@*
    Partial de SEO con Structured Data (JSON-LD)
    Incluye Schema.org para Organization, WebSite y datos dinamicos
    Usa configuracion desde la base de datos
*@
@using Lado.Services
@inject ISeoConfigService SeoConfigService

@{
    // Cargar configuracion SEO desde BD (con cache)
    var seoConfig = await SeoConfigService.ObtenerConfiguracionAsync();

    var baseUrl = seoConfig.UrlBase;
    var siteName = seoConfig.OrganizacionNombre;
    var siteDescription = ViewData["MetaDescription"]?.ToString() ?? seoConfig.DescripcionMeta;
    var logoUrl = $"{baseUrl}{seoConfig.OrganizacionLogo}";

    // Construir lista de redes sociales
    var socialLinks = new List<string>();
    if (!string.IsNullOrEmpty(seoConfig.TwitterUrl)) socialLinks.Add(seoConfig.TwitterUrl);
    if (!string.IsNullOrEmpty(seoConfig.InstagramUrl)) socialLinks.Add(seoConfig.InstagramUrl);
    if (!string.IsNullOrEmpty(seoConfig.FacebookUrl)) socialLinks.Add(seoConfig.FacebookUrl);
    if (!string.IsNullOrEmpty(seoConfig.TikTokUrl)) socialLinks.Add(seoConfig.TikTokUrl);
    if (!string.IsNullOrEmpty(seoConfig.YouTubeUrl)) socialLinks.Add(seoConfig.YouTubeUrl);

    // Datos dinamicos para schemas especificos
    var schemaType = ViewData["SchemaType"]?.ToString();
    var schemaName = ViewData["SchemaName"]?.ToString();
    var schemaImage = ViewData["OgImage"]?.ToString();
    var schemaDescription = ViewData["SchemaDescription"]?.ToString() ?? siteDescription;
    var schemaUrl = ViewData["CanonicalUrl"]?.ToString() ?? ViewData["OgUrl"]?.ToString();

    // Datos para Article schema
    var articleTitle = ViewData["ArticleTitle"]?.ToString();
    var articleAuthor = ViewData["ArticleAuthor"]?.ToString();
    var articleDatePublished = ViewData["ArticleDatePublished"]?.ToString();
}

<!-- Schema Organization -->
<script type="application/ld+json">
{
    "@@context": "https://schema.org",
    "@@type": "Organization",
    "name": "@siteName",
    "url": "@baseUrl",
    "logo": {
        "@@type": "ImageObject",
        "url": "@logoUrl",
        "width": 512,
        "height": 512
    },
    "description": "@seoConfig.OrganizacionDescripcion",
    "foundingDate": "@seoConfig.OrganizacionFundacion",
    "sameAs": [@Html.Raw(string.Join(", ", socialLinks.Select(s => $"\"{s}\"")))],
    "contactPoint": {
        "@@type": "ContactPoint",
        "contactType": "customer service",
        "email": "@seoConfig.OrganizacionEmail",
        "availableLanguage": ["Spanish", "English"]
    }
}
</script>

<!-- Schema WebSite con SearchAction -->
<script type="application/ld+json">
{
    "@@context": "https://schema.org",
    "@@type": "WebSite",
    "name": "@siteName",
    "url": "@baseUrl",
    "description": "@siteDescription",
    "inLanguage": "es",
    "potentialAction": {
        "@@type": "SearchAction",
        "target": {
            "@@type": "EntryPoint",
            "urlTemplate": "@(baseUrl)/FeedPublico?buscar={search_term_string}"
        },
        "query-input": "required name=search_term_string"
    }
}
</script>

@* Schema dinamico segun tipo de pagina *@
@if (schemaType == "Person" && !string.IsNullOrEmpty(schemaName))
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "ProfilePage",
        "mainEntity": {
            "@@type": "Person",
            "name": "@schemaName",
            "url": "@(schemaUrl ?? baseUrl)",
            "image": "@(schemaImage ?? $"{baseUrl}/images/default-avatar.svg")",
            "description": "@schemaDescription"
        },
        "dateModified": "@DateTime.UtcNow.ToString("yyyy-MM-dd")"
    }
    </script>
}
else if (schemaType == "Article" && !string.IsNullOrEmpty(articleTitle))
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Article",
        "headline": "@articleTitle",
        "image": ["@(schemaImage ?? $"{baseUrl}{seoConfig.OgImagenDefault}")"],
        "datePublished": "@(articleDatePublished ?? DateTime.UtcNow.ToString("yyyy-MM-dd"))",
        "dateModified": "@(articleDatePublished ?? DateTime.UtcNow.ToString("yyyy-MM-dd"))",
        "author": {
            "@@type": "Person",
            "name": "@(articleAuthor ?? siteName)"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "@siteName",
            "logo": {
                "@@type": "ImageObject",
                "url": "@logoUrl"
            }
        },
        "mainEntityOfPage": {
            "@@type": "WebPage",
            "@@id": "@(schemaUrl ?? baseUrl)"
        }
    }
    </script>
}
else if (schemaType == "CollectionPage")
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@(ViewData["Title"] ?? "Explorar Contenido")",
        "description": "@schemaDescription",
        "url": "@(schemaUrl ?? baseUrl)",
        "isPartOf": {
            "@@type": "WebSite",
            "name": "@siteName",
            "url": "@baseUrl"
        }
    }
    </script>
}
