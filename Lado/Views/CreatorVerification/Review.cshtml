@model CreatorVerificationRequest
@{
    ViewData["Title"] = "Revisar Verificación";
}

<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-12">
            <a href="/CreatorVerification/AdminPanel" class="btn btn-outline-secondary mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                    <polyline points="15 18 9 12 15 6" />
                </svg>
                Volver al Panel
            </a>

            <h2>Revisión de Verificación</h2>
            <p class="text-muted">Solicitud de @Model.User.UserName</p>
        </div>
    </div>

    <div class="row">
        <!-- Información del Usuario -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                        Información del Creador
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <img src="@(Model.User.FotoPerfil ?? "/images/default-avatar.svg")"
                             alt="@Model.User.UserName"
                             class="rounded-circle"
                             style="width: 100px; height: 100px; object-fit: cover;">
                        <h5 class="mt-2 mb-0">@Model.User.UserName</h5>
                        <p class="text-muted mb-0">@Model.User.Email</p>
                    </div>

                    <hr />

                    <div class="mb-2">
                        <strong>Nombre Real:</strong><br />
                        @Model.NombreCompleto
                    </div>

                    <div class="mb-2">
                        <strong>Documento:</strong><br />
                        <span class="badge bg-secondary">@Model.TipoDocumento</span> @Model.NumeroDocumento
                    </div>

                    <div class="mb-2">
                        <strong>País:</strong><br />
                        @Model.Pais
                    </div>

                    <div class="mb-2">
                        <strong>Teléfono:</strong><br />
                        @Model.Telefono
                    </div>

                    <div class="mb-2">
                        <strong>Fecha de Solicitud:</strong><br />
                        @Model.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")
                    </div>

                    <div>
                        <strong>Estado:</strong><br />
                        @if (Model.Estado == "Pendiente")
                        {
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        }
                        else if (Model.Estado == "Aprobada")
                        {
                            <span class="badge bg-success">Aprobada</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Rechazada</span>
                        }
                    </div>

                    @if (Model.Estado == "Rechazada" && !string.IsNullOrEmpty(Model.MotivoRechazo))
                    {
                        <hr />
                        <div class="alert alert-danger mb-0">
                            <strong>Motivo de Rechazo:</strong><br />
                            @Model.MotivoRechazo
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Documentos -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                        </svg>
                        Documentos Adjuntos
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Selfie con Documento (Principal) -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                            Selfie con Documento
                            <span class="badge bg-info ms-2">Verificación Principal</span>
                        </h6>
                        <p class="text-muted small mb-3">
                            Verifica que el rostro coincida con el documento y que los datos sean legibles.
                        </p>
                        <div class="document-preview">
                            <img src="@Model.SelfieConDocumentoPath" alt="Selfie con Documento" class="img-fluid rounded border" style="max-height: 500px; cursor: pointer;" onclick="openModal(this.src)" />
                        </div>
                    </div>

                    <!-- Documento de Identidad (Solo si existe - solicitudes antiguas) -->
                    @if (!string.IsNullOrEmpty(Model.DocumentoIdentidadPath))
                    {
                        <div class="mb-4">
                            <h6 class="text-secondary mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                    <rect x="2" y="6" width="20" height="12" rx="2" />
                                    <circle cx="8" cy="12" r="2" />
                                    <path d="M14 10h4M14 14h4" />
                                </svg>
                                Documento de Identidad (adicional)
                            </h6>
                            <div class="document-preview">
                                @if (Model.DocumentoIdentidadPath.EndsWith(".pdf"))
                                {
                                    <a href="@Model.DocumentoIdentidadPath" target="_blank" class="btn btn-outline-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                            <polyline points="15 3 21 3 21 9" />
                                            <line x1="10" y1="14" x2="21" y2="3" />
                                        </svg>
                                        Ver PDF
                                    </a>
                                }
                                else
                                {
                                    <img src="@Model.DocumentoIdentidadPath" alt="Documento" class="img-fluid rounded border" style="max-height: 400px; cursor: pointer;" onclick="openModal(this.src)" />
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Acciones de Aprobación/Rechazo -->
            @if (Model.Estado == "Pendiente")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                <polyline points="9 11 12 14 22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            Acciones de Verificación
                        </h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="ProcessVerification" method="post" id="formAprobacion">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-success btn-lg w-100" onclick="aprobar()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                            <polyline points="20 6 9 17 4 12" />
                                        </svg>
                                        Aprobar Verificación
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-danger btn-lg w-100" onclick="rechazar()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                            <line x1="18" y1="6" x2="6" y2="18" />
                                            <line x1="6" y1="6" x2="18" y2="18" />
                                        </svg>
                                        Rechazar Solicitud
                                    </button>
                                </div>
                            </div>

                            <div id="motivoRechazo" style="display: none;" class="mt-3">
                                <label class="form-label">Motivo del Rechazo</label>
                                <textarea name="motivo" class="form-control" rows="3" placeholder="Explica por qué se rechaza la solicitud..."></textarea>
                            </div>

                            <input type="hidden" name="accion" id="accionInput" />
                        </form>
                    </div>
                </div>
            }

            <!-- Opción de Revocar para usuarios ya aprobados -->
            @if (Model.Estado == "Aprobada" && Model.User.CreadorVerificado)
            {
                <div class="card border-0 shadow-sm border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0 text-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                <line x1="12" y1="9" x2="12" y2="13" />
                                <line x1="12" y1="17" x2="12.01" y2="17" />
                            </svg>
                            Revocar Verificación
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3">
                            <strong>Atención:</strong> Esta acción quitará la verificación del usuario.
                            Ya no podrá publicar contenido LadoB hasta que vuelva a verificarse.
                        </div>

                        <form asp-action="RevocarVerificacion" method="post" id="formRevocar">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="usuarioId" value="@Model.UserId" />

                            <div class="mb-3">
                                <label class="form-label">Motivo de la Revocación <span class="text-danger">*</span></label>
                                <textarea name="motivo" id="motivoRevocacion" class="form-control" rows="3"
                                    placeholder="Explica por qué se revoca la verificación..." required></textarea>
                            </div>

                            <button type="button" class="btn btn-warning w-100" onclick="revocar()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                                    <circle cx="12" cy="12" r="10" />
                                    <line x1="15" y1="9" x2="9" y2="15" />
                                    <line x1="9" y1="9" x2="15" y2="15" />
                                </svg>
                                Revocar Verificación
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal para ver imágenes en tamaño completo -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img src="" id="modalImage" class="img-fluid w-100" />
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openModal(src) {
        document.getElementById('modalImage').src = src;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    function aprobar() {
        if (confirm('¿Estás seguro de aprobar esta verificación? El creador podrá comenzar a publicar contenido.')) {
            document.getElementById('accionInput').value = 'aprobar';
            document.getElementById('formAprobacion').submit();
        }
    }

    function rechazar() {
        document.getElementById('motivoRechazo').style.display = 'block';
        document.getElementById('accionInput').value = 'rechazar';

        if (confirm('¿Estás seguro de rechazar esta solicitud? El creador será notificado.')) {
            const motivo = document.querySelector('textarea[name="motivo"]').value;
            if (!motivo.trim()) {
                alert('Debes especificar un motivo para el rechazo.');
                return;
            }
            document.getElementById('formAprobacion').submit();
        }
    }

    function revocar() {
        const motivo = document.getElementById('motivoRevocacion').value;
        if (!motivo.trim()) {
            alert('Debes especificar un motivo para la revocación.');
            return;
        }

        if (confirm('¿Estás seguro de REVOCAR la verificación de este usuario?\n\nEsta acción:\n- Quitará el estado de creador verificado\n- El usuario no podrá publicar contenido LadoB\n- Deberá volver a solicitar verificación')) {
            document.getElementById('formRevocar').submit();
        }
    }
</script>

<style>
    .document-preview img {
        transition: transform 0.2s;
    }

        .document-preview img:hover {
            transform: scale(1.02);
        }
</style>