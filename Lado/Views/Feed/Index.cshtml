@model IEnumerable<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "Feed";
    var likesUsuario = ViewBag.LikesUsuario as List<int> ?? new List<int>();
    var favoritosIds = ViewBag.FavoritosIds as List<int> ?? new List<int>();
    var usuariosSeguidosIds = ViewBag.UsuariosSeguidosIds as List<string> ?? new List<string>();
    var stories = ViewBag.Stories as IEnumerable<dynamic>;
    var usuarioActual = ViewBag.UsuarioActual as ApplicationUser;
    var creadoresSugeridos = ViewBag.CreadoresSugeridos as List<ApplicationUser> ?? new List<ApplicationUser>();
    var contenidoBloqueadoIds = ViewBag.ContenidoBloqueadoIds as List<int> ?? new List<int>();
    var anuncios = ViewBag.Anuncios as List<Lado.Models.Anuncio> ?? new List<Lado.Models.Anuncio>();
    var algoritmoActual = ViewBag.AlgoritmoActual as AlgoritmoFeed;
    var algoritmosDisponibles = ViewBag.AlgoritmosDisponibles as List<AlgoritmoFeed> ?? new List<AlgoritmoFeed>();
}

@Html.AntiForgeryToken()

<style>
    /* Ocultar toast en el feed */
    .toast-notification,
    #toastNotification {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    /* ========================================
       FEED INSTAGRAM-STYLE - REDISE√ëO COMPLETO
       ======================================== */

    /* MAIN LAYOUT */
    .feed-page-layout {
        display: grid;
        grid-template-columns: minmax(0, 630px) 320px;
        gap: 32px;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px 16px;
        justify-content: center;
    }

    .feed-main {
        min-width: 0;
    }

    .feed-sidebar {
        position: sticky;
        top: 90px;
        height: fit-content;
    }

    .feed-container {
        max-width: 630px;
        margin: 0 auto;
    }

    /* ========================================
       ALGORITHM SELECTOR (SELECT NATIVO)
       ======================================== */
    .algorithm-selector {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .algorithm-label {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .algorithm-label svg {
        width: 16px;
        height: 16px;
    }

    .algorithm-select {
        padding: 8px 32px 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: var(--fg);
        background-color: var(--bg);
        border: 1px solid var(--line);
        border-radius: 20px;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        min-width: 160px;
        transition: all 0.2s;
    }

    .algorithm-select:hover {
        border-color: var(--primary);
    }

    .algorithm-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.15);
    }

    .algorithm-select option {
        padding: 8px;
        background: var(--surface);
        color: var(--fg);
    }

    /* ========================================
       STORIES BAR
       ======================================== */
    .stories-bar {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .stories-scroll {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 4px 0;
    }

    .stories-scroll::-webkit-scrollbar {
        display: none;
    }

    .story-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .story-ring {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }

    .story-ring.seen {
        background: var(--line);
    }

    .story-ring-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--surface);
        padding: 2px;
    }

    .story-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .story-avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 18px;
    }

    .story-username {
        font-size: 12px;
        color: var(--fg);
        max-width: 66px;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* ========================================
       POST CARD
       ======================================== */
    .post {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .post-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
    }

    .post-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        text-decoration: none;
    }

    .post-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .post-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .post-user-info {
        display: flex;
        flex-direction: column;
    }

    .post-username {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    .post-header-left:hover .post-username {
        color: var(--primary);
    }

    .post-time {
        font-size: 12px;
        color: var(--muted);
    }

    .post-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 6px;
    }

    .badge-ladob {
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
    }

    .verified-icon {
        width: 16px;
        height: 16px;
        margin-left: 4px;
        vertical-align: middle;
        flex-shrink: 0;
        display: inline-block;
    }

    .post-menu {
        padding: 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--fg);
        position: relative;
    }

    /* Post Menu Dropdown */
    .post-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 200px;
        z-index: 100;
        display: none;
        overflow: hidden;
    }

    .post-menu-dropdown.show {
        display: block;
    }

    .post-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: var(--fg);
        font-size: 14px;
        cursor: pointer;
        transition: background 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .post-menu-item:hover {
        background: var(--bg-secondary);
    }

    .post-menu-item.danger {
        color: #ed4956;
    }

    .post-menu-item.danger:hover {
        background: rgba(237, 73, 86, 0.1);
    }

    .post-menu-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .post-menu-divider {
        height: 1px;
        background: var(--line);
        margin: 4px 0;
    }

    /* POST MEDIA - Con aspect-ratio para evitar layout shift */
    .post-media {
        width: 100%;
        background: var(--bg-tertiary);
        position: relative;
        aspect-ratio: 4 / 5;
        overflow: hidden;
    }

    .post-media img {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
    }

    .post-media video {
        width: 100%;
        height: auto; /* Altura autom√°tica seg√∫n aspect ratio del video */
        max-height: 80vh; /* M√°ximo 80% de la pantalla */
        display: block;
        background: #000;
        cursor: pointer;
        object-fit: contain;
    }

    /* Contenedor de video se adapta al contenido */
    .post-media:has(video) {
        aspect-ratio: unset;
        height: auto;
        min-height: 200px; /* M√≠nimo mientras carga */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Video TikTok-style Controls */
    .post-media {
        position: relative;
    }

    .video-controls-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
    }

    /* Location Badge */
    .location-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 10;
        backdrop-filter: blur(4px);
        max-width: 70%;
        overflow: hidden;
    }

    .location-badge svg {
        width: 12px;
        height: 12px;
        flex-shrink: 0;
    }

    .location-badge span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========================================
       PREVIEW BLUR DE LADOB
       ======================================== */
    .post-media.preview-blur-wrapper {
        position: relative;
    }

    /* Efecto Blur */
    .post-media.blur-effect img,
    .post-media.blur-effect video {
        filter: blur(20px);
        transform: scale(1.1);
    }

    /* Efecto Pixelado (simulado con blur peque√±o + contrast) */
    .post-media.pixelado-effect img,
    .post-media.pixelado-effect video {
        filter: blur(8px) contrast(1.2);
        image-rendering: pixelated;
    }

    /* Efecto Silueta */
    .post-media.silueta-effect img,
    .post-media.silueta-effect video {
        filter: brightness(0) blur(3px);
    }

    /* Efecto Parcial (solo borde visible) */
    .post-media.parcial-effect img,
    .post-media.parcial-effect video {
        filter: blur(15px);
        mask-image: radial-gradient(ellipse 80% 80% at center, transparent 30%, black 70%);
        -webkit-mask-image: radial-gradient(ellipse 80% 80% at center, transparent 30%, black 70%);
    }

    /* Overlay del preview blur */
    .preview-blur-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        z-index: 15;
        gap: 12px;
        text-align: center;
        padding: 20px;
    }

    .preview-blur-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-blur-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .preview-blur-text {
        color: white;
        font-size: 14px;
        font-weight: 500;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .preview-blur-subtext {
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .preview-blur-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .preview-blur-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
    }

    .preview-blur-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Badge LadoB en preview */
    .ladob-preview-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        z-index: 16;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ladob-preview-badge svg {
        width: 12px;
        height: 12px;
    }

    /* ========================================
       PULL TO REFRESH
       ======================================== */
    .pull-to-refresh {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%) translateY(-100%);
        z-index: 1000;
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        pointer-events: none;
    }

    .pull-to-refresh.visible {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .pull-to-refresh.refreshing {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .pull-indicator {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .pull-indicator svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
        transition: transform 0.2s ease;
    }

    .pull-to-refresh.ready .pull-indicator svg {
        transform: rotate(180deg);
    }

    .pull-to-refresh.refreshing .pull-indicator svg {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* ========================================
       INFINITE SCROLL LOADER
       ======================================== */
    .infinite-scroll-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .infinite-scroll-loader.visible {
        opacity: 1;
    }

    .infinite-scroll-loader .loader-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .infinite-scroll-end {
        text-align: center;
        padding: 30px 0;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* Skeleton loading para posts */
    .post-skeleton {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .post-skeleton .skeleton-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
    }

    .post-skeleton .skeleton-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .post-skeleton .skeleton-text {
        flex: 1;
    }

    .post-skeleton .skeleton-line {
        height: 12px;
        border-radius: 4px;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .post-skeleton .skeleton-line.short {
        width: 60%;
        margin-top: 6px;
    }

    .post-skeleton .skeleton-media {
        width: 100%;
        padding-top: 100%;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @@keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .video-play-icon {
        width: 64px;
        height: 64px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .video-play-icon svg {
        width: 32px;
        height: 32px;
    }

    /* Icono de play (triangulo) - centrado con margin-left */
    .video-play-icon .icon-play {
        margin-left: 4px;
    }

    /* Icono de pausa - oculto por defecto */
    .video-play-icon .icon-pause {
        display: none;
    }

    /* Cuando el video esta reproduciendose: mostrar pausa, ocultar play */
    .post-media.video-playing .video-play-icon .icon-play {
        display: none;
    }
    .post-media.video-playing .video-play-icon .icon-pause {
        display: block;
    }

    /* Mostrar icono en hover o cuando esta pausado */
    .post-media:hover .video-play-icon,
    .video-paused .video-play-icon {
        opacity: 1;
    }

    /* En mobile: siempre mostrar cuando esta pausado, no en hover */
    @@media (hover: none) {
        .post-media:hover .video-play-icon {
            opacity: 0;
        }
        .video-paused .video-play-icon {
            opacity: 1;
        }
    }

    /* üçé iOS: Indicador de que se requiere tap */
    .ios-needs-tap::after {
        content: 'Toca para reproducir';
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform: translate(-50%, 50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        z-index: 15;
        pointer-events: none;
        animation: iosTapPulse 2s ease-in-out infinite;
    }

    @@keyframes iosTapPulse {
        0%, 100% { opacity: 0.9; transform: translate(-50%, 50%) scale(1); }
        50% { opacity: 1; transform: translate(-50%, 50%) scale(1.05); }
    }

    .video-mute-btn {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
        z-index: 10;
    }

    .video-mute-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .video-mute-btn svg {
        width: 20px;
        height: 20px;
    }

    .feed-video {
        object-fit: contain;
        max-height: 600px;
    }

    .post-media-audio {
        padding: 48px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--surface) 100%);
    }

    .post-media-audio audio {
        width: 100%;
        max-width: 400px;
    }

    .post-text-content {
        padding: 32px 24px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--surface) 100%);
        font-size: 18px;
        line-height: 1.6;
        color: var(--fg);
        text-align: center;
    }

    /* POST ACTIONS */
    .post-actions {
        padding: 12px 16px 0;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        margin: -8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--fg);
        transition: transform 0.1s ease;
    }

    .action-btn:hover {
        opacity: 0.7;
    }

    .action-btn:active {
        transform: scale(0.9);
    }

    .action-btn svg {
        width: 24px;
        height: 24px;
    }

    .action-btn.liked svg {
        fill: #ed4956;
        stroke: #ed4956;
    }

    .action-btn.bookmarked svg {
        fill: var(--fg);
        stroke: var(--fg);
    }

    .action-spacer {
        flex: 1;
    }

    /* LIKES COUNT */
    .post-likes {
        padding: 0 16px;
        margin-top: 8px;
    }

    .post-likes-count {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    /* CAPTION */
    .post-caption {
        padding: 8px 16px;
    }

    .post-caption-text {
        font-size: 14px;
        line-height: 1.4;
        color: var(--fg);
    }

    .post-caption-username {
        font-weight: 600;
        margin-right: 6px;
    }

    /* COMMENTS PREVIEW */
    .post-comments-preview {
        padding: 0 16px 8px;
    }

    .view-all-comments {
        font-size: 14px;
        color: var(--muted);
        cursor: pointer;
        margin-bottom: 8px;
    }

    .view-all-comments:hover {
        text-decoration: underline;
    }

    /* ========================================
       COMENTARIOS ESTILO INSTAGRAM - FEED
       ======================================== */

    .feed-comment-item {
        display: flex;
        gap: 10px;
        padding: 8px 0;
    }

    .feed-comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: var(--hover);
    }

    .feed-comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .feed-comment-avatar-initial {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 12px;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        color: white;
    }

    .feed-comment-content {
        flex: 1;
        min-width: 0;
    }

    .feed-comment-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 2px;
    }

    .feed-comment-username {
        font-size: 13px;
        font-weight: 600;
        color: var(--fg);
        text-decoration: none;
    }

    .feed-comment-username:hover {
        text-decoration: underline;
    }

    .feed-comment-time {
        font-size: 12px;
        color: var(--muted);
    }

    .feed-comment-text {
        font-size: 14px;
        line-height: 1.4;
        color: var(--fg);
        margin-bottom: 4px;
        word-wrap: break-word;
    }

    .feed-comment-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .feed-comment-action-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        transition: all 0.2s;
    }

    .feed-comment-action-btn:hover {
        color: var(--fg);
    }

    .feed-comment-action-btn svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
    }

    .feed-comment-action-btn.like-btn svg.liked {
        fill: #ed4956;
        stroke: #ed4956;
    }

    .feed-comment-action-btn .count {
        font-weight: 500;
    }

    @@keyframes feedHeartPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    .feed-comment-action-btn svg.liked {
        animation: feedHeartPop 0.3s ease-out;
    }

    /* Respuestas mini */
    .feed-show-replies {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 0 4px 42px;
        cursor: pointer;
    }

    .feed-show-replies:hover span {
        text-decoration: underline;
    }

    .feed-reply-avatars {
        display: flex;
    }

    .feed-reply-avatars img {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--bg);
        margin-left: -6px;
        object-fit: cover;
    }

    .feed-reply-avatars img:first-child {
        margin-left: 0;
    }

    .feed-show-replies span {
        font-size: 12px;
        color: var(--muted);
        font-weight: 500;
    }

    /* ADD COMMENT */
    .post-add-comment {
        border-top: 1px solid var(--line);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 14px;
        color: var(--fg);
        outline: none;
    }

    .comment-input::placeholder {
        color: var(--muted);
    }

    .comment-post-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
    }

    .comment-post-btn:not(:disabled) {
        opacity: 1;
    }

    .comment-post-btn:disabled {
        cursor: not-allowed;
    }

    /* POST TIMESTAMP */
    .post-timestamp {
        padding: 0 16px 12px;
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    /* SHARE MODAL */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .share-modal {
        background: var(--surface);
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        overflow: hidden;
    }

    .share-modal-header {
        padding: 16px;
        text-align: center;
        border-bottom: 1px solid var(--line);
        font-weight: 600;
        font-size: 16px;
        position: relative;
    }

    .share-modal-close {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: var(--fg);
        font-size: 20px;
    }

    .share-options {
        padding: 16px;
        display: flex;
        justify-content: center;
        gap: 24px;
    }

    .share-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        text-decoration: none;
    }

    .share-option-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .share-option-icon.whatsapp { background: #25D366; }
    .share-option-icon.telegram { background: #0088cc; }
    .share-option-icon.twitter { background: #1DA1F2; }
    .share-option-icon.copy { background: var(--fg); }
    .share-option-icon.friends { background: var(--primary); }

    .share-option-label {
        font-size: 12px;
        color: var(--fg);
    }

    .share-url-section {
        padding: 0 16px 16px;
    }

    .share-url-input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        font-size: 13px;
        background: var(--bg-tertiary);
        color: var(--fg);
    }

    /* Friends Panel en Share Modal */
    .share-friends-panel {
        display: none;
        border-top: 1px solid var(--line);
    }

    .share-friends-panel.active {
        display: block;
    }

    .friends-panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
    }

    .friends-panel-back {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--fg);
    }

    .friends-panel-back:hover {
        background: var(--line);
    }

    .friends-panel-title {
        font-weight: 600;
        font-size: 15px;
        color: var(--fg);
    }

    .friends-search {
        padding: 12px 16px;
    }

    .friends-search input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--line);
        border-radius: 20px;
        font-size: 14px;
        background: var(--bg);
        color: var(--fg);
    }

    .friends-search input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .friends-list {
        max-height: 280px;
        overflow-y: auto;
        padding: 0 8px 12px;
    }

    .friend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .friend-item:hover {
        background: var(--bg);
    }

    .friend-item.selected {
        background: rgba(70, 130, 180, 0.1);
    }

    .friend-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--line);
    }

    .friend-info {
        flex: 1;
        min-width: 0;
    }

    .friend-name {
        font-weight: 500;
        font-size: 14px;
        color: var(--fg);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .friend-username {
        font-size: 13px;
        color: var(--muted);
    }

    .friend-check {
        width: 24px;
        height: 24px;
        border: 2px solid var(--line);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
    }

    .friend-item.selected .friend-check {
        background: var(--primary);
        border-color: var(--primary);
    }

    .friend-check svg {
        display: none;
        color: white;
    }

    .friend-item.selected .friend-check svg {
        display: block;
    }

    .friends-empty {
        text-align: center;
        padding: 32px 16px;
        color: var(--muted);
        font-size: 14px;
    }

    .friends-loading {
        text-align: center;
        padding: 32px 16px;
        color: var(--muted);
    }

    .send-friends-btn {
        margin: 0 16px 16px;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: calc(100% - 32px);
        transition: all 0.15s;
    }

    .send-friends-btn:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .send-friends-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }


    /* ========================================
       ANUNCIO EN FEED (ESTILO POST)
       ======================================== */
    .post-ad {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .post-ad-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        gap: 12px;
    }

    .post-ad-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .post-ad-icon svg {
        width: 20px;
        height: 20px;
    }

    .post-ad-info {
        flex: 1;
    }

    .post-ad-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    .post-ad-badge {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .post-ad-badge i {
        font-size: 10px;
    }

    .post-ad-media {
        position: relative;
        overflow: hidden;
        cursor: pointer;
        display: block;
        background: #f8f9fa;
    }

    .post-ad-media img,
    .post-ad-media video {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.3s ease;
    }

    .post-ad:hover .post-ad-media img,
    .post-ad:hover .post-ad-media video {
        transform: scale(1.02);
    }

    .post-ad-content {
        padding: 14px 16px;
    }

    .post-ad-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        width: 100%;
    }

    .post-ad-cta:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .post-ad-cta i {
        font-size: 12px;
    }

    /* EMPTY STATE */
    .empty-feed {
        text-align: center;
        padding: 60px 20px;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
    }

    .empty-feed h3 {
        font-size: 20px;
        margin-bottom: 8px;
    }

    .empty-feed p {
        color: var(--muted);
        margin-bottom: 20px;
    }

    .empty-feed-btn {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
    }

    /* ========================================
       SIDEBAR
       ======================================== */
    .sidebar-section {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .sidebar-user {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .sidebar-user-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
    }

    .sidebar-user-avatar-placeholder {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
    }

    .sidebar-user-info {
        flex: 1;
    }

    .sidebar-user-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--fg);
    }

    .sidebar-user-username {
        font-size: 14px;
        color: var(--muted);
    }

    .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .sidebar-title {
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
    }

    .sidebar-see-all {
        font-size: 12px;
        color: var(--fg);
        font-weight: 600;
        text-decoration: none;
    }

    .sidebar-see-all:hover {
        text-decoration: underline;
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .suggestion-item:last-child {
        margin-bottom: 0;
    }

    .suggestion-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .suggestion-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
    }

    .suggestion-info {
        flex: 1;
        min-width: 0;
    }

    .suggestion-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .suggestion-name:hover {
        color: var(--primary);
    }

    .suggestion-badge-b {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        color: white;
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 4px;
        vertical-align: middle;
    }

    .suggestion-reason {
        font-size: 12px;
        color: var(--muted);
    }

    .suggestion-follow-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
    }

    .suggestion-follow-btn:hover {
        opacity: 0.7;
    }

    .sidebar-footer {
        margin-top: 24px;
        font-size: 11px;
        color: var(--muted);
    }

    .sidebar-footer a {
        color: var(--muted);
        text-decoration: none;
    }

    .sidebar-footer a:hover {
        text-decoration: underline;
    }

    /* RESPONSIVE */
    @@media (max-width: 960px) {
        .feed-page-layout {
            grid-template-columns: 1fr;
            max-width: 630px;
        }

        .feed-sidebar {
            display: none;
        }
    }

    @@media (max-width: 640px) {
        .feed-page-layout {
            padding: 0;
        }

        .stories-bar,
        .post {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        .post {
            margin-bottom: 8px;
        }
    }

    /* ========================================
       CONTENIDO BLOQUEADO - BLUR Y CANDADO
       ======================================== */
    .locked-content-wrapper {
        position: relative;
        cursor: pointer;
        overflow: hidden;
    }

    .locked-content-wrapper .post-media img,
    .locked-content-wrapper .post-media video,
    .locked-content-wrapper .post-text-content {
        filter: blur(20px);
        transform: scale(1.1);
        pointer-events: none;
    }

    .locked-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10;
    }

    .locked-icon {
        width: 64px;
        height: 64px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .locked-icon svg {
        width: 32px;
        height: 32px;
        color: #FFC400;
    }

    .locked-text {
        color: white;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        padding: 0 20px;
    }

    .locked-subscribe-btn {
        margin-top: 16px;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4);
    }

    .locked-subscribe-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 24px rgba(168, 85, 247, 0.5);
    }

    .locked-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 11;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .locked-badge svg {
        width: 12px;
        height: 12px;
    }

    /* Modal de suscripcion */
    .subscribe-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .subscribe-modal.active {
        display: flex;
    }

    .subscribe-modal-content {
        background: var(--surface);
        border-radius: 16px;
        max-width: 420px;
        width: 90%;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
    }

    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .subscribe-modal-header {
        position: relative;
        padding: 24px;
        text-align: center;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
    }

    .subscribe-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s;
    }

    .subscribe-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .subscribe-modal-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        margin-bottom: 12px;
    }

    .subscribe-modal-avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        margin: 0 auto 12px;
    }

    .subscribe-modal-name {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .subscribe-modal-username {
        font-size: 14px;
        opacity: 0.9;
    }

    .subscribe-modal-body {
        padding: 24px;
        text-align: center;
    }

    .subscribe-modal-body h4 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--fg);
    }

    .subscribe-modal-body p {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .subscribe-modal-price {
        font-size: 28px;
        font-weight: 700;
        color: var(--fg);
        margin-bottom: 4px;
    }

    .subscribe-modal-price-label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 20px;
    }

    .subscribe-modal-btn {
        width: 100%;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .subscribe-modal-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }

    .subscribe-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--line);
        text-align: center;
    }

    .subscribe-modal-footer a {
        color: var(--primary);
        font-size: 14px;
        text-decoration: none;
        font-weight: 500;
    }

    .subscribe-modal-footer a:hover {
        text-decoration: underline;
    }

    /* ========================================
       FULLSCREEN MODE - Ocultar header y sidebar
       ======================================== */
    body.fullscreen-mode .top-navbar,
    body.fullscreen-mode .sidebar,
    body.fullscreen-mode .sidebar-overlay,
    body.fullscreen-mode header,
    body.fullscreen-mode nav {
        display: none !important;
    }

    body.fullscreen-mode {
        overflow: hidden !important;
    }

    body.fullscreen-mode .main-content {
        margin-left: 0 !important;
        padding-top: 0 !important;
    }

    /* ========================================
       FULLSCREEN MEDIA VIEWER (TikTok-style)
       ======================================== */
    .fullscreen-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 9999;
        overflow: hidden;
    }

    .fullscreen-viewer.active {
        display: flex;
        flex-direction: column;
    }

    .fullscreen-viewer-close {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .fullscreen-viewer-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .fullscreen-viewer-close svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .fullscreen-slides-container {
        flex: 1;
        overflow-y: scroll;
        overflow-x: hidden;
        scroll-snap-type: y mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        overscroll-behavior-y: contain;
        scroll-behavior: smooth;
    }

    .fullscreen-slides-container::-webkit-scrollbar {
        display: none;
    }

    .fullscreen-slide {
        width: 100%;
        height: 100vh;
        height: 100dvh;
        min-height: 100vh;
        min-height: 100dvh;
        scroll-snap-align: center;
        scroll-snap-stop: always;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #000;
        flex-shrink: 0;
    }

    .fullscreen-slide img,
    .fullscreen-slide video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        user-select: none;
        -webkit-user-drag: none;
    }

    .fullscreen-slide video {
        background: #000;
    }

    /* ========================================
       CARRUSEL DENTRO DEL FULLSCREEN
       ======================================== */
    .fullscreen-slide.has-carousel {
        padding: 0;
    }

    .fs-carousel-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fs-carousel-slides {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .fs-carousel-item {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .fs-carousel-item.active {
        display: flex;
    }

    .fs-carousel-item img,
    .fs-carousel-item video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .fs-carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
    }

    .fs-carousel-nav:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .fs-carousel-nav svg {
        width: 28px;
        height: 28px;
    }

    .fs-carousel-prev {
        left: 20px;
    }

    .fs-carousel-next {
        right: 20px;
    }

    .fs-carousel-dots {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .fs-carousel-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        transition: all 0.2s;
    }

    .fs-carousel-dot:hover {
        background: rgba(255, 255, 255, 0.7);
    }

    .fs-carousel-dot.active {
        background: white;
        transform: scale(1.3);
    }

    .fs-carousel-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 500;
        z-index: 10;
    }

    /* Responsive carrusel fullscreen */
    @@media (max-width: 768px) {
        .fs-carousel-nav {
            width: 40px;
            height: 40px;
        }

        .fs-carousel-prev {
            left: 10px;
        }

        .fs-carousel-next {
            right: 10px;
        }

        .fs-carousel-dots {
            bottom: 20px;
        }

        .fs-carousel-counter {
            top: 15px;
            right: 15px;
            font-size: 12px;
        }
    }

    /* Desktop - carrusel m√°s grande */
    @@media (min-width: 992px) {
        .fs-carousel-item img,
        .fs-carousel-item video {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
    }

    /* Double tap heart animation */
    .fullscreen-heart-animation {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
        z-index: 10000;
    }

    .fullscreen-heart-animation svg {
        width: 120px;
        height: 120px;
        fill: #ed4956;
        filter: drop-shadow(0 0 20px rgba(237, 73, 86, 0.6));
    }

    .fullscreen-heart-animation.animate {
        animation: heartPop 0.8s ease-out forwards;
    }

    @@keyframes heartPop {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        15% {
            transform: translate(-50%, -50%) scale(1.2);
        }
        30% {
            transform: translate(-50%, -50%) scale(0.95);
        }
        45% {
            transform: translate(-50%, -50%) scale(1);
        }
        80% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
        }
    }

    /* Navigation hints */
    .fullscreen-nav-hint {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        pointer-events: none;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .fullscreen-nav-hint.top {
        top: 60px;
    }

    .fullscreen-nav-hint.bottom {
        bottom: 30px;
    }

    .fullscreen-nav-hint svg {
        width: 16px;
        height: 16px;
    }

    .fullscreen-viewer.show-hints .fullscreen-nav-hint {
        opacity: 1;
    }

    /* Audio content in fullscreen */
    .fullscreen-audio-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 24px;
        padding: 20px;
    }

    .fullscreen-audio-content svg {
        width: 100px;
        height: 100px;
        fill: var(--primary);
    }

    .fullscreen-audio-content audio {
        width: 100%;
        max-width: 400px;
    }

    /* Music badge in fullscreen - OCULTO, ahora va integrado en credits */
    .fullscreen-music-badge {
        display: none !important;
    }

    .fullscreen-audio-player {
        display: none;
    }

    /* Text content in fullscreen */
    .fullscreen-text-content {
        max-width: 600px;
        padding: 40px;
        color: white;
        font-size: 24px;
        line-height: 1.6;
        text-align: center;
    }

    /* Post counter - oculto en feed infinito */
    .fullscreen-counter {
        display: none;
    }

    /* Loading indicator */
    .fullscreen-loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        transition: opacity 0.3s ease;
    }

    .fullscreen-slide.media-loaded .fullscreen-loading-indicator {
        opacity: 0;
        pointer-events: none;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Media loaded state - show content */
    .fullscreen-slide img,
    .fullscreen-slide video {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .fullscreen-slide.media-loaded img,
    .fullscreen-slide.media-loaded video {
        opacity: 1;
    }

    /* Fullscreen Viewer - Estilos para pantallas grandes (PC) */
    @@media (min-width: 992px) {
        .fullscreen-viewer {
            background: rgba(0, 0, 0, 0.95);
        }

        .fullscreen-slide {
            padding: 20px;
            box-sizing: border-box;
        }

        .fullscreen-slide img,
        .fullscreen-slide video {
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-slide.media-loaded img,
        .fullscreen-slide.media-loaded video {
            opacity: 1;
        }

        .fullscreen-music-badge {
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
        }

        .fullscreen-viewer-close {
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
        }

        .fullscreen-viewer-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }
    }

    /* Fullscreen Viewer - Estilos para pantallas muy grandes */
    @@media (min-width: 1400px) {
        .fullscreen-slide img,
        .fullscreen-slide video {
            max-width: 70%;
            max-height: 85vh;
        }
    }

    /* Music Badge - Estilo Instagram/TikTok */
    .music-badge {
        position: absolute;
        bottom: 16px;
        left: 16px;
        right: 60px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 8px 12px;
        border-radius: 20px;
        color: white;
        font-size: 13px;
        z-index: 5;
        overflow: hidden;
    }

    .music-badge-icon {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary), #ff6b6b);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: musicSpin 20s linear infinite !important;
    }

    .music-badge-icon svg {
        width: 14px;
        height: 14px;
    }

    @@keyframes musicSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .music-badge-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }

    .music-badge-title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .music-badge-artist {
        font-size: 11px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .photo-audio-player {
        display: none;
    }

    /* Badge playing state */
    .music-badge.playing .music-badge-icon {
        animation: musicSpin 10s linear infinite !important;
        box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.6);
    }

    .music-badge.playing {
        background: rgba(var(--primary-rgb), 0.3);
    }

    /* üçé iOS: Badge que requiere tap para reproducir */
    .music-badge.needs-tap {
        background: rgba(255, 165, 0, 0.4);
        animation: needsTapPulse 1.5s ease-in-out infinite;
    }

    .music-badge.needs-tap::after {
        content: 'üëÜ';
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 16px;
        animation: tapBounce 0.6s ease-in-out infinite;
    }

    @@keyframes needsTapPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
    }

    @@keyframes tapBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }

    /* Fullscreen Mute Button Global - Arriba Izquierda */
    .fullscreen-mute-btn-global {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        z-index: 10001;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .fullscreen-mute-btn-global:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .fullscreen-mute-btn-global svg {
        width: 24px;
        height: 24px;
    }

    /* Ocultar el bot√≥n de mute dentro de los slides */
    .fullscreen-mute-btn {
        display: none !important;
    }

    /* ========================================
       CARRUSEL DE M√öLTIPLES ARCHIVOS
       ======================================== */

    .post-carousel {
        position: relative;
        width: 100%;
        background: #000;
        overflow: hidden;
    }

    .carousel-container {
        width: 100%;
        overflow: hidden;
    }

    .carousel-track {
        display: flex;
        transition: transform 0.3s ease-out;
    }

    .carousel-slide {
        flex-shrink: 0;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        max-height: 600px;
    }

    .carousel-media {
        width: 100%;
        height: 100%;
        object-fit: contain;
        max-height: 600px;
    }

    .carousel-play-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        opacity: 0.8;
    }

    .carousel-play-icon svg {
        width: 30px;
        height: 30px;
    }

    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
        opacity: 0;
    }

    .post-carousel:hover .carousel-btn {
        opacity: 1;
    }

    .carousel-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-btn svg {
        width: 24px;
        height: 24px;
    }

    .carousel-prev {
        left: 12px;
    }

    .carousel-next {
        right: 12px;
    }

    .carousel-prev.hidden,
    .carousel-next.hidden {
        display: none;
    }

    .carousel-dots {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 10;
    }

    .carousel-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.2s;
    }

    .carousel-dot.active {
        background: white;
        transform: scale(1.2);
    }

    .carousel-counter {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 12px;
        z-index: 10;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .carousel-btn {
            width: 32px;
            height: 32px;
            opacity: 0.8;
        }

        .carousel-prev {
            left: 8px;
        }

        .carousel-next {
            right: 8px;
        }

        .carousel-dots {
            bottom: 12px;
        }

        .carousel-dot {
            width: 6px;
            height: 6px;
        }
    }

    /* ========================================
       FULLSCREEN CREDITS (Estilo TikTok/Reels)
       ======================================== */
    /* ========================================
       FULLSCREEN UI - ESTILO YOUTUBE SHORTS
       ======================================== */

    /* Contenedor principal de cr√©ditos - ahora con layout separado */
    .fullscreen-credits {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        pointer-events: none;
        padding: 20px;
        padding-bottom: 30px;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
    }

    .credits-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        max-width: 100%;
    }

    /* ========================================
       INFO DEL CREADOR - IZQUIERDA INFERIOR
       ======================================== */
    .credits-creator-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 70%;
        pointer-events: auto;
    }

    .credits-creator-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .credits-avatar {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        max-width: 40px;
        min-height: 40px;
        max-height: 40px;
        border-radius: 50% !important;
        object-fit: cover;
        border: 2px solid white;
        cursor: pointer;
        flex-shrink: 0;
        display: block;
    }

    .credits-avatar-placeholder {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        max-width: 40px;
        min-height: 40px;
        max-height: 40px;
        border-radius: 50% !important;
        background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 16px;
        border: 2px solid white;
        cursor: pointer;
        flex-shrink: 0;
    }

    .credits-creator-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        cursor: pointer;
    }

    .credits-name {
        font-size: 15px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .credits-verified {
        width: 16px;
        height: 16px;
        color: #3b82f6;
    }

    .credits-badge-ladob {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .credits-username {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
    }

    .credits-follow-btn {
        background: white;
        color: black;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .credits-follow-btn:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: scale(1.05);
    }

    .credits-follow-btn.following {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
    }

    /* Descripci√≥n del post */
    .credits-description {
        font-size: 14px;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        max-width: 300px;
    }

    /* M√∫sica */
    .credits-music {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
    }

    .credits-music svg {
        width: 14px;
        height: 14px;
    }

    .credits-music-text {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========================================
       ACCIONES - DERECHA (COLUMNA VERTICAL)
       ======================================== */
    .credits-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        pointer-events: auto;
        margin-bottom: 10px;
    }

    .credits-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        background: transparent;
        border: none;
        color: white;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        transition: transform 0.2s ease;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
    }

    .credits-action-btn:hover {
        transform: scale(1.1);
    }

    .credits-action-btn:active {
        transform: scale(0.95);
    }

    .credits-action-btn.liked {
        color: #ef4444;
    }

    .credits-action-btn svg {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .credits-action-btn.liked svg {
        fill: #ef4444;
    }

    .credits-likes-count,
    .credits-comments-count {
        font-size: 13px;
    }

    /* Bot√≥n compartir */
    .credits-share-wrapper {
        position: relative;
    }

    .credits-share-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 8px 0;
        min-width: 160px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transition: all 0.2s ease;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .credits-share-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    .credits-share-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
    }

    .credits-share-option:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .credits-share-option svg {
        width: 18px;
        height: 18px;
    }

    /* Avatar del creador en acciones (peque√±o) */
    .credits-creator-avatar-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid white;
        cursor: pointer;
        margin-top: 8px;
    }

    .credits-creator-avatar-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ========================================
       NAVEGACI√ìN ARRIBA/ABAJO
       ======================================== */
    .fullscreen-nav-arrows {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 10002;
    }

    .fullscreen-nav-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .fullscreen-nav-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .fullscreen-nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .fullscreen-nav-btn svg {
        width: 28px;
        height: 28px;
        color: white;
    }

    /* Mobile adjustments */
    @@media (max-width: 768px) {
        .fullscreen-credits {
            padding: 16px;
            padding-bottom: 24px;
        }

        .credits-creator-section {
            max-width: 65%;
        }

        .credits-avatar,
        .credits-avatar-placeholder {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px;
            max-width: 36px;
            min-height: 36px;
            max-height: 36px;
            font-size: 14px;
        }

        .credits-name {
            font-size: 14px;
        }

        .credits-username {
            font-size: 12px;
        }

        .credits-description {
            font-size: 13px;
            -webkit-line-clamp: 2;
        }

        .credits-action-btn svg {
            width: 28px;
            height: 28px;
        }

        .credits-actions {
            gap: 16px;
        }

        .credits-follow-btn {
            padding: 6px 14px;
            font-size: 13px;
        }

        .fullscreen-nav-arrows {
            right: 12px;
        }

        .fullscreen-nav-btn {
            width: 40px;
            height: 40px;
        }

        .fullscreen-nav-btn svg {
            width: 24px;
            height: 24px;
        }
    }

    /* Ocultar navegaci√≥n en landscape peque√±o */
    @@media (max-height: 500px) and (orientation: landscape) {
        .fullscreen-nav-arrows {
            display: none;
        }

        .fullscreen-credits {
            bottom: 100px; /* 20px mas arriba que desktop */
            right: 12px;
        }

        .credits-name {
            font-size: 14px;
        }

        .credits-username {
            font-size: 12px;
        }

        .credits-action-btn svg {
            width: 26px;
            height: 26px;
        }

        .credits-actions {
            gap: 16px;
        }
    }

    /* Landscape mobile */
    @@media (max-height: 500px) and (orientation: landscape) {
        .fullscreen-credits {
            bottom: 10px;
            right: 10px;
        }

        .credits-action-btn svg {
            width: 22px;
            height: 22px;
        }

        .credits-actions {
            gap: 12px;
        }

        .credits-description {
            -webkit-line-clamp: 1;
            font-size: 12px;
        }
    }

    /* ========================================
       FULLSCREEN CARRUSEL VIEWER
       ======================================== */
    .carousel-fullscreen-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        overflow: hidden;
    }

    .carousel-fullscreen-viewer.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-fs-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .carousel-fs-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .carousel-fs-close svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .carousel-fs-counter {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10001;
    }

    .carousel-fs-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-fs-slide {
        display: none;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        box-sizing: border-box;
    }

    .carousel-fs-slide.active {
        display: flex;
    }

    .carousel-fs-slide img,
    .carousel-fs-slide video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .carousel-fs-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10001;
    }

    .carousel-fs-nav:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-fs-nav svg {
        width: 28px;
        height: 28px;
    }

    .carousel-fs-prev {
        left: 20px;
    }

    .carousel-fs-next {
        right: 20px;
    }

    .carousel-fs-dots {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10001;
    }

    .carousel-fs-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        transition: all 0.2s;
    }

    .carousel-fs-dot:hover {
        background: rgba(255, 255, 255, 0.7);
    }

    .carousel-fs-dot.active {
        background: white;
        transform: scale(1.2);
    }

    .carousel-fs-mute {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        transition: all 0.2s;
    }

    .carousel-fs-mute:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .carousel-fs-mute svg {
        width: 24px;
        height: 24px;
    }

    /* Responsive fullscreen carrusel */
    @@media (max-width: 768px) {
        .carousel-fs-nav {
            width: 40px;
            height: 40px;
        }

        .carousel-fs-prev {
            left: 10px;
        }

        .carousel-fs-next {
            right: 10px;
        }

        .carousel-fs-slide {
            padding: 50px 10px;
        }

        .carousel-fs-close {
            top: 10px;
            right: 10px;
        }

        .carousel-fs-counter {
            top: 15px;
            font-size: 12px;
        }

        .carousel-fs-dots {
            bottom: 20px;
        }

        .carousel-fs-dot {
            width: 8px;
            height: 8px;
        }
    }

    /* =====================================================
       OVERLAY CONTENIDO SENSIBLE
    ===================================================== */
    .sensitive-content-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(40px) saturate(1.2);
        -webkit-backdrop-filter: blur(40px) saturate(1.2);
    }

    .sensitive-warning {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 30px;
        max-width: 90%;
    }

    .sensitive-icon {
        width: 56px;
        height: 56px;
        stroke: rgba(255, 255, 255, 0.85);
        margin-bottom: 16px;
    }

    .sensitive-title {
        font-size: 18px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 10px;
    }

    .sensitive-text {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.85);
        max-width: 280px;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .sensitive-reveal-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.6);
        color: #fff;
        padding: 10px 28px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sensitive-reveal-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: #fff;
    }

    .sensitive-reveal-btn:active {
        transform: scale(0.95);
    }

    /* Animaci√≥n de fade out al revelar */
    .sensitive-content-overlay.revealing {
        animation: sensitiveReveal 0.3s ease forwards;
    }

    @@keyframes sensitiveReveal {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            pointer-events: none;
        }
    }

    /* ========================================
       MODAL DE REPORTES ESTILO INSTAGRAM
       ======================================== */
    .report-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeInOverlay 0.2s ease;
    }

    .report-modal-overlay.show {
        display: flex;
    }

    @@keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .report-modal {
        background: var(--surface);
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        max-height: 85vh;
        overflow: hidden;
        animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    @@keyframes slideUpModal {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .report-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--line);
    }

    .report-modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        flex: 1;
        text-align: center;
    }

    .report-modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--fg);
        cursor: pointer;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .report-modal-close:hover {
        background: var(--hover);
    }

    .report-modal-close svg {
        width: 20px;
        height: 20px;
    }

    .report-modal-subtitle {
        padding: 16px 20px 12px;
        font-size: 14px;
        color: var(--muted);
        line-height: 1.4;
    }

    .report-options {
        max-height: calc(85vh - 180px);
        overflow-y: auto;
    }

    .report-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
    }

    .report-option:hover {
        background: var(--hover);
    }

    .report-option:active {
        background: var(--line);
    }

    .report-option-content {
        flex: 1;
    }

    .report-option-title {
        font-size: 15px;
        color: var(--fg);
        font-weight: 400;
        margin-bottom: 2px;
    }

    .report-option-desc {
        font-size: 12px;
        color: var(--muted);
        display: none;
    }

    .report-option-arrow {
        color: var(--muted);
        flex-shrink: 0;
        margin-left: 12px;
    }

    .report-option-arrow svg {
        width: 20px;
        height: 20px;
    }

    /* Subopciones */
    .report-suboptions {
        display: none;
        animation: fadeInOptions 0.2s ease;
    }

    .report-suboptions.show {
        display: block;
    }

    @@keyframes fadeInOptions {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .report-back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 20px;
        font-size: 15px;
        color: var(--primary);
        cursor: pointer;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        border-bottom: 1px solid var(--line);
        font-weight: 500;
    }

    .report-back-btn:hover {
        background: var(--hover);
    }

    .report-back-btn svg {
        width: 18px;
        height: 18px;
    }

    .report-category-title {
        padding: 12px 20px 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Campo de texto adicional */
    .report-textarea-container {
        padding: 0 20px 16px;
        display: none;
    }

    .report-textarea-container.show {
        display: block;
    }

    .report-textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: var(--bg);
        color: var(--fg);
        font-size: 14px;
        resize: none;
        font-family: inherit;
    }

    .report-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .report-textarea::placeholder {
        color: var(--muted);
    }

    /* Boton de enviar */
    .report-submit-container {
        padding: 12px 20px 20px;
        display: none;
    }

    .report-submit-container.show {
        display: block;
    }

    .report-submit-btn {
        width: 100%;
        padding: 14px;
        background: #ed4956;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .report-submit-btn:hover {
        background: #dc3545;
        transform: translateY(-1px);
    }

    .report-submit-btn:active {
        transform: translateY(0);
    }

    .report-submit-btn:disabled {
        background: var(--muted);
        cursor: not-allowed;
        transform: none;
    }

    /* Confirmacion de envio */
    .report-confirmation {
        display: none;
        text-align: center;
        padding: 40px 20px;
    }

    .report-confirmation.show {
        display: block;
    }

    .report-confirmation-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .report-confirmation-icon svg {
        width: 32px;
        height: 32px;
        color: white;
    }

    .report-confirmation-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--fg);
        margin-bottom: 8px;
    }

    .report-confirmation-text {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
        margin-bottom: 24px;
    }

    .report-confirmation-btn {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .report-confirmation-btn:hover {
        opacity: 0.9;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .report-modal {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
            height: 100%;
        }

        .report-modal-overlay {
            align-items: flex-end;
        }

        @@supports (padding-bottom: env(safe-area-inset-bottom)) {
            .report-submit-container {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
    }

</style>

<div class="feed-page-layout">
    <!-- MAIN FEED -->
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <div class="pull-indicator">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        </div>
    </div>

    <div class="feed-main">
        <div class="feed-container">
            <!-- STORIES BAR -->
            @if (stories != null && stories.Any())
            {
                <div class="stories-bar">
                    <div class="stories-scroll">
                        @foreach (var storyGroup in stories)
                        {
                            <div class="story-item" onclick="window.location.href='/Feed/Perfil/@storyGroup.CreadorId'">
                                <div class="story-ring @(storyGroup.TieneStorysSinVer ? "" : "seen")">
                                    <div class="story-ring-inner">
                                        @if (!string.IsNullOrEmpty(storyGroup.Creador.FotoPerfil))
                                        {
                                            <img src="@storyGroup.Creador.FotoPerfil" alt="" class="story-avatar">
                                        }
                                        else
                                        {
                                            <div class="story-avatar-placeholder">
                                                @storyGroup.Creador.NombreCompleto.Substring(0, 1).ToUpper()
                                            </div>
                                        }
                                    </div>
                                </div>
                                <span class="story-username">@storyGroup.Creador.NombreCompleto.Split(' ')[0]</span>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- ALGORITHM SELECTOR -->
            @if (algoritmosDisponibles.Any())
            {
                var algoritmoActualId = algoritmoActual?.Id ?? 0;

                <div class="algorithm-selector">
                    <span class="algorithm-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        Ordenar por
                    </span>
                    <select class="algorithm-select" id="algorithmSelect" onchange="cambiarAlgoritmoSelect(this.value)">
                        @foreach (var alg in algoritmosDisponibles)
                        {
                            if (alg.Id == algoritmoActualId)
                            {
                                <option value="@alg.Id" selected>@alg.Nombre</option>
                            }
                            else
                            {
                                <option value="@alg.Id">@alg.Nombre</option>
                            }
                        }
                    </select>
                </div>
            }

    <!-- POSTS -->
    <div id="postsContainer">
    @if (Model.Any())
    {
        var postIndex = 0;
        var anuncioIndex = 0;
        var insertarAnuncioCada = 5; // Insertar anuncio cada 5 posts

        @foreach (var post in Model.Take(10))
        {
            var tiempoTexto = GetTimeAgo(post.FechaPublicacion);
            var urlPerfil = post.TipoLado == TipoLado.LadoB
                ? $"/Feed/Perfil/{post.UsuarioId}?verSeudonimo=true"
                : $"/Feed/Perfil/{post.UsuarioId}";
            var nombreUsuario = post.NombreMostrado ?? post.Usuario?.NombreCompleto ?? "Usuario";
            var usernameMostrado = post.TipoLado == TipoLado.LadoB
                ? (post.Usuario?.Seudonimo ?? post.Usuario?.UserName ?? "usuario")
                : (post.Usuario?.UserName ?? "usuario");
            var tipoMedia = post.TipoContenido;
            var esImagen = tipoMedia == TipoContenido.Foto || tipoMedia == TipoContenido.Imagen;
            var esVideo = tipoMedia == TipoContenido.Video;
            var esAudio = tipoMedia == TipoContenido.Audio;
            var esPost = tipoMedia == TipoContenido.Post;
            var tieneArchivo = !string.IsNullOrEmpty(post.RutaArchivo);

            // Soporte para carrusel (m√∫ltiples archivos)
            var archivosCarrusel = post.TodosLosArchivos;
            var esCarrusel = archivosCarrusel.Count > 1;
            var yaLeDioLike = likesUsuario.Contains(post.Id);
            var esFavorito = favoritosIds.Contains(post.Id);
            var estaBloqueado = contenidoBloqueadoIds.Contains(post.Id);
            var esPreviewBlur = post.EsPreviewBlurDeLadoB;
            var tipoCensura = post.TipoCensuraPreview ?? TipoCensuraPreview.Blur;

            // Determinar la foto de perfil seg√∫n el tipo de contenido
            var fotoPerfilMostrar = post.TipoLado == TipoLado.LadoB
                ? (post.Usuario?.FotoPerfilLadoB ?? post.Usuario?.FotoPerfil)
                : post.Usuario?.FotoPerfil;
            var sigueAlCreador = usuariosSeguidosIds.Contains(post.UsuarioId);
            <article class="post @(estaBloqueado ? "post-locked" : "")" data-post-id="@post.Id" data-locked="@estaBloqueado.ToString().ToLower()" data-creator-id="@post.UsuarioId" data-creator-name="@(post.Usuario?.Seudonimo ?? post.Usuario?.NombreCompleto ?? "Creador")" data-creator-photo="@(post.Usuario?.FotoPerfilLadoB ?? post.Usuario?.FotoPerfil)" data-creator-price="@(post.Usuario?.PrecioSuscripcion.ToString("0.00") ?? "0.00")" data-likes="@post.NumeroLikes" data-comments="@post.NumeroComentarios" data-is-following="@sigueAlCreador.ToString().ToLower()">
                <!-- Header -->
                <header class="post-header">
                    <a href="@urlPerfil" class="post-header-left">
                        @if (!string.IsNullOrEmpty(fotoPerfilMostrar))
                        {
                            <img src="@fotoPerfilMostrar" alt="" class="post-avatar" loading="lazy">
                        }
                        else
                        {
                            <div class="post-avatar-placeholder">
                                @nombreUsuario.Substring(0, 1).ToUpper()
                            </div>
                        }
                        <div class="post-user-info">
                            <span class="post-username">
                                @usernameMostrado
                                @if (post.Usuario?.CreadorVerificado == true)
                                {
                                    <svg class="verified-icon" viewBox="0 0 24 24" fill="#10b981" width="16" height="16" title="Creador verificado">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                        <polyline points="9 12 12 15 16 10" fill="none" stroke="white" stroke-width="2"></polyline>
                                    </svg>
                                }
                                @if (post.TipoLado == TipoLado.LadoB)
                                {
                                    <span class="post-badge badge-ladob">B</span>
                                }
                            </span>
                            <span class="post-time">@tiempoTexto</span>
                        </div>
                    </a>
                    <div class="post-menu" onclick="togglePostMenu(event, this)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="1.5"></circle>
                            <circle cx="6" cy="12" r="1.5"></circle>
                            <circle cx="18" cy="12" r="1.5"></circle>
                        </svg>
                        <div class="post-menu-dropdown" data-post-id="@post.Id" data-user-id="@post.UsuarioId" data-tipo-lado="@((int)post.TipoLado)">
                            <button class="post-menu-item" onclick="irAPublicacion(@post.Id)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="3" x2="9" y2="21"></line>
                                </svg>
                                Ir a la publicacion
                            </button>
                            <button class="post-menu-item" onclick="copiarEnlace(@post.Id)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                Copiar enlace
                            </button>
                            <button class="post-menu-item" onclick="agregarFavorito(@post.Id, this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Agregar a favoritos
                            </button>
                            @if (usuarioActual?.Id != post.UsuarioId)
                            {
                                <div class="post-menu-divider"></div>
                                <button class="post-menu-item" onclick="dejarDeSeguir('@post.UsuarioId', @((int)post.TipoLado), this)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                    Dejar de seguir
                                </button>
                                <button class="post-menu-item danger" onclick="bloquearUsuario('@post.UsuarioId', '@(post.Usuario?.NombreCompleto ?? "este usuario")')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    Bloquear usuario
                                </button>
                                <button class="post-menu-item danger" onclick="reportarContenido(@post.Id)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                        <line x1="4" y1="22" x2="4" y2="15"></line>
                                    </svg>
                                    Reportar
                                </button>
                            }
                        </div>
                    </div>
                </header>

                <!-- Media -->
                @if (estaBloqueado)
                {
                    <!-- Contenido bloqueado con blur y candado -->
                    <div class="locked-content-wrapper" onclick="openSubscribeModal(this.closest('.post'))">
                        <div class="locked-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            EXCLUSIVO
                        </div>
                        @if (tieneArchivo)
                        {
                            <div class="post-media">
                                @if (esImagen || (!esVideo && !esAudio))
                                {
                                    <img src="@post.RutaArchivo" alt="" loading="lazy">
                                }
                                else if (esVideo)
                                {
                                    <video src="@post.RutaArchivo" class="feed-video" muted loop playsinline="true" webkit-playsinline="true" preload="none" poster=""></video>
                                }
                                else if (esAudio)
                                {
                                    <div class="post-media-audio">
                                        <svg width="64" height="64" viewBox="0 0 24 24" fill="var(--primary)">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="post-text-content" style="min-height: 200px;">
                                @(post.Descripcion?.Length > 50 ? post.Descripcion.Substring(0, 50) + "..." : post.Descripcion)
                            </div>
                        }
                        <div class="locked-overlay">
                            <div class="locked-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                            </div>
                            <div class="locked-text">Contenido exclusivo de Lado B</div>
                            <button class="locked-subscribe-btn">Suscribirse para ver</button>
                        </div>
                    </div>
                }
                else if (esCarrusel)
                {
                    // Preparar datos JSON de archivos para el fullscreen viewer
                    var archivosJson = System.Text.Json.JsonSerializer.Serialize(archivosCarrusel.Select(a => new {
                        src = a.RutaArchivo,
                        type = a.TipoArchivo == TipoArchivo.Video ? "video" : "image"
                    }));
                    var primerArchivo = archivosCarrusel.First();
                    var tipoPrimerArchivo = primerArchivo.TipoArchivo == TipoArchivo.Video ? "video" : "image";
                    <!-- Carrusel de m√∫ltiples archivos -->
                    <div class="post-carousel post-media"
                         data-post-id="@post.Id"
                         data-is-carousel="true"
                         data-carousel-files='@archivosJson'
                         data-media-type="@tipoPrimerArchivo"
                         data-media-src="@primerArchivo.RutaArchivo"
                         onclick="openFullscreenViewer(event, @post.Id)"
                         style="cursor: pointer;">
                        <div class="carousel-container">
                            <div class="carousel-track" style="width: @(archivosCarrusel.Count * 100)%;">
                                @for (int i = 0; i < archivosCarrusel.Count; i++)
                                {
                                    var archivo = archivosCarrusel[i];
                                    var esArchivoVideo = archivo.TipoArchivo == TipoArchivo.Video;
                                    <div class="carousel-slide" data-index="@i" style="width: @(100.0 / archivosCarrusel.Count)%;">
                                        @if (esArchivoVideo)
                                        {
                                            <video src="@archivo.RutaArchivo" class="carousel-media feed-video" muted loop playsinline="true" webkit-playsinline="true" preload="none"></video>
                                            <div class="video-play-icon carousel-play-icon">
                                                <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                                <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                            </div>
                                        }
                                        else
                                        {
                                            <img src="@archivo.RutaArchivo" alt="" class="carousel-media" loading="lazy">
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <!-- Navegaci√≥n del carrusel -->
                        @if (archivosCarrusel.Count > 1)
                        {
                            <button class="carousel-btn carousel-prev" onclick="carouselPrev(event, this)">
                                <svg viewBox="0 0 24 24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                            </button>
                            <button class="carousel-btn carousel-next" onclick="carouselNext(event, this)">
                                <svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                            </button>
                            <div class="carousel-dots">
                                @for (int i = 0; i < archivosCarrusel.Count; i++)
                                {
                                    <span class="carousel-dot @(i == 0 ? "active" : "")" data-index="@i"></span>
                                }
                            </div>
                            <div class="carousel-counter">1/@archivosCarrusel.Count</div>
                        }
                        @* Overlay de contenido sensible *@
                        @if (post.EsContenidoSensible)
                        {
                            <div class="sensitive-content-overlay" data-post-id="@post.Id">
                                <div class="sensitive-warning">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="sensitive-icon">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <line x1="2" y1="2" x2="22" y2="22"></line>
                                    </svg>
                                    <span class="sensitive-title">Contenido Delicado</span>
                                    <span class="sensitive-text">Esta foto incluye contenido delicado que algunas personas pueden encontrar ofensivo o molesto.</span>
                                    <button class="sensitive-reveal-btn" onclick="revelarContenidoSensible(event, @post.Id)">Ver</button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (tieneArchivo)
                {
                    // Determinar clase de efecto blur
                    var blurEffectClass = esPreviewBlur ? tipoCensura switch
                    {
                        TipoCensuraPreview.Blur => "blur-effect",
                        TipoCensuraPreview.Pixelado => "pixelado-effect",
                        TipoCensuraPreview.Silueta => "silueta-effect",
                        TipoCensuraPreview.Parcial => "parcial-effect",
                        _ => "blur-effect"
                    } : "";

                    <div class="post-media @(esPreviewBlur ? "preview-blur-wrapper " + blurEffectClass : "")"
                         data-post-id="@post.Id"
                         data-media-type="@(esVideo ? "video" : (esAudio ? "audio" : "image"))"
                         data-media-src="@post.RutaArchivo"
                         data-is-preview-blur="@esPreviewBlur.ToString().ToLower()"
                         @if (post.PistaMusical != null)
                         {
                             <text>data-audio-src="@post.PistaMusical.RutaArchivo"</text>
                             <text>data-audio-title="@post.PistaMusical.Titulo"</text>
                             <text>data-audio-artist="@post.PistaMusical.Artista"</text>
                             <text>data-audio-start="@(post.AudioTrimInicio ?? 0)"</text>
                             <text>data-audio-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))"</text>
                         }
                         @if (!esPreviewBlur)
                         {
                            <text>onclick="openFullscreenViewer(event, @post.Id)"</text>
                         }
                         style="cursor: pointer;">
                        @if (esPreviewBlur)
                        {
                            <!-- Badge LadoB -->
                            <div class="ladob-preview-badge">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                LadoB
                            </div>
                            <!-- Overlay con bot√≥n -->
                            <div class="preview-blur-overlay">
                                <div class="preview-blur-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <div class="preview-blur-text">Contenido Exclusivo</div>
                                <div class="preview-blur-subtext">Disponible en LadoB de @nombreUsuario</div>
                                <a href="/Feed/Creador/@(post.Usuario?.Seudonimo)" class="preview-blur-btn" onclick="event.stopPropagation();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polygon points="10,8 16,12 10,16"/>
                                    </svg>
                                    Ver en LadoB
                                </a>
                            </div>
                        }
                        @if (esImagen)
                        {
                            <img src="@post.RutaArchivo" alt="" loading="lazy">
                            @if (!string.IsNullOrEmpty(post.NombreUbicacion))
                            {
                                <!-- Badge de ubicaci√≥n -->
                                <div class="location-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span>@post.NombreUbicacion</span>
                                </div>
                            }
                            @if (post.PistaMusical != null)
                            {
                                <!-- Badge de m√∫sica estilo Instagram para foto -->
                                <div class="music-badge" data-post-id="@post.Id">
                                    <div class="music-badge-icon">
                                        <svg viewBox="0 0 24 24" fill="white">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                    </div>
                                    <div class="music-badge-info">
                                        <div class="music-badge-title">@post.PistaMusical.Titulo</div>
                                        <div class="music-badge-artist">@post.PistaMusical.Artista</div>
                                    </div>
                                </div>
                                <!-- Audio oculto para reproducci√≥n -->
                                <audio class="photo-audio-player"
                                       data-post-id="@post.Id"
                                       src="@post.PistaMusical.RutaArchivo"
                                       preload="metadata"
                                       loop
                                       data-start="@(post.AudioTrimInicio ?? 0)"
                                       data-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                                </audio>
                            }
                        }
                        else if (esVideo)
                        {
                            <video src="@post.RutaArchivo"
                                   class="feed-video"
                                   muted
                                   loop
                                   playsinline="true"
                                   webkit-playsinline="true"
                                   preload="none"
                                   data-post-id="@post.Id">
                            </video>
                            <div class="video-controls-overlay" onclick="handleVideoClick(event, this)">
                                <div class="video-play-icon">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </div>
                                <button class="video-mute-btn" onclick="toggleVideoMute(event, this)" title="Activar/Desactivar sonido">
                                    <svg class="muted-icon" viewBox="0 0 24 24" fill="white">
                                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                    </svg>
                                    <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            </div>
                        }
                        else if (esAudio)
                        {
                            <div class="post-media-audio">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="var(--primary)">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                                <audio src="@post.RutaArchivo" controls preload="metadata" onclick="event.stopPropagation()"></audio>
                            </div>
                        }
                        else
                        {
                            <img src="@post.RutaArchivo" alt="" loading="lazy" onerror="this.style.display='none'">
                            @if (!string.IsNullOrEmpty(post.NombreUbicacion))
                            {
                                <!-- Badge de ubicaci√≥n -->
                                <div class="location-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span>@post.NombreUbicacion</span>
                                </div>
                            }
                            @if (post.PistaMusical != null)
                            {
                                <!-- Badge de m√∫sica estilo Instagram -->
                                <div class="music-badge" data-post-id="@post.Id">
                                    <div class="music-badge-icon">
                                        <svg viewBox="0 0 24 24" fill="white">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                    </div>
                                    <div class="music-badge-info">
                                        <div class="music-badge-title">@post.PistaMusical.Titulo</div>
                                        <div class="music-badge-artist">@post.PistaMusical.Artista</div>
                                    </div>
                                </div>
                                <!-- Audio oculto para reproducci√≥n -->
                                <audio class="photo-audio-player"
                                       data-post-id="@post.Id"
                                       src="@post.PistaMusical.RutaArchivo"
                                       preload="metadata"
                                       loop
                                       data-start="@(post.AudioTrimInicio ?? 0)"
                                       data-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                                </audio>
                            }
                        }
                        @* Overlay de contenido sensible *@
                        @if (post.EsContenidoSensible)
                        {
                            <div class="sensitive-content-overlay" data-post-id="@post.Id">
                                <div class="sensitive-warning">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="sensitive-icon">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <line x1="2" y1="2" x2="22" y2="22"></line>
                                    </svg>
                                    <span class="sensitive-title">Contenido Delicado</span>
                                    <span class="sensitive-text">Esta foto incluye contenido delicado que algunas personas pueden encontrar ofensivo o molesto.</span>
                                    <button class="sensitive-reveal-btn" onclick="revelarContenidoSensible(event, @post.Id)">Ver</button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (esPost && !string.IsNullOrEmpty(post.Descripcion))
                {
                    <div class="post-text-content">
                        @post.Descripcion
                    </div>
                }

                <!-- Actions -->
                <div class="post-actions">
                    <button class="action-btn like-btn @(yaLeDioLike ? "liked" : "")" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <button class="action-btn comment-btn" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn share-btn" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <div class="action-spacer"></div>
                    <button class="action-btn bookmark-btn @(esFavorito ? "bookmarked" : "")" data-id="@post.Id" title="@(esFavorito ? "Quitar de favoritos" : "Guardar en favoritos")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <button class="action-btn detail-btn" data-id="@post.Id" title="Ver detalle" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                    </button>
                </div>

                <!-- Likes -->
                <div class="post-likes">
                    <span class="post-likes-count" id="likes-@post.Id">@post.NumeroLikes Me gusta</span>
                </div>

                <!-- Caption -->
                @if (!string.IsNullOrEmpty(post.Descripcion) && tieneArchivo)
                {
                    <div class="post-caption">
                        <p class="post-caption-text">
                            <span class="post-caption-username">@usernameMostrado</span>@post.Descripcion
                        </p>
                    </div>
                }

                <!-- Comments Preview - Estilo Instagram -->
                @if (post.Comentarios != null && post.Comentarios.Any())
                {
                    <div class="post-comments-preview">
                        @if (post.NumeroComentarios > 2)
                        {
                            <div class="view-all-comments" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                Ver los @post.NumeroComentarios comentarios
                            </div>
                        }
                        @foreach (var comment in post.Comentarios.Where(c => c.ComentarioPadreId == null).Take(2))
                        {
                            var tcDiff = DateTime.Now - comment.FechaCreacion;
                            var tcTexto = tcDiff.TotalDays >= 1 ? $"{(int)tcDiff.TotalDays}d" :
                                tcDiff.TotalHours >= 1 ? $"{(int)tcDiff.TotalHours}h" : $"{(int)tcDiff.TotalMinutes}m";
                            var numRespuestas = post.Comentarios.Count(c => c.ComentarioPadreId == comment.Id);

                            <div class="feed-comment-item" data-comment-id="@comment.Id">
                                <div class="feed-comment-avatar">
                                    @if (!string.IsNullOrEmpty(comment.Usuario?.FotoPerfil))
                                    {
                                        <img src="@comment.Usuario.FotoPerfil" alt="">
                                    }
                                    else
                                    {
                                        <div class="feed-comment-avatar-initial">@(comment.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "U")</div>
                                    }
                                </div>
                                <div class="feed-comment-content">
                                    <div class="feed-comment-header">
                                        <a href="/Feed/Perfil/@comment.Usuario?.UserName" class="feed-comment-username">@(comment.Usuario?.UserName ?? "usuario")</a>
                                        <span class="feed-comment-time">@tcTexto</span>
                                    </div>
                                    <p class="feed-comment-text">@comment.Texto</p>
                                    <div class="feed-comment-actions">
                                        <button class="feed-comment-action-btn like-btn" onclick="toggleFeedCommentLike(@comment.Id, this)" data-comment-id="@comment.Id">
                                            <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                            <span class="count">@(comment.NumeroLikes > 0 ? comment.NumeroLikes.ToString() : "")</span>
                                        </button>
                                        <button class="feed-comment-action-btn" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                            <span class="count">@(numRespuestas > 0 ? numRespuestas.ToString() : "")</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            @if (numRespuestas > 0)
                            {
                                <div class="feed-show-replies" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                    <div class="feed-reply-avatars">
                                        @foreach (var resp in post.Comentarios.Where(c => c.ComentarioPadreId == comment.Id).Take(2))
                                        {
                                            if (!string.IsNullOrEmpty(resp.Usuario?.FotoPerfil))
                                            {
                                                <img src="@resp.Usuario.FotoPerfil" alt="">
                                            }
                                        }
                                    </div>
                                    <span>Mostrar respuestas</span>
                                </div>
                            }
                        }
                    </div>
                }

                <!-- Add Comment -->
                <div class="post-add-comment">
                    <input type="text" class="comment-input" placeholder="Agrega un comentario..." data-post-id="@post.Id">
                    <button class="comment-post-btn" data-post-id="@post.Id" disabled>Publicar</button>
                </div>

                <!-- Timestamp -->
                <div class="post-timestamp">
                    @post.FechaPublicacion.ToString("dd MMMM yyyy").ToUpper()
                </div>
            </article>

            @* Insertar anuncio cada N posts *@
            postIndex++;
            if (postIndex % insertarAnuncioCada == 0 && anuncioIndex < anuncios.Count)
            {
                var anuncioFeed = anuncios[anuncioIndex];
                anuncioIndex++;

                <article class="post-ad">
                    <div class="post-ad-header">
                        <div class="post-ad-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                            </svg>
                        </div>
                        <div class="post-ad-info">
                            <div class="post-ad-label">Patrocinado</div>
                            <div class="post-ad-badge">
                                <i class="fas fa-ad"></i>
                                <span>Publicidad</span>
                            </div>
                        </div>
                    </div>
                    <a href="@Url.Action("RedirectAnuncio", "FeedPublico", new { id = anuncioFeed.Id })" target="_blank" class="post-ad-media">
                        @if (anuncioFeed.TipoCreativo == TipoCreativo.Video && !string.IsNullOrEmpty(anuncioFeed.UrlCreativo))
                        {
                            <video src="@Url.Content($"~{anuncioFeed.UrlCreativo}")" muted autoplay loop playsinline></video>
                        }
                        else if (!string.IsNullOrEmpty(anuncioFeed.UrlCreativo))
                        {
                            <img src="@Url.Content($"~{anuncioFeed.UrlCreativo}")" alt="Anuncio">
                        }
                    </a>
                    <div class="post-ad-content">
                        <a href="@Url.Action("RedirectAnuncio", "FeedPublico", new { id = anuncioFeed.Id })" target="_blank" class="post-ad-cta">
                            @anuncioFeed.TextoBotonDisplay
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </article>
            }
        }
    }
    else
    {
        <div class="empty-feed">
            <h3>Tu feed esta vacio</h3>
            <p>Sigue a creadores para ver su contenido aqui</p>
            <a href="/Feed/Explorar" class="empty-feed-btn">Explorar creadores</a>
        </div>
    }
    </div><!-- /#postsContainer -->

    <!-- Infinite Scroll Loader -->
    <div class="infinite-scroll-loader" id="infiniteScrollLoader">
        <div class="loader-spinner"></div>
    </div>
    <div class="infinite-scroll-end" id="infiniteScrollEnd" style="display: none;">
        Has llegado al final del feed
    </div>

        </div><!-- /.feed-container -->
    </div><!-- /.feed-main -->

    <!-- SIDEBAR -->
    <aside class="feed-sidebar">
        <!-- Usuario actual -->
        @if (usuarioActual != null)
        {
            <div class="sidebar-section">
                <a href="/Feed/Perfil/@usuarioActual.Id" class="sidebar-user" style="text-decoration: none;">
                    @if (!string.IsNullOrEmpty(usuarioActual.FotoPerfil))
                    {
                        <img src="@usuarioActual.FotoPerfil" alt="" class="sidebar-user-avatar">
                    }
                    else
                    {
                        <div class="sidebar-user-avatar-placeholder">
                            @usuarioActual.NombreCompleto.Substring(0, 1).ToUpper()
                        </div>
                    }
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">@usuarioActual.UserName</div>
                        <div class="sidebar-user-username">@usuarioActual.NombreCompleto</div>
                    </div>
                </a>
            </div>
        }

        <!-- Sugerencias -->
        @if (creadoresSugeridos.Any())
        {
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <span class="sidebar-title">Sugerencias para ti</span>
                    <a href="/Feed/Explorar" class="sidebar-see-all">Ver todo</a>
                </div>
                @foreach (var creador in creadoresSugeridos.Take(5))
                {
                    // Mostrar seg√∫n LadoPreferido del creador (solo si tiene LadoB configurado)
                    var tieneLadoB = creador.EsCreador && !string.IsNullOrEmpty(creador.Seudonimo);
                    var mostrarComoLadoB = tieneLadoB && creador.LadoPreferido == TipoLado.LadoB;
                    var nombreMostrar = mostrarComoLadoB ? creador.Seudonimo : creador.NombreCompleto;
                    var fotoMostrar = mostrarComoLadoB ? (creador.FotoPerfilLadoB ?? creador.FotoPerfil) : creador.FotoPerfil;
                    var urlPerfil = mostrarComoLadoB ? $"/Feed/Creador/{creador.Seudonimo}" : $"/Feed/Perfil/{creador.Id}";
                    var inicialMostrar = !string.IsNullOrEmpty(nombreMostrar) ? nombreMostrar.Substring(0, 1).ToUpper() : "?";

                    <div class="suggestion-item">
                        @if (!string.IsNullOrEmpty(fotoMostrar))
                        {
                            <img src="@fotoMostrar" alt="" class="suggestion-avatar">
                        }
                        else
                        {
                            <div class="suggestion-avatar-placeholder">
                                @inicialMostrar
                            </div>
                        }
                        <div class="suggestion-info">
                            <a href="@urlPerfil" class="suggestion-name">
                                @nombreMostrar
                                @if (mostrarComoLadoB)
                                {
                                    <span class="suggestion-badge-b">B</span>
                                }
                            </a>
                            <div class="suggestion-reason">
                                @if (creador.CreadorVerificado)
                                {
                                    <text>Creador verificado</text>
                                }
                                else if (creador.NumeroSeguidores > 0)
                                {
                                    <text>@creador.NumeroSeguidores seguidores</text>
                                }
                                else
                                {
                                    <text>Sugerido para ti</text>
                                }
                            </div>
                        </div>
                        <button class="suggestion-follow-btn" onclick="seguirUsuario('@creador.Id', this)">Seguir</button>
                    </div>
                }
            </div>
        }

        <div class="sidebar-footer">
            <a href="#">Acerca de</a> ¬∑
            <a href="#">Ayuda</a> ¬∑
            <a href="#">Privacidad</a> ¬∑
            <a href="#">Terminos</a>
            <br>
            ¬© 2024 Lado
        </div>
    </aside>
</div><!-- /.feed-page-layout -->

<!-- Share Modal -->
<div class="modal-overlay" id="shareModal">
    <div class="share-modal">
        <div class="share-modal-header">
            Compartir
            <button class="share-modal-close" onclick="closeShareModal()">&times;</button>
        </div>

        <!-- Vista principal de opciones -->
        <div id="shareMainView">
            <div class="share-options">
                <div class="share-option" id="shareFriends" onclick="openFriendsPanel()">
                    <div class="share-option-icon friends">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </div>
                    <span class="share-option-label">Amigos</span>
                </div>
                <a class="share-option" id="shareWhatsApp" target="_blank">
                    <div class="share-option-icon whatsapp">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </div>
                    <span class="share-option-label">WhatsApp</span>
                </a>
                <a class="share-option" id="shareTelegram" target="_blank">
                    <div class="share-option-icon telegram">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                    </div>
                    <span class="share-option-label">Telegram</span>
                </a>
                <a class="share-option" id="shareTwitter" target="_blank">
                    <div class="share-option-icon twitter">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                    </div>
                    <span class="share-option-label">Twitter</span>
                </a>
                <div class="share-option" id="shareCopy" onclick="copyShareUrl()">
                    <div class="share-option-icon copy">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </div>
                    <span class="share-option-label">Copiar</span>
                </div>
            </div>
            <div class="share-url-section">
                <input type="text" class="share-url-input" id="shareUrlInput" readonly>
            </div>
        </div>

        <!-- Panel de amigos -->
        <div class="share-friends-panel" id="friendsPanel">
            <div class="friends-panel-header">
                <button class="friends-panel-back" onclick="closeFriendsPanel()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <span class="friends-panel-title">Enviar a amigos</span>
            </div>
            <div class="friends-search">
                <input type="text" id="friendsSearchInput" placeholder="Buscar amigos...">
            </div>
            <div class="friends-list" id="friendsList">
                <div class="friends-loading">Cargando amigos...</div>
            </div>
            <button class="send-friends-btn" id="sendToFriendsBtn" disabled onclick="sendToSelectedFriends()">
                Enviar
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE REPORTES ESTILO INSTAGRAM -->
<div class="report-modal-overlay" id="reportModal">
    <div class="report-modal">
        <!-- Header -->
        <div class="report-modal-header">
            <div style="width: 32px;"></div>
            <span class="report-modal-title">Reportar</span>
            <button class="report-modal-close" onclick="closeReportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Contenido principal -->
        <div id="reportMainContent">
            <div class="report-modal-subtitle">
                ¬øPor qu√© quieres reportar esta publicaci√≥n?
            </div>

            <div class="report-options">
                <!-- Opcion 1: No me gusta -->
                <button class="report-option" onclick="selectReportReason('No me gusta', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Simplemente no me gusta</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 2: Bullying -->
                <button class="report-option" onclick="selectReportReason('Bullying o acoso', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Bullying o contacto no deseado</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 3: Autolesion -->
                <button class="report-option" onclick="selectReportReason('Autolesi√≥n o suicidio', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Suicidio, autolesi√≥n o trastornos alimentarios</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 4: Violencia -->
                <button class="report-option" onclick="showReportSuboptions('violencia')">
                    <div class="report-option-content">
                        <div class="report-option-title">Violencia, odio o explotaci√≥n</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 5: Venta restringida -->
                <button class="report-option" onclick="selectReportReason('Venta de art√≠culos restringidos', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Venta o promoci√≥n de art√≠culos restringidos</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 6: Contenido sexual -->
                <button class="report-option" onclick="showReportSuboptions('sexual')">
                    <div class="report-option-content">
                        <div class="report-option-title">Desnudos o actividad sexual</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 7: Spam -->
                <button class="report-option" onclick="selectReportReason('Estafa, fraude o spam', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Estafa, fraude o spam</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 8: Info falsa -->
                <button class="report-option" onclick="selectReportReason('Informaci√≥n falsa', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Informaci√≥n falsa</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 9: Suplantaci√≥n -->
                <button class="report-option" onclick="selectReportReason('Suplantaci√≥n de identidad', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Suplantaci√≥n de identidad</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 10: Propiedad intelectual -->
                <button class="report-option" onclick="selectReportReason('Infracci√≥n de propiedad intelectual', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Infracci√≥n de propiedad intelectual</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 11: Otro -->
                <button class="report-option" onclick="selectReportReason('Otro motivo', true)">
                    <div class="report-option-content">
                        <div class="report-option-title">Otro motivo</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- Subopciones: Violencia -->
        <div class="report-suboptions" id="reportSubViolencia">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title">Violencia, odio o explotaci√≥n</div>
            <div class="report-options">
                <button class="report-option" onclick="selectReportReason('Violencia gr√°fica', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Violencia gr√°fica</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Amenazas de violencia', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Amenazas de violencia</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Discurso de odio', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Discurso de odio o s√≠mbolos</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Crueldad animal', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Crueldad o maltrato animal</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Explotaci√≥n de menores', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Explotaci√≥n de menores</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Terrorismo o extremismo', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Terrorismo o extremismo</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Subopciones: Sexual -->
        <div class="report-suboptions" id="reportSubSexual">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title">Desnudos o actividad sexual</div>
            <div class="report-options">
                <button class="report-option" onclick="selectReportReason('Desnudos no solicitados', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Desnudos sin consentimiento</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Contenido sexual expl√≠cito', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Actividad sexual expl√≠cita</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Solicitud sexual', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Solicitud o explotaci√≥n sexual</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Contenido sexual de menores', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Involucramiento de menores</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Paso 2: Detalles adicionales -->
        <div class="report-suboptions" id="reportDetailsStep">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title" id="selectedReasonTitle">Motivo seleccionado</div>

            <div class="report-textarea-container show">
                <textarea
                    class="report-textarea"
                    id="reportDetails"
                    placeholder="Describe con m√°s detalle el problema (opcional)..."
                    maxlength="500"></textarea>
            </div>

            <div class="report-submit-container show">
                <button class="report-submit-btn" id="submitReportBtn" onclick="submitReport()">
                    Enviar reporte
                </button>
            </div>
        </div>

        <!-- Confirmaci√≥n -->
        <div class="report-confirmation" id="reportConfirmation">
            <div class="report-confirmation-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="report-confirmation-title">Gracias por informarnos</div>
            <div class="report-confirmation-text">
                Tu reporte nos ayuda a mantener la comunidad segura.
                Revisaremos este contenido y tomaremos las medidas necesarias.
            </div>
            <button class="report-confirmation-btn" onclick="closeReportModal()">
                Listo
            </button>
        </div>
    </div>
</div>

@functions {
    string GetTimeAgo(DateTime fecha)
    {
        var diff = DateTime.Now - fecha;
        if (diff.TotalDays >= 7) return fecha.ToString("dd MMM");
        if (diff.TotalDays >= 1) return $"Hace {(int)diff.TotalDays}d";
        if (diff.TotalHours >= 1) return $"Hace {(int)diff.TotalHours}h";
        if (diff.TotalMinutes >= 1) return $"Hace {(int)diff.TotalMinutes}m";
        return "Ahora";
    }
}

<script>
    let currentShareUrl = '';

    // Set global para debounce de likes (evitar spam)
    const likeInProgress = new Set();

    // Funci√≥n de escape para prevenir XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Toast deshabilitado en el feed
    function showToast(msg) {
        // No hacer nada - toasts deshabilitados en el feed
    }

    // Sobrescribir window.showToast DESPU√âS de que el layout lo defina
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            window.showToast = function(type, title, msg) {
                // No hacer nada - toasts deshabilitados en el feed
            };
        }, 100);
    });

    // ========================================
    // LIKES EN COMENTARIOS DEL FEED
    // ========================================

    async function toggleFeedCommentLike(comentarioId, btn) {
        try {
            const svg = btn.querySelector('svg');
            const countSpan = btn.querySelector('.count');
            const isLiked = svg.classList.contains('liked');

            // Actualizaci√≥n optimista
            if (isLiked) {
                svg.classList.remove('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount > 1 ? currentCount - 1 : '';
            } else {
                svg.classList.add('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount + 1;
            }

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const response = await fetch('/Feed/ToggleLikeComentario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comentarioId=${comentarioId}&__RequestVerificationToken=${encodeURIComponent(token || '')}`
            });

            const data = await response.json();

            if (data.success) {
                countSpan.textContent = data.likes > 0 ? data.likes : '';
                if (data.meDioLike) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            } else {
                // Revertir
                if (isLiked) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            }
        } catch (error) {
            console.error('Error al procesar like:', error);
        }
    }

    // ========================================
    // PULL TO REFRESH & INFINITE SCROLL
    // ========================================
    let currentPage = 1; // Empezamos en p√°gina 1 porque la 0 ya est√° cargada
    let isLoadingMore = false;
    let hasMorePosts = @(Model.Count() > 10 ? "true" : "false");
    let isPulling = false;
    let pullStartY = 0;
    let pullDistance = 0;
    const PULL_THRESHOLD = 80;

    // Pull to Refresh
    function initPullToRefresh() {
        const pullIndicator = document.getElementById('pullToRefresh');
        const feedMain = document.querySelector('.feed-main');

        if (!pullIndicator || !feedMain) return;

        let touchStartY = 0;
        let touchCurrentY = 0;

        feedMain.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
                isPulling = true;
            }
        }, { passive: true });

        feedMain.addEventListener('touchmove', (e) => {
            if (!isPulling || window.scrollY > 0) {
                pullIndicator.classList.remove('visible', 'ready');
                return;
            }

            touchCurrentY = e.touches[0].clientY;
            pullDistance = touchCurrentY - touchStartY;

            if (pullDistance > 0 && pullDistance < 150) {
                pullIndicator.classList.add('visible');

                if (pullDistance > PULL_THRESHOLD) {
                    pullIndicator.classList.add('ready');
                } else {
                    pullIndicator.classList.remove('ready');
                }
            }
        }, { passive: true });

        feedMain.addEventListener('touchend', () => {
            if (isPulling && pullDistance > PULL_THRESHOLD) {
                refreshFeed();
            } else {
                pullIndicator.classList.remove('visible', 'ready');
            }
            isPulling = false;
            pullDistance = 0;
        });
    }

    async function refreshFeed() {
        const pullIndicator = document.getElementById('pullToRefresh');
        pullIndicator.classList.remove('ready');
        pullIndicator.classList.add('refreshing');

        try {
            // Obtener los posts m√°s recientes sin recargar la p√°gina
            const response = await fetch('/Feed/CargarMasPosts?pagina=0&cantidad=10&refresh=true');
            const data = await response.json();

            if (data.success && data.posts.length > 0) {
                const postsContainer = document.getElementById('postsContainer');
                const existingIds = new Set(
                    Array.from(postsContainer.querySelectorAll('.post[data-post-id]'))
                        .map(p => p.dataset.postId)
                );

                // Solo agregar posts que no existen
                let newPostsHtml = '';
                let newCount = 0;
                data.posts.forEach(post => {
                    if (!existingIds.has(String(post.id))) {
                        newPostsHtml += renderPost(post);
                        newCount++;
                    }
                });

                if (newPostsHtml) {
                    // Agregar al inicio
                    postsContainer.insertAdjacentHTML('afterbegin', newPostsHtml);

                    // Inicializar observers para nuevos posts
                    initVideoObserversForNewPosts();
                    if (typeof initCarousels === 'function') {
                        initCarousels();
                    }

                    // Mostrar notificaci√≥n breve
                    console.log(`${newCount} nuevos posts cargados`);
                }
            }

            // Scroll suave al inicio si hay nuevos posts
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            console.error('Error al refrescar:', error);
        } finally {
            pullIndicator.classList.remove('refreshing', 'visible');
            pullIndicator.style.transform = 'translateX(-50%) translateY(-100%)';
        }
    }

    // Infinite Scroll
    function initInfiniteScroll() {
        const loader = document.getElementById('infiniteScrollLoader');
        const endMessage = document.getElementById('infiniteScrollEnd');
        const postsContainer = document.getElementById('postsContainer');

        if (!loader || !postsContainer) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !isLoadingMore && hasMorePosts) {
                    loadMorePosts();
                }
            });
        }, { rootMargin: '200px' }); // Cargar antes de llegar al final

        observer.observe(loader);
    }

    async function loadMorePosts() {
        if (isLoadingMore || !hasMorePosts) return;

        isLoadingMore = true;
        const loader = document.getElementById('infiniteScrollLoader');
        const endMessage = document.getElementById('infiniteScrollEnd');

        loader.classList.add('visible');

        try {
            const response = await fetch(`/Feed/CargarMasPosts?pagina=${currentPage}&cantidad=10`);
            const data = await response.json();

            if (data.success && data.posts.length > 0) {
                const postsContainer = document.getElementById('postsContainer');

                data.posts.forEach(post => {
                    const postHtml = renderPost(post);
                    postsContainer.insertAdjacentHTML('beforeend', postHtml);
                });

                currentPage++;
                hasMorePosts = data.hayMas;

                // Reinicializar carruseles y observers para los nuevos posts
                if (typeof initCarousels === 'function') {
                    initCarousels();
                }

                // Reinicializar video observers
                initVideoObserversForNewPosts();

                // Limpiar observers antiguos para evitar memory leak
                cleanupOldObservers();

            } else {
                hasMorePosts = false;
            }

            if (!hasMorePosts) {
                loader.style.display = 'none';
                endMessage.style.display = 'block';
            }

        } catch (error) {
            console.error('Error cargando m√°s posts:', error);
        } finally {
            isLoadingMore = false;
            loader.classList.remove('visible');
        }
    }

    function renderPost(post) {
        const tiempoTexto = getTimeAgo(new Date(post.fechaPublicacion));
        const urlPerfil = post.tipoLado === 1
            ? `/Feed/Perfil/${post.usuarioId}?verSeudonimo=true`
            : `/Feed/Perfil/${post.usuarioId}`;
        const nombreMostrado = post.tipoLado === 1 ? (post.seudonimo || 'An√≥nimo') : post.nombreCompleto;
        const fotoPerfilMostrar = post.tipoLado === 1 ? (post.fotoPerfilLadoB || post.fotoPerfil) : post.fotoPerfil;
        const usernameMostrado = post.tipoLado === 1 ? '******' : post.username;

        let mediaHtml = '';
        if (post.rutaArchivo) {
            if (post.esCarrusel && post.archivos.length > 1) {
                const archivosJson = JSON.stringify(post.archivos).replace(/"/g, '&quot;');
                mediaHtml = `
                    <div class="post-carousel post-media"
                         data-post-id="${post.id}"
                         data-is-carousel="true"
                         data-carousel-files='${archivosJson}'
                         onclick="openFullscreenViewer(event, ${post.id})"
                         style="cursor: pointer;">
                        <img src="${post.archivos[0].rutaArchivo}" alt="" loading="lazy">
                        <div class="carousel-counter">1/${post.archivos.length}</div>
                    </div>`;
            } else if (post.esVideo) {
                mediaHtml = `
                    <div class="post-media video-paused"
                         data-post-id="${post.id}"
                         data-media-type="video"
                         data-media-src="${post.rutaArchivo}"
                         onclick="openFullscreenViewer(event, ${post.id})"
                         style="cursor: pointer;">
                        <video src="${post.rutaArchivo}" class="feed-video" muted loop playsinline="true" webkit-playsinline="true" preload="none" data-post-id="${post.id}"></video>
                        <div class="video-controls-overlay" onclick="handleVideoClick(event, this)">
                            <div class="video-play-icon">
                                <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </div>
                            <button class="video-mute-btn" onclick="toggleVideoMute(event, this)" title="Activar/Desactivar sonido">
                                <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'block' : 'none'};">
                                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                </svg>
                                <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'none' : 'block'};">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>
                        </div>
                    </div>`;
            } else {
                mediaHtml = `
                    <div class="post-media"
                         data-post-id="${post.id}"
                         data-media-type="image"
                         data-media-src="${post.rutaArchivo}"
                         onclick="openFullscreenViewer(event, ${post.id})"
                         style="cursor: pointer;">
                        <img src="${post.rutaArchivo}" alt="" loading="lazy">
                        ${post.nombreUbicacion ? `
                        <div class="location-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span>${post.nombreUbicacion}</span>
                        </div>` : ''}
                    </div>`;
            }
        }

        const avatarHtml = fotoPerfilMostrar
            ? `<img src="${fotoPerfilMostrar}" alt="" class="post-avatar" loading="lazy">`
            : `<div class="post-avatar-placeholder">${nombreMostrado.substring(0, 1).toUpperCase()}</div>`;

        return `
            <article class="post" data-post-id="${post.id}">
                <header class="post-header">
                    <a href="${urlPerfil}" class="post-header-left">
                        ${avatarHtml}
                        <div class="post-user-info">
                            <span class="post-username">
                                ${usernameMostrado}
                                ${post.verificado ? '<svg class="verified-icon" viewBox="0 0 24 24" fill="#10b981" width="16" height="16"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M9 12l2 2 4-4" fill="none" stroke="white" stroke-width="2"></path></svg>' : ''}
                                ${post.tipoLado === 1 ? '<span class="post-badge badge-ladob">B</span>' : ''}
                            </span>
                            <span class="post-time">${tiempoTexto}</span>
                        </div>
                    </a>
                    <div class="post-menu" onclick="togglePostMenu(event, this)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="1.5"></circle>
                            <circle cx="6" cy="12" r="1.5"></circle>
                            <circle cx="18" cy="12" r="1.5"></circle>
                        </svg>
                    </div>
                </header>

                ${mediaHtml}

                <div class="post-actions">
                    <button class="action-btn like-btn ${post.yaLeDioLike ? 'liked' : ''}" data-id="${post.id}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <button class="action-btn comment-btn" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn share-btn" onclick="compartirContenido(${post.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>

                <div class="post-likes">
                    <span class="post-likes-count" id="likes-${post.id}">${post.numeroLikes} Me gusta</span>
                </div>

                ${post.descripcion ? `
                <div class="post-caption">
                    <p class="post-caption-text">
                        <span class="post-caption-username">${usernameMostrado}</span>${post.descripcion}
                    </p>
                </div>` : ''}

                ${post.numeroComentarios > 0 ? `
                <div class="post-comments-preview">
                    <div class="view-all-comments" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                        Ver los ${post.numeroComentarios} comentarios
                    </div>
                </div>` : ''}

                <div class="post-add-comment">
                    <input type="text" class="comment-input" placeholder="Agrega un comentario..." data-post-id="${post.id}">
                    <button class="comment-post-btn" data-post-id="${post.id}" disabled>Publicar</button>
                </div>

                <div class="post-timestamp">
                    ${new Date(post.fechaPublicacion).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase()}
                </div>
            </article>
        `;
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Ahora';
        if (diffMins < 60) return `${diffMins}m`;
        if (diffHours < 24) return `${diffHours}h`;
        if (diffDays < 7) return `${diffDays}d`;
        return `${Math.floor(diffDays / 7)}sem`;
    }

    // ========================================
    // SISTEMA DE VIDEO REFACTORIZADO
    // ========================================

    // Contador de observers activos
    let activeVideoObservers = 0;
    const MAX_VIDEO_OBSERVERS = 30;

    // Estado global de mute
    let isGlobalMuted = true; // Empezar siempre muted para autoplay

    // Deteccion mejorada de iOS/iPadOS (incluye iPadOS 13+ que se identifica como Mac)
    const isIOSDevice = (() => {
        const ua = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
        const isIPadOS = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
        return isIOS || isIPadOS;
    })();

    let userHasInteracted = false;

    // Funcion para actualizar el estado visual del video
    function updateVideoState(video, isPlaying) {
        const postMedia = video?.closest('.post-media');
        if (!postMedia) return;

        if (isPlaying) {
            postMedia.classList.remove('video-paused');
            postMedia.classList.add('video-playing');
            postMedia.classList.remove('ios-needs-tap');
        } else {
            postMedia.classList.add('video-paused');
            postMedia.classList.remove('video-playing');
        }
    }

    // Pausar todos los videos excepto uno
    function pauseAllVideosExcept(exceptVideo) {
        document.querySelectorAll('.feed-video').forEach(v => {
            if (v !== exceptVideo && !v.paused) {
                v.pause();
                updateVideoState(v, false);
            }
        });
    }

    // Reproducir video con manejo de errores
    async function playVideo(video) {
        const postMedia = video?.closest('.post-media');
        if (!video || !postMedia) return false;

        // En iOS sin interaccion, mostrar indicador de tap
        if (isIOSDevice && !userHasInteracted) {
            postMedia.classList.add('video-paused', 'ios-needs-tap');
            video.muted = true;
            return false;
        }

        // Asegurar que este muted para autoplay
        video.muted = isGlobalMuted;

        try {
            await video.play();
            updateVideoState(video, true);
            return true;
        } catch (err) {
            // Si falla, intentar con muted
            if (!video.muted) {
                video.muted = true;
                isGlobalMuted = true;
                updateAllMuteIcons();
                try {
                    await video.play();
                    updateVideoState(video, true);
                    return true;
                } catch (e) {
                    // Requiere interaccion del usuario
                    if (isIOSDevice) {
                        postMedia.classList.add('ios-needs-tap');
                    }
                    updateVideoState(video, false);
                    return false;
                }
            } else {
                if (isIOSDevice) {
                    postMedia.classList.add('ios-needs-tap');
                }
                updateVideoState(video, false);
                return false;
            }
        }
    }

    // Handler para click en el overlay del video
    function handleVideoClick(event, overlay) {
        event.stopPropagation();
        event.preventDefault();

        // Marcar que el usuario interactuo
        userHasInteracted = true;

        const postMedia = overlay.closest('.post-media');
        const video = postMedia?.querySelector('video.feed-video');
        if (!video) return;

        if (video.paused) {
            // Pausar otros videos
            pauseAllVideosExcept(video);
            // Reproducir este
            video.muted = isGlobalMuted;
            video.play().then(() => {
                updateVideoState(video, true);
            }).catch(() => {
                updateVideoState(video, false);
            });
        } else {
            // Pausar
            video.pause();
            updateVideoState(video, false);
        }
    }

    // Funcion para actualizar iconos de mute
    function updateAllMuteIcons() {
        document.querySelectorAll('.video-mute-btn').forEach(btn => {
            const mi = btn.querySelector('.muted-icon');
            const ui = btn.querySelector('.unmuted-icon');
            if (mi && ui) {
                mi.style.display = isGlobalMuted ? 'block' : 'none';
                ui.style.display = isGlobalMuted ? 'none' : 'block';
            }
        });
    }

    // Desbloquear videos en iOS al interactuar
    function handleUserInteraction() {
        if (userHasInteracted) return;
        userHasInteracted = true;

        // Intentar reproducir el video visible
        const visibleVideo = document.querySelector('.feed-video[data-observed="true"]');
        if (visibleVideo && visibleVideo.paused) {
            const postMedia = visibleVideo.closest('.post-media');
            if (postMedia?.classList.contains('ios-needs-tap')) {
                visibleVideo.muted = true;
                visibleVideo.play().then(() => {
                    updateVideoState(visibleVideo, true);
                }).catch(() => {});
            }
        }
    }

    // Registrar interaccion del usuario
    ['touchstart', 'click'].forEach(evt => {
        document.addEventListener(evt, handleUserInteraction, { passive: true, once: true });
    });

    // Intersection Observer para autoplay de videos
    const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            const postMedia = video.closest('.post-media');

            if (entry.isIntersecting) {
                // Video visible - pausar otros y reproducir este
                pauseAllVideosExcept(video);
                playVideo(video);
            } else {
                // Video no visible - pausar
                video.pause();
                updateVideoState(video, false);
            }
        });
    }, {
        root: null,
        rootMargin: '0px',
        threshold: 0.6
    });

    // Preload observer - carga videos antes de ser visibles
    const videoPreloadObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                if (video.preload === 'none') {
                    video.preload = 'metadata';
                    video.load();
                }
                videoPreloadObserver.unobserve(video);
            }
        });
    }, { rootMargin: '500px' });

    function initVideoObserversForNewPosts() {
        document.querySelectorAll('.post-media video.feed-video:not([data-observed])').forEach(video => {
            video.setAttribute('data-observed', 'true');

            // Asegurar atributos para iOS
            video.setAttribute('playsinline', 'true');
            video.setAttribute('webkit-playsinline', 'true');
            video.muted = true;

            // Escuchar eventos del video para actualizar estado
            video.addEventListener('play', () => updateVideoState(video, true));
            video.addEventListener('pause', () => updateVideoState(video, false));
            video.addEventListener('ended', () => {
                // Loop manual si es necesario
                if (video.loop) {
                    video.currentTime = 0;
                    video.play().catch(() => {});
                }
            });

            // Agregar observers
            videoPreloadObserver.observe(video);

            if (activeVideoObservers < MAX_VIDEO_OBSERVERS) {
                videoObserver.observe(video);
                updateVideoState(video, false);
                activeVideoObservers++;
            }
        });

        // Observar posts con musica
        document.querySelectorAll('.post-media:not([data-music-observed])').forEach(media => {
            if (media.querySelector('.photo-audio-player')) {
                media.setAttribute('data-music-observed', 'true');
                if (typeof photoMusicObserver !== 'undefined') {
                    photoMusicObserver.observe(media);
                }
            }
        });
    }

    // Limpiar observers de posts antiguos para evitar memory leak
    function cleanupOldObservers() {
        if (activeVideoObservers <= MAX_VIDEO_OBSERVERS) return;

        const posts = document.querySelectorAll('.post');
        const postsToClean = Array.from(posts).slice(0, posts.length - MAX_VIDEO_OBSERVERS);

        postsToClean.forEach(post => {
            const video = post.querySelector('video[data-observed]');
            if (video) {
                videoObserver.unobserve(video);
                video.pause();
                video.removeAttribute('src');
                video.load(); // Liberar memoria
                activeVideoObservers--;
            }
        });
    }

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        initPullToRefresh();
        initInfiniteScroll();

        // SharedPostId se maneja al final del script donde openFullscreenViewer ya est√° definido
    });

    // ========================================
    // PHOTO MUSIC PLAYER - Reproducci√≥n autom√°tica
    // ========================================
    let currentPhotoAudio = null;

    // Variable para controlar si el fullscreen est√° activo
    let isFullscreenActive = false;

    // Intersection Observer para detectar fotos con m√∫sica visibles
    const photoMusicObserver = new IntersectionObserver((entries) => {
        // NO reproducir audio del feed si el fullscreen est√° activo
        if (isFullscreenActive) {
            return;
        }

        entries.forEach(entry => {
            const postMedia = entry.target;
            const audio = postMedia.querySelector('.photo-audio-player');

            if (!audio) return;

            if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                // Verificar de nuevo que fullscreen no est√© activo
                if (isFullscreenActive) return;

                // La foto est√° visible - reproducir m√∫sica
                if (currentPhotoAudio && currentPhotoAudio !== audio) {
                    currentPhotoAudio.pause();
                }

                const startTime = parseFloat(audio.dataset.start) || 0;
                let volume = parseFloat(audio.dataset.volume) || 0.7;

                // Normalizar volumen al rango [0, 1]
                if (volume > 1) {
                    volume = volume / 10; // Si es 7, convertir a 0.7
                }
                volume = Math.min(1, Math.max(0, volume));

                audio.currentTime = startTime;
                audio.volume = volume;

                // üçé iOS Fix: Usar el wrapper seguro si est√° disponible
                const badge = postMedia.querySelector('.music-badge');

                if (window.iOSAudioFix && window.iOSAudioFix.isIOS) {
                    // En iOS, verificar si necesita interacci√≥n del usuario
                    if (window.iOSAudioFix.needsUserInteraction()) {
                        // Mostrar indicador visual de que requiere tap
                        if (badge) {
                            badge.classList.add('needs-tap');
                            badge.title = 'Toca para reproducir m√∫sica';
                        }
                        console.log('[iOS] Audio requiere interacci√≥n del usuario');
                    } else {
                        // iOS desbloqueado - reproducir
                        window.iOSAudioFix.play(audio).then(success => {
                            if (success && badge) {
                                badge.classList.remove('needs-tap');
                                badge.classList.add('playing');
                            }
                        });
                    }
                } else {
                    // No iOS - reproducir normalmente
                    audio.play().catch(() => {
                        console.log('Autoplay bloqueado - haga click para reproducir');
                        if (badge) {
                            badge.classList.add('needs-tap');
                        }
                    });
                }

                currentPhotoAudio = audio;

                // Animar el badge de m√∫sica
                if (badge && !window.iOSAudioFix?.needsUserInteraction()) {
                    badge.classList.add('playing');
                }
            } else {
                // La foto no est√° visible - pausar m√∫sica
                if (currentPhotoAudio === audio) {
                    audio.pause();
                    currentPhotoAudio = null;
                }

                // Detener animaci√≥n del badge
                const badge = postMedia.querySelector('.music-badge');
                if (badge) {
                    badge.classList.remove('playing');
                }
            }
        });
    }, {
        threshold: [0.5]
    });

    // Observar todas las fotos con m√∫sica
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.post-media').forEach(media => {
            if (media.querySelector('.photo-audio-player')) {
                media.setAttribute('data-music-observed', 'true');
                photoMusicObserver.observe(media);
            }
        });
    });

    // üçé iOS: Primer toque en cualquier lugar desbloquea el audio
    if (window.iOSAudioFix && window.iOSAudioFix.isIOS) {
        let audioUnlockHandled = false;
        document.addEventListener('touchstart', function unlockAudioOnTouch() {
            if (audioUnlockHandled) return;
            audioUnlockHandled = true;

            window.iOSAudioFix.resume().then(() => {
                console.log('[iOS] Audio desbloqueado por interacci√≥n');
                // Remover clase needs-tap de todos los badges
                document.querySelectorAll('.music-badge.needs-tap').forEach(badge => {
                    badge.classList.remove('needs-tap');
                });
                // Intentar reproducir el audio actual si hay uno visible
                if (currentPhotoAudio && currentPhotoAudio.paused) {
                    window.iOSAudioFix.play(currentPhotoAudio);
                }
            });
        }, { once: true, passive: true });
    }

    // Click en badge de m√∫sica para reproducir manualmente
    document.addEventListener('click', (e) => {
        const badge = e.target.closest('.music-badge');
        if (!badge) return;

        // NO reproducir si fullscreen est√° activo
        if (isFullscreenActive) return;

        e.stopPropagation();
        const postId = badge.dataset.postId;
        const audio = document.querySelector(`.photo-audio-player[data-post-id="${postId}"]`);

        if (!audio) return;

        if (audio.paused) {
            if (currentPhotoAudio && currentPhotoAudio !== audio) {
                currentPhotoAudio.pause();
                // Limpiar badge anterior
                document.querySelectorAll('.music-badge.playing').forEach(b => b.classList.remove('playing'));
            }
            const startTime = parseFloat(audio.dataset.start) || 0;
            let volume = parseFloat(audio.dataset.volume) || 0.7;
            // Normalizar volumen al rango [0, 1]
            if (volume > 1) volume = volume / 10;
            volume = Math.min(1, Math.max(0, volume));

            audio.currentTime = startTime;
            audio.volume = volume;

            // üçé iOS Fix: El click del usuario desbloquea el audio
            if (window.iOSAudioFix && window.iOSAudioFix.isIOS) {
                window.iOSAudioFix.resume().then(() => {
                    window.iOSAudioFix.play(audio).then(success => {
                        if (success) {
                            badge.classList.remove('needs-tap');
                            badge.classList.add('playing');
                            currentPhotoAudio = audio;
                        }
                    });
                });
            } else {
                audio.play().then(() => {
                    badge.classList.add('playing');
                    currentPhotoAudio = audio;
                }).catch(err => {
                    console.log('Error al reproducir:', err);
                });
            }
        } else {
            audio.pause();
            currentPhotoAudio = null;
            badge.classList.remove('playing');
            badge.classList.remove('needs-tap');
        }
    });

    // Like (con debounce para evitar spam)
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const postId = this.dataset.id;

            // Debounce: evitar m√∫ltiples clicks simult√°neos
            if (likeInProgress.has(postId)) return;
            likeInProgress.add(postId);

            try {
                const res = await fetch('/Feed/Like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${postId}`
                });
                const data = await res.json();

                if (data.success) {
                    this.classList.toggle('liked', data.liked);
                    document.getElementById(`likes-${postId}`).textContent = `${data.likes} Me gusta`;
                }
            } catch (err) {
                console.error('Error:', err);
            } finally {
                // Liberar despu√©s de 500ms para evitar spam
                setTimeout(() => likeInProgress.delete(postId), 500);
            }
        });
    });

    // Bookmark (Favorito)
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const postId = this.dataset.id;

            try {
                const res = await fetch('/Feed/ToggleFavorito', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${postId}`
                });
                const data = await res.json();

                if (data.success) {
                    this.classList.toggle('bookmarked', data.esFavorito);
                    this.title = data.esFavorito ? 'Quitar de favoritos' : 'Guardar en favoritos';
                }
            } catch (err) {
                console.error('Error:', err);
            }
        });
    });

    // Comment input enable/disable
    document.querySelectorAll('.comment-input').forEach(input => {
        const postId = input.dataset.postId;
        const btn = document.querySelector(`.comment-post-btn[data-post-id="${postId}"]`);

        input.addEventListener('input', function() {
            btn.disabled = !this.value.trim();
        });

        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !btn.disabled) {
                btn.click();
            }
        });
    });

    // Post Comment
    document.querySelectorAll('.comment-post-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.postId;
            const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
            const texto = input.value.trim();

            if (!texto) return;

            this.disabled = true;

            try {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
                formData.append('id', postId);
                formData.append('texto', texto);

                const res = await fetch('/Feed/Comentar', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    input.value = '';
                    showToast('Comentario publicado');

                    // Add comment to preview
                    const post = document.querySelector(`[data-post-id="${postId}"]`);
                    let preview = post.querySelector('.post-comments-preview');
                    if (!preview) {
                        preview = document.createElement('div');
                        preview.className = 'post-comments-preview';
                        post.querySelector('.post-add-comment').before(preview);
                    }

                    const newComment = document.createElement('div');
                    newComment.className = 'comment-preview';
                    newComment.innerHTML = `<span class="comment-preview-username">${escapeHtml(data.comentario.username)}</span><span class="comment-preview-text">${escapeHtml(data.comentario.texto)}</span>`;
                    preview.appendChild(newComment);
                } else {
                    showToast(data.message || 'Error al comentar');
                }
            } catch (err) {
                console.error('Error:', err);
                showToast('Error al publicar comentario');
            }

            this.disabled = !input.value.trim();
        });
    });

    // Focus comment input
    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const postId = this.dataset.id;
            const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
            input.focus();
        });
    });

    // Share
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.id;
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            try {
                const res = await fetch('/Feed/Compartir', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: `id=${postId}&__RequestVerificationToken=${encodeURIComponent(token)}`
                });
                const data = await res.json();

                if (data.success) {
                    currentShareUrl = data.url;
                    currentSharePostId = postId; // Guardar para enviar a amigos
                    document.getElementById('shareUrlInput').value = data.url;
                    document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${encodeURIComponent('Mira esto: ' + data.url)}`;
                    document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(data.url)}`;
                    document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(data.url)}`;
                    document.getElementById('shareModal').classList.add('active');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        });
    });

    // Funci√≥n global para compartir desde posts din√°micos
    window.compartirContenido = async function(postId) {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        try {
            const res = await fetch('/Feed/Compartir', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `id=${postId}&__RequestVerificationToken=${encodeURIComponent(token)}`
            });
            const data = await res.json();

            if (data.success) {
                currentShareUrl = data.url;
                currentSharePostId = postId;
                document.getElementById('shareUrlInput').value = data.url;
                document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${encodeURIComponent('Mira esto: ' + data.url)}`;
                document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(data.url)}`;
                document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(data.url)}`;
                document.getElementById('shareModal').classList.add('active');
            }
        } catch (err) {
            console.error('Error:', err);
        }
    };

    function closeShareModal() {
        document.getElementById('shareModal').classList.remove('active');
        // Resetear panel de amigos
        closeFriendsPanel();
        selectedFriends.clear();
        updateSendButton();
    }

    function copyShareUrl() {
        const input = document.getElementById('shareUrlInput');
        input.select();
        document.execCommand('copy');
        showToast('URL copiada');
    }

    // ========================================
    // ENVIAR A AMIGOS
    // ========================================
    let allFriends = [];
    let selectedFriends = new Set();
    let currentSharePostId = null;

    function openFriendsPanel() {
        document.getElementById('shareMainView').style.display = 'none';
        document.getElementById('friendsPanel').classList.add('active');
        loadFriends();
    }

    function closeFriendsPanel() {
        document.getElementById('friendsPanel').classList.remove('active');
        document.getElementById('shareMainView').style.display = 'block';
        document.getElementById('friendsSearchInput').value = '';
    }

    async function loadFriends() {
        const friendsList = document.getElementById('friendsList');
        friendsList.innerHTML = '<div class="friends-loading">Cargando amigos...</div>';

        try {
            const res = await fetch('/Feed/ObtenerSiguiendo');
            if (!res.ok) throw new Error('Error al cargar amigos');

            allFriends = await res.json();
            renderFriendsList(allFriends);
        } catch (err) {
            console.error('Error:', err);
            friendsList.innerHTML = '<div class="friends-empty">Error al cargar amigos</div>';
        }
    }

    function renderFriendsList(friends) {
        const friendsList = document.getElementById('friendsList');

        if (friends.length === 0) {
            friendsList.innerHTML = '<div class="friends-empty">No sigues a nadie a√∫n</div>';
            return;
        }

        friendsList.innerHTML = friends.map(friend => `
            <div class="friend-item ${selectedFriends.has(friend.id) ? 'selected' : ''}"
                 data-id="${escapeHtml(friend.id)}" onclick="toggleFriendSelection('${escapeHtml(friend.id)}')">
                ${friend.fotoPerfil
                    ? `<img src="${escapeHtml(friend.fotoPerfil)}" alt="" class="friend-avatar">`
                    : `<div class="friend-avatar" style="display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--fg);">${escapeHtml(friend.nombre?.charAt(0)?.toUpperCase() || '')}</div>`
                }
                <div class="friend-info">
                    <div class="friend-name">${escapeHtml(friend.nombre)}</div>
                    <div class="friend-username">@@${escapeHtml(friend.username)}</div>
                </div>
                <div class="friend-check">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
            </div>
        `).join('');
    }

    function toggleFriendSelection(friendId) {
        if (selectedFriends.has(friendId)) {
            selectedFriends.delete(friendId);
        } else {
            selectedFriends.add(friendId);
        }

        // Actualizar visual
        const item = document.querySelector(`.friend-item[data-id="${friendId}"]`);
        if (item) {
            item.classList.toggle('selected', selectedFriends.has(friendId));
        }

        updateSendButton();
    }

    function updateSendButton() {
        const btn = document.getElementById('sendToFriendsBtn');
        const count = selectedFriends.size;
        btn.disabled = count === 0;
        btn.textContent = count > 0 ? `Enviar (${count})` : 'Enviar';
    }

    async function sendToSelectedFriends() {
        if (selectedFriends.size === 0) return;

        const btn = document.getElementById('sendToFriendsBtn');
        btn.disabled = true;
        btn.textContent = 'Enviando...';

        try {
            const friendIds = Array.from(selectedFriends);
            const res = await fetch('/Feed/EnviarAAmigos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contenidoId: currentSharePostId,
                    amigosIds: friendIds,
                    url: currentShareUrl
                })
            });

            const data = await res.json();

            if (data.success) {
                showToast(`Enviado a ${data.enviados} amigo${data.enviados !== 1 ? 's' : ''}`);
                closeShareModal();
            } else {
                showToast(data.message || 'Error al enviar');
            }
        } catch (err) {
            console.error('Error:', err);
            showToast('Error al enviar');
        } finally {
            btn.disabled = false;
            updateSendButton();
        }
    }

    // B√∫squeda de amigos
    document.getElementById('friendsSearchInput').addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query === '') {
            renderFriendsList(allFriends);
        } else {
            const filtered = allFriends.filter(f =>
                f.nombre.toLowerCase().includes(query) ||
                f.username.toLowerCase().includes(query)
            );
            renderFriendsList(filtered);
        }
    });

    // Close modal on background click
    document.getElementById('shareModal').addEventListener('click', function(e) {
        if (e.target === this) closeShareModal();
    });

    // Seguir usuario desde sidebar (con TipoLado)
    async function seguirUsuario(userId, btn, tipoLado = 0) {
        try {
            const res = await fetch('/Feed/Seguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                if (data.siguiendo) {
                    btn.textContent = 'Siguiendo';
                    btn.style.color = 'var(--muted)';
                } else {
                    btn.textContent = 'Seguir';
                    btn.style.color = 'var(--primary)';
                }
                const ladoTexto = tipoLado === 1 ? ' (Lado B)' : ' (Lado A)';
                showToast(data.siguiendo ? 'Ahora sigues a este usuario' + ladoTexto : 'Has dejado de seguir');
            } else {
                showToast(data.message || 'Error al seguir');
            }
        } catch (err) {
            console.error('Error:', err);
            showToast('Error al seguir usuario');
        }
    }

    // ========================================
    // CONTENIDO SENSIBLE
    // ========================================

    function revelarContenidoSensible(event, postId) {
        event.stopPropagation();
        event.preventDefault();

        const overlay = document.querySelector(`.sensitive-content-overlay[data-post-id="${postId}"]`);
        if (overlay) {
            overlay.classList.add('revealing');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
    }

    // ========================================
    // FUNCIONES DEL CARRUSEL
    // ========================================

    function carouselPrev(event, btn) {
        event.stopPropagation();
        const carousel = btn.closest('.post-carousel');
        navigateCarousel(carousel, -1);
    }

    function carouselNext(event, btn) {
        event.stopPropagation();
        const carousel = btn.closest('.post-carousel');
        navigateCarousel(carousel, 1);
    }

    function navigateCarousel(carousel, direction) {
        const track = carousel.querySelector('.carousel-track');
        const slides = carousel.querySelectorAll('.carousel-slide');
        const dots = carousel.querySelectorAll('.carousel-dot');
        const counter = carousel.querySelector('.carousel-counter');
        const prevBtn = carousel.querySelector('.carousel-prev');
        const nextBtn = carousel.querySelector('.carousel-next');

        // Obtener √≠ndice actual
        let currentIndex = parseInt(carousel.dataset.currentIndex || '0');
        const totalSlides = slides.length;

        // Calcular nuevo √≠ndice
        let newIndex = currentIndex + direction;

        // Limitar a los bordes
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= totalSlides) newIndex = totalSlides - 1;

        // No hacer nada si ya estamos en el borde
        if (newIndex === currentIndex) return;

        // Mover el track
        const offset = -newIndex * (100 / totalSlides);
        track.style.transform = `translateX(${offset}%)`;

        // Actualizar √≠ndice actual
        carousel.dataset.currentIndex = newIndex;

        // Actualizar dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === newIndex);
        });

        // Actualizar contador
        if (counter) {
            counter.textContent = `${newIndex + 1}/${totalSlides}`;
        }

        // Mostrar/ocultar botones de navegaci√≥n
        if (prevBtn) prevBtn.classList.toggle('hidden', newIndex === 0);
        if (nextBtn) nextBtn.classList.toggle('hidden', newIndex === totalSlides - 1);

        // Pausar videos de otros slides, reproducir el actual
        slides.forEach((slide, i) => {
            const video = slide.querySelector('video');
            if (video) {
                if (i === newIndex) {
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });
    }

    // Inicializar carruseles al cargar
    function initCarousels() {
        document.querySelectorAll('.post-carousel').forEach(carousel => {
            carousel.dataset.currentIndex = '0';

            // Ocultar bot√≥n prev inicialmente
            const prevBtn = carousel.querySelector('.carousel-prev');
            if (prevBtn) prevBtn.classList.add('hidden');

            // Click en dots
            carousel.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                dot.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentIndex = parseInt(carousel.dataset.currentIndex || '0');
                    const direction = index - currentIndex;
                    if (direction !== 0) {
                        // Ir directamente al √≠ndice
                        const track = carousel.querySelector('.carousel-track');
                        const totalSlides = carousel.querySelectorAll('.carousel-slide').length;
                        const offset = -index * (100 / totalSlides);
                        track.style.transform = `translateX(${offset}%)`;
                        carousel.dataset.currentIndex = index;

                        // Actualizar dots
                        carousel.querySelectorAll('.carousel-dot').forEach((d, i) => {
                            d.classList.toggle('active', i === index);
                        });

                        // Actualizar contador
                        const counter = carousel.querySelector('.carousel-counter');
                        if (counter) counter.textContent = `${index + 1}/${totalSlides}`;

                        // Actualizar botones
                        const prevBtn = carousel.querySelector('.carousel-prev');
                        const nextBtn = carousel.querySelector('.carousel-next');
                        if (prevBtn) prevBtn.classList.toggle('hidden', index === 0);
                        if (nextBtn) nextBtn.classList.toggle('hidden', index === totalSlides - 1);
                    }
                });
            });

            // Soporte para swipe t√°ctil
            let startX = 0;
            let isDragging = false;

            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isDragging = true;
            }, { passive: true });

            carousel.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                const endX = e.changedTouches[0].clientX;
                const diff = startX - endX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        navigateCarousel(carousel, 1); // Swipe left = next
                    } else {
                        navigateCarousel(carousel, -1); // Swipe right = prev
                    }
                }
            }, { passive: true });
        });
    }

    // Inicializar carruseles cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', initCarousels);

    // ========================================
    // FUNCIONES DEL MENU DE 3 PUNTOS
    // ========================================

    // Toggle del menu dropdown
    function togglePostMenu(event, element) {
        event.stopPropagation();
        const dropdown = element.querySelector('.post-menu-dropdown');

        // Cerrar todos los demas menus abiertos
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            if (d !== dropdown) d.classList.remove('show');
        });

        dropdown.classList.toggle('show');
    }

    // Cerrar menus al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Ir a la publicacion
    function irAPublicacion(postId) {
        window.location.href = '/Feed/Detalle/' + postId;
    }

    // Copiar enlace
    function copiarEnlace(postId) {
        const url = window.location.origin + '/Feed/Detalle/' + postId;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Enlace copiado al portapapeles');
        }).catch(() => {
            // Fallback para navegadores sin soporte de clipboard
            const input = document.createElement('input');
            input.value = url;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('Enlace copiado al portapapeles');
        });
        cerrarMenus();
    }

    // Agregar a favoritos
    async function agregarFavorito(postId, btn) {
        try {
            const res = await fetch('/Feed/ToggleFavorito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}`
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || (data.esFavorito ? 'Guardado en favoritos' : 'Eliminado de favoritos'));
                // Actualizar texto del boton
                const textNode = btn.childNodes[btn.childNodes.length - 1];
                textNode.textContent = data.esFavorito ? ' Quitar de favoritos' : ' Agregar a favoritos';
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            console.error('Error:', err);
            showToast('Error al procesar');
        }
        cerrarMenus();
    }

    // Dejar de seguir
    async function dejarDeSeguir(userId, tipoLado, btn) {
        try {
            const res = await fetch('/Feed/DejarDeSeguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || 'Has dejado de seguir a este usuario');
            } else {
                showToast(data.message || 'Error al dejar de seguir');
            }
        } catch (err) {
            console.error('Error:', err);
            showToast('Error al procesar');
        }
        cerrarMenus();
    }

    // ========================================
    // SISTEMA DE REPORTES ESTILO INSTAGRAM
    // ========================================
    let currentReportPostId = null;
    let currentReportReason = '';
    let requiresDetails = false;

    // Abrir modal de reportes
    function reportarContenido(postId) {
        currentReportPostId = postId;
        currentReportReason = '';
        requiresDetails = false;

        // Resetear estado del modal
        document.getElementById('reportMainContent').style.display = 'block';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');
        document.getElementById('reportDetailsStep').classList.remove('show');
        document.getElementById('reportConfirmation').classList.remove('show');
        document.getElementById('reportDetails').value = '';

        // Mostrar modal
        document.getElementById('reportModal').classList.add('show');
        document.body.style.overflow = 'hidden';

        cerrarMenus();
    }

    // Cerrar modal de reportes
    function closeReportModal() {
        document.getElementById('reportModal').classList.remove('show');
        document.body.style.overflow = '';
        currentReportPostId = null;
        currentReportReason = '';
    }

    // Mostrar opciones principales
    function showMainReportOptions() {
        document.getElementById('reportMainContent').style.display = 'block';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');
        document.getElementById('reportDetailsStep').classList.remove('show');
    }

    // Mostrar subopciones
    function showReportSuboptions(category) {
        document.getElementById('reportMainContent').style.display = 'none';

        if (category === 'violencia') {
            document.getElementById('reportSubViolencia').classList.add('show');
        } else if (category === 'sexual') {
            document.getElementById('reportSubSexual').classList.add('show');
        }
    }

    // Seleccionar motivo de reporte
    function selectReportReason(reason, needsDetails) {
        currentReportReason = reason;
        requiresDetails = needsDetails;

        // Ocultar todas las secciones
        document.getElementById('reportMainContent').style.display = 'none';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');

        // Mostrar paso de detalles o enviar directamente
        if (needsDetails) {
            document.getElementById('selectedReasonTitle').textContent = reason;
            document.getElementById('reportDetailsStep').classList.add('show');
            document.getElementById('reportDetails').focus();
        } else {
            // Enviar reporte directamente con el motivo seleccionado
            submitReportWithReason(reason);
        }
    }

    // Enviar reporte con motivo
    async function submitReportWithReason(reason) {
        const submitBtn = document.getElementById('submitReportBtn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
        }

        try {
            const res = await fetch('/Feed/Reportar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${currentReportPostId}&motivo=${encodeURIComponent(reason)}`
            });
            const data = await res.json();

            // Mostrar confirmaci√≥n
            document.getElementById('reportMainContent').style.display = 'none';
            document.getElementById('reportSubViolencia').classList.remove('show');
            document.getElementById('reportSubSexual').classList.remove('show');
            document.getElementById('reportDetailsStep').classList.remove('show');
            document.getElementById('reportConfirmation').classList.add('show');

        } catch (err) {
            console.error('Error:', err);
            showToast('Error al enviar reporte');
            closeReportModal();
        }

        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enviar reporte';
        }
    }

    // Enviar reporte desde el formulario de detalles
    async function submitReport() {
        const details = document.getElementById('reportDetails').value.trim();
        let fullReason = currentReportReason;

        if (details) {
            fullReason += ': ' + details;
        }

        await submitReportWithReason(fullReason);
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('reportModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReportModal();
        }
    });

    // Cerrar con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('reportModal').classList.contains('show')) {
            closeReportModal();
        }
    });

    // Bloquear usuario
    async function bloquearUsuario(userId, nombreUsuario) {
        cerrarMenus();

        const confirmar = confirm(`¬øEst√°s seguro de que quieres bloquear a ${nombreUsuario}?\n\nAl bloquear:\n‚Ä¢ No ver√°s su contenido\n‚Ä¢ No podr√°s enviarle mensajes\n‚Ä¢ Se cancelar√°n suscripciones mutuas`);
        if (!confirmar) {
            return;
        }

        try {
            const res = await fetch('/Usuario/BloquearUsuario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuarioId: userId })
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || 'Usuario bloqueado correctamente');
                // Ocultar posts del usuario bloqueado
                document.querySelectorAll(`[data-user-id="${userId}"]`).forEach(post => {
                    const article = post.closest('.post');
                    if (article) {
                        article.style.display = 'none';
                    }
                });
                // Recargar despu√©s de un momento
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.message || 'Error al bloquear usuario');
            }
        } catch (err) {
            console.error('Error:', err);
            showToast('Error al bloquear usuario');
        }
    }

    // Cerrar todos los menus
    function cerrarMenus() {
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            d.classList.remove('show');
        });
    }

    // ========================================
    // VIDEO CONTROLS - SIMPLIFICADO
    // ========================================

    // Toggle play/pause (legacy - usar handleVideoClick preferentemente)
    function toggleVideoPlay(event, video) {
        event.stopPropagation();
        event.preventDefault();
        userHasInteracted = true;

        if (video.paused) {
            pauseAllVideosExcept(video);
            video.muted = isGlobalMuted;
            video.play().then(() => {
                updateVideoState(video, true);
            }).catch(() => {
                updateVideoState(video, false);
            });
        } else {
            video.pause();
            updateVideoState(video, false);
        }
    }

    // Toggle mute global
    function toggleVideoMute(event, btn) {
        event.stopPropagation();
        event.preventDefault();
        userHasInteracted = true;

        isGlobalMuted = !isGlobalMuted;

        // Aplicar a todos los videos
        document.querySelectorAll('.feed-video').forEach(v => {
            v.muted = isGlobalMuted;
        });

        updateAllMuteIcons();
    }

    // Inicializar observers para videos existentes al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        // Usar la funcion unificada de inicializacion
        initVideoObserversForNewPosts();
        // Actualizar iconos de mute
        updateAllMuteIcons();
    });
</script>

<!-- ========================================
     POPUP DE MENSAJES - ESTILO INSTAGRAM DM
     ======================================== -->
<style>
    /* Floating Messages Popup Container */
    .dm-popup-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
    }

    /* FAB Button */
    .dm-fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #262626;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .dm-fab:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }

    .dm-fab svg {
        width: 26px;
        height: 26px;
        stroke: white;
    }

    .dm-fab .dm-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #262626;
        padding: 0 5px;
    }

    /* Modal Popup */
    .dm-modal {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 400px;
        height: 480px;
        background: #262626;
        border-radius: 12px;
        overflow: hidden;
        display: none;
        flex-direction: column;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        animation: dmSlideUp 0.25s ease;
    }

    .dm-modal.show {
        display: flex;
    }

    @@keyframes dmSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Header */
    .dm-header {
        padding: 16px 20px;
        background: #262626;
        border-bottom: 1px solid #363636;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .dm-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dm-header-title {
        color: #ffffff;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .dm-header-badge {
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
    }

    .dm-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dm-header-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
        transition: background 0.2s, color 0.2s;
    }

    .dm-header-btn:hover {
        background: #363636;
        color: white;
    }

    .dm-header-btn svg {
        width: 20px;
        height: 20px;
    }

    /* Conversations List */
    .dm-conversations {
        flex: 1;
        overflow-y: auto;
        background: #262626;
    }

    .dm-conv-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        gap: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dm-conv-item:hover {
        background: #363636;
    }

    .dm-conv-avatar {
        position: relative;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
    }

    .dm-conv-avatar img,
    .dm-conv-avatar .dm-avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .dm-avatar-placeholder {
        background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
    }

    .dm-online-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        background: #22c55e;
        border-radius: 50%;
        border: 3px solid #262626;
    }

    .dm-conv-info {
        flex: 1;
        min-width: 0;
    }

    .dm-conv-name {
        color: #ffffff;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
        display: block;
    }

    .dm-conv-status {
        color: #a8a8a8;
        font-size: 13px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dm-conv-item.unread .dm-conv-status {
        color: #ffffff;
        font-weight: 500;
    }

    .dm-conv-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .dm-conv-time {
        color: #a8a8a8;
        font-size: 12px;
    }

    .dm-conv-unread {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
    }

    /* Empty State */
    .dm-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
        padding: 40px;
        text-align: center;
    }

    .dm-empty svg {
        width: 64px;
        height: 64px;
        stroke: #525252;
        margin-bottom: 16px;
    }

    .dm-empty p {
        margin: 0 0 16px;
        font-size: 14px;
    }

    .dm-empty-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dm-empty-btn:hover {
        background: #2563eb;
    }

    /* Loading */
    .dm-loading {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
    }

    /* Footer with new message button */
    .dm-footer {
        padding: 12px 16px;
        border-top: 1px solid #363636;
        display: flex;
        justify-content: flex-end;
    }

    .dm-new-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #262626;
        border: 1px solid #525252;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s, border-color 0.2s;
    }

    .dm-new-btn:hover {
        background: #363636;
        border-color: #a8a8a8;
    }

    .dm-new-btn svg {
        width: 20px;
        height: 20px;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .dm-modal {
            width: calc(100vw - 32px);
            right: -8px;
            height: 60vh;
        }

        .dm-popup-container {
            bottom: 16px;
            right: 16px;
        }
    }
</style>

<!-- DM Popup HTML -->
<div class="dm-popup-container" id="dmPopup">
    <!-- FAB Button -->
    <button class="dm-fab" id="dmFab" onclick="toggleDmPopup()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
        <span class="dm-badge" id="dmBadge" style="display: none;">0</span>
    </button>

    <!-- Modal -->
    <div class="dm-modal" id="dmModal">
        <!-- Header -->
        <div class="dm-header">
            <div class="dm-header-left">
                <h5 class="dm-header-title">Mensajes</h5>
                <span class="dm-header-badge" id="dmHeaderBadge" style="display: none;">0</span>
            </div>
            <div class="dm-header-actions">
                <a href="/Mensajes" class="dm-header-btn" title="Expandir">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                </a>
                <button class="dm-header-btn" onclick="toggleDmPopup()" title="Cerrar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Conversations -->
        <div class="dm-conversations" id="dmConversations">
            <div class="dm-loading">
                <span>Cargando...</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="dm-footer">
            <a href="/Mensajes" class="dm-new-btn" title="Nuevo mensaje">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<script>
    // ========================================
    // DM POPUP - INSTAGRAM STYLE
    // ========================================

    let dmPopupOpen = false;
    let dmConversationsData = [];
    const CURRENT_USER_ID_DM = '@ViewBag.UsuarioActual?.Id';

    function toggleDmPopup() {
        dmPopupOpen = !dmPopupOpen;
        const modal = document.getElementById('dmModal');

        if (dmPopupOpen) {
            modal.classList.add('show');
            loadDmConversations();
        } else {
            modal.classList.remove('show');
        }
    }

    async function loadDmConversations() {
        const container = document.getElementById('dmConversations');
        container.innerHTML = '<div class="dm-loading"><span>Cargando...</span></div>';

        try {
            const response = await fetch('/api/mensajes/conversaciones');
            if (!response.ok) throw new Error('Error');

            dmConversationsData = await response.json();
            renderDmConversations(dmConversationsData);
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="dm-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p>No tienes conversaciones aun</p>
                    <a href="/Mensajes" class="dm-empty-btn">Iniciar conversacion</a>
                </div>`;
        }
    }

    function renderDmConversations(conversations) {
        const container = document.getElementById('dmConversations');

        if (!conversations || conversations.length === 0) {
            container.innerHTML = `
                <div class="dm-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p>No tienes conversaciones aun</p>
                    <a href="/Mensajes" class="dm-empty-btn">Iniciar conversacion</a>
                </div>`;
            return;
        }

        let html = '';
        conversations.forEach(conv => {
            const unreadClass = conv.noLeidos > 0 ? 'unread' : '';
            const initial = (conv.nombreUsuario || 'U').charAt(0).toUpperCase();

            html += `<div class="dm-conv-item ${unreadClass}" onclick="openDmChat('${conv.usuarioId}')">`;
            html += '<div class="dm-conv-avatar">';
            if (conv.fotoPerfil) {
                html += `<img src="${conv.fotoPerfil}" alt="${escapeDmHtml(conv.nombreUsuario)}">`;
            } else {
                html += `<div class="dm-avatar-placeholder">${initial}</div>`;
            }
            if (conv.enLinea) html += '<span class="dm-online-dot"></span>';
            html += '</div>';

            html += '<div class="dm-conv-info">';
            html += `<span class="dm-conv-name">${escapeDmHtml(conv.nombreUsuario)}</span>`;

            let statusText = conv.ultimoMensaje || 'Sin mensajes';
            if (conv.enLinea) {
                statusText = 'Activo(a) ahora';
            }
            html += `<span class="dm-conv-status">${escapeDmHtml(statusText)}</span>`;
            html += '</div>';

            html += '<div class="dm-conv-meta">';
            html += `<span class="dm-conv-time">${formatDmTime(conv.fechaUltimoMensaje)}</span>`;
            if (conv.noLeidos > 0) html += '<span class="dm-conv-unread"></span>';
            html += '</div></div>';
        });

        container.innerHTML = html;
    }

    function openDmChat(userId) {
        window.location.href = '/Mensajes/Chat/' + userId;
    }

    function escapeDmHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDmTime(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (hours < 1) return 'Ahora';
        if (hours < 24) return `${hours}h`;
        if (days < 7) return `${days}d`;
        return date.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    async function updateDmBadge() {
        try {
            const response = await fetch('/api/mensajes/no-leidos-count');
            if (response.ok) {
                const data = await response.json();
                const badge = document.getElementById('dmBadge');
                const headerBadge = document.getElementById('dmHeaderBadge');

                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'flex';
                    headerBadge.textContent = data.count;
                    headerBadge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                    headerBadge.style.display = 'none';
                }
            }
        } catch (error) {
            console.log('Error updating badge');
        }
    }

    // Cargar badge al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        updateDmBadge();
        // Actualizar cada 30 segundos
        setInterval(updateDmBadge, 30000);
    });
</script>

<!-- ========================================
     FULLSCREEN MEDIA VIEWER (TikTok-style)
     ======================================== -->
<div class="fullscreen-viewer" id="fullscreenViewer">
    <!-- Bot√≥n Mute Global - Arriba Izquierda -->
    <button class="fullscreen-mute-btn-global" id="globalMuteBtn" onclick="toggleGlobalMute()" title="Activar/Desactivar sonido" style="display:none;">
        <svg class="icon-muted" viewBox="0 0 24 24" fill="white">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
    </button>
    <!-- Bot√≥n Cerrar - Arriba Derecha -->
    <button class="fullscreen-viewer-close" onclick="closeFullscreenViewer()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="fullscreen-counter" id="fullscreenCounter">1 / 1</div>

    <!-- Navegaci√≥n arriba/abajo estilo YouTube Shorts -->
    <div class="fullscreen-nav-arrows" id="fullscreenNavArrows">
        <button class="fullscreen-nav-btn" id="navPrevBtn" onclick="navigateFullscreen(-1)" title="Anterior">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18,15 12,9 6,15"/>
            </svg>
        </button>
        <button class="fullscreen-nav-btn" id="navNextBtn" onclick="navigateFullscreen(1)" title="Siguiente">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
            </svg>
        </button>
    </div>

    <div class="fullscreen-slides-container" id="fullscreenSlidesContainer">
        <!-- Slides se generan dinamicamente -->
    </div>
</div>

<!-- ========================================
     MODAL DE SUSCRIPCION - CONTENIDO BLOQUEADO
     ======================================== -->
<div class="subscribe-modal" id="subscribeModal" onclick="if(event.target === this) closeSubscribeModal()">
    <div class="subscribe-modal-content">
        <div class="subscribe-modal-header">
            <button class="subscribe-modal-close" onclick="closeSubscribeModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div id="subscribeModalAvatar" class="subscribe-modal-avatar-placeholder">?</div>
            <div class="subscribe-modal-name" id="subscribeModalName">Creador</div>
            <div class="subscribe-modal-username" id="subscribeModalUsername">@@usuario</div>
        </div>
        <div class="subscribe-modal-body">
            <h4>Contenido exclusivo de Lado B</h4>
            <p>Suscribete para acceder a todo el contenido exclusivo de este creador, incluyendo fotos, videos y mas.</p>
            <div class="subscribe-modal-price" id="subscribeModalPrice">$0.00</div>
            <div class="subscribe-modal-price-label">por mes</div>
            <button class="subscribe-modal-btn" id="subscribeModalBtn" onclick="goToSubscribe()">
                Suscribirse ahora
            </button>
        </div>
        <div class="subscribe-modal-footer">
            <a href="#" id="subscribeModalProfileLink">Ver perfil del creador</a>
        </div>
    </div>
</div>

<script>
    // ========================================
    // MODAL DE SUSCRIPCION - CONTENIDO BLOQUEADO
    // ========================================

    let currentCreatorId = null;

    function openSubscribeModal(postElement) {
        if (!postElement) return;

        const creatorId = postElement.dataset.creatorId;
        const creatorName = postElement.dataset.creatorName || 'Creador';
        const creatorPhoto = postElement.dataset.creatorPhoto;
        const creatorPrice = postElement.dataset.creatorPrice || '0.00';

        currentCreatorId = creatorId;

        // Actualizar contenido del modal
        document.getElementById('subscribeModalName').textContent = creatorName;
        document.getElementById('subscribeModalUsername').textContent = '@@' + creatorName.toLowerCase().replace(/\s+/g, '');
        document.getElementById('subscribeModalPrice').textContent = '$' + creatorPrice;

        // Avatar
        const avatarContainer = document.getElementById('subscribeModalAvatar');
        if (creatorPhoto && creatorPhoto !== '') {
            avatarContainer.innerHTML = '';
            avatarContainer.className = '';
            const img = document.createElement('img');
            img.src = creatorPhoto;
            img.alt = creatorName;
            img.className = 'subscribe-modal-avatar';
            avatarContainer.appendChild(img);
        } else {
            avatarContainer.innerHTML = creatorName.charAt(0).toUpperCase();
            avatarContainer.className = 'subscribe-modal-avatar-placeholder';
        }

        // Link al perfil
        document.getElementById('subscribeModalProfileLink').href = '/Feed/Perfil/' + creatorId + '?verSeudonimo=true';

        // Mostrar modal
        document.getElementById('subscribeModal').classList.add('active');
    }

    function closeSubscribeModal() {
        document.getElementById('subscribeModal').classList.remove('active');
        currentCreatorId = null;
    }

    function goToSubscribe() {
        if (currentCreatorId) {
            window.location.href = '/Feed/Perfil/' + currentCreatorId + '?verSeudonimo=true&subscribe=true';
        }
    }

    // Cerrar con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSubscribeModal();
        }
    });
</script>

<!-- ========================================
     FULLSCREEN VIEWER JAVASCRIPT
     ======================================== -->
<script>
    // Variables globales del fullscreen viewer
    let fullscreenPosts = [];
    let currentFullscreenIndex = 0;
    let lastTapTime = 0;
    let tapTimeout = null;

    // iOS Audio Unlock - Desbloquear audio en dispositivos iOS/Safari
    let audioUnlocked = false;

    function unlockAudio() {
        if (audioUnlocked) return;

        // Crear un AudioContext y reproducir un sonido silencioso
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);

            // Tambien intentar con un elemento de audio
            const silentAudio = document.createElement('audio');
            silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
            silentAudio.play().then(() => {
                silentAudio.pause();
                silentAudio.remove();
            }).catch(() => {});

            audioUnlocked = true;
            console.log('Audio desbloqueado para iOS');
        } catch (e) {
            console.log('Error al desbloquear audio:', e);
        }
    }

    // Desbloquear audio en el primer touch/click
    document.addEventListener('touchstart', unlockAudio, { once: true });
    document.addEventListener('click', unlockAudio, { once: true });

    // Cache de medios precargados
    const preloadedMedia = new Map();
    const PRELOAD_RANGE = 3; // Precargar N slides adelante y atras

    // Pausar cualquier audio/video del feed
    function pauseFeedMedia() {
        // Pausar todos los videos del feed
        document.querySelectorAll('.post-media video, .feed-video').forEach(video => {
            if (!video.paused) {
                video.pause();
            }
        });

        // Pausar todos los audios del feed (m√∫sica de fotos)
        document.querySelectorAll('.photo-audio-player, .post-media audio').forEach(audio => {
            if (!audio.paused) {
                audio.pause();
            }
        });
    }

    // CORREGIDO: Pausar TODOS los audios y videos del fullscreen viewer
    // Esto evita el bug donde la m√∫sica no coincide con la foto al navegar
    let currentPlayingAudioId = null; // Rastrear qu√© audio est√° reproduci√©ndose

    function pauseAllFullscreenMedia() {
        console.log('[DEBUG] pauseAllFullscreenMedia llamado');

        // Pausar todos los videos del visor
        document.querySelectorAll('.fullscreen-slide video').forEach(video => {
            video.pause();
            video.currentTime = 0;
        });

        // Pausar TODOS los audios del visor - selector m√°s espec√≠fico
        const audios = document.querySelectorAll('#fullscreenSlidesContainer audio');
        console.log('[DEBUG] Audios encontrados para pausar:', audios.length);
        audios.forEach(audio => {
            if (!audio.paused) {
                console.log('[DEBUG] Pausando audio:', audio.dataset.postId);
            }
            audio.pause();
        });

        // Quitar clase playing de todos los badges de m√∫sica
        document.querySelectorAll('.fullscreen-music-badge').forEach(badge => {
            badge.classList.remove('playing');
            badge.classList.remove('tap-to-play');
        });

        currentPlayingAudioId = null;
    }

    // Toggle Fullscreen Video Mute (legacy - para botones dentro de slides)
    function toggleFullscreenMute(btn) {
        const slide = btn.closest('.fullscreen-slide');
        const video = slide ? slide.querySelector('video') : null;
        if (!video) return;

        video.muted = !video.muted;
        updateGlobalMuteIcon(video.muted);
    }

    // Toggle Global Mute - Bot√≥n fijo arriba izquierda
    function toggleGlobalMute() {
        const container = document.getElementById('fullscreenSlidesContainer');
        const currentSlide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);
        if (!currentSlide) return;

        const video = currentSlide.querySelector('video');
        if (video) {
            video.muted = !video.muted;
            updateGlobalMuteIcon(video.muted);
        }
    }

    // Actualizar icono del bot√≥n global de mute
    function updateGlobalMuteIcon(isMuted) {
        const muteBtn = document.getElementById('globalMuteBtn');
        if (!muteBtn) return;

        const iconMuted = muteBtn.querySelector('.icon-muted');
        const iconUnmuted = muteBtn.querySelector('.icon-unmuted');
        if (iconMuted && iconUnmuted) {
            iconMuted.style.display = isMuted ? 'block' : 'none';
            iconUnmuted.style.display = isMuted ? 'none' : 'block';
        }
    }

    // Mostrar/ocultar bot√≥n de mute seg√∫n el tipo de contenido actual
    function updateGlobalMuteVisibility() {
        const muteBtn = document.getElementById('globalMuteBtn');
        if (!muteBtn || currentFullscreenIndex < 0 || currentFullscreenIndex >= fullscreenPosts.length) {
            if (muteBtn) muteBtn.style.display = 'none';
            return;
        }

        const currentPost = fullscreenPosts[currentFullscreenIndex];
        // Mostrar solo si es video
        if (currentPost && currentPost.type === 'video') {
            muteBtn.style.display = 'flex';
            // Obtener estado actual de mute del video
            const container = document.getElementById('fullscreenSlidesContainer');
            const currentSlide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);
            const video = currentSlide?.querySelector('video');
            if (video) {
                updateGlobalMuteIcon(video.muted);
            }
        } else {
            muteBtn.style.display = 'none';
        }
    }

    // Recolectar todos los posts con media al cargar
    function collectMediaPosts() {
        fullscreenPosts = [];
        document.querySelectorAll('.post-media[data-post-id]').forEach(media => {
            const postId = parseInt(media.dataset.postId);
            const mediaType = media.dataset.mediaType;
            const mediaSrc = media.dataset.mediaSrc;
            if (postId && mediaSrc) {
                // Buscar el elemento .post padre para obtener info del creador
                const postElement = media.closest('.post');

                const postData = {
                    id: postId,
                    type: mediaType,
                    src: mediaSrc,
                    loaded: false,
                    // Info del creador para los cr√©ditos
                    creatorId: postElement?.dataset.creatorId || '',
                    creatorName: postElement?.dataset.creatorName || 'Creador',
                    creatorPhoto: postElement?.dataset.creatorPhoto || '',
                    creatorUsername: postElement?.querySelector('.post-username')?.textContent?.trim() || '',
                    creatorVerified: postElement?.querySelector('.post-username .fas.fa-check-circle') !== null,
                    isLadoB: postElement?.querySelector('.badge-ladob') !== null,
                    isFollowing: postElement?.dataset.isFollowing === 'true',
                    description: postElement?.querySelector('.post-caption-text')?.textContent?.trim() || postElement?.querySelector('.post-text-content')?.textContent?.trim() || '',
                    // Usar data attributes para likes y comments
                    likes: parseInt(postElement?.dataset.likes) || 0,
                    comments: parseInt(postElement?.dataset.comments) || 0,
                    isLiked: postElement?.querySelector('.like-btn')?.classList.contains('liked') || false,
                    postDate: postElement?.querySelector('.post-time')?.textContent?.trim() || ''
                };

                // Verificar si es un carrusel
                if (media.dataset.isCarousel === 'true' && media.dataset.carouselFiles) {
                    try {
                        postData.isCarousel = true;
                        postData.carouselFiles = JSON.parse(media.dataset.carouselFiles);
                        postData.carouselIndex = 0;
                    } catch (e) {
                        console.error('Error parsing carousel files:', e);
                    }
                }

                // Capturar datos de audio si existen
                if (media.dataset.audioSrc) {
                    postData.audioSrc = media.dataset.audioSrc;
                    postData.audioTitle = media.dataset.audioTitle || '';
                    postData.audioArtist = media.dataset.audioArtist || '';
                    postData.audioStart = parseFloat(media.dataset.audioStart) || 0;
                    let vol = parseFloat(media.dataset.audioVolume) || 0.7;
                    if (vol > 1) vol = vol / 10;
                    postData.audioVolume = Math.min(1, Math.max(0, vol));
                }
                fullscreenPosts.push(postData);
            }
        });
    }

    // Precargar medios adyacentes
    function preloadAdjacentMedia(centerIndex) {
        const indicesToPreload = [];

        // Agregar indices a precargar (actual, anteriores y siguientes)
        for (let i = -PRELOAD_RANGE; i <= PRELOAD_RANGE; i++) {
            const idx = centerIndex + i;
            if (idx >= 0 && idx < fullscreenPosts.length) {
                indicesToPreload.push(idx);
            }
        }

        // Precargar cada uno
        indicesToPreload.forEach(idx => {
            const post = fullscreenPosts[idx];
            if (!post || preloadedMedia.has(post.src)) return;

            if (post.type === 'image') {
                // Precargar imagen
                const img = new Image();
                img.onload = () => {
                    post.loaded = true;
                    // Actualizar el slide si ya existe
                    updateSlideIfExists(idx, post);
                };
                img.src = post.src;
                preloadedMedia.set(post.src, img);
            } else if (post.type === 'video') {
                // Precargar video (solo metadata primero, luego mas)
                const video = document.createElement('video');
                video.preload = 'auto';
                video.muted = true;
                video.oncanplaythrough = () => {
                    post.loaded = true;
                };
                video.src = post.src;
                video.load();
                preloadedMedia.set(post.src, video);
            }
        });
    }

    // Actualizar slide si ya existe en el DOM
    function updateSlideIfExists(index, post) {
        const slide = document.querySelector(`.fullscreen-slide[data-index="${index}"]`);
        if (slide && post.loaded) {
            slide.classList.add('media-loaded');
        }
    }

    // Abrir el fullscreen viewer
    function openFullscreenViewer(event, postId) {
        // Prevenir si es un click en audio controls
        if (event.target.tagName === 'AUDIO') {
            return;
        }
        event.preventDefault();
        event.stopPropagation();

        console.log('[DEBUG] openFullscreenViewer para postId:', postId);

        // IMPORTANTE: Marcar fullscreen como activo para bloquear el IntersectionObserver del feed
        isFullscreenActive = true;

        // Pausar cualquier audio/video del feed antes de abrir el viewer
        pauseFeedMedia();
        // Tambi√©n pausar el audio actual del feed si existe
        if (currentPhotoAudio) {
            currentPhotoAudio.pause();
            currentPhotoAudio = null;
        }

        // Resetear estado de scroll
        isScrolling = false;
        lastScrollIndex = -1;
        currentPlayingAudioId = null;

        // Recolectar posts
        collectMediaPosts();

        // Encontrar el indice del post actual
        currentFullscreenIndex = fullscreenPosts.findIndex(p => p.id === postId);
        if (currentFullscreenIndex === -1) {
            currentFullscreenIndex = 0;
        }
        console.log('[DEBUG] currentFullscreenIndex:', currentFullscreenIndex);

        // Iniciar precarga inmediatamente
        preloadAdjacentMedia(currentFullscreenIndex);

        // Generar slides
        generateFullscreenSlides();

        // Mostrar viewer
        const viewer = document.getElementById('fullscreenViewer');
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Ocultar sidebar y header
        document.body.classList.add('fullscreen-mode');

        // Scroll al slide actual Y LUEGO reproducir
        // IMPORTANTE: NO reproducir antes del scroll para evitar audio duplicado
        setTimeout(() => {
            // Scroll sin animaci√≥n para evitar m√∫ltiples llamadas a onFullscreenScroll
            const container = document.getElementById('fullscreenSlidesContainer');
            const slideHeight = window.innerHeight;
            container.scrollTop = slideHeight * currentFullscreenIndex;

            updateCounter();
            updateNavButtons();

            // Ahora s√≠ reproducir despu√©s de que el scroll termin√≥
            setTimeout(() => {
                lastScrollIndex = currentFullscreenIndex; // Evitar que onFullscreenScroll lo pause
                playCurrentVideo();
            }, 50);
        }, 50);
    }

    // Generar HTML de cr√©ditos estilo YouTube Shorts
    function generateCreditsHtml(post) {
        const verifiedHtml = post.creatorVerified
            ? `<svg class="credits-verified" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`
            : '';

        const ladoBBadge = post.isLadoB
            ? `<span class="credits-badge-ladob">B</span>`
            : '';

        // Avatar del creador
        const avatarHtml = post.creatorPhoto
            ? `<img class="credits-avatar" src="${post.creatorPhoto}" alt="${escapeHtml(post.creatorName)}" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">`
            : `<div class="credits-avatar-placeholder" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">${escapeHtml(post.creatorName?.charAt(0) || '?')}</div>`;

        // M√∫sica si existe
        const musicHtml = (post.audioTitle || post.audioArtist)
            ? `<div class="credits-music">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    <span class="credits-music-text">${post.audioTitle || ''} ${post.audioArtist ? '- ' + post.audioArtist : ''}</span>
               </div>`
            : '';

        // Descripci√≥n si existe
        const descHtml = post.description
            ? `<div class="credits-description">${escapeHtml(post.description)}</div>`
            : '';

        return `
            <div class="fullscreen-credits">
                <div class="credits-content">
                    <!-- IZQUIERDA: Info del creador -->
                    <div class="credits-creator-section">
                        <div class="credits-creator-row">
                            ${avatarHtml}
                            <div class="credits-creator-info" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">
                                <div class="credits-name">
                                    ${escapeHtml(post.creatorName)}
                                    ${verifiedHtml}
                                    ${ladoBBadge}
                                </div>
                                <div class="credits-username">@@${escapeHtml(post.creatorUsername || post.creatorName)}</div>
                            </div>
                            <button class="credits-follow-btn ${post.isFollowing ? 'following' : ''}"
                                    data-creator-id="${post.creatorId}"
                                    onclick="event.stopPropagation(); followFromFullscreen('${post.creatorId}', this)">
                                ${post.isFollowing ? 'Siguiendo' : 'Seguir'}
                            </button>
                        </div>
                        ${descHtml}
                        ${musicHtml}
                    </div>

                    <!-- DERECHA: Acciones verticales -->
                    <div class="credits-actions">
                        <button class="credits-action-btn credits-like-btn ${post.isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); likeFromFullscreen(${post.id}, this)">
                            <svg viewBox="0 0 24 24" fill="${post.isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            <span class="credits-likes-count">${formatNumber(post.likes || 0)}</span>
                        </button>

                        <button class="credits-action-btn credits-comments-btn" onclick="event.stopPropagation(); window.location.href='/Feed/Detalle/${post.id}'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span class="credits-comments-count">${formatNumber(post.comments || 0)}</span>
                        </button>

                        <div class="credits-share-wrapper">
                            <button class="credits-action-btn" onclick="event.stopPropagation(); toggleShareMenu(this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                                    <polyline points="16,6 12,2 8,6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </button>
                            <div class="credits-share-menu">
                                <button class="credits-share-option" onclick="event.stopPropagation(); copyLinkFromFullscreen(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                    </svg>
                                    Copiar enlace
                                </button>
                                <button class="credits-share-option" onclick="event.stopPropagation(); shareWhatsApp(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    WhatsApp
                                </button>
                                <button class="credits-share-option" onclick="event.stopPropagation(); shareTwitter(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                    </svg>
                                    X (Twitter)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Formatear n√∫meros (1000 -> 1k, 1000000 -> 1M)
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
        return num.toString();
    }

    // Ir al perfil del creador
    function goToCreatorProfile(creatorId, isLadoB) {
        window.location.href = '/Feed/Perfil/' + creatorId + (isLadoB ? '?verSeudonimo=true' : '');
    }

    // Seguir/Dejar de seguir desde fullscreen
    async function followFromFullscreen(creatorId, btn) {
        const isFollowing = btn.classList.contains('following');
        const endpoint = isFollowing ? '/Feed/DejarDeSeguir' : '/Feed/Seguir';

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ creadorId: creatorId, tipoLado: 0 })
            });

            const data = await res.json();
            if (data.success) {
                // Actualizar el bot√≥n
                if (data.siguiendo) {
                    btn.classList.add('following');
                    btn.textContent = 'Siguiendo';
                } else {
                    btn.classList.remove('following');
                    btn.textContent = 'Seguir';
                }

                // Actualizar en fullscreenPosts para mantener sincronizado
                const postIndex = fullscreenPosts.findIndex(p => p.creatorId === creatorId);
                if (postIndex >= 0) {
                    fullscreenPosts[postIndex].isFollowing = data.siguiendo;
                }

                // Actualizar todos los botones de follow del mismo creador en el fullscreen
                document.querySelectorAll(`.credits-follow-btn[data-creator-id="${creatorId}"]`).forEach(otherBtn => {
                    if (data.siguiendo) {
                        otherBtn.classList.add('following');
                        otherBtn.textContent = 'Siguiendo';
                    } else {
                        otherBtn.classList.remove('following');
                        otherBtn.textContent = 'Seguir';
                    }
                });

                showFullscreenToast(data.siguiendo ? 'Siguiendo' : 'Dejaste de seguir');
            } else {
                showFullscreenToast(data.message || 'Error al procesar');
            }
        } catch (error) {
            console.error('Error al seguir:', error);
            showFullscreenToast('Error de conexi√≥n');
        }
    }

    // Toggle menu de compartir
    function toggleShareMenu(btn) {
        const menu = btn.parentElement.querySelector('.credits-share-menu');
        menu.classList.toggle('active');

        // Cerrar al hacer clic fuera
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!btn.parentElement.contains(e.target)) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    // Copiar enlace
    function copyLinkFromFullscreen(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        navigator.clipboard.writeText(url).then(() => {
            showFullscreenToast('Enlace copiado');
        }).catch(() => {
            showFullscreenToast('Error al copiar');
        });
    }

    // Compartir en WhatsApp
    function shareWhatsApp(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        window.open(`https://wa.me/?text=${encodeURIComponent('Mira este contenido en LADO: ' + url)}`, '_blank');
    }

    // Compartir en Twitter/X
    function shareTwitter(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Mira este contenido en LADO')}`, '_blank');
    }

    // Generar los slides
    function generateFullscreenSlides() {
        const container = document.getElementById('fullscreenSlidesContainer');
        container.innerHTML = '';

        fullscreenPosts.forEach((post, index) => {
            const slide = document.createElement('div');
            slide.className = 'fullscreen-slide';
            slide.dataset.postId = post.id;
            slide.dataset.index = index;

            // Marcar como cargado si ya esta en cache
            if (preloadedMedia.has(post.src) || post.loaded) {
                slide.classList.add('media-loaded');
            }

            // Contenido segun tipo
            if (post.type === 'video') {
                // Usar el video precargado si existe
                const preloadedVideo = preloadedMedia.get(post.src);
                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <video src="${post.src}"
                           playsinline
                           loop
                           muted
                           preload="metadata">
                    </video>
                    <button class="fullscreen-mute-btn" onclick="event.stopPropagation(); toggleFullscreenMute(this)" title="Activar/Desactivar sonido">
                        <svg class="icon-muted" viewBox="0 0 24 24" fill="white">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                // Marcar como cargado cuando el video este listo
                const videoEl = slide.querySelector('video');
                videoEl.oncanplaythrough = () => slide.classList.add('media-loaded');
                videoEl.onloadeddata = () => slide.classList.add('media-loaded');
            } else if (post.type === 'audio') {
                slide.innerHTML = `
                    <div class="fullscreen-audio-content">
                        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                        <audio src="${post.src}" controls></audio>
                    </div>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                slide.classList.add('media-loaded'); // Audio siempre listo
            } else if (post.isCarousel && post.carouselFiles && post.carouselFiles.length > 1) {
                // CARRUSEL - M√∫ltiples archivos con navegaci√≥n horizontal
                const carouselSlidesHtml = post.carouselFiles.map((file, idx) => {
                    if (file.type === 'video') {
                        return `<div class="fs-carousel-item ${idx === 0 ? 'active' : ''}" data-idx="${idx}">
                            <video src="${file.src}" playsinline loop muted></video>
                        </div>`;
                    } else {
                        return `<div class="fs-carousel-item ${idx === 0 ? 'active' : ''}" data-idx="${idx}">
                            <img src="${file.src}" alt="" draggable="false">
                        </div>`;
                    }
                }).join('');

                const dotsHtml = post.carouselFiles.map((_, idx) =>
                    `<span class="fs-carousel-dot ${idx === 0 ? 'active' : ''}" data-idx="${idx}"></span>`
                ).join('');

                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="fs-carousel-wrapper" data-post-id="${post.id}" data-current="0">
                        <div class="fs-carousel-slides">
                            ${carouselSlidesHtml}
                        </div>
                        <button class="fs-carousel-nav fs-carousel-prev" onclick="event.stopPropagation(); fsCarouselNav(${post.id}, -1)">
                            <svg viewBox="0 0 24 24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <button class="fs-carousel-nav fs-carousel-next" onclick="event.stopPropagation(); fsCarouselNav(${post.id}, 1)">
                            <svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </button>
                        <div class="fs-carousel-dots">${dotsHtml}</div>
                        <div class="fs-carousel-counter">1/${post.carouselFiles.length}</div>
                    </div>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                slide.classList.add('media-loaded');
                slide.classList.add('has-carousel');

                // Agregar eventos de swipe horizontal para el carrusel
                const wrapper = slide.querySelector('.fs-carousel-wrapper');
                let startX = 0;
                wrapper.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, { passive: true });
                wrapper.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = startX - endX;
                    if (Math.abs(diff) > 50) {
                        e.stopPropagation();
                        fsCarouselNav(post.id, diff > 0 ? 1 : -1);
                    }
                }, { passive: false });

                // Click en dots
                slide.querySelectorAll('.fs-carousel-dot').forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        fsCarouselGoTo(post.id, parseInt(dot.dataset.idx));
                    });
                });
            } else {
                // Imagen simple - verificar si tiene audio
                let audioHtml = '';
                if (post.audioSrc) {
                    audioHtml = `
                        <div class="fullscreen-music-badge" data-post-id="${post.id}">
                            <div class="fullscreen-music-icon">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                            </div>
                            <div class="fullscreen-music-info">
                                <div class="fullscreen-music-title">${post.audioTitle}</div>
                                <div class="fullscreen-music-artist">${post.audioArtist}</div>
                            </div>
                        </div>
                        <audio class="fullscreen-audio-player"
                               data-post-id="${post.id}"
                               src="${post.audioSrc}"
                               loop
                               data-start="${post.audioStart}"
                               data-volume="${post.audioVolume}">
                        </audio>
                    `;
                }
                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <img src="${post.src}" alt="" draggable="false">
                    ${audioHtml}
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                // Marcar como cargado cuando la imagen este lista
                const imgEl = slide.querySelector('img');
                imgEl.onload = () => {
                    slide.classList.add('media-loaded');
                };
                // Si ya estaba en cache, marcar inmediatamente
                if (imgEl.complete) {
                    slide.classList.add('media-loaded');
                }
            }

            // Doble tap para like
            slide.addEventListener('click', (e) => handleTap(e, post.id, slide));
            slide.addEventListener('touchend', (e) => handleTap(e, post.id, slide));

            container.appendChild(slide);
        });

        // Listener para scroll/snap
        container.addEventListener('scroll', onFullscreenScroll);
    }

    // Navegaci√≥n del carrusel dentro del fullscreen
    function fsCarouselNav(postId, direction) {
        const wrapper = document.querySelector(`.fs-carousel-wrapper[data-post-id="${postId}"]`);
        if (!wrapper) return;

        const items = wrapper.querySelectorAll('.fs-carousel-item');
        const total = items.length;
        let current = parseInt(wrapper.dataset.current || '0');

        // Calcular nuevo √≠ndice
        current += direction;
        if (current < 0) current = 0;
        if (current >= total) current = total - 1;

        fsCarouselGoTo(postId, current);
    }

    function fsCarouselGoTo(postId, index) {
        const wrapper = document.querySelector(`.fs-carousel-wrapper[data-post-id="${postId}"]`);
        if (!wrapper) return;

        const items = wrapper.querySelectorAll('.fs-carousel-item');
        const dots = wrapper.querySelectorAll('.fs-carousel-dot');
        const counter = wrapper.querySelector('.fs-carousel-counter');
        const prevBtn = wrapper.querySelector('.fs-carousel-prev');
        const nextBtn = wrapper.querySelector('.fs-carousel-next');
        const total = items.length;

        // Validar √≠ndice
        if (index < 0) index = 0;
        if (index >= total) index = total - 1;

        // Actualizar √≠ndice actual
        wrapper.dataset.current = index;

        // Actualizar items activos
        items.forEach((item, i) => {
            item.classList.toggle('active', i === index);
            // Pausar/reproducir videos
            const video = item.querySelector('video');
            if (video) {
                if (i === index) {
                    video.currentTime = 0;
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });

        // Actualizar dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });

        // Actualizar contador
        if (counter) {
            counter.textContent = `${index + 1}/${total}`;
        }

        // Mostrar/ocultar botones de navegaci√≥n
        if (prevBtn) prevBtn.style.display = index === 0 ? 'none' : 'flex';
        if (nextBtn) nextBtn.style.display = index === total - 1 ? 'none' : 'flex';
    }

    // Manejar tap/click (detectar doble tap)
    function handleTap(event, postId, slideElement) {
        // Ignorar si es audio controls
        if (event.target.tagName === 'AUDIO') return;

        const now = Date.now();
        const timeDiff = now - lastTapTime;

        if (timeDiff < 300 && timeDiff > 0) {
            // Doble tap - dar like
            clearTimeout(tapTimeout);
            triggerLike(postId, slideElement);
        } else {
            // Primer tap - toggle video si es video
            tapTimeout = setTimeout(() => {
                const video = slideElement.querySelector('video');
                if (video) {
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                }
            }, 300);
        }

        lastTapTime = now;
    }

    // Dar like con animacion (con debounce)
    function triggerLike(postId, slideElement) {
        // Verificar si ya tiene like (para no quitarlo con el toggle)
        const likeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
        const yaLeDioLike = likeBtn?.classList.contains('liked');

        // Siempre mostrar animacion del corazon
        const heart = slideElement.querySelector('.fullscreen-heart-animation');
        if (heart) {
            heart.classList.remove('animate');
            void heart.offsetWidth; // Reflow
            heart.classList.add('animate');

            setTimeout(() => {
                heart.classList.remove('animate');
            }, 800);
        }

        // Si ya tiene like, solo mostrar animacion, no llamar API
        if (yaLeDioLike) {
            return;
        }

        // Debounce: evitar m√∫ltiples calls simult√°neos
        if (likeInProgress.has(postId)) return;
        likeInProgress.add(postId);

        // Llamar al API de like (solo si no tiene like)
        fetch('/Feed/Like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.liked) {
                // Actualizar el boton de like en el feed
                if (likeBtn) {
                    likeBtn.classList.add('liked');
                }
                // Actualizar contador
                const likesSpan = document.getElementById(`likes-${postId}`);
                if (likesSpan && data.likes !== undefined) {
                    likesSpan.textContent = `${data.likes} Me gusta`;
                }
            }
        })
        .catch(err => console.error('Error al dar like:', err))
        .finally(() => {
            setTimeout(() => likeInProgress.delete(postId), 500);
        });
    }

    // Like desde los cr√©ditos del fullscreen (con debounce)
    function likeFromFullscreen(postId, button) {
        // Debounce: evitar m√∫ltiples clicks simult√°neos
        if (likeInProgress.has(postId)) return;
        likeInProgress.add(postId);

        const isLiked = button.classList.contains('liked');

        fetch('/Feed/Like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar el bot√≥n de cr√©ditos
                if (data.liked) {
                    button.classList.add('liked');
                    button.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    button.classList.remove('liked');
                    button.querySelector('svg').setAttribute('fill', 'none');
                }

                // Actualizar contador en cr√©ditos
                const likesCount = button.querySelector('.credits-likes-count');
                if (likesCount && data.likes !== undefined) {
                    likesCount.textContent = data.likes;
                }

                // Actualizar el bot√≥n de like en el feed principal
                const feedLikeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
                if (feedLikeBtn) {
                    if (data.liked) {
                        feedLikeBtn.classList.add('liked');
                    } else {
                        feedLikeBtn.classList.remove('liked');
                    }
                }

                // Actualizar contador en el feed principal
                const feedLikesSpan = document.getElementById(`likes-${postId}`);
                if (feedLikesSpan && data.likes !== undefined) {
                    feedLikesSpan.textContent = `${data.likes} Me gusta`;
                }

                // Mostrar animaci√≥n del coraz√≥n si dio like
                if (data.liked) {
                    const slide = button.closest('.fullscreen-slide');
                    const heart = slide?.querySelector('.fullscreen-heart-animation');
                    if (heart) {
                        heart.classList.remove('animate');
                        void heart.offsetWidth;
                        heart.classList.add('animate');
                        setTimeout(() => heart.classList.remove('animate'), 800);
                    }
                }

                // Actualizar el estado en fullscreenPosts para mantener sincronizado
                const postIndex = fullscreenPosts.findIndex(p => p.id === postId);
                if (postIndex !== -1) {
                    fullscreenPosts[postIndex].isLiked = data.liked;
                    fullscreenPosts[postIndex].likes = data.likes;
                }
            }
        })
        .catch(err => console.error('Error al dar like desde fullscreen:', err))
        .finally(() => {
            // Liberar despu√©s de 500ms para evitar spam
            setTimeout(() => likeInProgress.delete(postId), 500);
        });
    }

    // Compartir desde el fullscreen
    function shareFromFullscreen(postId) {
        const shareUrl = `${window.location.origin}/Feed/Detalle/${postId}`;

        if (navigator.share) {
            navigator.share({
                title: 'Mira este contenido en Lado',
                url: shareUrl
            }).catch(() => {
                // Fallback si cancela
                copyToClipboard(shareUrl);
            });
        } else {
            copyToClipboard(shareUrl);
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Mostrar notificaci√≥n
            showToast('Enlace copiado al portapapeles');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Enlace copiado al portapapeles');
        });
    }

    // Esta funci√≥n se elimina porque ya existe showToast arriba (l√≠nea 3607)
    // que usa #feedPageToast. La funci√≥n original es suficiente.

    // Scroll handler para detectar el slide actual
    let scrollTimeout;
    let isScrolling = false;
    let lastScrollIndex = -1;

    function onFullscreenScroll() {
        const container = document.getElementById('fullscreenSlidesContainer');
        if (!container) return;

        const slideHeight = window.innerHeight;
        const newIndex = Math.round(container.scrollTop / slideHeight);

        // Validar √≠ndice
        if (newIndex < 0 || newIndex >= fullscreenPosts.length) return;

        // INMEDIATAMENTE pausar todo cuando se detecta un cambio de slide durante scroll
        if (newIndex !== lastScrollIndex) {
            console.log('[DEBUG] onFullscreenScroll: cambio de', lastScrollIndex, 'a', newIndex);
            if (!isScrolling) {
                isScrolling = true;
                pauseAllFullscreenMedia();
            }
            lastScrollIndex = newIndex;
        }

        // Debounce para detectar cuando el scroll termina
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            isScrolling = false;

            // Solo reproducir si cambi√≥ el √≠ndice actual
            if (newIndex !== currentFullscreenIndex) {
                console.log('[DEBUG] onFullscreenScroll fin: actualizando a √≠ndice', newIndex);
                currentFullscreenIndex = newIndex;
                updateCounter();
                updateNavButtons();
                preloadAdjacentMedia(currentFullscreenIndex);
                playCurrentVideo();
            }
        }, 150);
    }

    // Scroll al slide
    function scrollToSlide(index, smooth = true) {
        const container = document.getElementById('fullscreenSlidesContainer');
        const slideHeight = window.innerHeight;
        container.scrollTo({
            top: slideHeight * index,
            behavior: smooth ? 'smooth' : 'auto'
        });
    }

    // Actualizar contador y visibilidad del bot√≥n de mute
    function updateCounter() {
        const counter = document.getElementById('fullscreenCounter');
        counter.textContent = `${currentFullscreenIndex + 1} / ${fullscreenPosts.length}`;
        // Actualizar visibilidad del bot√≥n de mute seg√∫n el tipo de contenido
        updateGlobalMuteVisibility();
    }

    // Reproducir video o audio del slide actual
    function playCurrentVideo() {
        // IMPORTANTE: Pausar TODOS los medios primero para evitar audio superpuesto
        pauseAllFullscreenMedia();

        // USAR data-index para buscar el slide correcto - m√°s confiable que √≠ndices de array
        const container = document.getElementById('fullscreenSlidesContainer');
        if (!container) {
            console.log('[DEBUG] No se encontr√≥ container');
            return;
        }

        const slide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);

        if (!slide) {
            console.log('[DEBUG] No se encontr√≥ slide con data-index:', currentFullscreenIndex);
            return;
        }

        const postId = slide.dataset.postId;
        console.log('[DEBUG] playCurrentVideo - √≠ndice:', currentFullscreenIndex, 'postId:', postId);

        // Intentar desbloquear audio primero (iOS)
        unlockAudio();

        // Reproducir video si existe
        const video = slide.querySelector('video');
        if (video) {
            // En iOS, primero intentar con mute, luego sin mute
            const playVideo = async () => {
                try {
                    video.muted = false;
                    await video.play();
                    // Actualizar icono del bot√≥n global (sin mute)
                    updateGlobalMuteIcon(false);
                } catch (e) {
                    // Si falla, intentar con mute
                    console.log('Reproduciendo video con mute debido a politica de autoplay');
                    video.muted = true;
                    try {
                        await video.play();
                        // Actualizar icono del bot√≥n global (con mute)
                        updateGlobalMuteIcon(true);
                    } catch (e2) {
                        console.log('No se pudo reproducir el video:', e2);
                    }
                }
            };
            playVideo();
            return; // Videos no tienen audio adicional
        }

        // Reproducir audio si existe (para imagenes con musica)
        const audio = slide.querySelector('audio.fullscreen-audio-player');
        const musicBadge = slide.querySelector('.fullscreen-music-badge');

        console.log('[DEBUG] Buscando audio en slide', postId, '- encontrado:', !!audio, 'badge:', !!musicBadge);

        if (audio && musicBadge) {
            const audioPostId = audio.dataset.postId;
            const audioSrc = audio.src;
            console.log('[DEBUG] Audio encontrado - postId:', audioPostId, 'src:', audioSrc);

            // Evitar reproducir si ya es el audio actual
            if (currentPlayingAudioId === audioPostId && !audio.paused) {
                console.log('[DEBUG] Audio ya reproduci√©ndose, saltando');
                return;
            }

            const startTime = parseFloat(audio.dataset.start) || 0;
            const volume = parseFloat(audio.dataset.volume) || 0.7;
            audio.currentTime = startTime;
            audio.volume = volume;

            const playAudio = async () => {
                try {
                    await audio.play();
                    currentPlayingAudioId = audioPostId;
                    musicBadge.classList.add('playing');
                    console.log('[DEBUG] Audio REPRODUCI√âNDOSE - postId:', audioPostId);
                } catch (e) {
                    console.log('Autoplay de audio bloqueado, esperando interaccion');
                    // Mostrar indicador de que necesita tap para reproducir
                    musicBadge.classList.add('tap-to-play');
                }
            };
            playAudio();

            // Click en badge para toggle - usar dataset para evitar duplicados
            if (!musicBadge.dataset.handlerAttached) {
                musicBadge.dataset.handlerAttached = 'true';
                musicBadge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const thisAudio = musicBadge.parentElement.querySelector('audio.fullscreen-audio-player');
                    if (!thisAudio) return;

                    musicBadge.classList.remove('tap-to-play');
                    if (thisAudio.paused) {
                        // Pausar todos los otros audios primero
                        pauseAllFullscreenMedia();
                        const st = parseFloat(thisAudio.dataset.start) || 0;
                        thisAudio.currentTime = st;
                        thisAudio.play().then(() => {
                            currentPlayingAudioId = thisAudio.dataset.postId;
                            musicBadge.classList.add('playing');
                        }).catch(() => {});
                    } else {
                        thisAudio.pause();
                        currentPlayingAudioId = null;
                        musicBadge.classList.remove('playing');
                    }
                });
            }
        }
    }

    // Pausar video y audio en indice
    function pauseVideoAtIndex(index) {
        const slides = document.querySelectorAll('.fullscreen-slide');
        if (slides[index]) {
            const slide = slides[index];

            // Pausar video
            const video = slide.querySelector('video');
            if (video) {
                video.pause();
            }

            // Pausar audio
            const audio = slide.querySelector('.fullscreen-audio-player');
            const musicBadge = slide.querySelector('.fullscreen-music-badge');
            if (audio) {
                audio.pause();
                if (musicBadge) {
                    musicBadge.classList.remove('playing');
                }
            }
        }
    }

    // Cerrar fullscreen viewer
    function closeFullscreenViewer() {
        console.log('[DEBUG] closeFullscreenViewer llamado');

        // Pausar todo primero
        pauseAllFullscreenMedia();

        // Ocultar bot√≥n de mute global
        const muteBtn = document.getElementById('globalMuteBtn');
        if (muteBtn) muteBtn.style.display = 'none';

        const viewer = document.getElementById('fullscreenViewer');
        viewer.classList.remove('active');
        document.body.classList.remove('fullscreen-mode');
        document.body.style.overflow = '';

        // Limpiar container
        document.getElementById('fullscreenSlidesContainer').innerHTML = '';

        // Resetear estado
        currentPlayingAudioId = null;
        currentFullscreenIndex = 0;
        isScrolling = false;
        lastScrollIndex = -1;

        // IMPORTANTE: Marcar fullscreen como inactivo para permitir que el IntersectionObserver del feed funcione
        isFullscreenActive = false;

        // Cerrar tambi√©n el carrusel fullscreen si est√° abierto
        closeFullscreenCarousel();
    }

    // Navegar entre slides con botones
    function navigateFullscreen(direction) {
        const container = document.getElementById('fullscreenSlidesContainer');
        const slideHeight = window.innerHeight;
        const newIndex = currentFullscreenIndex + direction;

        if (newIndex < 0 || newIndex >= fullscreenPosts.length) return;

        // Pausar media actual
        pauseAllFullscreenMedia();

        currentFullscreenIndex = newIndex;
        container.scrollTo({
            top: slideHeight * newIndex,
            behavior: 'smooth'
        });

        // Actualizar contador y botones
        updateCounter();
        updateNavButtons();

        // Reproducir despu√©s del scroll
        setTimeout(() => {
            lastScrollIndex = newIndex;
            playCurrentVideo();
        }, 300);
    }

    // Actualizar estado de botones de navegaci√≥n
    function updateNavButtons() {
        const prevBtn = document.getElementById('navPrevBtn');
        const nextBtn = document.getElementById('navNextBtn');

        if (prevBtn) prevBtn.disabled = currentFullscreenIndex === 0;
        if (nextBtn) nextBtn.disabled = currentFullscreenIndex >= fullscreenPosts.length - 1;
    }

    // ========================================
    // FULLSCREEN CARRUSEL - Para posts con m√∫ltiples archivos
    // ========================================
    let carouselFullscreenFiles = [];
    let carouselFullscreenIndex = 0;

    function openFullscreenCarousel(event, postId) {
        // No abrir si el click fue en un bot√≥n de navegaci√≥n
        if (event.target.closest('.carousel-btn') || event.target.closest('.carousel-dot')) {
            return;
        }
        event.preventDefault();
        event.stopPropagation();

        const carousel = document.querySelector(`.post-carousel[data-post-id="${postId}"]`);
        if (!carousel) return;

        // Obtener archivos del carrusel
        try {
            carouselFullscreenFiles = JSON.parse(carousel.dataset.carouselFiles || '[]');
        } catch (e) {
            console.error('Error parsing carousel files:', e);
            return;
        }

        if (carouselFullscreenFiles.length === 0) return;

        // Obtener √≠ndice actual del carrusel en el feed
        carouselFullscreenIndex = parseInt(carousel.dataset.currentIndex || '0');

        // Marcar fullscreen como activo
        isFullscreenActive = true;
        pauseFeedMedia();

        // Generar el viewer del carrusel
        generateCarouselFullscreenViewer();

        // Mostrar
        const viewer = document.getElementById('carouselFullscreenViewer');
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.body.classList.add('fullscreen-mode');

        // Ir al slide actual
        updateCarouselFullscreen();
    }

    function generateCarouselFullscreenViewer() {
        // Verificar si ya existe el viewer
        let viewer = document.getElementById('carouselFullscreenViewer');
        if (!viewer) {
            // Crear el viewer
            viewer = document.createElement('div');
            viewer.id = 'carouselFullscreenViewer';
            viewer.className = 'carousel-fullscreen-viewer';
            viewer.innerHTML = `
                <button class="carousel-fs-close" onclick="closeFullscreenCarousel()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div class="carousel-fs-counter" id="carouselFsCounter">1 / 1</div>
                <div class="carousel-fs-content" id="carouselFsContent"></div>
                <button class="carousel-fs-nav carousel-fs-prev" onclick="carouselFsPrev()">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <button class="carousel-fs-nav carousel-fs-next" onclick="carouselFsNext()">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </button>
                <div class="carousel-fs-dots" id="carouselFsDots"></div>
            `;
            document.body.appendChild(viewer);

            // Agregar swipe support
            let touchStartX = 0;
            let touchEndX = 0;
            viewer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            viewer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) carouselFsNext();
                    else carouselFsPrev();
                }
            }, { passive: true });

            // Click en el fondo para cerrar
            viewer.addEventListener('click', (e) => {
                if (e.target === viewer || e.target.classList.contains('carousel-fs-content')) {
                    closeFullscreenCarousel();
                }
            });
        }

        // Generar contenido
        const content = document.getElementById('carouselFsContent');
        content.innerHTML = carouselFullscreenFiles.map((file, index) => {
            if (file.type === 'video') {
                return `<div class="carousel-fs-slide ${index === carouselFullscreenIndex ? 'active' : ''}" data-index="${index}">
                    <video src="${file.src}" playsinline loop muted></video>
                    <button class="carousel-fs-mute" onclick="toggleCarouselFsVideoMute(this)">
                        <svg class="icon-muted" viewBox="0 0 24 24" fill="white"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                </div>`;
            } else {
                return `<div class="carousel-fs-slide ${index === carouselFullscreenIndex ? 'active' : ''}" data-index="${index}">
                    <img src="${file.src}" alt="">
                </div>`;
            }
        }).join('');

        // Generar dots
        const dots = document.getElementById('carouselFsDots');
        dots.innerHTML = carouselFullscreenFiles.map((_, index) =>
            `<span class="carousel-fs-dot ${index === carouselFullscreenIndex ? 'active' : ''}" onclick="goToCarouselFsSlide(${index})"></span>`
        ).join('');
    }

    function updateCarouselFullscreen() {
        const content = document.getElementById('carouselFsContent');
        const counter = document.getElementById('carouselFsCounter');
        const dots = document.getElementById('carouselFsDots');
        const prevBtn = document.querySelector('.carousel-fs-prev');
        const nextBtn = document.querySelector('.carousel-fs-next');

        // Actualizar slides activos
        content.querySelectorAll('.carousel-fs-slide').forEach((slide, index) => {
            slide.classList.toggle('active', index === carouselFullscreenIndex);
            // Pausar/reproducir videos
            const video = slide.querySelector('video');
            if (video) {
                if (index === carouselFullscreenIndex) {
                    video.currentTime = 0;
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });

        // Actualizar dots
        dots.querySelectorAll('.carousel-fs-dot').forEach((dot, index) => {
            dot.classList.toggle('active', index === carouselFullscreenIndex);
        });

        // Actualizar contador
        counter.textContent = `${carouselFullscreenIndex + 1} / ${carouselFullscreenFiles.length}`;

        // Mostrar/ocultar botones de navegaci√≥n
        if (prevBtn) prevBtn.style.display = carouselFullscreenIndex === 0 ? 'none' : 'flex';
        if (nextBtn) nextBtn.style.display = carouselFullscreenIndex === carouselFullscreenFiles.length - 1 ? 'none' : 'flex';
    }

    function carouselFsPrev() {
        if (carouselFullscreenIndex > 0) {
            carouselFullscreenIndex--;
            updateCarouselFullscreen();
        }
    }

    function carouselFsNext() {
        if (carouselFullscreenIndex < carouselFullscreenFiles.length - 1) {
            carouselFullscreenIndex++;
            updateCarouselFullscreen();
        }
    }

    function goToCarouselFsSlide(index) {
        carouselFullscreenIndex = index;
        updateCarouselFullscreen();
    }

    function toggleCarouselFsVideoMute(btn) {
        const slide = btn.closest('.carousel-fs-slide');
        const video = slide ? slide.querySelector('video') : null;
        if (!video) return;

        video.muted = !video.muted;
        btn.querySelector('.icon-muted').style.display = video.muted ? 'block' : 'none';
        btn.querySelector('.icon-unmuted').style.display = video.muted ? 'none' : 'block';
    }

    function closeFullscreenCarousel() {
        const viewer = document.getElementById('carouselFullscreenViewer');
        if (viewer) {
            // Pausar todos los videos
            viewer.querySelectorAll('video').forEach(v => v.pause());
            viewer.classList.remove('active');
        }
        document.body.classList.remove('fullscreen-mode');
        document.body.style.overflow = '';
        isFullscreenActive = false;
        carouselFullscreenFiles = [];
        carouselFullscreenIndex = 0;
    }

    // Keyboard navigation para carrusel fullscreen
    document.addEventListener('keydown', function(e) {
        const viewer = document.getElementById('carouselFullscreenViewer');
        if (!viewer || !viewer.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeFullscreenCarousel();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            carouselFsPrev();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            carouselFsNext();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        const viewer = document.getElementById('fullscreenViewer');
        if (!viewer.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeFullscreenViewer();
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
            e.preventDefault();
            if (currentFullscreenIndex < fullscreenPosts.length - 1) {
                currentFullscreenIndex++;
                scrollToSlide(currentFullscreenIndex);
                updateCounter();
                preloadAdjacentMedia(currentFullscreenIndex);
                // playCurrentVideo() ya llama a pauseAllFullscreenMedia()
                playCurrentVideo();
            }
        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
            e.preventDefault();
            if (currentFullscreenIndex > 0) {
                currentFullscreenIndex--;
                scrollToSlide(currentFullscreenIndex);
                updateCounter();
                preloadAdjacentMedia(currentFullscreenIndex);
                // playCurrentVideo() ya llama a pauseAllFullscreenMedia()
                playCurrentVideo();
            }
        } else if (e.key === ' ') {
            e.preventDefault();
            // Toggle play/pause del video actual
            const slides = document.querySelectorAll('.fullscreen-slide');
            const video = slides[currentFullscreenIndex]?.querySelector('video');
            if (video) {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            }
        }
    });

    // Cerrar al hacer click fuera (en el background)
    document.getElementById('fullscreenViewer')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullscreenViewer();
        }
    });

    // ==========================================
    // SWIPE HORIZONTAL PARA CERRAR/DETALLE
    // ==========================================
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let swipeDirection = null; // 'horizontal', 'vertical', o null

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
            swipeDirection = null;
        }
    }, { passive: true });

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1 || swipeDirection === 'vertical') return;

        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = Math.abs(touchX - touchStartX);
        const deltaY = Math.abs(touchY - touchStartY);

        // Determinar direccion del swipe en los primeros 15px de movimiento
        if (swipeDirection === null && (deltaX > 15 || deltaY > 15)) {
            if (deltaX > deltaY * 1.5) {
                swipeDirection = 'horizontal';
            } else {
                swipeDirection = 'vertical';
            }
        }
    }, { passive: true });

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchend', function(e) {
        if (swipeDirection !== 'horizontal') {
            swipeDirection = null;
            return;
        }

        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        const deltaTime = Date.now() - touchStartTime;

        // Calcular velocidad del swipe
        const velocity = Math.abs(deltaX) / deltaTime;

        // Swipe hacia la izquierda: deltaX negativo -> cerrar viewer
        const isSwipeLeft = deltaX < -100 || (deltaX < -50 && velocity > 0.4);

        // Swipe hacia la derecha: deltaX positivo -> ir al detalle
        const isSwipeRight = deltaX > 100 || (deltaX > 50 && velocity > 0.4);

        if (isSwipeLeft) {
            closeFullscreenViewer();
        } else if (isSwipeRight) {
            // Ir al detalle de la publicacion actual
            const currentPost = fullscreenPosts[currentFullscreenIndex];
            if (currentPost && currentPost.id) {
                closeFullscreenViewer();
                window.location.href = '/Feed/Detalle/' + currentPost.id;
            }
        }

        swipeDirection = null;
    }, { passive: true });

    // ========================================
    // ALGORITHM SELECTOR
    // ========================================

    // Exponer globalmente para el onchange
    window.cambiarAlgoritmoSelect = async function(algoritmoId) {
        console.log('cambiarAlgoritmoSelect llamado con:', algoritmoId);

        if (!algoritmoId) {
            console.log('algoritmoId es vac√≠o, saliendo');
            return;
        }

        const select = document.getElementById('algorithmSelect');
        if (select) {
            select.disabled = true; // Deshabilitar mientras procesa
        }

        try {
            console.log('Enviando POST a /Feed/CambiarAlgoritmo');

            const response = await fetch('/Feed/CambiarAlgoritmo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: `algoritmoId=${algoritmoId}`
            });

            console.log('Respuesta recibida, status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Data recibida:', data);

            if (data.success) {
                // Recargar pagina para aplicar nuevo algoritmo
                window.location.reload();
            } else {
                console.error('Error del servidor:', data.message);
                if (select) select.disabled = false;
            }
        } catch (error) {
            console.error('Error en cambiarAlgoritmoSelect:', error);
            if (select) select.disabled = false;
        }
    };

    // ========================================
    // ABRIR POST COMPARTIDO AUTOMATICAMENTE
    // ========================================
    @if (ViewBag.SharedPostId != null) {
        <text>
    (function() {
        const sharedPostId = @ViewBag.SharedPostId;
        console.log('[SharedPost] Abriendo post compartido:', sharedPostId);

        window.addEventListener('load', function() {
            setTimeout(() => {
                const postElement = document.querySelector(`.post[data-post-id="${sharedPostId}"]`);
                console.log('[SharedPost] Post element:', postElement);

                if (postElement) {
                    // Scroll al post
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Highlight temporal
                    postElement.style.transition = 'box-shadow 0.3s';
                    postElement.style.boxShadow = '0 0 0 3px #6366f1';
                    setTimeout(() => {
                        postElement.style.boxShadow = '';
                    }, 2000);

                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, 500);
        });
    })();
        </text>
    }

    @if (ViewBag.SharedPostNoAccess != null) {
        <text>
    (function() {
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('sharedPostNoAccessModal').classList.add('active');
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 300);
        });
    })();
        </text>
    }
</script>

<!-- Modal: No tienes acceso al post compartido -->
@if (ViewBag.SharedPostNoAccess != null) {
    var noAccess = ViewBag.SharedPostNoAccess;
    <div class="modal-overlay" id="sharedPostNoAccessModal">
        <div class="share-modal" style="max-width: 380px; text-align: center;">
            <div class="share-modal-header">
                Contenido exclusivo
                <button class="share-modal-close" onclick="document.getElementById('sharedPostNoAccessModal').classList.remove('active')">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    @if (!string.IsNullOrEmpty((string)noAccess.CreadorFoto)) {
                        <img src="@noAccess.CreadorFoto" alt="" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
                    } else {
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); display: inline-flex; align-items: center; justify-content: center; font-size: 2rem; color: white;">
                            @(((string)noAccess.CreadorNombre)?.Substring(0, 1).ToUpper() ?? "?")
                        </div>
                    }
                </div>
                <h3 style="margin-bottom: 8px; font-size: 1.1rem;">@noAccess.CreadorNombre</h3>
                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">
                    @if ((string)noAccess.TipoLado == "LadoB") {
                        <text>Este contenido es exclusivo para suscriptores de Lado B</text>
                    } else {
                        <text>Sigue a este creador para ver su contenido</text>
                    }
                </p>
                <a href="/Feed/Perfil/@noAccess.CreadorUsername" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; text-decoration: none;">
                    <i class="fas fa-user-plus"></i>
                    Ver perfil
                </a>
                @if (noAccess.Precio != null && (decimal)noAccess.Precio > 0) {
                    <p style="margin-top: 12px; font-size: 0.8rem; color: var(--muted);">
                        Desde $@(((decimal)noAccess.Precio).ToString("N0"))/mes
                    </p>
                }
            </div>
        </div>
    </div>
}
