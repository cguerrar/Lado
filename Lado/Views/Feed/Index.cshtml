@model IEnumerable<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "Feed";
    var likesUsuario = ViewBag.LikesUsuario as List<int> ?? new List<int>();
    var favoritosIds = ViewBag.FavoritosIds as List<int> ?? new List<int>();
    var usuariosSeguidosIds = ViewBag.UsuariosSeguidosIds as List<string> ?? new List<string>();
    var stories = ViewBag.Stories as IEnumerable<dynamic>;
    var usuarioActual = ViewBag.UsuarioActual as ApplicationUser;
    var creadoresSugeridos = ViewBag.CreadoresSugeridos as List<Lado.Services.CreadorSugeridoDto> ?? new List<Lado.Services.CreadorSugeridoDto>();
    var creadoresSugeridosJson = ViewBag.CreadoresSugeridosJson as string ?? "[]";
    var contenidoBloqueadoIds = ViewBag.ContenidoBloqueadoIds as List<int> ?? new List<int>();
    // DEBUG
    var debugSuscripcionesLadoBIds = ViewBag.DEBUG_SuscripcionesLadoBIds as List<int> ?? new List<int>();
    var debugCompradosIds = ViewBag.DEBUG_CompradosIds as List<int> ?? new List<int>();
    var debugCreadoresLadoBIds = ViewBag.DEBUG_CreadoresLadoBIds as List<string> ?? new List<string>();
    var anuncios = ViewBag.Anuncios as List<Lado.Models.Anuncio> ?? new List<Lado.Models.Anuncio>();
    var anunciosIntervalo = ViewBag.AnunciosIntervalo as int? ?? 8;
    var algoritmoActual = ViewBag.AlgoritmoActual as AlgoritmoFeed;
    var algoritmosDisponibles = ViewBag.AlgoritmosDisponibles as List<AlgoritmoFeed> ?? new List<AlgoritmoFeed>();
    var mensajesNoLeidos = ViewBag.MensajesNoLeidos as int? ?? 0;

    // Función para limpiar comillas de rutas (datos legacy)
    string LimpiarRuta(string ruta) {
        if (string.IsNullOrEmpty(ruta)) return "";
        var limpia = ruta.Trim();
        while (limpia.StartsWith("\"") || limpia.StartsWith("'") || limpia.StartsWith("\\\""))
            limpia = limpia.TrimStart('"', '\'', '\\');
        while (limpia.EndsWith("\"") || limpia.EndsWith("'") || limpia.EndsWith("\\\""))
            limpia = limpia.TrimEnd('"', '\'', '\\');
        return limpia.Replace("\"", "").Replace("'", "").Replace("&quot;", "").Replace("%22", "");
    }
}

@Html.AntiForgeryToken()

<style>
    /* ========================================
       PREVENIR PULL-TO-REFRESH NATIVO DEL NAVEGADOR
       Usamos nuestro propio pull-to-refresh
       ======================================== */
    html, body {
        overscroll-behavior-y: contain;
    }

    /* Ocultar toast en el feed */
    .toast-notification,
    #toastNotification {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    /* ========================================
       FEED INSTAGRAM-STYLE - REDISEÑO COMPLETO
       ======================================== */

    /* MAIN LAYOUT */
    .feed-page-layout {
        display: grid;
        grid-template-columns: minmax(0, 630px) 320px;
        gap: 32px;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px 16px;
        justify-content: center;
    }

    .feed-main {
        min-width: 0;
    }

    .feed-sidebar {
        position: sticky;
        top: 90px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .feed-sidebar::-webkit-scrollbar {
        display: none;
    }

    .feed-container {
        max-width: 630px;
        margin: 0 auto;
    }

    /* ========================================
       ALGORITHM SELECTOR (SELECT NATIVO)
       ======================================== */
    .algorithm-selector {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .algorithm-label {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .algorithm-label svg {
        width: 16px;
        height: 16px;
    }

    .algorithm-select {
        padding: 8px 32px 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: var(--fg);
        background-color: var(--bg);
        border: 1px solid var(--line);
        border-radius: 20px;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        min-width: 160px;
        transition: all 0.2s;
    }

    .algorithm-select:hover {
        border-color: var(--primary);
    }

    .algorithm-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.15);
    }

    .algorithm-select option {
        padding: 8px;
        background: var(--surface);
        color: var(--fg);
    }

    /* ========================================
       PLACEHOLDER PARA MEDIOS CON ERROR
       ======================================== */
    .media-error-placeholder {
        width: 100%;
        height: 100%;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 8px;
    }

    .media-error-placeholder svg {
        width: 64px;
        height: 64px;
        opacity: 0.5;
    }

    /* ========================================
       STORIES BAR
       ======================================== */
    .stories-bar {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .stories-scroll {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 4px 0;
        cursor: grab;
    }

    .stories-scroll::-webkit-scrollbar {
        display: none;
    }

    .stories-scroll.is-dragging {
        cursor: grabbing;
    }

    .story-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .story-ring {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }

    .story-ring.seen {
        background: #4682B4; /* Steel Blue */
    }

    .story-ring-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--surface);
        padding: 2px;
    }

    .story-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .story-avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 28px;
    }

    .story-username {
        font-size: 12px;
        color: var(--fg);
        max-width: 100px;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* TU STORY - Estilo especial con botón + */
    .story-ring.your-story {
        background: linear-gradient(135deg, var(--line) 0%, var(--muted) 100%);
        position: relative;
    }

    .story-ring.your-story.has-story {
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }

    .story-add-btn {
        position: absolute;
        bottom: 0px;
        right: 0px;
        width: 30px;
        height: 30px;
        background: var(--primary);
        border-radius: 50%;
        border: 2px solid var(--surface);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .story-add-btn svg {
        width: 14px;
        height: 14px;
    }

    .story-item:hover .story-add-btn {
        transform: scale(1.1);
        transition: transform 0.2s;
    }

    /* ========================================
       STORY VIEWER MODAL - Pantalla Completa
       ======================================== */

    /* Variables de tema para el visor de stories */
    :root {
        --story-overlay-bg: rgba(241, 245, 249, 0.97);
        --story-container-bg: #e2e8f0;
        --story-header-bg: linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, transparent 100%);
        --story-text-color: #1e293b;
        --story-text-secondary: rgba(30, 41, 59, 0.7);
        --story-close-bg: rgba(0, 0, 0, 0.1);
        --story-close-bg-hover: rgba(0, 0, 0, 0.2);
        --story-close-color: #334155;
        --story-progress-bg: rgba(0, 0, 0, 0.2);
        --story-progress-fill: var(--primary);
    }

    [data-theme="dark"] {
        --story-overlay-bg: rgba(15, 23, 42, 0.97);
        --story-container-bg: #1e293b;
        --story-header-bg: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
        --story-text-color: #f8fafc;
        --story-text-secondary: rgba(248, 250, 252, 0.7);
        --story-close-bg: rgba(255, 255, 255, 0.2);
        --story-close-bg-hover: rgba(255, 255, 255, 0.3);
        --story-close-color: white;
        --story-progress-bg: rgba(255, 255, 255, 0.3);
        --story-progress-fill: white;
    }

    .story-viewer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--story-overlay-bg);
        z-index: 9999999;
        display: none;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }

    .story-viewer-overlay.active {
        display: flex;
    }

    /* Ocultar header y bottom nav cuando el visor de stories está activo */
    body.story-viewer-open .top-navbar,
    body.story-viewer-open .bottom-nav {
        display: none !important;
    }

    .story-viewer-container {
        position: relative;
        width: 100%;
        max-width: 420px;
        height: 90vh;
        max-height: 750px;
        background: var(--story-container-bg);
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        transition: background 0.3s ease;
    }

    /* Móvil: pantalla completa con safe-area para Dynamic Island/Notch */
    @@media (max-width: 768px) {
        .story-viewer-container {
            max-width: 100%;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            max-height: none;
            border-radius: 0;
            box-shadow: none;
            /* Safe area para Dynamic Island arriba y home indicator abajo */
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            background: #000; /* Fondo negro para las áreas safe */
        }

        .story-viewer-header {
            padding: 10px 12px !important;
            /* Posicionar respetando la Dynamic Island/Notch - con fallback */
            top: 47px !important; /* Fallback para Dynamic Island */
            top: max(47px, env(safe-area-inset-top, 47px)) !important;
            padding-top: 10px !important;
        }

        .story-progress-container {
            gap: 3px;
            margin-bottom: 10px;
            /* Ajustar posición para safe-area */
            margin-top: 4px;
        }

        .story-viewer-user {
            gap: 8px;
        }

        .story-viewer-avatar,
        .story-viewer-avatar-placeholder {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }

        .story-viewer-username {
            font-size: 13px;
        }

        .story-viewer-time {
            font-size: 11px;
        }

        .story-header-actions {
            /* Posicionar respetando la Dynamic Island/Notch - con fallback */
            top: 57px !important; /* Fallback: 47px + 10px */
            top: calc(max(47px, env(safe-area-inset-top, 47px)) + 10px) !important;
            right: 12px;
            gap: 6px;
        }

        .story-menu-btn,
        .story-audio-btn,
        .story-viewer-close {
            width: 28px;
            height: 28px;
        }

        .story-menu-btn svg,
        .story-audio-btn svg,
        .story-viewer-close svg {
            width: 16px;
            height: 16px;
        }

        .story-bottom-bar {
            padding: 12px;
            padding-bottom: max(12px, calc(env(safe-area-inset-bottom) + 8px));
            gap: 10px;
        }
    }

    .story-viewer-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 12px 16px;
        z-index: 10;
        background: var(--story-header-bg);
    }

    .story-progress-container {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
    }

    .story-progress-bar {
        flex: 1;
        height: 3px;
        background: var(--story-progress-bg);
        border-radius: 2px;
        overflow: hidden;
    }

    .story-progress-fill {
        height: 100%;
        background: var(--story-progress-fill);
        width: 0%;
        transition: width 0.1s linear;
    }

    .story-progress-bar.completed .story-progress-fill {
        width: 100%;
    }

    .story-progress-bar.active .story-progress-fill {
        /* Duración se establece dinámicamente via JavaScript con --story-duration */
        animation: storyProgress var(--story-duration, 5s) linear forwards;
    }

    @@keyframes storyProgress {
        from { width: 0%; }
        to { width: 100%; }
    }

    .story-viewer-user {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .story-viewer-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--story-text-color);
    }

    .story-viewer-avatar-placeholder {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        border: 2px solid var(--story-text-color);
    }

    .story-viewer-username {
        color: var(--story-text-color);
        font-weight: 600;
        font-size: 14px;
    }

    .story-viewer-time {
        color: var(--story-text-secondary);
        font-size: 12px;
    }

    .story-viewer-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        background: var(--story-close-bg);
        border: none;
        border-radius: 50%;
        color: var(--story-close-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 11;
        transition: background 0.2s ease;
    }

    .story-viewer-close:hover {
        background: var(--story-close-bg-hover);
    }

    /* Contenedor de botones del header */
    .story-header-actions {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 11;
    }

    .story-header-actions .story-viewer-close {
        position: static;
    }

    /* Botón de menú */
    .story-menu-btn {
        width: 32px;
        height: 32px;
        background: var(--story-close-bg);
        border: none;
        border-radius: 50%;
        color: var(--story-close-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .story-menu-btn:hover {
        background: var(--story-close-bg-hover);
    }

    /* Botón de audio */
    .story-audio-btn {
        width: 32px;
        height: 32px;
        background: var(--story-close-bg);
        border: none;
        border-radius: 50%;
        color: var(--story-close-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .story-audio-btn:hover {
        background: var(--story-close-bg-hover);
    }

    .story-audio-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Menú dropdown */
    .story-menu-dropdown {
        position: absolute;
        top: 40px;
        right: 40px;
        background: var(--surface);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        overflow: hidden;
        display: none;
        min-width: 180px;
        z-index: 100;
    }

    .story-menu-dropdown.active {
        display: block;
    }

    .story-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 14px 16px;
        background: none;
        border: none;
        color: var(--fg);
        font-size: 14px;
        cursor: pointer;
        text-align: left;
        transition: background 0.15s;
    }

    .story-menu-item:hover {
        background: var(--bg);
    }

    .story-menu-item svg {
        flex-shrink: 0;
        color: var(--muted);
    }

    .story-menu-item.danger {
        color: #ef4444;
    }

    .story-menu-item.danger svg {
        color: #ef4444;
    }

    /* Estilos para anuncios en stories */
    .story-ad-badge {
        position: absolute;
        top: 70px;
        left: 16px;
        background: rgba(0,0,0,0.5);
        color: white;
        font-size: 11px;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 10;
    }

    .story-ad-cta {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: #111;
        font-size: 14px;
        font-weight: 600;
        padding: 12px 32px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .story-ad-cta:hover {
        transform: translateX(-50%) scale(1.02);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .story-ad-cta svg {
        width: 16px;
        height: 16px;
    }

    .story-swipe-hint {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 12px;
        opacity: 0.7;
        z-index: 10;
    }

    .story-viewer-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        background: #000;
    }

    /* Fondo blur estilo Instagram - muestra imagen escalada y borrosa detrás */
    .story-blur-background {
        position: absolute;
        top: -20px;
        left: -20px;
        right: -20px;
        bottom: -20px;
        background-size: cover;
        background-position: center;
        filter: blur(30px) brightness(0.6);
        transform: scale(1.1);
        z-index: 0;
    }

    /* Indicador de carga de story */
    .story-loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        color: white;
        font-size: 14px;
        z-index: 10;
    }

    .story-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: storySpinner 0.8s linear infinite;
    }

    @@keyframes storySpinner {
        to { transform: rotate(360deg); }
    }

    .story-viewer-media {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        position: relative;
        z-index: 1;
    }

    .story-viewer-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        position: relative;
        z-index: 1;
    }

    /* En móvil, las imágenes pueden usar cover si el aspect ratio es cercano a 9:16 */
    @@media (max-width: 768px) {
        .story-viewer-media.cover-mode,
        .story-viewer-video.cover-mode {
            object-fit: cover;
        }
    }

    .story-viewer-text {
        position: absolute;
        bottom: 60px;
        left: 16px;
        right: 16px;
        color: var(--story-text-color);
        font-size: 16px;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    /* Contenedor de overlays del editor */
    .story-overlays-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
    }

    .story-overlay-item {
        position: absolute;
        pointer-events: none;
        /* Centrar porque las coordenadas del editor son el centro del objeto */
        transform: translate(-50%, -50%);
    }

    .story-overlay-text {
        white-space: pre-wrap;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .story-overlay-sticker {
        font-size: 48px;
    }

    .story-overlay-mention {
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 14px;
    }

    .story-overlay-drawing {
        width: 100%;
        height: 100%;
    }

    .story-overlay-link {
        pointer-events: auto !important;
        cursor: pointer;
        color: white;
        font-weight: 600;
        font-size: 15px;
        text-decoration: none;
        display: inline-block;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
        z-index: 10;
        /* Centrar el elemento porque las coordenadas representan el centro */
        transform: translate(-50%, -50%);
    }

    .story-overlay-link:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    /* Indicador de música */
    .story-music-indicator {
        position: absolute;
        bottom: 80px;
        left: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--story-close-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 8px 12px;
        border-radius: 20px;
        color: var(--story-text-color);
        z-index: 10;
    }

    .story-music-indicator .music-icon {
        animation: musicBounce 0.5s ease infinite alternate;
    }

    @@keyframes musicBounce {
        from { transform: scale(1); }
        to { transform: scale(1.1); }
    }

    .story-music-indicator .music-info {
        display: flex;
        flex-direction: column;
    }

    .story-music-indicator .music-title {
        font-size: 12px;
        font-weight: 600;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .story-music-indicator .music-artist {
        font-size: 10px;
        opacity: 0.8;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Navegación táctil */
    .story-nav-zone {
        position: absolute;
        top: calc(60px + env(safe-area-inset-top, 0px));
        bottom: calc(80px + env(safe-area-inset-bottom, 0px)); /* Dejar espacio para la barra de acciones */
        width: 35%;
        z-index: 5;
        cursor: pointer;
    }

    .story-nav-zone.prev {
        left: 0;
    }

    .story-nav-zone.next {
        right: 0;
    }

    /* Navegación entre usuarios */
    .story-user-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        color: #262626;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .story-user-nav:hover {
        background: white;
    }

    .story-user-nav.prev {
        left: -60px;
    }

    .story-user-nav.next {
        right: -60px;
    }

    .story-user-nav svg {
        width: 20px;
        height: 20px;
    }

    /* ========================================
       BARRA DE ACCIONES DEL STORY (Like + Mensaje)
       ======================================== */

    /* Barra inferior estilo Instagram mejorada */
    .story-bottom-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 20;
    }

    /* Fila de reacciones rápidas */
    .story-reactions-row {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .story-reaction-btn {
        width: 44px;
        height: 44px;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        transition: all 0.2s ease;
        -webkit-tap-highlight-color: transparent;
    }

    .story-reaction-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.1);
    }

    .story-reaction-btn:active {
        transform: scale(0.9);
    }

    .story-reaction-btn.sent {
        animation: reactionSent 0.5s ease;
    }

    @@keyframes reactionSent {
        0% { transform: scale(1); }
        30% { transform: scale(1.4); }
        60% { transform: scale(0.8); }
        100% { transform: scale(1); }
    }

    /* Fila de input y acciones */
    .story-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .story-input-wrapper {
        flex: 1;
        position: relative;
        min-width: 0;
    }

    .story-input-hint {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 3px;
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        pointer-events: none;
    }

    .story-input-hint svg {
        width: 12px;
        height: 12px;
        opacity: 0.7;
    }

    .story-input {
        width: 100%;
        min-width: 0;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        padding: 12px 70px 12px 18px;
        color: white;
        font-size: 15px;
        outline: none;
        transition: all 0.2s;
    }

    .story-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .story-input:focus {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(255, 255, 255, 0.4);
    }

    .story-bottom-actions {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .story-bottom-btn {
        width: 48px;
        height: 48px;
        border: none;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
        border-radius: 50%;
        -webkit-tap-highlight-color: transparent;
    }

    .story-bottom-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
    }

    .story-bottom-btn:active {
        transform: scale(0.9);
    }

    .story-bottom-btn svg {
        width: 26px;
        height: 26px;
    }

    /* Like con corazón rojo */
    .story-bottom-btn.liked {
        background: rgba(255, 48, 64, 0.2);
    }

    .story-bottom-btn.liked svg {
        fill: #ff3040 !important;
        stroke: #ff3040 !important;
        color: #ff3040;
    }

    .story-bottom-btn.liked svg path {
        fill: #ff3040 !important;
        stroke: #ff3040 !important;
    }

    @@keyframes storyLikePop {
        0% { transform: scale(1); }
        30% { transform: scale(1.4); }
        60% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }

    .story-bottom-btn.liked {
        animation: storyLikePop 0.4s ease;
    }

    .story-like-count {
        font-size: 13px;
        color: white;
        font-weight: 500;
        position: absolute;
        bottom: -18px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
    }

    .story-like-count:empty {
        display: none;
    }

    #storyLikeBtn {
        position: relative;
    }

    /* Ocultar input en propias stories */
    .story-bottom-bar.own-story .story-input-wrapper,
    .story-bottom-bar.own-story .story-reactions-row {
        display: none;
    }

    .story-bottom-bar.own-story .story-input-row {
        justify-content: flex-end;
    }

    /* ========================================
       BARRA DE ACCIONES DEL CREADOR (Instagram style)
       ======================================== */
    .story-owner-actions {
        display: none;
        justify-content: center;
        gap: 24px;
        padding: 8px 0;
    }

    .story-bottom-bar.own-story .story-owner-actions {
        display: flex;
    }

    .story-bottom-bar.own-story .story-bottom-actions {
        display: none;
    }

    .story-owner-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        cursor: pointer;
        color: white;
        padding: 8px;
        min-width: 64px;
        transition: transform 0.2s ease;
        -webkit-tap-highlight-color: transparent;
    }

    .story-owner-action:active {
        transform: scale(0.9);
    }

    .story-owner-action-icon {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .story-owner-action:hover .story-owner-action-icon {
        background: rgba(255, 255, 255, 0.25);
    }

    .story-owner-action-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .story-owner-action-icon img {
        width: 26px;
        height: 26px;
    }

    .story-owner-action-label {
        font-size: 11px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        white-space: nowrap;
    }

    /* Icono de WhatsApp verde */
    .story-owner-action.whatsapp .story-owner-action-icon {
        background: #25D366;
    }

    .story-owner-action.whatsapp:hover .story-owner-action-icon {
        background: #20BD5A;
    }

    /* Contador de visualizaciones */
    .story-views-counter {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: white;
        font-size: 14px;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .story-views-counter:hover {
        background: rgba(0, 0, 0, 0.5);
    }

    .story-bottom-bar.own-story .story-views-counter {
        display: flex;
    }

    .story-views-counter svg {
        width: 18px;
        height: 18px;
    }

    /* Feedback de envío */
    .story-send-feedback {
        position: absolute;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        font-weight: 500;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 100;
    }

    .story-send-feedback.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .story-send-feedback .feedback-icon {
        font-size: 18px;
    }

    /* ========================================
       MODAL COMPARTIR STORY
       ======================================== */
    .share-story-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 99999999;
        display: none;
        align-items: flex-end;
        justify-content: center;
    }

    .share-story-overlay.active {
        display: flex;
    }

    .share-story-modal {
        background: var(--card-bg, white);
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        animation: slideUpShare 0.3s ease;
    }

    @@keyframes slideUpShare {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .share-story-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border, #eee);
    }

    .share-story-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--fg, #111);
    }

    .share-story-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg, #f5f5f5);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted, #666);
        transition: background 0.2s;
    }

    .share-story-close:hover {
        background: var(--border, #e0e0e0);
    }

    .share-story-options {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 20px;
    }

    @@media (max-width: 400px) {
        .share-story-options {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .share-story-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 12px 8px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 12px;
        transition: background 0.2s;
    }

    .share-story-option:hover {
        background: var(--bg, #f5f5f5);
    }

    .share-story-option:active {
        transform: scale(0.95);
    }

    .share-option-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .share-story-option span {
        font-size: 12px;
        color: var(--fg, #111);
        font-weight: 500;
        text-align: center;
    }

    /* Animación de reacciones flotantes */
    .story-reaction-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
    }

    .floating-emoji {
        position: absolute;
        font-size: 48px;
        animation: floatUp 1.5s ease-out forwards;
        opacity: 0;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    @@keyframes floatUp {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0.5) rotate(0deg);
        }
        20% {
            opacity: 1;
            transform: translateY(-50px) scale(1.2) rotate(-10deg);
        }
        40% {
            opacity: 1;
            transform: translateY(-120px) scale(1) rotate(10deg);
        }
        100% {
            opacity: 0;
            transform: translateY(-300px) scale(0.8) rotate(-5deg);
        }
    }

    /* Variantes de animación */
    .floating-emoji:nth-child(1) { animation-delay: 0s; }
    .floating-emoji:nth-child(2) { animation-delay: 0.1s; }
    .floating-emoji:nth-child(3) { animation-delay: 0.2s; }
    .floating-emoji:nth-child(4) { animation-delay: 0.15s; }
    .floating-emoji:nth-child(5) { animation-delay: 0.25s; }

    /* ========================================
       MODAL GUARDAR EN DESTACADOS
       ======================================== */
    .story-destacados-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 99999999;
        display: none;
        align-items: flex-end;
        justify-content: center;
    }

    .story-destacados-overlay.active {
        display: flex;
    }

    .story-destacados-modal {
        background: var(--card-bg, white);
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 70vh;
        overflow: hidden;
        animation: slideUpShare 0.3s ease;
    }

    .story-destacados-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border, #eee);
    }

    .story-destacados-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--fg, #111);
    }

    .story-destacados-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg, #f5f5f5);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted, #666);
        transition: background 0.2s;
    }

    .story-destacados-close:hover {
        background: var(--border, #e0e0e0);
    }

    .story-destacados-body {
        padding: 16px;
        overflow-y: auto;
        max-height: calc(70vh - 60px);
    }

    .destacados-nuevo-grupo {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg, #f5f5f5);
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .destacados-nuevo-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #ff6b6b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .destacados-nuevo-grupo input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 14px;
        color: var(--fg, #111);
        outline: none;
    }

    .destacados-nuevo-grupo input::placeholder {
        color: var(--muted, #666);
    }

    .destacados-crear-btn {
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .destacados-crear-btn:hover {
        opacity: 0.9;
    }

    .destacados-grupos-lista {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
    }

    .destacados-grupo-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--card-bg, white);
        border: 1px solid var(--border, #eee);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .destacados-grupo-item:hover {
        border-color: var(--primary);
        background: var(--bg, #f5f5f5);
    }

    .destacados-grupo-thumb {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border, #eee);
    }

    .destacados-grupo-info {
        flex: 1;
    }

    .destacados-grupo-nombre {
        font-weight: 600;
        color: var(--fg, #111);
        font-size: 14px;
    }

    .destacados-grupo-count {
        font-size: 12px;
        color: var(--muted, #666);
    }

    .destacados-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 20px;
        color: var(--muted, #666);
        font-size: 14px;
    }

    .spinner-small {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border, #eee);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .destacados-sin-grupo-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        background: transparent;
        border: 2px dashed var(--border, #ddd);
        border-radius: 12px;
        color: var(--muted, #666);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .destacados-sin-grupo-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    /* ========================================
       MODAL ENVIAR STORY A USUARIO
       ======================================== */
    .story-enviar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 99999999;
        display: none;
        align-items: flex-end;
        justify-content: center;
    }

    .story-enviar-overlay.active {
        display: flex;
    }

    .story-enviar-modal {
        background: var(--card-bg, white);
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        animation: slideUpShare 0.3s ease;
    }

    .story-enviar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border, #eee);
    }

    .story-enviar-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--fg, #111);
    }

    .story-enviar-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg, #f5f5f5);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted, #666);
        transition: background 0.2s;
    }

    .story-enviar-close:hover {
        background: var(--border, #e0e0e0);
    }

    .story-enviar-body {
        padding: 16px;
        overflow-y: auto;
        max-height: calc(80vh - 60px);
    }

    .story-enviar-search {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg, #f5f5f5);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .story-enviar-search svg {
        color: var(--muted, #666);
        flex-shrink: 0;
    }

    .story-enviar-search input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 14px;
        color: var(--fg, #111);
        outline: none;
    }

    .story-enviar-search input::placeholder {
        color: var(--muted, #666);
    }

    .story-enviar-mensaje {
        margin-bottom: 16px;
    }

    .story-enviar-mensaje input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border, #eee);
        border-radius: 12px;
        font-size: 14px;
        color: var(--fg, #111);
        outline: none;
        transition: border-color 0.2s;
    }

    .story-enviar-mensaje input:focus {
        border-color: var(--primary);
    }

    .story-enviar-usuarios {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 150px;
    }

    .enviar-story-usuario-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--card-bg, white);
        border: 1px solid var(--border, #eee);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .enviar-story-usuario-item:hover {
        border-color: var(--primary);
        background: var(--bg, #f5f5f5);
    }

    .enviar-story-usuario-item.enviando {
        opacity: 0.6;
        pointer-events: none;
    }

    .enviar-story-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
    }

    .enviar-story-avatar-placeholder {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #ff6b6b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
    }

    .enviar-story-info {
        flex: 1;
    }

    .enviar-story-nombre {
        font-weight: 600;
        color: var(--fg, #111);
        font-size: 14px;
    }

    .enviar-story-username {
        font-size: 12px;
        color: var(--muted, #666);
    }

    .enviar-story-btn {
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .enviar-story-btn:hover {
        opacity: 0.9;
    }

    .enviar-story-btn.enviado {
        background: #4CAF50;
    }

    .enviar-story-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--muted, #666);
        font-size: 14px;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .story-bottom-bar {
            padding: 12px;
            padding-bottom: max(12px, calc(env(safe-area-inset-bottom) + 8px));
            gap: 10px;
        }

        .story-reaction-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }

        .story-input {
            padding: 10px 60px 10px 14px;
            font-size: 14px;
        }

        .story-input-hint {
            padding: 4px 6px;
            font-size: 9px;
            right: 6px;
        }

        .story-input-hint svg {
            width: 10px;
            height: 10px;
        }

        .story-bottom-btn {
            width: 44px;
            height: 44px;
        }

        .story-bottom-btn svg {
            width: 22px;
            height: 22px;
        }
    }

    @@media (max-width: 360px) {
        .story-reaction-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }

        .story-input {
            padding: 10px 40px 10px 12px;
        }

        /* En pantallas muy pequeñas, solo mostrar el icono ↵ */
        .story-input-hint {
            padding: 4px 5px;
            font-size: 0;
            right: 5px;
        }

        .story-input-hint svg {
            width: 12px;
            height: 12px;
        }

        .story-reactions-row {
            gap: 6px;
        }

        .story-bottom-btn {
            width: 40px;
            height: 40px;
        }
    }

    /* Responsive para acciones del creador */
    @@media (max-width: 480px) {
        .story-owner-actions {
            gap: 16px;
        }

        .story-owner-action {
            min-width: 56px;
            padding: 6px;
        }

        .story-owner-action-icon {
            width: 48px;
            height: 48px;
        }

        .story-owner-action-icon svg {
            width: 22px;
            height: 22px;
        }

        .story-owner-action-label {
            font-size: 10px;
        }

        .story-views-counter {
            font-size: 13px;
            padding: 6px 14px;
        }

        .story-views-counter svg {
            width: 16px;
            height: 16px;
        }
    }

    @@media (max-width: 360px) {
        .story-owner-actions {
            gap: 12px;
        }

        .story-owner-action {
            min-width: 50px;
            padding: 4px;
        }

        .story-owner-action-icon {
            width: 44px;
            height: 44px;
        }

        .story-owner-action-icon svg {
            width: 20px;
            height: 20px;
        }

        .story-owner-action-label {
            font-size: 9px;
        }
    }

    /* ========================================
       MODAL CREAR STORY
       ======================================== */
    .create-story-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9998;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .create-story-modal.active {
        display: flex;
    }

    .create-story-container {
        background: var(--surface);
        border-radius: 12px;
        width: 100%;
        max-width: 450px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .create-story-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid var(--line);
    }

    .create-story-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
    }

    .create-story-close {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
    }

    .create-story-close:hover {
        color: var(--fg);
    }

    .create-story-body {
        padding: 20px;
        overflow-y: auto;
    }

    .create-story-upload {
        border: 2px dashed var(--line);
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 16px;
    }

    .create-story-upload:hover {
        border-color: var(--primary);
        background: rgba(70, 130, 180, 0.05);
    }

    .create-story-upload svg {
        width: 48px;
        height: 48px;
        color: var(--muted);
        margin-bottom: 12px;
    }

    .create-story-upload p {
        color: var(--muted);
        margin: 0;
        font-size: 14px;
    }

    .create-story-upload span {
        color: var(--primary);
        font-weight: 500;
    }

    .create-story-preview {
        position: relative;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px;
        display: none;
    }

    .create-story-preview.active {
        display: block;
    }

    .create-story-preview img,
    .create-story-preview video {
        width: 100%;
        max-height: 400px;
        object-fit: contain;
        background: #000;
    }

    .create-story-remove-preview {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .create-story-text {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: var(--bg);
        color: var(--fg);
        font-size: 14px;
        resize: none;
        margin-bottom: 16px;
    }

    .create-story-text:focus {
        outline: none;
        border-color: var(--primary);
    }

    .create-story-tipo {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }

    .create-story-tipo label {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        border: 2px solid var(--line);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        color: var(--muted);
    }

    .create-story-tipo input[type="radio"] {
        display: none;
    }

    .create-story-tipo input[type="radio"]:checked + label {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(70, 130, 180, 0.1);
    }

    .create-story-submit {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .create-story-submit:hover {
        background: var(--primary-hover);
    }

    .create-story-submit:disabled {
        background: #9ca3af !important;
        color: #ffffff !important;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .create-story-editor-link {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        color: var(--primary);
        background: transparent;
        border: 1px dashed var(--primary);
        border-radius: 8px;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .create-story-editor-link:hover {
        background: rgba(var(--primary-rgb), 0.1);
    }

    /* ========================================
       POST CARD
       ======================================== */
    .post {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .post-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
    }

    .post-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        text-decoration: none;
    }

    .post-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .post-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .post-user-info {
        display: flex;
        flex-direction: column;
    }

    .post-username {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    .post-header-left:hover .post-username {
        color: var(--primary);
    }

    .post-time {
        font-size: 12px;
        color: var(--muted);
    }

    .post-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 6px;
    }

    .badge-ladoa {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }

    .badge-ladob {
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
    }

    .badge-reel {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        color: white;
    }

    .badge-musica {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        padding: 0;
        margin-left: 4px;
    }

    .badge-musica img {
        width: 18px;
        height: 18px;
        object-fit: contain;
    }

    .verified-icon {
        width: 18px;
        height: 18px;
        margin-left: 4px;
        vertical-align: middle;
        flex-shrink: 0;
        display: inline-block;
        object-fit: contain;
    }

    /* Mejor definición para los badges */
    .post-username {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        flex-wrap: wrap;
    }

    .post-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Botón Seguir en header del post */
    .post-follow-btn {
        background: transparent;
        border: none;
        color: var(--primary, #4682B4);
        font-size: 13px;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: auto;
        flex-shrink: 0;
        -webkit-tap-highlight-color: transparent;
    }

    .post-follow-btn:hover {
        background: rgba(70, 130, 180, 0.1);
    }

    .post-follow-btn:active {
        transform: scale(0.95);
    }

    .post-follow-btn.following {
        color: var(--muted, #6b7280);
    }

    /* Ajustar header para acomodar el botón */
    .post-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        gap: 8px;
    }

    .post-header-right {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
    }

    .post-menu {
        padding: 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--fg);
        position: relative;
    }

    /* Post Menu Dropdown */
    .post-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 200px;
        z-index: 100;
        display: none;
        overflow: hidden;
    }

    .post-menu-dropdown.show {
        display: block;
    }

    .post-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: var(--fg);
        font-size: 14px;
        cursor: pointer;
        transition: background 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .post-menu-item:hover {
        background: var(--bg-secondary);
    }

    .post-menu-item.danger {
        color: #ed4956;
    }

    .post-menu-item.danger:hover {
        background: rgba(237, 73, 86, 0.1);
    }

    .post-menu-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .post-menu-divider {
        height: 1px;
        background: var(--line);
        margin: 4px 0;
    }

    /* POST MEDIA - aspect-ratio 4:5 para acomodar fotos verticales */
    .post-media {
        width: 100%;
        max-width: 100%;
        background: var(--bg-tertiary);
        position: relative;
        overflow: hidden;
        aspect-ratio: 4 / 5;
    }

    /* Para contenido bloqueado/censurado, forzar cuadrado */
    .post-media.locked-media {
        aspect-ratio: 1 / 1;
    }

    .post-media img {
        width: 100%;
        height: 100%;
        max-width: 100%;
        display: block;
        object-fit: contain;
    }

    .post-media video {
        width: 100%;
        height: auto; /* Altura automática según aspect ratio del video */
        max-height: 80vh; /* Máximo 80% de la pantalla */
        display: block;
        background: #000;
        cursor: pointer;
        object-fit: contain;
    }

    /* Contenedor de video se adapta al contenido */
    .post-media:has(video) {
        aspect-ratio: unset;
        height: auto;
        min-height: 200px; /* Mínimo mientras carga */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Video TikTok-style Controls */
    .post-media {
        position: relative;
    }

    .video-controls-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
    }

    /* Location Badge */
    .location-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 10;
        backdrop-filter: blur(4px);
        max-width: 70%;
        overflow: hidden;
    }

    .location-badge svg {
        width: 12px;
        height: 12px;
        flex-shrink: 0;
    }

    .location-badge span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========================================
       PREVIEW BLUR DE LADOB
       ======================================== */
    .post-media.preview-blur-wrapper {
        position: relative;
    }

    /* Efecto Blur */
    .post-media.blur-effect img,
    .post-media.blur-effect video {
        filter: blur(20px);
        transform: scale(1.1);
    }

    /* Efecto Pixelado (simulado con blur pequeño + contrast) */
    .post-media.pixelado-effect img,
    .post-media.pixelado-effect video {
        filter: blur(8px) contrast(1.2);
        image-rendering: pixelated;
    }

    /* Efecto Silueta */
    .post-media.silueta-effect img,
    .post-media.silueta-effect video {
        filter: brightness(0) blur(3px);
    }

    /* Efecto Parcial (solo borde visible) */
    .post-media.parcial-effect img,
    .post-media.parcial-effect video {
        filter: blur(15px);
        mask-image: radial-gradient(ellipse 80% 80% at center, transparent 30%, black 70%);
        -webkit-mask-image: radial-gradient(ellipse 80% 80% at center, transparent 30%, black 70%);
    }

    /* Overlay del preview blur */
    .preview-blur-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        z-index: 15;
        gap: 12px;
        text-align: center;
        padding: 20px;
    }

    .preview-blur-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-blur-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .preview-blur-text {
        color: white;
        font-size: 14px;
        font-weight: 500;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .preview-blur-subtext {
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .preview-blur-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .preview-blur-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
    }

    .preview-blur-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Badge LadoB en preview */
    .ladob-preview-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        z-index: 16;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ladob-preview-badge svg {
        width: 12px;
        height: 12px;
    }

    /* ========================================
       PULL TO REFRESH - MEJORADO PARA PWA
       ======================================== */
    .pull-to-refresh {
        position: fixed;
        /* Posición debajo del navbar - usa calc para safe-area */
        top: calc(70px + env(safe-area-inset-top, 0px));
        left: 50%;
        transform: translateX(-50%) translateY(-100%);
        z-index: 1060;
        transition: opacity 0.2s ease, transform 0.2s ease;
        opacity: 0;
        pointer-events: none;
    }

    .pull-to-refresh.visible {
        opacity: 1;
    }

    .pull-to-refresh.refreshing {
        opacity: 1;
    }

    .pull-indicator {
        background: var(--primary);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(70, 130, 180, 0.5);
        transition: transform 0.2s ease, background 0.2s ease;
    }

    .pull-indicator svg {
        width: 24px;
        height: 24px;
        color: white;
        transition: transform 0.2s ease;
    }

    .pull-to-refresh.ready .pull-indicator {
        background: #22c55e;
        transform: scale(1.15);
        box-shadow: 0 4px 25px rgba(34, 197, 94, 0.6);
    }

    .pull-to-refresh.ready .pull-indicator svg {
        transform: rotate(180deg);
    }

    .pull-to-refresh.refreshing .pull-indicator {
        background: var(--primary);
    }

    .pull-to-refresh.refreshing .pull-indicator svg {
        animation: spin 0.8s linear infinite;
    }

    /* Texto de estado del pull */
    .pull-text {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
        background: var(--bg-primary);
        padding: 4px 12px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .pull-to-refresh.visible .pull-text {
        opacity: 1;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* ========================================
       INFINITE SCROLL LOADER
       ======================================== */
    .infinite-scroll-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .infinite-scroll-loader.visible {
        opacity: 1;
    }

    .infinite-scroll-loader .loader-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .infinite-scroll-end {
        text-align: center;
        padding: 30px 0;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* Banner de nuevos posts */
    .new-posts-banner {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        z-index: 1060;
        background: var(--primary);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(70, 130, 180, 0.4);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
    }

    @@media (max-width: 768px) {
        .new-posts-banner {
            top: 70px;
        }
    }

    @@media (max-width: 576px) {
        .new-posts-banner {
            top: 60px;
            padding: 10px 18px;
            font-size: 13px;
        }
    }

    .new-posts-banner.visible {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .new-posts-banner:hover {
        background: var(--primary-hover);
        box-shadow: 0 6px 20px rgba(70, 130, 180, 0.5);
    }

    .new-posts-banner svg {
        width: 18px;
        height: 18px;
    }

    /* Skeleton loading para posts */
    .post-skeleton {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .post-skeleton .skeleton-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
    }

    .post-skeleton .skeleton-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .post-skeleton .skeleton-text {
        flex: 1;
    }

    .post-skeleton .skeleton-line {
        height: 12px;
        border-radius: 4px;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .post-skeleton .skeleton-line.short {
        width: 60%;
        margin-top: 6px;
    }

    .post-skeleton .skeleton-media {
        width: 100%;
        padding-top: 100%;
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @@keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .video-play-icon {
        width: 64px;
        height: 64px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease, transform 0.15s ease;
        pointer-events: auto; /* Habilitado para click → fullview */
        cursor: pointer;
        z-index: 10;
    }

    .video-play-icon:active {
        transform: scale(0.92);
    }

    .video-play-icon svg {
        width: 32px;
        height: 32px;
    }

    /* Icono de play (triangulo) - centrado con margin-left */
    .video-play-icon .icon-play {
        margin-left: 4px;
    }

    /* Icono de pausa - oculto por defecto, solo visible en .video-playing */
    .video-play-icon .icon-pause {
        display: none;
    }
    .video-playing .video-play-icon .icon-play {
        display: none;
    }
    .video-playing .video-play-icon .icon-pause {
        display: block;
    }

    /* REGLA SIMPLE: Icono solo visible cuando video esta PAUSADO */
    .video-paused .video-play-icon {
        opacity: 1;
    }

    /* Video reproduciendose: icono SIEMPRE oculto */
    .video-playing .video-play-icon {
        opacity: 0 !important;
    }

    /* Desktop: mostrar icono en hover para indicar que se puede pausar */
    @@media (hover: hover) and (pointer: fine) {
        .video-playing:hover .video-play-icon {
            opacity: 0.8 !important;
        }
    }

    /* Video loading spinner */
    .video-loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        margin: -20px 0 0 -20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: videoSpin 0.8s linear infinite;
        z-index: 20;
    }

    @@keyframes videoSpin {
        to { transform: rotate(360deg); }
    }

    /* Video error - mostrar icono de reintento */
    .video-error::before {
        content: '\f01e'; /* fa-refresh */
        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome;
        font-weight: 900;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 32px;
        color: rgba(255, 255, 255, 0.7);
        z-index: 20;
        cursor: pointer;
    }

    .video-error::after {
        content: 'Toca para reintentar';
        position: absolute;
        top: calc(50% + 30px);
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        z-index: 20;
        white-space: nowrap;
    }

    /* iOS: Indicador visual de que requiere tap para reproducir */
    .post-media.needs-tap::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        z-index: 15;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 40px;
        animation: tapPulse 2s infinite;
    }

    @@keyframes tapPulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    }

    /* MOVIL/iOS: Ocultar icono completamente - solo tap para play/pause */
    @@media (hover: none) and (pointer: coarse) {
        .video-play-icon {
            display: none !important;
        }
    }

    .video-mute-btn {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
        z-index: 10;
    }

    .video-mute-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .video-mute-btn svg {
        width: 20px;
        height: 20px;
    }

    /* Botón mute para música de foto */
    .photo-music-mute-btn {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
        z-index: 10;
    }

    .photo-music-mute-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .photo-music-mute-btn svg {
        width: 20px;
        height: 20px;
    }

    .feed-video {
        object-fit: contain;
        max-height: 600px;
        background-color: #000;
        /* iOS fix: forzar GPU rendering */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }

    /* iOS Safari: fix para videos que se ven negros o no reproducen */
    @@supports (-webkit-touch-callout: none) {
        .feed-video {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
            /* iOS necesita esto para renderizar correctamente */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        .post-media video {
            opacity: 1 !important;
            visibility: visible !important;
            /* Forzar que iOS muestre el video */
            background: transparent !important;
        }

        /* Forzar que los videos del fullscreen se muestren en iOS */
        .fullscreen-slide video {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
            opacity: 1 !important;
            visibility: visible !important;
        }
    }

    .post-media-audio {
        padding: 32px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--surface) 100%);
        position: relative;
        min-height: 180px;
    }

    .post-media-audio .audio-visual {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    .post-media-audio .audio-icon {
        width: 48px;
        height: 48px;
    }

    .post-media-audio .audio-waves {
        display: flex;
        align-items: center;
        gap: 3px;
        height: 24px;
    }

    .post-media-audio .audio-waves span {
        width: 4px;
        height: 8px;
        background: var(--primary);
        border-radius: 2px;
        opacity: 0.4;
    }

    .post-media-audio.playing .audio-waves span {
        animation: audioWave 0.8s ease-in-out infinite;
        opacity: 1;
    }

    .post-media-audio.playing .audio-waves span:nth-child(1) { animation-delay: 0s; }
    .post-media-audio.playing .audio-waves span:nth-child(2) { animation-delay: 0.1s; }
    .post-media-audio.playing .audio-waves span:nth-child(3) { animation-delay: 0.2s; }
    .post-media-audio.playing .audio-waves span:nth-child(4) { animation-delay: 0.3s; }
    .post-media-audio.playing .audio-waves span:nth-child(5) { animation-delay: 0.4s; }

    @@keyframes audioWave {
        0%, 100% { height: 8px; }
        50% { height: 24px; }
    }

    .post-media-audio .post-audio-player {
        display: none;
    }

    .post-media-audio .audio-controls-overlay {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .post-media-audio .audio-play-btn,
    .post-media-audio .audio-mute-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .post-media-audio .audio-play-btn {
        background: var(--primary);
    }

    .post-media-audio .audio-play-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.4);
    }

    .post-media-audio .audio-mute-btn {
        background: rgba(255,255,255,0.2);
    }

    .post-media-audio .audio-mute-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .post-media-audio .audio-play-btn svg,
    .post-media-audio .audio-mute-btn svg {
        width: 24px;
        height: 24px;
    }

    .post-media-audio .audio-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: rgba(255,255,255,0.2);
    }

    .post-media-audio .audio-progress-bar {
        height: 100%;
        width: 0%;
        background: var(--primary);
        transition: width 0.1s linear;
    }

    .post-text-content {
        padding: 32px 24px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--surface) 100%);
        font-size: 18px;
        line-height: 1.6;
        color: var(--fg);
        text-align: center;
    }

    /* POST ACTIONS */
    .post-actions {
        padding: 12px 16px 0;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        margin: -8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--fg);
        transition: transform 0.1s ease;
    }

    .action-btn:hover {
        opacity: 0.7;
    }

    .action-btn:active {
        transform: scale(0.9);
    }

    .action-btn svg {
        width: 24px;
        height: 24px;
    }

    .action-btn.liked svg {
        fill: #ed4956;
        stroke: #ed4956;
    }

    .action-btn.bookmarked svg {
        fill: var(--fg);
        stroke: var(--fg);
    }

    .action-spacer {
        flex: 1;
    }

    /* LIKES COUNT */
    .post-likes {
        padding: 0 16px;
        margin-top: 8px;
    }

    .post-likes-count {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    /* CAPTION */
    .post-caption {
        padding: 8px 16px;
    }

    .post-caption-text {
        font-size: 14px;
        line-height: 1.4;
        color: var(--fg);
    }

    .post-caption-username {
        font-weight: 600;
        margin-right: 6px;
    }

    /* COMMENTS PREVIEW */
    .post-comments-preview {
        padding: 0 16px 8px;
    }

    .view-all-comments {
        font-size: 14px;
        color: var(--muted);
        cursor: pointer;
        margin-bottom: 8px;
    }

    .view-all-comments:hover {
        text-decoration: underline;
    }

    /* ========================================
       COMENTARIOS ESTILO INSTAGRAM - FEED
       ======================================== */

    .feed-comment-item {
        display: flex;
        gap: 10px;
        padding: 8px 0;
    }

    .feed-comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: var(--hover);
    }

    .feed-comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .feed-comment-avatar-initial {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 12px;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        color: white;
    }

    .feed-comment-content {
        flex: 1;
        min-width: 0;
    }

    .feed-comment-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 2px;
    }

    .feed-comment-username {
        font-size: 13px;
        font-weight: 600;
        color: var(--fg);
        text-decoration: none;
    }

    .feed-comment-username:hover {
        text-decoration: underline;
    }

    .feed-comment-time {
        font-size: 12px;
        color: var(--muted);
    }

    .feed-comment-text {
        font-size: 14px;
        line-height: 1.4;
        color: var(--fg);
        margin-bottom: 4px;
        word-wrap: break-word;
    }

    /* Comentarios preview (agregados via JS) */
    .comment-preview {
        font-size: 14px;
        line-height: 1.4;
        padding: 4px 0;
    }

    .comment-preview-username {
        font-weight: 600;
        color: var(--fg);
    }

    .comment-preview-text {
        color: var(--fg);
    }

    .feed-comment-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .feed-comment-action-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        transition: all 0.2s;
    }

    .feed-comment-action-btn:hover {
        color: var(--fg);
    }

    .feed-comment-action-btn svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
    }

    .feed-comment-action-btn.like-btn svg.liked {
        fill: #ed4956;
        stroke: #ed4956;
    }

    .feed-comment-action-btn .count {
        font-weight: 500;
    }

    @@keyframes feedHeartPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    .feed-comment-action-btn svg.liked {
        animation: feedHeartPop 0.3s ease-out;
    }

    /* Respuestas mini */
    .feed-show-replies {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 0 4px 42px;
        cursor: pointer;
    }

    .feed-show-replies:hover span {
        text-decoration: underline;
    }

    .feed-reply-avatars {
        display: flex;
    }

    .feed-reply-avatars img {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--bg);
        margin-left: -6px;
        object-fit: cover;
    }

    .feed-reply-avatars img:first-child {
        margin-left: 0;
    }

    .feed-show-replies span {
        font-size: 12px;
        color: var(--muted);
        font-weight: 500;
    }

    /* ADD COMMENT */
    .post-add-comment {
        border-top: 1px solid var(--line);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 14px;
        color: var(--fg);
        outline: none;
    }

    .comment-input::placeholder {
        color: var(--muted);
    }

    .comment-post-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
    }

    .comment-post-btn:not(:disabled) {
        opacity: 1;
    }

    .comment-post-btn:disabled {
        cursor: not-allowed;
    }

    /* POST TIMESTAMP */
    .post-timestamp {
        padding: 0 16px 12px;
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    /* SHARE MODAL - Estilo Instagram */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1100;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .modal-overlay.active {
        display: flex;
    }

    .share-modal {
        background: var(--surface);
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        height: 70vh;
        max-height: 600px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: shareModalFadeIn 0.2s ease-out;
    }

    @@keyframes shareModalFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    .share-modal-handle {
        display: none;
    }

    .share-modal-header {
        padding: 16px;
        text-align: center;
        font-weight: 700;
        font-size: 16px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--line);
        flex-shrink: 0;
    }

    .share-modal-close {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--fg);
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.15s;
        font-weight: 300;
        z-index: 10;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }

    .share-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .share-modal-close:active {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Buscador */
    .share-search-box {
        padding: 12px 16px;
        flex-shrink: 0;
    }

    .share-search-input {
        width: 100%;
        background: var(--bg);
        border: none;
        border-radius: 10px;
        padding: 12px 16px 12px 42px;
        font-size: 15px;
        color: var(--fg);
        outline: none;
        box-sizing: border-box;
    }

    .share-search-input::placeholder {
        color: var(--muted);
    }

    .share-search-wrapper {
        position: relative;
    }

    .share-search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
    }

    /* Grid de contactos - 4 columnas */
    .share-contacts-grid {
        flex: 1;
        overflow-y: auto;
        padding: 8px 12px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        align-content: start;
    }

    .share-contacts-grid::-webkit-scrollbar {
        width: 6px;
    }

    .share-contacts-grid::-webkit-scrollbar-thumb {
        background: var(--line);
        border-radius: 3px;
    }

    .share-contact-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 12px 4px;
        border-radius: 12px;
        transition: background 0.15s;
    }

    .share-contact-item:hover {
        background: var(--bg);
    }

    .share-contact-item.selected {
        background: rgba(70, 130, 180, 0.15);
    }

    .share-contact-item.selected .share-contact-avatar {
        border-color: var(--primary);
    }

    .share-contact-avatar {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        object-fit: cover;
        background: linear-gradient(135deg, var(--line) 0%, var(--bg) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 22px;
        color: var(--muted);
        border: 3px solid transparent;
        transition: border-color 0.15s;
    }

    .share-contact-name {
        font-size: 12px;
        color: var(--fg);
        text-align: center;
        width: 100%;
        max-width: 80px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
    }

    .share-contacts-empty {
        grid-column: 1 / -1;
        text-align: center;
        color: var(--muted);
        padding: 40px 20px;
        font-size: 14px;
    }

    /* Barra inferior de apps */
    .share-apps-bar {
        border-top: 1px solid var(--line);
        padding: 12px 8px;
        flex-shrink: 0;
        display: flex;
        overflow-x: auto;
        gap: 4px;
        scrollbar-width: none;
    }

    .share-apps-bar::-webkit-scrollbar {
        display: none;
    }

    .share-app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 10px;
        transition: background 0.15s, transform 0.1s;
        min-width: 64px;
        flex-shrink: 0;
        text-decoration: none;
    }

    .share-app-item:hover {
        background: var(--bg);
    }

    .share-app-item:active {
        transform: scale(0.95);
    }

    .share-app-item.disabled {
        opacity: 0.35;
        pointer-events: none;
    }

    .share-app-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .share-app-icon.link { background: var(--line); color: var(--fg); }
    .share-app-icon.story { background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); }
    .share-app-icon.whatsapp { background: #25D366; }
    .share-app-icon.telegram { background: #2AABEE; }
    .share-app-icon.email { background: var(--line); color: var(--fg); }
    .share-app-icon.twitter { background: #000; }

    .share-app-label {
        font-size: 11px;
        color: var(--fg);
        text-align: center;
        white-space: nowrap;
    }

    /* Mensaje de restricción */
    .share-restriction-msg {
        display: none;
        padding: 8px 16px;
        background: rgba(255, 193, 7, 0.1);
        font-size: 12px;
        color: #f0a500;
        text-align: center;
        flex-shrink: 0;
    }

    .share-restriction-msg.visible {
        display: block;
    }

    /* Ocultar elementos legacy */
    #shareMainView, .share-options-grid, .share-link-section, .share-recent-section {
        display: none !important;
    }

    /* Friends Panel en Share Modal */
    .share-friends-panel {
        display: none;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .share-friends-panel.active {
        display: flex;
    }

    .friends-panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        flex-shrink: 0;
    }

    .friends-panel-back {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--fg);
        transition: background 0.15s;
    }

    .friends-panel-back:hover {
        background: var(--line);
    }

    .friends-panel-title {
        font-weight: 600;
        font-size: 16px;
        color: var(--fg);
    }

    .friends-search {
        padding: 12px 16px;
        flex-shrink: 0;
    }

    .friends-search input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--line);
        border-radius: 24px;
        font-size: 14px;
        background: var(--bg);
        color: var(--fg);
        box-sizing: border-box;
    }

    .friends-search input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .friends-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 8px 12px;
    }

    .friend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 8px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .friend-item:hover {
        background: var(--bg);
    }

    .friend-item.selected {
        background: rgba(70, 130, 180, 0.12);
    }

    .friend-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--line);
    }

    .friend-info {
        flex: 1;
        min-width: 0;
    }

    .friend-name {
        font-weight: 500;
        font-size: 14px;
        color: var(--fg);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .friend-username {
        font-size: 13px;
        color: var(--muted);
    }

    .friend-check {
        width: 24px;
        height: 24px;
        border: 2px solid var(--line);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
    }

    .friend-item.selected .friend-check {
        background: var(--primary);
        border-color: var(--primary);
    }

    .friend-check svg {
        display: none;
        color: white;
    }

    .friend-item.selected .friend-check svg {
        display: block;
    }

    .friends-empty {
        text-align: center;
        padding: 32px 16px;
        color: var(--muted);
        font-size: 14px;
    }

    .friends-loading {
        text-align: center;
        padding: 32px 16px;
        color: var(--muted);
    }

    .send-friends-btn {
        margin: 0 16px 16px;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: calc(100% - 32px);
        transition: all 0.15s;
    }

    .send-friends-btn:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .send-friends-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Share Modal - Responsive */
    @@media (max-width: 600px) {
        .modal-overlay {
            padding: 0;
            align-items: flex-end;
        }

        .share-modal {
            max-width: 100%;
            height: auto;
            max-height: 70vh;
            margin-bottom: calc(64px + env(safe-area-inset-bottom, 0px));
            border-radius: 16px 16px 0 0;
            animation: shareModalSlideUp 0.25s ease-out;
        }

        @@keyframes shareModalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .share-modal-header {
            padding: 14px 16px;
        }

        .share-search-box {
            padding: 8px 12px;
        }

        .share-contacts-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 4px 8px;
        }

        .share-contact-item {
            padding: 8px 2px;
        }

        .share-contact-avatar {
            width: 56px;
            height: 56px;
            font-size: 18px;
        }

        .share-contact-name {
            font-size: 11px;
            max-width: 70px;
        }

        .share-apps-bar {
            padding: 10px 4px 16px 4px;
            gap: 2px;
        }

        .share-app-item {
            padding: 6px 8px;
            min-width: 56px;
        }

        .share-app-icon {
            width: 40px;
            height: 40px;
        }

        .share-app-label {
            font-size: 10px;
        }
    }

    @@media (max-width: 380px) {
        .share-contacts-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .share-contact-avatar {
            width: 60px;
            height: 60px;
        }
    }


    /* ========================================
       ANUNCIO EN FEED (ESTILO POST)
       ======================================== */
    .post-ad {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .post-ad-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        gap: 12px;
    }

    .post-ad-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .post-ad-icon svg {
        width: 20px;
        height: 20px;
    }

    .post-ad-info {
        flex: 1;
    }

    .post-ad-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
    }

    .post-ad-badge {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .post-ad-badge i {
        font-size: 10px;
    }

    .post-ad-media {
        position: relative;
        overflow: hidden;
        cursor: pointer;
        display: block;
        background: #f8f9fa;
    }

    .post-ad-media img,
    .post-ad-media video {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.3s ease;
    }

    .post-ad:hover .post-ad-media img,
    .post-ad:hover .post-ad-media video {
        transform: scale(1.02);
    }

    .post-ad-content {
        padding: 14px 16px;
    }

    .post-ad-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        width: 100%;
    }

    .post-ad-cta:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .post-ad-cta i {
        font-size: 12px;
    }

    /* Botón de sonido para video ads */
    .ad-sound-toggle {
        position: absolute;
        bottom: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(0,0,0,0.6);
        border: none;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: background 0.2s, transform 0.2s;
    }

    .ad-sound-toggle:hover {
        background: rgba(0,0,0,0.8);
        transform: scale(1.1);
    }

    .ad-sound-toggle i {
        font-size: 16px;
    }

    .ad-sound-toggle.unmuted {
        background: var(--primary);
    }

    /* EMPTY STATE */
    .empty-feed {
        text-align: center;
        padding: 60px 20px;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
    }

    .empty-feed h3 {
        font-size: 20px;
        margin-bottom: 8px;
    }

    .empty-feed p {
        color: var(--muted);
        margin-bottom: 20px;
    }

    .empty-feed-btn {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
    }

    /* ========================================
       SIDEBAR
       ======================================== */
    .sidebar-section {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .sidebar-user {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .sidebar-user-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
    }

    .sidebar-user-avatar-placeholder {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
    }

    .sidebar-user-info {
        flex: 1;
    }

    .sidebar-user-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--fg);
    }

    .sidebar-user-username {
        font-size: 14px;
        color: var(--muted);
    }

    .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .sidebar-title {
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
    }

    .sidebar-see-all {
        font-size: 12px;
        color: var(--fg);
        font-weight: 600;
        text-decoration: none;
    }

    .sidebar-see-all:hover {
        text-decoration: underline;
    }

    /* ========================================
       CREADORES SUGERIDOS - Cards verticales con paginación
       ======================================== */
    .suggestions-section {
        background: var(--bg);
        border-radius: 16px;
        padding: 20px;
    }

    .suggestions-section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--fg);
        margin-bottom: 16px;
    }

    .suggestions-pages-wrap {
        position: relative;
        overflow: hidden;
    }

    .suggestions-page {
        display: none;
        flex-direction: column;
        gap: 10px;
    }

    .suggestions-page.is-active {
        display: flex;
    }

    /* Card = toda la imagen con overlays */
    .suggestion-card {
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        transition: transform 0.25s, opacity 0.25s;
    }

    .suggestion-card.is-dismissing {
        transform: scale(0.85);
        opacity: 0;
    }

    .suggestion-card.is-removing {
        max-height: 0;
        margin: 0;
        overflow: hidden;
        transition: max-height 0.3s, margin 0.3s;
    }

    /* Cover = toda la card */
    .suggestion-card-cover {
        position: relative;
        height: 180px;
        background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .suggestion-card-cover > img.suggestion-card-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
    }

    /* Gradient fuerte en la parte inferior para legibilidad */
    .suggestion-card-cover::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.25) 50%, transparent 100%);
        pointer-events: none;
        z-index: 1;
    }

    /* Avatar dentro del cover, abajo-izquierda, encima del texto */
    .suggestion-card-avatar-wrap {
        position: absolute;
        bottom: 60px;
        left: 14px;
        z-index: 3;
    }

    .suggestion-card-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255,255,255,0.3);
        background: var(--bg);
    }

    .suggestion-card-avatar-placeholder {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary);
        border: 3px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
    }

    .suggestion-card-activity {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #22c55e;
        border: 2px solid rgba(0,0,0,0.5);
        z-index: 4;
    }

    /* Botón Seguir - pill blanco, alineado con nombre a la derecha */
    .suggestion-card-follow {
        position: absolute;
        bottom: 18px;
        right: 14px;
        z-index: 3;
        padding: 8px 22px;
        border: none;
        border-radius: 20px;
        background: #fff;
        color: #111;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s, background 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .suggestion-card-follow:hover {
        background: #f0f0f0;
    }

    .suggestion-card-follow:active {
        transform: scale(0.95);
    }

    .suggestion-card-follow.is-following {
        background: rgba(255,255,255,0.2);
        color: white;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    /* Nombre y username SOBRE el cover (abajo) */
    .suggestion-card-info {
        position: relative;
        z-index: 2;
        padding: 4px 14px 12px 14px;
    }

    .suggestion-card-name {
        font-size: 16px;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-decoration: none;
        display: block;
        line-height: 1.3;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .suggestion-card-name:hover {
        opacity: 0.85;
    }

    .suggestion-card-username {
        font-size: 13px;
        color: rgba(255,255,255,0.7);
        margin-top: 1px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    /* Dismiss button */
    .suggestion-card-dismiss {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: rgba(0,0,0,0.45);
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 4;
        line-height: 1;
        padding: 0;
    }

    .suggestion-card:hover .suggestion-card-dismiss {
        opacity: 1;
    }

    @@media (hover: none) {
        .suggestion-card-dismiss {
            opacity: 0.8;
        }
    }

    /* Paginación: flechas + dots */
    .suggestions-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 16px;
        padding: 0 4px;
    }

    .suggestions-nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--line);
        background: var(--surface);
        color: var(--fg);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, border-color 0.2s;
    }

    .suggestions-nav-btn:hover {
        background: var(--bg);
        border-color: var(--muted);
    }

    .suggestions-nav-btn:disabled {
        opacity: 0.3;
        cursor: default;
    }

    .suggestions-nav-btn svg {
        width: 16px;
        height: 16px;
    }

    .suggestions-dots {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .suggestions-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--line);
        transition: background 0.2s, transform 0.2s;
    }

    .suggestions-dot.is-active {
        background: var(--fg);
        transform: scale(1.2);
    }

    /* Mobile inline suggestions (entre posts) */
    .suggestions-inline-mobile {
        display: none;
        margin: 16px 0;
    }

    @@media (max-width: 960px) {
        .suggestions-inline-mobile {
            display: block;
        }
    }

    .sidebar-footer {
        margin-top: 24px;
        font-size: 11px;
        color: var(--muted);
    }

    .sidebar-footer a {
        color: var(--muted);
        text-decoration: none;
    }

    .sidebar-footer a:hover {
        text-decoration: underline;
    }

    /* RESPONSIVE */
    @@media (max-width: 960px) {
        .feed-page-layout {
            grid-template-columns: 1fr;
            max-width: 630px;
        }

        .feed-sidebar {
            display: none;
        }
    }

    @@media (max-width: 640px) {
        .feed-page-layout {
            padding: 0;
        }

        .stories-bar,
        .post {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        .post {
            margin-bottom: 8px;
        }
    }

    /* ========================================
       CONTENIDO BLOQUEADO - BLUR Y CANDADO
       ======================================== */
    .locked-content-wrapper {
        position: relative;
        cursor: pointer;
        overflow: hidden;
    }

    .locked-content-wrapper .post-media img,
    .locked-content-wrapper .post-media video,
    .locked-content-wrapper .post-text-content {
        filter: blur(20px);
        transform: scale(1.1);
        pointer-events: none;
    }

    .locked-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10;
    }

    .locked-icon {
        width: 64px;
        height: 64px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .locked-icon svg {
        width: 32px;
        height: 32px;
        color: #FFC400;
    }

    .locked-text {
        color: white;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        padding: 0 20px;
    }

    .locked-subscribe-btn {
        margin-top: 16px;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4);
    }

    .locked-subscribe-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 24px rgba(168, 85, 247, 0.5);
    }

    .locked-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 11;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .locked-badge svg {
        width: 12px;
        height: 12px;
    }

    /* Modal de suscripcion */
    .subscribe-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .subscribe-modal.active {
        display: flex;
    }

    .subscribe-modal-content {
        background: var(--surface);
        border-radius: 16px;
        max-width: 420px;
        width: 90%;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
    }

    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .subscribe-modal-header {
        position: relative;
        padding: 24px;
        text-align: center;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
    }

    .subscribe-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s;
    }

    .subscribe-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .subscribe-modal-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        margin-bottom: 12px;
    }

    .subscribe-modal-avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        margin: 0 auto 12px;
    }

    .subscribe-modal-name {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .subscribe-modal-username {
        font-size: 14px;
        opacity: 0.9;
    }

    .subscribe-modal-body {
        padding: 24px;
        text-align: center;
    }

    .subscribe-modal-body h4 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--fg);
    }

    .subscribe-modal-body p {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .subscribe-modal-price {
        font-size: 28px;
        font-weight: 700;
        color: var(--fg);
        margin-bottom: 4px;
    }

    .subscribe-modal-price-label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 20px;
    }

    .subscribe-modal-btn {
        width: 100%;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .subscribe-modal-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }

    .subscribe-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--line);
        text-align: center;
    }

    .subscribe-modal-footer a {
        color: var(--primary);
        font-size: 14px;
        text-decoration: none;
        font-weight: 500;
    }

    .subscribe-modal-footer a:hover {
        text-decoration: underline;
    }

    /* ========================================
       FULLSCREEN MODE - Ocultar header y sidebar
       ======================================== */
    body.fullscreen-mode .top-navbar,
    body.fullscreen-mode .sidebar,
    body.fullscreen-mode .sidebar-overlay,
    body.fullscreen-mode header,
    body.fullscreen-mode nav {
        display: none !important;
    }

    body.fullscreen-mode {
        overflow: hidden !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body.fullscreen-mode .main-content,
    body.fullscreen-mode .feed-page-layout {
        margin: 0 !important;
        padding: 0 !important;
        padding-bottom: 0 !important;
    }

    /* ========================================
       FULLSCREEN MEDIA VIEWER (TikTok-style)
       ======================================== */

    /* Forzar fondo negro en todo el documento cuando fullscreen está activo */
    html.fullscreen-active,
    body.fullscreen-active,
    html:has(.fullscreen-viewer.active),
    html:has(body.fullscreen-active) {
        background: #000 !important;
        background-color: #000 !important;
        overflow: hidden !important;
    }

    .fullscreen-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* Fondo negro sólido */
        background: #000;
        background-color: #000;
        z-index: 1100;
        overflow: hidden;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        /* iOS: Asegurar que cubra todo incluyendo safe-area */
        min-height: 100vh;
        min-height: 100dvh;
        min-height: -webkit-fill-available;
    }

    .fullscreen-viewer.active {
        display: block;
    }

    /* Ocultar TODOS los elementos de navegación cuando fullscreen está activo */
    body.fullscreen-active .bottom-nav,
    body.fullscreen-active #bottomNav,
    body.fullscreen-active .top-navbar,
    body.fullscreen-active #topNavbar,
    body.fullscreen-active .sidebar,
    body.fullscreen-active .navbar,
    body.fullscreen-active nav:not(.fullscreen-nav-arrows) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        z-index: -1 !important;
    }

    /* Evitar espacio blanco en iOS */
    .fullscreen-viewer,
    .fullscreen-viewer * {
        box-sizing: border-box;
    }

    /* iOS: Pseudo-elemento para cubrir safe-area inferior con negro */
    .fullscreen-viewer::before {
        content: '';
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        /* Altura generosa para cubrir cualquier safe-area */
        height: calc(env(safe-area-inset-bottom, 0px) + 50px);
        background: #000;
        z-index: -1; /* Negativo para estar DETRÁS del contenido */
        pointer-events: none;
    }

    /* iOS Safari: NO agregar padding al slide, solo ajustar elementos UI */
    /* El slide debe ocupar 100% sin padding para evitar desplazamiento */

    .fullscreen-viewer-close {
        position: fixed;
        /* iOS: Posicionar debajo del botón de mute (alineado en columna derecha) */
        top: max(74px, calc(env(safe-area-inset-top, 0) + 64px));
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1101; /* Reducido - relativo al viewer */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .fullscreen-viewer-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .fullscreen-viewer-close svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .fullscreen-slides-container {
        /* Cubrir todo el viewer incluyendo safe-area */
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        overflow-y: scroll;
        overflow-x: hidden;
        scroll-snap-type: y mandatory; /* mandatory para snap obligatorio estilo TikTok */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        overscroll-behavior-y: contain;
        /* Eliminar espacio blanco */
        margin: 0;
        padding: 0;
        background: #000;
    }

    .fullscreen-slides-container::-webkit-scrollbar {
        display: none;
    }

    .fullscreen-slide {
        width: 100%;
        /* Cascada de fallbacks para altura del viewport:
           1. --vh-full (calculado por JS con window.innerHeight)
           2. 100dvh (iOS Safari 15.4+)
           3. 100vh (fallback final) */
        height: 100vh;
        height: 100dvh;
        height: var(--vh-full, 100dvh);
        min-height: 100vh;
        min-height: 100dvh;
        min-height: var(--vh-full, 100dvh);
        scroll-snap-align: start;
        scroll-snap-stop: always;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #000;
        flex-shrink: 0;
    }

    .fullscreen-slide img,
    .fullscreen-slide video {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain; /* Mostrar completo sin recortar */
        user-select: none;
        -webkit-user-drag: none;
        -webkit-touch-callout: none; /* iOS: evitar menú contextual */
        margin: auto; /* Centrar la imagen */
    }

    .fullscreen-slide video {
        background: #000;
    }

    /* 🍎 iOS: Indicador de tap-to-play cuando autoplay falla */
    .fullscreen-slide.needs-tap::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        pointer-events: none;
        animation: tapPulse 1.5s ease-in-out 4; /* Limitado a 4 ciclos (6s) */
    }

    .fullscreen-slide.needs-tap::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 15px 0 15px 25px;
        border-color: transparent transparent transparent white;
        z-index: 11;
        pointer-events: none;
        margin-left: 4px;
    }

    @@keyframes tapPulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    }

    /* ========================================
       CARRUSEL DENTRO DEL FULLSCREEN
       ======================================== */
    .fullscreen-slide.has-carousel {
        padding: 0;
        /* Permitir que Swiper maneje swipes horizontales */
        touch-action: pan-y pinch-zoom;
        overscroll-behavior-x: contain;
    }

    /* Cuando se está haciendo swipe horizontal en carrusel, desactivar scroll snap del contenedor */
    .fullscreen-slides-container.carousel-swiping {
        scroll-snap-type: none !important;
        overflow-y: hidden !important;
    }

    .fs-carousel-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fs-carousel-slides {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .fs-carousel-item {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .fs-carousel-item.active {
        display: flex;
    }

    .fs-carousel-item img,
    .fs-carousel-item video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .fs-carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
    }

    .fs-carousel-nav:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .fs-carousel-nav svg {
        width: 28px;
        height: 28px;
    }

    .fs-carousel-prev {
        left: 20px;
    }

    .fs-carousel-next {
        right: 20px;
    }

    .fs-carousel-dots {
        position: absolute;
        bottom: 95px; /* Subido para no ser tapado por créditos del usuario */
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .fs-carousel-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        transition: all 0.2s;
    }

    .fs-carousel-dot:hover {
        background: rgba(255, 255, 255, 0.7);
    }

    .fs-carousel-dot.active {
        background: white;
        transform: scale(1.3);
    }

    .fs-carousel-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 500;
        z-index: 10;
    }

    /* Responsive carrusel fullscreen */
    @@media (max-width: 768px) {
        .fs-carousel-nav {
            width: 40px;
            height: 40px;
        }

        .fs-carousel-prev {
            left: 10px;
        }

        .fs-carousel-next {
            right: 10px;
        }

        .fs-carousel-dots {
            bottom: 85px; /* Subido para no ser tapado por créditos */
        }

        .fs-carousel-counter {
            top: 15px;
            right: 15px;
            font-size: 12px;
        }

        /* MÓVIL: Forzar fondos negros en fullscreen para evitar franjas blancas */
        .fullscreen-viewer,
        .fullscreen-slides-container,
        .fullscreen-slide {
            background: #000 !important;
            background-color: #000 !important;
        }

        /* MÓVIL: Asegurar que el body tenga fondo negro cuando fullscreen activo */
        body.fullscreen-active {
            background: #000 !important;
            background-color: #000 !important;
            overflow: hidden !important;
        }
    }

    /* Desktop - carrusel más grande */
    @@media (min-width: 992px) {
        .fs-carousel-item img,
        .fs-carousel-item video {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
    }

    /* ========================================
       SWIPER.JS - Carrusel Fullscreen iOS-Compatible
       ======================================== */
    .fs-swiper-carousel {
        width: 100%;
        height: 100%;
        position: relative;
        /* Permitir swipe horizontal (Swiper) mientras vertical pasa al contenedor padre */
        touch-action: pan-y pinch-zoom;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        /* Aislar del scroll snap del padre */
        scroll-snap-type: none;
        overscroll-behavior: contain;
        overscroll-behavior-x: contain;
        /* Forzar contexto de stacking */
        isolation: isolate;
        z-index: 5;
    }

    .fs-swiper-carousel .swiper-wrapper {
        align-items: center;
        touch-action: pan-y;
    }

    .fs-swiper-carousel .swiper-slide {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        touch-action: pan-y;
    }

    .fs-swiper-carousel .swiper-slide img,
    .fs-swiper-carousel .swiper-slide video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        user-select: none;
        -webkit-user-drag: none;
        -webkit-touch-callout: none;
    }

    /* Botones de navegación Swiper - Mejorados para visibilidad */
    .fs-swiper-carousel .swiper-button-next,
    .fs-swiper-carousel .swiper-button-prev {
        color: white;
        background: rgba(0, 0, 0, 0.6);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        transition: all 0.2s ease;
        z-index: 100;
        opacity: 0;
        pointer-events: auto;
    }

    /* Mostrar botones en hover del carrusel */
    .fs-swiper-carousel:hover .swiper-button-next,
    .fs-swiper-carousel:hover .swiper-button-prev {
        opacity: 1;
    }

    /* En móvil siempre visibles si hay más de 1 slide */
    @@media (max-width: 768px) {
        .fs-swiper-carousel .swiper-button-next,
        .fs-swiper-carousel .swiper-button-prev {
            opacity: 1 !important;
            width: 40px;
            height: 40px;
            display: flex !important;
        }

        .fs-swiper-carousel .swiper-button-disabled {
            opacity: 0.3 !important;
        }
    }

    .fs-swiper-carousel .swiper-button-next:after,
    .fs-swiper-carousel .swiper-button-prev:after {
        font-size: 18px;
        font-weight: bold;
    }

    .fs-swiper-carousel .swiper-button-next:hover,
    .fs-swiper-carousel .swiper-button-prev:hover {
        background: rgba(0, 0, 0, 0.85);
        transform: scale(1.1);
        opacity: 1;
    }

    .fs-swiper-carousel .swiper-button-next:active,
    .fs-swiper-carousel .swiper-button-prev:active {
        transform: scale(0.95);
    }

    .fs-swiper-carousel .swiper-button-disabled {
        opacity: 0.2 !important;
        pointer-events: none;
    }

    /* Posicionamiento más hacia adentro en móvil */
    .fs-swiper-carousel .swiper-button-prev {
        left: 12px;
    }

    .fs-swiper-carousel .swiper-button-next {
        right: 12px;
    }

    /* Áreas clickables para navegación (desktop) */
    @@media (min-width: 769px) {
        .fs-swiper-carousel::before,
        .fs-swiper-carousel::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 25%;
            z-index: 5;
            cursor: pointer;
            pointer-events: none; /* Los clicks pasan al handler JS */
        }

        .fs-swiper-carousel::before {
            left: 0;
            background: linear-gradient(90deg, rgba(0,0,0,0.03) 0%, transparent 100%);
        }

        .fs-swiper-carousel::after {
            right: 0;
            background: linear-gradient(-90deg, rgba(0,0,0,0.03) 0%, transparent 100%);
        }

        .fs-swiper-carousel:hover::before,
        .fs-swiper-carousel:hover::after {
            background: linear-gradient(90deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }
    }

    /* Paginación (bullets) - Posicionada encima de los créditos del usuario */
    .fs-swiper-carousel .swiper-pagination {
        bottom: 95px !important;
    }

    .fs-swiper-carousel .swiper-pagination-bullet {
        width: 8px;
        height: 8px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 1;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .fs-swiper-carousel .swiper-pagination-bullet:hover {
        background: rgba(255, 255, 255, 0.8);
        transform: scale(1.2);
    }

    .fs-swiper-carousel .swiper-pagination-bullet-active {
        background: white;
        transform: scale(1.4);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    /* Contador personalizado - más visible */
    .fs-swiper-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10;
        pointer-events: none;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        letter-spacing: 0.5px;
    }

    /* Indicador visual de swipe en móvil */
    @@media (max-width: 768px) {
        .fs-swiper-carousel[data-has-multiple="true"]::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 8px;
            width: 4px;
            height: 40px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            transform: translateY(-50%);
            animation: swipeHint 2s ease-in-out 3; /* Limitado a 3 ciclos (6s) */
            opacity: 0;
        }

        .fs-swiper-carousel[data-swipe-hint="true"]::after {
            opacity: 1;
        }

        @@keyframes swipeHint {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(-5px); }
        }
    }

    /* Responsive para Swiper */
    @@media (max-width: 768px) {
        .fs-swiper-carousel .swiper-button-next:after,
        .fs-swiper-carousel .swiper-button-prev:after {
            font-size: 16px;
        }

        .fs-swiper-counter {
            top: 15px;
            right: 15px;
            font-size: 12px;
            padding: 4px 10px;
        }

        /* Pagination más visible en móvil */
        .fs-swiper-carousel .swiper-pagination-bullet {
            width: 8px;
            height: 8px;
        }

        .fs-swiper-carousel .swiper-pagination-bullet-active {
            width: 20px;
            border-radius: 4px;
        }
    }

    /* Desktop - imágenes/videos más grandes con sombra */
    @@media (min-width: 992px) {
        .fs-swiper-carousel .swiper-slide img,
        .fs-swiper-carousel .swiper-slide video {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
    }

    /* Double tap heart animation - Fullscreen */
    .fullscreen-heart-animation {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
        z-index: 10000;
    }

    .fullscreen-heart-animation svg {
        width: 120px;
        height: 120px;
        fill: #ed4956;
        filter: drop-shadow(0 0 20px rgba(237, 73, 86, 0.6));
    }

    .fullscreen-heart-animation.animate {
        animation: heartPop 0.8s ease-out forwards;
    }

    /* Double tap heart animation - Feed (Instagram style) */
    .doubletap-heart {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
        z-index: 100;
        opacity: 0;
    }

    .doubletap-heart svg {
        width: 100px;
        height: 100px;
        fill: #ed4956;
        filter: drop-shadow(0 0 15px rgba(237, 73, 86, 0.5));
    }

    .doubletap-heart.animate {
        animation: heartPopFeed 0.9s cubic-bezier(0.17, 0.89, 0.32, 1.28) forwards;
    }

    @@keyframes heartPopFeed {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        25% {
            transform: translate(-50%, -50%) scale(1.3);
        }
        40% {
            transform: translate(-50%, -50%) scale(0.9);
        }
        55% {
            transform: translate(-50%, -50%) scale(1.1);
        }
        70% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
        }
    }

    @@keyframes heartPop {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        15% {
            transform: translate(-50%, -50%) scale(1.2);
        }
        30% {
            transform: translate(-50%, -50%) scale(0.95);
        }
        45% {
            transform: translate(-50%, -50%) scale(1);
        }
        80% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
        }
    }

    /* Navigation hints */
    .fullscreen-nav-hint {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        pointer-events: none;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .fullscreen-nav-hint.top {
        top: 60px;
    }

    .fullscreen-nav-hint.bottom {
        bottom: 30px;
    }

    .fullscreen-nav-hint svg {
        width: 16px;
        height: 16px;
    }

    .fullscreen-viewer.show-hints .fullscreen-nav-hint {
        opacity: 1;
    }

    /* Audio content in fullscreen */
    .fullscreen-audio-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 24px;
        padding: 20px;
    }

    .fullscreen-audio-content svg {
        width: 100px;
        height: 100px;
        fill: var(--primary);
    }

    .fullscreen-audio-content audio {
        width: 100%;
        max-width: 400px;
    }

    /* Music badge in fullscreen - OCULTO, ahora va integrado en credits */
    .fullscreen-music-badge {
        display: none !important;
    }

    .fullscreen-audio-player {
        display: none;
    }

    /* Text content in fullscreen */
    .fullscreen-text-content {
        max-width: 600px;
        padding: 40px;
        color: white;
        font-size: 24px;
        line-height: 1.6;
        text-align: center;
    }

    /* Post counter - oculto en feed infinito */
    .fullscreen-counter {
        display: none;
    }

    /* Loading indicator */
    .fullscreen-loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        transition: opacity 0.3s ease;
    }

    .fullscreen-slide.media-loaded .fullscreen-loading-indicator {
        opacity: 0;
        pointer-events: none;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Media state - mostrar video/poster inmediatamente, transición suave */
    .fullscreen-slide img,
    .fullscreen-slide video {
        opacity: 1; /* Mostrar inmediatamente (el poster es visible mientras carga) */
        transition: opacity 0.3s ease;
    }

    /* Opcional: efecto fade-in cuando el media está completamente cargado */
    .fullscreen-slide.media-loaded img,
    .fullscreen-slide.media-loaded video {
        opacity: 1;
    }

    /* Fullscreen Viewer - Estilos para pantallas grandes (PC) */
    @@media (min-width: 992px) {
        .fullscreen-viewer {
            background: rgba(0, 0, 0, 0.95);
        }

        .fullscreen-slide {
            padding: 20px;
            box-sizing: border-box;
        }

        .fullscreen-slide img,
        .fullscreen-slide video {
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-slide.media-loaded img,
        .fullscreen-slide.media-loaded video {
            opacity: 1;
        }

        .fullscreen-music-badge {
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
        }

        .fullscreen-viewer-close {
            top: 90px; /* Debajo del botón mute en pantallas grandes */
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
        }

        .fullscreen-mute-btn-global {
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
        }

        .fullscreen-viewer-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }
    }

    /* Fullscreen Viewer - Estilos para pantallas muy grandes */
    @@media (min-width: 1400px) {
        .fullscreen-slide img,
        .fullscreen-slide video {
            max-width: 70%;
            max-height: 85vh;
        }
    }

    /* Music Badge - Estilo Instagram/TikTok */
    .music-badge {
        position: absolute;
        bottom: 16px;
        left: 16px;
        right: 60px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 8px 12px;
        border-radius: 20px;
        color: white;
        font-size: 13px;
        z-index: 5;
        overflow: hidden;
    }

    .music-badge-icon {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary), #ff6b6b);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: musicSpin 20s linear infinite !important;
    }

    .music-badge-icon svg {
        width: 14px;
        height: 14px;
    }

    @@keyframes musicSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .music-badge-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }

    .music-badge-title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .music-badge-artist {
        font-size: 11px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .photo-audio-player {
        display: none;
    }

    /* Badge playing state */
    .music-badge.playing .music-badge-icon {
        animation: musicSpin 10s linear infinite !important;
        box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.6);
    }

    .music-badge.playing {
        background: rgba(var(--primary-rgb), 0.3);
    }

    /* 🍎 iOS: Badge que requiere tap para reproducir */
    .music-badge.needs-tap {
        background: rgba(255, 165, 0, 0.4);
        animation: needsTapPulse 1.5s ease-in-out 4; /* Limitado a 4 ciclos (6s) */
    }

    .music-badge.needs-tap::after {
        content: '👆';
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 16px;
        animation: tapBounce 0.6s ease-in-out 10; /* Limitado a 10 ciclos (6s) */
    }

    @@keyframes needsTapPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
    }

    @@keyframes tapBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }

    /* Fullscreen Mute Button Global - Arriba Derecha (alineado con acciones) */
    .fullscreen-mute-btn-global {
        position: fixed;
        top: max(20px, calc(env(safe-area-inset-top, 0) + 10px));
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        z-index: 10001;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .fullscreen-mute-btn-global:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .fullscreen-mute-btn-global svg {
        width: 24px;
        height: 24px;
    }

    /* Ocultar el botón de mute dentro de los slides */
    .fullscreen-mute-btn {
        display: none !important;
    }

    /* ========================================
       CARRUSEL DE MÚLTIPLES ARCHIVOS
       Diseño moderno estilo Instagram
       ======================================== */

    .post-carousel {
        position: relative;
        width: 100%;
        background: #000;
        aspect-ratio: 4 / 5;
        overflow: hidden;
    }

    .carousel-container {
        width: 100%;
        height: 100%;
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        scroll-behavior: smooth;
    }

    .carousel-container::-webkit-scrollbar {
        display: none;
    }

    .carousel-track {
        display: contents;
    }

    .carousel-slide {
        flex: 0 0 100%;
        width: 100%;
        min-width: 100%;
        height: 100%;
        position: relative;
        scroll-snap-align: start;
        scroll-snap-stop: always;
    }

    .carousel-slide img.carousel-media,
    .carousel-slide video.carousel-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Gradiente inferior sutil para visibilidad de dots */
    .post-carousel::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 100%);
        pointer-events: none;
        z-index: 5;
    }

    .carousel-play-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 56px;
        height: 56px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        opacity: 0.9;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .carousel-play-icon svg {
        width: 28px;
        height: 28px;
    }

    /* Botones de navegación - estilo minimalista */
    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex !important;
        align-items: center;
        justify-content: center;
        z-index: 20;
        transition: all 0.2s ease;
        opacity: 0.9;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .carousel-btn:hover {
        background: #fff;
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .carousel-btn:active {
        transform: translateY(-50%) scale(0.95);
    }

    .carousel-btn svg {
        width: 18px;
        height: 18px;
        fill: #262626;
    }

    .carousel-prev {
        left: 12px;
    }

    .carousel-next {
        right: 12px;
    }

    .carousel-prev.hidden,
    .carousel-next.hidden {
        display: none !important;
    }

    /* Dots - estilo Instagram, sin fondo */
    .carousel-dots {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 4px;
        z-index: 20;
        padding: 0;
        background: transparent;
    }

    .carousel-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .carousel-dot.active {
        background: #fff;
        transform: scale(1);
    }

    .carousel-dot:hover {
        background: rgba(255, 255, 255, 0.8);
    }

    /* Contador - más discreto */
    .carousel-counter {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(0, 0, 0, 0.65);
        color: white;
        font-size: 12px;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 10px;
        z-index: 10;
        letter-spacing: 0.5px;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    /* Responsive - móvil */
    @@media (max-width: 480px) {
        .carousel-btn {
            width: 28px;
            height: 28px;
        }

        .carousel-btn svg {
            width: 16px;
            height: 16px;
        }

        .carousel-prev {
            left: 8px;
        }

        .carousel-next {
            right: 8px;
        }

        .carousel-dots {
            bottom: 12px;
            gap: 3px;
        }

        .carousel-dot {
            width: 5px;
            height: 5px;
        }

        .carousel-counter {
            font-size: 11px;
            padding: 3px 6px;
            top: 10px;
            right: 10px;
        }

        .post-carousel::after {
            height: 60px;
        }
    }

    /* ========================================
       FULLSCREEN CREDITS (Estilo TikTok/Reels)
       ======================================== */
    /* ========================================
       FULLSCREEN UI - ESTILO YOUTUBE SHORTS
       ======================================== */

    /* Contenedor principal de créditos - ahora con layout separado */
    .fullscreen-credits {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        pointer-events: none;
        padding: 20px;
        padding-bottom: 20px;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
    }

    .credits-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        max-width: 100%;
    }

    /* ========================================
       INFO DEL CREADOR - IZQUIERDA INFERIOR
       ======================================== */
    .credits-creator-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 70%;
        pointer-events: auto;
    }

    .credits-creator-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .credits-avatar {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        max-width: 40px;
        min-height: 40px;
        max-height: 40px;
        border-radius: 50% !important;
        object-fit: cover;
        border: 2px solid white;
        cursor: pointer;
        flex-shrink: 0;
        display: block;
    }

    .credits-avatar-placeholder {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        max-width: 40px;
        min-height: 40px;
        max-height: 40px;
        border-radius: 50% !important;
        background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 16px;
        border: 2px solid white;
        cursor: pointer;
        flex-shrink: 0;
    }

    .credits-creator-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        cursor: pointer;
    }

    .credits-name {
        font-size: 15px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .credits-verified {
        width: 16px;
        height: 16px;
        color: #3b82f6;
    }

    .credits-badge-ladob {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .credits-username {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
    }

    .credits-follow-btn {
        background: white;
        color: black;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .credits-follow-btn:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: scale(1.05);
    }

    .credits-follow-btn.following {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
    }

    /* Descripción del post */
    .credits-description {
        font-size: 14px;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        max-width: 300px;
    }

    /* Música */
    .credits-music {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
    }

    .credits-music svg {
        width: 14px;
        height: 14px;
    }

    .credits-music-text {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========================================
       ACCIONES - DERECHA (COLUMNA VERTICAL)
       ======================================== */
    .credits-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        pointer-events: auto;
        margin-bottom: 48px; /* Subido ~1cm */
    }

    .credits-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        background: transparent;
        border: none;
        color: white;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        transition: transform 0.2s ease;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
    }

    .credits-action-btn:hover {
        transform: scale(1.1);
    }

    .credits-action-btn:active {
        transform: scale(0.95);
    }

    .credits-action-btn.liked {
        color: #ef4444;
    }

    .credits-action-btn svg {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .credits-action-btn.liked svg {
        fill: #ef4444;
    }

    .credits-likes-count,
    .credits-comments-count {
        font-size: 13px;
    }

    /* Botón compartir */
    .credits-share-wrapper {
        position: relative;
    }

    .credits-share-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 8px 0;
        min-width: 160px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transition: all 0.2s ease;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .credits-share-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    .credits-share-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
    }

    .credits-share-option:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .credits-share-option svg {
        width: 18px;
        height: 18px;
    }

    /* Avatar del creador en acciones (pequeño) */
    .credits-creator-avatar-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid white;
        cursor: pointer;
        margin-top: 8px;
    }

    .credits-creator-avatar-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ========================================
       NAVEGACIÓN ARRIBA/ABAJO
       Posicionado en esquina superior derecha, debajo del botón cerrar
       ======================================== */
    .fullscreen-nav-arrows {
        display: none !important; /* Ocultas - navegación por scroll/swipe */
    }

    .fullscreen-nav-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .fullscreen-nav-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .fullscreen-nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .fullscreen-nav-btn svg {
        width: 28px;
        height: 28px;
        color: white;
    }

    /* Mobile adjustments */
    @@media (max-width: 768px) {
        .fullscreen-credits {
            padding: 16px;
            padding-bottom: 24px;
        }

        .credits-creator-section {
            max-width: 65%;
        }

        .credits-avatar,
        .credits-avatar-placeholder {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px;
            max-width: 36px;
            min-height: 36px;
            max-height: 36px;
            font-size: 14px;
        }

        .credits-name {
            font-size: 14px;
        }

        .credits-username {
            font-size: 12px;
        }

        .credits-description {
            font-size: 13px;
            -webkit-line-clamp: 2;
        }

        .credits-action-btn svg {
            width: 28px;
            height: 28px;
        }

        .credits-actions {
            gap: 16px;
        }

        .credits-follow-btn {
            padding: 6px 14px;
            font-size: 13px;
        }

        .fullscreen-nav-arrows {
            right: 12px;
            top: 70px; /* Debajo del botón cerrar en móvil */
            bottom: auto;
        }

        .fullscreen-nav-btn {
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.4);
        }

        .fullscreen-nav-btn svg {
            width: 20px;
            height: 20px;
        }
    }

    /* Ocultar navegación en landscape pequeño */
    @@media (max-height: 500px) and (orientation: landscape) {
        .fullscreen-nav-arrows {
            display: none;
        }

        .fullscreen-credits {
            bottom: 100px; /* 20px mas arriba que desktop */
            right: 12px;
        }

        .credits-name {
            font-size: 14px;
        }

        .credits-username {
            font-size: 12px;
        }

        .credits-action-btn svg {
            width: 26px;
            height: 26px;
        }

        .credits-actions {
            gap: 16px;
        }
    }

    /* Landscape mobile */
    @@media (max-height: 500px) and (orientation: landscape) {
        .fullscreen-credits {
            bottom: 10px;
            right: 10px;
        }

        .credits-action-btn svg {
            width: 22px;
            height: 22px;
        }

        .credits-actions {
            gap: 12px;
        }

        .credits-description {
            -webkit-line-clamp: 1;
            font-size: 12px;
        }
    }

    /* ========================================
       COMMENTS BOTTOM SHEET (Instagram-style)
       ======================================== */
    .comments-bottomsheet-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1200;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .comments-bottomsheet-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .comments-bottomsheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1201;
        background: #262626;
        border-radius: 16px 16px 0 0;
        max-height: 70vh;
        max-height: 70dvh;
        min-height: 50vh;
        min-height: 50dvh;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .comments-bottomsheet.active {
        transform: translateY(0);
    }

    .comments-bottomsheet.dragging {
        transition: none;
    }

    .comments-bs-drag-handle {
        display: flex;
        justify-content: center;
        padding: 12px 0 4px 0;
        cursor: grab;
        flex-shrink: 0;
    }

    .comments-bs-drag-handle::after {
        content: '';
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
    }

    .comments-bs-header {
        text-align: center;
        padding: 8px 16px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
    }

    .comments-bs-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: #fff;
    }

    .comments-bs-body {
        flex: 1;
        overflow-y: auto;
        overscroll-behavior-y: contain;
        -webkit-overflow-scrolling: touch;
        padding: 12px 16px;
    }

    .comments-bs-body::-webkit-scrollbar {
        width: 0;
        display: none;
    }

    .comments-bs-loading {
        display: flex;
        justify-content: center;
        padding: 40px 0;
    }

    .comments-bs-loading .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .comments-bs-empty {
        text-align: center;
        padding: 40px 0;
        color: rgba(255, 255, 255, 0.5);
        font-size: 14px;
    }

    .comments-bs-load-more {
        text-align: center;
        padding: 12px 0;
    }

    .comments-bs-load-more button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 13px;
        cursor: pointer;
        padding: 8px 16px;
    }

    /* Comment item */
    .bs-comment-item {
        display: flex;
        gap: 12px;
        padding: 10px 0;
    }

    .bs-comment-avatar {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
    }

    .bs-comment-avatar img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .bs-comment-avatar-initial {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary, #8b5cf6) 0%, #6366f1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 13px;
        font-weight: 700;
    }

    .bs-comment-body {
        flex: 1;
        min-width: 0;
    }

    .bs-comment-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
    }

    .bs-comment-username {
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        text-decoration: none;
    }

    .bs-comment-time {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.4);
    }

    .bs-comment-text {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.4;
        margin: 0;
        word-break: break-word;
    }

    .bs-comment-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 8px;
    }

    .bs-comment-action-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 12px;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .bs-comment-action-btn svg {
        width: 14px;
        height: 14px;
    }

    .bs-comment-action-btn.liked {
        color: #ef4444;
    }

    .bs-comment-action-btn.liked svg {
        fill: #ef4444;
    }

    .bs-comment-reply-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
    }

    /* Replies */
    .bs-comment-replies {
        margin-top: 8px;
        padding-left: 0;
    }

    .bs-show-replies-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        padding: 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .bs-show-replies-btn::before {
        content: '';
        display: inline-block;
        width: 24px;
        height: 1px;
        background: rgba(255, 255, 255, 0.3);
    }

    .bs-reply-item {
        display: flex;
        gap: 10px;
        padding: 8px 0;
    }

    .bs-reply-item .bs-comment-avatar,
    .bs-reply-item .bs-comment-avatar img,
    .bs-reply-item .bs-comment-avatar-initial {
        width: 24px;
        height: 24px;
        font-size: 10px;
    }

    /* Comment input */
    .comments-bs-input-area {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: #262626;
        flex-shrink: 0;
    }

    .comments-bs-reply-indicator {
        display: none;
        padding: 8px 16px 0;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        background: #262626;
        flex-shrink: 0;
    }

    .comments-bs-reply-indicator.active {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .comments-bs-reply-cancel {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        cursor: pointer;
        padding: 4px;
    }

    .comments-bs-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 14px;
        outline: none;
        padding: 8px 0;
        min-width: 0;
    }

    .comments-bs-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .comments-bs-send-btn {
        background: none;
        border: none;
        color: #0095f6;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px;
        opacity: 0.4;
        transition: opacity 0.2s;
        flex-shrink: 0;
    }

    .comments-bs-send-btn.enabled {
        opacity: 1;
    }

    /* Responsive */
    @@media (min-width: 768px) {
        .comments-bottomsheet {
            max-width: 500px;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            border-radius: 16px 16px 0 0;
        }

        .comments-bottomsheet.active {
            transform: translateX(-50%) translateY(0);
        }

        .comments-bottomsheet.dragging {
            transition: none;
        }
    }

    /* ========================================
       FULLSCREEN CARRUSEL VIEWER
       ======================================== */
    .carousel-fullscreen-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        overflow: hidden;
    }

    .carousel-fullscreen-viewer.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-fs-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .carousel-fs-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .carousel-fs-close svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .carousel-fs-counter {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10001;
    }

    .carousel-fs-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-fs-slide {
        display: none;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        box-sizing: border-box;
    }

    .carousel-fs-slide.active {
        display: flex;
    }

    .carousel-fs-slide img,
    .carousel-fs-slide video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .carousel-fs-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10001;
    }

    .carousel-fs-nav:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-fs-nav svg {
        width: 28px;
        height: 28px;
    }

    .carousel-fs-prev {
        left: 20px;
    }

    .carousel-fs-next {
        right: 20px;
    }

    .carousel-fs-dots {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10001;
    }

    .carousel-fs-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        transition: all 0.2s;
    }

    .carousel-fs-dot:hover {
        background: rgba(255, 255, 255, 0.7);
    }

    .carousel-fs-dot.active {
        background: white;
        transform: scale(1.2);
    }

    .carousel-fs-mute {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        transition: all 0.2s;
    }

    .carousel-fs-mute:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .carousel-fs-mute svg {
        width: 24px;
        height: 24px;
    }

    /* Responsive fullscreen carrusel */
    @@media (max-width: 768px) {
        .carousel-fs-nav {
            width: 40px;
            height: 40px;
        }

        .carousel-fs-prev {
            left: 10px;
        }

        .carousel-fs-next {
            right: 10px;
        }

        .carousel-fs-slide {
            padding: 50px 10px;
        }

        .carousel-fs-close {
            top: 10px;
            right: 10px;
        }

        .carousel-fs-counter {
            top: 15px;
            font-size: 12px;
        }

        .carousel-fs-dots {
            bottom: 20px;
        }

        .carousel-fs-dot {
            width: 8px;
            height: 8px;
        }
    }

    /* =====================================================
       OVERLAY CONTENIDO SENSIBLE
    ===================================================== */
    .sensitive-content-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(40px) saturate(1.2);
        -webkit-backdrop-filter: blur(40px) saturate(1.2);
    }

    .sensitive-warning {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 30px;
        max-width: 90%;
    }

    .sensitive-icon {
        width: 56px;
        height: 56px;
        stroke: rgba(255, 255, 255, 0.85);
        margin-bottom: 16px;
    }

    .sensitive-title {
        font-size: 18px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 10px;
    }

    .sensitive-text {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.85);
        max-width: 280px;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .sensitive-reveal-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.6);
        color: #fff;
        padding: 10px 28px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sensitive-reveal-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: #fff;
    }

    .sensitive-reveal-btn:active {
        transform: scale(0.95);
    }

    /* Animación de fade out al revelar */
    .sensitive-content-overlay.revealing {
        animation: sensitiveReveal 0.3s ease forwards;
    }

    @@keyframes sensitiveReveal {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            pointer-events: none;
        }
    }

    /* ========================================
       MODAL DE REPORTES ESTILO INSTAGRAM
       ======================================== */
    .report-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeInOverlay 0.2s ease;
    }

    .report-modal-overlay.show {
        display: flex;
    }

    @@keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .report-modal {
        background: var(--surface);
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        max-height: 85vh;
        overflow: hidden;
        animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    @@keyframes slideUpModal {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .report-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--line);
    }

    .report-modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        flex: 1;
        text-align: center;
    }

    .report-modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--fg);
        cursor: pointer;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .report-modal-close:hover {
        background: var(--hover);
    }

    .report-modal-close svg {
        width: 20px;
        height: 20px;
    }

    .report-modal-subtitle {
        padding: 16px 20px 12px;
        font-size: 14px;
        color: var(--muted);
        line-height: 1.4;
    }

    .report-options {
        max-height: calc(85vh - 180px);
        overflow-y: auto;
    }

    .report-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
    }

    .report-option:hover {
        background: var(--hover);
    }

    .report-option:active {
        background: var(--line);
    }

    .report-option-content {
        flex: 1;
    }

    .report-option-title {
        font-size: 15px;
        color: var(--fg);
        font-weight: 400;
        margin-bottom: 2px;
    }

    .report-option-desc {
        font-size: 12px;
        color: var(--muted);
        display: none;
    }

    .report-option-arrow {
        color: var(--muted);
        flex-shrink: 0;
        margin-left: 12px;
    }

    .report-option-arrow svg {
        width: 20px;
        height: 20px;
    }

    /* Subopciones */
    .report-suboptions {
        display: none;
        animation: fadeInOptions 0.2s ease;
    }

    .report-suboptions.show {
        display: block;
    }

    @@keyframes fadeInOptions {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .report-back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 20px;
        font-size: 15px;
        color: var(--primary);
        cursor: pointer;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        border-bottom: 1px solid var(--line);
        font-weight: 500;
    }

    .report-back-btn:hover {
        background: var(--hover);
    }

    .report-back-btn svg {
        width: 18px;
        height: 18px;
    }

    .report-category-title {
        padding: 12px 20px 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Campo de texto adicional */
    .report-textarea-container {
        padding: 0 20px 16px;
        display: none;
    }

    .report-textarea-container.show {
        display: block;
    }

    .report-textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: var(--bg);
        color: var(--fg);
        font-size: 14px;
        resize: none;
        font-family: inherit;
    }

    .report-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .report-textarea::placeholder {
        color: var(--muted);
    }

    /* Boton de enviar */
    .report-submit-container {
        padding: 12px 20px 20px;
        display: none;
    }

    .report-submit-container.show {
        display: block;
    }

    .report-submit-btn {
        width: 100%;
        padding: 14px;
        background: #ed4956;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .report-submit-btn:hover {
        background: #dc3545;
        transform: translateY(-1px);
    }

    .report-submit-btn:active {
        transform: translateY(0);
    }

    .report-submit-btn:disabled {
        background: var(--muted);
        cursor: not-allowed;
        transform: none;
    }

    /* Confirmacion de envio */
    .report-confirmation {
        display: none;
        text-align: center;
        padding: 40px 20px;
    }

    .report-confirmation.show {
        display: block;
    }

    .report-confirmation-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .report-confirmation-icon svg {
        width: 32px;
        height: 32px;
        color: white;
    }

    .report-confirmation-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--fg);
        margin-bottom: 8px;
    }

    .report-confirmation-text {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
        margin-bottom: 24px;
    }

    .report-confirmation-btn {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .report-confirmation-btn:hover {
        opacity: 0.9;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .report-modal {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
            height: 100%;
        }

        .report-modal-overlay {
            align-items: flex-end;
        }

        @@supports (padding-bottom: env(safe-area-inset-bottom)) {
            .report-submit-container {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
    }

    /* ========================================
       TOOLTIP DE LIKES (Desktop hover)
       ======================================== */
    .likes-tooltip {
        position: absolute;
        z-index: 1000;
        background: var(--surface, #fff);
        border: 1px solid var(--line, #dbdbdb);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 12px;
        min-width: 200px;
        max-width: 280px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .likes-tooltip.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    .likes-tooltip-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--muted, #8e8e8e);
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--line, #efefef);
    }

    .likes-tooltip-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .likes-tooltip-user {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--fg, #262626);
        padding: 4px;
        border-radius: 8px;
        transition: background 0.15s;
    }

    .likes-tooltip-user:hover {
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-tooltip-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-tooltip-info {
        flex: 1;
        min-width: 0;
    }

    .likes-tooltip-username {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .likes-tooltip-username .verified {
        color: var(--primary, #4682B4);
        font-size: 12px;
    }

    .likes-tooltip-name {
        font-size: 12px;
        color: var(--muted, #8e8e8e);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .likes-tooltip-more {
        font-size: 12px;
        color: var(--primary, #4682B4);
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid var(--line, #efefef);
        margin-top: 8px;
        cursor: pointer;
    }

    .likes-tooltip-loading {
        display: flex;
        justify-content: center;
        padding: 20px;
        color: var(--muted, #8e8e8e);
    }

    /* ========================================
       MODAL DE LIKES (Instagram style)
       ======================================== */
    .likes-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
    }

    .likes-modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .likes-modal {
        background: var(--surface, #fff);
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        max-height: 70vh;
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.2s ease, opacity 0.2s ease;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
    }

    .likes-modal-overlay.visible .likes-modal {
        transform: scale(1);
        opacity: 1;
    }

    /* En móvil: bottom sheet */
    @@media (max-width: 480px) {
        .likes-modal-overlay {
            align-items: flex-end;
        }

        .likes-modal {
            width: 100%;
            max-width: 100%;
            border-radius: 16px 16px 0 0;
            max-height: 80vh;
            min-height: 50vh; /* Altura mínima para que no se vea cortado */
            transform: translateY(100%);
            /* Safe area para iOS */
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .likes-modal-overlay.visible .likes-modal {
            transform: translateY(0);
        }
    }

    .likes-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--line, #efefef);
        position: relative;
    }

    /* Handle visual estilo iOS para bottom sheet */
    @@media (max-width: 480px) {
        .likes-modal-header {
            padding-top: 24px; /* Espacio para el handle */
        }

        .likes-modal-header::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 4px;
            background: var(--line, #dbdbdb);
            border-radius: 2px;
        }
    }

    .likes-modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg, #262626);
    }

    .likes-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--muted, #8e8e8e);
        cursor: pointer;
        padding: 4px;
        line-height: 1;
    }

    .likes-modal-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 20px 20px;
        min-height: 200px; /* Altura mínima para el contenido */
    }

    .likes-modal-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Loading y empty states mejorados */
    .likes-modal-loading,
    .likes-modal-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--muted, #8e8e8e);
        text-align: center;
        min-height: 150px;
    }

    .likes-modal-loading i,
    .likes-modal-empty i {
        font-size: 24px;
        margin-bottom: 12px;
    }

    .likes-modal-empty p {
        margin: 0;
        font-size: 14px;
    }

    .likes-modal-user {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--fg, #262626);
        padding: 8px;
        border-radius: 12px;
        transition: background 0.15s;
    }

    .likes-modal-user:hover {
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-modal-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-modal-info {
        flex: 1;
    }

    .likes-modal-username {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .likes-modal-username .verified {
        color: var(--primary, #4682B4);
        font-size: 14px;
    }

    .likes-modal-name {
        font-size: 13px;
        color: var(--muted, #8e8e8e);
    }

    /* Botón de seguir en modal de likes */
    .likes-modal-follow-btn {
        padding: 7px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        border: none;
    }

    .likes-modal-follow-btn.seguir {
        background: var(--primary, #4682B4);
        color: white;
    }

    .likes-modal-follow-btn.seguir:hover {
        background: var(--primary-dark, #3a6d94);
        transform: scale(1.02);
    }

    .likes-modal-follow-btn.siguiendo {
        background: var(--bg-tertiary, #efefef);
        color: var(--fg, #262626);
        border: 1px solid var(--line, #dbdbdb);
    }

    .likes-modal-follow-btn.siguiendo:hover {
        background: var(--bg-hover, #fafafa);
    }

    .likes-modal-follow-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Contador de likes clickeable */
    .post-likes-count.clickable {
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .post-likes-count.clickable:hover {
        opacity: 0.7;
    }

    .likes-modal-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted, #8e8e8e);
    }

    .likes-modal-empty i {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .likes-modal-loading-more {
        text-align: center;
        padding: 16px;
        color: var(--muted, #8e8e8e);
        font-size: 13px;
    }

    @@media (prefers-color-scheme: dark) {
        .likes-tooltip,
        .likes-modal {
            background: var(--surface, #262626);
            border-color: var(--line, #363636);
        }

        .likes-modal-follow-btn.siguiendo {
            background: var(--bg-tertiary, #363636);
            color: var(--fg, #f5f5f5);
            border-color: var(--line, #484848);
        }
    }

    /* ========================================
       SIMPLIFICACIÓN MÓVIL - DISEÑO LIMPIO
       ======================================== */

    /* Móvil Grande (< 768px) */
    @@media (max-width: 767px) {
        /* Layout edge-to-edge */
        .feed-page-layout {
            padding: 0 !important;
            gap: 0 !important;
        }

        .feed-container {
            max-width: 100%;
        }

        /* Ocultar selector de algoritmo en móvil - usar desplegable simple */
        .algorithm-selector {
            border-radius: 0;
            border-left: none;
            border-right: none;
            margin-bottom: 0;
            padding: 10px 16px;
            border-bottom: none;
        }

        .algorithm-label {
            font-size: 12px;
        }

        .algorithm-select {
            padding: 6px 28px 6px 10px;
            font-size: 12px;
            min-width: 130px;
            border-radius: 16px;
        }

        /* Stories más compactos */
        .stories-bar {
            border-radius: 0;
            border-left: none;
            border-right: none;
            padding: 12px;
            margin-bottom: 0;
            border-bottom: 1px solid var(--line);
        }

        .stories-scroll {
            gap: 12px;
        }

        .story-ring {
            width: 85px;
            height: 85px;
        }

        .story-username {
            font-size: 11px;
            max-width: 85px;
        }

        /* Posts sin bordes laterales */
        .post {
            border-radius: 0;
            border-left: none;
            border-right: none;
            margin-bottom: 0;
            border-bottom: 8px solid var(--bg);
        }

        /* Header del post más compacto */
        .post-header {
            padding: 10px 12px;
        }

        .post-avatar,
        .post-avatar-placeholder {
            width: 36px !important;
            height: 36px !important;
        }

        .post-username {
            font-size: 13px;
        }

        .post-time {
            font-size: 11px;
        }

        .post-badge {
            font-size: 9px;
            padding: 1px 5px;
        }

        /* Acciones con mejor touch target */
        .post-actions {
            padding: 8px 12px 0;
            gap: 20px;
        }

        .action-btn {
            padding: 12px;
            margin: -12px;
            min-width: 48px;
            min-height: 48px;
        }

        .action-btn svg {
            width: 26px;
            height: 26px;
        }

        /* Ocultar botón de comentarios en móvil - tap en el post abre detalle */
        .comment-btn {
            display: none !important;
        }

        /* Likes y caption más compactos */
        .post-likes {
            padding: 0 12px;
            margin-top: 6px;
        }

        .post-likes-count {
            font-size: 13px;
        }

        .post-caption {
            padding: 6px 12px;
        }

        .post-caption-text {
            font-size: 13px;
            line-height: 1.35;
        }

        /* Comentarios más compactos */
        .post-comments-preview {
            padding: 0 12px 6px;
        }

        .view-all-comments {
            font-size: 13px;
        }

        /* Input de comentario optimizado para móvil */
        .post-add-comment {
            padding: 8px 12px;
            gap: 10px;
        }

        .comment-input {
            font-size: 14px;
            padding: 10px 0;
        }

        .comment-post-btn {
            font-size: 13px;
            padding: 8px 12px;
        }

        /* Timestamp más discreto */
        .post-timestamp {
            padding: 4px 12px 12px;
            font-size: 10px;
        }

        /* Menú de post más accesible */
        .post-menu {
            padding: 12px;
            margin: -8px;
        }

        .post-menu-dropdown {
            min-width: 180px;
        }

        .post-menu-item {
            padding: 14px 16px;
            font-size: 15px;
        }

        /* Pull to refresh ajustado para móvil */
        .pull-to-refresh {
            /* Navbar móvil es ~56px + safe-area + padding extra */
            top: calc(76px + env(safe-area-inset-top, 0px));
        }

        .pull-indicator {
            width: 44px;
            height: 44px;
        }

        .pull-indicator svg {
            width: 20px;
            height: 20px;
        }

        .pull-text {
            font-size: 11px;
            padding: 3px 10px;
        }

        /* Carrusel optimizado */
        .carousel-btn {
            width: 36px;
            height: 36px;
        }

        /* Location badge más pequeño */
        .location-badge {
            padding: 3px 8px;
            font-size: 11px;
        }
    }

    /* Móvil Pequeño (< 480px) */
    @@media (max-width: 479px) {
        /* Stories aún más compactos */
        .story-ring {
            width: 78px;
            height: 78px;
        }

        .story-username {
            font-size: 10px;
            max-width: 78px;
        }

        .stories-scroll {
            gap: 10px;
        }

        /* Header del post ultra compacto */
        .post-header {
            padding: 8px 10px;
        }

        .post-avatar,
        .post-avatar-placeholder {
            width: 32px !important;
            height: 32px !important;
        }

        .post-header-left {
            gap: 10px;
        }

        .post-username {
            font-size: 12px;
        }

        .post-time {
            font-size: 10px;
        }

        /* Acciones aún más grandes para dedos */
        .post-actions {
            padding: 6px 10px 0;
            gap: 24px;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Contenido más compacto */
        .post-likes {
            padding: 0 10px;
        }

        .post-caption {
            padding: 4px 10px;
        }

        .post-comments-preview {
            padding: 0 10px 4px;
        }

        .post-add-comment {
            padding: 6px 10px;
        }

        .post-timestamp {
            padding: 2px 10px 10px;
        }

        /* Ocultar label del algoritmo en pantallas muy pequeñas */
        .algorithm-label span {
            display: none;
        }

        .algorithm-select {
            min-width: 110px;
        }

        /* Preview blur más compacto */
        .preview-blur-text {
            font-size: 13px;
        }

        .preview-blur-subtext {
            font-size: 11px;
        }

        .preview-blur-btn {
            padding: 8px 20px;
            font-size: 12px;
        }

        /* Locked content más compacto */
        .locked-icon {
            width: 52px;
            height: 52px;
        }

        .locked-icon svg {
            width: 26px;
            height: 26px;
        }

        .locked-text {
            font-size: 14px;
        }

        .locked-subscribe-btn {
            padding: 10px 24px;
            font-size: 13px;
        }
    }

    /* Pantallas muy pequeñas (< 360px) - iPhone SE, etc */
    @@media (max-width: 359px) {
        .story-ring {
            width: 72px;
            height: 72px;
        }

        .story-username {
            max-width: 72px;
        }

        .stories-scroll {
            gap: 8px;
        }

        .post-avatar,
        .post-avatar-placeholder {
            width: 28px !important;
            height: 28px !important;
        }

        .post-actions {
            gap: 20px;
        }

        .action-btn svg {
            width: 22px;
            height: 22px;
        }

        .algorithm-selector {
            padding: 8px 10px;
        }
    }

    /* Safe area para iPhone X+ */
    @@supports (padding-bottom: env(safe-area-inset-bottom)) {
        @@media (max-width: 767px) {
            .feed-page-layout {
                padding-bottom: calc(70px + env(safe-area-inset-bottom)) !important;
            }
        }
    }

    /* Mejoras de rendimiento móvil */
    @@media (max-width: 767px) {
        .post-media img,
        .post-media video {
            will-change: auto;
        }

        /* Reducir animaciones en móvil para mejor rendimiento */
        .post,
        .action-btn,
        .story-item {
            transition-duration: 0.15s;
        }

        /* Scroll suave nativo */
        .stories-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x proximity;
        }

        .story-item {
            scroll-snap-align: start;
        }
    }

</style>

<div class="feed-page-layout">
    <!-- MAIN FEED -->
    <!-- Pull to Refresh Indicator - Mejorado -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <div class="pull-indicator">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        </div>
        <span class="pull-text" id="pullText">Desliza para actualizar</span>
    </div>

    <!-- Banner de nuevos posts -->
    <div class="new-posts-banner" id="newPostsBanner" onclick="cargarNuevosPosts()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
        <span id="newPostsText">Nuevas publicaciones</span>
    </div>

    <div class="feed-main">
        <div class="feed-container">
            <!-- STORIES BAR - Estilo Instagram -->
            <div class="stories-bar">
                <div class="stories-scroll">
                    <!-- TU STORY - Siempre primero con botón + -->
                    <div class="story-item" id="tuStoryItem" onclick="manejarTuStoryClick()">
                        <div class="story-ring your-story" id="tuStoryRing">
                            <div class="story-ring-inner">
                                @if (!string.IsNullOrEmpty(usuarioActual?.FotoPerfil))
                                {
                                    <img src="@usuarioActual.FotoPerfil" alt="Tu foto de perfil" class="story-avatar">
                                }
                                else
                                {
                                    <div class="story-avatar-placeholder">
                                        @(usuarioActual?.NombreCompleto?.Substring(0, 1).ToUpper() ?? "U")
                                    </div>
                                }
                            </div>
                            <div class="story-add-btn" onclick="event.stopPropagation(); abrirModalCrearStory();">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </div>
                        </div>
                        <span class="story-username">Tu story</span>
                    </div>

                    <!-- STORIES DE SEGUIDOS -->
                    @if (stories != null && stories.Any())
                    {
                        @foreach (var storyGroup in stories)
                        {
                            <div class="story-item" onclick="abrirVisorStories('@storyGroup.CreadorId')">
                                <div class="story-ring @(storyGroup.TieneStorysSinVer ? "" : "seen")">
                                    <div class="story-ring-inner">
                                        @if (!string.IsNullOrEmpty(storyGroup.Creador.FotoPerfil))
                                        {
                                            <img src="@storyGroup.Creador.FotoPerfil" alt="Foto de @storyGroup.Creador.NombreCompleto" class="story-avatar">
                                        }
                                        else
                                        {
                                            <div class="story-avatar-placeholder">
                                                @storyGroup.Creador.NombreCompleto.Substring(0, 1).ToUpper()
                                            </div>
                                        }
                                    </div>
                                </div>
                                <span class="story-username">@storyGroup.Creador.NombreCompleto.Split(' ')[0]</span>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- ALGORITHM SELECTOR -->
            @if (algoritmosDisponibles.Any())
            {
                var algoritmoActualId = algoritmoActual?.Id ?? 0;

                <div class="algorithm-selector">
                    <span class="algorithm-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        Ordenar por
                    </span>
                    <select class="algorithm-select" id="algorithmSelect" onchange="cambiarAlgoritmoSelect(this.value)">
                        @foreach (var alg in algoritmosDisponibles)
                        {
                            if (alg.Id == algoritmoActualId)
                            {
                                <option value="@alg.Id" selected>@alg.Nombre</option>
                            }
                            else
                            {
                                <option value="@alg.Id">@alg.Nombre</option>
                            }
                        }
                    </select>
                </div>
            }

    <!-- POSTS -->
    <div id="postsContainer">
    @if (Model.Any())
    {
        var postIndex = 0;
        var anuncioIndex = 0;
        var insertarAnuncioCada = anunciosIntervalo; // Usar intervalo desde configuración

        @foreach (var post in Model.Take(10))
        {
            var tiempoTexto = GetTimeAgo(post.FechaPublicacion);
            var urlPerfil = post.TipoLado == TipoLado.LadoB
                ? $"/Feed/Perfil/{post.UsuarioId}?verSeudonimo=true"
                : $"/Feed/Perfil/{post.UsuarioId}";
            var nombreUsuario = post.NombreMostrado ?? post.Usuario?.NombreCompleto ?? "Usuario";
            var usernameMostrado = post.TipoLado == TipoLado.LadoB
                ? (post.Usuario?.Seudonimo ?? post.Usuario?.UserName ?? "usuario")
                : (post.Usuario?.UserName ?? "usuario");
            var tipoMedia = post.TipoContenido;
            var esImagen = tipoMedia == TipoContenido.Foto || tipoMedia == TipoContenido.Imagen;
            var esVideo = tipoMedia == TipoContenido.Video;
            var esAudio = tipoMedia == TipoContenido.Audio;
            var esPost = tipoMedia == TipoContenido.Post;

            // Soporte para carrusel (múltiples archivos)
            // Shadow Hide: Si no es el creador, excluir archivos ocultos silenciosamente
            var esCreadorDelPost = usuarioActual?.Id == post.UsuarioId;
            var archivosCarrusel = esCreadorDelPost ? post.TodosLosArchivos : post.ArchivosVisibles;
            var esCarrusel = archivosCarrusel.Count > 1;

            // Usar PrimerArchivo para compatibilidad con contenidos que solo tienen Archivos (sin RutaArchivo)
            var rutaArchivoEfectiva = post.PrimerArchivo;
            var tieneArchivo = !string.IsNullOrEmpty(rutaArchivoEfectiva);
            var yaLeDioLike = likesUsuario.Contains(post.Id);
            var esFavorito = favoritosIds.Contains(post.Id);
            var estaBloqueado = contenidoBloqueadoIds.Contains(post.Id);
            var esPreviewBlur = post.EsPreviewBlurDeLadoB;
            var tipoCensura = post.TipoCensuraPreview ?? TipoCensuraPreview.Blur;

            // Determinar la foto de perfil según el tipo de contenido
            var fotoPerfilMostrar = post.TipoLado == TipoLado.LadoB
                ? (post.Usuario?.FotoPerfilLadoB ?? post.Usuario?.FotoPerfil)
                : post.Usuario?.FotoPerfil;
            var sigueAlCreador = usuariosSeguidosIds.Contains(post.UsuarioId);
            <article id="post-@post.Id" class="post @(estaBloqueado ? "post-locked" : "")" data-post-id="@post.Id" data-locked="@estaBloqueado.ToString().ToLower()" data-creator-id="@post.UsuarioId" data-creator-name="@(post.Usuario?.Seudonimo ?? post.Usuario?.NombreCompleto ?? "Creador")" data-creator-photo="@(post.Usuario?.FotoPerfilLadoB ?? post.Usuario?.FotoPerfil)" data-creator-price="@(post.Usuario?.PrecioSuscripcion.ToString("0.00") ?? "0.00")" data-likes="@post.NumeroLikes" data-comments="@post.NumeroComentarios" data-is-following="@sigueAlCreador.ToString().ToLower()">
                <!-- Header -->
                <header class="post-header">
                    <a href="@urlPerfil" class="post-header-left">
                        @if (!string.IsNullOrEmpty(fotoPerfilMostrar))
                        {
                            <img src="@fotoPerfilMostrar" alt="Foto de @usernameMostrado" class="post-avatar" loading="lazy">
                        }
                        else
                        {
                            <div class="post-avatar-placeholder">
                                @nombreUsuario.Substring(0, 1).ToUpper()
                            </div>
                        }
                        <div class="post-user-info">
                            <span class="post-username">
                                @usernameMostrado
                                @if (post.Usuario?.CreadorVerificado == true)
                                {
                                    <img src="/images/verified-badge.png" alt="Verificado" class="verified-icon" title="Creador verificado">
                                }
                            </span>
                            <span class="post-time">@tiempoTexto</span>
                        </div>
                    </a>
                    <div class="post-header-right">
                        @if (usuarioActual != null && usuarioActual.Id != post.UsuarioId && !sigueAlCreador)
                        {
                            <button class="post-follow-btn" onclick="seguirDesdeHeader(event, '@post.UsuarioId', @((int)post.TipoLado), this)">Seguir</button>
                        }
                        <div class="post-menu" onclick="togglePostMenu(event, this)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="1.5"></circle>
                            <circle cx="6" cy="12" r="1.5"></circle>
                            <circle cx="18" cy="12" r="1.5"></circle>
                        </svg>
                        <div class="post-menu-dropdown" data-post-id="@post.Id" data-user-id="@post.UsuarioId" data-tipo-lado="@((int)post.TipoLado)">
                            <button class="post-menu-item" onclick="irAPublicacion(@post.Id)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="3" x2="9" y2="21"></line>
                                </svg>
                                Ir a la publicacion
                            </button>
                            <button class="post-menu-item" onclick="copiarEnlace(@post.Id)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                Copiar enlace
                            </button>
                            <button class="post-menu-item" onclick="agregarFavorito(@post.Id, this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Agregar a favoritos
                            </button>
                            @if (usuarioActual?.Id != post.UsuarioId)
                            {
                                <div class="post-menu-divider"></div>
                                <button class="post-menu-item" onclick="dejarDeSeguir('@post.UsuarioId', @((int)post.TipoLado), this)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                    Dejar de seguir
                                </button>
                                <button class="post-menu-item danger" onclick="bloquearUsuario('@post.UsuarioId', '@(post.Usuario?.NombreCompleto ?? "este usuario")')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    Bloquear usuario
                                </button>
                                <button class="post-menu-item danger" onclick="reportarContenido(@post.Id)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                        <line x1="4" y1="22" x2="4" y2="15"></line>
                                    </svg>
                                    Reportar
                                </button>
                            }
                        </div>
                    </div>
                    </div>
                </header>

                <!-- Media -->
                @if (estaBloqueado)
                {
                    <!-- Contenido bloqueado con blur y candado -->
                    <div class="locked-content-wrapper" onclick="openSubscribeModal(this.closest('.post'))">
                        <div class="locked-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            EXCLUSIVO
                        </div>
                        @if (tieneArchivo)
                        {
                            var rutaArchivoLimpia = LimpiarRuta(rutaArchivoEfectiva);
                            <div class="post-media" style="aspect-ratio:1/1;max-width:100%;overflow:hidden;">
                                @if (esImagen || (!esVideo && !esAudio))
                                {
                                    <img src="@rutaArchivoLimpia" alt="" loading="lazy" style="max-width:100%;max-height:600px;width:100%;height:100%;object-fit:cover;display:block;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'media-error-placeholder\'></div>';">
                                }
                                else if (esVideo)
                                {
                                    @* iOS Safari requiere tipo MIME explícito *@
                                    var esWebm = rutaArchivoLimpia.EndsWith(".webm", StringComparison.OrdinalIgnoreCase);
                                    var esMp4 = rutaArchivoLimpia.EndsWith(".mp4", StringComparison.OrdinalIgnoreCase) ||
                                                rutaArchivoLimpia.EndsWith(".m4v", StringComparison.OrdinalIgnoreCase);
                                    var tipoMime = esWebm ? "video/webm" : "video/mp4";
                                    var posterUrl = !string.IsNullOrEmpty(post.Thumbnail) ? post.Thumbnail : "";
                                    <video class="feed-video"
                                           autoplay
                                           muted
                                           loop
                                           playsinline
                                           webkit-playsinline="true"
                                           x-webkit-airplay="allow"
                                           disablepictureinpicture
                                           disableremoteplayback
                                           preload="auto"
                                           data-post-id="@post.Id"
                                           poster="@posterUrl"
                                           style="background:#000;"
                                           onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'media-error-placeholder\'><svg viewBox=\'0 0 24 24\' fill=\'rgba(255,255,255,0.3)\'><path d=\'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z\'/></svg></div>';">
                                        @* Primero MP4 para iOS, luego WebM como fallback *@
                                        @if (!esWebm)
                                        {
                                            <source src="@rutaArchivoLimpia" type="video/mp4">
                                        }
                                        <source src="@rutaArchivoLimpia" type="@tipoMime">
                                    </video>
                                }
                                else if (esAudio)
                                {
                                    <div class="post-media-audio">
                                        <svg width="64" height="64" viewBox="0 0 24 24" fill="var(--primary)">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                        <audio src="@rutaArchivoLimpia" controls preload="metadata" onclick="event.stopPropagation()"></audio>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="post-text-content" style="min-height: 200px;">
                                @(post.Descripcion?.Length > 50 ? post.Descripcion.Substring(0, 50) + "..." : post.Descripcion)
                            </div>
                        }
                        <div class="locked-overlay">
                            <div class="locked-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                            </div>
                            <div class="locked-text">Contenido exclusivo de Lado B</div>
                            <button class="locked-subscribe-btn">Suscribirse para ver</button>
                        </div>
                    </div>
                }
                else if (esCarrusel)
                {
                    // Preparar datos JSON de archivos para el fullscreen viewer
                    var archivosJson = System.Text.Json.JsonSerializer.Serialize(archivosCarrusel.Select(a => new {
                        src = LimpiarRuta(a.RutaArchivo),
                        type = a.TipoArchivo == TipoArchivo.Video ? "video" : "image"
                    }));
                    var primerArchivo = archivosCarrusel.First();
                    var tipoPrimerArchivo = primerArchivo.TipoArchivo == TipoArchivo.Video ? "video" : "image";
                    <!-- Carrusel de múltiples archivos -->
                    <div class="post-carousel post-media"
                         data-post-id="@post.Id"
                         data-is-carousel="true"
                         data-carousel-files='@archivosJson'
                         data-media-type="@tipoPrimerArchivo"
                         data-media-src="@primerArchivo.RutaArchivo">
                        <div class="carousel-container">
                            <div class="carousel-track">
                                @for (int i = 0; i < archivosCarrusel.Count; i++)
                                {
                                    var archivo = archivosCarrusel[i];
                                    var esArchivoVideo = archivo.TipoArchivo == TipoArchivo.Video;
                                    var rutaArchivoCarrusel = LimpiarRuta(archivo.RutaArchivo);
                                    <div class="carousel-slide" data-index="@i">
                                        @if (esArchivoVideo)
                                        {
                                            @* iOS Safari requiere tipo MIME explícito *@
                                            var esWebmCarrusel = rutaArchivoCarrusel.EndsWith(".webm", StringComparison.OrdinalIgnoreCase);
                                            var tipoMimeCarrusel = esWebmCarrusel ? "video/webm" : "video/mp4";
                                            <video class="carousel-media feed-video"
                                                   autoplay
                                                   muted
                                                   loop
                                                   playsinline
                                                   webkit-playsinline="true"
                                                   x-webkit-airplay="allow"
                                                   disablepictureinpicture
                                                   disableremoteplayback
                                                   preload="auto"
                                                   data-post-id="@post.Id"
                                                   style="background:#000;"
                                                   onerror="this.parentElement.innerHTML='<div class=\'media-error-placeholder\'><svg viewBox=\'0 0 24 24\' fill=\'rgba(255,255,255,0.3)\'><path d=\'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z\'/></svg></div>';">
                                                @if (!esWebmCarrusel)
                                                {
                                                    <source src="@rutaArchivoCarrusel" type="video/mp4">
                                                }
                                                <source src="@rutaArchivoCarrusel" type="@tipoMimeCarrusel">
                                            </video>
                                            <div class="video-play-icon carousel-play-icon">
                                                <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                                <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                            </div>
                                        }
                                        else
                                        {
                                            <img src="@rutaArchivoCarrusel" alt="" class="carousel-media" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E';">
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <!-- Navegación del carrusel -->
                        @if (archivosCarrusel.Count > 1)
                        {
                            <button class="carousel-btn carousel-prev hidden" onclick="carouselPrev(event, this)">
                                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                            </button>
                            <button class="carousel-btn carousel-next" onclick="carouselNext(event, this)">
                                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                            </button>
                            <div class="carousel-dots">
                                @for (int i = 0; i < archivosCarrusel.Count; i++)
                                {
                                    <span class="carousel-dot @(i == 0 ? "active" : "")" data-index="@i"></span>
                                }
                            </div>
                            <div class="carousel-counter">1/@archivosCarrusel.Count</div>
                        }
                        @* Overlay de contenido sensible *@
                        @if (post.EsContenidoSensible)
                        {
                            <div class="sensitive-content-overlay" data-post-id="@post.Id">
                                <div class="sensitive-warning">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="sensitive-icon">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <line x1="2" y1="2" x2="22" y2="22"></line>
                                    </svg>
                                    <span class="sensitive-title">Contenido Delicado</span>
                                    <span class="sensitive-text">Esta foto incluye contenido delicado que algunas personas pueden encontrar ofensivo o molesto.</span>
                                    <button class="sensitive-reveal-btn" onclick="revelarContenidoSensible(event, @post.Id)">Ver</button>
                                </div>
                            </div>
                        }
                        @* Badge de música para carruseles *@
                        @if (post.PistaMusical != null)
                        {
                            <div class="music-badge" data-post-id="@post.Id">
                                <div class="music-badge-icon">
                                    <svg viewBox="0 0 24 24" fill="white">
                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                    </svg>
                                </div>
                                <div class="music-badge-info">
                                    <div class="music-badge-title">@post.PistaMusical.Titulo</div>
                                    <div class="music-badge-artist">@post.PistaMusical.Artista</div>
                                </div>
                            </div>
                            <audio class="photo-audio-player"
                                   data-post-id="@post.Id"
                                   src="@post.PistaMusical.RutaArchivo"
                                   preload="metadata"
                                   loop
                                   data-start="@(post.AudioTrimInicio ?? 0)"
                                   data-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                            </audio>
                            <!-- Botón mute para música de carrusel -->
                            <button class="photo-music-mute-btn" data-post-id="@post.Id" onclick="togglePhotoMusicMute(event, this)" title="Silenciar/Activar música">
                                <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                </svg>
                                <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>
                        }
                    </div>
                }
                else if (tieneArchivo)
                {
                    // Determinar clase de efecto blur
                    var blurEffectClass = esPreviewBlur ? tipoCensura switch
                    {
                        TipoCensuraPreview.Blur => "blur-effect",
                        TipoCensuraPreview.Pixelado => "pixelado-effect",
                        TipoCensuraPreview.Silueta => "silueta-effect",
                        TipoCensuraPreview.Parcial => "parcial-effect",
                        _ => "blur-effect"
                    } : "";

                    <div class="post-media @(esPreviewBlur ? "preview-blur-wrapper " + blurEffectClass : "")"
                         data-post-id="@post.Id"
                         data-media-type="@(esVideo ? "video" : (esAudio ? "audio" : "image"))"
                         data-media-src="@rutaArchivoEfectiva"
                         data-is-preview-blur="@esPreviewBlur.ToString().ToLower()"
                         @if (post.PistaMusical != null)
                         {
                             <text>data-audio-src="@post.PistaMusical.RutaArchivo"</text>
                             <text>data-audio-title="@post.PistaMusical.Titulo"</text>
                             <text>data-audio-artist="@post.PistaMusical.Artista"</text>
                             <text>data-audio-start="@(post.AudioTrimInicio ?? 0)"</text>
                             <text>data-audio-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))"</text>
                         }
                         @if (!esPreviewBlur)
                         {
                            <text>onclick="openFullscreenViewer(event, @post.Id)"</text>
                         }
                         style="cursor:pointer;max-width:100%;overflow:hidden;">
                        @if (esPreviewBlur)
                        {
                            <!-- Badge LadoB -->
                            <div class="ladob-preview-badge">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                LadoB
                            </div>
                            <!-- Overlay con botón -->
                            <div class="preview-blur-overlay">
                                <div class="preview-blur-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <div class="preview-blur-text">Contenido Exclusivo</div>
                                <div class="preview-blur-subtext">Disponible en LadoB de @nombreUsuario</div>
                                <a href="/Feed/Creador/@(post.Usuario?.Seudonimo)" class="preview-blur-btn" onclick="event.stopPropagation();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polygon points="10,8 16,12 10,16"/>
                                    </svg>
                                    Ver en LadoB
                                </a>
                            </div>
                        }
                        @{var rutaPostMedia = LimpiarRuta(rutaArchivoEfectiva);}
                        @if (esImagen)
                        {
                            <img src="@rutaPostMedia" alt="" loading="lazy" class="carousel-media" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E';">
                            @if (!string.IsNullOrEmpty(post.NombreUbicacion))
                            {
                                <!-- Badge de ubicación -->
                                <div class="location-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span>@post.NombreUbicacion</span>
                                </div>
                            }
                            @if (post.PistaMusical != null)
                            {
                                <!-- Badge de música estilo Instagram para foto -->
                                <div class="music-badge" data-post-id="@post.Id">
                                    <div class="music-badge-icon">
                                        <svg viewBox="0 0 24 24" fill="white">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                    </div>
                                    <div class="music-badge-info">
                                        <div class="music-badge-title">@post.PistaMusical.Titulo</div>
                                        <div class="music-badge-artist">@post.PistaMusical.Artista</div>
                                    </div>
                                </div>
                                <!-- Botón mute para música de foto -->
                                <button class="photo-music-mute-btn" data-post-id="@post.Id" onclick="togglePhotoMusicMute(event, this)" title="Silenciar/Activar música">
                                    <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                    </svg>
                                    <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                                <!-- Audio oculto para reproducción -->
                                <audio class="photo-audio-player"
                                       data-post-id="@post.Id"
                                       src="@post.PistaMusical.RutaArchivo"
                                       preload="metadata"
                                       loop
                                       data-start="@(post.AudioTrimInicio ?? 0)"
                                       data-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                                </audio>
                            }
                        }
                        else if (esVideo)
                        {
                            @* iOS Safari requiere MIME type explícito en <source> *@
                            var esWebmPost = rutaPostMedia.EndsWith(".webm", StringComparison.OrdinalIgnoreCase);
                            var tipoMimePost = esWebmPost ? "video/webm" : "video/mp4";
                            <video class="feed-video"
                                   autoplay
                                   muted
                                   loop
                                   playsinline
                                   webkit-playsinline="true"
                                   x-webkit-airplay="allow"
                                   disablepictureinpicture
                                   disableremoteplayback
                                   preload="metadata"
                                   data-post-id="@post.Id"
                                   poster="@(post.Thumbnail ?? "")"
                                   onerror="this.parentElement.innerHTML='<div class=\'media-error-placeholder\'><svg viewBox=\'0 0 24 24\' fill=\'rgba(255,255,255,0.3)\'><path d=\'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z\'/></svg></div>';">
                                @if (!esWebmPost)
                                {
                                    <source src="@rutaPostMedia" type="video/mp4">
                                }
                                <source src="@rutaPostMedia" type="@tipoMimePost">
                            </video>
                            <div class="video-controls-overlay" onclick="handleVideoClick(event, this)">
                                <div class="video-play-icon">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </div>
                                <button class="video-mute-btn" onclick="toggleVideoMute(event, this)" title="Activar/Desactivar sonido">
                                    <svg class="muted-icon" viewBox="0 0 24 24" fill="white">
                                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                    </svg>
                                    <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            </div>
                        }
                        else if (esAudio)
                        {
                            <div class="post-media-audio" data-post-id="@post.Id">
                                <div class="audio-visual">
                                    <svg class="audio-icon" viewBox="0 0 24 24" fill="var(--primary)">
                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                    </svg>
                                    <div class="audio-waves">
                                        <span></span><span></span><span></span><span></span><span></span>
                                    </div>
                                </div>
                                <audio class="post-audio-player" src="@rutaPostMedia" preload="metadata" data-post-id="@post.Id"></audio>
                                <div class="audio-controls-overlay">
                                    <button class="audio-play-btn" onclick="toggleAudioPlay(event, this)" title="Reproducir/Pausar">
                                        <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                        <svg class="icon-pause" viewBox="0 0 24 24" fill="white" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                    </button>
                                    <button class="audio-mute-btn" onclick="toggleAudioMute(event, this)" title="Activar/Desactivar sonido">
                                        <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                        </svg>
                                        <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white">
                                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="audio-progress">
                                    <div class="audio-progress-bar"></div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <img src="@rutaPostMedia" alt="" loading="lazy" class="carousel-media" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E';">
                            @if (!string.IsNullOrEmpty(post.NombreUbicacion))
                            {
                                <!-- Badge de ubicación -->
                                <div class="location-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span>@post.NombreUbicacion</span>
                                </div>
                            }
                            @if (post.PistaMusical != null)
                            {
                                <!-- Badge de música estilo Instagram -->
                                <div class="music-badge" data-post-id="@post.Id">
                                    <div class="music-badge-icon">
                                        <svg viewBox="0 0 24 24" fill="white">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                        </svg>
                                    </div>
                                    <div class="music-badge-info">
                                        <div class="music-badge-title">@post.PistaMusical.Titulo</div>
                                        <div class="music-badge-artist">@post.PistaMusical.Artista</div>
                                    </div>
                                </div>
                                <!-- Audio oculto para reproducción -->
                                <audio class="photo-audio-player"
                                       data-post-id="@post.Id"
                                       src="@post.PistaMusical.RutaArchivo"
                                       preload="metadata"
                                       loop
                                       data-start="@(post.AudioTrimInicio ?? 0)"
                                       data-volume="@(((double)(post.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                                </audio>
                            }
                        }
                        @* Overlay de contenido sensible *@
                        @if (post.EsContenidoSensible)
                        {
                            <div class="sensitive-content-overlay" data-post-id="@post.Id">
                                <div class="sensitive-warning">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="sensitive-icon">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <line x1="2" y1="2" x2="22" y2="22"></line>
                                    </svg>
                                    <span class="sensitive-title">Contenido Delicado</span>
                                    <span class="sensitive-text">Esta foto incluye contenido delicado que algunas personas pueden encontrar ofensivo o molesto.</span>
                                    <button class="sensitive-reveal-btn" onclick="revelarContenidoSensible(event, @post.Id)">Ver</button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (esPost && !string.IsNullOrEmpty(post.Descripcion))
                {
                    <div class="post-text-content">
                        @post.Descripcion
                    </div>
                }

                <!-- Actions -->
                <div class="post-actions">
                    <button class="action-btn like-btn @(yaLeDioLike ? "liked" : "")" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <button class="action-btn comment-btn" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn share-btn" data-id="@post.Id">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <div class="action-spacer"></div>
                    <button class="action-btn bookmark-btn @(esFavorito ? "bookmarked" : "")" data-id="@post.Id" title="@(esFavorito ? "Quitar de favoritos" : "Guardar en favoritos")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <button class="action-btn detail-btn" data-id="@post.Id" title="Ver detalle" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                    </button>
                </div>

                <!-- Likes -->
                <div class="post-likes">
                    <span class="post-likes-count" id="likes-@post.Id">@post.NumeroLikes Me gusta</span>
                </div>

                <!-- Caption -->
                @if (!string.IsNullOrEmpty(post.Descripcion) && tieneArchivo)
                {
                    <div class="post-caption">
                        <p class="post-caption-text">
                            <span class="post-caption-username">@usernameMostrado</span>@post.Descripcion
                        </p>
                    </div>
                }

                <!-- Comments Preview - Estilo Instagram -->
                @if (post.Comentarios != null && post.Comentarios.Any())
                {
                    <div class="post-comments-preview">
                        @if (post.NumeroComentarios > 2)
                        {
                            <div class="view-all-comments" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                Ver los @post.NumeroComentarios comentarios
                            </div>
                        }
                        @foreach (var comment in post.Comentarios.Where(c => c.ComentarioPadreId == null).Take(2))
                        {
                            var tcDiff = DateTime.Now - comment.FechaCreacion;
                            var tcTexto = tcDiff.TotalDays >= 1 ? $"{(int)tcDiff.TotalDays}d" :
                                tcDiff.TotalHours >= 1 ? $"{(int)tcDiff.TotalHours}h" : $"{(int)tcDiff.TotalMinutes}m";
                            var numRespuestas = post.Comentarios.Count(c => c.ComentarioPadreId == comment.Id);

                            <div class="feed-comment-item" data-comment-id="@comment.Id">
                                <div class="feed-comment-avatar">
                                    @if (!string.IsNullOrEmpty(comment.Usuario?.FotoPerfil))
                                    {
                                        <img src="@comment.Usuario.FotoPerfil" alt="Foto de @(comment.Usuario?.UserName ?? "usuario")">
                                    }
                                    else
                                    {
                                        <div class="feed-comment-avatar-initial">@(comment.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "U")</div>
                                    }
                                </div>
                                <div class="feed-comment-content">
                                    <div class="feed-comment-header">
                                        <a href="/Feed/Perfil/@comment.Usuario?.UserName" class="feed-comment-username">@(comment.Usuario?.UserName ?? "usuario")</a>
                                        <span class="feed-comment-time">@tcTexto</span>
                                    </div>
                                    <p class="feed-comment-text">@comment.Texto</p>
                                    <div class="feed-comment-actions">
                                        <button class="feed-comment-action-btn like-btn" onclick="toggleFeedCommentLike(@comment.Id, this)" data-comment-id="@comment.Id">
                                            <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                            <span class="count">@(comment.NumeroLikes > 0 ? comment.NumeroLikes.ToString() : "")</span>
                                        </button>
                                        <button class="feed-comment-action-btn" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                            <span class="count">@(numRespuestas > 0 ? numRespuestas.ToString() : "")</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            @if (numRespuestas > 0)
                            {
                                <div class="feed-show-replies" onclick="window.location.href='/Feed/Detalle/@post.Id'">
                                    <div class="feed-reply-avatars">
                                        @foreach (var resp in post.Comentarios.Where(c => c.ComentarioPadreId == comment.Id).Take(2))
                                        {
                                            if (!string.IsNullOrEmpty(resp.Usuario?.FotoPerfil))
                                            {
                                                <img src="@resp.Usuario.FotoPerfil" alt="">
                                            }
                                        }
                                    </div>
                                    <span>Mostrar respuestas</span>
                                </div>
                            }
                        }
                    </div>
                }

                <!-- Add Comment -->
                <div class="post-add-comment">
                    <input type="text" class="comment-input" placeholder="Agrega un comentario..." data-post-id="@post.Id">
                    <button class="comment-post-btn" data-post-id="@post.Id" disabled>Publicar</button>
                </div>

                <!-- Timestamp -->
                <div class="post-timestamp">
                    @post.FechaPublicacion.ToString("dd MMMM yyyy").ToUpper()
                </div>
            </article>

            @* Insertar anuncio cada N posts *@
            postIndex++;
            if (postIndex % insertarAnuncioCada == 0 && anuncioIndex < anuncios.Count)
            {
                var anuncioFeed = anuncios[anuncioIndex];
                anuncioIndex++;

                <article class="post-ad">
                    <div class="post-ad-header">
                        <div class="post-ad-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                            </svg>
                        </div>
                        <div class="post-ad-info">
                            <div class="post-ad-label">Patrocinado</div>
                            <div class="post-ad-badge">
                                <i class="fas fa-ad"></i>
                                <span>Publicidad</span>
                            </div>
                        </div>
                    </div>
                    <div class="post-ad-media-container" style="position: relative;">
                        <a href="@Url.Action("RedirectAnuncio", "FeedPublico", new { id = anuncioFeed.Id })" target="_blank" class="post-ad-media">
                            @if (anuncioFeed.TipoCreativo == TipoCreativo.Video && !string.IsNullOrEmpty(anuncioFeed.UrlCreativo))
                            {
                                var urlCreativoLimpio = Url.Content($"~{anuncioFeed.UrlCreativo}");
                                var esWebmAnuncio = anuncioFeed.UrlCreativo.EndsWith(".webm", StringComparison.OrdinalIgnoreCase);
                                var tipoMimeAnuncio = esWebmAnuncio ? "video/webm" : "video/mp4";
                                <video class="ad-video" muted autoplay loop playsinline webkit-playsinline="true" preload="metadata">
                                    @if (!esWebmAnuncio)
                                    {
                                        <source src="@urlCreativoLimpio" type="video/mp4">
                                    }
                                    <source src="@urlCreativoLimpio" type="@tipoMimeAnuncio">
                                </video>
                            }
                            else if (!string.IsNullOrEmpty(anuncioFeed.UrlCreativo))
                            {
                                <img src="@Url.Content($"~{anuncioFeed.UrlCreativo}")" alt="Anuncio">
                            }
                        </a>
                        @if (anuncioFeed.TipoCreativo == TipoCreativo.Video)
                        {
                            <button type="button" class="ad-sound-toggle" onclick="toggleAdSound(this, event)" title="Activar/Desactivar sonido">
                                <i class="fas fa-volume-mute"></i>
                            </button>
                        }
                    </div>
                    <div class="post-ad-content">
                        <a href="@Url.Action("RedirectAnuncio", "FeedPublico", new { id = anuncioFeed.Id })" target="_blank" class="post-ad-cta">
                            @anuncioFeed.TextoBotonDisplay
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </article>
            }

            @* Insertar sugerencias inline (mobile) después del 3er post *@
            if (postIndex == 3 && creadoresSugeridos.Any())
            {
                var mobileCardsPerPage = 3;
                var mobileTotalPages = (int)Math.Ceiling((double)creadoresSugeridos.Count / mobileCardsPerPage);

                <div class="suggestions-inline-mobile" id="suggestionsInlineMobile">
                    <div class="suggestions-section" data-suggestions="mobile">
                        <div class="suggestions-section-title">Creadores sugeridos</div>
                        <div class="suggestions-pages-wrap">
                            @for (var mPageIdx = 0; mPageIdx < mobileTotalPages; mPageIdx++)
                            {
                                var mPageItems = creadoresSugeridos.Skip(mPageIdx * mobileCardsPerPage).Take(mobileCardsPerPage).ToList();
                                <div class="suggestions-page @(mPageIdx == 0 ? "is-active" : "")" data-page="@mPageIdx">
                                    @foreach (var creador in mPageItems)
                                    {
                                        var inicialMobile = !string.IsNullOrEmpty(creador.NombreMostrar) ? creador.NombreMostrar.Substring(0, 1).ToUpper() : "?";
                                        <div class="suggestion-card" data-user-id="@creador.Id">
                                            <div class="suggestion-card-cover">
                                                @if (!string.IsNullOrEmpty(creador.FotoPortada))
                                                {
                                                    <img class="suggestion-card-bg" src="@creador.FotoPortada" alt="" loading="lazy">
                                                }
                                                <button class="suggestion-card-dismiss" onclick="descartarSugerencia('@creador.Id', this)" title="No me interesa">&times;</button>
                                                <div class="suggestion-card-avatar-wrap">
                                                    @if (!string.IsNullOrEmpty(creador.FotoPerfil))
                                                    {
                                                        <img src="@creador.FotoPerfil" alt="" class="suggestion-card-avatar" loading="lazy">
                                                    }
                                                    else
                                                    {
                                                        <div class="suggestion-card-avatar-placeholder">@inicialMobile</div>
                                                    }
                                                    @if (creador.TextoActividad == "Activo ahora")
                                                    {
                                                        <span class="suggestion-card-activity"></span>
                                                    }
                                                </div>
                                                <button class="suggestion-card-follow" data-user-id="@creador.Id"
                                                        onclick="seguirUsuarioCard('@creador.Id', this)">
                                                    Seguir
                                                </button>
                                                <div class="suggestion-card-info">
                                                    <a href="@creador.UrlPerfil" class="suggestion-card-name">@creador.NombreMostrar</a>
                                                    <div class="suggestion-card-username">@@@creador.UserName</div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        @if (mobileTotalPages > 1)
                        {
                            <div class="suggestions-nav">
                                <button class="suggestions-nav-btn" data-dir="prev" onclick="navigateSuggestions(this, -1)" disabled>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                </button>
                                <div class="suggestions-dots">
                                    @for (var dm = 0; dm < mobileTotalPages; dm++)
                                    {
                                        <span class="suggestions-dot @(dm == 0 ? "is-active" : "")"></span>
                                    }
                                </div>
                                <button class="suggestions-nav-btn" data-dir="next" onclick="navigateSuggestions(this, 1)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }
    else
    {
        <div class="empty-feed">
            <h3>Tu feed esta vacio</h3>
            <p>Sigue a creadores para ver su contenido aqui</p>
            <a href="/Feed/Explorar" class="empty-feed-btn">Explorar creadores</a>
        </div>
    }
    </div><!-- /#postsContainer -->

    <!-- Infinite Scroll Loader -->
    <div class="infinite-scroll-loader" id="infiniteScrollLoader">
        <div class="loader-spinner"></div>
    </div>
    <div class="infinite-scroll-end" id="infiniteScrollEnd" style="display: none;">
        Has llegado al final del feed
    </div>

        </div><!-- /.feed-container -->
    </div><!-- /.feed-main -->

    <!-- SIDEBAR -->
    <aside class="feed-sidebar">
        <!-- Usuario actual -->
        @if (usuarioActual != null)
        {
            <div class="sidebar-section">
                <a href="/Feed/Perfil/@usuarioActual.Id" class="sidebar-user" style="text-decoration: none;">
                    @if (!string.IsNullOrEmpty(usuarioActual.FotoPerfil))
                    {
                        <img src="@usuarioActual.FotoPerfil" alt="" class="sidebar-user-avatar">
                    }
                    else
                    {
                        <div class="sidebar-user-avatar-placeholder">
                            @usuarioActual.NombreCompleto.Substring(0, 1).ToUpper()
                        </div>
                    }
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">@usuarioActual.UserName</div>
                        <div class="sidebar-user-username">@usuarioActual.NombreCompleto</div>
                    </div>
                </a>
            </div>
        }

        <!-- Creadores sugeridos - Cards verticales con paginación -->
        @if (creadoresSugeridos.Any())
        {
            var cardsPerPage = 3;
            var totalPages = (int)Math.Ceiling((double)creadoresSugeridos.Count / cardsPerPage);

            <div class="suggestions-section" data-suggestions="desktop">
                <div class="suggestions-section-title">Creadores sugeridos</div>
                <div class="suggestions-pages-wrap">
                    @for (var pageIdx = 0; pageIdx < totalPages; pageIdx++)
                    {
                        var pageItems = creadoresSugeridos.Skip(pageIdx * cardsPerPage).Take(cardsPerPage).ToList();
                        <div class="suggestions-page @(pageIdx == 0 ? "is-active" : "")" data-page="@pageIdx">
                            @foreach (var creador in pageItems)
                            {
                                var inicialMostrar = !string.IsNullOrEmpty(creador.NombreMostrar) ? creador.NombreMostrar.Substring(0, 1).ToUpper() : "?";
                                <div class="suggestion-card" data-user-id="@creador.Id">
                                    <div class="suggestion-card-cover">
                                        @if (!string.IsNullOrEmpty(creador.FotoPortada))
                                        {
                                            <img class="suggestion-card-bg" src="@creador.FotoPortada" alt="" loading="lazy">
                                        }
                                        <button class="suggestion-card-dismiss" onclick="descartarSugerencia('@creador.Id', this)" title="No me interesa">&times;</button>
                                        <div class="suggestion-card-avatar-wrap">
                                            @if (!string.IsNullOrEmpty(creador.FotoPerfil))
                                            {
                                                <img src="@creador.FotoPerfil" alt="" class="suggestion-card-avatar" loading="lazy">
                                            }
                                            else
                                            {
                                                <div class="suggestion-card-avatar-placeholder">@inicialMostrar</div>
                                            }
                                            @if (creador.TextoActividad == "Activo ahora")
                                            {
                                                <span class="suggestion-card-activity"></span>
                                            }
                                        </div>
                                        <button class="suggestion-card-follow" data-user-id="@creador.Id"
                                                onclick="seguirUsuarioCard('@creador.Id', this)">
                                            Seguir
                                        </button>
                                        <div class="suggestion-card-info">
                                            <a href="@creador.UrlPerfil" class="suggestion-card-name">@creador.NombreMostrar</a>
                                            <div class="suggestion-card-username">@@@creador.UserName</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                @if (totalPages > 1)
                {
                    <div class="suggestions-nav">
                        <button class="suggestions-nav-btn" data-dir="prev" onclick="navigateSuggestions(this, -1)" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <div class="suggestions-dots">
                            @for (var d = 0; d < totalPages; d++)
                            {
                                <span class="suggestions-dot @(d == 0 ? "is-active" : "")"></span>
                            }
                        </div>
                        <button class="suggestions-nav-btn" data-dir="next" onclick="navigateSuggestions(this, 1)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                }
            </div>
        }

        <div class="sidebar-footer">
            <a href="#">Acerca de</a> ·
            <a href="#">Ayuda</a> ·
            <a href="#">Privacidad</a> ·
            <a href="#">Terminos</a>
            <br>
            © 2024 Lado
        </div>
    </aside>
</div><!-- /.feed-page-layout -->

<!-- Share Modal - Estilo Instagram -->
<div class="modal-overlay" id="shareModal" onclick="if(event.target === this) closeShareModal()">
    <div class="share-modal">
        <!-- Header -->
        <div class="share-modal-header">
            <button class="share-modal-close" onclick="closeShareModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            Compartir
        </div>

        <!-- Mensaje de restricción -->
        <div class="share-restriction-msg" id="shareRestrictionMsg">
            Solo puedes agregar tus propios posts a tu historia
        </div>

        <!-- Buscador -->
        <div class="share-search-box">
            <div class="share-search-wrapper">
                <svg class="share-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" class="share-search-input" id="shareSearchInput" placeholder="Buscar">
            </div>
        </div>

        <!-- Grid de contactos -->
        <div class="share-contacts-grid" id="shareContactsGrid">
            <div class="share-contacts-empty">Cargando contactos...</div>
        </div>

        <!-- Barra inferior de apps -->
        <div class="share-apps-bar">
            <div class="share-app-item" onclick="copyShareUrl()">
                <div class="share-app-icon link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                </div>
                <span class="share-app-label">Copiar enlace</span>
            </div>
            <div class="share-app-item" id="shareAsStory" onclick="compartirComoStory()">
                <div class="share-app-icon story">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </div>
                <span class="share-app-label">Historia</span>
            </div>
            <a class="share-app-item" id="shareWhatsApp" target="_blank">
                <div class="share-app-icon whatsapp">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                </div>
                <span class="share-app-label">WhatsApp</span>
            </a>
            <a class="share-app-item" id="shareTelegram" target="_blank">
                <div class="share-app-icon telegram">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                    </svg>
                </div>
                <span class="share-app-label">Telegram</span>
            </a>
            <a class="share-app-item" id="shareEmail" href="" target="_blank">
                <div class="share-app-icon email">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </div>
                <span class="share-app-label">Email</span>
            </a>
            <a class="share-app-item" id="shareTwitter" target="_blank">
                <div class="share-app-icon twitter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </div>
                <span class="share-app-label">X</span>
            </a>
        </div>
    </div>
</div>
<!-- Input oculto para URL -->
<input type="hidden" id="shareUrlInput" value="">

<!-- MODAL DE REPORTES ESTILO INSTAGRAM -->
<div class="report-modal-overlay" id="reportModal">
    <div class="report-modal">
        <!-- Header -->
        <div class="report-modal-header">
            <div style="width: 32px;"></div>
            <span class="report-modal-title">Reportar</span>
            <button class="report-modal-close" onclick="closeReportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Contenido principal -->
        <div id="reportMainContent">
            <div class="report-modal-subtitle">
                ¿Por qué quieres reportar esta publicación?
            </div>

            <div class="report-options">
                <!-- Opcion 1: No me gusta -->
                <button class="report-option" onclick="selectReportReason('No me gusta', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Simplemente no me gusta</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 2: Bullying -->
                <button class="report-option" onclick="selectReportReason('Bullying o acoso', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Bullying o contacto no deseado</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 3: Autolesion -->
                <button class="report-option" onclick="selectReportReason('Autolesión o suicidio', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Suicidio, autolesión o trastornos alimentarios</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 4: Violencia -->
                <button class="report-option" onclick="showReportSuboptions('violencia')">
                    <div class="report-option-content">
                        <div class="report-option-title">Violencia, odio o explotación</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 5: Venta restringida -->
                <button class="report-option" onclick="selectReportReason('Venta de artículos restringidos', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Venta o promoción de artículos restringidos</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 6: Contenido sexual -->
                <button class="report-option" onclick="showReportSuboptions('sexual')">
                    <div class="report-option-content">
                        <div class="report-option-title">Desnudos o actividad sexual</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 7: Spam -->
                <button class="report-option" onclick="selectReportReason('Estafa, fraude o spam', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Estafa, fraude o spam</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 8: Info falsa -->
                <button class="report-option" onclick="selectReportReason('Información falsa', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Información falsa</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 9: Suplantación -->
                <button class="report-option" onclick="selectReportReason('Suplantación de identidad', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Suplantación de identidad</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 10: Propiedad intelectual -->
                <button class="report-option" onclick="selectReportReason('Infracción de propiedad intelectual', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Infracción de propiedad intelectual</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>

                <!-- Opcion 11: Otro -->
                <button class="report-option" onclick="selectReportReason('Otro motivo', true)">
                    <div class="report-option-content">
                        <div class="report-option-title">Otro motivo</div>
                    </div>
                    <div class="report-option-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- Subopciones: Violencia -->
        <div class="report-suboptions" id="reportSubViolencia">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title">Violencia, odio o explotación</div>
            <div class="report-options">
                <button class="report-option" onclick="selectReportReason('Violencia gráfica', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Violencia gráfica</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Amenazas de violencia', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Amenazas de violencia</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Discurso de odio', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Discurso de odio o símbolos</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Crueldad animal', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Crueldad o maltrato animal</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Explotación de menores', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Explotación de menores</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Terrorismo o extremismo', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Terrorismo o extremismo</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Subopciones: Sexual -->
        <div class="report-suboptions" id="reportSubSexual">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title">Desnudos o actividad sexual</div>
            <div class="report-options">
                <button class="report-option" onclick="selectReportReason('Desnudos no solicitados', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Desnudos sin consentimiento</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Contenido sexual explícito', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Actividad sexual explícita</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Solicitud sexual', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Solicitud o explotación sexual</div>
                    </div>
                </button>
                <button class="report-option" onclick="selectReportReason('Contenido sexual de menores', false)">
                    <div class="report-option-content">
                        <div class="report-option-title">Involucramiento de menores</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Paso 2: Detalles adicionales -->
        <div class="report-suboptions" id="reportDetailsStep">
            <button class="report-back-btn" onclick="showMainReportOptions()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
            </button>
            <div class="report-category-title" id="selectedReasonTitle">Motivo seleccionado</div>

            <div class="report-textarea-container show">
                <textarea
                    class="report-textarea"
                    id="reportDetails"
                    placeholder="Describe con más detalle el problema (opcional)..."
                    maxlength="500"></textarea>
            </div>

            <div class="report-submit-container show">
                <button class="report-submit-btn" id="submitReportBtn" onclick="submitReport()">
                    Enviar reporte
                </button>
            </div>
        </div>

        <!-- Confirmación -->
        <div class="report-confirmation" id="reportConfirmation">
            <div class="report-confirmation-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="report-confirmation-title">Gracias por informarnos</div>
            <div class="report-confirmation-text">
                Tu reporte nos ayuda a mantener la comunidad segura.
                Revisaremos este contenido y tomaremos las medidas necesarias.
            </div>
            <button class="report-confirmation-btn" onclick="closeReportModal()">
                Listo
            </button>
        </div>
    </div>
</div>

<!-- TOOLTIP DE LIKES (Desktop) -->
<div class="likes-tooltip" id="likesTooltip">
    <div class="likes-tooltip-header" id="likesTooltipHeader">Me gusta</div>
    <div class="likes-tooltip-list" id="likesTooltipList">
        <div class="likes-tooltip-loading">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </div>
</div>

<!-- MODAL DE LIKES (Móvil) -->
<div class="likes-modal-overlay" id="likesModalOverlay" onclick="closeLikesModal()">
    <div class="likes-modal" onclick="event.stopPropagation()">
        <div class="likes-modal-header">
            <span class="likes-modal-title">Me gusta</span>
            <button class="likes-modal-close" onclick="closeLikesModal()">&times;</button>
        </div>
        <div class="likes-modal-content">
            <div class="likes-modal-list" id="likesModalList">
                <div class="likes-tooltip-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetTimeAgo(DateTime fecha)
    {
        var diff = DateTime.Now - fecha;
        if (diff.TotalDays >= 7) return fecha.ToString("dd MMM");
        if (diff.TotalDays >= 1) return $"Hace {(int)diff.TotalDays}d";
        if (diff.TotalHours >= 1) return $"Hace {(int)diff.TotalHours}h";
        if (diff.TotalMinutes >= 1) return $"Hace {(int)diff.TotalMinutes}m";
        return "Ahora";
    }
}

<script>
    let currentShareUrl = '';
    let currentSharePostId = null;

    // Set global para debounce de likes (evitar spam)
    const likeInProgress = new Set();

    // Función de escape para prevenir XSS
    // ⚠️ GLOBAL para que otros scripts puedan usarla
    window.escapeHtml = function(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };
    // Alias local para compatibilidad
    const escapeHtml = window.escapeHtml;

    // Toast simple para el feed (función interna)
    function _feedToast(msg) {
        const existingToast = document.querySelector('.feed-toast');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.className = 'feed-toast';
        toast.textContent = msg;
        toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface);color:var(--fg);padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;font-size:14px;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Exponer como showToast local y global
    function showToast(msg) {
        _feedToast(msg);
    }

    // Sobrescribir window.showToast para compatibilidad con layout
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            window.showToast = function(type, title, msg) {
                _feedToast(msg || title || type);
            };
        }, 100);
    });

    // ========================================
    // SCROLL AL POST DESDE HASH (para volver del fullscreen)
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Detectar si hay un hash #post-{id} en la URL
        const hash = window.location.hash;
        if (hash && hash.startsWith('#post-')) {
            const postElement = document.querySelector(hash);
            if (postElement) {
                // Delay suficiente para que el DOM esté completamente renderizado
                setTimeout(() => {
                    // Asegurar que no hay estado residual de fullscreen
                    document.body.classList.remove('fullscreen-active', 'fullscreen-mode');
                    document.documentElement.classList.remove('fullscreen-active');
                    document.body.style.overflow = '';

                    // Scroll al post
                    postElement.scrollIntoView({ behavior: 'instant', block: 'center' });

                    // Limpiar el hash de la URL sin recargar
                    setTimeout(() => {
                        history.replaceState(null, '', window.location.pathname + window.location.search);
                    }, 100);
                }, 300);
            }
        }
    });

    // ========================================
    // LIKES EN COMENTARIOS DEL FEED
    // ========================================

    // ⚠️ GLOBAL para onclick en HTML
    window.toggleFeedCommentLike = async function(comentarioId, btn) {
        try {
            const svg = btn.querySelector('svg');
            const countSpan = btn.querySelector('.count');
            const isLiked = svg.classList.contains('liked');

            // Actualización optimista
            if (isLiked) {
                svg.classList.remove('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount > 1 ? currentCount - 1 : '';
            } else {
                svg.classList.add('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount + 1;
            }

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const response = await fetch('/Feed/ToggleLikeComentario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comentarioId=${comentarioId}&__RequestVerificationToken=${encodeURIComponent(token || '')}`
            });

            const data = await response.json();

            if (data.success) {
                countSpan.textContent = data.likes > 0 ? data.likes : '';
                if (data.meDioLike) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            } else {
                // Revertir
                if (isLiked) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            }
        } catch (error) {
        }
    };

    // ========================================
    // LISTA DE USUARIOS SEGUIDOS (para botón Seguir)
    // ========================================
    let usuariosSeguidosIds = @Html.Raw(Json.Serialize(usuariosSeguidosIds));

    // ========================================
    // PULL TO REFRESH & INFINITE SCROLL
    // ⚡ MEJORADO: Mayor sensibilidad, haptic feedback, mejor UX
    // ========================================
    let isLoadingMore = false;
    let hasMorePosts = @(Model.Count() > 10 ? "true" : "false");
    let isPulling = false;
    let pullStartY = 0;
    let pullDistance = 0;
    const PULL_THRESHOLD = 50; // ⚡ Reducido de 80 a 50 para mayor sensibilidad
    let hasTriggeredHaptic = false; // Para evitar múltiples vibraciones

    // ⚡ NUEVO: Set de IDs de posts ya cargados (evita duplicados)
    const loadedPostIds = new Set();

    // Inicializar con los posts ya cargados en el servidor
    function initLoadedPostIds() {
        document.querySelectorAll('.post[data-post-id]').forEach(post => {
            const postId = parseInt(post.dataset.postId);
            if (!isNaN(postId)) {
                loadedPostIds.add(postId);
            }
        });
        console.log('[Feed] Posts iniciales cargados:', loadedPostIds.size);
    }

    // Llamar al cargar la página
    initLoadedPostIds();

    // ⚡ Haptic feedback (vibración táctil)
    function triggerHaptic() {
        if (hasTriggeredHaptic) return;
        hasTriggeredHaptic = true;

        if ('vibrate' in navigator) {
            navigator.vibrate(15); // Vibración corta de 15ms
        }
    }

    // Pull to Refresh - MEJORADO
    function initPullToRefresh() {
        const pullIndicator = document.getElementById('pullToRefresh');
        const pullText = document.getElementById('pullText');
        const feedMain = document.querySelector('.feed-main');

        if (!pullIndicator || !feedMain) return;

        let touchStartY = 0;
        let touchCurrentY = 0;
        let isRefreshing = false;

        // Detectar si estamos en la parte superior (con tolerancia para iOS bounce)
        function isAtTop() {
            const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            return scrollY <= 10; // ⚡ Aumentado tolerancia a 10px
        }

        // Actualizar texto según estado
        function updatePullText(state) {
            if (!pullText) return;
            switch(state) {
                case 'pull':
                    pullText.textContent = 'Desliza para actualizar';
                    break;
                case 'ready':
                    pullText.textContent = '¡Suelta para actualizar!';
                    break;
                case 'refreshing':
                    pullText.textContent = 'Actualizando...';
                    break;
            }
        }

        // Escuchar en window para mejor compatibilidad móvil
        window.addEventListener('touchstart', (e) => {
            if (isAtTop() && !isRefreshing) {
                touchStartY = e.touches[0].clientY;
                isPulling = true;
                hasTriggeredHaptic = false; // Reset haptic flag
            }
        }, { passive: true });

        window.addEventListener('touchmove', (e) => {
            if (!isPulling || isRefreshing) return;

            // Si el usuario hizo scroll hacia abajo, cancelar pull
            if (!isAtTop() && pullDistance <= 0) {
                isPulling = false;
                pullIndicator.classList.remove('visible', 'ready');
                return;
            }

            touchCurrentY = e.touches[0].clientY;
            pullDistance = touchCurrentY - touchStartY;

            if (pullDistance > 0 && pullDistance < 200) {
                pullIndicator.classList.add('visible');

                // ⚡ Resistencia mejorada: más natural al principio
                const resistance = 0.6;
                const translateY = Math.min(pullDistance * resistance, 80);
                pullIndicator.style.transform = `translateX(-50%) translateY(${translateY}px)`;

                // Rotar el icono proporcionalmente
                const rotation = Math.min((pullDistance / PULL_THRESHOLD) * 180, 180);
                pullIndicator.querySelector('svg').style.transform = `rotate(${rotation}deg)`;

                if (pullDistance > PULL_THRESHOLD) {
                    pullIndicator.classList.add('ready');
                    updatePullText('ready');
                    triggerHaptic(); // ⚡ Vibración al alcanzar threshold
                } else {
                    pullIndicator.classList.remove('ready');
                    updatePullText('pull');
                }
            } else if (pullDistance <= 0) {
                pullIndicator.classList.remove('visible', 'ready');
            }
        }, { passive: true });

        window.addEventListener('touchend', () => {
            if (!isPulling || isRefreshing) return;

            if (pullDistance > PULL_THRESHOLD) {
                isRefreshing = true;
                updatePullText('refreshing');
                pullIndicator.classList.add('refreshing');
                pullIndicator.classList.remove('ready');
                pullIndicator.style.transform = 'translateX(-50%) translateY(30px)';
                pullIndicator.querySelector('svg').style.transform = '';

                refreshFeed().finally(() => {
                    isRefreshing = false;
                    pullIndicator.classList.remove('visible', 'ready', 'refreshing');
                    pullIndicator.style.transform = 'translateX(-50%) translateY(-100%)';
                    updatePullText('pull');
                });
            } else {
                pullIndicator.classList.remove('visible', 'ready');
                pullIndicator.style.transform = 'translateX(-50%) translateY(-100%)';
                pullIndicator.querySelector('svg').style.transform = '';
            }
            isPulling = false;
            pullDistance = 0;
        });
    }

    async function refreshFeed() {
        const pullIndicator = document.getElementById('pullToRefresh');
        pullIndicator.classList.remove('ready');
        pullIndicator.classList.add('refreshing');

        try {
            // ⚡ FIX: Enviar IDs ya vistos para que el servidor los excluya y devuelva posts nuevos
            const idsVistosParam = Array.from(loadedPostIds).slice(0, 100).join(',');
            const response = await fetch(`/Feed/CargarMasPosts?cantidad=10&idsVistos=${encodeURIComponent(idsVistosParam)}`);
            const data = await response.json();

            if (data.success && data.posts.length > 0) {
                const postsContainer = document.getElementById('postsContainer');

                // Solo agregar posts que no existen en loadedPostIds
                let newPostsHtml = '';
                let newCount = 0;
                data.posts.forEach(post => {
                    if (!loadedPostIds.has(post.id)) {
                        newPostsHtml += renderPost(post);
                        loadedPostIds.add(post.id); // Registrar nuevo ID
                        newCount++;
                    }
                });

                if (newPostsHtml) {
                    // Agregar al inicio
                    postsContainer.insertAdjacentHTML('afterbegin', newPostsHtml);

                    // Inicializar observers para nuevos posts
                    initVideoObserversForNewPosts();
                    if (typeof initCarousels === 'function') {
                        initCarousels();
                    }

                }
            }

            // Scroll suave al inicio si hay nuevos posts
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            console.error('[Feed] Error en refreshFeed:', error);
        } finally {
            pullIndicator.classList.remove('refreshing', 'visible');
            pullIndicator.style.transform = 'translateX(-50%) translateY(-100%)';
        }
    }

    // Infinite Scroll
    function initInfiniteScroll() {
        const loader = document.getElementById('infiniteScrollLoader');
        const endMessage = document.getElementById('infiniteScrollEnd');
        const postsContainer = document.getElementById('postsContainer');

        if (!loader || !postsContainer) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !isLoadingMore && hasMorePosts) {
                    loadMorePosts();
                }
            });
        }, { rootMargin: '200px' }); // Cargar antes de llegar al final

        observer.observe(loader);
    }

    let loadRetryCount = 0;
    const MAX_RETRIES = 3;

    async function loadMorePosts(isRetry = false) {
        if (isLoadingMore || !hasMorePosts) return;

        isLoadingMore = true;
        const loader = document.getElementById('infiniteScrollLoader');
        const endMessage = document.getElementById('infiniteScrollEnd');

        loader.classList.add('visible');
        hideLoadError(); // Ocultar error previo si existe

        try {
            // ⚡ MEJORADO: Enviar IDs ya vistos al servidor
            const idsVistosParam = Array.from(loadedPostIds).join(',');

            // Fetch con timeout de 15 segundos
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            // ⚡ Usar nuevo endpoint con IDs ya vistos
            const response = await fetch(`/Feed/CargarMasPosts?cantidad=10&idsVistos=${encodeURIComponent(idsVistosParam)}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.posts.length > 0) {
                const postsContainer = document.getElementById('postsContainer');
                let nuevosAgregados = 0;

                data.posts.forEach(post => {
                    // Solo agregar si no existe (doble verificación)
                    if (!loadedPostIds.has(post.id)) {
                        const postHtml = renderPost(post);
                        postsContainer.insertAdjacentHTML('beforeend', postHtml);
                        loadedPostIds.add(post.id); // Registrar nuevo ID
                        nuevosAgregados++;
                    }
                });

                console.log('[Feed] Cargados', nuevosAgregados, 'posts nuevos. Total:', loadedPostIds.size);

                hasMorePosts = data.hayMas;
                loadRetryCount = 0; // Reset retry count on success

                // Reinicializar carruseles y observers para los nuevos posts
                if (typeof initCarousels === 'function') {
                    initCarousels();
                }

                // Reinicializar video observers
                initVideoObserversForNewPosts();

                // Reinicializar observers de música en fotos
                if (typeof initPhotoMusicObserversForNewPosts === 'function') {
                    initPhotoMusicObserversForNewPosts();
                }

                // Limpiar observers antiguos para evitar memory leak
                cleanupOldObservers();

            } else {
                hasMorePosts = false;
            }

            if (!hasMorePosts) {
                loader.style.display = 'none';
                endMessage.style.display = 'block';
            }

        } catch (error) {
            console.error('[Feed] Error cargando más posts:', error);
            loadRetryCount++;

            // Reintentar automáticamente hasta MAX_RETRIES
            if (loadRetryCount < MAX_RETRIES && !isRetry) {
                isLoadingMore = false;
                setTimeout(() => loadMorePosts(true), 2000);
                return;
            }

            // Mostrar mensaje de error con opción de reintentar
            showLoadError();
        } finally {
            isLoadingMore = false;
            loader.classList.remove('visible');
        }
    }

    function showLoadError() {
        let errorDiv = document.getElementById('loadErrorMessage');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'loadErrorMessage';
            errorDiv.style.cssText = 'text-align:center;padding:20px;color:#888;';
            errorDiv.innerHTML = `
                <p style="margin-bottom:10px;">No se pudieron cargar más publicaciones</p>
                <button onclick="retryLoad()" style="background:var(--primary-color,#e91e63);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;">
                    Reintentar
                </button>
            `;
            const loader = document.getElementById('infiniteScrollLoader');
            loader.parentNode.insertBefore(errorDiv, loader.nextSibling);
        }
        errorDiv.style.display = 'block';
    }

    function hideLoadError() {
        const errorDiv = document.getElementById('loadErrorMessage');
        if (errorDiv) errorDiv.style.display = 'none';
    }

    function retryLoad() {
        loadRetryCount = 0;
        loadMorePosts();
    }

    // Función para limpiar comillas de rutas (datos legacy)
    function limpiarRuta(ruta) {
        if (!ruta) return '';
        return ruta.replace(/^"|"$/g, '');
    }

    function renderPost(post) {
        const tiempoTexto = getTimeAgo(new Date(post.fechaPublicacion));
        const urlPerfil = post.tipoLado === 1
            ? `/Feed/Perfil/${post.usuarioId}?verSeudonimo=true`
            : `/Feed/Perfil/${post.usuarioId}`;
        const nombreMostrado = post.tipoLado === 1 ? (post.seudonimo || 'Anónimo') : post.nombreCompleto;
        const fotoPerfilMostrar = post.tipoLado === 1 ? (post.fotoPerfilLadoB || post.fotoPerfil) : post.fotoPerfil;
        const usernameMostrado = post.tipoLado === 1 ? (post.seudonimo || 'Anónimo') : post.username;

        // Limpiar rutas de archivos
        const rutaArchivoLimpia = limpiarRuta(post.rutaArchivo);

        let mediaHtml = '';

        // Si está bloqueado, mostrar con blur y candado
        if (post.estaBloqueado) {
            const seudonimo = post.seudonimo || 'este creador';
            mediaHtml = `
                <div class="locked-content-wrapper" onclick="openSubscribeModal(this.closest('.post'))">
                    <div class="locked-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        EXCLUSIVO
                    </div>
                    <div class="post-media" style="aspect-ratio:1/1;max-width:100%;overflow:hidden;">
                        ${post.esVideo
                            ? `<video class="feed-video" muted loop playsinline poster="${post.thumbnail || ''}" style="filter:blur(20px);transform:scale(1.1);">
                                   <source src="${rutaArchivoLimpia}" type="video/mp4">
                               </video>`
                            : `<img src="${rutaArchivoLimpia}" alt="" loading="lazy" style="filter:blur(20px);transform:scale(1.1);max-width:100%;max-height:600px;width:100%;height:100%;object-fit:cover;display:block;">`
                        }
                    </div>
                    <div class="locked-overlay">
                        <div class="locked-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <div class="locked-text">Contenido exclusivo de Lado B</div>
                        <button class="locked-subscribe-btn">Suscribirse para ver</button>
                    </div>
                </div>`;
        } else if (rutaArchivoLimpia) {
            if (post.esCarrusel && post.archivos.length > 1) {
                // Convertir archivos al formato esperado por el fullscreen viewer
                const archivosParaFullscreen = post.archivos.map(a => ({
                    src: limpiarRuta(a.rutaArchivo),
                    type: a.tipoArchivo === 1 ? 'video' : 'image'
                }));
                const archivosJson = JSON.stringify(archivosParaFullscreen).replace(/"/g, '&quot;');

                // Construir badges y audio para carruseles con música
                let carouselMusicHtml = '';
                if (post.pistaMusical) {
                    carouselMusicHtml = `
                        <div class="music-badge" data-post-id="${post.id}">
                            <div class="music-badge-icon">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                            </div>
                            <div class="music-badge-info">
                                <div class="music-badge-title">${escapeHtml(post.pistaMusical.titulo || '')}</div>
                                <div class="music-badge-artist">${escapeHtml(post.pistaMusical.artista || '')}</div>
                            </div>
                        </div>
                        <audio class="photo-audio-player"
                               data-post-id="${post.id}"
                               src="${limpiarRuta(post.pistaMusical.rutaArchivo)}"
                               preload="metadata"
                               loop
                               data-start="${post.audioTrimInicio || 0}"
                               data-volume="${post.musicaVolumen || 0.7}">
                        </audio>
                        <button class="photo-music-mute-btn" data-post-id="${post.id}" onclick="togglePhotoMusicMute(event, this)" title="Silenciar/Activar música">
                            <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'block' : 'none'};">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                            </svg>
                            <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'none' : 'block'};">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </button>`;
                }

                // Generar slides del carrusel
                const slidesHtml = post.archivos.map((archivo, idx) => {
                    const rutaArchivo = limpiarRuta(archivo.rutaArchivo);
                    const esVideo = archivo.tipoArchivo === 1; // TipoArchivo.Video = 1
                    if (esVideo) {
                        const esWebm = rutaArchivo.toLowerCase().endsWith('.webm');
                        const mimeType = esWebm ? 'video/webm' : 'video/mp4';
                        return `<div class="carousel-slide" data-index="${idx}">
                            <video class="carousel-media feed-video" autoplay muted loop playsinline webkit-playsinline="true" preload="auto" style="background:#000;">
                                ${!esWebm ? `<source src="${rutaArchivo}" type="video/mp4">` : ''}
                                <source src="${rutaArchivo}" type="${mimeType}">
                            </video>
                        </div>`;
                    } else {
                        return `<div class="carousel-slide" data-index="${idx}">
                            <img src="${rutaArchivo}" alt="" class="carousel-media" loading="lazy">
                        </div>`;
                    }
                }).join('');

                // Generar dots
                const dotsHtml = post.archivos.map((_, idx) =>
                    `<span class="carousel-dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>`
                ).join('');

                mediaHtml = `
                    <div class="post-carousel post-media"
                         data-post-id="${post.id}"
                         data-is-carousel="true"
                         data-carousel-files='${archivosJson}'
                         data-media-type="${post.archivos[0].tipoArchivo === 1 ? 'video' : 'image'}"
                         data-media-src="${limpiarRuta(post.archivos[0].rutaArchivo)}">
                        <div class="carousel-container">
                            <div class="carousel-track">
                                ${slidesHtml}
                            </div>
                        </div>
                        <button class="carousel-btn carousel-prev hidden" onclick="carouselPrev(event, this)">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <button class="carousel-btn carousel-next" onclick="carouselNext(event, this)">
                            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </button>
                        <div class="carousel-dots">
                            ${dotsHtml}
                        </div>
                        <div class="carousel-counter">1/${post.archivos.length}</div>
                        ${carouselMusicHtml}
                    </div>`;
            } else if (post.esVideo) {
                // iOS Safari requiere MIME type explícito en <source>
                const isWebmFeed = rutaArchivoLimpia.toLowerCase().endsWith('.webm');
                const mimeTypeFeed = isWebmFeed ? 'video/webm' : 'video/mp4';
                const posterAttrFeed = post.thumbnail ? `poster="${post.thumbnail}"` : '';
                mediaHtml = `
                    <div class="post-media video-paused"
                         data-post-id="${post.id}"
                         data-media-type="video"
                         data-media-src="${rutaArchivoLimpia}"
                         onclick="openFullscreenViewer(event, ${post.id})"
                         style="cursor: pointer;">
                        <video class="feed-video" autoplay muted loop playsinline webkit-playsinline="true" x-webkit-airplay="allow" disablepictureinpicture disableremoteplayback preload="metadata" data-post-id="${post.id}" ${posterAttrFeed} onerror="this.parentElement.innerHTML='<div class=\\'media-error-placeholder\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'rgba(255,255,255,0.3)\\'><path d=\\'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z\\'/></svg></div>';">
                            ${!isWebmFeed ? `<source src="${rutaArchivoLimpia}" type="video/mp4">` : ''}
                            <source src="${rutaArchivoLimpia}" type="${mimeTypeFeed}">
                        </video>
                        <div class="video-controls-overlay" onclick="handleVideoClick(event, this)">
                            <div class="video-play-icon">
                                <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                <svg class="icon-pause" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </div>
                            <button class="video-mute-btn" onclick="toggleVideoMute(event, this)" title="Activar/Desactivar sonido">
                                <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'block' : 'none'};">
                                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                </svg>
                                <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'none' : 'block'};">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>
                        </div>
                    </div>`;
            } else if (post.esAudio) {
                // Posts de tipo audio con controles
                mediaHtml = `
                    <div class="post-media"
                         data-post-id="${post.id}"
                         data-media-type="audio">
                        <div class="post-media-audio" data-post-id="${post.id}">
                            <div class="audio-visual">
                                <svg class="audio-icon" viewBox="0 0 24 24" fill="var(--primary)">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                                <div class="audio-waves">
                                    <span></span><span></span><span></span><span></span><span></span>
                                </div>
                            </div>
                            <audio class="post-audio-player" src="${rutaArchivoLimpia}" preload="metadata" data-post-id="${post.id}"></audio>
                            <div class="audio-controls-overlay">
                                <button class="audio-play-btn" onclick="toggleAudioPlay(event, this)" title="Reproducir/Pausar">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="white" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </button>
                                <button class="audio-mute-btn" onclick="toggleAudioMute(event, this)" title="Activar/Desactivar sonido">
                                    <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:none;">
                                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                                    </svg>
                                    <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="audio-progress">
                                <div class="audio-progress-bar"></div>
                            </div>
                        </div>
                    </div>`;
            } else {
                // Construir badges y audio para imágenes
                let musicBadgeHtml = '';
                let photoAudioHtml = '';
                if (post.pistaMusical) {
                    musicBadgeHtml = `
                        <div class="music-badge" data-post-id="${post.id}">
                            <div class="music-badge-icon">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                            </div>
                            <div class="music-badge-info">
                                <div class="music-badge-title">${escapeHtml(post.pistaMusical.titulo || '')}</div>
                                <div class="music-badge-artist">${escapeHtml(post.pistaMusical.artista || '')}</div>
                            </div>
                        </div>`;
                    photoAudioHtml = `
                        <audio class="photo-audio-player"
                               data-post-id="${post.id}"
                               src="${limpiarRuta(post.pistaMusical.rutaArchivo)}"
                               preload="metadata"
                               loop
                               data-start="${post.audioTrimInicio || 0}"
                               data-volume="${post.musicaVolumen || 0.7}">
                        </audio>
                        <button class="photo-music-mute-btn" data-post-id="${post.id}" onclick="togglePhotoMusicMute(event, this)" title="Silenciar/Activar música">
                            <svg class="muted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'block' : 'none'};">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                            </svg>
                            <svg class="unmuted-icon" viewBox="0 0 24 24" fill="white" style="display:${isGlobalMuted ? 'none' : 'block'};">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </button>`;
                }

                mediaHtml = `
                    <div class="post-media"
                         data-post-id="${post.id}"
                         data-media-type="image"
                         data-media-src="${rutaArchivoLimpia}"
                         onclick="openFullscreenViewer(event, ${post.id})"
                         style="cursor:pointer;max-width:100%;overflow:hidden;">
                        <img src="${rutaArchivoLimpia}" alt="" loading="lazy" style="max-width:100%;max-height:600px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E';">
                        ${post.nombreUbicacion ? `
                        <div class="location-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span>${escapeHtml(post.nombreUbicacion)}</span>
                        </div>` : ''}
                        ${musicBadgeHtml}
                        ${photoAudioHtml}
                    </div>`;
            }
        }

        const avatarHtml = fotoPerfilMostrar
            ? `<img src="${fotoPerfilMostrar}" alt="" class="post-avatar" loading="lazy">`
            : `<div class="post-avatar-placeholder">${nombreMostrado.substring(0, 1).toUpperCase()}</div>`;

        // Determinar si se debe mostrar el botón Seguir
        const currentUserId = '@(usuarioActual?.Id ?? "")';
        const isOwnPost = currentUserId === post.usuarioId;
        const isFollowing = usuariosSeguidosIds.includes(post.usuarioId);
        const showFollowBtn = currentUserId && !isOwnPost && !isFollowing;

        return `
            <article id="post-${post.id}" class="post" data-post-id="${post.id}" data-creator-id="${post.usuarioId}" data-creator-name="${escapeHtml(nombreMostrado)}" data-creator-photo="${fotoPerfilMostrar || ''}" data-likes="${post.numeroLikes || 0}" data-comments="${post.numeroComentarios || 0}" data-is-following="${isFollowing}">
                <header class="post-header">
                    <a href="${urlPerfil}" class="post-header-left">
                        ${avatarHtml}
                        <div class="post-user-info">
                            <span class="post-username">
                                ${usernameMostrado}
                                ${post.verificado ? '<img src="/images/verified-badge.png" alt="Verificado" class="verified-icon" title="Creador verificado">' : ''}
                            </span>
                            <span class="post-time">${tiempoTexto}</span>
                        </div>
                    </a>
                    <div class="post-header-right">
                        ${showFollowBtn ? `<button class="post-follow-btn" onclick="seguirDesdeHeader(event, '${post.usuarioId}', ${post.tipoLado}, this)">Seguir</button>` : ''}
                        <div class="post-menu" onclick="togglePostMenu(event, this)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="1.5"></circle>
                            <circle cx="6" cy="12" r="1.5"></circle>
                            <circle cx="18" cy="12" r="1.5"></circle>
                        </svg>
                        <div class="post-menu-dropdown" data-post-id="${post.id}" data-user-id="${post.usuarioId}" data-tipo-lado="${post.tipoLado}">
                            <button class="post-menu-item" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="3" x2="9" y2="21"></line>
                                </svg>
                                <span>Ver publicación</span>
                            </button>
                            <button class="post-menu-item" onclick="copiarEnlace(${post.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                <span>Copiar enlace</span>
                            </button>
                            <button class="post-menu-item" onclick="compartirContenido(${post.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="18" cy="5" r="3"></circle>
                                    <circle cx="6" cy="12" r="3"></circle>
                                    <circle cx="18" cy="19" r="3"></circle>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                </svg>
                                <span>Compartir</span>
                            </button>
                        </div>
                    </div>
                    </div>
                </header>

                ${mediaHtml}

                <div class="post-actions">
                    <button class="action-btn like-btn ${post.yaLeDioLike ? 'liked' : ''}" data-id="${post.id}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <button class="action-btn comment-btn" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn share-btn" onclick="compartirContenido(${post.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>

                <div class="post-likes">
                    <span class="post-likes-count" id="likes-${post.id}">${post.numeroLikes} Me gusta</span>
                </div>

                ${post.descripcion ? `
                <div class="post-caption">
                    <p class="post-caption-text">
                        <span class="post-caption-username">${escapeHtml(usernameMostrado)}</span>${escapeHtml(post.descripcion)}
                    </p>
                </div>` : ''}

                ${post.comentarios && post.comentarios.length > 0 ? `
                <div class="post-comments-preview">
                    ${post.numeroComentarios > 2 ? `
                    <div class="view-all-comments" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                        Ver los ${post.numeroComentarios} comentarios
                    </div>` : ''}
                    ${post.comentarios.map(comment => {
                        const tcDiff = Date.now() - new Date(comment.fechaCreacion).getTime();
                        const tcTexto = tcDiff >= 86400000 ? Math.floor(tcDiff / 86400000) + 'd' :
                            tcDiff >= 3600000 ? Math.floor(tcDiff / 3600000) + 'h' : Math.floor(tcDiff / 60000) + 'm';
                        return `
                        <div class="feed-comment-item" data-comment-id="${comment.id}">
                            <div class="feed-comment-avatar">
                                ${comment.usuario?.fotoPerfil
                                    ? `<img src="${comment.usuario.fotoPerfil}" alt="Foto de ${comment.usuario?.userName || 'usuario'}">`
                                    : `<div class="feed-comment-avatar-initial">${(comment.usuario?.userName || 'U').substring(0, 1).toUpperCase()}</div>`
                                }
                            </div>
                            <div class="feed-comment-content">
                                <div class="feed-comment-header">
                                    <a href="/Feed/Perfil/${comment.usuario?.userName}" class="feed-comment-username">${comment.usuario?.userName || 'usuario'}</a>
                                    <span class="feed-comment-time">${tcTexto}</span>
                                </div>
                                <p class="feed-comment-text">${escapeHtml(comment.texto)}</p>
                                <div class="feed-comment-actions">
                                    <button class="feed-comment-action-btn like-btn" onclick="toggleFeedCommentLike(${comment.id}, this)" data-comment-id="${comment.id}">
                                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                        <span class="count">${comment.numeroLikes > 0 ? comment.numeroLikes : ''}</span>
                                    </button>
                                    <button class="feed-comment-action-btn" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                                        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                        <span class="count">${comment.numRespuestas > 0 ? comment.numRespuestas : ''}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${comment.numRespuestas > 0 ? `
                        <div class="feed-show-replies" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                            <div class="feed-reply-avatars">
                                ${(comment.respuestas || []).map(resp =>
                                    resp.usuario?.fotoPerfil ? `<img src="${resp.usuario.fotoPerfil}" alt="">` : ''
                                ).join('')}
                            </div>
                            <span>Mostrar respuestas</span>
                        </div>` : ''}
                        `;
                    }).join('')}
                </div>` : (post.numeroComentarios > 0 ? `
                <div class="post-comments-preview">
                    <div class="view-all-comments" onclick="window.location.href='/Feed/Detalle/${post.id}'">
                        Ver los ${post.numeroComentarios} comentarios
                    </div>
                </div>` : '')}

                <div class="post-add-comment">
                    <input type="text" class="comment-input" placeholder="Agrega un comentario..." data-post-id="${post.id}">
                    <button class="comment-post-btn" data-post-id="${post.id}" disabled>Publicar</button>
                </div>

                <div class="post-timestamp">
                    ${new Date(post.fechaPublicacion).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase()}
                </div>
            </article>
        `;
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Ahora';
        if (diffMins < 60) return `${diffMins}m`;
        if (diffHours < 24) return `${diffHours}h`;
        if (diffDays < 7) return `${diffDays}d`;
        return `${Math.floor(diffDays / 7)}sem`;
    }

    // ========================================
    // SISTEMA DE VIDEO - OPTIMIZADO PARA iOS
    // ========================================

    let activeVideoObservers = 0;
    const MAX_VIDEO_OBSERVERS = 30;
    let isGlobalMuted = true;

    // Deteccion de iOS/iPadOS (incluye iPadOS 13+)
    const isIOSDevice = (() => {
        const ua = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
        const isIPadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
                         (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
        return isIOS || isIPadOS;
    })();

    // Safari detection
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // Videos pausados manualmente por el usuario (no autoplay)
    const manuallyPausedVideos = new Set();

    // Actualizar estado visual del video
    function updateVideoState(video, isPlaying) {
        const postMedia = video?.closest('.post-media');
        if (!postMedia) return;

        if (isPlaying) {
            postMedia.classList.remove('video-paused');
            postMedia.classList.add('video-playing');
        } else {
            postMedia.classList.remove('video-playing');
            postMedia.classList.add('video-paused');
        }
    }

    // Pausar todos los videos excepto uno
    function pauseAllVideosExcept(exceptVideo) {
        document.querySelectorAll('.feed-video').forEach(v => {
            if (v !== exceptVideo && !v.paused) {
                v.pause();
                updateVideoState(v, false);
            }
        });
    }

    // Reproducir video - estrategia IGUAL que fullscreen (que funciona bien en iOS)
    async function playVideo(video, retryCount = 0) {
        const postMedia = video?.closest('.post-media');
        const postId = video?.getAttribute('data-post-id') || 'unknown';
        const MAX_RETRIES = 2;

        if (!video || !postMedia) {
            return false;
        }

        // Preparar atributos iOS si es necesario
        if (isIOSDevice && window.iOSMediaFix?.enhance) {
            window.iOSMediaFix.enhance(video);
        }

        // Asegurar atributos críticos
        video.playsInline = true;
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');

        // Si el video no tiene src o readyState es 0, cargarlo
        if (video.readyState < 1) {
            video.preload = 'auto';
            video.load();
        }

        // ESTRATEGIA EXACTA DEL FULLSCREEN (líneas 12627-12641):
        // 1. Primero intentar SIN mute (para que tenga audio)
        // 2. Si falla, reintentar CON mute
        const tryPlay = async () => {
            try {
                // Intento 1: SIN mute (como fullscreen)
                video.muted = isGlobalMuted;
                await video.play();
                postMedia.classList.remove('needs-tap', 'video-paused', 'video-loading');
                postMedia.classList.add('video-playing');
                return true;
            } catch (e) {
                // Intento 2: CON mute (fallback como fullscreen)
                try {
                    video.muted = true;
                    await video.play();
                    postMedia.classList.remove('needs-tap', 'video-paused', 'video-loading');
                    postMedia.classList.add('video-playing');
                    return true;
                } catch (e2) {
                    return false;
                }
            }
        };

        let success = await tryPlay();

        // Si falló y no hemos agotado reintentos, esperar y reintentar
        if (!success && retryCount < MAX_RETRIES) {
            // Esperar 500ms antes de reintentar (backoff)
            await new Promise(r => setTimeout(r, 500 * (retryCount + 1)));
            return playVideo(video, retryCount + 1);
        }

        if (!success) {
            // Falló después de todos los reintentos - mostrar needs-tap
            postMedia.classList.remove('video-playing', 'video-loading');
            postMedia.classList.add('video-paused', 'needs-tap');
        }

        return success;
    }

    // Flag global para indicar que hubo double-tap reciente (evita play/pause en videos)
    window._doubleTapJustFired = false;

    // Handler para click en overlay de video
    // Tap en cualquier parte = abrir FullView (igual que fotos, estilo Instagram)
    // Double-tap = like (manejado por el handler global de double-tap)
    // ⚠️ GLOBAL para que onclick del HTML pueda accederla
    window.handleVideoClick = function(event, overlay) {
        event.stopPropagation();

        // Si hubo double-tap reciente, ignorar este click
        if (window._doubleTapJustFired) {
            window._doubleTapJustFired = false;
            return;
        }

        // Si clickeó en el botón de mute, ignorar (tiene su propio handler)
        if (event.target.closest('.video-mute-btn')) {
            return;
        }

        event.preventDefault();

        // Tap en cualquier parte del video = abrir FullView (igual que las fotos)
        const postMedia = overlay.closest('.post-media');
        const postCard = postMedia?.closest('.post-card, .post, [data-post-id]');
        const postId = postCard?.dataset?.postId || postMedia?.dataset?.postId;

        if (postId && typeof window.openFullscreenViewer === 'function') {
            window.openFullscreenViewer(event, parseInt(postId));
        }
    };

    // Actualizar iconos de mute
    function updateAllMuteIcons() {
        // Actualizar iconos de video
        document.querySelectorAll('.video-mute-btn').forEach(btn => {
            const mi = btn.querySelector('.muted-icon');
            const ui = btn.querySelector('.unmuted-icon');
            if (mi && ui) {
                mi.style.display = isGlobalMuted ? 'block' : 'none';
                ui.style.display = isGlobalMuted ? 'none' : 'block';
            }
        });
        // Actualizar iconos de música de foto
        document.querySelectorAll('.photo-music-mute-btn').forEach(btn => {
            const mi = btn.querySelector('.muted-icon');
            const ui = btn.querySelector('.unmuted-icon');
            if (mi && ui) {
                mi.style.display = isGlobalMuted ? 'block' : 'none';
                ui.style.display = isGlobalMuted ? 'none' : 'block';
            }
        });
    }

    // ========================================
    // SCROLL DEBOUNCE (como fullscreen)
    // ========================================
    let isFeedScrolling = false;
    let feedScrollTimeout = null;
    let pendingVideoToPlay = null;

    // Detectar scroll para aplicar debounce
    const feedContainer = document.querySelector('.feed-container') || document.querySelector('.feed-main');
    if (feedContainer) {
        window.addEventListener('scroll', () => {
            isFeedScrolling = true;
            clearTimeout(feedScrollTimeout);

            feedScrollTimeout = setTimeout(() => {
                isFeedScrolling = false;
                // Reproducir el video pendiente después del debounce
                if (pendingVideoToPlay) {
                    const video = pendingVideoToPlay;
                    pendingVideoToPlay = null;
                    // Pausar TODOS antes de reproducir (como fullscreen)
                    pauseAllVideosExcept(video);
                    playVideo(video);
                }
            }, 150); // 150ms debounce como fullscreen
        }, { passive: true });
    }

    // Intersection Observer para autoplay (mejorado como fullscreen)
    const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            const videoId = video.getAttribute('data-post-id') || video.src;

            if (entry.isIntersecting) {
                // No reproducir si el usuario lo pausó manualmente
                if (manuallyPausedVideos.has(videoId)) {
                    return;
                }

                // Si estamos scrolleando, guardar para después del debounce
                if (isFeedScrolling) {
                    pendingVideoToPlay = video;
                    return;
                }

                // Pausar TODOS antes de reproducir (como fullscreen)
                pauseAllVideosExcept(video);
                playVideo(video);
            } else {
                // Al salir del viewport, limpiar pausa manual y pausar
                manuallyPausedVideos.delete(videoId);
                video.pause();
                updateVideoState(video, false);

                // Si era el video pendiente, limpiar
                if (pendingVideoToPlay === video) {
                    pendingVideoToPlay = null;
                }
            }
        });
    }, {
        root: null,
        rootMargin: '0px',
        threshold: 0.7  // Aumentado de 0.5 a 0.7 (70% visible)
    });

    // Preload observer - rootMargin reducido para móviles para evitar sobrecargar la red
    const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const preloadMargin = isMobileDevice ? '200px' : '500px'; // Menor margen en móvil

    const videoPreloadObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                // Cambiar a preload auto para que iOS descargue el video
                video.preload = 'auto';
                // Asegurar que esté muted para autoplay en iOS
                video.muted = true;
                if (video.readyState < 1) {
                    video.load();
                }
                videoPreloadObserver.unobserve(video);
            }
        });
    }, { rootMargin: preloadMargin });

    function initVideoObserversForNewPosts() {
        document.querySelectorAll('.post-media video.feed-video:not([data-observed])').forEach(video => {
            video.setAttribute('data-observed', 'true');
            video.dataset.loadStartTime = Date.now();

            const postId = video.getAttribute('data-post-id') || 'unknown';
            const videoSrc = video.currentSrc || video.querySelector('source')?.src || '';

            // Log inicial: verificar si el video tiene src válido
            if (!videoSrc || videoSrc.endsWith('/Feed') || videoSrc.includes('undefined')) {
                if (window.ladoLog) {
                    window.ladoLog.error(`Video inicializado sin src válido post:${postId}`, {
                        postId,
                        src: videoSrc || 'EMPTY',
                        sourceElements: video.querySelectorAll('source').length,
                        videoHTML: video.outerHTML.substring(0, 400)
                    });
                }
            }

            // 🍎 iOS: Usar iOSMediaFix.enhance() para configurar atributos correctamente
            if (window.iOSMediaFix?.isIOS) {
                window.iOSMediaFix.enhance(video);
            }

            // Forzar atributos para iOS (también aplica si no hay iOSMediaFix)
            video.playsInline = true;
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            // IMPORTANTE: Iniciar siempre muted para que autoplay funcione
            video.muted = true;
            video.loop = true; // Los videos del feed deben hacer loop

            // En desktop: dejar que autoplay funcione naturalmente
            // En iOS: desactivar autoplay y controlar manualmente (políticas más estrictas)
            if (isIOSDevice) {
                video.autoplay = false; // iOS requiere control manual
            }
            // En desktop, el autoplay HTML (muted+playsinline) debe funcionar

            // Eventos de estado
            video.addEventListener('playing', () => {
                updateVideoState(video, true);
                const postMedia = video.closest('.post-media');
                if (postMedia) {
                    postMedia.classList.remove('video-loading');
                    postMedia.classList.remove('needs-tap');
                }
            });
            video.addEventListener('pause', () => {
                updateVideoState(video, false);
            });
            video.addEventListener('waiting', () => {
                video.closest('.post-media')?.classList.add('video-loading');
            });

            // Fallback: reiniciar si el video termina (por si loop no funciona)
            video.addEventListener('ended', () => {
                video.currentTime = 0;
                // Solo reproducir si está visible
                const rect = video.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
                if (isVisible) {
                    playVideo(video);
                }
            });

            // iOS fix: Forzar repaint cuando el video carga para evitar pantalla negra
            video.addEventListener('loadeddata', () => {
                const postMedia = video.closest('.post-media');
                if (postMedia) {
                    postMedia.classList.remove('video-loading');
                }
                // Forzar repaint en iOS
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    video.style.opacity = '0.99';
                    requestAnimationFrame(() => {
                        video.style.opacity = '1';
                    });
                }
            });

            // iOS fix: También en canplay
            video.addEventListener('canplay', () => {
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    video.style.transform = 'translateZ(0)';
                }
            });

            // Manejar errores en elementos <source>
            // NOTA: En iOS Chrome, source error puede dispararse aunque otra fuente funcione
            // Solo loguear si TODAS las fuentes fallan (video.error existe)
            video.querySelectorAll('source').forEach((source, index, sources) => {
                source.addEventListener('error', (e) => {
                    // Solo reportar si es la última fuente Y el video tiene error real
                    const isLastSource = index === sources.length - 1;
                    if (isLastSource && video.error) {
                        const postId = video.getAttribute('data-post-id') || 'unknown';
                        const srcUrl = source.src || 'unknown';
                        if (window.ladoLog) {
                            window.ladoLog.error(`Video source error (404 o formato) post:${postId}`, {
                                postId,
                                src: srcUrl.substring(0, 200),
                                type: source.type || 'unknown',
                                videoError: video.error?.code
                            });
                        }
                    }
                });
            });

            // Manejar errores de carga - remover spinner y mostrar estado de error
            video.addEventListener('error', (e) => {
                const postMedia = video.closest('.post-media');
                const postId = video.getAttribute('data-post-id') || 'unknown';
                const videoSrc = video.currentSrc || video.querySelector('source')?.src || 'no-src';
                const errorCode = video.error?.code;
                const errorMessage = video.error?.message || 'Unknown error';

                // Interpretar código de error
                const errorDescriptions = {
                    1: 'MEDIA_ERR_ABORTED - Carga abortada',
                    2: 'MEDIA_ERR_NETWORK - Error de red',
                    3: 'MEDIA_ERR_DECODE - Error de decodificación',
                    4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - Formato no soportado o archivo no encontrado (404)'
                };

                // Log detallado del error
                if (window.ladoLog) {
                    window.ladoLog.error(`Video error post:${postId}`, {
                        postId: postId,
                        src: videoSrc.substring(0, 200),
                        errorCode: errorCode,
                        errorDescription: errorDescriptions[errorCode] || 'Error desconocido',
                        errorMessage: errorMessage,
                        readyState: video.readyState,
                        networkState: video.networkState,
                        userAgent: navigator.userAgent.substring(0, 150)
                    });
                }

                if (postMedia) {
                    postMedia.classList.remove('video-loading');
                    postMedia.classList.add('video-error');

                    // Handler para reintentar con click/tap
                    const retryHandler = () => {
                        if (postMedia.classList.contains('video-error')) {
                            postMedia.classList.remove('video-error');
                            postMedia.classList.add('video-loading');
                            video.load();
                            playVideo(video);
                        }
                        postMedia.removeEventListener('click', retryHandler);
                    };
                    postMedia.addEventListener('click', retryHandler, { once: true });

                    // También reintentar automáticamente después de 5 segundos
                    setTimeout(() => {
                        if (postMedia.classList.contains('video-error')) {
                            postMedia.classList.remove('video-error');
                            video.load();
                        }
                    }, 5000);
                }
            });

            // timeupdate: se dispara constantemente mientras el video reproduce
            // Esto asegura que el estado visual se mantenga correcto en iOS
            video.addEventListener('timeupdate', () => {
                if (!video.paused && !video.ended) {
                    const postMedia = video.closest('.post-media');
                    if (postMedia && !postMedia.classList.contains('video-playing')) {
                        updateVideoState(video, true);
                    }
                }
            });

            // 🍎 iOS: Manejar el evento stalled para recuperar videos que se quedan cargando
            video.addEventListener('stalled', () => {
                if (isIOSDevice && !video.paused) {
                    setTimeout(() => {
                        if (!video.paused && video.readyState < 3) {
                            video.load();
                            playVideo(video);
                        }
                    }, 500);
                }
            });

            // Observers
            videoPreloadObserver.observe(video);

            if (activeVideoObservers < MAX_VIDEO_OBSERVERS) {
                videoObserver.observe(video);
                updateVideoState(video, false);
                activeVideoObservers++;
            }
        });

        // Observar posts con musica
        document.querySelectorAll('.post-media:not([data-music-observed])').forEach(media => {
            if (media.querySelector('.photo-audio-player')) {
                media.setAttribute('data-music-observed', 'true');
                if (typeof photoMusicObserver !== 'undefined') {
                    photoMusicObserver.observe(media);
                }
            }
        });
    }

    // ========================================
    // DETECTOR DE PANTALLA NEGRA
    // ========================================
    // Detecta videos visibles que no se reproducen y reporta al log
    function initBlackScreenDetector() {
        // Ejecutar en TODOS los dispositivos para detectar videos problemáticos
        setInterval(() => {
            document.querySelectorAll('video.feed-video').forEach(video => {
                const postMedia = video.closest('.post-media');
                if (!postMedia) return;

                const rect = video.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight && rect.bottom > 0 &&
                                 rect.left < window.innerWidth && rect.right > 0;

                if (!isVisible) return;

                const postId = video.getAttribute('data-post-id') || 'unknown';
                const videoSrc = video.currentSrc || video.querySelector('source')?.src || '';
                const lastReport = video.dataset.lastBlackScreenReport || 0;
                const now = Date.now();

                // Detectar videos con src inválido o vacío
                if (!videoSrc || videoSrc.endsWith('/Feed') || videoSrc.includes('undefined')) {
                    if (now - lastReport > 60000) { // Reportar cada 60 segundos
                        video.dataset.lastBlackScreenReport = now;
                        if (window.ladoLog) {
                            window.ladoLog.error(`Video SRC inválido post:${postId}`, {
                                postId,
                                src: videoSrc || 'EMPTY',
                                videoElement: video.outerHTML.substring(0, 300)
                            });
                        }
                        postMedia.classList.add('video-error');
                    }
                    return;
                }

                // Detectar videos que no cargan (networkState=3 es NETWORK_NO_SOURCE)
                if (video.networkState === 3) {
                    if (now - lastReport > 30000) {
                        video.dataset.lastBlackScreenReport = now;
                        if (window.ladoLog) {
                            window.ladoLog.error(`Video sin fuente válida post:${postId}`, {
                                postId,
                                src: videoSrc.substring(0, 150),
                                networkState: video.networkState,
                                readyState: video.readyState,
                                error: video.error ? { code: video.error.code, message: video.error.message } : null
                            });
                        }
                        postMedia.classList.add('video-error');
                    }
                    return;
                }

                // Detectar videos con error de carga
                if (video.error) {
                    if (now - lastReport > 30000) {
                        video.dataset.lastBlackScreenReport = now;
                        if (window.ladoLog) {
                            window.ladoLog.error(`Video con error post:${postId}`, {
                                postId,
                                src: videoSrc.substring(0, 150),
                                errorCode: video.error.code,
                                errorMessage: video.error.message,
                                networkState: video.networkState,
                                readyState: video.readyState
                            });
                        }
                        postMedia.classList.add('video-error');
                    }
                    return;
                }

                // Si el video está visible, pausado, sin error visible, y no tiene needs-tap
                if (video.paused &&
                    !postMedia.classList.contains('video-error') &&
                    !postMedia.classList.contains('needs-tap') &&
                    !postMedia.classList.contains('video-playing') &&
                    video.readyState >= 1) {

                    // Determinar si el video está cerca del final (>90% reproducido)
                    const isNearEnd = video.duration > 0 && (video.currentTime / video.duration) > 0.9;
                    const hasPlayed = video.currentTime > 0.5; // Ha reproducido más de 0.5 segundos

                    // Solo loguear si no ha reproducido mucho (evitar spam de videos que terminaron normalmente)
                    if (now - lastReport > 30000 && !isNearEnd) {
                        video.dataset.lastBlackScreenReport = now;

                        if (window.ladoLog) {
                            window.ladoLog.warn(`Video pantalla negra detectado post:${postId}`, {
                                postId,
                                src: videoSrc.substring(0, 150),
                                readyState: video.readyState,
                                networkState: video.networkState,
                                paused: video.paused,
                                ended: video.ended,
                                duration: video.duration,
                                currentTime: video.currentTime,
                                muted: video.muted,
                                isIOS: isIOSDevice,
                                userAgent: navigator.userAgent.substring(0, 100)
                            });
                        }
                    }

                    // Si el video está cerca del final o terminó, reiniciar desde el principio
                    if (isNearEnd || video.ended) {
                        video.currentTime = 0;
                    }

                    // Asegurar que el video tiene loop para que no se pause al final
                    if (!video.loop) {
                        video.loop = true;
                    }

                    // Intentar recuperar el video
                    playVideo(video);
                }

                // Detectar videos atascados en carga (readyState bajo por mucho tiempo)
                if (video.readyState < 2 && !postMedia.classList.contains('video-error')) {
                    const loadStartTime = parseInt(video.dataset.loadStartTime || '0');
                    if (!loadStartTime) {
                        video.dataset.loadStartTime = now;
                    } else if (now - loadStartTime > 10000) { // 10 segundos sin cargar
                        if (now - lastReport > 30000) {
                            video.dataset.lastBlackScreenReport = now;
                            if (window.ladoLog) {
                                window.ladoLog.warn(`Video atascado en carga post:${postId}`, {
                                    postId,
                                    src: videoSrc.substring(0, 150),
                                    readyState: video.readyState,
                                    networkState: video.networkState,
                                    loadTime: Math.round((now - loadStartTime) / 1000) + 's'
                                });
                            }
                            // Intentar recargar
                            video.load();
                        }
                    }
                } else if (video.readyState >= 2) {
                    // Reset load timer when video loads
                    video.dataset.loadStartTime = '0';
                }
            });
        }, 5000); // Revisar cada 5 segundos
    }

    // Limpiar observers de posts antiguos para evitar memory leak
    function cleanupOldObservers() {
        if (activeVideoObservers <= MAX_VIDEO_OBSERVERS) return;

        const posts = document.querySelectorAll('.post');
        const postsToClean = Array.from(posts).slice(0, posts.length - MAX_VIDEO_OBSERVERS);

        postsToClean.forEach(post => {
            const video = post.querySelector('video[data-observed]');
            if (video) {
                videoObserver.unobserve(video);
                video.pause();
                video.removeAttribute('src');
                video.load(); // Liberar memoria
                activeVideoObservers--;
            }
        });
    }

    // ========================================
    // AUTO-REFRESH: Sistema mejorado para PWA
    // ⚡ Auto-actualiza cuando vuelve del background
    // ========================================
    let autoRefreshInterval = null;
    let pendingNewPosts = 0;
    const AUTO_REFRESH_DELAY = 30000; // 30 segundos para verificación periódica
    const BACKGROUND_AUTO_REFRESH_THRESHOLD = 60000; // 60 segundos en background = auto-refresh
    let lastVisibleTime = Date.now();
    let hiddenTime = null;

    async function checkForNewPosts() {
        if (loadedPostIds.size === 0) return;

        try {
            const idsVistosParam = Array.from(loadedPostIds).slice(0, 100).join(',');
            const response = await fetch(`/Feed/VerificarNuevosPosts?idsVistos=${encodeURIComponent(idsVistosParam)}`);
            const data = await response.json();

            if (data.success && data.hayNuevos && data.cantidad > 0) {
                pendingNewPosts = data.cantidad;
                showNewPostsBanner(data.cantidad);
            }
        } catch (error) {
            console.log('[Feed] Error verificando nuevos posts:', error);
        }
    }

    function showNewPostsBanner(cantidad) {
        const banner = document.getElementById('newPostsBanner');
        const text = document.getElementById('newPostsText');
        if (banner && text) {
            text.textContent = cantidad === 1
                ? '1 nueva publicación'
                : `${cantidad} nuevas publicaciones`;
            banner.classList.add('visible');
        }
    }

    function hideNewPostsBanner() {
        const banner = document.getElementById('newPostsBanner');
        if (banner) {
            banner.classList.remove('visible');
        }
        pendingNewPosts = 0;
    }

    // Cargar nuevos posts cuando el usuario hace clic en el banner
    window.cargarNuevosPosts = async function() {
        hideNewPostsBanner();

        // Scroll al inicio
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Esperar un momento para el scroll
        await new Promise(resolve => setTimeout(resolve, 300));

        // Llamar a refreshFeed para cargar los nuevos posts
        await refreshFeed();
    };

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(checkForNewPosts, AUTO_REFRESH_DELAY);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // ⚡ MEJORADO: Auto-refresh cuando vuelve del background
    document.addEventListener('visibilitychange', async function() {
        if (document.hidden) {
            // App va al background
            hiddenTime = Date.now();
            lastVisibleTime = Date.now();
            stopAutoRefresh();
        } else {
            // App vuelve al frente
            const timeInBackground = hiddenTime ? Date.now() - hiddenTime : 0;
            console.log('[Feed] Volviendo del background, tiempo:', Math.round(timeInBackground/1000), 'segundos');

            // Si estuvo más de 60 segundos en background, auto-actualizar
            if (timeInBackground > BACKGROUND_AUTO_REFRESH_THRESHOLD) {
                console.log('[Feed] Auto-actualizando por tiempo en background');

                // Mostrar indicador de refresh brevemente
                const pullIndicator = document.getElementById('pullToRefresh');
                const pullText = document.getElementById('pullText');
                if (pullIndicator && pullText) {
                    pullIndicator.classList.add('visible', 'refreshing');
                    pullIndicator.style.transform = 'translateX(-50%) translateY(30px)';
                    pullText.textContent = 'Actualizando...';
                }

                // Scroll al inicio suavemente
                window.scrollTo({ top: 0, behavior: 'smooth' });

                try {
                    await refreshFeed();
                } finally {
                    if (pullIndicator) {
                        pullIndicator.classList.remove('visible', 'refreshing');
                        pullIndicator.style.transform = 'translateX(-50%) translateY(-100%)';
                    }
                }

                // Ocultar banner ya que acabamos de actualizar
                hideNewPostsBanner();
            } else {
                // Solo verificar si hay nuevos posts
                checkForNewPosts();
            }

            hiddenTime = null;
            startAutoRefresh();
        }
    });

    // Inicializar al cargar - prioriza funciones críticas primero
    document.addEventListener('DOMContentLoaded', function() {
        // Crítico: funcionalidad principal del feed
        initInfiniteScroll();

        // Diferir funciones no críticas para no bloquear renderizado
        var deferInit = window.requestIdleCallback || function(cb) { setTimeout(cb, 100); };
        deferInit(function() {
            initPullToRefresh();
            initBlackScreenDetector();
        });

        // Iniciar auto-refresh despues de 10 segundos
        setTimeout(startAutoRefresh, 10000);

        // 🍎 iOS: Forzar reproducción del primer video visible después de cualquier interacción
        if (isIOSDevice) {
            let firstInteractionHandled = false;

            const forcePlayOnInteraction = () => {
                if (firstInteractionHandled) return;
                firstInteractionHandled = true;

                // Esperar un momento y luego intentar reproducir
                setTimeout(() => {
                    const videos = document.querySelectorAll('video.feed-video');
                    videos.forEach(video => {
                        const rect = video.getBoundingClientRect();
                        const isVisible = rect.top < window.innerHeight && rect.bottom > 0 &&
                                         rect.left < window.innerWidth && rect.right > 0;

                        if (isVisible && video.paused) {
                            playVideo(video).then(success => {
                                if (!success && window.ladoLog) {
                                    window.ladoLog.warn('iOS: Fallo autoplay video en Feed',
                                        JSON.stringify({ videoSrc: video.src?.substring(0, 100) }));
                                }
                            });
                        }
                    });
                }, 100);
            };

            // Escuchar múltiples eventos de interacción
            ['touchstart', 'touchend', 'click'].forEach(event => {
                document.addEventListener(event, forcePlayOnInteraction, { once: true, passive: true });
            });
        }

        // SharedPostId se maneja al final del script donde openFullscreenViewer ya está definido
    });

    // ========================================
    // PHOTO MUSIC PLAYER - Reproducción automática
    // ========================================
    // ⚠️ GLOBAL para que openFullscreenViewer (en otro script) pueda accederla
    window.currentPhotoAudio = null;

    // Variable para controlar si el fullscreen está activo
    let isFullscreenActive = false;

    // Intersection Observer para detectar fotos con música visibles
    const photoMusicObserver = new IntersectionObserver((entries) => {
        // NO reproducir audio del feed si el fullscreen está activo
        if (isFullscreenActive) {
            return;
        }

        entries.forEach(entry => {
            const postMedia = entry.target;
            const audio = postMedia.querySelector('.photo-audio-player');

            if (!audio) return;

            if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                // Verificar de nuevo que fullscreen no esté activo
                if (isFullscreenActive) return;

                // Si el audio global está muteado, no reproducir música de fotos
                if (isGlobalMuted) {
                    // Pausar si estaba sonando
                    if (window.currentPhotoAudio === audio) {
                        if (window.iOSMediaFix?.isIOS) {
                            window.iOSMediaFix.pause(audio);
                        } else {
                            audio.pause();
                        }
                        const badge = postMedia.querySelector('.music-badge');
                        if (badge) badge.classList.remove('playing');
                    }
                    return;
                }

                const startTime = parseFloat(audio.dataset.start) || 0;
                let volume = parseFloat(audio.dataset.volume) || 0.7;

                // Normalizar volumen al rango [0, 1]
                if (volume > 1) {
                    volume = volume / 10;
                }
                volume = Math.min(1, Math.max(0, volume));

                const badge = postMedia.querySelector('.music-badge');

                // 🍎 iOS: Usar iOSMediaFix.playPhotoMusic para mejor compatibilidad
                if (window.iOSMediaFix?.isIOS) {
                    // Pausar audio anterior si existe
                    if (window.currentPhotoAudio && window.currentPhotoAudio !== audio) {
                        window.iOSMediaFix.pause(window.currentPhotoAudio);
                        // Limpiar badge del audio anterior
                        document.querySelectorAll('.music-badge.playing').forEach(b => {
                            if (b !== badge) b.classList.remove('playing');
                        });
                    }

                    // En iOS, verificar si necesita interacción del usuario
                    if (window.iOSMediaFix.needsUserInteraction()) {
                        if (badge) {
                            badge.classList.add('needs-tap');
                            badge.title = 'Toca para reproducir música';
                        }
                        window.currentPhotoAudio = audio;
                    } else {
                        // iOS desbloqueado o no es iOS - reproducir
                        window.iOSMediaFix.playPhotoMusic(audio, { startTime, volume }).then(success => {
                            if (success && badge) {
                                badge.classList.remove('needs-tap');
                                badge.classList.add('playing');
                            }
                            window.currentPhotoAudio = audio;
                        });
                    }
                } else {
                    // Fallback: sin iOSMediaFix (non-iOS)
                    if (window.currentPhotoAudio && window.currentPhotoAudio !== audio) {
                        window.currentPhotoAudio.pause();
                    }

                    audio.currentTime = startTime;
                    audio.volume = volume;

                    audio.play().then(() => {
                        if (badge) badge.classList.add('playing');
                        window.currentPhotoAudio = audio;
                    }).catch((err) => {
                        if (badge) badge.classList.add('needs-tap');
                        window.currentPhotoAudio = audio;
                    });
                }
            } else {
                // La foto no está visible - pausar música
                if (window.currentPhotoAudio === audio) {
                    if (window.iOSMediaFix?.isIOS) {
                        window.iOSMediaFix.pause(audio);
                    } else {
                        audio.pause();
                    }
                    window.currentPhotoAudio = null;
                }

                // Detener animación del badge
                const badge = postMedia.querySelector('.music-badge');
                if (badge) {
                    badge.classList.remove('playing');
                }
            }
        });
    }, {
        threshold: [0.5]
    });

    // Función para observar nuevos posts con música (llamada desde loadMorePosts)
    function initPhotoMusicObserversForNewPosts() {
        const mediaElements = document.querySelectorAll('.post-media:not([data-music-observed])');

        mediaElements.forEach(media => {
            const audioPlayer = media.querySelector('.photo-audio-player');
            if (audioPlayer) {
                media.setAttribute('data-music-observed', 'true');
                photoMusicObserver.observe(media);

                // Configurar loop manual para respetar el startTime
                if (!audioPlayer.hasAttribute('data-loop-configured')) {
                    audioPlayer.setAttribute('data-loop-configured', 'true');
                    audioPlayer.removeAttribute('loop'); // Quitar loop nativo

                    // Establecer tiempo inicial al cargar
                    audioPlayer.addEventListener('loadedmetadata', function() {
                        const st = parseFloat(this.dataset.start) || 0;
                        if (st > 0 && this.currentTime < st) {
                            this.currentTime = st;
                        }
                    });

                    // Cuando el audio termina, reiniciar desde startTime
                    audioPlayer.addEventListener('ended', function() {
                        const startTime = parseFloat(this.dataset.start) || 0;
                        this.currentTime = startTime;
                        this.play().catch(() => {});
                    });

                    // También verificar en timeupdate
                    audioPlayer.addEventListener('timeupdate', function() {
                        const startTime = parseFloat(this.dataset.start) || 0;
                        // Si el audio está antes del startTime y está reproduciéndose, corregir
                        if (startTime > 0 && this.currentTime < startTime && this.currentTime < 1 && !this.paused) {
                            this.currentTime = startTime;
                        }
                    });
                }
            }
        });
    }

    // Observar todas las fotos con música al cargar (diferido)
    document.addEventListener('DOMContentLoaded', () => {
        var defer = window.requestIdleCallback || function(cb) { setTimeout(cb, 200); };
        defer(initPhotoMusicObserversForNewPosts);
    });

    // 🍎 iOS: Evento cuando el media se desbloquea (disparado por iOSMediaFix)
    document.addEventListener('iOSMediaUnlocked', () => {
        // Remover indicadores de needs-tap
        document.querySelectorAll('.needs-tap').forEach(el => {
            el.classList.remove('needs-tap');
        });
        document.querySelectorAll('.music-badge.needs-tap').forEach(badge => {
            badge.classList.remove('needs-tap');
        });

        // Reproducir el video visible si hay uno
        const visibleVideo = document.querySelector('.post-media.video-paused video.feed-video');
        if (visibleVideo && visibleVideo.paused) {
            const rect = visibleVideo.getBoundingClientRect();
            const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
            if (isVisible) {
                playVideo(visibleVideo);
            }
        }

        // Reproducir el audio visible si hay uno
        if (window.currentPhotoAudio && window.currentPhotoAudio.paused) {
            const startTime = parseFloat(window.currentPhotoAudio.dataset.start) || 0;
            let volume = parseFloat(window.currentPhotoAudio.dataset.volume) || 0.7;
            if (volume > 1) volume = volume / 10;

            if (window.iOSMediaFix?.isIOS) {
                window.iOSMediaFix.playPhotoMusic(window.currentPhotoAudio, { startTime, volume });
            }
        }
    });

    // 🍎 iOS: Primer toque en cualquier lugar desbloquea el media
    if (window.iOSMediaFix && window.iOSMediaFix.isIOS) {
        let mediaUnlockHandled = false;
        document.addEventListener('touchstart', function unlockMediaOnTouch() {
            if (mediaUnlockHandled) return;
            mediaUnlockHandled = true;

            window.iOSMediaFix.resume().then(() => {
            });
        }, { once: true, passive: true });
    }

    // ========================================
    // DOUBLE TAP PARA LIKE - Instagram Style
    // Compatible con iOS Safari y todos los navegadores
    // ========================================
    (function initDoubleTapLike() {
        // Estado global para tracking de taps
        const tapState = new Map(); // postId -> { lastTap, timeout, startX, startY }
        const DOUBLE_TAP_DELAY = 300; // ms entre taps para considerarlo doble
        const TAP_MOVE_THRESHOLD = 15; // px máximo de movimiento para considerarlo tap
        const likeInProgressFeed = new Set();

        // Crear el corazón si no existe en el post-media
        function ensureHeartElement(postMedia) {
            let heart = postMedia.querySelector('.doubletap-heart');
            if (!heart) {
                heart = document.createElement('div');
                heart.className = 'doubletap-heart';
                heart.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
                postMedia.appendChild(heart);
            }
            return heart;
        }

        // Mostrar animación del corazón
        function showHeartAnimation(postMedia) {
            const heart = ensureHeartElement(postMedia);
            heart.classList.remove('animate');
            void heart.offsetWidth; // Force reflow
            heart.classList.add('animate');
            setTimeout(() => heart.classList.remove('animate'), 900);
        }

        // Dar like al post
        async function likePostFromDoubleTap(postId, postMedia) {
            if (likeInProgressFeed.has(postId)) return;
            likeInProgressFeed.add(postId);

            // Mostrar animación inmediatamente (optimistic UI)
            showHeartAnimation(postMedia);

            // Haptic feedback
            if (window.LadoHaptic) {
                window.LadoHaptic.medium();
            } else if (navigator.vibrate) {
                navigator.vibrate(30);
            }

            try {
                const response = await fetch('/Feed/Like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${postId}`
                });
                const data = await response.json();

                if (data.success) {
                    // Actualizar botón de like
                    const likeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
                    if (likeBtn) {
                        likeBtn.classList.toggle('liked', data.liked);
                    }

                    // Actualizar contador
                    const likesSpan = document.getElementById(`likes-${postId}`);
                    if (likesSpan && data.likes !== undefined) {
                        likesSpan.textContent = `${data.likes} Me gusta`;
                    }

                    // Actualizar data-likes en el article para el fullscreen viewer
                    const postArticle = postMedia?.closest('.post');
                    if (postArticle && data.likes !== undefined) {
                        postArticle.dataset.likes = data.likes;
                    }
                }
            } catch (err) {
                console.warn('Error al dar like:', err);
            } finally {
                setTimeout(() => likeInProgressFeed.delete(postId), 500);
            }
        }

        // Obtener postId de un elemento
        function getPostId(element) {
            const postMedia = element.closest('.post-media');
            if (!postMedia) return null;

            // Buscar data-post-id en el media o en el contenedor padre
            let postId = postMedia.dataset?.postId;
            if (!postId) {
                const postCard = postMedia.closest('.post, .post-card, [data-post-id]');
                postId = postCard?.dataset?.postId;
            }
            return postId;
        }

        // Variables para tracking de touch
        let touchStartX = 0;
        let touchStartY = 0;
        let isTouchMoving = false;

        // Trackear inicio del touch
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length !== 1) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isTouchMoving = false;
        }, { passive: true });

        // Detectar si hubo movimiento (scroll)
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length !== 1) return;
            const dx = Math.abs(e.touches[0].clientX - touchStartX);
            const dy = Math.abs(e.touches[0].clientY - touchStartY);
            if (dx > TAP_MOVE_THRESHOLD || dy > TAP_MOVE_THRESHOLD) {
                isTouchMoving = true;
            }
        }, { passive: true });

        // Detectar double-tap en touchend
        document.addEventListener('touchend', function(e) {
            // Ignorar si hubo movimiento, múltiples toques, o fullscreen activo
            if (isTouchMoving) return;
            if (e.changedTouches.length !== 1) return;
            if (typeof isFullscreenActive !== 'undefined' && isFullscreenActive) return;

            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY) || e.target;

            // Ignorar si es en controles específicos
            if (target.closest('.video-mute-btn, .photo-music-mute-btn, .carousel-btn, .music-badge, audio, .carousel-dots, .sensitive-reveal-btn, .locked-overlay, .preview-blur-overlay, .video-play-icon')) {
                return;
            }

            const postMedia = target.closest('.post-media');
            if (!postMedia) return;

            // Ignorar contenido bloqueado
            if (postMedia.closest('.locked-content-wrapper')) return;

            const postId = getPostId(target);
            if (!postId) return;

            const now = Date.now();
            const state = tapState.get(postId) || { lastTap: 0 };

            if (now - state.lastTap < DOUBLE_TAP_DELAY) {
                // ¡Double tap detectado!
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // Marcar flag global para que otros handlers ignoren el click subsecuente
                window._doubleTapJustFired = true;
                setTimeout(() => { window._doubleTapJustFired = false; }, 100);

                // Limpiar timeout de single tap
                if (state.timeout) clearTimeout(state.timeout);
                tapState.delete(postId);

                // Dar like
                likePostFromDoubleTap(postId, postMedia);
            } else {
                // Primer tap - guardar estado
                state.lastTap = now;
                state.timeout = setTimeout(() => {
                    tapState.delete(postId);
                }, DOUBLE_TAP_DELAY + 50);
                tapState.set(postId, state);
            }
        }, { passive: false, capture: true }); // capture: true para interceptar antes que otros handlers

        // Desktop: dblclick
        document.addEventListener('dblclick', function(e) {
            // Ignorar en touch devices
            if ('ontouchstart' in window) return;
            if (typeof isFullscreenActive !== 'undefined' && isFullscreenActive) return;

            const postMedia = e.target.closest('.post-media');
            if (!postMedia) return;

            if (postMedia.closest('.locked-content-wrapper')) return;
            if (e.target.closest('.video-mute-btn, .carousel-btn, .music-badge, audio, .video-play-icon')) return;

            const postId = getPostId(e.target);
            if (!postId) return;

            e.preventDefault();
            e.stopPropagation();
            likePostFromDoubleTap(postId, postMedia);
        }, { capture: true });

        // Observer para posts cargados dinámicamente
        const postObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.querySelectorAll) {
                        node.querySelectorAll('.post-media').forEach(pm => {
                            if (pm.closest('.post, .post-card') && !pm.closest('.locked-content-wrapper') && !pm.querySelector('.doubletap-heart')) {
                                ensureHeartElement(pm);
                            }
                        });
                    }
                });
            });
        });

        postObserver.observe(document.body, { childList: true, subtree: true });

        // Inicializar corazones en posts existentes
        document.querySelectorAll('.post-media').forEach(pm => {
            if (pm.closest('.post, .post-card') && !pm.closest('.locked-content-wrapper')) {
                ensureHeartElement(pm);
            }
        });

        // Exponer función global para usar desde otros handlers
        window.triggerDoubleTapLike = function(postId, postMedia) {
            likePostFromDoubleTap(postId, postMedia);
        };
    })();

    // Click en badge de música para reproducir manualmente
    document.addEventListener('click', (e) => {
        const badge = e.target.closest('.music-badge');
        if (!badge) return;

        // NO reproducir si fullscreen está activo
        if (isFullscreenActive) return;

        e.stopPropagation();
        const postId = badge.dataset.postId;
        const audio = document.querySelector(`.photo-audio-player[data-post-id="${postId}"]`);

        if (!audio) return;

        if (audio.paused) {
            // Pausar audio anterior si existe
            if (window.currentPhotoAudio && window.currentPhotoAudio !== audio) {
                if (window.iOSMediaFix?.isIOS) {
                    window.iOSMediaFix.pause(window.currentPhotoAudio);
                } else {
                    window.currentPhotoAudio.pause();
                }
                // Limpiar badge anterior
                document.querySelectorAll('.music-badge.playing').forEach(b => b.classList.remove('playing'));
            }

            const startTime = parseFloat(audio.dataset.start) || 0;
            let volume = parseFloat(audio.dataset.volume) || 0.7;
            if (volume > 1) volume = volume / 10;
            volume = Math.min(1, Math.max(0, volume));

            // 🍎 iOS/Android: Usar iOSMediaFix para mejor compatibilidad
            if (window.iOSMediaFix?.isIOS) {
                window.iOSMediaFix.resume().then(() => {
                    window.iOSMediaFix.playPhotoMusic(audio, { startTime, volume }).then(success => {
                        if (success) {
                            badge.classList.remove('needs-tap');
                            badge.classList.add('playing');
                            window.currentPhotoAudio = audio;
                        }
                    });
                });
            } else {
                audio.currentTime = startTime;
                audio.volume = volume;
                audio.play().then(() => {
                    badge.classList.add('playing');
                    window.currentPhotoAudio = audio;
                }).catch(err => {
                });
            }
        } else {
            // Pausar audio
            if (window.iOSMediaFix?.isIOS) {
                window.iOSMediaFix.pause(audio);
            } else {
                audio.pause();
            }
            window.currentPhotoAudio = null;
            badge.classList.remove('playing');
            badge.classList.remove('needs-tap');
        }
    });

    // Like (con debounce para evitar spam) - Usando event delegation para soportar infinite scroll
    document.addEventListener('click', async function(e) {
        const btn = e.target.closest('.like-btn');
        if (!btn) return;

        e.preventDefault();
        const postId = btn.dataset.id;
        if (!postId) return;

        // Debounce: evitar múltiples clicks simultáneos
        if (likeInProgress.has(postId)) return;
        likeInProgress.add(postId);

        try {
            const res = await fetch('/Feed/Like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}`
            });
            const data = await res.json();

            if (data.success) {
                btn.classList.toggle('liked', data.liked);
                const likesEl = document.getElementById(`likes-${postId}`);
                if (likesEl) likesEl.textContent = `${data.likes} Me gusta`;
                // Actualizar data-likes en el article para el fullscreen viewer
                const postArticle = btn.closest('.post');
                if (postArticle) postArticle.dataset.likes = data.likes;
            }
        } catch (err) {
            console.error('Like error:', err);
        } finally {
            // Liberar después de 500ms para evitar spam
            setTimeout(() => likeInProgress.delete(postId), 500);
        }
    });

    // Bookmark (Favorito)
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const postId = this.dataset.id;

            try {
                const res = await fetch('/Feed/ToggleFavorito', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${postId}`
                });
                const data = await res.json();

                if (data.success) {
                    this.classList.toggle('bookmarked', data.esFavorito);
                    this.title = data.esFavorito ? 'Quitar de favoritos' : 'Guardar en favoritos';
                }
            } catch (err) {
            }
        });
    });

    // Comment input enable/disable - Event Delegation para infinite scroll
    document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('comment-input')) return;
        const postId = e.target.dataset.postId;
        const btn = document.querySelector(`.comment-post-btn[data-post-id="${postId}"]`);
        if (btn) btn.disabled = !e.target.value.trim();
    });

    document.addEventListener('keypress', function(e) {
        if (!e.target.classList.contains('comment-input')) return;
        if (e.key !== 'Enter') return;
        const postId = e.target.dataset.postId;
        const btn = document.querySelector(`.comment-post-btn[data-post-id="${postId}"]`);
        if (btn && !btn.disabled) btn.click();
    });

    // Post Comment - Event Delegation para infinite scroll
    const commentInProgress = new Set();
    document.addEventListener('click', async function(e) {
        const btn = e.target.closest('.comment-post-btn');
        if (!btn) return;

        const postId = btn.dataset.postId;
        if (!postId) return;

        const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
        const texto = input?.value?.trim();
        if (!texto) return;

        // Evitar doble click
        if (commentInProgress.has(postId)) return;
        commentInProgress.add(postId);
        btn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
            formData.append('id', postId);
            formData.append('texto', texto);

            const res = await fetch('/Feed/Comentar', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                input.value = '';
                showToast('Comentario publicado');

                // Add comment to preview
                const post = document.querySelector(`[data-post-id="${postId}"]`);
                if (post) {
                    let preview = post.querySelector('.post-comments-preview');
                    if (!preview) {
                        preview = document.createElement('div');
                        preview.className = 'post-comments-preview';
                        const addComment = post.querySelector('.post-add-comment');
                        if (addComment) addComment.before(preview);
                    }
                    const newComment = document.createElement('div');
                    newComment.className = 'comment-preview';
                    newComment.innerHTML = `<span class="comment-preview-username">${escapeHtml(data.comentario.username)}</span> <span class="comment-preview-text">${escapeHtml(data.comentario.texto)}</span>`;
                    preview.appendChild(newComment);

                    // Actualizar data-comments en el article para el fullscreen viewer
                    const postArticle = post.closest('.post') || post;
                    if (postArticle && data.totalComentarios !== undefined) {
                        postArticle.dataset.comments = data.totalComentarios;
                    }
                }
            } else {
                showToast(data.message || 'Error al comentar');
            }
        } catch (err) {
            console.error('Comment error:', err);
            showToast('Error al publicar comentario');
        } finally {
            commentInProgress.delete(postId);
            btn.disabled = !input?.value?.trim();
        }
    });

    // Focus comment input - Event Delegation
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.comment-btn');
        if (!btn) return;
        const postId = btn.dataset.id;
        const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
        if (input) input.focus();
    });

    // Share - Abrir modal de compartir mejorado
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            const button = e.target.closest('.share-btn');
            const postId = button?.dataset?.id;
            if (postId) {
                await abrirModalCompartir(postId);
            }
        });
    });

    // Datos de contactos para compartir
    let shareContactsData = [];
    let selectedShareContacts = new Set();

    // Función global para abrir modal de compartir
    async function abrirModalCompartir(postId) {
        if (!postId) {
            return;
        }

        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        if (!token) {
            showToast('Error de autenticación');
            return;
        }

        try {
            const res = await fetch('/Feed/Compartir', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `id=${postId}&__RequestVerificationToken=${encodeURIComponent(token)}`
            });

            if (!res.ok) {
                showToast('Error al compartir');
                return;
            }

            const data = await res.json();

            if (data.success) {
                currentShareUrl = data.url;
                currentSharePostId = postId;

                // Actualizar URLs de redes sociales
                document.getElementById('shareUrlInput').value = data.url;
                document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${encodeURIComponent('Mira esto: ' + data.url)}`;
                document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(data.url)}`;
                document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(data.url)}`;
                document.getElementById('shareEmail').href = `mailto:?subject=${encodeURIComponent('Mira esto')}&body=${encodeURIComponent(data.url)}`;

                // Manejar restricción de compartir a historia
                const storyBtn = document.getElementById('shareAsStory');
                const restrictionMsg = document.getElementById('shareRestrictionMsg');

                if (data.esPostPropio) {
                    storyBtn.classList.remove('disabled');
                    restrictionMsg.classList.remove('visible');
                } else {
                    storyBtn.classList.add('disabled');
                    restrictionMsg.classList.add('visible');
                }

                // Limpiar búsqueda
                const searchInput = document.getElementById('shareSearchInput');
                if (searchInput) searchInput.value = '';

                // Resetear selección
                selectedShareContacts.clear();

                // Cargar contactos en el grid
                cargarContactosGrid();

                // Mostrar modal
                document.getElementById('shareModal').classList.add('active');
            } else {
                showToast(data.message || 'Error al compartir');
            }
        } catch (err) {
            showToast('Error al preparar compartir');
        }
    }

    // Cargar contactos en el grid estilo Instagram
    async function cargarContactosGrid() {
        const grid = document.getElementById('shareContactsGrid');
        grid.innerHTML = '<div class="share-contacts-empty">Cargando...</div>';

        try {
            const res = await fetch('/Feed/ObtenerSiguiendo');
            if (!res.ok) throw new Error('Error');

            shareContactsData = await res.json();
            renderizarContactosGrid(shareContactsData);
        } catch (err) {
            grid.innerHTML = '<div class="share-contacts-empty">Error al cargar contactos</div>';
        }
    }

    // Renderizar contactos en grid
    function renderizarContactosGrid(contactos) {
        const grid = document.getElementById('shareContactsGrid');

        if (!contactos || contactos.length === 0) {
            grid.innerHTML = '<div class="share-contacts-empty">No sigues a nadie aún</div>';
            return;
        }

        grid.innerHTML = contactos.map(contacto => {
            const inicial = (contacto.nombre?.charAt(0) || contacto.username?.charAt(0) || 'U').toUpperCase();
            const nombre = contacto.nombre || contacto.username || 'Usuario';
            const foto = contacto.fotoPerfil;
            const isSelected = selectedShareContacts.has(contacto.id);

            return `
            <div class="share-contact-item ${isSelected ? 'selected' : ''}"
                 data-id="${escapeHtml(contacto.id)}"
                 onclick="toggleShareContact('${escapeHtml(contacto.id)}')">
                ${foto
                    ? `<img src="${escapeHtml(foto)}" alt="" class="share-contact-avatar" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                       <div class="share-contact-avatar" style="display:none;">${escapeHtml(inicial)}</div>`
                    : `<div class="share-contact-avatar">${escapeHtml(inicial)}</div>`
                }
                <span class="share-contact-name">${escapeHtml(nombre)}</span>
            </div>`;
        }).join('');
    }

    // Toggle selección de contacto
    function toggleShareContact(contactId) {
        const item = document.querySelector(`.share-contact-item[data-id="${contactId}"]`);

        if (selectedShareContacts.has(contactId)) {
            selectedShareContacts.delete(contactId);
            item?.classList.remove('selected');
        } else {
            selectedShareContacts.add(contactId);
            item?.classList.add('selected');
            // Enviar inmediatamente al seleccionar
            enviarAContacto(contactId);
        }
    }

    // Enviar post a un contacto
    async function enviarAContacto(contactId) {
        if (!currentSharePostId || !currentShareUrl) return;

        const item = document.querySelector(`.share-contact-item[data-id="${contactId}"]`);
        if (item) item.style.opacity = '0.5';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const res = await fetch('/Feed/EnviarAAmigos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    ContenidoId: currentSharePostId,
                    AmigosIds: [contactId],
                    Url: currentShareUrl
                })
            });

            if (res.ok) {
                showToast('Enviado');
            } else {
                showToast('Error al enviar');
            }
        } catch (err) {
            showToast('Error al enviar');
        } finally {
            if (item) item.style.opacity = '1';
            selectedShareContacts.delete(contactId);
            item?.classList.remove('selected');
        }
    }

    // Búsqueda de contactos en el share modal
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('shareSearchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (!query) {
                    renderizarContactosGrid(shareContactsData);
                    return;
                }
                const filtered = shareContactsData.filter(c =>
                    (c.nombre || '').toLowerCase().includes(query) ||
                    (c.username || '').toLowerCase().includes(query)
                );
                renderizarContactosGrid(filtered);
            });
        }
    });

    // Cargar contactos recientes para compartir rápido
    async function cargarContactosRecientes() {
        const container = document.getElementById('shareRecentScroll');
        const section = document.getElementById('shareRecentSection');

        try {
            const res = await fetch('/Feed/ObtenerSiguiendo');
            if (!res.ok) throw new Error('Error');

            const amigos = await res.json();

            if (amigos && amigos.length > 0) {
                // Mostrar máximo 10 contactos para scroll horizontal
                const recientes = amigos.slice(0, 10);
                container.innerHTML = recientes.map(amigo => {
                    const inicial = (amigo.nombre?.charAt(0) || amigo.username?.charAt(0) || 'U').toUpperCase();
                    const nombreCorto = amigo.nombre?.split(' ')[0] || amigo.username || 'Usuario';
                    const foto = amigo.fotoPerfil;

                    return `
                    <div class="share-recent-item" onclick="enviarRapidoA('${escapeHtml(amigo.id)}', this)" data-userid="${escapeHtml(amigo.id)}">
                        ${foto
                            ? `<img class="share-recent-avatar" src="${escapeHtml(foto)}" alt="${escapeHtml(nombreCorto)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                               <div class="share-recent-avatar" style="display:none;">${escapeHtml(inicial)}</div>`
                            : `<div class="share-recent-avatar">${escapeHtml(inicial)}</div>`
                        }
                        <span class="share-recent-name">${escapeHtml(nombreCorto)}</span>
                    </div>`;
                }).join('');
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        } catch (err) {
            section.style.display = 'none';
        }
    }

    // Envío rápido a un contacto
    async function enviarRapidoA(userId, element) {
        if (!currentSharePostId || !currentShareUrl) return;
        if (element.classList.contains('sending')) return; // Evitar doble envío

        element.classList.add('sending');
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        try {
            const res = await fetch('/Mensajes/EnviarMensaje', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `receptorId=${userId}&mensaje=${encodeURIComponent('Mira esta publicación: ' + currentShareUrl)}&__RequestVerificationToken=${encodeURIComponent(token)}`
            });

            const data = await res.json();
            element.classList.remove('sending');

            if (data.success) {
                element.classList.add('selected');
                showToast('Enviado');
                setTimeout(() => {
                    element.classList.remove('selected');
                }, 2000);
            } else {
                showToast(data.message || 'Error al enviar');
            }
        } catch (err) {
            element.classList.remove('sending');
            showToast('Error al enviar');
        }
    }

    // Función global para compartir desde posts dinámicos
    window.compartirContenido = async function(postId) {
        await abrirModalCompartir(postId);
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.closeShareModal = function() {
        document.getElementById('shareModal').classList.remove('active');
        // Resetear panel de amigos
        closeFriendsPanel();
        selectedFriends.clear();
        updateSendButton();
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.copyShareUrl = function() {
        const input = document.getElementById('shareUrlInput');
        const linkLabel = document.querySelector('.share-app-icon.link')?.parentElement?.querySelector('.share-app-label');

        // Usar API moderna de clipboard si está disponible
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(input.value).then(() => {
                if (linkLabel) {
                    linkLabel.textContent = 'Copiado ✓';
                    setTimeout(() => {
                        linkLabel.textContent = 'Copiar enlace';
                    }, 2000);
                }
                showToast('Enlace copiado');
            }).catch(() => {
                showToast('Error al copiar');
            });
        } else {
            // Fallback para navegadores antiguos
            input.select();
            document.execCommand('copy');
            if (linkLabel) {
                linkLabel.textContent = 'Copiado ✓';
                setTimeout(() => {
                    linkLabel.textContent = 'Copiar enlace';
                }, 2000);
            }
            showToast('Enlace copiado');
        }
    };

    // Compartir post como story
    // ⚠️ GLOBAL para onclick en HTML
    window.compartirComoStory = async function() {
        if (!currentSharePostId) {
            showToast('Error: no se encontró el post');
            return;
        }

        closeShareModal();
        showToast('Creando historia...');

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            if (!token) {
                showToast('Error de autenticación');
                return;
            }

            const formData = new FormData();
            formData.append('postId', currentSharePostId);
            formData.append('__RequestVerificationToken', token);

            const response = await fetch('/Stories/CrearDesdePost', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token
                },
                body: formData
            });

            if (!response.ok) {
                showToast('Error al crear historia');
                return;
            }

            const data = await response.json();

            if (data.success) {
                showToast('¡Compartido en tu historia!');
                if (typeof actualizarBarraStories === 'function') {
                    actualizarBarraStories();
                }
            } else {
                showToast(data.message || 'Error al compartir');
            }
        } catch (error) {
            showToast('Error al compartir');
        }
    }

    // ========================================
    // ENVIAR A AMIGOS
    // ========================================
    let allFriends = [];
    let selectedFriends = new Set();

    function openFriendsPanel() {
        const shareMainView = document.getElementById('shareMainView');
        if (shareMainView) shareMainView.style.display = 'none';
        document.getElementById('friendsPanel')?.classList.add('active');
        loadFriends();
    }

    function closeFriendsPanel() {
        document.getElementById('friendsPanel')?.classList.remove('active');
        const shareMainView = document.getElementById('shareMainView');
        if (shareMainView) shareMainView.style.display = 'block';
        const friendsSearchInput = document.getElementById('friendsSearchInput');
        if (friendsSearchInput) friendsSearchInput.value = '';
    }

    async function loadFriends() {
        const friendsList = document.getElementById('friendsList');
        if (!friendsList) return;

        friendsList.innerHTML = '<div class="friends-loading">Cargando amigos...</div>';

        try {
            const res = await fetch('/Feed/ObtenerSiguiendo');
            if (!res.ok) throw new Error('Error al cargar amigos');

            allFriends = await res.json();
            renderFriendsList(allFriends);
        } catch (err) {
            friendsList.innerHTML = '<div class="friends-empty">Error al cargar amigos</div>';
        }
    }

    function renderFriendsList(friends) {
        const friendsList = document.getElementById('friendsList');
        if (!friendsList) return;

        if (friends.length === 0) {
            friendsList.innerHTML = '<div class="friends-empty">No sigues a nadie aún</div>';
            return;
        }

        friendsList.innerHTML = friends.map(friend => {
            const inicial = (friend.nombre?.charAt(0) || friend.username?.charAt(0) || 'U').toUpperCase();
            const foto = friend.fotoPerfil;

            return `
            <div class="friend-item ${selectedFriends.has(friend.id) ? 'selected' : ''}"
                 data-id="${escapeHtml(friend.id)}" onclick="toggleFriendSelection('${escapeHtml(friend.id)}')">
                ${foto
                    ? `<img src="${escapeHtml(foto)}" alt="" class="friend-avatar" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                       <div class="friend-avatar" style="display:none;align-items:center;justify-content:center;font-weight:600;color:var(--fg);background:var(--line);">${escapeHtml(inicial)}</div>`
                    : `<div class="friend-avatar" style="display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--fg);background:var(--line);">${escapeHtml(inicial)}</div>`
                }
                <div class="friend-info">
                    <div class="friend-name">${escapeHtml(friend.nombre || friend.username)}</div>
                    <div class="friend-username">@@${escapeHtml(friend.username)}</div>
                </div>
                <div class="friend-check">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
            </div>`;
        }).join('');
    }

    function toggleFriendSelection(friendId) {
        if (selectedFriends.has(friendId)) {
            selectedFriends.delete(friendId);
        } else {
            selectedFriends.add(friendId);
        }

        // Actualizar visual
        const item = document.querySelector(`.friend-item[data-id="${friendId}"]`);
        if (item) {
            item.classList.toggle('selected', selectedFriends.has(friendId));
        }

        updateSendButton();
    }

    function updateSendButton() {
        const btn = document.getElementById('sendToFriendsBtn');
        if (!btn) return;
        const count = selectedFriends.size;
        btn.disabled = count === 0;
        btn.textContent = count > 0 ? `Enviar (${count})` : 'Enviar';
    }

    async function sendToSelectedFriends() {
        if (selectedFriends.size === 0) return;

        const btn = document.getElementById('sendToFriendsBtn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Enviando...';
        }

        try {
            const friendIds = Array.from(selectedFriends);
            const res = await fetch('/Feed/EnviarAAmigos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ContenidoId: currentSharePostId,
                    AmigosIds: friendIds,
                    Url: currentShareUrl
                })
            });

            const data = await res.json();

            if (data.success) {
                showToast(`Enviado a ${data.enviados} amigo${data.enviados !== 1 ? 's' : ''}`);
                closeShareModal();
            } else {
                showToast(data.message || 'Error al enviar');
            }
        } catch (err) {
            showToast('Error al enviar');
        } finally {
            if (btn) btn.disabled = false;
            updateSendButton();
        }
    }

    // Búsqueda de amigos
    document.getElementById('friendsSearchInput')?.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query === '') {
            renderFriendsList(allFriends);
        } else {
            const filtered = allFriends.filter(f =>
                f.nombre.toLowerCase().includes(query) ||
                f.username.toLowerCase().includes(query)
            );
            renderFriendsList(filtered);
        }
    });

    // Close modal on background click
    document.getElementById('shareModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeShareModal();
    });

    // Seguir usuario desde header del post (solo seguir, no toggle)
    // ⚠️ GLOBAL para onclick en HTML
    window.seguirDesdeHeader = async function(event, userId, tipoLado, btn) {
        event.preventDefault();
        event.stopPropagation();

        btn.disabled = true;
        btn.textContent = '...';

        try {
            const res = await fetch('/Feed/Seguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success && data.siguiendo) {
                // Ocultar el botón después de seguir exitosamente
                btn.style.display = 'none';

                // Actualizar el atributo data-is-following en el post
                const post = btn.closest('.post');
                if (post) {
                    post.setAttribute('data-is-following', 'true');
                }

                // También actualizar la lista de seguidos para posts futuros
                if (!usuariosSeguidosIds.includes(userId)) {
                    usuariosSeguidosIds.push(userId);
                }

                showToast('Ahora sigues a este usuario');
            } else if (data.success && !data.siguiendo) {
                // Si por alguna razón dejó de seguir, restaurar el botón
                btn.textContent = 'Seguir';
                btn.disabled = false;
            } else {
                showToast(data.message || 'Error al seguir');
                btn.textContent = 'Seguir';
                btn.disabled = false;
            }
        } catch (err) {
            showToast('Error al seguir usuario');
            btn.textContent = 'Seguir';
            btn.disabled = false;
        }
    };

    // Seguir usuario desde sidebar (con TipoLado)
    // ⚠️ GLOBAL para onclick en HTML
    window.seguirUsuario = async function(userId, btn, tipoLado = 0) {
        try {
            const res = await fetch('/Feed/Seguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                if (data.siguiendo) {
                    btn.textContent = 'Siguiendo';
                    btn.style.color = 'var(--muted)';
                } else {
                    btn.textContent = 'Seguir';
                    btn.style.color = 'var(--primary)';
                }
                const ladoTexto = tipoLado === 1 ? ' (Lado B)' : ' (Lado A)';
                showToast(data.siguiendo ? 'Ahora sigues a este usuario' + ladoTexto : 'Has dejado de seguir');
            } else {
                showToast(data.message || 'Error al seguir');
            }
        } catch (err) {
            showToast('Error al seguir usuario');
        }
    };

    // ========================================
    // CREADORES SUGERIDOS - Paginación
    // ========================================

    // Navegar entre páginas de sugerencias
    // ⚠️ GLOBAL para onclick en HTML
    window.navigateSuggestions = function(btn, direction) {
        const section = btn.closest('.suggestions-section');
        if (!section) return;

        const pages = section.querySelectorAll('.suggestions-page');
        const dots = section.querySelectorAll('.suggestions-dot');
        const prevBtn = section.querySelector('[data-dir="prev"]');
        const nextBtn = section.querySelector('[data-dir="next"]');

        let currentIdx = 0;
        pages.forEach((page, i) => {
            if (page.classList.contains('is-active')) currentIdx = i;
        });

        const newIdx = currentIdx + direction;
        if (newIdx < 0 || newIdx >= pages.length) return;

        // Cambiar página
        pages[currentIdx].classList.remove('is-active');
        pages[newIdx].classList.add('is-active');

        // Actualizar dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('is-active', i === newIdx);
        });

        // Actualizar estado botones
        if (prevBtn) prevBtn.disabled = (newIdx === 0);
        if (nextBtn) nextBtn.disabled = (newIdx === pages.length - 1);
    };

    // Seguir usuario desde card de sugerencias (con animación)
    // ⚠️ GLOBAL para onclick en HTML
    window.seguirUsuarioCard = async function(userId, btn) {
        try {
            const tipoLado = 0;
            const res = await fetch('/Feed/Seguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                // Animación bounce
                btn.style.transform = 'scale(1.15)';
                setTimeout(() => { btn.style.transform = ''; }, 200);

                if (data.siguiendo) {
                    btn.textContent = 'Siguiendo';
                    btn.classList.add('is-following');
                } else {
                    btn.textContent = 'Seguir';
                    btn.classList.remove('is-following');
                }

                // Sincronizar cards con mismo userId en desktop y mobile
                document.querySelectorAll(`.suggestion-card-follow[data-user-id="${userId}"]`).forEach(otherBtn => {
                    if (otherBtn !== btn) {
                        if (data.siguiendo) {
                            otherBtn.textContent = 'Siguiendo';
                            otherBtn.classList.add('is-following');
                        } else {
                            otherBtn.textContent = 'Seguir';
                            otherBtn.classList.remove('is-following');
                        }
                    }
                });

                const msg = data.siguiendo ? 'Ahora sigues a este usuario' : 'Has dejado de seguir';
                showToast(msg);
            } else {
                showToast(data.message || 'Error al seguir');
            }
        } catch (err) {
            showToast('Error al seguir usuario');
        }
    };

    // Descartar sugerencia con animación
    // ⚠️ GLOBAL para onclick en HTML
    window.descartarSugerencia = function(userId, btn) {
        // Encontrar todas las cards con este userId en ambas secciones
        const cards = document.querySelectorAll(`.suggestion-card[data-user-id="${userId}"]`);
        cards.forEach(card => {
            card.classList.add('is-dismissing');
            setTimeout(() => {
                card.classList.add('is-removing');
                card.style.maxHeight = '0';
                card.style.margin = '0';
                setTimeout(() => {
                    card.remove();
                }, 300);
            }, 250);
        });

        // Fire-and-forget al server
        fetch('/Feed/DescartarSugerencia', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${userId}`
        }).catch(() => {});
    };

    // ========================================
    // CONTENIDO SENSIBLE
    // ========================================

    // ⚠️ GLOBAL para onclick en HTML
    window.revelarContenidoSensible = function(event, postId) {
        event.stopPropagation();
        event.preventDefault();

        const overlay = document.querySelector(`.sensitive-content-overlay[data-post-id="${postId}"]`);
        if (overlay) {
            overlay.classList.add('revealing');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
    };

    // ========================================
    // FUNCIONES DEL CARRUSEL
    // ========================================

    // ⚠️ GLOBAL para onclick en HTML
    window.carouselPrev = function(event, btn) {
        event.stopPropagation();
        const carousel = btn.closest('.post-carousel');
        navigateCarousel(carousel, -1);
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.carouselNext = function(event, btn) {
        event.stopPropagation();
        const carousel = btn.closest('.post-carousel');
        navigateCarousel(carousel, 1);
    };

    function navigateCarousel(carousel, direction) {
        if (!carousel) return;

        const container = carousel.querySelector('.carousel-container');
        if (!container) return;

        const slides = carousel.querySelectorAll('.carousel-slide');
        const totalSlides = slides.length;

        if (totalSlides === 0) return;

        // Obtener índice actual
        let currentIndex = parseInt(carousel.dataset.currentIndex || '0');

        // Calcular nuevo índice
        let newIndex = currentIndex + direction;

        // Limitar a los bordes
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= totalSlides) newIndex = totalSlides - 1;

        // No hacer nada si ya estamos en el borde
        if (newIndex === currentIndex) return;

        // Scroll al nuevo slide usando scroll nativo
        const slideWidth = container.offsetWidth;
        container.scrollTo({
            left: newIndex * slideWidth,
            behavior: 'smooth'
        });
    }

    // Actualizar UI del carrusel cuando cambia el índice
    function updateCarouselUI(carousel, newIndex) {
        const dots = carousel.querySelectorAll('.carousel-dot');
        const counter = carousel.querySelector('.carousel-counter');
        const prevBtn = carousel.querySelector('.carousel-prev');
        const nextBtn = carousel.querySelector('.carousel-next');
        const slides = carousel.querySelectorAll('.carousel-slide');
        const totalSlides = slides.length;

        // Actualizar índice actual
        carousel.dataset.currentIndex = newIndex;

        // Actualizar dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === newIndex);
        });

        // Actualizar contador
        if (counter) {
            counter.textContent = `${newIndex + 1}/${totalSlides}`;
        }

        // Mostrar/ocultar botones de navegación
        if (prevBtn) prevBtn.classList.toggle('hidden', newIndex === 0);
        if (nextBtn) nextBtn.classList.toggle('hidden', newIndex === totalSlides - 1);

        // Pausar videos de otros slides, reproducir el actual
        slides.forEach((slide, i) => {
            const video = slide.querySelector('video');
            if (video) {
                if (i === newIndex) {
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });
    }

    // Inicializar carruseles al cargar
    function initCarousels() {
        document.querySelectorAll('.post-carousel:not([data-carousel-initialized])').forEach(carousel => {
            carousel.dataset.carouselInitialized = 'true';
            carousel.dataset.currentIndex = '0';

            const container = carousel.querySelector('.carousel-container');
            const slides = carousel.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;

            if (!container || totalSlides === 0) return;

            // Ocultar botón prev inicialmente
            const prevBtn = carousel.querySelector('.carousel-prev');
            if (prevBtn) prevBtn.classList.add('hidden');

            // Detectar cambio de slide por scroll nativo
            let scrollTimeout;
            container.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const slideWidth = container.offsetWidth;
                    if (slideWidth > 0) {
                        const newIndex = Math.round(container.scrollLeft / slideWidth);
                        const clampedIndex = Math.max(0, Math.min(newIndex, totalSlides - 1));
                        const currentIndex = parseInt(carousel.dataset.currentIndex || '0');
                        if (clampedIndex !== currentIndex) {
                            updateCarouselUI(carousel, clampedIndex);
                        }
                    }
                }, 50);
            }, { passive: true });

            // Click en dots para navegar
            carousel.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                dot.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const slideWidth = container.offsetWidth;
                    container.scrollTo({
                        left: index * slideWidth,
                        behavior: 'smooth'
                    });
                });
            });

            // Variables para detectar si fue scroll o tap
            let scrollStartLeft = 0;
            let wasScrolling = false;
            let touchStartTime = 0;

            container.addEventListener('touchstart', (e) => {
                scrollStartLeft = container.scrollLeft;
                wasScrolling = false;
                touchStartTime = Date.now();
            }, { passive: true });

            container.addEventListener('scroll', () => {
                // Si hubo scroll horizontal significativo, marcar como scrolling
                if (Math.abs(container.scrollLeft - scrollStartLeft) > 15) {
                    wasScrolling = true;
                }
            }, { passive: true });

            // Click/Tap para abrir fullscreen (solo si no fue scroll)
            carousel.addEventListener('click', (e) => {
                // Si fue un scroll reciente, ignorar
                if (wasScrolling) {
                    console.log('[Carousel] Click ignorado - fue scroll');
                    e.stopPropagation();
                    return;
                }

                // No abrir si click fue en botón de navegación, dot, o controles
                if (e.target.closest('.carousel-btn') || e.target.closest('.carousel-dot') ||
                    e.target.closest('.photo-music-mute-btn') || e.target.closest('.sensitive-reveal-btn') ||
                    e.target.closest('.music-badge')) {
                    console.log('[Carousel] Click ignorado - fue en control');
                    return;
                }

                // Solo abrir si el tap fue rápido (< 300ms desde touchstart)
                const tapDuration = Date.now() - touchStartTime;
                if (tapDuration > 500) {
                    console.log('[Carousel] Click ignorado - tap muy largo:', tapDuration);
                    return;
                }

                // Abrir fullscreen con el índice actual
                const postId = parseInt(carousel.dataset.postId);
                const currentIndex = parseInt(carousel.dataset.currentIndex || '0');
                console.log('[Carousel] Abriendo fullscreen - postId:', postId, 'carouselIndex:', currentIndex);
                if (postId && typeof window.openFullscreenViewer === 'function') {
                    window.openFullscreenViewer(e, postId, currentIndex);
                }
            });

            // Reset wasScrolling después de touchend
            container.addEventListener('touchend', () => {
                setTimeout(() => {
                    wasScrolling = false;
                }, 200);
            }, { passive: true });
        });
    }

    // Inicializar carruseles cuando el DOM esté listo (diferido)
    document.addEventListener('DOMContentLoaded', function() {
        var defer = window.requestIdleCallback || function(cb) { setTimeout(cb, 150); };
        defer(initCarousels);
    });

    // ========================================
    // FUNCIONES DEL MENU DE 3 PUNTOS
    // ========================================

    // Toggle del menu dropdown
    // ⚠️ GLOBAL para onclick en HTML
    window.togglePostMenu = function(event, element) {
        event.stopPropagation();
        const dropdown = element.querySelector('.post-menu-dropdown');

        // Cerrar todos los demas menus abiertos
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            if (d !== dropdown) d.classList.remove('show');
        });

        // Solo toggle si dropdown existe
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    };

    // Cerrar menus al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Ir a la publicacion
    // ⚠️ GLOBAL para onclick en HTML
    window.irAPublicacion = function(postId) {
        window.location.href = '/Feed/Detalle/' + postId;
    };

    // Copiar enlace
    // ⚠️ GLOBAL para onclick en HTML
    window.copiarEnlace = function(postId) {
        const url = window.location.origin + '/Feed/Detalle/' + postId;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Enlace copiado al portapapeles');
        }).catch(() => {
            // Fallback para navegadores sin soporte de clipboard
            const input = document.createElement('input');
            input.value = url;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('Enlace copiado al portapapeles');
        });
        cerrarMenus();
    };

    // Agregar a favoritos
    // ⚠️ GLOBAL para onclick en HTML
    window.agregarFavorito = async function(postId, btn) {
        try {
            const res = await fetch('/Feed/ToggleFavorito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}`
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || (data.esFavorito ? 'Guardado en favoritos' : 'Eliminado de favoritos'));
                // Actualizar texto del boton
                const textNode = btn.childNodes[btn.childNodes.length - 1];
                textNode.textContent = data.esFavorito ? ' Quitar de favoritos' : ' Agregar a favoritos';
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
        cerrarMenus();
    };

    // Dejar de seguir
    // ⚠️ GLOBAL para onclick en HTML
    window.dejarDeSeguir = async function(userId, tipoLado, btn) {
        try {
            const res = await fetch('/Feed/DejarDeSeguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || 'Has dejado de seguir a este usuario');
            } else {
                showToast(data.message || 'Error al dejar de seguir');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
        cerrarMenus();
    };

    // ========================================
    // SISTEMA DE REPORTES ESTILO INSTAGRAM
    // ========================================
    let currentReportPostId = null;
    let currentReportReason = '';
    let requiresDetails = false;

    // Abrir modal de reportes
    // ⚠️ GLOBAL para onclick en HTML
    window.reportarContenido = function(postId) {
        currentReportPostId = postId;
        currentReportReason = '';
        requiresDetails = false;

        // Resetear estado del modal
        document.getElementById('reportMainContent').style.display = 'block';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');
        document.getElementById('reportDetailsStep').classList.remove('show');
        document.getElementById('reportConfirmation').classList.remove('show');
        document.getElementById('reportDetails').value = '';

        // Mostrar modal
        document.getElementById('reportModal').classList.add('show');
        document.body.style.overflow = 'hidden';

        cerrarMenus();
    };

    // Cerrar modal de reportes
    // ⚠️ GLOBAL para onclick en HTML
    window.closeReportModal = function() {
        document.getElementById('reportModal').classList.remove('show');
        document.body.style.overflow = '';
        currentReportPostId = null;
        currentReportReason = '';
    };

    // Mostrar opciones principales
    // ⚠️ GLOBAL para onclick en HTML
    window.showMainReportOptions = function() {
        document.getElementById('reportMainContent').style.display = 'block';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');
        document.getElementById('reportDetailsStep').classList.remove('show');
    };

    // Mostrar subopciones
    // ⚠️ GLOBAL para onclick en HTML
    window.showReportSuboptions = function(category) {
        document.getElementById('reportMainContent').style.display = 'none';

        if (category === 'violencia') {
            document.getElementById('reportSubViolencia').classList.add('show');
        } else if (category === 'sexual') {
            document.getElementById('reportSubSexual').classList.add('show');
        }
    };

    // Seleccionar motivo de reporte
    // ⚠️ GLOBAL para onclick en HTML
    window.selectReportReason = function(reason, needsDetails) {
        currentReportReason = reason;
        requiresDetails = needsDetails;

        // Ocultar todas las secciones
        document.getElementById('reportMainContent').style.display = 'none';
        document.getElementById('reportSubViolencia').classList.remove('show');
        document.getElementById('reportSubSexual').classList.remove('show');

        // Mostrar paso de detalles o enviar directamente
        if (needsDetails) {
            document.getElementById('selectedReasonTitle').textContent = reason;
            document.getElementById('reportDetailsStep').classList.add('show');
            document.getElementById('reportDetails').focus();
        } else {
            // Enviar reporte directamente con el motivo seleccionado
            submitReportWithReason(reason);
        }
    };

    // Enviar reporte con motivo
    async function submitReportWithReason(reason) {
        const submitBtn = document.getElementById('submitReportBtn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
        }

        try {
            const res = await fetch('/Feed/Reportar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${currentReportPostId}&motivo=${encodeURIComponent(reason)}`
            });
            const data = await res.json();

            // Mostrar confirmación
            document.getElementById('reportMainContent').style.display = 'none';
            document.getElementById('reportSubViolencia').classList.remove('show');
            document.getElementById('reportSubSexual').classList.remove('show');
            document.getElementById('reportDetailsStep').classList.remove('show');
            document.getElementById('reportConfirmation').classList.add('show');

        } catch (err) {
            showToast('Error al enviar reporte');
            closeReportModal();
        }

        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enviar reporte';
        }
    }

    // Enviar reporte desde el formulario de detalles
    // ⚠️ GLOBAL para onclick en HTML
    window.submitReport = async function() {
        const details = document.getElementById('reportDetails').value.trim();
        let fullReason = currentReportReason;

        if (details) {
            fullReason += ': ' + details;
        }

        await submitReportWithReason(fullReason);
    };

    // Cerrar modal al hacer clic fuera
    document.getElementById('reportModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeReportModal();
        }
    });

    // Cerrar con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('reportModal')?.classList.contains('show')) {
            closeReportModal();
        }
    });

    // Bloquear usuario
    // ⚠️ GLOBAL para onclick en HTML
    window.bloquearUsuario = async function(userId, nombreUsuario) {
        cerrarMenus();

        const confirmar = confirm(`¿Estás seguro de que quieres bloquear a ${nombreUsuario}?\n\nAl bloquear:\n• No verás su contenido\n• No podrás enviarle mensajes\n• Se cancelarán suscripciones mutuas`);
        if (!confirmar) {
            return;
        }

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
            const res = await fetch('/Usuario/BloquearUsuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': token
                },
                body: JSON.stringify({ usuarioId: userId })
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || 'Usuario bloqueado correctamente');
                // Ocultar posts del usuario bloqueado
                document.querySelectorAll(`[data-user-id="${userId}"]`).forEach(post => {
                    const article = post.closest('.post');
                    if (article) {
                        article.style.display = 'none';
                    }
                });
                // Recargar después de un momento
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.message || 'Error al bloquear usuario');
            }
        } catch (err) {
            showToast('Error al bloquear usuario');
        }
    };

    // Cerrar todos los menus
    function cerrarMenus() {
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            d.classList.remove('show');
        });
    }

    // ========================================
    // VIDEO CONTROLS - SIMPLIFICADO
    // ========================================

    // Toggle play/pause (legacy - usar handleVideoClick preferentemente)
    function toggleVideoPlay(event, video) {
        event.stopPropagation();
        event.preventDefault();
        userHasInteracted = true;

        if (video.paused) {
            pauseAllVideosExcept(video);
            video.muted = isGlobalMuted;
            video.play().then(() => {
                updateVideoState(video, true);
            }).catch(() => {
                updateVideoState(video, false);
            });
        } else {
            video.pause();
            updateVideoState(video, false);
        }
    }

    // Toggle mute global
    // ⚠️ GLOBAL para que onclick del HTML pueda accederla
    window.toggleVideoMute = function(event, btn) {
        event.stopPropagation();
        event.preventDefault();
        userHasInteracted = true;

        isGlobalMuted = !isGlobalMuted;

        // Aplicar a todos los videos
        document.querySelectorAll('.feed-video').forEach(v => {
            v.muted = isGlobalMuted;
        });

        // Aplicar a audio de fotos
        if (isGlobalMuted) {
            // Pausar el audio de foto actual si existe
            if (window.currentPhotoAudio) {
                if (window.iOSMediaFix?.isIOS) {
                    window.iOSMediaFix.pause(window.currentPhotoAudio);
                } else {
                    window.currentPhotoAudio.pause();
                }
                // Quitar indicador de playing del badge
                document.querySelectorAll('.music-badge.playing').forEach(b => {
                    b.classList.remove('playing');
                });
            }
        } else {
            // Si se activa el audio, intentar reproducir la música de la foto visible
            const visiblePhotoWithMusic = document.querySelector('.post-media[data-music-observed] .photo-audio-player');
            if (visiblePhotoWithMusic) {
                const postMedia = visiblePhotoWithMusic.closest('.post-media');
                const rect = postMedia?.getBoundingClientRect();
                // Verificar si está visible en el viewport
                if (rect && rect.top < window.innerHeight && rect.bottom > 0) {
                    const startTime = parseFloat(visiblePhotoWithMusic.dataset.start) || 0;
                    let volume = parseFloat(visiblePhotoWithMusic.dataset.volume) || 0.7;
                    if (volume > 1) volume = volume / 10;
                    volume = Math.min(1, Math.max(0, volume));

                    if (window.iOSMediaFix?.isIOS) {
                        window.iOSMediaFix.playPhotoMusic(visiblePhotoWithMusic, { startTime, volume });
                    } else {
                        visiblePhotoWithMusic.currentTime = startTime;
                        visiblePhotoWithMusic.volume = volume;
                        visiblePhotoWithMusic.play().catch(() => {});
                    }
                    window.currentPhotoAudio = visiblePhotoWithMusic;
                    const badge = postMedia?.querySelector('.music-badge');
                    if (badge) badge.classList.add('playing');
                }
            }
        }

        updateAllMuteIcons();
    };

    // Toggle mute para música de foto
    // ⚠️ GLOBAL para onclick en HTML
    window.togglePhotoMusicMute = function(event, btn) {
        event.stopPropagation();
        event.preventDefault();
        userHasInteracted = true;

        isGlobalMuted = !isGlobalMuted;

        // Aplicar a todos los videos también
        document.querySelectorAll('.feed-video').forEach(v => {
            v.muted = isGlobalMuted;
        });

        // Aplicar a audio de fotos
        if (isGlobalMuted) {
            // Pausar el audio de foto actual si existe
            if (window.currentPhotoAudio) {
                if (window.iOSMediaFix?.isIOS) {
                    window.iOSMediaFix.pause(window.currentPhotoAudio);
                } else {
                    window.currentPhotoAudio.pause();
                }
                // Quitar indicador de playing del badge
                document.querySelectorAll('.music-badge.playing').forEach(b => {
                    b.classList.remove('playing');
                });
            }
        } else {
            // Si se activa el audio, intentar reproducir la música de la foto actual
            const postMedia = btn.closest('.post-media');
            const audioPlayer = postMedia?.querySelector('.photo-audio-player');
            if (audioPlayer) {
                const startTime = parseFloat(audioPlayer.dataset.start) || 0;
                let volume = parseFloat(audioPlayer.dataset.volume) || 0.7;
                if (volume > 1) volume = volume / 10;
                volume = Math.min(1, Math.max(0, volume));

                if (window.iOSMediaFix?.isIOS) {
                    window.iOSMediaFix.playPhotoMusic(audioPlayer, { startTime, volume });
                } else {
                    audioPlayer.currentTime = startTime;
                    audioPlayer.volume = volume;
                    audioPlayer.play().catch(() => {});
                }
                window.currentPhotoAudio = audioPlayer;
                const badge = postMedia?.querySelector('.music-badge');
                if (badge) badge.classList.add('playing');
            }
        }

        updateAllMuteIcons();
    };

    // ========================================
    // AUDIO POST CONTROLS
    // ========================================
    let currentPostAudio = null;

    // ⚠️ GLOBAL para onclick en HTML
    window.toggleAudioPlay = function(event, btn) {
        event.stopPropagation();
        event.preventDefault();

        const container = btn.closest('.post-media-audio');
        const audio = container.querySelector('.post-audio-player');
        if (!audio) return;

        const playIcon = btn.querySelector('.icon-play');
        const pauseIcon = btn.querySelector('.icon-pause');

        if (audio.paused) {
            // Pausar cualquier otro audio reproduciéndose
            if (currentPostAudio && currentPostAudio !== audio) {
                currentPostAudio.pause();
                const otherContainer = currentPostAudio.closest('.post-media-audio');
                if (otherContainer) {
                    otherContainer.classList.remove('playing');
                    const otherPlayIcon = otherContainer.querySelector('.icon-play');
                    const otherPauseIcon = otherContainer.querySelector('.icon-pause');
                    if (otherPlayIcon) otherPlayIcon.style.display = 'block';
                    if (otherPauseIcon) otherPauseIcon.style.display = 'none';
                }
            }

            audio.play().then(() => {
                container.classList.add('playing');
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                currentPostAudio = audio;
            }).catch(err => {
            });
        } else {
            audio.pause();
            container.classList.remove('playing');
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        }
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.toggleAudioMute = function(event, btn) {
        event.stopPropagation();
        event.preventDefault();

        const container = btn.closest('.post-media-audio');
        const audio = container.querySelector('.post-audio-player');
        if (!audio) return;

        const mutedIcon = btn.querySelector('.muted-icon');
        const unmutedIcon = btn.querySelector('.unmuted-icon');

        audio.muted = !audio.muted;

        if (audio.muted) {
            mutedIcon.style.display = 'block';
            unmutedIcon.style.display = 'none';
        } else {
            mutedIcon.style.display = 'none';
            unmutedIcon.style.display = 'block';
        }
    };

    // Actualizar barra de progreso del audio (diferido)
    document.addEventListener('DOMContentLoaded', function() {
        var defer = window.requestIdleCallback || function(cb) { setTimeout(cb, 300); };
        defer(function() {
            document.querySelectorAll('.post-audio-player').forEach(audio => {
            audio.addEventListener('timeupdate', function() {
                const container = this.closest('.post-media-audio');
                const progressBar = container?.querySelector('.audio-progress-bar');
                if (progressBar && this.duration) {
                    const percent = (this.currentTime / this.duration) * 100;
                    progressBar.style.width = percent + '%';
                }
            });

            audio.addEventListener('ended', function() {
                const container = this.closest('.post-media-audio');
                if (container) {
                    container.classList.remove('playing');
                    const playIcon = container.querySelector('.icon-play');
                    const pauseIcon = container.querySelector('.icon-pause');
                    if (playIcon) playIcon.style.display = 'block';
                    if (pauseIcon) pauseIcon.style.display = 'none';
                    const progressBar = container.querySelector('.audio-progress-bar');
                    if (progressBar) progressBar.style.width = '0%';
                }
            });
            });
        }); // cierra defer
    });

    // Inicializar observers para videos existentes al cargar la página (diferido)
    document.addEventListener('DOMContentLoaded', function() {
        var defer = window.requestIdleCallback || function(cb) { setTimeout(cb, 250); };
        defer(function() {
            // Usar la funcion unificada de inicializacion
            initVideoObserversForNewPosts();
            // Actualizar iconos de mute
            updateAllMuteIcons();
        });
    });

    // ========================================
    // TOOLTIP DE LIKES (Desktop hover + Mobile long press)
    // ========================================

    let likesTooltipTimeout = null;
    let likesCache = {};
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 500; // ms

    // Detectar si es dispositivo táctil
    function isTouchDevice() {
        return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    // Obtener likes de un contenido
    async function fetchLikesUsuarios(contenidoId) {
        // Usar cache si existe y es reciente (5 minutos)
        const cached = likesCache[contenidoId];
        if (cached && (Date.now() - cached.timestamp) < 300000) {
            return cached.data;
        }

        try {
            const response = await fetch(`/Feed/ObtenerLikesUsuarios?contenidoId=${contenidoId}&limit=10`);
            const data = await response.json();

            if (data.success) {
                likesCache[contenidoId] = {
                    data: data,
                    timestamp: Date.now()
                };
                return data;
            }
            return null;
        } catch (error) {
            return null;
        }
    }

    // Renderizar lista de usuarios con botón de seguir
    function renderLikesUsuarios(usuarios, total, hayMas, isModal = false) {
        if (!usuarios || usuarios.length === 0) {
            return isModal
                ? '<div class="likes-modal-empty"><i class="far fa-heart"></i><p>Aún no hay likes</p></div>'
                : '<div class="likes-tooltip-loading">Sin likes aún</div>';
        }

        const prefix = isModal ? 'likes-modal' : 'likes-tooltip';
        let html = '';

        usuarios.forEach(u => {
            const verifiedBadge = u.esVerificado ? '<i class="fas fa-check-circle verified"></i>' : '';

            // Botón de seguir solo en modal y si no soy yo
            let followBtn = '';
            if (isModal && !u.esSoyYo) {
                if (u.loSigo) {
                    followBtn = `<button class="likes-modal-follow-btn siguiendo" data-userid="${u.id}" onclick="seguirDesdeModalLikes(event, '${u.id}', this)">Siguiendo</button>`;
                } else {
                    followBtn = `<button class="likes-modal-follow-btn seguir" data-userid="${u.id}" onclick="seguirDesdeModalLikes(event, '${u.id}', this)">Seguir</button>`;
                }
            }

            html += `
                <div class="${prefix}-user">
                    <a href="/Feed/Perfil/${u.id}" class="${prefix}-user-link" style="display:flex;align-items:center;gap:12px;flex:1;text-decoration:none;color:inherit;">
                        <img src="${u.foto}" alt="" class="${prefix}-avatar" onerror="this.src='/images/default-avatar.svg'">
                        <div class="${prefix}-info">
                            <div class="${prefix}-username">${escapeHtml(u.username)}${verifiedBadge}</div>
                            <div class="${prefix}-name">${escapeHtml(u.nombre)}</div>
                        </div>
                    </a>
                    ${followBtn}
                </div>
            `;
        });

        if (hayMas && !isModal) {
            html += `<div class="likes-tooltip-more">y ${total - usuarios.length} más...</div>`;
        }

        if (hayMas && isModal) {
            html += `<div class="likes-modal-loading-more">y ${total - usuarios.length} personas más</div>`;
        }

        return html;
    }

    // Función para seguir/dejar de seguir desde el modal de likes
    window.seguirDesdeModalLikes = async function(event, userId, btn) {
        event.preventDefault();
        event.stopPropagation();

        if (btn.disabled) return;
        btn.disabled = true;

        const estaSiguiendo = btn.classList.contains('siguiendo');

        // Si no hay conexión y es para seguir (no dejar de seguir), guardar offline
        if (!navigator.onLine && !estaSiguiendo && window.LadoOfflineSync) {
            await window.LadoOfflineSync.savePendingFollow(userId);
            btn.classList.remove('seguir');
            btn.classList.add('siguiendo');
            btn.textContent = 'Siguiendo';
            _feedToast('Seguimiento guardado - se sincronizará cuando vuelva la conexión');
            btn.disabled = false;
            return;
        }

        try {
            const response = await fetch(estaSiguiendo ? '/Feed/DejarDeSeguir' : '/Feed/Seguir', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${userId}`
            });

            const data = await response.json();

            if (data.success) {
                if (data.siguiendo) {
                    btn.classList.remove('seguir');
                    btn.classList.add('siguiendo');
                    btn.textContent = 'Siguiendo';
                } else {
                    btn.classList.remove('siguiendo');
                    btn.classList.add('seguir');
                    btn.textContent = 'Seguir';
                }

                // Limpiar cache para refrescar datos
                Object.keys(likesCache).forEach(key => delete likesCache[key]);

                // Feedback haptico
                if (window.LadoHaptic) {
                    window.LadoHaptic.light();
                }
            } else {
                _feedToast(data.message || 'Error al procesar');
            }
        } catch (error) {
            console.error('Error al seguir:', error);
            // Si falló por red y era para seguir, guardar offline
            if (!navigator.onLine && !estaSiguiendo && window.LadoOfflineSync) {
                await window.LadoOfflineSync.savePendingFollow(userId);
                btn.classList.remove('seguir');
                btn.classList.add('siguiendo');
                btn.textContent = 'Siguiendo';
                _feedToast('Seguimiento guardado - se sincronizará cuando vuelva la conexión');
            } else {
                _feedToast('Error de conexión');
            }
        } finally {
            btn.disabled = false;
        }
    };

    // Mostrar tooltip (Desktop)
    function showLikesTooltip(element, contenidoId) {
        if (isTouchDevice()) return; // No mostrar en móvil

        const tooltip = document.getElementById('likesTooltip');
        const list = document.getElementById('likesTooltipList');

        // Posicionar tooltip
        const rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';

        // Mostrar loading
        list.innerHTML = '<div class="likes-tooltip-loading"><i class="fas fa-spinner fa-spin"></i></div>';
        tooltip.classList.add('visible');

        // Cargar datos
        fetchLikesUsuarios(contenidoId).then(data => {
            if (data) {
                document.getElementById('likesTooltipHeader').textContent = `${data.total} Me gusta`;
                list.innerHTML = renderLikesUsuarios(data.usuarios, data.total, data.hayMas, false);
            } else {
                list.innerHTML = '<div class="likes-tooltip-loading">Error al cargar</div>';
            }
        });
    }

    // Ocultar tooltip
    function hideLikesTooltip() {
        const tooltip = document.getElementById('likesTooltip');
        tooltip.classList.remove('visible');
    }

    // Mostrar modal de likes
    function showLikesModal(contenidoId) {
        const overlay = document.getElementById('likesModalOverlay');
        const list = document.getElementById('likesModalList');

        // Mostrar loading
        list.innerHTML = '<div class="likes-tooltip-loading"><i class="fas fa-spinner fa-spin"></i></div>';
        overlay.classList.add('visible');

        // Prevenir scroll del body sin causar shift
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = scrollbarWidth + 'px';

        // Cargar datos
        fetchLikesUsuarios(contenidoId).then(data => {
            if (data) {
                list.innerHTML = renderLikesUsuarios(data.usuarios, data.total, data.hayMas, true);
            } else {
                list.innerHTML = '<div class="likes-modal-empty"><i class="fas fa-exclamation-circle"></i><p>Error al cargar</p></div>';
            }
        });
    }

    // Cerrar modal
    // ⚠️ GLOBAL para onclick en HTML
    window.closeLikesModal = function() {
        const overlay = document.getElementById('likesModalOverlay');
        overlay.classList.remove('visible');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    };

    // Inicializar eventos de likes en elementos .post-likes
    function initLikesTooltipEvents() {
        document.querySelectorAll('.post-likes').forEach(likesEl => {
            // Evitar inicializar múltiples veces
            if (likesEl.dataset.likesInitialized) return;
            likesEl.dataset.likesInitialized = 'true';

            const postEl = likesEl.closest('.post') || likesEl.closest('article');
            const postId = postEl?.querySelector('.like-btn')?.dataset?.id ||
                          postEl?.dataset?.postId;

            if (!postId) return;

            // Agregar clase clickable y cursor pointer
            const likesCount = likesEl.querySelector('.post-likes-count');
            if (likesCount) {
                likesCount.classList.add('clickable');
            }
            likesEl.style.cursor = 'pointer';

            // Click para abrir modal (tanto desktop como móvil)
            likesEl.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Mostrar modal
                showLikesModal(postId);
            });
        });
    }

    // Inicializar al cargar (diferido - no crítico)
    document.addEventListener('DOMContentLoaded', function() {
        var defer = window.requestIdleCallback || function(cb) { setTimeout(cb, 400); };
        defer(initLikesTooltipEvents);
    });

    // Re-inicializar cuando se carguen nuevos posts
    const likesObserver = new MutationObserver((mutations) => {
        mutations.forEach(mutation => {
            mutation.addedNodes.forEach(node => {
                if (node.nodeType === 1 && (node.classList?.contains('post') || node.tagName === 'ARTICLE')) {
                    initLikesTooltipEvents();
                }
            });
        });
    });

    const likesContainer = document.querySelector('.feed-posts') || document.querySelector('.feed-container');
    if (likesContainer) {
        likesObserver.observe(likesContainer, { childList: true, subtree: true });
    }
</script>

<!-- ========================================
     POPUP DE MENSAJES - ESTILO INSTAGRAM DM
     ======================================== -->
<style>
    /* Floating Messages Popup Container - Oculto */
    .dm-popup-container {
        display: none !important;
    }

    /* FAB Button */
    .dm-fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #262626;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .dm-fab:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }

    .dm-fab svg {
        width: 26px;
        height: 26px;
        stroke: white;
    }

    .dm-fab .dm-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #262626;
        padding: 0 5px;
    }

    /* Modal Popup */
    .dm-modal {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 400px;
        height: 480px;
        background: #262626;
        border-radius: 12px;
        overflow: hidden;
        display: none;
        flex-direction: column;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        animation: dmSlideUp 0.25s ease;
    }

    .dm-modal.show {
        display: flex;
    }

    @@keyframes dmSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Header */
    .dm-header {
        padding: 16px 20px;
        background: #262626;
        border-bottom: 1px solid #363636;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .dm-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dm-header-title {
        color: #ffffff;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .dm-header-badge {
        background: #ef4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
    }

    .dm-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dm-header-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
        transition: background 0.2s, color 0.2s;
    }

    .dm-header-btn:hover {
        background: #363636;
        color: white;
    }

    .dm-header-btn svg {
        width: 20px;
        height: 20px;
    }

    /* Conversations List */
    .dm-conversations {
        flex: 1;
        overflow-y: auto;
        background: #262626;
    }

    .dm-conv-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        gap: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dm-conv-item:hover {
        background: #363636;
    }

    .dm-conv-avatar {
        position: relative;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
    }

    .dm-conv-avatar img,
    .dm-conv-avatar .dm-avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .dm-avatar-placeholder {
        background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
    }

    .dm-online-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        background: #22c55e;
        border-radius: 50%;
        border: 3px solid #262626;
    }

    .dm-conv-info {
        flex: 1;
        min-width: 0;
    }

    .dm-conv-name {
        color: #ffffff;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
        display: block;
    }

    .dm-conv-status {
        color: #a8a8a8;
        font-size: 13px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dm-conv-item.unread .dm-conv-status {
        color: #ffffff;
        font-weight: 500;
    }

    .dm-conv-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .dm-conv-time {
        color: #a8a8a8;
        font-size: 12px;
    }

    .dm-conv-unread {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
    }

    /* Empty State */
    .dm-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
        padding: 40px;
        text-align: center;
    }

    .dm-empty svg {
        width: 64px;
        height: 64px;
        stroke: #525252;
        margin-bottom: 16px;
    }

    .dm-empty p {
        margin: 0 0 16px;
        font-size: 14px;
    }

    .dm-empty-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dm-empty-btn:hover {
        background: #2563eb;
    }

    /* Loading */
    .dm-loading {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a8a8a8;
    }

    /* Footer with new message button */
    .dm-footer {
        padding: 12px 16px;
        border-top: 1px solid #363636;
        display: flex;
        justify-content: flex-end;
    }

    .dm-new-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #262626;
        border: 1px solid #525252;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s, border-color 0.2s;
    }

    .dm-new-btn:hover {
        background: #363636;
        border-color: #a8a8a8;
    }

    .dm-new-btn svg {
        width: 20px;
        height: 20px;
    }

    /* Responsive */
    @@media (max-width: 480px) {
        .dm-modal {
            width: calc(100vw - 32px);
            right: -8px;
            height: 60vh;
        }

        .dm-popup-container {
            bottom: 16px;
            right: 16px;
        }
    }

    /* Ocultar FAB de mensajes en móvil - se muestra en header */
    @@media (max-width: 768px) {
        .dm-popup-container {
            display: none !important;
        }
    }
</style>

<!-- ========================================
     STORY VIEWER MODAL - Visor pantalla completa
     ======================================== -->
<div class="story-viewer-overlay" id="storyViewerOverlay">
    <div class="story-viewer-container">
        <!-- Header con progreso -->
        <div class="story-viewer-header">
            <div class="story-progress-container" id="storyProgressContainer">
                <!-- Barras de progreso se generan dinámicamente -->
            </div>
            <div class="story-viewer-user">
                <img src="" alt="" class="story-viewer-avatar" id="storyViewerAvatar" style="display:none;">
                <div class="story-viewer-avatar-placeholder" id="storyViewerAvatarPlaceholder">?</div>
                <div>
                    <div class="story-viewer-username" id="storyViewerUsername">Usuario</div>
                    <div class="story-viewer-time" id="storyViewerTime">Hace 2h</div>
                </div>
            </div>
        </div>

        <!-- Botones de acción en el header -->
        <div class="story-header-actions">
            <!-- Botón de audio/mute para videos (inicia muted para iOS) -->
            <button class="story-audio-btn" id="storyAudioBtn" onclick="toggleStoryAudio()" style="display:none;" title="Activar sonido">
                <svg class="audio-on-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="display:none;">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg class="audio-off-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            </button>
            <!-- Botón menú -->
            <button class="story-menu-btn" onclick="toggleStoryMenu(event)">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <circle cx="12" cy="5" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="19" r="2"/>
                </svg>
            </button>
            <!-- Menú dropdown -->
            <div class="story-menu-dropdown" id="storyMenuDropdown">
                <!-- Guardar en destacados (solo para stories propias) -->
                <button class="story-menu-item" id="btnGuardarDestacados" onclick="abrirModalDestacados()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                    <span>Guardar en destacados</span>
                </button>
                <!-- Enviar a usuario específico -->
                <button class="story-menu-item" id="btnEnviarStoryUsuario" onclick="abrirModalEnviarStory()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                    <span>Enviar a...</span>
                </button>
                <button class="story-menu-item" id="btnDescargarStory" onclick="descargarStoryActual()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span>Descargar</span>
                </button>
                <button class="story-menu-item danger" id="btnEliminarStory" onclick="eliminarStoryActual()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                    <span>Eliminar esta historia</span>
                </button>
                <button class="story-menu-item" id="btnSilenciarHistorias" onclick="silenciarHistoriasCreador()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M17 14V2"/>
                        <path d="M9 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4"/>
                        <path d="M17 10h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-4"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                    <span id="txtSilenciarHistorias">Silenciar historias</span>
                </button>
                <button class="story-menu-item" onclick="reportarStory()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                        <line x1="4" y1="22" x2="4" y2="15"/>
                    </svg>
                    <span>Reportar</span>
                </button>
            </div>
            <!-- Botón cerrar -->
            <button class="story-viewer-close" onclick="cerrarVisorStories()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Contenido (imagen/video) -->
        <div class="story-viewer-content" id="storyViewerContent">
            <!-- Fondo blur estilo Instagram -->
            <div class="story-blur-background" id="storyBlurBg"></div>

            <!-- Indicador de carga -->
            <div class="story-loading-indicator" id="storyLoadingIndicator" style="display:none;">
                <div class="story-loading-spinner"></div>
                <span>Cargando...</span>
            </div>

            <img src="" alt="" class="story-viewer-media" id="storyViewerImage" style="display:none;">
            <video class="story-viewer-video" id="storyViewerVideo" playsinline muted style="display:none;"></video>

            <!-- Contenedor de overlays del editor -->
            <div class="story-overlays-container" id="storyOverlaysContainer"></div>

            <div class="story-viewer-text" id="storyViewerText"></div>

            <!-- Badge de publicidad (solo visible en anuncios) -->
            <div class="story-ad-badge" id="storyAdBadge" style="display:none;">Publicidad</div>

            <!-- Botón CTA de anuncio (solo visible en anuncios) -->
            <button class="story-ad-cta" id="storyAdCta" style="display:none;" onclick="clickAnuncioStory()">
                <span id="storyAdCtaText">Ver mas</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 17L17 7M17 7H7M17 7V17"/>
                </svg>
            </button>

            <!-- Zonas táctiles para navegar -->
            <div class="story-nav-zone prev" onclick="storyAnterior()"></div>
            <div class="story-nav-zone next" onclick="storySiguiente()"></div>
        </div>

        <!-- Audio para música de stories -->
        <audio id="storyMusicPlayer" preload="auto" style="display:none;"></audio>

        <!-- Indicador de música -->
        <div class="story-music-indicator" id="storyMusicIndicator" style="display:none;">
            <div class="music-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
            </div>
            <div class="music-info">
                <span class="music-title" id="storyMusicTitle">Cancion</span>
                <span class="music-artist" id="storyMusicArtist">Artista</span>
            </div>
        </div>

        <!-- Navegación entre usuarios -->
        <button class="story-user-nav prev" id="storyUserNavPrev" onclick="usuarioStoriesAnterior()" style="display:none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <button class="story-user-nav next" id="storyUserNavNext" onclick="usuarioStoriesSiguiente()" style="display:none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>

        <!-- Feedback de envío -->
        <div class="story-send-feedback" id="storySendFeedback">
            <span class="feedback-icon">✓</span>
            <span class="feedback-text">Enviado</span>
        </div>

        <!-- Barra de acciones estilo Instagram mejorada -->
        <div class="story-bottom-bar" id="storyBottomBar">
            <!-- Contador de visualizaciones (solo para propietario) -->
            <div class="story-views-counter" id="storyViewsCounter" onclick="abrirVisualizacionesStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span id="storyViewsCount">0</span>
            </div>

            <!-- Acciones del creador (estilo Instagram) -->
            <div class="story-owner-actions" id="storyOwnerActions">
                <!-- WhatsApp -->
                <button class="story-owner-action whatsapp" onclick="compartirStoryWhatsApp()" title="Compartir en WhatsApp">
                    <div class="story-owner-action-icon">
                        <svg viewBox="0 0 24 24" fill="white">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                    </div>
                    <span class="story-owner-action-label">WhatsApp</span>
                </button>

                <!-- Destacadas -->
                <button class="story-owner-action" onclick="abrirModalDestacados()" title="Guardar en destacados">
                    <div class="story-owner-action-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                    </div>
                    <span class="story-owner-action-label">Destacar</span>
                </button>

                <!-- Enviar -->
                <button class="story-owner-action" onclick="abrirModalEnviarStory()" title="Enviar a...">
                    <div class="story-owner-action-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                        </svg>
                    </div>
                    <span class="story-owner-action-label">Enviar</span>
                </button>

                <!-- Mas opciones -->
                <button class="story-owner-action" onclick="toggleStoryMenu(event)" title="Mas opciones">
                    <div class="story-owner-action-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="5" r="2"/>
                            <circle cx="12" cy="12" r="2"/>
                            <circle cx="12" cy="19" r="2"/>
                        </svg>
                    </div>
                    <span class="story-owner-action-label">Mas</span>
                </button>
            </div>

            <!-- Fila de reacciones rápidas -->
            <div class="story-reactions-row">
                <button class="story-reaction-btn" onclick="enviarReaccionStory('❤️', this)" title="Me encanta">❤️</button>
                <button class="story-reaction-btn" onclick="enviarReaccionStory('😂', this)" title="Jaja">😂</button>
                <button class="story-reaction-btn" onclick="enviarReaccionStory('😮', this)" title="Wow">😮</button>
                <button class="story-reaction-btn" onclick="enviarReaccionStory('😢', this)" title="Triste">😢</button>
                <button class="story-reaction-btn" onclick="enviarReaccionStory('👏', this)" title="Aplausos">👏</button>
                <button class="story-reaction-btn" onclick="enviarReaccionStory('🔥', this)" title="Fuego">🔥</button>
            </div>

            <!-- Fila de input y acciones -->
            <div class="story-input-row">
                <!-- Input de mensaje -->
                <div class="story-input-wrapper">
                    <input type="text" class="story-input" id="storyMessageInput"
                           placeholder="Responder..."
                           onfocus="pausarTimerStory()"
                           onblur="reanudarTimerStory()"
                           onkeydown="if(event.key === 'Enter' && !event.shiftKey) enviarMensajeStory()">
                    <span class="story-input-hint" title="Presiona Enter para enviar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 10 4 15 9 20"></polyline>
                            <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                        </svg>
                        Enter
                    </span>
                </div>

                <!-- Iconos de acción -->
                <div class="story-bottom-actions">
                    <!-- Like/Corazón -->
                    <button class="story-bottom-btn" id="storyLikeBtn" onclick="toggleStoryLike()" title="Me gusta">
                        <svg viewBox="0 0 24 24" width="26" height="26" id="storyLikeIcon">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="none" stroke="currentColor" stroke-width="2"></path>
                        </svg>
                        <span id="storyLikeCount" class="story-like-count"></span>
                    </button>

                    <!-- Compartir -->
                    <button class="story-bottom-btn" onclick="abrirCompartirStory()" title="Compartir">
                        <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 3L9.218 10.083M22 3l-4.545 18-5.237-7.917M22 3L2 11l7.218 2.083"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div><!-- Cierra story-viewer-container -->
</div><!-- Cierra story-viewer-overlay -->

<!-- ========================================
     MODAL COMPARTIR STORY
     ======================================== -->
<div class="share-story-overlay" id="shareStoryOverlay" onclick="cerrarCompartirStory(event)">
    <div class="share-story-modal" onclick="event.stopPropagation()">
        <div class="share-story-header">
            <h3>Compartir</h3>
            <button class="share-story-close" onclick="cerrarCompartirStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="share-story-options">
            <!-- WhatsApp -->
            <button class="share-story-option" onclick="compartirStoryWhatsApp()">
                <div class="share-option-icon" style="background: #25D366;">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                </div>
                <span>WhatsApp</span>
            </button>

            <!-- Copiar enlace -->
            <button class="share-story-option" onclick="copiarEnlaceStory()">
                <div class="share-option-icon" style="background: var(--primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                </div>
                <span>Copiar enlace</span>
            </button>

            <!-- Facebook -->
            <button class="share-story-option" onclick="compartirStoryFacebook()">
                <div class="share-option-icon" style="background: #1877F2;">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                </div>
                <span>Facebook</span>
            </button>

            <!-- Twitter/X -->
            <button class="share-story-option" onclick="compartirStoryTwitter()">
                <div class="share-option-icon" style="background: #000;">
                    <svg viewBox="0 0 24 24" fill="white" width="20" height="20">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </div>
                <span>X</span>
            </button>

            <!-- Telegram -->
            <button class="share-story-option" onclick="compartirStoryTelegram()">
                <div class="share-option-icon" style="background: #0088cc;">
                    <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                    </svg>
                </div>
                <span>Telegram</span>
            </button>

            <!-- Enviar mensaje directo -->
            <button class="share-story-option" onclick="enviarStoryPorMensaje()">
                <div class="share-option-icon" style="background: linear-gradient(135deg, #833AB4, #E1306C, #F77737);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="22" height="22">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                </div>
                <span>Mensaje</span>
            </button>

            <!-- Más opciones (Web Share API) -->
            <button class="share-story-option" id="shareStoryMoreBtn" onclick="compartirStoryNativo()" style="display:none;">
                <div class="share-option-icon" style="background: #666;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="22" height="22">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </svg>
                </div>
                <span>Más</span>
            </button>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL GUARDAR EN DESTACADOS
     ======================================== -->
<div class="story-destacados-overlay" id="storyDestacadosOverlay" onclick="cerrarModalDestacados(event)">
    <div class="story-destacados-modal" onclick="event.stopPropagation()">
        <div class="story-destacados-header">
            <h3>Guardar en destacados</h3>
            <button class="story-destacados-close" onclick="cerrarModalDestacados()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="story-destacados-body">
            <!-- Crear nuevo grupo -->
            <div class="destacados-nuevo-grupo">
                <div class="destacados-nuevo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </div>
                <input type="text" id="nuevoGrupoNombre" placeholder="Nuevo grupo..." maxlength="50"
                       onkeydown="if(event.key === 'Enter') crearNuevoGrupoYGuardar()">
                <button class="destacados-crear-btn" onclick="crearNuevoGrupoYGuardar()">Crear</button>
            </div>

            <!-- Lista de grupos existentes -->
            <div class="destacados-grupos-lista" id="destacadosGruposLista">
                <!-- Se llena dinámicamente -->
                <div class="destacados-loading">
                    <div class="spinner-small"></div>
                    <span>Cargando grupos...</span>
                </div>
            </div>

            <!-- Guardar sin grupo -->
            <button class="destacados-sin-grupo-btn" onclick="guardarDestacadoSinGrupo()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Guardar sin grupo</span>
            </button>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL ENVIAR STORY A USUARIO
     ======================================== -->
<div class="story-enviar-overlay" id="storyEnviarOverlay" onclick="cerrarModalEnviarStory(event)">
    <div class="story-enviar-modal" onclick="event.stopPropagation()">
        <div class="story-enviar-header">
            <h3>Enviar a...</h3>
            <button class="story-enviar-close" onclick="cerrarModalEnviarStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="story-enviar-body">
            <!-- Buscador de usuarios -->
            <div class="story-enviar-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="enviarStoryBusqueda" placeholder="Buscar usuario..."
                       oninput="buscarUsuariosParaEnviar(this.value)">
            </div>

            <!-- Mensaje opcional -->
            <div class="story-enviar-mensaje">
                <input type="text" id="enviarStoryMensaje" placeholder="Agregar un mensaje (opcional)" maxlength="500">
            </div>

            <!-- Lista de usuarios -->
            <div class="story-enviar-usuarios" id="enviarStoryUsuarios">
                <div class="enviar-story-loading">
                    <span>Escribe para buscar usuarios</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL CREAR STORY
     ======================================== -->
<div class="create-story-modal" id="createStoryModal">
    <div class="create-story-container">
        <div class="create-story-header">
            <h3>Crear historia</h3>
            <button class="create-story-close" onclick="cerrarModalCrearStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="create-story-body">
            <!-- Zona de upload -->
            <div class="create-story-upload" id="createStoryUpload" onclick="document.getElementById('storyFileInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <p><span>Haz clic para subir</span> una foto o video</p>
                <p style="font-size: 12px; margin-top: 8px;">JPG, PNG, MP4 (máx. 30s)</p>
            </div>
            <input type="file" id="storyFileInput" accept="image/*,video/*" style="display:none;" onchange="previsualizarStory(this)">

            <!-- Preview -->
            <div class="create-story-preview" id="createStoryPreview">
                <img src="" alt="" id="storyPreviewImage" style="display:none;">
                <video src="" id="storyPreviewVideo" muted playsinline style="display:none;"></video>
                <button class="create-story-remove-preview" onclick="eliminarPreviewStory()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Texto opcional -->
            <textarea class="create-story-text" id="storyTexto" placeholder="Añade un texto a tu historia (opcional)" rows="2"></textarea>

            <!-- Tipo de lado (solo mostrar si el usuario es creador verificado) -->
            @if (usuarioActual?.CreadorVerificado == true)
            {
                <div class="create-story-tipo">
                    <input type="radio" name="storyTipoLado" id="storyTipoLadoA" value="LadoA" checked>
                    <label for="storyTipoLadoA">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        Lado A
                    </label>
                    <input type="radio" name="storyTipoLado" id="storyTipoLadoB" value="LadoB">
                    <label for="storyTipoLadoB">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zM2 12h20"></path>
                        </svg>
                        Lado B
                    </label>
                </div>
            }
            else
            {
                <input type="hidden" name="storyTipoLado" value="LadoA">
            }

            <!-- Botón crear -->
            <button class="create-story-submit" id="storySubmitBtn" onclick="crearStory()" disabled>
                Compartir historia
            </button>

            <!-- Enlace al editor avanzado -->
            <button type="button" class="create-story-editor-link" onclick="abrirEditorAvanzado()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
                Usar editor avanzado
            </button>
        </div>
    </div>
</div>

<!-- DM Popup HTML -->
<div class="dm-popup-container" id="dmPopup">
    <!-- FAB Button -->
    <button class="dm-fab" id="dmFab" onclick="toggleDmPopup()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
        <span class="dm-badge" id="dmBadge" style="display: @(mensajesNoLeidos > 0 ? "flex" : "none");">@mensajesNoLeidos</span>
    </button>

    <!-- Modal -->
    <div class="dm-modal" id="dmModal">
        <!-- Header -->
        <div class="dm-header">
            <div class="dm-header-left">
                <h5 class="dm-header-title">Mensajes</h5>
                <span class="dm-header-badge" id="dmHeaderBadge" style="display: @(mensajesNoLeidos > 0 ? "flex" : "none");">@mensajesNoLeidos</span>
            </div>
            <div class="dm-header-actions">
                <a href="/Mensajes" class="dm-header-btn" title="Expandir">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                </a>
                <button class="dm-header-btn" onclick="toggleDmPopup()" title="Cerrar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Conversations -->
        <div class="dm-conversations" id="dmConversations">
            <div class="dm-loading">
                <span>Cargando...</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="dm-footer">
            <a href="/Mensajes" class="dm-new-btn" title="Nuevo mensaje">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<script>
    // ========================================
    // DM POPUP - INSTAGRAM STYLE
    // ========================================

    let dmPopupOpen = false;
    let dmConversationsData = [];
    const CURRENT_USER_ID_DM = '@ViewBag.UsuarioActual?.Id';

    function toggleDmPopup() {
        dmPopupOpen = !dmPopupOpen;
        const modal = document.getElementById('dmModal');

        if (dmPopupOpen) {
            modal.classList.add('show');
            loadDmConversations();
        } else {
            modal.classList.remove('show');
        }
    }

    async function loadDmConversations() {
        const container = document.getElementById('dmConversations');
        container.innerHTML = '<div class="dm-loading"><span>Cargando...</span></div>';

        try {
            const response = await fetch('/api/mensajes/conversaciones');
            if (!response.ok) throw new Error('Error');

            dmConversationsData = await response.json();
            renderDmConversations(dmConversationsData);
        } catch (error) {
            container.innerHTML = `
                <div class="dm-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p>No tienes conversaciones aun</p>
                    <a href="/Mensajes" class="dm-empty-btn">Iniciar conversacion</a>
                </div>`;
        }
    }

    function renderDmConversations(conversations) {
        const container = document.getElementById('dmConversations');

        if (!conversations || conversations.length === 0) {
            container.innerHTML = `
                <div class="dm-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p>No tienes conversaciones aun</p>
                    <a href="/Mensajes" class="dm-empty-btn">Iniciar conversacion</a>
                </div>`;
            return;
        }

        let html = '';
        conversations.forEach(conv => {
            const unreadClass = conv.noLeidos > 0 ? 'unread' : '';
            const initial = (conv.nombreUsuario || 'U').charAt(0).toUpperCase();

            html += `<div class="dm-conv-item ${unreadClass}" onclick="openDmChat('${conv.usuarioId}')">`;
            html += '<div class="dm-conv-avatar">';
            if (conv.fotoPerfil) {
                html += `<img src="${conv.fotoPerfil}" alt="${escapeDmHtml(conv.nombreUsuario)}">`;
            } else {
                html += `<div class="dm-avatar-placeholder">${initial}</div>`;
            }
            if (conv.enLinea) html += '<span class="dm-online-dot"></span>';
            html += '</div>';

            html += '<div class="dm-conv-info">';
            html += `<span class="dm-conv-name">${escapeDmHtml(conv.nombreUsuario)}</span>`;

            let statusText = conv.ultimoMensaje || 'Sin mensajes';
            if (conv.enLinea) {
                statusText = 'Activo(a) ahora';
            }
            html += `<span class="dm-conv-status">${escapeDmHtml(statusText)}</span>`;
            html += '</div>';

            html += '<div class="dm-conv-meta">';
            html += `<span class="dm-conv-time">${formatDmTime(conv.fechaUltimoMensaje)}</span>`;
            if (conv.noLeidos > 0) html += '<span class="dm-conv-unread"></span>';
            html += '</div></div>';
        });

        container.innerHTML = html;
    }

    function openDmChat(userId) {
        window.location.href = '/Mensajes/Chat/' + userId;
    }

    function escapeDmHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDmTime(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (hours < 1) return 'Ahora';
        if (hours < 24) return `${hours}h`;
        if (days < 7) return `${days}d`;
        return date.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    async function updateDmBadge() {
        try {
            const response = await fetch('/api/mensajes/no-leidos-count');
            if (response.ok) {
                const data = await response.json();
                const badge = document.getElementById('dmBadge');
                const headerBadge = document.getElementById('dmHeaderBadge');

                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'flex';
                    headerBadge.textContent = data.count;
                    headerBadge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                    headerBadge.style.display = 'none';
                }
            }
        } catch (error) {
        }
    }

    // Cargar badge al iniciar (diferido para priorizar renderizado)
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            updateDmBadge();
            setInterval(updateDmBadge, 30000);
        }, 3000); // Diferir 3s para no competir con carga inicial
    });
</script>

<!-- ========================================
     FULLSCREEN MEDIA VIEWER (TikTok-style)
     ======================================== -->
<div class="fullscreen-viewer" id="fullscreenViewer">
    <!-- Botón Mute Global - Arriba Izquierda -->
    <button class="fullscreen-mute-btn-global" id="globalMuteBtn" onclick="toggleGlobalMute()" title="Activar/Desactivar sonido" style="display:none;">
        <svg class="icon-muted" viewBox="0 0 24 24" fill="white">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
    </button>
    <!-- Botón Cerrar - Arriba Derecha -->
    <button class="fullscreen-viewer-close" onclick="closeFullscreenViewer()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="fullscreen-counter" id="fullscreenCounter">1 / 1</div>

    <!-- Navegación arriba/abajo estilo YouTube Shorts -->
    <div class="fullscreen-nav-arrows" id="fullscreenNavArrows">
        <button class="fullscreen-nav-btn" id="navPrevBtn" onclick="navigateFullscreen(-1)" title="Anterior">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18,15 12,9 6,15"/>
            </svg>
        </button>
        <button class="fullscreen-nav-btn" id="navNextBtn" onclick="navigateFullscreen(1)" title="Siguiente">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
            </svg>
        </button>
    </div>

    <div class="fullscreen-slides-container" id="fullscreenSlidesContainer">
        <!-- Slides se generan dinamicamente -->
    </div>

    <!-- Comments Bottom Sheet (Instagram-style) -->
    <div class="comments-bottomsheet-overlay" id="commentsBsOverlay" onclick="closeCommentsBottomSheet()"></div>
    <div class="comments-bottomsheet" id="commentsBottomSheet">
        <div class="comments-bs-drag-handle" id="commentsBsDragHandle"></div>
        <div class="comments-bs-header">
            <h3>Comentarios</h3>
        </div>
        <div class="comments-bs-body" id="commentsBsBody">
            <div class="comments-bs-loading" id="commentsBsLoading">
                <div class="spinner"></div>
            </div>
            <div class="comments-bs-empty" id="commentsBsEmpty" style="display:none;">
                Aun no hay comentarios. Se el primero en comentar.
            </div>
            <div id="commentsBsList"></div>
            <div class="comments-bs-load-more" id="commentsBsLoadMore" style="display:none;">
                <button onclick="loadMoreBsComments()">Cargar mas comentarios</button>
            </div>
        </div>
        <div class="comments-bs-reply-indicator" id="commentsBsReplyIndicator">
            <span id="commentsBsReplyTo">Respondiendo a @@usuario</span>
            <button class="comments-bs-reply-cancel" onclick="cancelBsReply()">Cancelar</button>
        </div>
        <div class="comments-bs-input-area">
            <input type="text" class="comments-bs-input" id="commentsBsInput" placeholder="Agrega un comentario..." autocomplete="off">
            <button class="comments-bs-send-btn" id="commentsBsSendBtn" onclick="sendBsComment()">Publicar</button>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL DE SUSCRIPCION - CONTENIDO BLOQUEADO
     ======================================== -->
<div class="subscribe-modal" id="subscribeModal" onclick="if(event.target === this) closeSubscribeModal()">
    <div class="subscribe-modal-content">
        <div class="subscribe-modal-header">
            <button class="subscribe-modal-close" onclick="closeSubscribeModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div id="subscribeModalAvatar" class="subscribe-modal-avatar-placeholder">?</div>
            <div class="subscribe-modal-name" id="subscribeModalName">Creador</div>
            <div class="subscribe-modal-username" id="subscribeModalUsername">@@usuario</div>
        </div>
        <div class="subscribe-modal-body">
            <h4>Contenido exclusivo de Lado B</h4>
            <p>Suscribete para acceder a todo el contenido exclusivo de este creador, incluyendo fotos, videos y mas.</p>
            <div class="subscribe-modal-price" id="subscribeModalPrice">$0.00</div>
            <div class="subscribe-modal-price-label">por mes</div>
            <button class="subscribe-modal-btn" id="subscribeModalBtn" onclick="goToSubscribe()">
                Suscribirse ahora
            </button>
        </div>
        <div class="subscribe-modal-footer">
            <a href="#" id="subscribeModalProfileLink">Ver perfil del creador</a>
        </div>
    </div>
</div>

<script>
    // ========================================
    // MODAL DE SUSCRIPCION - CONTENIDO BLOQUEADO
    // ========================================

    let currentCreatorId = null;

    // ⚠️ GLOBAL para onclick en HTML
    window.openSubscribeModal = function(postElement) {
        if (!postElement) return;

        const creatorId = postElement.dataset.creatorId;
        const creatorName = postElement.dataset.creatorName || 'Creador';
        const creatorPhoto = postElement.dataset.creatorPhoto;
        const creatorPrice = postElement.dataset.creatorPrice || '0.00';

        currentCreatorId = creatorId;

        // Actualizar contenido del modal
        document.getElementById('subscribeModalName').textContent = creatorName;
        document.getElementById('subscribeModalUsername').textContent = '@@' + creatorName.toLowerCase().replace(/\s+/g, '');
        document.getElementById('subscribeModalPrice').textContent = '$' + creatorPrice;

        // Avatar
        const avatarContainer = document.getElementById('subscribeModalAvatar');
        if (creatorPhoto && creatorPhoto !== '') {
            avatarContainer.innerHTML = '';
            avatarContainer.className = '';
            const img = document.createElement('img');
            img.src = creatorPhoto;
            img.alt = creatorName;
            img.className = 'subscribe-modal-avatar';
            avatarContainer.appendChild(img);
        } else {
            avatarContainer.innerHTML = creatorName.charAt(0).toUpperCase();
            avatarContainer.className = 'subscribe-modal-avatar-placeholder';
        }

        // Link al perfil
        document.getElementById('subscribeModalProfileLink').href = '/Feed/Perfil/' + creatorId + '?verSeudonimo=true';

        // Mostrar modal
        document.getElementById('subscribeModal').classList.add('active');
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.closeSubscribeModal = function() {
        document.getElementById('subscribeModal').classList.remove('active');
        currentCreatorId = null;
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.goToSubscribe = function() {
        if (currentCreatorId) {
            window.location.href = '/Feed/Perfil/' + currentCreatorId + '?verSeudonimo=true&subscribe=true';
        }
    };

    // Cerrar con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSubscribeModal();
        }
    });
</script>

<!-- ========================================
     FULLSCREEN VIEWER JAVASCRIPT
     ======================================== -->
<script>
    // Usar window.escapeHtml directamente (definida en script anterior)

    // iOS Safari fix: calcular altura real del viewport y actualizar en resize
    function updateVhVariable() {
        const vh = window.innerHeight;
        document.documentElement.style.setProperty('--vh-full', `${vh}px`);

        // También calcular safe-area-inset-bottom via JS para fallback
        const safeAreaBottom = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0px';
        document.documentElement.style.setProperty('--vh-with-safe-area', `calc(${vh}px + ${safeAreaBottom})`);
    }
    updateVhVariable(); // Calcular al cargar
    window.addEventListener('resize', updateVhVariable);
    window.addEventListener('orientationchange', () => {
        // Delay para orientationchange porque innerHeight puede no actualizarse inmediatamente
        setTimeout(updateVhVariable, 100);
    });

    // Variables globales del fullscreen viewer
    let fullscreenPosts = [];
    let currentFullscreenIndex = 0;
    let pendingCarouselIndex = {}; // {postId: startIndex} para carruseles
    let lastTapTime = 0;
    let tapTimeout = null;

    // Variables para infinite scroll dentro del FullView
    let isLoadingMoreFullscreen = false;
    let fullscreenCurrentPage = 0; // Página actual para cargar más posts
    let fullscreenHasMore = true; // Si hay más posts por cargar

    // Sincronizar fullscreenHasMore con el estado del feed normal
    function syncFullscreenHasMore() {
        // Usar la variable global hasMorePosts del feed si existe
        if (typeof hasMorePosts !== 'undefined') {
            fullscreenHasMore = hasMorePosts;
        }
    }

    // iOS Audio Unlock - Desbloquear audio en dispositivos iOS/Safari
    let audioUnlocked = false;

    function unlockAudio() {
        if (audioUnlocked) return;

        // Crear un AudioContext y reproducir un sonido silencioso
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);

            // Tambien intentar con un elemento de audio
            const silentAudio = document.createElement('audio');
            silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
            silentAudio.play().then(() => {
                silentAudio.pause();
                silentAudio.remove();
            }).catch(() => {});

            audioUnlocked = true;
        } catch (e) {
        }
    }

    // Desbloquear audio en el primer touch/click
    document.addEventListener('touchstart', unlockAudio, { once: true });
    document.addEventListener('click', unlockAudio, { once: true });

    // Cache de medios precargados con límite LRU
    const preloadedMedia = new Map();
    const PRELOAD_RANGE = 4; // Precargar N slides adelante y atrás (aumentado para mejor anticipación)
    const MAX_PRELOAD_CACHE = 12; // Máximo de items en cache para evitar memory leaks

    // Pausar cualquier audio/video del feed
    function pauseFeedMedia() {
        // Pausar todos los videos del feed
        document.querySelectorAll('.post-media video, .feed-video').forEach(video => {
            if (!video.paused) {
                video.pause();
            }
        });

        // Pausar todos los audios del feed (música de fotos)
        document.querySelectorAll('.photo-audio-player, .post-media audio').forEach(audio => {
            if (!audio.paused) {
                audio.pause();
            }
        });
    }

    // Toggle sonido de video de anuncio
    function toggleAdSound(btn, event) {
        event.preventDefault();
        event.stopPropagation();

        const container = btn.closest('.post-ad-media-container');
        const video = container.querySelector('video.ad-video');
        if (!video) return;

        const icon = btn.querySelector('i');
        if (video.muted) {
            // Mutear otros videos de anuncios primero
            document.querySelectorAll('video.ad-video').forEach(v => {
                if (v !== video) {
                    v.muted = true;
                    const otherBtn = v.closest('.post-ad-media-container')?.querySelector('.ad-sound-toggle');
                    if (otherBtn) {
                        otherBtn.classList.remove('unmuted');
                        otherBtn.querySelector('i').className = 'fas fa-volume-mute';
                    }
                }
            });
            video.muted = false;
            icon.className = 'fas fa-volume-up';
            btn.classList.add('unmuted');
        } else {
            video.muted = true;
            icon.className = 'fas fa-volume-mute';
            btn.classList.remove('unmuted');
        }
    }

    // CORREGIDO: Pausar TODOS los audios y videos del fullscreen viewer
    // Esto evita el bug donde la música no coincide con la foto al navegar
    let currentPlayingAudioId = null; // Rastrear qué audio está reproduciéndose

    function pauseAllFullscreenMedia() {
        // Pausar todos los videos del visor
        document.querySelectorAll('.fullscreen-slide video').forEach(video => {
            video.pause();
            video.currentTime = 0;
        });

        // Pausar TODOS los audios del visor - selector más específico
        const audios = document.querySelectorAll('#fullscreenSlidesContainer audio');
        audios.forEach(audio => {
            audio.pause();
        });

        // Quitar clase playing de todos los badges de música
        document.querySelectorAll('.fullscreen-music-badge').forEach(badge => {
            badge.classList.remove('playing');
            badge.classList.remove('tap-to-play');
        });

        currentPlayingAudioId = null;
    }

    // Toggle Fullscreen Video Mute (legacy - para botones dentro de slides)
    // ⚠️ GLOBAL para onclick en HTML
    window.toggleFullscreenMute = function(btn) {
        const slide = btn.closest('.fullscreen-slide');
        const video = slide ? slide.querySelector('video') : null;
        if (!video) return;

        video.muted = !video.muted;
        updateGlobalMuteIcon(video.muted);
    };

    // Toggle Global Mute - Botón fijo arriba izquierda
    // ⚠️ GLOBAL para onclick en HTML
    window.toggleGlobalMute = function() {
        const container = document.getElementById('fullscreenSlidesContainer');
        const currentSlide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);
        if (!currentSlide) return;

        const video = currentSlide.querySelector('video');
        if (video) {
            video.muted = !video.muted;
            updateGlobalMuteIcon(video.muted);
        }
    };

    // Actualizar icono del botón global de mute
    function updateGlobalMuteIcon(isMuted) {
        const muteBtn = document.getElementById('globalMuteBtn');
        if (!muteBtn) return;

        const iconMuted = muteBtn.querySelector('.icon-muted');
        const iconUnmuted = muteBtn.querySelector('.icon-unmuted');
        if (iconMuted && iconUnmuted) {
            iconMuted.style.display = isMuted ? 'block' : 'none';
            iconUnmuted.style.display = isMuted ? 'none' : 'block';
        }
    }

    // Mostrar/ocultar botón de mute según el tipo de contenido actual
    function updateGlobalMuteVisibility() {
        const muteBtn = document.getElementById('globalMuteBtn');
        if (!muteBtn || currentFullscreenIndex < 0 || currentFullscreenIndex >= fullscreenPosts.length) {
            if (muteBtn) muteBtn.style.display = 'none';
            return;
        }

        const currentPost = fullscreenPosts[currentFullscreenIndex];
        // Mostrar solo si es video
        if (currentPost && currentPost.type === 'video') {
            muteBtn.style.display = 'flex';
            // Obtener estado actual de mute del video
            const container = document.getElementById('fullscreenSlidesContainer');
            const currentSlide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);
            const video = currentSlide?.querySelector('video');
            if (video) {
                updateGlobalMuteIcon(video.muted);
            }
        } else {
            muteBtn.style.display = 'none';
        }
    }

    // Recolectar todos los posts con media al cargar
    function collectMediaPosts() {
        fullscreenPosts = [];
        document.querySelectorAll('.post-media[data-post-id]').forEach(media => {
            const postId = parseInt(media.dataset.postId);
            const mediaType = media.dataset.mediaType;
            const mediaSrc = media.dataset.mediaSrc;
            if (postId && mediaSrc) {
                // Buscar el elemento .post padre para obtener info del creador
                const postElement = media.closest('.post');

                const postData = {
                    id: postId,
                    type: mediaType,
                    src: mediaSrc,
                    loaded: false,
                    // Info del creador para los créditos
                    creatorId: postElement?.dataset.creatorId || '',
                    creatorName: postElement?.dataset.creatorName || 'Creador',
                    creatorPhoto: postElement?.dataset.creatorPhoto || '',
                    creatorUsername: postElement?.querySelector('.post-username')?.textContent?.trim() || '',
                    creatorVerified: postElement?.querySelector('.post-username .fas.fa-check-circle') !== null,
                    isLadoB: postElement?.querySelector('.badge-ladob') !== null,
                    isFollowing: postElement?.dataset.isFollowing === 'true',
                    description: postElement?.querySelector('.post-caption-text')?.textContent?.trim() || postElement?.querySelector('.post-text-content')?.textContent?.trim() || '',
                    // Usar data attributes para likes y comments
                    likes: parseInt(postElement?.dataset.likes) || 0,
                    comments: parseInt(postElement?.dataset.comments) || 0,
                    isLiked: postElement?.querySelector('.like-btn')?.classList.contains('liked') || false,
                    postDate: postElement?.querySelector('.post-time')?.textContent?.trim() || ''
                };

                // Verificar si es un carrusel
                if (media.dataset.isCarousel === 'true' && media.dataset.carouselFiles) {
                    try {
                        postData.isCarousel = true;
                        postData.carouselFiles = JSON.parse(media.dataset.carouselFiles);
                        // Usar el índice pendiente si existe, sino el índice actual del carrusel en el feed
                        const pendingIdx = pendingCarouselIndex[postId];
                        const datasetIdx = parseInt(media.dataset.currentIndex || '0');
                        postData.carouselIndex = pendingIdx ?? datasetIdx;
                        console.log('[CollectMedia] Carrusel postId:', postId, 'pendingIdx:', pendingIdx, 'datasetIdx:', datasetIdx, 'final:', postData.carouselIndex);
                    } catch (e) {
                        console.error('[CollectMedia] Error parseando carrusel:', e);
                    }
                }

                // Capturar datos de audio si existen
                if (media.dataset.audioSrc) {
                    postData.audioSrc = media.dataset.audioSrc;
                    postData.audioTitle = media.dataset.audioTitle || '';
                    postData.audioArtist = media.dataset.audioArtist || '';
                    postData.audioStart = parseFloat(media.dataset.audioStart) || 0;
                    let vol = parseFloat(media.dataset.audioVolume) || 0.7;
                    if (vol > 1) vol = vol / 10;
                    postData.audioVolume = Math.min(1, Math.max(0, vol));
                }
                fullscreenPosts.push(postData);
            }
        });
        console.log('[FullView] Posts recolectados:', fullscreenPosts.length);
    }

    // Precargar medios adyacentes con limpieza LRU y estrategia escalonada
    function preloadAdjacentMedia(centerIndex) {
        const indicesToPreload = [];
        const validSrcs = new Set();

        // Agregar indices a precargar (actual, anteriores y siguientes) con distancia
        for (let i = -PRELOAD_RANGE; i <= PRELOAD_RANGE; i++) {
            const idx = centerIndex + i;
            if (idx >= 0 && idx < fullscreenPosts.length) {
                indicesToPreload.push({ idx, distance: Math.abs(i) });
                if (fullscreenPosts[idx]?.src) {
                    validSrcs.add(fullscreenPosts[idx].src);
                }
            }
        }

        // Limpiar items fuera del rango para evitar memory leaks
        if (preloadedMedia.size > MAX_PRELOAD_CACHE) {
            for (const [src, media] of preloadedMedia.entries()) {
                if (!validSrcs.has(src)) {
                    // Liberar memoria del video
                    if (media instanceof HTMLVideoElement) {
                        media.pause();
                        media.removeAttribute('src');
                        media.load();
                    }
                    preloadedMedia.delete(src);
                    // Parar si ya estamos dentro del límite
                    if (preloadedMedia.size <= MAX_PRELOAD_CACHE) break;
                }
            }
        }

        // Ordenar por proximidad (precargar primero los más cercanos)
        indicesToPreload.sort((a, b) => a.distance - b.distance);

        // Precargar cada uno con estrategia escalonada
        indicesToPreload.forEach(({ idx, distance }) => {
            const post = fullscreenPosts[idx];
            if (!post || preloadedMedia.has(post.src)) return;

            if (post.type === 'image') {
                // Precargar imagen
                const img = new Image();
                img.onload = () => {
                    post.loaded = true;
                    // Actualizar el slide si ya existe
                    updateSlideIfExists(idx, post);
                };
                img.src = post.src;
                preloadedMedia.set(post.src, img);
            } else if (post.type === 'video') {
                // Precargar video con estrategia escalonada según distancia
                const video = document.createElement('video');

                // Estrategia de precarga:
                // - distance 0 (actual): auto (descarga completa)
                // - distance 1 (±1): auto (siguiente inmediato también completo)
                // - distance 2+ : metadata (solo info, carga rápida)
                if (distance <= 1) {
                    video.preload = 'auto';
                } else {
                    video.preload = 'metadata';
                }

                video.muted = true;
                video.oncanplaythrough = () => {
                    post.loaded = true;
                };
                video.src = post.src;
                video.load();
                preloadedMedia.set(post.src, video);
            }
        });
    }

    // Actualizar slide si ya existe en el DOM
    function updateSlideIfExists(index, post) {
        const slide = document.querySelector(`.fullscreen-slide[data-index="${index}"]`);
        if (slide && post.loaded) {
            slide.classList.add('media-loaded');
        }
    }

    // Abrir el fullscreen viewer
    // ⚠️ GLOBAL para onclick en HTML
    window.openFullscreenViewer = function(event, postId, carouselStartIndex = 0) {
        // Prevenir si es un click en audio controls (con null check para eventos sintéticos)
        if (event && event.target && event.target.tagName === 'AUDIO') {
            return;
        }
        if (event && event.preventDefault) event.preventDefault();
        if (event && event.stopPropagation) event.stopPropagation();

        // IMPORTANTE: Marcar fullscreen como activo para bloquear el IntersectionObserver del feed
        isFullscreenActive = true;

        // Agregar clase al body y html para ocultar elementos de navegación y forzar fondo negro
        document.body.classList.add('fullscreen-active');
        document.documentElement.classList.add('fullscreen-active');

        // iOS Safari fix: calcular altura real del viewport
        const vh = window.innerHeight;
        document.documentElement.style.setProperty('--vh-full', `${vh}px`);

        // Guardar el índice del carrusel para este post (si aplica)
        console.log('[FullView] openFullscreenViewer - postId:', postId, 'carouselStartIndex:', carouselStartIndex);
        if (carouselStartIndex > 0) {
            pendingCarouselIndex[postId] = carouselStartIndex;
            console.log('[FullView] Guardado pendingCarouselIndex[' + postId + '] =', carouselStartIndex);
        } else {
            delete pendingCarouselIndex[postId];
        }

        // Pausar cualquier audio/video del feed antes de abrir el viewer
        pauseFeedMedia();
        // También pausar el audio actual del feed si existe
        if (window.currentPhotoAudio) {
            window.currentPhotoAudio.pause();
            window.currentPhotoAudio = null;
        }

        // Resetear estado de scroll
        isScrolling = false;
        lastScrollIndex = -1;
        currentPlayingAudioId = null;

        // Sincronizar estado de carga con el feed normal
        syncFullscreenHasMore();

        // Recolectar posts
        collectMediaPosts();

        // Si hay muy pocos posts y hay más disponibles, precargar
        if (fullscreenPosts.length < 5 && fullscreenHasMore) {
            // Cargar más posts en background
            loadMoreFullscreenPosts();
        }

        // Encontrar el indice del post actual
        console.log('[FullView] Buscando postId:', postId, 'tipo:', typeof postId);
        console.log('[FullView] Posts disponibles:', fullscreenPosts.map(p => ({ id: p.id, tipo: typeof p.id, isCarousel: p.isCarousel, carouselIndex: p.carouselIndex })));
        currentFullscreenIndex = fullscreenPosts.findIndex(p => p.id === postId);
        console.log('[FullView] Índice encontrado:', currentFullscreenIndex);
        if (currentFullscreenIndex === -1) {
            currentFullscreenIndex = 0;
            console.warn('[FullView] Post no encontrado, usando índice 0');
        }

        // Iniciar precarga inmediatamente
        preloadAdjacentMedia(currentFullscreenIndex);

        // Generar slides
        generateFullscreenSlides();

        // Mostrar viewer
        const viewer = document.getElementById('fullscreenViewer');
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Ocultar sidebar y header
        document.body.classList.add('fullscreen-mode');

        // Scroll al slide actual Y LUEGO reproducir
        // IMPORTANTE: NO reproducir antes del scroll para evitar audio duplicado
        // Usar requestAnimationFrame para asegurar que el DOM esté actualizado
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                const container = document.getElementById('fullscreenSlidesContainer');
                const slides = container.querySelectorAll('.fullscreen-slide');

                if (slides.length > 0 && currentFullscreenIndex < slides.length) {
                    // iOS Safari fix: usar scrollIntoView para posicionamiento preciso
                    const targetSlide = slides[currentFullscreenIndex];
                    targetSlide.scrollIntoView({ behavior: 'instant', block: 'start' });

                    // Fallback: también establecer scrollTop por si scrollIntoView falla
                    const slideHeight = targetSlide.offsetHeight || window.innerHeight;
                    container.scrollTop = slideHeight * currentFullscreenIndex;
                }

                updateCounter();
                updateNavButtons();

                // Ahora sí reproducir después de que el scroll terminó
                setTimeout(() => {
                    lastScrollIndex = currentFullscreenIndex; // Evitar que onFullscreenScroll lo pause
                    playCurrentVideo();
                }, 50);
            });
        });
    };

    // Generar HTML de créditos estilo YouTube Shorts
    function generateCreditsHtml(post) {
        const verifiedHtml = post.creatorVerified
            ? `<svg class="credits-verified" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`
            : '';

        const ladoBBadge = post.isLadoB
            ? `<span class="credits-badge-ladob">B</span>`
            : '';

        // Avatar del creador
        const avatarHtml = post.creatorPhoto
            ? `<img class="credits-avatar" src="${post.creatorPhoto}" alt="${window.escapeHtml(post.creatorName)}" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">`
            : `<div class="credits-avatar-placeholder" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">${window.escapeHtml(post.creatorName?.charAt(0) || '?')}</div>`;

        // Música si existe
        const musicHtml = (post.audioTitle || post.audioArtist)
            ? `<div class="credits-music">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    <span class="credits-music-text">${post.audioTitle || ''} ${post.audioArtist ? '- ' + post.audioArtist : ''}</span>
               </div>`
            : '';

        // Descripción si existe
        const descHtml = post.description
            ? `<div class="credits-description">${window.escapeHtml(post.description)}</div>`
            : '';

        return `
            <div class="fullscreen-credits">
                <div class="credits-content">
                    <!-- IZQUIERDA: Info del creador -->
                    <div class="credits-creator-section">
                        <div class="credits-creator-row">
                            ${avatarHtml}
                            <div class="credits-creator-info" onclick="event.stopPropagation(); goToCreatorProfile('${post.creatorId}', ${post.isLadoB})">
                                <div class="credits-name">
                                    ${window.escapeHtml(post.creatorName)}
                                    ${verifiedHtml}
                                    ${ladoBBadge}
                                </div>
                                <div class="credits-username">@@${window.escapeHtml(post.creatorUsername || post.creatorName)}</div>
                            </div>
                            <button class="credits-follow-btn ${post.isFollowing ? 'following' : ''}"
                                    data-creator-id="${post.creatorId}"
                                    onclick="event.stopPropagation(); followFromFullscreen('${post.creatorId}', this)">
                                ${post.isFollowing ? 'Siguiendo' : 'Seguir'}
                            </button>
                        </div>
                        ${descHtml}
                        ${musicHtml}
                    </div>

                    <!-- DERECHA: Acciones verticales -->
                    <div class="credits-actions">
                        <button class="credits-action-btn credits-like-btn ${post.isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); likeFromFullscreen(${post.id}, this)">
                            <svg viewBox="0 0 24 24" fill="${post.isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            <span class="credits-likes-count">${formatNumber(post.likes || 0)}</span>
                        </button>

                        <button class="credits-action-btn credits-comments-btn" onclick="event.stopPropagation(); openCommentsBottomSheet(${post.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span class="credits-comments-count">${formatNumber(post.comments || 0)}</span>
                        </button>

                        <div class="credits-share-wrapper">
                            <button class="credits-action-btn" onclick="event.stopPropagation(); toggleShareMenu(this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                                    <polyline points="16,6 12,2 8,6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </button>
                            <div class="credits-share-menu">
                                <button class="credits-share-option" onclick="event.stopPropagation(); copyLinkFromFullscreen(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                    </svg>
                                    Copiar enlace
                                </button>
                                <button class="credits-share-option" onclick="event.stopPropagation(); shareWhatsApp(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    WhatsApp
                                </button>
                                <button class="credits-share-option" onclick="event.stopPropagation(); shareTwitter(${post.id})">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                    </svg>
                                    X (Twitter)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Formatear números (1000 -> 1k, 1000000 -> 1M)
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
        return num.toString();
    }

    // Ir al perfil del creador
    function goToCreatorProfile(creatorId, isLadoB) {
        window.location.href = '/Feed/Perfil/' + creatorId + (isLadoB ? '?verSeudonimo=true' : '');
    }

    // Seguir/Dejar de seguir desde fullscreen
    async function followFromFullscreen(creatorId, btn) {
        const isFollowing = btn.classList.contains('following');
        const endpoint = isFollowing ? '/Feed/DejarDeSeguir' : '/Feed/Seguir';

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ creadorId: creatorId, tipoLado: 0 })
            });

            const data = await res.json();
            if (data.success) {
                // Actualizar el botón
                if (data.siguiendo) {
                    btn.classList.add('following');
                    btn.textContent = 'Siguiendo';
                } else {
                    btn.classList.remove('following');
                    btn.textContent = 'Seguir';
                }

                // Actualizar en fullscreenPosts para mantener sincronizado
                const postIndex = fullscreenPosts.findIndex(p => p.creatorId === creatorId);
                if (postIndex >= 0) {
                    fullscreenPosts[postIndex].isFollowing = data.siguiendo;
                }

                // Actualizar todos los botones de follow del mismo creador en el fullscreen
                document.querySelectorAll(`.credits-follow-btn[data-creator-id="${creatorId}"]`).forEach(otherBtn => {
                    if (data.siguiendo) {
                        otherBtn.classList.add('following');
                        otherBtn.textContent = 'Siguiendo';
                    } else {
                        otherBtn.classList.remove('following');
                        otherBtn.textContent = 'Seguir';
                    }
                });

                showFullscreenToast(data.siguiendo ? 'Siguiendo' : 'Dejaste de seguir');
            } else {
                showFullscreenToast(data.message || 'Error al procesar');
            }
        } catch (error) {
            showFullscreenToast('Error de conexión');
        }
    }

    // Toggle menu de compartir
    function toggleShareMenu(btn) {
        const menu = btn.parentElement.querySelector('.credits-share-menu');
        menu.classList.toggle('active');

        // Cerrar al hacer clic fuera
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!btn.parentElement.contains(e.target)) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    // Copiar enlace
    function copyLinkFromFullscreen(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        navigator.clipboard.writeText(url).then(() => {
            showFullscreenToast('Enlace copiado');
        }).catch(() => {
            showFullscreenToast('Error al copiar');
        });
    }

    // Compartir en WhatsApp
    function shareWhatsApp(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        window.open(`https://wa.me/?text=${encodeURIComponent('Mira este contenido en LADO: ' + url)}`, '_blank');
    }

    // Compartir en Twitter/X
    function shareTwitter(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Mira este contenido en LADO')}`, '_blank');
    }

    // Generar los slides
    // Generar el contenido HTML de un slide individual
    function generateSlideContent(post, index) {
        let content = '';

        if (post.type === 'video') {
            const isWebm = post.src.toLowerCase().endsWith('.webm');
            const mimeType = isWebm ? 'video/webm' : 'video/mp4';
            const posterAttr = post.thumbnail ? `poster="${post.thumbnail}"` : '';
            content = `
                <div class="fullscreen-loading-indicator">
                    <div class="loading-spinner"></div>
                </div>
                <video playsinline webkit-playsinline="true" x-webkit-airplay="allow" autoplay loop muted preload="auto" ${posterAttr}>
                    ${!isWebm ? `<source src="${post.src}" type="video/mp4">` : ''}
                    <source src="${post.src}" type="${mimeType}">
                </video>
                <button class="fullscreen-mute-btn" onclick="event.stopPropagation(); toggleFullscreenMute(this)" title="Activar/Desactivar sonido">
                    <svg class="icon-muted" viewBox="0 0 24 24" fill="white">
                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                    </svg>
                    <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                </button>
                <div class="fullscreen-heart-animation">
                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </div>
                ${generateCreditsHtml(post)}
            `;
        } else if (post.type === 'audio') {
            content = `
                <div class="fullscreen-audio-content">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    <audio src="${post.src}" controls></audio>
                </div>
                <div class="fullscreen-heart-animation">
                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </div>
                ${generateCreditsHtml(post)}
            `;
        } else if (post.isCarousel && post.carouselFiles && post.carouselFiles.length > 1) {
            // Generar slides para Swiper.js
            const swiperSlidesHtml = post.carouselFiles.map((file, idx) => {
                if (file.type === 'video') {
                    const isWebmCarousel = file.src.toLowerCase().endsWith('.webm');
                    const mimeTypeCarousel = isWebmCarousel ? 'video/webm' : 'video/mp4';
                    return `<div class="swiper-slide" data-idx="${idx}">
                        <video playsinline webkit-playsinline="true" x-webkit-airplay="allow" autoplay loop muted preload="auto">
                            ${!isWebmCarousel ? `<source src="${file.src}" type="video/mp4">` : ''}
                            <source src="${file.src}" type="${mimeTypeCarousel}">
                        </video>
                    </div>`;
                } else {
                    return `<div class="swiper-slide" data-idx="${idx}">
                        <img src="${file.src}" alt="" draggable="false">
                    </div>`;
                }
            }).join('');

            const hasMultiple = post.carouselFiles.length > 1;
            content = `
                <div class="fullscreen-loading-indicator">
                    <div class="loading-spinner"></div>
                </div>
                <div class="swiper fs-swiper-carousel" data-post-id="${post.id}" data-has-multiple="${hasMultiple}" data-swipe-hint="${hasMultiple}">
                    <div class="swiper-wrapper">
                        ${swiperSlidesHtml}
                    </div>
                    <div class="swiper-pagination fs-swiper-pagination"></div>
                    <div class="swiper-button-next fs-swiper-next"></div>
                    <div class="swiper-button-prev fs-swiper-prev"></div>
                    <div class="fs-swiper-counter">1/${post.carouselFiles.length}</div>
                </div>
                <div class="fullscreen-heart-animation">
                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </div>
                ${generateCreditsHtml(post)}
            `;
        } else {
            // Imagen simple
            let audioHtml = '';
            if (post.audioSrc) {
                audioHtml = `
                    <div class="fullscreen-music-badge" data-post-id="${post.id}">
                        <div class="fullscreen-music-icon">
                            <svg viewBox="0 0 24 24" fill="white">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                        </div>
                        <div class="fullscreen-music-info">
                            <div class="fullscreen-music-title">${post.audioTitle}</div>
                            <div class="fullscreen-music-artist">${post.audioArtist}</div>
                        </div>
                    </div>
                    <audio class="fullscreen-audio-player"
                           data-post-id="${post.id}"
                           src="${post.audioSrc}"
                           loop
                           data-start="${post.audioStart}"
                           data-volume="${post.audioVolume}">
                    </audio>
                `;
            }
            content = `
                <div class="fullscreen-loading-indicator">
                    <div class="loading-spinner"></div>
                </div>
                <img src="${post.src}" alt="" draggable="false">
                ${audioHtml}
                <div class="fullscreen-heart-animation">
                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </div>
                ${generateCreditsHtml(post)}
            `;
        }

        return content;
    }

    function generateFullscreenSlides() {
        const container = document.getElementById('fullscreenSlidesContainer');
        container.innerHTML = '';

        fullscreenPosts.forEach((post, index) => {
            const slide = document.createElement('div');
            slide.className = 'fullscreen-slide';
            slide.dataset.postId = post.id;
            slide.dataset.index = index;

            // Marcar como cargado si ya esta en cache
            if (preloadedMedia.has(post.src) || post.loaded) {
                slide.classList.add('media-loaded');
            }

            // Contenido segun tipo
            if (post.type === 'video') {
                // Usar el video precargado si existe
                const preloadedVideo = preloadedMedia.get(post.src);
                // Determinar MIME type para iOS Safari
                const isWebm = post.src.toLowerCase().endsWith('.webm');
                const mimeType = isWebm ? 'video/webm' : 'video/mp4';
                const posterAttr = post.thumbnail ? `poster="${post.thumbnail}"` : '';
                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <video playsinline
                           webkit-playsinline="true"
                           x-webkit-airplay="allow"
                           autoplay
                           loop
                           muted
                           preload="auto"
                           ${posterAttr}>
                        ${!isWebm ? `<source src="${post.src}" type="video/mp4">` : ''}
                        <source src="${post.src}" type="${mimeType}">
                    </video>
                    <button class="fullscreen-mute-btn" onclick="event.stopPropagation(); toggleFullscreenMute(this)" title="Activar/Desactivar sonido">
                        <svg class="icon-muted" viewBox="0 0 24 24" fill="white">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                // Marcar como cargado cuando el video esté listo (múltiples eventos para mayor rapidez)
                const videoEl = slide.querySelector('video');
                const markLoaded = () => {
                    slide.classList.add('media-loaded');
                    // Limpiar el timeout de seguridad si existe
                    if (slide._loadingTimeout) {
                        clearTimeout(slide._loadingTimeout);
                        slide._loadingTimeout = null;
                    }
                };
                videoEl.oncanplaythrough = markLoaded;
                videoEl.onloadeddata = markLoaded;
                videoEl.onplaying = markLoaded; // Se dispara más rápido cuando el video comienza a reproducirse
                videoEl.oncanplay = markLoaded; // También cuando puede comenzar a reproducir

                // Timeout de seguridad: ocultar spinner después de 8 segundos máximo
                slide._loadingTimeout = setTimeout(() => {
                    slide.classList.add('media-loaded');
                }, 8000);
            } else if (post.type === 'audio') {
                slide.innerHTML = `
                    <div class="fullscreen-audio-content">
                        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                        <audio src="${post.src}" controls></audio>
                    </div>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                slide.classList.add('media-loaded'); // Audio siempre listo
            } else if (post.isCarousel && post.carouselFiles && post.carouselFiles.length > 1) {
                // CARRUSEL - Múltiples archivos con Swiper.js
                const swiperSlidesHtml = post.carouselFiles.map((file, idx) => {
                    if (file.type === 'video') {
                        // 🍎 iOS Safari requiere MIME type explícito y atributos especiales
                        const isWebmCarousel = file.src.toLowerCase().endsWith('.webm');
                        const mimeTypeCarousel = isWebmCarousel ? 'video/webm' : 'video/mp4';
                        return `<div class="swiper-slide" data-idx="${idx}">
                            <video playsinline webkit-playsinline="true" x-webkit-airplay="allow" autoplay loop muted preload="auto">
                                ${!isWebmCarousel ? `<source src="${file.src}" type="video/mp4">` : ''}
                                <source src="${file.src}" type="${mimeTypeCarousel}">
                            </video>
                        </div>`;
                    } else {
                        return `<div class="swiper-slide" data-idx="${idx}">
                            <img src="${file.src}" alt="" draggable="false">
                        </div>`;
                    }
                }).join('');

                const hasMultipleSlides = post.carouselFiles.length > 1;
                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="swiper fs-swiper-carousel" data-post-id="${post.id}" data-has-multiple="${hasMultipleSlides}" data-swipe-hint="${hasMultipleSlides}">
                        <div class="swiper-wrapper">
                            ${swiperSlidesHtml}
                        </div>
                        <div class="swiper-pagination fs-swiper-pagination"></div>
                        <div class="swiper-button-next fs-swiper-next"></div>
                        <div class="swiper-button-prev fs-swiper-prev"></div>
                        <div class="fs-swiper-counter">1/${post.carouselFiles.length}</div>
                    </div>
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                slide.classList.add('media-loaded');
                slide.classList.add('has-carousel');
            } else {
                // Imagen simple - verificar si tiene audio
                let audioHtml = '';
                if (post.audioSrc) {
                    audioHtml = `
                        <div class="fullscreen-music-badge" data-post-id="${post.id}">
                            <div class="fullscreen-music-icon">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                            </div>
                            <div class="fullscreen-music-info">
                                <div class="fullscreen-music-title">${post.audioTitle}</div>
                                <div class="fullscreen-music-artist">${post.audioArtist}</div>
                            </div>
                        </div>
                        <audio class="fullscreen-audio-player"
                               data-post-id="${post.id}"
                               src="${post.audioSrc}"
                               loop
                               data-start="${post.audioStart}"
                               data-volume="${post.audioVolume}">
                        </audio>
                    `;
                }
                slide.innerHTML = `
                    <div class="fullscreen-loading-indicator">
                        <div class="loading-spinner"></div>
                    </div>
                    <img src="${post.src}" alt="" draggable="false">
                    ${audioHtml}
                    <div class="fullscreen-heart-animation">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    </div>
                    ${generateCreditsHtml(post)}
                `;
                // Marcar como cargado cuando la imagen este lista
                const imgEl = slide.querySelector('img');
                imgEl.onload = () => {
                    slide.classList.add('media-loaded');
                };
                // Si ya estaba en cache, marcar inmediatamente
                if (imgEl.complete) {
                    slide.classList.add('media-loaded');
                }
            }

            // Doble tap para like
            slide.addEventListener('click', (e) => handleTap(e, post.id, slide));
            slide.addEventListener('touchend', (e) => handleTap(e, post.id, slide));

            container.appendChild(slide);
        });

        // Listener para scroll/snap
        container.addEventListener('scroll', onFullscreenScroll);

        // Inicializar todos los Swiper carousels
        initFullscreenSwipers();
    }

    // Almacenar instancias de Swiper
    const fullscreenSwipers = new Map();

    // Inicializar Swiper.js en los carruseles del fullscreen
    function initFullscreenSwipers() {
        // Destruir instancias previas
        fullscreenSwipers.forEach(swiper => swiper.destroy(true, true));
        fullscreenSwipers.clear();

        // Inicializar nuevos Swipers
        document.querySelectorAll('.fs-swiper-carousel').forEach(swiperEl => {
            const postId = swiperEl.dataset.postId;
            const counter = swiperEl.querySelector('.fs-swiper-counter');
            const totalSlides = swiperEl.querySelectorAll('.swiper-slide').length;

            // Obtener el índice inicial del carrusel desde los datos del post
            const postData = fullscreenPosts.find(p => p.id == postId);
            const initialSlideIndex = postData?.carouselIndex || 0;
            console.log('[Swiper] Init para postId:', postId, 'postData:', postData ? { id: postData.id, carouselIndex: postData.carouselIndex } : null, 'initialSlideIndex:', initialSlideIndex);

            const swiper = new Swiper(swiperEl, {
                // Configuración base
                slidesPerView: 1,
                spaceBetween: 0,
                loop: false,
                speed: 300,
                cssMode: false, // Mejor rendimiento en iOS
                initialSlide: initialSlideIndex, // Iniciar en el índice del carrusel del feed

                // Navegación
                navigation: {
                    nextEl: swiperEl.querySelector('.swiper-button-next'),
                    prevEl: swiperEl.querySelector('.swiper-button-prev'),
                },

                // Paginación (bullets)
                pagination: {
                    el: swiperEl.querySelector('.swiper-pagination'),
                    clickable: true,
                    dynamicBullets: totalSlides > 5,
                },

                // Soporte táctil mejorado para iOS
                touchEventsTarget: 'container',
                simulateTouch: true,
                allowTouchMove: true,
                touchRatio: 1,
                touchAngle: 45, // Más tolerante al ángulo para detectar horizontal
                grabCursor: true,
                passiveListeners: false, // Permitir preventDefault para capturar swipes
                touchStartPreventDefault: false,
                touchMoveStopPropagation: true,
                preventInteractionOnTransition: true,
                edgeSwipeDetection: true,
                edgeSwipeThreshold: 20,

                // Threshold bajo para detectar swipe rápido
                threshold: 5,
                shortSwipes: true,
                longSwipes: true,
                longSwipesRatio: 0.3,
                longSwipesMs: 150,

                // Resistencia en los bordes
                resistance: true,
                resistanceRatio: 0.65,

                // Teclado - navegación con flechas izq/der en carrusel
                keyboard: {
                    enabled: true,
                    onlyInViewport: true,
                    pageUpDown: false,
                },

                // Eventos
                on: {
                    slideChange: function() {
                        // Actualizar contador
                        if (counter) {
                            counter.textContent = `${this.activeIndex + 1}/${totalSlides}`;
                        }

                        // Ocultar hint de swipe después del primer cambio
                        this.el.removeAttribute('data-swipe-hint');

                        // Pausar videos de slides anteriores
                        this.slides.forEach((slide, idx) => {
                            const video = slide.querySelector('video');
                            if (video) {
                                if (idx === this.activeIndex) {
                                    video.play().catch(() => {});
                                } else {
                                    video.pause();
                                }
                            }
                        });

                        // Haptic feedback en móvil
                        if (navigator.vibrate) {
                            navigator.vibrate(10);
                        }
                    },
                    init: function() {
                        // Actualizar contador al valor inicial
                        if (counter) {
                            counter.textContent = `${this.activeIndex + 1}/${totalSlides}`;
                        }
                        // Reproducir video del slide inicial si existe
                        const currentSlide = this.slides[this.activeIndex];
                        if (currentSlide) {
                            const video = currentSlide.querySelector('video');
                            if (video) {
                                video.play().catch(() => {});
                            }
                        }
                        // Pausar videos de otros slides
                        this.slides.forEach((slide, idx) => {
                            if (idx !== this.activeIndex) {
                                const video = slide.querySelector('video');
                                if (video) video.pause();
                            }
                        });
                    },
                    touchStart: function(swiper, event) {
                        // Guardar posición inicial del touch
                        swiper.touchStartX = event.touches ? event.touches[0].clientX : event.clientX;
                        swiper.touchStartY = event.touches ? event.touches[0].clientY : event.clientY;
                        swiper.touchDirection = null;
                    },
                    touchMove: function(swiper, event) {
                        if (!swiper.touchStartX) return;

                        const currentX = event.touches ? event.touches[0].clientX : event.clientX;
                        const currentY = event.touches ? event.touches[0].clientY : event.clientY;
                        const deltaX = Math.abs(currentX - swiper.touchStartX);
                        const deltaY = Math.abs(currentY - swiper.touchStartY);

                        // Determinar dirección del swipe con umbral bajo
                        if (!swiper.touchDirection && (deltaX > 5 || deltaY > 5)) {
                            swiper.touchDirection = deltaX > deltaY ? 'horizontal' : 'vertical';

                            // Si es horizontal, bloquear scroll inmediatamente
                            if (swiper.touchDirection === 'horizontal') {
                                const container = document.getElementById('fullscreenSlidesContainer');
                                if (container) {
                                    container.classList.add('carousel-swiping');
                                }
                            }
                        }

                        // Si es horizontal, seguir bloqueando
                        if (swiper.touchDirection === 'horizontal') {
                            event.stopPropagation();
                        }
                    },
                    touchEnd: function(swiper) {
                        swiper.touchStartX = null;
                        swiper.touchStartY = null;
                        swiper.touchDirection = null;
                        // Restaurar scroll con delay
                        setTimeout(() => {
                            const container = document.getElementById('fullscreenSlidesContainer');
                            if (container) {
                                container.classList.remove('carousel-swiping');
                            }
                        }, 150);
                    }
                }
            });

            fullscreenSwipers.set(postId, swiper);

            // Añadir event listeners directos al elemento para garantizar captura de touch
            swiperEl.addEventListener('touchstart', function(e) {
                this._touchStartX = e.touches[0].clientX;
                this._touchStartY = e.touches[0].clientY;
                this._isHorizontalSwipe = null;
            }, { passive: true });

            swiperEl.addEventListener('touchmove', function(e) {
                if (!this._touchStartX) return;

                const deltaX = Math.abs(e.touches[0].clientX - this._touchStartX);
                const deltaY = Math.abs(e.touches[0].clientY - this._touchStartY);

                // Detectar si es swipe horizontal (umbral bajo para detectar rápido)
                if (this._isHorizontalSwipe === null && (deltaX > 5 || deltaY > 5)) {
                    this._isHorizontalSwipe = deltaX > deltaY;

                    // Si es horizontal, bloquear scroll y snap del contenedor padre inmediatamente
                    if (this._isHorizontalSwipe) {
                        const container = document.getElementById('fullscreenSlidesContainer');
                        if (container) {
                            container.classList.add('carousel-swiping');
                        }
                    }
                }

                // Continuar bloqueando si es horizontal
                if (this._isHorizontalSwipe) {
                    e.stopPropagation();
                }
            }, { passive: true });

            swiperEl.addEventListener('touchend', function() {
                this._touchStartX = null;
                this._touchStartY = null;
                this._isHorizontalSwipe = null;
                // Restaurar scroll y snap con delay para evitar glitches
                setTimeout(() => {
                    const container = document.getElementById('fullscreenSlidesContainer');
                    if (container) {
                        container.classList.remove('carousel-swiping');
                    }
                }, 150);
            }, { passive: true });

            swiperEl.addEventListener('touchcancel', function() {
                this._touchStartX = null;
                this._touchStartY = null;
                this._isHorizontalSwipe = null;
                const container = document.getElementById('fullscreenSlidesContainer');
                if (container) {
                    container.classList.remove('carousel-swiping');
                }
            }, { passive: true });
        });
    }

    // Navegación del carrusel dentro del fullscreen (legacy - mantener compatibilidad)
    function fsCarouselNav(postId, direction) {
        const wrapper = document.querySelector(`.fs-carousel-wrapper[data-post-id="${postId}"]`);
        if (!wrapper) return;

        const items = wrapper.querySelectorAll('.fs-carousel-item');
        const total = items.length;
        let current = parseInt(wrapper.dataset.current || '0');

        // Calcular nuevo índice
        current += direction;
        if (current < 0) current = 0;
        if (current >= total) current = total - 1;

        fsCarouselGoTo(postId, current);
    }

    function fsCarouselGoTo(postId, index) {
        const wrapper = document.querySelector(`.fs-carousel-wrapper[data-post-id="${postId}"]`);
        if (!wrapper) return;

        const items = wrapper.querySelectorAll('.fs-carousel-item');
        const dots = wrapper.querySelectorAll('.fs-carousel-dot');
        const counter = wrapper.querySelector('.fs-carousel-counter');
        const prevBtn = wrapper.querySelector('.fs-carousel-prev');
        const nextBtn = wrapper.querySelector('.fs-carousel-next');
        const total = items.length;

        // Validar índice
        if (index < 0) index = 0;
        if (index >= total) index = total - 1;

        // Actualizar índice actual
        wrapper.dataset.current = index;

        // Actualizar items activos
        items.forEach((item, i) => {
            item.classList.toggle('active', i === index);
            // Pausar/reproducir videos
            const video = item.querySelector('video');
            if (video) {
                if (i === index) {
                    video.currentTime = 0;
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });

        // Actualizar dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });

        // Actualizar contador
        if (counter) {
            counter.textContent = `${index + 1}/${total}`;
        }

        // Mostrar/ocultar botones de navegación
        if (prevBtn) prevBtn.style.display = index === 0 ? 'none' : 'flex';
        if (nextBtn) nextBtn.style.display = index === total - 1 ? 'none' : 'flex';
    }

    // Manejar tap/click (detectar doble tap + navegación lateral en carruseles)
    function handleTap(event, postId, slideElement) {
        // Ignorar si es audio controls o botones de navegación
        if (event.target.tagName === 'AUDIO') return;
        if (event.target.closest('.swiper-button-next, .swiper-button-prev, .swiper-pagination')) return;
        if (event.target.closest('.fs-carousel-nav, .fs-carousel-dots')) return;

        const now = Date.now();
        const timeDiff = now - lastTapTime;

        // Verificar si es un carrusel con Swiper
        const swiperEl = slideElement.querySelector('.fs-swiper-carousel');
        const swiper = swiperEl ? fullscreenSwipers.get(postId) : null;

        // Desktop: navegación por click en áreas laterales del carrusel
        if (swiper && window.innerWidth > 768) {
            const rect = swiperEl.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const width = rect.width;

            // Click en el 25% izquierdo - slide anterior
            if (clickX < width * 0.25 && swiper.activeIndex > 0) {
                event.stopPropagation();
                swiper.slidePrev();
                return;
            }
            // Click en el 25% derecho - slide siguiente
            if (clickX > width * 0.75 && swiper.activeIndex < swiper.slides.length - 1) {
                event.stopPropagation();
                swiper.slideNext();
                return;
            }
        }

        if (timeDiff < 300 && timeDiff > 0) {
            // Doble tap - dar like
            clearTimeout(tapTimeout);
            triggerLike(postId, slideElement);
        } else {
            // Primer tap - toggle video si es video (solo si no es carrusel)
            tapTimeout = setTimeout(() => {
                // Si es carrusel, buscar video en el slide activo del swiper
                let video = null;
                if (swiper) {
                    const activeSlide = swiper.slides[swiper.activeIndex];
                    video = activeSlide?.querySelector('video');
                } else {
                    // Imagen/video simple
                    video = slideElement.querySelector('video');
                }

                if (video) {
                    // 🍎 iOS: Usar iOSMediaFix para mejor compatibilidad
                    if (window.iOSMediaFix?.isIOS) {
                        // Remover indicador de needs-tap
                        slideElement.classList.remove('needs-tap');

                        if (video.paused) {
                            window.iOSMediaFix.playVideo(video).then(success => {
                                if (success) {
                                    updateGlobalMuteIcon(video.muted);
                                }
                            });
                        } else {
                            window.iOSMediaFix.pauseVideo(video);
                        }
                    } else {
                        // Desktop/Android
                        if (video.paused) video.play();
                        else video.pause();
                    }
                }
            }, 300);
        }

        lastTapTime = now;
    }

    // Dar like con animacion (con debounce)
    function triggerLike(postId, slideElement) {
        // Verificar si ya tiene like (para no quitarlo con el toggle)
        const likeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
        const creditsLikeBtn = slideElement.querySelector('.credits-like-btn');
        const yaLeDioLike = likeBtn?.classList.contains('liked') || creditsLikeBtn?.classList.contains('liked');

        // Siempre mostrar animacion del corazon
        const heart = slideElement.querySelector('.fullscreen-heart-animation');
        if (heart) {
            heart.classList.remove('animate');
            void heart.offsetWidth; // Reflow
            heart.classList.add('animate');

            setTimeout(() => {
                heart.classList.remove('animate');
            }, 800);
        }

        // Si ya tiene like, solo mostrar animacion, no llamar API
        if (yaLeDioLike) {
            return;
        }

        // Debounce: evitar múltiples calls simultáneos
        if (likeInProgress.has(postId)) return;
        likeInProgress.add(postId);

        // Función para actualizar UI optimistamente
        function updateLikeUIOptimistic() {
            if (likeBtn) likeBtn.classList.add('liked');
            if (creditsLikeBtn) {
                creditsLikeBtn.classList.add('liked');
                const svg = creditsLikeBtn.querySelector('svg');
                if (svg) svg.setAttribute('fill', 'currentColor');
            }
            const postIndex = fullscreenPosts.findIndex(p => p.id === postId);
            if (postIndex !== -1) fullscreenPosts[postIndex].isLiked = true;
        }

        // Si no hay conexión, guardar para sincronizar después
        if (!navigator.onLine && window.LadoOfflineSync) {
            window.LadoOfflineSync.savePendingLike(postId);
            updateLikeUIOptimistic();
            showToast('Like guardado - se sincronizará cuando vuelva la conexión');
            setTimeout(() => likeInProgress.delete(postId), 500);
            return;
        }

        // Llamar al API de like (solo si no tiene like)
        fetch('/Feed/Like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.liked) {
                // Actualizar el boton de like en el feed
                if (likeBtn) {
                    likeBtn.classList.add('liked');
                }

                // Actualizar el botón de like en el fullview (credits)
                if (creditsLikeBtn) {
                    creditsLikeBtn.classList.add('liked');
                    const svg = creditsLikeBtn.querySelector('svg');
                    if (svg) {
                        svg.setAttribute('fill', 'currentColor');
                    }
                }

                // Actualizar contador en el feed
                const likesSpan = document.getElementById(`likes-${postId}`);
                if (likesSpan && data.likes !== undefined) {
                    likesSpan.textContent = `${data.likes} Me gusta`;
                }

                // Actualizar contador en el fullview (credits)
                const creditsLikesCount = creditsLikeBtn?.querySelector('.credits-likes-count');
                if (creditsLikesCount && data.likes !== undefined) {
                    creditsLikesCount.textContent = formatNumber(data.likes);
                }

                // Actualizar el estado en fullscreenPosts para mantener sincronizado
                const postIndex = fullscreenPosts.findIndex(p => p.id === postId);
                if (postIndex !== -1) {
                    fullscreenPosts[postIndex].isLiked = true;
                    fullscreenPosts[postIndex].likes = data.likes;
                }
            }
        })
        .catch(async err => {
            console.error('Error al dar like:', err);
            // Si falló por red, intentar guardar offline
            if (!navigator.onLine && window.LadoOfflineSync) {
                await window.LadoOfflineSync.savePendingLike(postId);
                updateLikeUIOptimistic();
                showToast('Like guardado - se sincronizará cuando vuelva la conexión');
            } else {
                showToast('Error al procesar tu reacción');
            }
        })
        .finally(() => {
            setTimeout(() => likeInProgress.delete(postId), 500);
        });
    }

    // Like desde los créditos del fullscreen (con debounce)
    function likeFromFullscreen(postId, button) {
        // Debounce: evitar múltiples clicks simultáneos
        if (likeInProgress.has(postId)) return;
        likeInProgress.add(postId);

        const isLiked = button.classList.contains('liked');

        // Función para actualizar UI optimistamente (solo para dar like, no quitar)
        function updateLikeUIOptimistic() {
            button.classList.add('liked');
            button.querySelector('svg')?.setAttribute('fill', 'currentColor');
            const feedLikeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
            if (feedLikeBtn) feedLikeBtn.classList.add('liked');
            const postIndex = fullscreenPosts.findIndex(p => p.id === postId);
            if (postIndex !== -1) fullscreenPosts[postIndex].isLiked = true;
            // Mostrar animación del corazón
            const slide = button.closest('.fullscreen-slide');
            const heart = slide?.querySelector('.fullscreen-heart-animation');
            if (heart) {
                heart.classList.remove('animate');
                void heart.offsetWidth;
                heart.classList.add('animate');
                setTimeout(() => heart.classList.remove('animate'), 800);
            }
        }

        // Si no hay conexión y es para dar like (no quitar), guardar offline
        if (!navigator.onLine && !isLiked && window.LadoOfflineSync) {
            window.LadoOfflineSync.savePendingLike(postId);
            updateLikeUIOptimistic();
            showToast('Like guardado - se sincronizará cuando vuelva la conexión');
            setTimeout(() => likeInProgress.delete(postId), 500);
            return;
        }

        fetch('/Feed/Like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar el botón de créditos
                if (data.liked) {
                    button.classList.add('liked');
                    button.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    button.classList.remove('liked');
                    button.querySelector('svg').setAttribute('fill', 'none');
                }

                // Actualizar contador en créditos
                const likesCount = button.querySelector('.credits-likes-count');
                if (likesCount && data.likes !== undefined) {
                    likesCount.textContent = formatNumber(data.likes);
                }

                // Actualizar el botón de like en el feed principal
                const feedLikeBtn = document.querySelector(`.like-btn[data-id="${postId}"]`);
                if (feedLikeBtn) {
                    if (data.liked) {
                        feedLikeBtn.classList.add('liked');
                    } else {
                        feedLikeBtn.classList.remove('liked');
                    }
                }

                // Actualizar contador en el feed principal
                const feedLikesSpan = document.getElementById(`likes-${postId}`);
                if (feedLikesSpan && data.likes !== undefined) {
                    feedLikesSpan.textContent = `${data.likes} Me gusta`;
                }

                // Mostrar animación del corazón si dio like
                if (data.liked) {
                    const slide = button.closest('.fullscreen-slide');
                    const heart = slide?.querySelector('.fullscreen-heart-animation');
                    if (heart) {
                        heart.classList.remove('animate');
                        void heart.offsetWidth;
                        heart.classList.add('animate');
                        setTimeout(() => heart.classList.remove('animate'), 800);
                    }
                }

                // Actualizar el estado en fullscreenPosts para mantener sincronizado
                const postIndex = fullscreenPosts.findIndex(p => p.id === postId);
                if (postIndex !== -1) {
                    fullscreenPosts[postIndex].isLiked = data.liked;
                    fullscreenPosts[postIndex].likes = data.likes;
                }

                // Actualizar data-likes en el article del feed para mantener sincronizado
                const postArticle = document.querySelector(`.post[data-post-id="${postId}"]`);
                if (postArticle && data.likes !== undefined) {
                    postArticle.dataset.likes = data.likes;
                }
            }
        })
        .catch(async err => {
            console.error('Error al dar like desde fullscreen:', err);
            // Si falló por red y era para dar like, guardar offline
            if (!navigator.onLine && !isLiked && window.LadoOfflineSync) {
                await window.LadoOfflineSync.savePendingLike(postId);
                updateLikeUIOptimistic();
                showToast('Like guardado - se sincronizará cuando vuelva la conexión');
            } else {
                showToast('Error al procesar tu reacción');
            }
        })
        .finally(() => {
            // Liberar después de 500ms para evitar spam
            setTimeout(() => likeInProgress.delete(postId), 500);
        });
    }

    // Compartir desde el fullscreen
    function shareFromFullscreen(postId) {
        const shareUrl = `${window.location.origin}/Feed/Detalle/${postId}`;

        if (navigator.share) {
            navigator.share({
                title: 'Mira este contenido en Lado',
                url: shareUrl
            }).catch(() => {
                // Fallback si cancela
                copyToClipboard(shareUrl);
            });
        } else {
            copyToClipboard(shareUrl);
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Mostrar notificación
            showToast('Enlace copiado al portapapeles');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Enlace copiado al portapapeles');
        });
    }

    // Esta función se elimina porque ya existe showToast arriba (línea 3607)
    // que usa #feedPageToast. La función original es suficiente.

    // Scroll handler para detectar el slide actual
    let scrollTimeout;
    let isScrolling = false;
    let lastScrollIndex = -1;

    function onFullscreenScroll() {
        const container = document.getElementById('fullscreenSlidesContainer');
        if (!container) return;

        // iOS fix: usar altura real del slide
        const slides = container.querySelectorAll('.fullscreen-slide');
        const slideHeight = slides.length > 0 ? slides[0].offsetHeight : window.innerHeight;
        const newIndex = Math.round(container.scrollTop / slideHeight);

        // Validar índice
        if (newIndex < 0 || newIndex >= fullscreenPosts.length) return;

        // INMEDIATAMENTE pausar todo cuando se detecta un cambio de slide durante scroll
        if (newIndex !== lastScrollIndex) {
            if (!isScrolling) {
                isScrolling = true;
                pauseAllFullscreenMedia();
            }
            lastScrollIndex = newIndex;
        }

        // Debounce reducido para detección más rápida del cambio de slide
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            isScrolling = false;

            // Solo reproducir si cambió el índice actual
            if (newIndex !== currentFullscreenIndex) {
                currentFullscreenIndex = newIndex;
                updateCounter();
                updateNavButtons();
                preloadAdjacentMedia(currentFullscreenIndex);
                playCurrentVideo();
            }

            // Infinite scroll: Cargar más posts cuando estamos cerca del final
            const shouldLoadMore = fullscreenHasMore && !isLoadingMoreFullscreen &&
                currentFullscreenIndex >= fullscreenPosts.length - 3;

            if (shouldLoadMore) {
                console.log('[FullView] Trigger carga:', {
                    index: currentFullscreenIndex,
                    total: fullscreenPosts.length,
                    threshold: fullscreenPosts.length - 3
                });
                loadMoreFullscreenPosts();
            }
        }, 75); // Reducido de 150ms para mayor responsividad
    }

    // Cargar más posts para el FullView
    // ⚡ MEJORADO: Usa IDs ya vistos en lugar de paginación
    async function loadMoreFullscreenPosts() {
        if (isLoadingMoreFullscreen || !fullscreenHasMore) {
            console.log('[FullView] No cargar más:', { isLoading: isLoadingMoreFullscreen, hasMore: fullscreenHasMore });
            return;
        }

        isLoadingMoreFullscreen = true;
        console.log('[FullView] Cargando más posts...');

        try {
            // ⚡ MEJORADO: Enviar IDs ya vistos
            const idsVistosParam = Array.from(loadedPostIds).join(',');
            console.log('[FullView] IDs ya vistos:', loadedPostIds.size);

            const response = await fetch(`/Feed/CargarMasPosts?cantidad=10&idsVistos=${encodeURIComponent(idsVistosParam)}`);
            const data = await response.json();

            console.log('[FullView] Respuesta servidor:', {
                success: data.success,
                postsRecibidos: data.posts?.length || 0,
                hayMas: data.hayMas
            });

            if (data.success && data.posts && data.posts.length > 0) {
                // Agregar posts al DOM del feed normal (mantener sincronizado)
                const postsContainer = document.getElementById('postsContainer');

                data.posts.forEach(post => {
                    // Verificar que no exista ya
                    if (!loadedPostIds.has(post.id) && !document.querySelector(`.post[data-post-id="${post.id}"]`)) {
                        const postHtml = renderPost(post);
                        postsContainer.insertAdjacentHTML('beforeend', postHtml);
                        loadedPostIds.add(post.id); // Registrar nuevo ID
                    }
                });

                // Reinicializar carruseles y observers para los nuevos posts
                if (typeof initCarousels === 'function') {
                    initCarousels();
                }
                if (typeof initVideoObserversForNewPosts === 'function') {
                    initVideoObserversForNewPosts();
                }

                // Ahora recolectar los nuevos posts para el fullscreen
                const existingIds = new Set(fullscreenPosts.map(p => p.id));

                document.querySelectorAll('.post-media[data-post-id]').forEach(media => {
                    const postId = parseInt(media.dataset.postId);
                    if (postId && !existingIds.has(postId)) {
                        const mediaSrc = media.dataset.mediaSrc;
                        const mediaType = media.dataset.mediaType;
                        if (mediaSrc) {
                            const postElement = media.closest('.post');
                            const postData = {
                                id: postId,
                                type: mediaType,
                                src: mediaSrc,
                                loaded: false,
                                creatorId: postElement?.dataset.creatorId || '',
                                creatorName: postElement?.dataset.creatorName || 'Creador',
                                creatorPhoto: postElement?.dataset.creatorPhoto || '',
                                creatorUsername: postElement?.querySelector('.post-username')?.textContent?.trim() || '',
                                creatorVerified: postElement?.querySelector('.post-username .fas.fa-check-circle') !== null,
                                isLadoB: postElement?.querySelector('.badge-ladob') !== null,
                                isFollowing: postElement?.dataset.isFollowing === 'true',
                                description: postElement?.querySelector('.post-caption-text')?.textContent?.trim() || '',
                                likes: parseInt(postElement?.dataset.likes) || 0,
                                comments: parseInt(postElement?.dataset.comments) || 0,
                                isLiked: postElement?.querySelector('.like-btn')?.classList.contains('liked') || false,
                                postDate: postElement?.querySelector('.post-time')?.textContent?.trim() || ''
                            };

                            // Verificar carrusel
                            if (media.dataset.isCarousel === 'true' && media.dataset.carouselFiles) {
                                try {
                                    postData.isCarousel = true;
                                    postData.carouselFiles = JSON.parse(media.dataset.carouselFiles);
                                    postData.carouselIndex = 0;
                                } catch (e) {}
                            }

                            // Audio
                            if (media.dataset.audioSrc) {
                                postData.audioSrc = media.dataset.audioSrc;
                                postData.audioTitle = media.dataset.audioTitle || '';
                                postData.audioArtist = media.dataset.audioArtist || '';
                                postData.audioStart = parseFloat(media.dataset.audioStart) || 0;
                                postData.audioVolume = Math.min(1, Math.max(0, parseFloat(media.dataset.audioVolume) || 0.7));
                            }

                            fullscreenPosts.push(postData);
                        }
                    }
                });

                // Generar slides para los nuevos posts
                const container = document.getElementById('fullscreenSlidesContainer');
                const newPostsCount = fullscreenPosts.length - existingIds.size;
                const startIndex = fullscreenPosts.length - newPostsCount;

                for (let i = startIndex; i < fullscreenPosts.length; i++) {
                    const post = fullscreenPosts[i];
                    const slide = document.createElement('div');
                    slide.className = 'fullscreen-slide';
                    slide.dataset.postId = post.id;
                    slide.dataset.index = i;
                    slide.innerHTML = generateSlideContent(post, i);

                    // Agregar event listeners de doble tap para like
                    slide.addEventListener('click', (e) => handleTap(e, post.id, slide));
                    slide.addEventListener('touchend', (e) => handleTap(e, post.id, slide));

                    // Si es carrusel, agregar eventos de swipe
                    if (post.isCarousel) {
                        const wrapper = slide.querySelector('.fs-carousel-wrapper');
                        if (wrapper) {
                            let startX = 0;
                            wrapper.addEventListener('touchstart', (e) => {
                                startX = e.touches[0].clientX;
                            }, { passive: true });
                            wrapper.addEventListener('touchend', (e) => {
                                const endX = e.changedTouches[0].clientX;
                                const diff = startX - endX;
                                if (Math.abs(diff) > 50) {
                                    e.stopPropagation();
                                    fsCarouselNav(post.id, diff > 0 ? 1 : -1);
                                }
                            }, { passive: false });
                        }
                    }

                    container.appendChild(slide);
                }

                // Actualizar contador
                updateCounter();

                console.log('[FullView] Nuevos slides agregados. Total posts:', fullscreenPosts.length, 'hayMas:', data.hayMas);

                fullscreenHasMore = data.hayMas;
            } else {
                fullscreenHasMore = false;
            }
        } catch (error) {
            console.error('Error cargando más posts para fullscreen:', error);
        } finally {
            isLoadingMoreFullscreen = false;
        }
    }

    // Scroll al slide
    function scrollToSlide(index, smooth = true) {
        const container = document.getElementById('fullscreenSlidesContainer');
        // iOS fix: usar altura real del slide
        const slides = container.querySelectorAll('.fullscreen-slide');
        const slideHeight = slides.length > 0 ? slides[0].offsetHeight : window.innerHeight;
        container.scrollTo({
            top: slideHeight * index,
            behavior: smooth ? 'smooth' : 'auto'
        });
    }

    // Actualizar contador y visibilidad del botón de mute
    function updateCounter() {
        const counter = document.getElementById('fullscreenCounter');
        counter.textContent = `${currentFullscreenIndex + 1} / ${fullscreenPosts.length}`;
        // Actualizar visibilidad del botón de mute según el tipo de contenido
        updateGlobalMuteVisibility();
    }

    // Reproducir video o audio del slide actual
    function playCurrentVideo() {
        // IMPORTANTE: Pausar TODOS los medios primero para evitar audio superpuesto
        pauseAllFullscreenMedia();

        // USAR data-index para buscar el slide correcto - más confiable que índices de array
        const container = document.getElementById('fullscreenSlidesContainer');
        if (!container) {
            return;
        }

        const slide = container.querySelector(`.fullscreen-slide[data-index="${currentFullscreenIndex}"]`);

        if (!slide) {
            return;
        }

        const postId = slide.dataset.postId;

        // 🍎 iOS: Usar iOSMediaFix para desbloquear media primero
        if (window.iOSMediaFix?.isIOS) {
            window.iOSMediaFix.unlock();
        } else {
            unlockAudio();
        }

        // Reproducir video si existe
        const video = slide.querySelector('video');
        if (video) {
            // 🍎 iOS: Usar iOSMediaFix.playVideo() que maneja correctamente iOS
            const playVideoAsync = async () => {
                // Asegurar atributos críticos para iOS
                video.playsInline = true;
                video.setAttribute('playsinline', '');
                video.setAttribute('webkit-playsinline', '');

                if (window.iOSMediaFix?.isIOS) {
                    // En iOS, usar el helper que maneja todos los edge cases
                    const success = await window.iOSMediaFix.playVideo(video);
                    // iOS siempre empieza muted
                    updateGlobalMuteIcon(true);

                    if (!success) {
                        // Mostrar indicador de tap-to-play
                        slide.classList.add('needs-tap');
                        // Detener animación después de 5s para ahorrar CPU/batería
                        setTimeout(() => slide.classList.remove('needs-tap'), 5000);
                    } else {
                        slide.classList.remove('needs-tap');
                    }
                } else {
                    // Desktop/Android: intentar sin mute primero
                    try {
                        video.muted = false;
                        await video.play();
                        updateGlobalMuteIcon(false);
                    } catch (e) {
                        // Fallback a muted
                        video.muted = true;
                        try {
                            await video.play();
                            updateGlobalMuteIcon(true);
                        } catch (e2) {
                            console.warn('[FullView] Error reproduciendo video:', e2);
                        }
                    }
                }
            };
            playVideoAsync();
            return; // Videos no tienen audio adicional
        }

        // Reproducir audio si existe (para imagenes con musica)
        const audio = slide.querySelector('audio.fullscreen-audio-player');
        const musicBadge = slide.querySelector('.fullscreen-music-badge');

        if (audio && musicBadge) {
            const audioPostId = audio.dataset.postId;

            // Evitar reproducir si ya es el audio actual
            if (currentPlayingAudioId === audioPostId && !audio.paused) {
                return;
            }

            const startTime = parseFloat(audio.dataset.start) || 0;
            const volume = parseFloat(audio.dataset.volume) || 0.7;
            audio.currentTime = startTime;
            audio.volume = volume;

            const playAudio = async () => {
                try {
                    await audio.play();
                    currentPlayingAudioId = audioPostId;
                    musicBadge.classList.add('playing');
                } catch (e) {
                    // Mostrar indicador de que necesita tap para reproducir
                    musicBadge.classList.add('tap-to-play');
                }
            };
            playAudio();

            // Click en badge para toggle - usar dataset para evitar duplicados
            if (!musicBadge.dataset.handlerAttached) {
                musicBadge.dataset.handlerAttached = 'true';
                musicBadge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const thisAudio = musicBadge.parentElement.querySelector('audio.fullscreen-audio-player');
                    if (!thisAudio) return;

                    musicBadge.classList.remove('tap-to-play');
                    if (thisAudio.paused) {
                        // Pausar todos los otros audios primero
                        pauseAllFullscreenMedia();
                        const st = parseFloat(thisAudio.dataset.start) || 0;
                        thisAudio.currentTime = st;
                        thisAudio.play().then(() => {
                            currentPlayingAudioId = thisAudio.dataset.postId;
                            musicBadge.classList.add('playing');
                        }).catch(() => {});
                    } else {
                        thisAudio.pause();
                        currentPlayingAudioId = null;
                        musicBadge.classList.remove('playing');
                    }
                });
            }
        }
    }

    // Pausar video y audio en indice
    function pauseVideoAtIndex(index) {
        const slides = document.querySelectorAll('.fullscreen-slide');
        if (slides[index]) {
            const slide = slides[index];

            // Pausar video
            const video = slide.querySelector('video');
            if (video) {
                video.pause();
            }

            // Pausar audio
            const audio = slide.querySelector('.fullscreen-audio-player');
            const musicBadge = slide.querySelector('.fullscreen-music-badge');
            if (audio) {
                audio.pause();
                if (musicBadge) {
                    musicBadge.classList.remove('playing');
                }
            }
        }
    }

    // ========================================
    // COMMENTS BOTTOM SHEET (Instagram-style)
    // ========================================
    let bsCurrentPostId = null;
    let bsCurrentPage = 1;
    let bsHasMore = false;
    let bsReplyToId = null;
    let bsIsLoading = false;

    // Abrir el bottom sheet de comentarios
    window.openCommentsBottomSheet = function(postId) {
        bsCurrentPostId = postId;
        bsCurrentPage = 1;
        bsHasMore = false;
        bsReplyToId = null;
        bsIsLoading = false;

        // Reset UI
        document.getElementById('commentsBsList').innerHTML = '';
        document.getElementById('commentsBsLoading').style.display = 'flex';
        document.getElementById('commentsBsEmpty').style.display = 'none';
        document.getElementById('commentsBsLoadMore').style.display = 'none';
        document.getElementById('commentsBsInput').value = '';
        document.getElementById('commentsBsSendBtn').classList.remove('enabled');
        cancelBsReply();

        // Mostrar overlay y bottom sheet
        document.getElementById('commentsBsOverlay').classList.add('active');
        document.getElementById('commentsBottomSheet').classList.add('active');

        // Cargar comentarios
        loadBsComments(postId, 1);

        // Inicializar drag gesture
        initBsDragGesture();
    };

    // Cerrar el bottom sheet
    window.closeCommentsBottomSheet = function() {
        document.getElementById('commentsBsOverlay').classList.remove('active');
        document.getElementById('commentsBottomSheet').classList.remove('active');
        bsCurrentPostId = null;
        bsReplyToId = null;
    };

    // Cargar comentarios via AJAX
    async function loadBsComments(postId, page) {
        if (bsIsLoading) return;
        bsIsLoading = true;

        try {
            const res = await fetch(`/Feed/ObtenerComentarios?contenidoId=${postId}&page=${page}&pageSize=15`);
            const data = await res.json();

            document.getElementById('commentsBsLoading').style.display = 'none';

            if (data.success) {
                if (data.comentarios && data.comentarios.length > 0) {
                    const list = document.getElementById('commentsBsList');
                    data.comentarios.forEach(c => {
                        list.appendChild(createBsCommentElement(c));
                    });
                    document.getElementById('commentsBsEmpty').style.display = 'none';
                } else if (page === 1) {
                    document.getElementById('commentsBsEmpty').style.display = 'block';
                }

                bsHasMore = data.hasMore;
                bsCurrentPage = page;
                document.getElementById('commentsBsLoadMore').style.display = bsHasMore ? 'block' : 'none';
            }
        } catch (err) {
            console.error('Error cargando comentarios:', err);
            document.getElementById('commentsBsLoading').style.display = 'none';
        } finally {
            bsIsLoading = false;
        }
    }

    // Cargar mas comentarios
    window.loadMoreBsComments = function() {
        if (bsCurrentPostId && bsHasMore) {
            loadBsComments(bsCurrentPostId, bsCurrentPage + 1);
        }
    };

    // Crear elemento HTML de un comentario
    function createBsCommentElement(comment) {
        const div = document.createElement('div');
        div.className = 'bs-comment-item';
        div.dataset.commentId = comment.id;

        const timeAgo = formatTimeAgo(comment.fechaCreacion);
        const avatarHtml = comment.usuario?.fotoPerfil
            ? `<img src="${comment.usuario.fotoPerfil}" alt="">`
            : `<div class="bs-comment-avatar-initial">${(comment.usuario?.username || 'U').charAt(0).toUpperCase()}</div>`;

        const likeSvgFill = comment.meDioLike ? 'currentColor' : 'none';
        const likedClass = comment.meDioLike ? 'liked' : '';

        div.innerHTML = `
            <div class="bs-comment-avatar">${avatarHtml}</div>
            <div class="bs-comment-body">
                <div class="bs-comment-header">
                    <a href="/Feed/Perfil/${window.escapeHtml(comment.usuario?.username || '')}" class="bs-comment-username">${window.escapeHtml(comment.usuario?.username || 'usuario')}</a>
                    <span class="bs-comment-time">${timeAgo}</span>
                </div>
                <p class="bs-comment-text">${window.escapeHtml(comment.texto)}</p>
                <div class="bs-comment-actions">
                    <button class="bs-comment-action-btn ${likedClass}" onclick="toggleBsCommentLike(${comment.id}, this)">
                        <svg viewBox="0 0 24 24" fill="${likeSvgFill}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        <span>${comment.numeroLikes > 0 ? comment.numeroLikes : ''}</span>
                    </button>
                    <button class="bs-comment-reply-btn" onclick="startBsReply(${comment.id}, '${window.escapeHtml(comment.usuario?.username || '')}')">Responder</button>
                </div>
                ${comment.totalRespuestas > 0 ? `
                    <div class="bs-comment-replies" id="bsReplies-${comment.id}">
                        <button class="bs-show-replies-btn" onclick="loadBsReplies(${comment.id}, this)">
                            Ver ${comment.totalRespuestas} ${comment.totalRespuestas === 1 ? 'respuesta' : 'respuestas'}
                        </button>
                    </div>
                ` : `<div class="bs-comment-replies" id="bsReplies-${comment.id}"></div>`}
            </div>
        `;

        return div;
    }

    // Crear elemento HTML de una respuesta
    function createBsReplyElement(reply) {
        const div = document.createElement('div');
        div.className = 'bs-reply-item';
        div.dataset.commentId = reply.id;

        const timeAgo = formatTimeAgo(reply.fechaCreacion);
        const avatarHtml = reply.usuario?.fotoPerfil
            ? `<img src="${reply.usuario.fotoPerfil}" alt="">`
            : `<div class="bs-comment-avatar-initial">${(reply.usuario?.username || 'U').charAt(0).toUpperCase()}</div>`;

        const likeSvgFill = reply.meDioLike ? 'currentColor' : 'none';
        const likedClass = reply.meDioLike ? 'liked' : '';

        div.innerHTML = `
            <div class="bs-comment-avatar">${avatarHtml}</div>
            <div class="bs-comment-body">
                <div class="bs-comment-header">
                    <a href="/Feed/Perfil/${window.escapeHtml(reply.usuario?.username || '')}" class="bs-comment-username">${window.escapeHtml(reply.usuario?.username || 'usuario')}</a>
                    <span class="bs-comment-time">${timeAgo}</span>
                </div>
                <p class="bs-comment-text">${window.escapeHtml(reply.texto)}</p>
                <div class="bs-comment-actions">
                    <button class="bs-comment-action-btn ${likedClass}" onclick="toggleBsCommentLike(${reply.id}, this)">
                        <svg viewBox="0 0 24 24" fill="${likeSvgFill}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        <span>${reply.numeroLikes > 0 ? reply.numeroLikes : ''}</span>
                    </button>
                </div>
            </div>
        `;

        return div;
    }

    // Formatear tiempo relativo
    function formatTimeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        const diffWeeks = Math.floor(diffDays / 7);

        if (diffMins < 1) return 'ahora';
        if (diffMins < 60) return `${diffMins}m`;
        if (diffHours < 24) return `${diffHours}h`;
        if (diffDays < 7) return `${diffDays}d`;
        return `${diffWeeks}sem`;
    }

    // Toggle like en comentario del bottom sheet
    window.toggleBsCommentLike = async function(commentId, btn) {
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const res = await fetch('/Feed/ToggleLikeComentario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comentarioId=${commentId}&__RequestVerificationToken=${encodeURIComponent(token || '')}`
            });
            const data = await res.json();
            if (data.success) {
                const countSpan = btn.querySelector('span');
                const svg = btn.querySelector('svg');
                if (data.meDioLike) {
                    btn.classList.add('liked');
                    svg.setAttribute('fill', 'currentColor');
                } else {
                    btn.classList.remove('liked');
                    svg.setAttribute('fill', 'none');
                }
                countSpan.textContent = data.likes > 0 ? data.likes : '';
            }
        } catch (err) {
            console.error('Error al dar like:', err);
        }
    };

    // Cargar respuestas de un comentario
    window.loadBsReplies = async function(commentId, btn) {
        const container = document.getElementById(`bsReplies-${commentId}`);
        if (!container) return;

        btn.textContent = 'Cargando...';
        btn.disabled = true;

        try {
            const res = await fetch(`/Feed/ObtenerRespuestasComentario?comentarioId=${commentId}&skip=0&take=50`);
            const data = await res.json();

            if (data.success) {
                // Quitar boton de mostrar respuestas
                btn.remove();

                // Agregar respuestas
                data.respuestas.forEach(r => {
                    container.appendChild(createBsReplyElement(r));
                });
            }
        } catch (err) {
            console.error('Error cargando respuestas:', err);
            btn.textContent = 'Error, reintentar';
            btn.disabled = false;
        }
    };

    // Responder a un comentario
    window.startBsReply = function(commentId, username) {
        bsReplyToId = commentId;
        document.getElementById('commentsBsReplyTo').textContent = 'Respondiendo a @@' + username;
        document.getElementById('commentsBsReplyIndicator').classList.add('active');
        document.getElementById('commentsBsInput').focus();
        document.getElementById('commentsBsInput').placeholder = 'Responder a @@' + username + '...';
    };

    // Cancelar respuesta
    window.cancelBsReply = function() {
        bsReplyToId = null;
        document.getElementById('commentsBsReplyIndicator').classList.remove('active');
        document.getElementById('commentsBsInput').placeholder = 'Agrega un comentario...';
    };

    // Enviar comentario/respuesta
    window.sendBsComment = async function() {
        const input = document.getElementById('commentsBsInput');
        const texto = input.value.trim();
        if (!texto || !bsCurrentPostId) return;

        const sendBtn = document.getElementById('commentsBsSendBtn');
        sendBtn.classList.remove('enabled');
        input.disabled = true;

        try {
            const formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
            formData.append('id', bsCurrentPostId);
            formData.append('texto', texto);
            if (bsReplyToId) {
                formData.append('comentarioPadreId', bsReplyToId);
            }

            const res = await fetch('/Feed/Comentar', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                input.value = '';

                if (bsReplyToId) {
                    // Agregar respuesta al contenedor de respuestas del comentario padre
                    const repliesContainer = document.getElementById(`bsReplies-${bsReplyToId}`);
                    if (repliesContainer) {
                        const replyEl = document.createElement('div');
                        replyEl.className = 'bs-reply-item';
                        replyEl.innerHTML = `
                            <div class="bs-comment-avatar">
                                <div class="bs-comment-avatar-initial">${(data.comentario.username || 'U').charAt(0).toUpperCase()}</div>
                            </div>
                            <div class="bs-comment-body">
                                <div class="bs-comment-header">
                                    <span class="bs-comment-username">${window.escapeHtml(data.comentario.username)}</span>
                                    <span class="bs-comment-time">ahora</span>
                                </div>
                                <p class="bs-comment-text">${window.escapeHtml(data.comentario.texto)}</p>
                            </div>
                        `;
                        repliesContainer.appendChild(replyEl);
                    }
                    cancelBsReply();
                } else {
                    // Agregar comentario nuevo al principio de la lista
                    const list = document.getElementById('commentsBsList');
                    const newComment = document.createElement('div');
                    newComment.className = 'bs-comment-item';
                    newComment.innerHTML = `
                        <div class="bs-comment-avatar">
                            <div class="bs-comment-avatar-initial">${(data.comentario.username || 'U').charAt(0).toUpperCase()}</div>
                        </div>
                        <div class="bs-comment-body">
                            <div class="bs-comment-header">
                                <span class="bs-comment-username">${window.escapeHtml(data.comentario.username)}</span>
                                <span class="bs-comment-time">ahora</span>
                            </div>
                            <p class="bs-comment-text">${window.escapeHtml(data.comentario.texto)}</p>
                            <div class="bs-comment-actions">
                                <button class="bs-comment-reply-btn" onclick="startBsReply(${data.comentario.id}, '${window.escapeHtml(data.comentario.username)}')">Responder</button>
                            </div>
                            <div class="bs-comment-replies" id="bsReplies-${data.comentario.id}"></div>
                        </div>
                    `;
                    list.insertBefore(newComment, list.firstChild);
                    document.getElementById('commentsBsEmpty').style.display = 'none';
                }

                // Actualizar contador de comentarios en el fullscreen
                updateBsCommentCount(bsCurrentPostId, 1);
            } else {
                showFullscreenToast(data.message || 'Error al comentar');
            }
        } catch (err) {
            console.error('Error al enviar comentario:', err);
            showFullscreenToast('Error al publicar comentario');
        } finally {
            input.disabled = false;
        }
    };

    // Actualizar contador de comentarios en el fullscreen overlay
    function updateBsCommentCount(postId, delta) {
        // Actualizar en fullscreenPosts
        const postIdx = fullscreenPosts.findIndex(p => p.id === postId);
        if (postIdx >= 0) {
            fullscreenPosts[postIdx].comments = (fullscreenPosts[postIdx].comments || 0) + delta;
            // Actualizar el span visible
            const slide = document.querySelector(`.fullscreen-slide[data-post-id="${postId}"]`);
            const countEl = slide?.querySelector('.credits-comments-count');
            if (countEl) {
                countEl.textContent = formatNumber(fullscreenPosts[postIdx].comments);
            }
        }
    }

    // Input handler para habilitar/deshabilitar boton de enviar
    document.getElementById('commentsBsInput')?.addEventListener('input', function() {
        const sendBtn = document.getElementById('commentsBsSendBtn');
        if (this.value.trim()) {
            sendBtn.classList.add('enabled');
        } else {
            sendBtn.classList.remove('enabled');
        }
    });

    // Enter para enviar comentario
    document.getElementById('commentsBsInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            sendBsComment();
        }
    });

    // Drag gesture para cerrar el bottom sheet
    let bsDragInitialized = false;
    function initBsDragGesture() {
        if (bsDragInitialized) return;
        bsDragInitialized = true;

        const sheet = document.getElementById('commentsBottomSheet');
        const handle = document.getElementById('commentsBsDragHandle');
        const body = document.getElementById('commentsBsBody');
        if (!sheet || !handle) return;

        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        function onTouchStart(e) {
            // Solo permitir drag desde el handle o cuando el body esta scrolleado arriba
            const isFromHandle = e.target.closest('#commentsBsDragHandle') || e.target.closest('.comments-bs-header');
            const bodyAtTop = body.scrollTop <= 0;

            if (!isFromHandle && !bodyAtTop) return;
            if (!isFromHandle && bodyAtTop) {
                // Solo si es un swipe hacia abajo, detectar en move
            }

            startY = e.touches[0].clientY;
            currentY = startY;
            isDragging = true;
            sheet.classList.add('dragging');
        }

        function onTouchMove(e) {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;

            // Solo permitir arrastrar hacia abajo
            if (deltaY < 0) {
                sheet.style.transform = '';
                return;
            }

            const isDesktop = window.innerWidth >= 768;
            if (isDesktop) {
                sheet.style.transform = `translateX(-50%) translateY(${deltaY}px)`;
            } else {
                sheet.style.transform = `translateY(${deltaY}px)`;
            }

            // Prevenir scroll del body mientras se arrastra
            if (deltaY > 10) {
                e.preventDefault();
            }
        }

        function onTouchEnd() {
            if (!isDragging) return;
            isDragging = false;
            sheet.classList.remove('dragging');
            sheet.style.transform = '';

            const deltaY = currentY - startY;
            // Si arrastro mas de 100px hacia abajo, cerrar
            if (deltaY > 100) {
                closeCommentsBottomSheet();
            }
        }

        sheet.addEventListener('touchstart', onTouchStart, { passive: true });
        sheet.addEventListener('touchmove', onTouchMove, { passive: false });
        sheet.addEventListener('touchend', onTouchEnd, { passive: true });
    }

    // Cerrar bottom sheet con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('commentsBottomSheet')?.classList.contains('active')) {
            closeCommentsBottomSheet();
        }
    });

    // Cerrar fullscreen viewer
    // ⚠️ GLOBAL para onclick en HTML
    window.closeFullscreenViewer = function() {
        // Cerrar bottom sheet de comentarios si esta abierto
        closeCommentsBottomSheet();

        // Obtener el postId del slide actual ANTES de limpiar
        const currentPostId = fullscreenPosts[currentFullscreenIndex]?.id;

        // Limpiar timeout pendiente para evitar ejecución después de cerrar
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
            scrollTimeout = null;
        }

        // Pausar todo primero
        pauseAllFullscreenMedia();

        // Limpiar cache de medios precargados para liberar memoria
        for (const [src, media] of preloadedMedia.entries()) {
            if (media instanceof HTMLVideoElement) {
                media.pause();
                media.removeAttribute('src');
                media.load();
            }
        }
        preloadedMedia.clear();

        // Ocultar botón de mute global
        const muteBtn = document.getElementById('globalMuteBtn');
        if (muteBtn) muteBtn.style.display = 'none';

        const viewer = document.getElementById('fullscreenViewer');
        viewer.classList.remove('active');
        document.body.classList.remove('fullscreen-mode');
        document.body.style.overflow = '';

        // Limpiar container
        document.getElementById('fullscreenSlidesContainer').innerHTML = '';

        // Resetear estado
        currentPlayingAudioId = null;
        currentFullscreenIndex = 0;
        isScrolling = false;
        lastScrollIndex = -1;

        // IMPORTANTE: Marcar fullscreen como inactivo para permitir que el IntersectionObserver del feed funcione
        isFullscreenActive = false;

        // Quitar clase del body y html para mostrar elementos de navegación nuevamente
        document.body.classList.remove('fullscreen-active');
        document.documentElement.classList.remove('fullscreen-active');

        // Cerrar también el carrusel fullscreen si está abierto
        closeFullscreenCarousel();

        // Hacer scroll al post que estaba viendo en el fullview
        if (currentPostId) {
            requestAnimationFrame(() => {
                const postElement = document.querySelector(`.post[data-post-id="${currentPostId}"]`);
                if (postElement) {
                    // Calcular posición para centrar el post en la pantalla
                    const rect = postElement.getBoundingClientRect();
                    const offset = window.pageYOffset + rect.top - (window.innerHeight / 2) + (rect.height / 2);
                    window.scrollTo({
                        top: Math.max(0, offset),
                        behavior: 'instant'
                    });
                }
            });
        }
    };

    // ========================================
    // SWIPE DOWN PARA CERRAR FULLVIEW
    // Compatible con iOS Safari y todos los navegadores
    // ========================================
    (function initSwipeDownToClose() {
        let touchStartY = 0;
        let touchStartX = 0;
        let touchCurrentY = 0;
        let isSwiping = false;
        const SWIPE_THRESHOLD = 100; // pixels para activar cierre
        const HORIZONTAL_THRESHOLD = 50; // si se mueve más horizontal, ignorar

        const viewer = document.getElementById('fullscreenViewer');
        const slidesContainer = document.getElementById('fullscreenSlidesContainer');

        if (!viewer || !slidesContainer) return;

        // Solo en el primer slide (índice 0) permitir swipe down
        function canSwipeDown() {
            // Verificar si estamos en el primer slide
            if (currentFullscreenIndex !== 0) return false;
            // Verificar si el contenedor está en el top
            return slidesContainer.scrollTop < 10;
        }

        viewer.addEventListener('touchstart', function(e) {
            if (!canSwipeDown()) return;

            // Ignorar si el touch inicia dentro de un carrusel Swiper
            if (e.target.closest('.fs-swiper-carousel')) {
                isSwiping = false;
                return;
            }

            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            touchCurrentY = touchStartY;
            isSwiping = true;
        }, { passive: true });

        viewer.addEventListener('touchmove', function(e) {
            if (!isSwiping) return;

            touchCurrentY = e.touches[0].clientY;
            const touchCurrentX = e.touches[0].clientX;
            const deltaY = touchCurrentY - touchStartY;
            const deltaX = Math.abs(touchCurrentX - touchStartX);

            // Si se está moviendo más horizontal que vertical, cancelar
            if (deltaX > HORIZONTAL_THRESHOLD) {
                isSwiping = false;
                return;
            }

            // Solo permitir arrastrar hacia abajo
            if (deltaY > 0 && canSwipeDown()) {
                // Feedback visual: mover el viewer hacia abajo
                const translateY = Math.min(deltaY * 0.5, 150);
                const scale = Math.max(1 - (deltaY * 0.0005), 0.9);
                const opacity = Math.max(1 - (deltaY * 0.003), 0.5);

                viewer.style.transform = `translateY(${translateY}px) scale(${scale})`;
                viewer.style.opacity = opacity;
                viewer.style.transition = 'none';
            }
        }, { passive: true });

        viewer.addEventListener('touchend', function(e) {
            if (!isSwiping) return;
            isSwiping = false;

            const deltaY = touchCurrentY - touchStartY;

            // Restaurar estilos
            viewer.style.transition = 'transform 0.3s ease, opacity 0.3s ease';

            if (deltaY > SWIPE_THRESHOLD && canSwipeDown()) {
                // Swipe down suficiente - cerrar
                viewer.style.transform = 'translateY(100vh)';
                viewer.style.opacity = '0';

                // Haptic feedback
                if (window.LadoHaptic) {
                    window.LadoHaptic.light();
                } else if (navigator.vibrate) {
                    navigator.vibrate(15);
                }

                setTimeout(() => {
                    viewer.style.transform = '';
                    viewer.style.opacity = '';
                    viewer.style.transition = '';
                    closeFullscreenViewer();
                }, 300);
            } else {
                // No suficiente - volver a posición original
                viewer.style.transform = '';
                viewer.style.opacity = '';
                setTimeout(() => {
                    viewer.style.transition = '';
                }, 300);
            }
        }, { passive: true });

        // También permitir swipe down en carrusel interno
        viewer.addEventListener('touchcancel', function() {
            isSwiping = false;
            viewer.style.transform = '';
            viewer.style.opacity = '';
            viewer.style.transition = '';
        }, { passive: true });
    })();

    // Navegar entre slides con botones
    // ⚠️ GLOBAL para onclick en HTML
    window.navigateFullscreen = function(direction) {
        const container = document.getElementById('fullscreenSlidesContainer');
        // iOS fix: usar altura real del slide
        const slides = container.querySelectorAll('.fullscreen-slide');
        const slideHeight = slides.length > 0 ? slides[0].offsetHeight : window.innerHeight;
        const newIndex = currentFullscreenIndex + direction;

        if (newIndex < 0 || newIndex >= fullscreenPosts.length) return;

        // Pausar media actual
        pauseAllFullscreenMedia();

        currentFullscreenIndex = newIndex;
        container.scrollTo({
            top: slideHeight * newIndex,
            behavior: 'smooth'
        });

        // Actualizar contador y botones
        updateCounter();
        updateNavButtons();

        // Reproducir después del scroll
        setTimeout(() => {
            lastScrollIndex = newIndex;
            playCurrentVideo();
        }, 300);
    };

    // Actualizar estado de botones de navegación
    function updateNavButtons() {
        const prevBtn = document.getElementById('navPrevBtn');
        const nextBtn = document.getElementById('navNextBtn');

        if (prevBtn) prevBtn.disabled = currentFullscreenIndex === 0;
        if (nextBtn) nextBtn.disabled = currentFullscreenIndex >= fullscreenPosts.length - 1;
    }

    // ========================================
    // FULLSCREEN CARRUSEL - Para posts con múltiples archivos
    // ========================================
    let carouselFullscreenFiles = [];
    let carouselFullscreenIndex = 0;

    // ⚠️ GLOBAL para onclick en HTML
    window.openFullscreenCarousel = function(event, postId) {
        // No abrir si el click fue en un botón de navegación
        if (event.target.closest('.carousel-btn') || event.target.closest('.carousel-dot')) {
            return;
        }
        event.preventDefault();
        event.stopPropagation();

        const carousel = document.querySelector(`.post-carousel[data-post-id="${postId}"]`);
        if (!carousel) return;

        // Obtener archivos del carrusel
        try {
            carouselFullscreenFiles = JSON.parse(carousel.dataset.carouselFiles || '[]');
        } catch (e) {
            return;
        }

        if (carouselFullscreenFiles.length === 0) return;

        // Obtener índice actual del carrusel en el feed
        carouselFullscreenIndex = parseInt(carousel.dataset.currentIndex || '0');

        // Marcar fullscreen como activo
        isFullscreenActive = true;
        pauseFeedMedia();

        // Agregar clase al body y html para ocultar elementos de navegación y forzar fondo negro
        document.body.classList.add('fullscreen-active');
        document.documentElement.classList.add('fullscreen-active');

        // Generar el viewer del carrusel
        generateCarouselFullscreenViewer();

        // Mostrar
        const viewer = document.getElementById('carouselFullscreenViewer');
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.body.classList.add('fullscreen-mode');

        // Ir al slide actual
        updateCarouselFullscreen();
    }

    function generateCarouselFullscreenViewer() {
        // Verificar si ya existe el viewer
        let viewer = document.getElementById('carouselFullscreenViewer');
        if (!viewer) {
            // Crear el viewer
            viewer = document.createElement('div');
            viewer.id = 'carouselFullscreenViewer';
            viewer.className = 'carousel-fullscreen-viewer';
            viewer.innerHTML = `
                <button class="carousel-fs-close" onclick="closeFullscreenCarousel()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div class="carousel-fs-counter" id="carouselFsCounter">1 / 1</div>
                <div class="carousel-fs-content" id="carouselFsContent"></div>
                <button class="carousel-fs-nav carousel-fs-prev" onclick="carouselFsPrev()">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <button class="carousel-fs-nav carousel-fs-next" onclick="carouselFsNext()">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </button>
                <div class="carousel-fs-dots" id="carouselFsDots"></div>
            `;
            document.body.appendChild(viewer);

            // Agregar swipe support
            let touchStartX = 0;
            let touchEndX = 0;
            viewer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            viewer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) carouselFsNext();
                    else carouselFsPrev();
                }
            }, { passive: true });

            // Click en el fondo para cerrar
            viewer.addEventListener('click', (e) => {
                if (e.target === viewer || e.target.classList.contains('carousel-fs-content')) {
                    closeFullscreenCarousel();
                }
            });
        }

        // Generar contenido
        const content = document.getElementById('carouselFsContent');
        content.innerHTML = carouselFullscreenFiles.map((file, index) => {
            if (file.type === 'video') {
                // 🍎 iOS Safari requiere MIME type explícito y atributos especiales
                const isWebmFs = file.src.toLowerCase().endsWith('.webm');
                const mimeTypeFs = isWebmFs ? 'video/webm' : 'video/mp4';
                return `<div class="carousel-fs-slide ${index === carouselFullscreenIndex ? 'active' : ''}" data-index="${index}">
                    <video playsinline webkit-playsinline="true" x-webkit-airplay="allow" autoplay loop muted preload="auto">
                        ${!isWebmFs ? `<source src="${file.src}" type="video/mp4">` : ''}
                        <source src="${file.src}" type="${mimeTypeFs}">
                    </video>
                    <button class="carousel-fs-mute" onclick="toggleCarouselFsVideoMute(this)">
                        <svg class="icon-muted" viewBox="0 0 24 24" fill="white"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                        <svg class="icon-unmuted" viewBox="0 0 24 24" fill="white" style="display:none;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                </div>`;
            } else {
                return `<div class="carousel-fs-slide ${index === carouselFullscreenIndex ? 'active' : ''}" data-index="${index}">
                    <img src="${file.src}" alt="">
                </div>`;
            }
        }).join('');

        // Generar dots
        const dots = document.getElementById('carouselFsDots');
        dots.innerHTML = carouselFullscreenFiles.map((_, index) =>
            `<span class="carousel-fs-dot ${index === carouselFullscreenIndex ? 'active' : ''}" onclick="goToCarouselFsSlide(${index})"></span>`
        ).join('');
    }

    function updateCarouselFullscreen() {
        const content = document.getElementById('carouselFsContent');
        const counter = document.getElementById('carouselFsCounter');
        const dots = document.getElementById('carouselFsDots');
        const prevBtn = document.querySelector('.carousel-fs-prev');
        const nextBtn = document.querySelector('.carousel-fs-next');

        // Actualizar slides activos
        content.querySelectorAll('.carousel-fs-slide').forEach((slide, index) => {
            slide.classList.toggle('active', index === carouselFullscreenIndex);
            // Pausar/reproducir videos
            const video = slide.querySelector('video');
            if (video) {
                if (index === carouselFullscreenIndex) {
                    video.currentTime = 0;
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            }
        });

        // Actualizar dots
        dots.querySelectorAll('.carousel-fs-dot').forEach((dot, index) => {
            dot.classList.toggle('active', index === carouselFullscreenIndex);
        });

        // Actualizar contador
        counter.textContent = `${carouselFullscreenIndex + 1} / ${carouselFullscreenFiles.length}`;

        // Mostrar/ocultar botones de navegación
        if (prevBtn) prevBtn.style.display = carouselFullscreenIndex === 0 ? 'none' : 'flex';
        if (nextBtn) nextBtn.style.display = carouselFullscreenIndex === carouselFullscreenFiles.length - 1 ? 'none' : 'flex';
    }

    function carouselFsPrev() {
        if (carouselFullscreenIndex > 0) {
            carouselFullscreenIndex--;
            updateCarouselFullscreen();
        }
    }

    function carouselFsNext() {
        if (carouselFullscreenIndex < carouselFullscreenFiles.length - 1) {
            carouselFullscreenIndex++;
            updateCarouselFullscreen();
        }
    }

    // ⚠️ GLOBAL para onclick en HTML
    window.goToCarouselFsSlide = function(index) {
        carouselFullscreenIndex = index;
        updateCarouselFullscreen();
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.toggleCarouselFsVideoMute = function(btn) {
        const slide = btn.closest('.carousel-fs-slide');
        const video = slide ? slide.querySelector('video') : null;
        if (!video) return;

        video.muted = !video.muted;
        btn.querySelector('.icon-muted').style.display = video.muted ? 'block' : 'none';
        btn.querySelector('.icon-unmuted').style.display = video.muted ? 'none' : 'block';
    };

    // ⚠️ GLOBAL para onclick en HTML
    window.closeFullscreenCarousel = function() {
        const viewer = document.getElementById('carouselFullscreenViewer');
        if (viewer) {
            // Pausar todos los videos
            viewer.querySelectorAll('video').forEach(v => v.pause());
            viewer.classList.remove('active');
        }
        document.body.classList.remove('fullscreen-mode');
        document.body.classList.remove('fullscreen-active');
        document.documentElement.classList.remove('fullscreen-active');
        document.body.style.overflow = '';
        isFullscreenActive = false;
        carouselFullscreenFiles = [];
        carouselFullscreenIndex = 0;
    };

    // Keyboard navigation para carrusel fullscreen
    document.addEventListener('keydown', function(e) {
        const viewer = document.getElementById('carouselFullscreenViewer');
        if (!viewer || !viewer.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeFullscreenCarousel();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            carouselFsPrev();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            carouselFsNext();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        const viewer = document.getElementById('fullscreenViewer');
        if (!viewer.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeFullscreenViewer();
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
            e.preventDefault();
            if (currentFullscreenIndex < fullscreenPosts.length - 1) {
                currentFullscreenIndex++;
                scrollToSlide(currentFullscreenIndex);
                updateCounter();
                preloadAdjacentMedia(currentFullscreenIndex);
                // playCurrentVideo() ya llama a pauseAllFullscreenMedia()
                playCurrentVideo();
            }
        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
            e.preventDefault();
            if (currentFullscreenIndex > 0) {
                currentFullscreenIndex--;
                scrollToSlide(currentFullscreenIndex);
                updateCounter();
                preloadAdjacentMedia(currentFullscreenIndex);
                // playCurrentVideo() ya llama a pauseAllFullscreenMedia()
                playCurrentVideo();
            }
        } else if (e.key === ' ') {
            e.preventDefault();
            // Toggle play/pause del video actual
            const slides = document.querySelectorAll('.fullscreen-slide');
            const video = slides[currentFullscreenIndex]?.querySelector('video');
            if (video) {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            }
        }
    });

    // Cerrar al hacer click fuera (en el background)
    document.getElementById('fullscreenViewer')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullscreenViewer();
        }
    });

    // ==========================================
    // SWIPE HORIZONTAL PARA CERRAR/DETALLE
    // ==========================================
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let swipeDirection = null; // 'horizontal', 'vertical', o null

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) {
            // Si el touch inicia dentro de un carrusel Swiper, no rastrear para swipes de cierre
            if (e.target.closest('.fs-swiper-carousel')) {
                swipeDirection = null;
                return;
            }
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
            swipeDirection = null;
        }
    }, { passive: true });

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1 || swipeDirection === 'vertical') return;

        // Ignorar si estamos dentro de un carrusel Swiper
        const targetSlide = e.target.closest('.fullscreen-slide');
        const hasCarousel = targetSlide?.querySelector('.fs-swiper-carousel');
        if (hasCarousel) {
            swipeDirection = null;
            return;
        }

        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = Math.abs(touchX - touchStartX);
        const deltaY = Math.abs(touchY - touchStartY);

        // Determinar direccion del swipe en los primeros 15px de movimiento
        if (swipeDirection === null && (deltaX > 15 || deltaY > 15)) {
            if (deltaX > deltaY * 1.5) {
                swipeDirection = 'horizontal';
            } else {
                swipeDirection = 'vertical';
            }
        }
    }, { passive: true });

    document.getElementById('fullscreenSlidesContainer')?.addEventListener('touchend', function(e) {
        if (swipeDirection !== 'horizontal') {
            swipeDirection = null;
            return;
        }

        // IMPORTANTE: Ignorar swipes horizontales si estamos dentro de un carrusel Swiper
        // para evitar conflictos con la navegación del carrusel
        const targetSlide = e.target.closest('.fullscreen-slide');
        const hasCarousel = targetSlide?.querySelector('.fs-swiper-carousel');
        if (hasCarousel) {
            // Dejar que Swiper maneje la navegación del carrusel
            swipeDirection = null;
            return;
        }

        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        const deltaTime = Date.now() - touchStartTime;

        // Calcular velocidad del swipe
        const velocity = Math.abs(deltaX) / deltaTime;

        // Swipe hacia la izquierda (dedo izq): deltaX negativo -> ir al detalle
        const isSwipeLeft = deltaX < -100 || (deltaX < -50 && velocity > 0.4);

        // Swipe hacia la derecha (dedo der): deltaX positivo -> volver al feed
        const isSwipeRight = deltaX > 100 || (deltaX > 50 && velocity > 0.4);

        if (isSwipeLeft) {
            // Ir al detalle de la publicacion actual
            const currentPost = fullscreenPosts[currentFullscreenIndex];
            if (currentPost && currentPost.id) {
                closeFullscreenViewer();
                window.location.href = '/Feed/Detalle/' + currentPost.id;
            }
        } else if (isSwipeRight) {
            // Volver al feed en la posición del post actual
            const currentPost = fullscreenPosts[currentFullscreenIndex];
            const postId = currentPost?.id;

            // IMPORTANTE: Cerrar el viewer y limpiar estado antes de navegar
            closeFullscreenViewer();

            // Navegar al feed con hash para scroll
            if (postId) {
                window.location.href = '/Feed#post-' + postId;
            } else {
                window.location.href = '/Feed';
            }
        }

        swipeDirection = null;
    }, { passive: true });

    // ========================================
    // ALGORITHM SELECTOR
    // ========================================

    // Exponer globalmente para el onchange
    window.cambiarAlgoritmoSelect = async function(algoritmoId) {
        if (!algoritmoId) {
            return;
        }

        const select = document.getElementById('algorithmSelect');
        if (select) {
            select.disabled = true; // Deshabilitar mientras procesa
        }

        try {
            const response = await fetch('/Feed/CambiarAlgoritmo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: `algoritmoId=${algoritmoId}`
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                // Recargar pagina para aplicar nuevo algoritmo
                window.location.reload();
            } else {
                if (select) select.disabled = false;
            }
        } catch (error) {
            if (select) select.disabled = false;
        }
    };

    // ========================================
    // ABRIR POST COMPARTIDO AUTOMATICAMENTE
    // ========================================
    @if (ViewBag.SharedPostId != null) {
        <text>
    (function() {
        const sharedPostId = @ViewBag.SharedPostId;

        window.addEventListener('load', function() {
            setTimeout(() => {
                const postElement = document.querySelector(`.post[data-post-id="${sharedPostId}"]`);

                if (postElement) {
                    // Scroll al post
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Highlight temporal
                    postElement.style.transition = 'box-shadow 0.3s';
                    postElement.style.boxShadow = '0 0 0 3px #6366f1';
                    setTimeout(() => {
                        postElement.style.boxShadow = '';
                    }, 2000);

                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, 500);
        });
    })();
        </text>
    }

    @if (ViewBag.SharedPostNoAccess != null) {
        <text>
    (function() {
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('sharedPostNoAccessModal').classList.add('active');
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 300);
        });
    })();
        </text>
    }

    // Abrir FullView si viene con parametro ?fullview=1
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('fullview') === '1') {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    // Buscar el primer post con media
                    const firstPost = document.querySelector('.post-media[data-post-id]');
                    if (firstPost) {
                        const postId = parseInt(firstPost.dataset.postId);
                        if (postId && typeof window.openFullscreenViewer === 'function') {
                            // Llamar directamente a la función en vez de simular click
                            window.openFullscreenViewer(new Event('click'), postId, 0);
                        }
                    }
                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 800); // Aumentar timeout para asegurar que todo está cargado
            });
        }
    })();

    // ========================================
    // STORIES - Sistema Instagram-style
    // ========================================
    let storiesData = [];
    let currentUserIndex = 0;
    let currentStoryIndex = 0;
    let storyTimer = null;
    let storyDuration = 5000; // 5 segundos para imágenes
    let storyArchivoSeleccionado = null;

    // Calcular tiempo relativo
    function tiempoRelativoStory(fecha) {
        const ahora = new Date();
        const publicado = new Date(fecha);
        const diff = ahora - publicado;
        const minutos = Math.floor(diff / 60000);
        const horas = Math.floor(diff / 3600000);

        if (minutos < 1) return 'Ahora';
        if (minutos < 60) return `Hace ${minutos}m`;
        if (horas < 24) return `Hace ${horas}h`;
        return 'Hace 1d';
    }

    // Variable para almacenar el anuncio actual
    let anuncioActual = null;

    // Cache de recursos precargados para stories
    const storyPreloadCache = new Map();
    let isPreloadingStory = false;

    // Precargar todos los recursos de una story
    async function precargarStory(story) {
        if (!story) return false;

        const cacheKey = story.id + '_' + story.rutaArchivo;
        if (storyPreloadCache.has(cacheKey)) {
            return true; // Ya precargado
        }

        const promesas = [];

        // 1. Precargar media principal (imagen o video)
        if (story.tipo === 'Video') {
            promesas.push(new Promise((resolve) => {
                const video = document.createElement('video');
                video.preload = 'auto';
                video.muted = true;
                video.oncanplaythrough = () => resolve(true);
                video.onerror = () => resolve(false);
                video.src = story.rutaArchivo;
                // Timeout de 10 segundos
                setTimeout(() => resolve(true), 10000);
            }));
        } else {
            promesas.push(new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = story.rutaArchivo;
                // Timeout de 5 segundos
                setTimeout(() => resolve(true), 5000);
            }));
        }

        // 2. Precargar overlays (stickers, imágenes)
        if (story.overlays && Array.isArray(story.overlays)) {
            story.overlays.forEach(overlay => {
                if (overlay.tipo === 'sticker' || overlay.tipo === 'gif') {
                    promesas.push(new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                        img.src = overlay.src;
                        setTimeout(() => resolve(true), 3000);
                    }));
                }
            });
        }

        // 3. Precargar música
        if (story.musica && story.musica.audioUrl) {
            promesas.push(new Promise((resolve) => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.oncanplaythrough = () => resolve(true);
                audio.onerror = () => resolve(false);
                audio.src = story.musica.audioUrl;
                setTimeout(() => resolve(true), 5000);
            }));
        }

        try {
            await Promise.all(promesas);
            storyPreloadCache.set(cacheKey, true);
            return true;
        } catch (e) {
            return false;
        }
    }

    // Precargar stories adyacentes en background
    function precargarStoriesAdyacentes() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories) return;

        // Precargar siguiente story del mismo usuario
        if (currentStoryIndex + 1 < userStories.stories.length) {
            precargarStory(userStories.stories[currentStoryIndex + 1]);
        }

        // Precargar primera story del siguiente usuario
        if (currentUserIndex + 1 < storiesData.length) {
            const nextUser = storiesData[currentUserIndex + 1];
            if (nextUser && nextUser.stories && nextUser.stories[0]) {
                precargarStory(nextUser.stories[0]);
            }
        }
    }

    // Abrir visor de stories
    async function abrirVisorStories(creadorId) {
        try {
            // Cargar stories desde API
            const response = await fetch('/Stories/Obtener');
            const data = await response.json();

            if (!data.success || !data.stories || data.stories.length === 0) {
                showToast('No hay stories disponibles');
                return;
            }

            storiesData = data.stories;

            // Intentar obtener un anuncio para insertar entre stories
            await insertarAnuncioEnStories();

            // Encontrar índice del creador seleccionado
            currentUserIndex = storiesData.findIndex(s => s.creadorId === creadorId);
            if (currentUserIndex === -1) currentUserIndex = 0;

            currentStoryIndex = 0;

            // Precargar primera story ANTES de mostrar el visor
            const primeraStory = storiesData[currentUserIndex]?.stories?.[0];
            if (primeraStory) {
                await precargarStory(primeraStory);
            }

            // Mostrar overlay (después de precargar)
            document.getElementById('storyViewerOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('story-viewer-open');

            // Mostrar primera story del usuario (ya precargada)
            mostrarStory();

        } catch (error) {
            showToast('Error al cargar stories');
        }
    }

    // Insertar un anuncio entre los grupos de stories
    async function insertarAnuncioEnStories() {
        try {
            // Solo insertar anuncio si hay al menos 2 grupos de stories
            if (storiesData.length < 2) return;

            const response = await fetch('/Stories/ObtenerAnuncioStory');
            const data = await response.json();

            if (!data.success || !data.anuncio) return;

            anuncioActual = data.anuncio;

            // Crear un "grupo de stories" falso para el anuncio
            const anuncioGrupo = {
                creadorId: 'ad-' + data.anuncio.id,
                esAnuncio: true,
                anuncioData: data.anuncio,
                creador: {
                    nombre: data.anuncio.nombreAnunciante,
                    username: 'Publicidad',
                    avatar: data.anuncio.avatarAnunciante
                },
                stories: [{
                    id: 'ad-' + data.anuncio.id,
                    rutaArchivo: data.anuncio.rutaArchivo,
                    tipo: data.anuncio.tipo,
                    esAnuncio: true,
                    urlDestino: data.anuncio.urlDestino,
                    textoBoton: data.anuncio.textoBoton
                }]
            };

            // Insertar el anuncio después del segundo grupo (índice 2)
            const posicionInsercion = Math.min(2, storiesData.length);
            storiesData.splice(posicionInsercion, 0, anuncioGrupo);

        } catch (error) {
        }
    }

    // Mostrar story actual (con precarga optimizada)
    async function mostrarStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories) {
            cerrarVisorStories();
            return;
        }

        const story = userStories.stories[currentStoryIndex];
        if (!story) {
            // Si no hay más stories de este usuario, pasar al siguiente
            usuarioStoriesSiguiente();
            return;
        }

        // Elementos del DOM
        const imgEl = document.getElementById('storyViewerImage');
        const videoEl = document.getElementById('storyViewerVideo');
        const textoEl = document.getElementById('storyViewerText');
        const audioBtn = document.getElementById('storyAudioBtn');
        const loadingEl = document.getElementById('storyLoadingIndicator');
        const overlaysContainer = document.getElementById('storyOverlaysContainer');

        // Ocultar media anterior y mostrar loading
        imgEl.style.display = 'none';
        videoEl.style.display = 'none';
        videoEl.pause();
        overlaysContainer.innerHTML = '';
        detenerMusicaStory();

        // Actualizar fondo blur con la imagen/video actual (estilo Instagram)
        const blurBg = document.getElementById('storyBlurBg');
        if (blurBg && story.rutaArchivo) {
            blurBg.style.backgroundImage = `url('${story.rutaArchivo}')`;
        }

        // Mostrar loading solo si no está precargado
        const cacheKey = story.id + '_' + story.rutaArchivo;
        if (!storyPreloadCache.has(cacheKey)) {
            loadingEl.style.display = 'flex';
        }

        // Actualizar UI mientras se precarga (header, progress bars, etc.)
        actualizarUIStory(userStories, story);

        // Precargar story actual
        await precargarStory(story);

        // Ocultar loading
        loadingEl.style.display = 'none';

        // Mostrar media
        if (story.tipo === 'Video') {
            // Flag para evitar múltiples llamadas al timer
            let timerStarted = false;

            // Configurar eventos ANTES de establecer src (importante para videos en caché)
            videoEl.onerror = function() {
                if (timerStarted) return;
                timerStarted = true;
                videoEl.style.display = 'none';
                textoEl.textContent = '⚠️ Video no compatible con tu dispositivo';
                textoEl.style.display = 'block';
                storyDuration = 3000;
                iniciarTimerStory();
            };

            videoEl.onloadedmetadata = function() {
                if (timerStarted) return;
                timerStarted = true;
                // Usar duración completa del video (sin límite de 30s)
                storyDuration = videoEl.duration * 1000;
                iniciarTimerStory();
            };

            // Establecer src y mostrar
            videoEl.src = story.rutaArchivo;
            videoEl.style.display = 'block';
            if (audioBtn) audioBtn.style.display = 'flex';
            aplicarEstadoAudio();

            // Si el video ya tiene metadata (precargado), iniciar timer inmediatamente
            if (!timerStarted && videoEl.readyState >= 1 && videoEl.duration > 0) {
                timerStarted = true;
                storyDuration = videoEl.duration * 1000;
                iniciarTimerStory();
            }

            videoEl.play().catch((err) => {
                if (err.name !== 'AbortError') {
                    videoEl.onerror?.();
                }
            });
        } else {
            // Para imágenes, esperar a que cargue antes de mostrar
            imgEl.onload = function() {
                imgEl.style.display = 'block';
                storyDuration = 5000;
                iniciarTimerStory();
                // Reproducir música DESPUÉS de que la imagen esté visible
                reproducirMusicaStory(story);
            };
            imgEl.onerror = function() {
                imgEl.style.display = 'block'; // Mostrar igual
                storyDuration = 5000;
                iniciarTimerStory();
            };
            if (audioBtn) audioBtn.style.display = 'none';
            imgEl.src = story.rutaArchivo;

            // Si la imagen ya está en caché del navegador, onload puede no disparar
            if (imgEl.complete) {
                imgEl.style.display = 'block';
                storyDuration = 5000;
                iniciarTimerStory();
                reproducirMusicaStory(story);
            }
        }

        // Renderizar overlays
        renderizarOverlays(story);

        // Texto de la story
        if (!story.tieneOverlays) {
            textoEl.textContent = story.texto || '';
        } else {
            textoEl.textContent = '';
        }

        // Para videos, reproducir música al iniciar playback
        if (story.tipo === 'Video') {
            reproducirMusicaStory(story);
        }

        // Marcar como vista
        marcarStoryVista(story.id);

        // Actualizar navegación
        actualizarNavegacionUsuarios();
        actualizarLikeUI(story);

        // Precargar stories adyacentes en background
        setTimeout(() => precargarStoriesAdyacentes(), 500);
    }

    // Actualizar UI del header y controles (sin esperar media)
    function actualizarUIStory(userStories, story) {
        // Manejar elementos de anuncio
        const adBadge = document.getElementById('storyAdBadge');
        const adCta = document.getElementById('storyAdCta');
        const adCtaText = document.getElementById('storyAdCtaText');
        const bottomBar = document.getElementById('storyBottomBar');
        const btnSilenciar = document.getElementById('btnSilenciarHistorias');

        if (story.esAnuncio || userStories.esAnuncio) {
            adBadge.style.display = 'block';
            adCta.style.display = 'flex';
            adCtaText.textContent = story.textoBoton || 'Ver mas';
            if (bottomBar) bottomBar.style.display = 'none';
            if (btnSilenciar) btnSilenciar.style.display = 'none';
        } else {
            adBadge.style.display = 'none';
            adCta.style.display = 'none';
            if (bottomBar) bottomBar.style.display = 'flex';
        }

        // Actualizar info del usuario
        const avatar = document.getElementById('storyViewerAvatar');
        const avatarPlaceholder = document.getElementById('storyViewerAvatarPlaceholder');

        if (userStories.creador.avatar) {
            avatar.src = userStories.creador.avatar;
            avatar.style.display = 'block';
            avatarPlaceholder.style.display = 'none';
        } else {
            avatar.style.display = 'none';
            avatarPlaceholder.style.display = 'flex';
            avatarPlaceholder.textContent = userStories.creador.nombre?.charAt(0)?.toUpperCase() || '?';
        }

        document.getElementById('storyViewerUsername').textContent = userStories.creador.nombre;
        document.getElementById('storyViewerTime').textContent = tiempoRelativoStory(story.fechaPublicacion);

        // Actualizar barras de progreso
        actualizarBarrasProgreso(userStories.stories.length, currentStoryIndex);

        // Actualizar visibilidad de controles
        actualizarControlesStory();

        // Limpiar input de mensaje
        const msgInput = document.getElementById('storyMessageInput');
        if (msgInput) msgInput.value = '';
    }

    // Detener música de story
    function detenerMusicaStory() {
        const audioEl = document.getElementById('storyMusicPlayer');
        if (audioEl) {
            audioEl.pause();
            audioEl.src = '';
        }
        const indicator = document.getElementById('storyMusicIndicator');
        if (indicator) indicator.style.display = 'none';
    }

    // Actualizar UI de like en el visor de story
    function actualizarLikeUI(story) {
        const likeBtn = document.getElementById('storyLikeBtn');
        const likeCount = document.getElementById('storyLikeCount');
        const likeIcon = document.getElementById('storyLikeIcon');

        if (!likeBtn || !likeIcon) return; // Salir si no existen los elementos

        if (story.liked) {
            likeBtn.classList.add('liked');
            likeIcon.setAttribute('fill', 'currentColor');
        } else {
            likeBtn.classList.remove('liked');
            likeIcon.setAttribute('fill', 'none');
        }

        if (likeCount) {
            likeCount.textContent = story.likes > 0 ? story.likes : '';
        }
    }

    // Toggle like en story actual
    async function toggleStoryLike() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories) return;

        const story = userStories.stories[currentStoryIndex];
        if (!story) return;

        const likeBtn = document.getElementById('storyLikeBtn');
        const likeCount = document.getElementById('storyLikeCount');
        const likeIcon = document.getElementById('storyLikeIcon');

        // Optimistic UI update
        const wasLiked = story.liked;
        story.liked = !wasLiked;
        story.likes = (story.likes || 0) + (wasLiked ? -1 : 1);
        if (story.likes < 0) story.likes = 0;

        actualizarLikeUI(story);

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const formData = new FormData();
            formData.append('__RequestVerificationToken', token || '');

            const response = await fetch(`/Stories/ToggleLike/${story.id}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                // Actualizar con datos reales del servidor
                story.liked = data.liked;
                story.likes = data.likes;
                actualizarLikeUI(story);
            } else {
                // Revertir si hay error
                story.liked = wasLiked;
                story.likes = (story.likes || 0) + (wasLiked ? 1 : -1);
                actualizarLikeUI(story);
            }
        } catch (error) {
            // Revertir en caso de error
            story.liked = wasLiked;
            story.likes = (story.likes || 0) + (wasLiked ? 1 : -1);
            actualizarLikeUI(story);
        }
    }

    // ========================================
    // AUDIO EN STORIES (Compatible con iOS)
    // ========================================
    // iOS requiere interacción del usuario para reproducir audio
    // El video comienza muted y el usuario debe tocar para activar el audio
    let storyAudioMuted = true; // Comienza muted por defecto (para iOS)
    let audioUnlockedByUser = false; // Indica si el usuario ya desbloqueó el audio

    function toggleStoryAudio() {
        const video = document.getElementById('storyViewerVideo');
        if (!video) return;

        storyAudioMuted = !storyAudioMuted;
        video.muted = storyAudioMuted;

        // Marcar que el usuario desbloqueó el audio
        if (!storyAudioMuted) {
            audioUnlockedByUser = true;
        }

        actualizarIconoAudio();

        // Para iOS: si el video está pausado, intentar reproducir de nuevo
        if (!storyAudioMuted && video.paused) {
            video.play().catch(() => {});
        }
    }

    function actualizarIconoAudio() {
        const audioBtn = document.getElementById('storyAudioBtn');
        if (!audioBtn) return;

        const iconOn = audioBtn.querySelector('.audio-on-icon');
        const iconOff = audioBtn.querySelector('.audio-off-icon');

        if (iconOn && iconOff) {
            // Mostrar icono de muted cuando está silenciado
            iconOn.style.display = storyAudioMuted ? 'none' : 'block';
            iconOff.style.display = storyAudioMuted ? 'block' : 'none';
        }
    }

    // Aplicar estado de audio al cargar nuevo video
    function aplicarEstadoAudio() {
        const video = document.getElementById('storyViewerVideo');
        if (!video) return;

        // Si el usuario ya desbloqueó el audio, mantenerlo activo
        if (audioUnlockedByUser && !storyAudioMuted) {
            video.muted = false;
        } else {
            video.muted = true;
            storyAudioMuted = true;
        }
        actualizarIconoAudio();
    }

    // ========================================
    // ELIMINAR STORY INDIVIDUAL
    // ========================================
    // Descargar la historia actual (solo para historias propias)
    async function descargarStoryActual() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory || !currentStory.rutaArchivo) return;

        // Cerrar menú
        const menu = document.getElementById('storyMenuDropdown');
        if (menu) menu.classList.remove('active');

        try {
            // Pausar la historia mientras se descarga
            pausarTimerStory();

            // Obtener el archivo
            const response = await fetch(currentStory.rutaArchivo);
            if (!response.ok) throw new Error('No se pudo descargar');

            const blob = await response.blob();

            // Determinar extensión según tipo
            let extension = 'jpg';
            if (currentStory.tipo === 'Video') {
                extension = 'mp4';
            } else if (currentStory.rutaArchivo.includes('.png')) {
                extension = 'png';
            } else if (currentStory.rutaArchivo.includes('.gif')) {
                extension = 'gif';
            }

            // Crear nombre del archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `historia_${fecha}_${currentStory.id}.${extension}`;

            // Crear link de descarga
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            // Reanudar la historia
            reanudarTimerStory();
        } catch (error) {
            console.error('Error al descargar historia:', error);
            alert('No se pudo descargar la historia');
            reanudarTimerStory();
        }
    }

    // ========================================
    // COMPARTIR STORY
    // ========================================
    let currentShareStoryData = null;

    function abrirCompartirStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        // Guardar datos de la story actual
        // URL al perfil del creador (las historias se ven desde ahí)
        const creadorId = userStories.creador?.id || '';
        currentShareStoryData = {
            id: currentStory.id,
            url: `${window.location.origin}/Feed/Perfil/${creadorId}`,
            creador: userStories.creador,
            rutaArchivo: currentStory.rutaArchivo
        };

        // Pausar story mientras está abierto el modal
        pausarTimerStory();

        // Mostrar botón "Más" si Web Share API está disponible
        if (navigator.share) {
            document.getElementById('shareStoryMoreBtn').style.display = 'flex';
        }

        // Mostrar modal
        document.getElementById('shareStoryOverlay').classList.add('active');
    }

    function cerrarCompartirStory(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('shareStoryOverlay').classList.remove('active');
        reanudarTimerStory();
    }

    function getShareStoryUrl() {
        return currentShareStoryData?.url || window.location.href;
    }

    function getShareStoryText() {
        const creador = currentShareStoryData?.creador?.nombre || 'alguien';
        return `Mira esta historia de ${creador} en LadoApp`;
    }

    function compartirStoryWhatsApp() {
        const url = getShareStoryUrl();
        const text = getShareStoryText();
        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
        cerrarCompartirStory();
    }

    function compartirStoryFacebook() {
        const url = getShareStoryUrl();
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
        cerrarCompartirStory();
    }

    function compartirStoryTwitter() {
        const url = getShareStoryUrl();
        const text = getShareStoryText();
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
        cerrarCompartirStory();
    }

    function compartirStoryTelegram() {
        const url = getShareStoryUrl();
        const text = getShareStoryText();
        window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
        cerrarCompartirStory();
    }

    // Abrir modal de visualizaciones de la story (para creadores)
    function abrirVisualizacionesStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories?.stories) return;

        const story = userStories.stories[currentStoryIndex];
        if (!story) return;

        pausarTimerStory();

        // Por ahora mostramos un toast con la info, en el futuro se puede hacer un modal
        const vistas = story.vistas || story.views || 0;
        showToast(`${vistas} ${vistas === 1 ? 'persona vio' : 'personas vieron'} esta historia`);

        setTimeout(reanudarTimerStory, 1500);
    }

    async function copiarEnlaceStory() {
        const url = getShareStoryUrl();
        try {
            await navigator.clipboard.writeText(url);
            showToast('Enlace copiado');
        } catch (e) {
            // Fallback para navegadores que no soportan clipboard API
            const input = document.createElement('input');
            input.value = url;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('Enlace copiado');
        }
        cerrarCompartirStory();
    }

    function enviarStoryPorMensaje() {
        cerrarCompartirStory();
        // Usar la funcionalidad existente
        abrirMensajesDesdeStory();
    }

    async function compartirStoryNativo() {
        if (!navigator.share) {
            showToast('Compartir no disponible en este navegador');
            return;
        }

        try {
            await navigator.share({
                title: 'Historia en LadoApp',
                text: getShareStoryText(),
                url: getShareStoryUrl()
            });
        } catch (e) {
            if (e.name !== 'AbortError') {
                console.log('Error compartiendo:', e);
            }
        }
        cerrarCompartirStory();
    }

    // ========================================
    // GUARDAR EN DESTACADOS
    // ========================================
    let currentDestacadoStoryId = null;

    async function abrirModalDestacados() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        // Guardar ID de la story
        currentDestacadoStoryId = currentStory.id;

        // Cerrar menú
        const menu = document.getElementById('storyMenuDropdown');
        if (menu) menu.classList.remove('active');

        // Pausar story
        pausarTimerStory();

        // Mostrar modal
        document.getElementById('storyDestacadosOverlay').classList.add('active');

        // Cargar grupos existentes
        await cargarGruposDestacados();
    }

    function cerrarModalDestacados(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('storyDestacadosOverlay').classList.remove('active');
        document.getElementById('nuevoGrupoNombre').value = '';
        currentDestacadoStoryId = null;
        reanudarTimerStory();
    }

    async function cargarGruposDestacados() {
        const lista = document.getElementById('destacadosGruposLista');
        lista.innerHTML = '<div class="destacados-loading"><div class="spinner-small"></div><span>Cargando grupos...</span></div>';

        try {
            const response = await fetch('/Stories/ObtenerGruposDestacados');
            const data = await response.json();

            if (data.success && data.grupos && data.grupos.length > 0) {
                lista.innerHTML = data.grupos.map(grupo => `
                    <div class="destacados-grupo-item" onclick="guardarEnGrupo(${grupo.id})">
                        <img src="${grupo.imagenPortada || '/images/default-highlight.png'}"
                             alt="${grupo.nombre}"
                             class="destacados-grupo-thumb"
                             onerror="this.src='/images/default-highlight.png'">
                        <div class="destacados-grupo-info">
                            <div class="destacados-grupo-nombre">${escapeHtml(grupo.nombre)}</div>
                            <div class="destacados-grupo-count">${grupo.cantidadHistorias} ${grupo.cantidadHistorias === 1 ? 'historia' : 'historias'}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                lista.innerHTML = '<div class="destacados-loading"><span>No tienes grupos de destacados</span></div>';
            }
        } catch (error) {
            console.error('Error cargando grupos:', error);
            lista.innerHTML = '<div class="destacados-loading"><span>Error al cargar grupos</span></div>';
        }
    }

    async function crearNuevoGrupoYGuardar() {
        const nombreInput = document.getElementById('nuevoGrupoNombre');
        const nombre = nombreInput.value.trim();

        if (!nombre) {
            showToast('Escribe un nombre para el grupo');
            nombreInput.focus();
            return;
        }

        await guardarDestacado(null, nombre);
    }

    async function guardarEnGrupo(grupoId) {
        await guardarDestacado(grupoId, null);
    }

    async function guardarDestacadoSinGrupo() {
        await guardarDestacado(null, null);
    }

    async function guardarDestacado(grupoId, nuevoGrupoNombre) {
        if (!currentDestacadoStoryId) return;

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const response = await fetch('/Stories/GuardarEnDestacados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': token || ''
                },
                body: JSON.stringify({
                    storyId: currentDestacadoStoryId,
                    grupoId: grupoId,
                    nuevoGrupoNombre: nuevoGrupoNombre
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error HTTP:', response.status, errorText);
                showToast('Error al guardar en destacados');
                return;
            }

            const data = await response.json();

            if (data.success) {
                showToast('Guardado en destacados');
                cerrarModalDestacados();
            } else {
                showToast(data.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error guardando destacado:', error);
            showToast('Error al guardar en destacados');
        }
    }

    // ========================================
    // ENVIAR STORY A USUARIO ESPECÍFICO
    // ========================================
    let currentEnviarStoryId = null;
    let busquedaUsuariosTimeout = null;

    function abrirModalEnviarStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        // Guardar ID de la story
        currentEnviarStoryId = currentStory.id;

        // Cerrar menú
        const menu = document.getElementById('storyMenuDropdown');
        if (menu) menu.classList.remove('active');

        // Pausar story
        pausarTimerStory();

        // Limpiar modal
        document.getElementById('enviarStoryBusqueda').value = '';
        document.getElementById('enviarStoryMensaje').value = '';
        document.getElementById('enviarStoryUsuarios').innerHTML = '<div class="enviar-story-loading"><span>Escribe para buscar usuarios</span></div>';

        // Mostrar modal
        document.getElementById('storyEnviarOverlay').classList.add('active');

        // Focus en buscador
        setTimeout(() => document.getElementById('enviarStoryBusqueda').focus(), 100);
    }

    function cerrarModalEnviarStory(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('storyEnviarOverlay').classList.remove('active');
        currentEnviarStoryId = null;
        reanudarTimerStory();
    }

    function buscarUsuariosParaEnviar(query) {
        // Debounce
        if (busquedaUsuariosTimeout) {
            clearTimeout(busquedaUsuariosTimeout);
        }

        if (!query || query.length < 2) {
            document.getElementById('enviarStoryUsuarios').innerHTML = '<div class="enviar-story-loading"><span>Escribe al menos 2 caracteres</span></div>';
            return;
        }

        document.getElementById('enviarStoryUsuarios').innerHTML = '<div class="enviar-story-loading"><div class="spinner-small"></div></div>';

        busquedaUsuariosTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/Stories/BuscarUsuariosParaEnviar?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                const container = document.getElementById('enviarStoryUsuarios');

                if (data.success && data.usuarios && data.usuarios.length > 0) {
                    container.innerHTML = data.usuarios.map(usuario => `
                        <div class="enviar-story-usuario-item" id="enviarItem-${usuario.id}">
                            ${usuario.fotoPerfilUrl
                                ? `<img src="${usuario.fotoPerfilUrl}" alt="${escapeHtml(usuario.nombre)}" class="enviar-story-avatar" onerror="this.parentElement.innerHTML = this.parentElement.innerHTML.replace(this.outerHTML, '<div class=\\'enviar-story-avatar-placeholder\\'>${escapeHtml(usuario.nombre.charAt(0).toUpperCase())}</div>')">`
                                : `<div class="enviar-story-avatar-placeholder">${escapeHtml(usuario.nombre.charAt(0).toUpperCase())}</div>`
                            }
                            <div class="enviar-story-info">
                                <div class="enviar-story-nombre">${escapeHtml(usuario.nombre)}</div>
                                <div class="enviar-story-username">@@${escapeHtml(usuario.userName)}</div>
                            </div>
                            <button class="enviar-story-btn" onclick="enviarStoryAUsuario('${usuario.id}', this)">Enviar</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="enviar-story-loading"><span>No se encontraron usuarios</span></div>';
                }
            } catch (error) {
                console.error('Error buscando usuarios:', error);
                document.getElementById('enviarStoryUsuarios').innerHTML = '<div class="enviar-story-loading"><span>Error al buscar</span></div>';
            }
        }, 300);
    }

    async function enviarStoryAUsuario(destinatarioId, button) {
        if (!currentEnviarStoryId) return;

        const item = button.closest('.enviar-story-usuario-item');
        item.classList.add('enviando');
        button.textContent = 'Enviando...';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const mensaje = document.getElementById('enviarStoryMensaje').value.trim();

            const response = await fetch('/Stories/EnviarStory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token || ''
                },
                body: JSON.stringify({
                    storyId: currentEnviarStoryId,
                    destinatarioId: destinatarioId,
                    mensaje: mensaje || null
                })
            });

            const data = await response.json();

            if (data.success) {
                button.textContent = 'Enviado';
                button.classList.add('enviado');
                item.classList.remove('enviando');

                // Mostrar feedback
                const feedback = document.getElementById('storySendFeedback');
                if (feedback) {
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 2000);
                }
            } else {
                throw new Error(data.message || 'Error al enviar');
            }
        } catch (error) {
            console.error('Error enviando story:', error);
            item.classList.remove('enviando');
            button.textContent = 'Error';
            showToast(error.message || 'Error al enviar la historia');
            setTimeout(() => {
                button.textContent = 'Enviar';
            }, 2000);
        }
    }

    async function eliminarStoryActual() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        // Confirmar eliminación
        if (!confirm('¿Estás seguro de que quieres eliminar esta historia?')) {
            return;
        }

        // Cerrar menú
        const menu = document.getElementById('storyMenuDropdown');
        if (menu) menu.classList.remove('active');

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const formData = new FormData();
            formData.append('__RequestVerificationToken', token || '');

            const response = await fetch(`/Stories/Eliminar/${currentStory.id}`, {
                method: 'POST',
                body: formData
            });

            // Verificar si el servidor respondió correctamente
            if (!response.ok) {
                const errorText = await response.text().catch(() => '');
                console.error('[Stories] Error HTTP al eliminar:', response.status, errorText.substring(0, 200));
                showToast && showToast(`Error al eliminar (${response.status})`, 'error');
                return;
            }

            // Intentar parsear JSON
            let data;
            try {
                const text = await response.text();
                data = JSON.parse(text);
            } catch (parseError) {
                console.error('[Stories] Error parseando respuesta:', parseError);
                showToast && showToast('Error en la respuesta del servidor', 'error');
                return;
            }

            if (data.success) {
                // Eliminar del array local
                userStories.stories.splice(currentStoryIndex, 1);

                // Si no quedan más stories de este usuario
                if (userStories.stories.length === 0) {
                    // Eliminar usuario del array
                    storiesData.splice(currentUserIndex, 1);
                    // Si no hay más usuarios, cerrar visor
                    if (storiesData.length === 0) {
                        cerrarVisorStories();
                        // Actualizar la barra de stories
                        location.reload();
                        return;
                    }
                    // Ir al siguiente usuario
                    if (currentUserIndex >= storiesData.length) {
                        currentUserIndex = 0;
                    }
                    currentStoryIndex = 0;
                } else if (currentStoryIndex >= userStories.stories.length) {
                    // Si eliminamos la última, ir a la anterior
                    currentStoryIndex = userStories.stories.length - 1;
                }

                // Mostrar la siguiente story
                mostrarStory();
                showToast && showToast('Historia eliminada', 'success');
            } else {
                console.error('[Stories] Server respondió error:', data.message);
                showToast && showToast(data.message || 'Error al eliminar la historia', 'error');
            }
        } catch (error) {
            console.error('[Stories] Exception al eliminar:', error);
            showToast && showToast('Error al eliminar la historia', 'error');
        }
    }

    // Abrir mensajes directos con el creador de la story (con referencia a la historia)
    function abrirMensajesDesdeStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.creador) return;

        const creadorId = userStories.creador.id;

        // Obtener el ID de la historia actual
        const currentStory = userStories.stories[currentStoryIndex];
        const storyId = currentStory ? currentStory.id : null;

        // Cerrar visor de stories
        cerrarVisorStories();

        // Ir al chat con el creador, incluyendo referencia a la historia
        let chatUrl = `/Mensajes/Chat/${encodeURIComponent(creadorId)}`;
        if (storyId) {
            chatUrl += `?storyId=${storyId}`;
        }
        window.location.href = chatUrl;
    }

    // ========================================
    // RESPONDER STORY INLINE (Sin salir del visor)
    // ========================================

    let storyResponseInProgress = false;

    // Mostrar animación de reacción flotante
    function mostrarAnimacionReaccion(emoji) {
        // Crear contenedor de animación
        const container = document.createElement('div');
        container.className = 'story-reaction-animation';
        document.body.appendChild(container);

        // Crear múltiples emojis flotantes
        const positions = [
            { left: '35%', bottom: '25%' },
            { left: '50%', bottom: '20%' },
            { left: '65%', bottom: '25%' },
            { left: '42%', bottom: '30%' },
            { left: '58%', bottom: '28%' }
        ];

        positions.forEach((pos, i) => {
            const emojiEl = document.createElement('div');
            emojiEl.className = 'floating-emoji';
            emojiEl.textContent = emoji;
            emojiEl.style.left = pos.left;
            emojiEl.style.bottom = pos.bottom;
            emojiEl.style.transform = `translateX(-50%)`;
            container.appendChild(emojiEl);
        });

        // Remover después de la animación
        setTimeout(() => {
            container.remove();
        }, 2000);
    }

    // Enviar reacción rápida a la story
    async function enviarReaccionStory(emoji, btn) {
        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        const currentUserId = '@usuarioActual?.Id';
        if (userStories.creador.id === currentUserId) {
            return; // No puede reaccionar a su propia story
        }

        // Mostrar animación de emojis flotantes
        mostrarAnimacionReaccion(emoji);

        // Animación del botón
        if (btn) {
            btn.classList.add('sent');
            setTimeout(() => btn.classList.remove('sent'), 500);
        }

        // Pausar timer mientras se envía
        pausarTimerStory();

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const formData = new FormData();
            formData.append('__RequestVerificationToken', token || '');
            formData.append('Contenido', emoji);
            formData.append('StoryId', currentStory.id);

            const response = await fetch(`/Mensajes/EnviarMensaje/${userStories.creador.id}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                mostrarFeedbackStory(`${emoji} Enviado`, 'success');
            }
        } catch (error) {
        }

        // Reanudar timer después de un pequeño delay
        setTimeout(() => reanudarTimerStory(), 500);
    }

    async function enviarMensajeStory() {
        if (storyResponseInProgress) return;

        const input = document.getElementById('storyMessageInput');
        const mensaje = input?.value?.trim();

        if (!mensaje) return;

        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories) return;

        const currentStory = userStories.stories[currentStoryIndex];
        if (!currentStory) return;

        // No puede enviar mensaje a su propia story
        if (userStories.creador?.id === '@usuarioActual?.Id') {
            mostrarFeedbackStory('No puedes responder a tu propia historia', 'error');
            return;
        }

        storyResponseInProgress = true;
        input.disabled = true;

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const formData = new FormData();
            formData.append('storyId', currentStory.id);
            formData.append('mensaje', mensaje);
            formData.append('tipoRespuesta', 0);
            formData.append('__RequestVerificationToken', token || '');

            const response = await fetch('/Stories/ResponderStory', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                input.value = '';
                mostrarFeedbackStory('Mensaje enviado', 'success');
                input.blur();
                setTimeout(() => reanudarTimerStory(), 1500);
            } else {
                mostrarFeedbackStory(data.message || 'Error al enviar', 'error');
            }
        } catch (error) {
            mostrarFeedbackStory('Error de conexión', 'error');
        } finally {
            storyResponseInProgress = false;
            input.disabled = false;
        }
    }

    function mostrarFeedbackStory(mensaje, tipo) {
        const feedback = document.getElementById('storySendFeedback');
        if (!feedback) return;

        const icon = feedback.querySelector('.feedback-icon');
        const text = feedback.querySelector('.feedback-text');

        if (tipo === 'success') {
            icon.textContent = '✓';
            feedback.style.background = 'rgba(34, 197, 94, 0.9)';
        } else {
            icon.textContent = '✕';
            feedback.style.background = 'rgba(239, 68, 68, 0.9)';
        }

        text.textContent = mensaje;
        feedback.classList.add('show');

        setTimeout(() => {
            feedback.classList.remove('show');
        }, 2000);
    }

    // Actualizar visibilidad de controles según si es su propia story
    function actualizarControlesStory() {
        const userStories = storiesData[currentUserIndex];
        const bottomBar = document.getElementById('storyBottomBar');
        const btnEliminar = document.getElementById('btnEliminarStory');
        const btnDescargar = document.getElementById('btnDescargarStory');
        const btnSilenciar = document.getElementById('btnSilenciarHistorias');
        const btnDestacados = document.getElementById('btnGuardarDestacados');
        const viewsCounter = document.getElementById('storyViewsCounter');
        const viewsCount = document.getElementById('storyViewsCount');
        const currentUserId = '@(usuarioActual?.Id ?? "")';
        // Comparar como strings para evitar problemas de tipo
        const creadorId = String(userStories?.creador?.id || '');
        const isOwnStory = creadorId !== '' && creadorId === currentUserId;

        if (bottomBar && userStories?.creador) {
            if (isOwnStory) {
                bottomBar.classList.add('own-story');
            } else {
                bottomBar.classList.remove('own-story');
            }
        }

        // Actualizar contador de visualizaciones (solo para historia propia)
        if (viewsCounter && viewsCount && isOwnStory) {
            const story = userStories?.stories?.[currentStoryIndex];
            const vistas = story?.vistas || story?.views || 0;
            viewsCount.textContent = vistas;
        }

        // Mostrar/ocultar botón de eliminar según si es historia propia
        if (btnEliminar) {
            btnEliminar.style.display = isOwnStory ? 'flex' : 'none';
        }

        // Mostrar/ocultar botón de descargar según si es historia propia
        if (btnDescargar) {
            btnDescargar.style.display = isOwnStory ? 'flex' : 'none';
        }

        // Mostrar/ocultar botón de guardar en destacados según si es historia propia
        if (btnDestacados) {
            btnDestacados.style.display = isOwnStory ? 'flex' : 'none';
        }

        // Ocultar botón de silenciar en historias propias
        if (btnSilenciar) {
            btnSilenciar.style.display = isOwnStory ? 'none' : 'flex';
        }
    }

    // Renderizar overlays del editor visual
    function renderizarOverlays(story) {
        const container = document.getElementById('storyOverlaysContainer');
        container.innerHTML = '';

        if (!story.elementosJson) return;

        try {
            const elementos = JSON.parse(story.elementosJson);

            // Renderizar textos
            if (elementos.textos && elementos.textos.length > 0) {
                elementos.textos.forEach(texto => {
                    const el = document.createElement('div');
                    el.className = 'story-overlay-item story-overlay-text';
                    el.textContent = texto.texto;
                    el.style.left = `${texto.x}%`;
                    el.style.top = `${texto.y}%`;
                    el.style.fontSize = `${texto.fontSize || 24}px`;
                    el.style.color = texto.color || '#ffffff';
                    el.style.fontFamily = texto.fontFamily || 'Arial';
                    if (texto.backgroundColor) {
                        el.style.backgroundColor = texto.backgroundColor;
                    }
                    // Siempre incluir translate para centrar
                    let transforms = ['translate(-50%, -50%)'];
                    if (texto.rotation) {
                        transforms.push(`rotate(${texto.rotation}deg)`);
                    }
                    el.style.transform = transforms.join(' ');
                    container.appendChild(el);
                });
            }

            // Renderizar stickers/emojis
            if (elementos.stickers && elementos.stickers.length > 0) {
                elementos.stickers.forEach(sticker => {
                    const el = document.createElement('div');
                    el.className = 'story-overlay-item story-overlay-sticker';
                    el.textContent = sticker.valor;
                    el.style.left = `${sticker.x}%`;
                    el.style.top = `${sticker.y}%`;
                    // Siempre incluir translate para centrar
                    let transforms = ['translate(-50%, -50%)'];
                    if (sticker.scale) {
                        transforms.push(`scale(${sticker.scale})`);
                    }
                    if (sticker.rotation) {
                        transforms.push(`rotate(${sticker.rotation}deg)`);
                    }
                    el.style.transform = transforms.join(' ');
                    container.appendChild(el);
                });
            }

            // Renderizar menciones
            if (elementos.menciones && elementos.menciones.length > 0) {
                elementos.menciones.forEach(mencion => {
                    const el = document.createElement('div');
                    el.className = 'story-overlay-item story-overlay-mention';
                    el.textContent = '@@' + mencion.username;
                    el.style.left = mencion.x + '%';
                    el.style.top = mencion.y + '%';
                    container.appendChild(el);
                });
            }

            // Renderizar dibujos (SVG)
            if (elementos.dibujos && elementos.dibujos.length > 0) {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'story-overlay-drawing');
                // Usar dimensiones originales del canvas si están disponibles
                const viewBoxWidth = elementos.canvasWidth || 360;
                const viewBoxHeight = elementos.canvasHeight || 640;
                svg.setAttribute('viewBox', `0 0 ${viewBoxWidth} ${viewBoxHeight}`);
                svg.setAttribute('preserveAspectRatio', 'none');

                elementos.dibujos.forEach(dibujo => {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', dibujo.pathData);
                    path.setAttribute('stroke', dibujo.color || '#ffffff');
                    path.setAttribute('stroke-width', dibujo.strokeWidth || 2);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('stroke-linecap', 'round');
                    path.setAttribute('stroke-linejoin', 'round');
                    svg.appendChild(path);
                });

                container.appendChild(svg);
            }

            // Renderizar link si existe
            if (elementos.link) {
                const link = elementos.link;
                const linkEl = document.createElement('a');
                linkEl.href = link.url;
                linkEl.target = '_blank';
                linkEl.rel = 'noopener noreferrer';
                linkEl.className = 'story-overlay-item story-overlay-link';
                linkEl.textContent = link.text || 'Ver mas';
                linkEl.style.left = `${link.x}%`;
                linkEl.style.top = `${link.y}%`;
                linkEl.style.fontFamily = link.font || 'Poppins';

                // Aplicar estilo segun tipo
                const style = link.style || 'pill';
                const color = link.color || '#4682B4';

                switch (style) {
                    case 'pill':
                        linkEl.style.background = color;
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '10px 24px';
                        break;
                    case 'rounded':
                        linkEl.style.background = color;
                        linkEl.style.borderRadius = '8px';
                        linkEl.style.padding = '10px 24px';
                        break;
                    case 'square':
                        linkEl.style.background = color;
                        linkEl.style.borderRadius = '3px';
                        linkEl.style.padding = '10px 24px';
                        break;
                    case 'outline-pill':
                        linkEl.style.background = 'transparent';
                        linkEl.style.border = `2px solid ${color}`;
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '8px 22px';
                        linkEl.style.color = color;
                        break;
                    case 'outline-square':
                        linkEl.style.background = 'transparent';
                        linkEl.style.border = `2px solid ${color}`;
                        linkEl.style.borderRadius = '3px';
                        linkEl.style.padding = '8px 22px';
                        linkEl.style.color = color;
                        break;
                    case 'glass':
                        linkEl.style.background = 'rgba(255,255,255,0.2)';
                        linkEl.style.backdropFilter = 'blur(8px)';
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '10px 24px';
                        break;
                    case 'gradient':
                        linkEl.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '10px 24px';
                        break;
                    case 'swipe':
                        linkEl.style.background = 'rgba(0,0,0,0.7)';
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '10px 24px';
                        linkEl.innerHTML = '<span style="margin-right:6px;">↑</span>' + (link.text || 'Ver mas');
                        break;
                    case 'minimal':
                        linkEl.style.background = 'transparent';
                        linkEl.style.textDecoration = 'underline';
                        linkEl.style.padding = '8px 16px';
                        break;
                    default:
                        linkEl.style.background = color;
                        linkEl.style.borderRadius = '20px';
                        linkEl.style.padding = '10px 24px';
                }

                // Construir transform combinado (siempre incluye translate para centrar)
                let transforms = ['translate(-50%, -50%)'];
                if (link.rotation) {
                    transforms.push(`rotate(${link.rotation}deg)`);
                }
                if (link.scale && link.scale !== 1) {
                    transforms.push(`scale(${link.scale})`);
                }
                linkEl.style.transform = transforms.join(' ');

                container.appendChild(linkEl);
            }

        } catch (error) {
        }
    }

    // Reproducir música de la story
    function reproducirMusicaStory(story) {
        const audioEl = document.getElementById('storyMusicPlayer');
        const indicator = document.getElementById('storyMusicIndicator');

        // Detener música anterior
        audioEl.pause();
        audioEl.src = '';
        indicator.style.display = 'none';

        if (story.musica && story.musica.audioUrl) {
            audioEl.src = story.musica.audioUrl;
            audioEl.currentTime = story.musica.inicioSegundos || 0;
            audioEl.volume = (story.musica.volumen || 70) / 100;

            // Mostrar indicador
            document.getElementById('storyMusicTitle').textContent = story.musica.titulo;
            document.getElementById('storyMusicArtist').textContent = story.musica.artista;
            indicator.style.display = 'flex';

            // Reproducir
            audioEl.play().catch(err => {
            });
        }
    }

    // Actualizar barras de progreso
    function actualizarBarrasProgreso(total, actual) {
        const container = document.getElementById('storyProgressContainer');
        container.innerHTML = '';

        for (let i = 0; i < total; i++) {
            const bar = document.createElement('div');
            bar.className = 'story-progress-bar';
            if (i < actual) {
                bar.classList.add('completed');
            } else if (i === actual) {
                bar.classList.add('active');
            }
            bar.innerHTML = '<div class="story-progress-fill"></div>';
            container.appendChild(bar);
        }
    }

    // Iniciar timer para avanzar
    function iniciarTimerStory() {
        if (storyTimer) clearTimeout(storyTimer);

        // Sincronizar la animación de la barra de progreso con la duración real
        const activeBar = document.querySelector('.story-progress-bar.active .story-progress-fill');
        if (activeBar) {
            // Establecer duración dinámica (convertir ms a segundos)
            const durationSec = (storyDuration / 1000) + 's';
            activeBar.style.setProperty('--story-duration', durationSec);

            // Reiniciar animación para que comience desde 0
            activeBar.style.animation = 'none';
            activeBar.offsetHeight; // Forzar reflow
            activeBar.style.animation = '';
        }

        storyTimer = setTimeout(() => {
            storySiguiente();
        }, storyDuration);
    }

    // Pausar timer
    function pausarTimerStory() {
        if (storyTimer) clearTimeout(storyTimer);
    }

    // Reanudar timer (si no está escribiendo)
    function reanudarTimerStory() {
        const input = document.getElementById('storyMessageInput');
        // Solo reanudar si el input está vacío
        if (!input || !input.value.trim()) {
            iniciarTimerStory();
        }
    }

    // Story anterior
    function storyAnterior() {
        pausarTimerStory();
        if (currentStoryIndex > 0) {
            currentStoryIndex--;
            mostrarStory();
        } else if (currentUserIndex > 0) {
            // Ir al último story del usuario anterior
            currentUserIndex--;
            currentStoryIndex = storiesData[currentUserIndex].stories.length - 1;
            mostrarStory();
        }
    }

    // Story siguiente
    function storySiguiente() {
        pausarTimerStory();
        const userStories = storiesData[currentUserIndex];

        if (currentStoryIndex < userStories.stories.length - 1) {
            currentStoryIndex++;
            mostrarStory();
        } else {
            // Pasar al siguiente usuario
            usuarioStoriesSiguiente();
        }
    }

    // Usuario anterior
    function usuarioStoriesAnterior() {
        pausarTimerStory();
        if (currentUserIndex > 0) {
            currentUserIndex--;
            currentStoryIndex = 0;
            mostrarStory();
        }
    }

    // Usuario siguiente
    function usuarioStoriesSiguiente() {
        pausarTimerStory();
        if (currentUserIndex < storiesData.length - 1) {
            currentUserIndex++;
            currentStoryIndex = 0;
            mostrarStory();
        } else {
            // Ya no hay más usuarios
            cerrarVisorStories();
        }
    }

    // Actualizar botones de navegación entre usuarios
    function actualizarNavegacionUsuarios() {
        const prevBtn = document.getElementById('storyUserNavPrev');
        const nextBtn = document.getElementById('storyUserNavNext');

        prevBtn.style.display = currentUserIndex > 0 ? 'flex' : 'none';
        nextBtn.style.display = currentUserIndex < storiesData.length - 1 ? 'flex' : 'none';
    }

    // Cerrar visor
    function cerrarVisorStories() {
        pausarTimerStory();

        const videoEl = document.getElementById('storyViewerVideo');
        if (videoEl) {
            videoEl.pause();
            videoEl.src = '';
        }

        // Detener música
        const audioEl = document.getElementById('storyMusicPlayer');
        if (audioEl) {
            audioEl.pause();
            audioEl.src = '';
        }
        document.getElementById('storyMusicIndicator').style.display = 'none';

        // Limpiar overlays
        document.getElementById('storyOverlaysContainer').innerHTML = '';

        // Limpiar fondo blur
        const blurBg = document.getElementById('storyBlurBg');
        if (blurBg) {
            blurBg.style.backgroundImage = '';
        }

        document.getElementById('storyViewerOverlay').classList.remove('active');
        document.body.style.overflow = '';
        document.body.classList.remove('story-viewer-open');

        // Cerrar menú si está abierto
        document.getElementById('storyMenuDropdown')?.classList.remove('active');
    }

    // ========================================
    // MENÚ DE STORY VIEWER
    // ========================================

    // Toggle menú de opciones
    function toggleStoryMenu(event) {
        event.stopPropagation();
        pausarTimerStory();
        const menu = document.getElementById('storyMenuDropdown');
        menu.classList.toggle('active');

        // Si es historia propia, ocultar opción de silenciar
        const currentUser = storiesData[currentUserIndex];
        const esMiHistoria = currentUser?.creadorId === '@(usuarioActual?.Id)';
        const btnSilenciar = document.getElementById('btnSilenciarHistorias');

        if (esMiHistoria && btnSilenciar) {
            btnSilenciar.style.display = 'none';
        } else if (btnSilenciar) {
            btnSilenciar.style.display = 'flex';
            // Verificar si ya está silenciado
            verificarEstadoSilenciado(currentUser?.creadorId);
        }
    }

    // Cerrar menú al hacer click fuera
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('storyMenuDropdown');
        if (menu?.classList.contains('active') && !e.target.closest('.story-menu-btn')) {
            menu.classList.remove('active');
            reanudarTimerStory();
        }
    });

    // Verificar si el creador actual está silenciado
    async function verificarEstadoSilenciado(creadorId) {
        if (!creadorId) return;

        try {
            const res = await fetch(`/Stories/EstaSilenciado/${creadorId}`);
            const data = await res.json();

            const txtSilenciar = document.getElementById('txtSilenciarHistorias');
            if (data.silenciado) {
                txtSilenciar.textContent = 'Dejar de silenciar';
            } else {
                txtSilenciar.textContent = 'Silenciar historias';
            }
        } catch (err) {
        }
    }

    // Variable para trackear el estado de silenciado del creador actual
    let creadorActualSilenciado = false;

    // Silenciar/Desilenciar historias del creador actual
    async function silenciarHistoriasCreador() {
        const currentUser = storiesData[currentUserIndex];
        if (!currentUser?.creadorId) return;

        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        const formData = new FormData();
        formData.append('usuarioId', currentUser.creadorId);
        formData.append('__RequestVerificationToken', token);

        const txtSilenciar = document.getElementById('txtSilenciarHistorias');
        const estaSilenciado = txtSilenciar.textContent === 'Dejar de silenciar';

        const endpoint = estaSilenciado ? '/Stories/DesilenciarHistorias' : '/Stories/SilenciarHistorias';

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                showToast(data.message);

                // Cerrar menú
                document.getElementById('storyMenuDropdown').classList.remove('active');

                // Si se silenció, cerrar el visor y actualizar stories
                if (!estaSilenciado) {
                    cerrarVisorStories();
                    actualizarBarraStories();
                } else {
                    // Si se desilencia, solo actualizar texto
                    txtSilenciar.textContent = 'Silenciar historias';
                    reanudarTimerStory();
                }
            } else {
                showToast(data.message || 'Error');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
    }

    // Reportar story
    function reportarStory() {
        document.getElementById('storyMenuDropdown').classList.remove('active');
        pausarTimerStory();

        const userStories = storiesData[currentUserIndex];
        if (!userStories || !userStories.stories || !userStories.stories[currentStoryIndex]) {
            showToast('Error al obtener información de la story', 'error');
            reanudarTimerStory();
            return;
        }

        const storyActual = userStories.stories[currentStoryIndex];
        mostrarModalReportarStory(storyActual.id, userStories.creador?.nombreCompleto || 'Usuario');
    }

    // Modal para reportar story
    function mostrarModalReportarStory(storyId, creadorNombre) {
        // Crear modal si no existe
        let modal = document.getElementById('reportStoryModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'reportStoryModal';
            modal.className = 'report-modal-overlay';
            modal.innerHTML = `
                <div class="report-modal">
                    <div class="report-modal-header">
                        <h3>Reportar Story</h3>
                        <button class="report-modal-close" onclick="cerrarModalReportar()">&times;</button>
                    </div>
                    <div class="report-modal-body">
                        <p class="report-modal-info">¿Por qué reportas esta story?</p>
                        <input type="hidden" id="reportStoryId">
                        <div class="report-motivos">
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Contenido inapropiado">
                                <span>Contenido inapropiado o explícito</span>
                            </label>
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Spam o publicidad">
                                <span>Spam o publicidad engañosa</span>
                            </label>
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Acoso o bullying">
                                <span>Acoso o bullying</span>
                            </label>
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Contenido violento">
                                <span>Violencia o contenido perturbador</span>
                            </label>
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Suplantación de identidad">
                                <span>Suplantación de identidad</span>
                            </label>
                            <label class="report-motivo-option">
                                <input type="radio" name="reportMotivo" value="Otro">
                                <span>Otro motivo</span>
                            </label>
                        </div>
                        <textarea id="reportDescripcion" placeholder="Describe el problema (opcional)" maxlength="500"></textarea>
                    </div>
                    <div class="report-modal-footer">
                        <button class="report-btn-cancel" onclick="cerrarModalReportar()">Cancelar</button>
                        <button class="report-btn-submit" onclick="enviarReporteStory()">Enviar Reporte</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Agregar estilos si no existen
            if (!document.getElementById('reportModalStyles')) {
                const styles = document.createElement('style');
                styles.id = 'reportModalStyles';
                styles.textContent = `
                    .report-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 100001;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s ease;
                    }
                    .report-modal-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .report-modal {
                        background: var(--surface, #1e293b);
                        border-radius: 16px;
                        width: 90%;
                        max-width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                        transform: scale(0.9);
                        transition: transform 0.3s ease;
                    }
                    .report-modal-overlay.active .report-modal {
                        transform: scale(1);
                    }
                    .report-modal-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--line, #334155);
                    }
                    .report-modal-header h3 {
                        font-size: 18px;
                        font-weight: 600;
                        color: var(--fg, #f8fafc);
                        margin: 0;
                    }
                    .report-modal-close {
                        background: none;
                        border: none;
                        font-size: 24px;
                        color: var(--muted, #94a3b8);
                        cursor: pointer;
                        padding: 0;
                        line-height: 1;
                    }
                    .report-modal-body {
                        padding: 20px;
                    }
                    .report-modal-info {
                        color: var(--fg-secondary, #e2e8f0);
                        margin-bottom: 16px;
                        font-size: 14px;
                    }
                    .report-motivos {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        margin-bottom: 16px;
                    }
                    .report-motivo-option {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px 16px;
                        background: var(--bg-tertiary, #334155);
                        border-radius: 10px;
                        cursor: pointer;
                        transition: background 0.2s;
                    }
                    .report-motivo-option:hover {
                        background: var(--surface-hover, #475569);
                    }
                    .report-motivo-option input {
                        accent-color: var(--primary, #4682B4);
                    }
                    .report-motivo-option span {
                        color: var(--fg, #f8fafc);
                        font-size: 14px;
                    }
                    .report-modal-body textarea {
                        width: 100%;
                        min-height: 80px;
                        padding: 12px;
                        border: 1px solid var(--line, #334155);
                        border-radius: 10px;
                        background: var(--bg-tertiary, #334155);
                        color: var(--fg, #f8fafc);
                        font-size: 14px;
                        resize: vertical;
                    }
                    .report-modal-body textarea::placeholder {
                        color: var(--muted, #94a3b8);
                    }
                    .report-modal-footer {
                        display: flex;
                        gap: 12px;
                        padding: 16px 20px;
                        border-top: 1px solid var(--line, #334155);
                    }
                    .report-btn-cancel, .report-btn-submit {
                        flex: 1;
                        padding: 12px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .report-btn-cancel {
                        background: var(--bg-tertiary, #334155);
                        border: none;
                        color: var(--fg, #f8fafc);
                    }
                    .report-btn-cancel:hover {
                        background: var(--surface-hover, #475569);
                    }
                    .report-btn-submit {
                        background: #ef4444;
                        border: none;
                        color: white;
                    }
                    .report-btn-submit:hover {
                        background: #dc2626;
                    }
                    .report-btn-submit:disabled {
                        opacity: 0.6;
                        cursor: not-allowed;
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        document.getElementById('reportStoryId').value = storyId;
        document.getElementById('reportDescripcion').value = '';
        document.querySelectorAll('input[name="reportMotivo"]').forEach(r => r.checked = false);
        modal.classList.add('active');
    }

    function cerrarModalReportar() {
        const modal = document.getElementById('reportStoryModal');
        if (modal) {
            modal.classList.remove('active');
        }
        reanudarTimerStory();
    }

    async function enviarReporteStory() {
        const storyId = document.getElementById('reportStoryId').value;
        const motivoRadio = document.querySelector('input[name="reportMotivo"]:checked');
        const descripcion = document.getElementById('reportDescripcion').value.trim();

        if (!motivoRadio) {
            showToast('Selecciona un motivo para el reporte', 'warning');
            return;
        }

        const btn = document.querySelector('.report-btn-submit');
        btn.disabled = true;
        btn.textContent = 'Enviando...';

        try {
            const response = await fetch('/Reportes/ReportarStory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    storyId: parseInt(storyId),
                    motivo: motivoRadio.value,
                    descripcion: descripcion || null
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
                cerrarModalReportar();
            } else {
                showToast(data.message || 'Error al enviar el reporte', 'error');
            }
        } catch (error) {
            console.error('Error al reportar story:', error);
            showToast('Error de conexión. Intenta de nuevo.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Enviar Reporte';
        }
    }

    // Click en anuncio de story
    async function clickAnuncioStory() {
        const userStories = storiesData[currentUserIndex];
        if (!userStories?.esAnuncio) return;

        const anuncio = userStories.anuncioData;
        if (!anuncio) return;

        try {
            // Registrar clic
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const formData = new FormData();
            formData.append('anuncioId', anuncio.id);
            formData.append('__RequestVerificationToken', token);

            const res = await fetch('/Stories/RegistrarClicAnuncio', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            // Abrir URL destino
            if (data.urlDestino || anuncio.urlDestino) {
                window.open(data.urlDestino || anuncio.urlDestino, '_blank');
            }
        } catch (err) {
            // Aún así abrir el URL
            if (anuncio.urlDestino) {
                window.open(anuncio.urlDestino, '_blank');
            }
        }
    }

    // Marcar story como vista
    async function marcarStoryVista(storyId) {
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const formData = new FormData();
            formData.append('__RequestVerificationToken', token);

            await fetch(`/Stories/MarcarVisto/${storyId}`, {
                method: 'POST',
                body: formData
            });
        } catch (error) {
        }
    }

    // Cerrar con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (document.getElementById('storyViewerOverlay').classList.contains('active')) {
                cerrarVisorStories();
            }
            if (document.getElementById('createStoryModal').classList.contains('active')) {
                cerrarModalCrearStory();
            }
        }
        // Navegación con flechas
        if (document.getElementById('storyViewerOverlay').classList.contains('active')) {
            if (e.key === 'ArrowLeft') storyAnterior();
            if (e.key === 'ArrowRight') storySiguiente();
        }
    });

    // ========================================
    // CREAR STORY
    // ========================================

    // ID del usuario actual para verificar stories propias
    const currentUserId = '@(usuarioActual?.Id ?? "")';

    // Manejar click en "Tu Story"
    function manejarTuStoryClick() {
        const ring = document.getElementById('tuStoryRing');
        if (ring && ring.classList.contains('has-story')) {
            // Si tiene stories, abrir visor con sus propias stories
            abrirVisorStories(currentUserId);
        } else {
            // Si no tiene stories, abrir modal de crear
            abrirModalCrearStory();
        }
    }

    // Abrir modal
    function abrirModalCrearStory() {
        document.getElementById('createStoryModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Cerrar modal
    function cerrarModalCrearStory() {
        document.getElementById('createStoryModal').classList.remove('active');
        document.body.style.overflow = '';
        eliminarPreviewStory();
    }

    // Previsualizar archivo
    function previsualizarStory(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            storyArchivoSeleccionado = file;

            const preview = document.getElementById('createStoryPreview');
            const upload = document.getElementById('createStoryUpload');
            const imgEl = document.getElementById('storyPreviewImage');
            const videoEl = document.getElementById('storyPreviewVideo');
            const submitBtn = document.getElementById('storySubmitBtn');

            // Ocultar zona de upload
            upload.style.display = 'none';
            preview.classList.add('active');

            if (file.type.startsWith('video/')) {
                imgEl.style.display = 'none';
                videoEl.src = URL.createObjectURL(file);
                videoEl.style.display = 'block';
                videoEl.play();
            } else {
                videoEl.style.display = 'none';
                imgEl.src = URL.createObjectURL(file);
                imgEl.style.display = 'block';
            }

            submitBtn.disabled = false;
        }
    }

    // Eliminar preview
    function eliminarPreviewStory() {
        storyArchivoSeleccionado = null;

        const preview = document.getElementById('createStoryPreview');
        const upload = document.getElementById('createStoryUpload');
        const imgEl = document.getElementById('storyPreviewImage');
        const videoEl = document.getElementById('storyPreviewVideo');
        const submitBtn = document.getElementById('storySubmitBtn');
        const fileInput = document.getElementById('storyFileInput');
        const textoInput = document.getElementById('storyTexto');

        preview.classList.remove('active');
        upload.style.display = 'block';

        imgEl.src = '';
        imgEl.style.display = 'none';
        videoEl.src = '';
        videoEl.style.display = 'none';

        fileInput.value = '';
        textoInput.value = '';
        submitBtn.disabled = true;
    }

    // Crear story
    async function crearStory() {
        if (!storyArchivoSeleccionado) {
            showToast('Selecciona una foto o video');
            return;
        }

        const submitBtn = document.getElementById('storySubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Publicando...';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const formData = new FormData();
            formData.append('archivo', storyArchivoSeleccionado);
            formData.append('__RequestVerificationToken', token);

            const texto = document.getElementById('storyTexto').value;
            if (texto) {
                formData.append('texto', texto);
            }

            // Obtener tipoLado: puede ser radio button (creador verificado) o hidden input (usuario normal)
            const tipoLadoChecked = document.querySelector('input[name="storyTipoLado"]:checked');
            const tipoLadoHidden = document.querySelector('input[name="storyTipoLado"][type="hidden"]');
            const tipoLado = tipoLadoChecked?.value || tipoLadoHidden?.value || 'LadoA';
            formData.append('tipoLado', tipoLado);

            const response = await fetch('/Stories/Crear', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': token
                },
                body: formData
            });

            // Debug: si hay error HTTP
            if (!response.ok) {
                console.error('Story error HTTP:', response.status, response.statusText);
                const errorText = await response.text();
                console.error('Story error body:', errorText);
                showToast(`Error ${response.status}: ${response.statusText}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Compartir historia';
                return;
            }

            const data = await response.json();

            if (data.success) {
                showToast('Historia publicada');
                cerrarModalCrearStory();
                // Actualizar la barra de stories
                actualizarBarraStories();
            } else {
                console.error('Story error del servidor:', data.message);
                showToast(data.message || 'Error al publicar');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Compartir historia';
            }
        } catch (error) {
            console.error('Story error excepción:', error);
            showToast('Error al publicar la historia: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Compartir historia';
        }
    }

    // Abrir editor avanzado (pasando archivo si existe)
    async function abrirEditorAvanzado() {
        // Si hay un archivo seleccionado, guardarlo en sessionStorage para el editor
        if (storyArchivoSeleccionado) {
            try {
                // Mostrar loading
                showToast('Preparando editor...');

                // Convertir archivo a base64
                const base64 = await fileToBase64(storyArchivoSeleccionado);

                // Guardar en sessionStorage
                sessionStorage.setItem('editorPendingFile', JSON.stringify({
                    data: base64,
                    type: storyArchivoSeleccionado.type,
                    name: storyArchivoSeleccionado.name
                }));

                // Cerrar modal y navegar al editor
                cerrarModalCrearStory();
                window.location.href = '/Stories/Editor?fromPopup=true';
            } catch (error) {
                console.error('Error preparando archivo para editor:', error);
                showToast('Error al preparar archivo');
                // Navegar al editor sin archivo
                window.location.href = '/Stories/Editor';
            }
        } else {
            // No hay archivo, ir directo al editor
            window.location.href = '/Stories/Editor';
        }
    }

    // Convertir File a base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Actualizar barra de stories
    async function actualizarBarraStories() {
        try {
            const response = await fetch('/Stories/Obtener');
            const data = await response.json();

            if (data.success && data.stories) {
                const scrollContainer = document.querySelector('.stories-scroll');
                if (!scrollContainer) return;

                // Mantener "Tu Story" y reconstruir el resto
                const tuStory = scrollContainer.querySelector('.story-item:first-child');

                // Limpiar todo excepto "Tu Story"
                scrollContainer.innerHTML = '';
                if (tuStory) {
                    scrollContainer.appendChild(tuStory);
                }

                // Agregar stories
                data.stories.forEach(group => {
                    // Saltar stories propias (ya están en "Tu Story")
                    if (group.creadorId === currentUserId) {
                        // Actualizar "Tu Story" para mostrar que tiene stories
                        const yourStoryRing = tuStory?.querySelector('.story-ring');
                        if (yourStoryRing) {
                            yourStoryRing.classList.add('has-story');
                        }
                        return;
                    }

                    const item = document.createElement('div');
                    item.className = 'story-item';
                    item.onclick = () => abrirVisorStories(group.creadorId);

                    const ringClass = group.tieneStorysSinVer ? '' : 'seen';
                    const avatarHtml = group.creador.avatar
                        ? `<img src="${group.creador.avatar}" alt="" class="story-avatar">`
                        : `<div class="story-avatar-placeholder">${group.creador.nombre?.charAt(0)?.toUpperCase() || '?'}</div>`;

                    item.innerHTML = `
                        <div class="story-ring ${ringClass}">
                            <div class="story-ring-inner">
                                ${avatarHtml}
                            </div>
                        </div>
                        <span class="story-username">${group.creador.nombre.split(' ')[0]}</span>
                    `;

                    scrollContainer.appendChild(item);
                });
            }
        } catch (error) {
        }
    }

    // Cargar stories al iniciar (diferido para priorizar feed)
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            actualizarBarraStories();
            initStoriesDragScroll();
        }, 1500); // Diferir 1.5s - stories no son críticas
    });

    // Drag to scroll horizontal para stories (version segura)
    function initStoriesDragScroll() {
        const slider = document.querySelector('.stories-scroll');
        if (!slider) return;

        let isDown = false;
        let startX;
        let scrollLeft;
        let didDrag = false;

        slider.addEventListener('mousedown', (e) => {
            // Solo activar con boton izquierdo
            if (e.button !== 0) return;

            isDown = true;
            didDrag = false;
            startX = e.pageX;
            scrollLeft = slider.scrollLeft;
            slider.classList.add('is-dragging');
        });

        document.addEventListener('mouseup', () => {
            if (!isDown) return;
            isDown = false;
            slider.classList.remove('is-dragging');

            // Resetear didDrag despues de un momento para permitir clicks
            if (didDrag) {
                setTimeout(() => { didDrag = false; }, 10);
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDown) return;

            const x = e.pageX;
            const walk = x - startX;

            // Solo considerar drag si movio mas de 5px
            if (Math.abs(walk) > 5) {
                didDrag = true;
                slider.scrollLeft = scrollLeft - walk;
            }
        });

        // Interceptar clicks en story-items si hubo drag
        slider.addEventListener('click', (e) => {
            if (didDrag) {
                e.stopPropagation();
                e.preventDefault();
            }
        }, true);
    }
</script>

<!-- Modal: No tienes acceso al post compartido -->
@if (ViewBag.SharedPostNoAccess != null) {
    var noAccess = ViewBag.SharedPostNoAccess;
    <div class="modal-overlay" id="sharedPostNoAccessModal">
        <div class="share-modal" style="max-width: 380px; text-align: center;">
            <div class="share-modal-header">
                Contenido exclusivo
                <button class="share-modal-close" onclick="document.getElementById('sharedPostNoAccessModal').classList.remove('active')">&times;</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    @if (!string.IsNullOrEmpty((string)noAccess.CreadorFoto)) {
                        <img src="@noAccess.CreadorFoto" alt="" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
                    } else {
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); display: inline-flex; align-items: center; justify-content: center; font-size: 2rem; color: white;">
                            @(((string)noAccess.CreadorNombre)?.Substring(0, 1).ToUpper() ?? "?")
                        </div>
                    }
                </div>
                <h3 style="margin-bottom: 8px; font-size: 1.1rem;">@noAccess.CreadorNombre</h3>
                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">
                    @if ((string)noAccess.TipoLado == "LadoB") {
                        <text>Este contenido es exclusivo para suscriptores de Lado B</text>
                    } else {
                        <text>Sigue a este creador para ver su contenido</text>
                    }
                </p>
                <a href="/Feed/Perfil/@noAccess.CreadorUsername" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; text-decoration: none;">
                    <i class="fas fa-user-plus"></i>
                    Ver perfil
                </a>
                @if (noAccess.Precio != null && (decimal)noAccess.Precio > 0) {
                    <p style="margin-top: 12px; font-size: 0.8rem; color: var(--muted);">
                        Desde $@(((decimal)noAccess.Precio).ToString("N0"))/mes
                    </p>
                }
            </div>
        </div>
    </div>
}

