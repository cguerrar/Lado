@model IEnumerable<Lado.Models.Contenido>
@{
    ViewData["Title"] = "Feed";
}

@Html.AntiForgeryToken()

<style>
    :root {
        --primary: #32d67b;
        --primary-dark: #16a34a;
        --primary-light: #e6f9ee;
        --bg: #fafafa;
        --card-bg: #ffffff;
        --fg: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --hover: #f3f4f6;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* ========================================
       LAYOUT PRINCIPAL
       ======================================== */
    .feed-layout {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 630px) 320px;
        gap: 32px;
        padding: 24px 20px 40px;
    }

    .feed-main {
        min-width: 0;
    }

    .feed-sidebar {
        position: sticky;
        top: 80px;
        height: fit-content;
    }

    /* ========================================
       STORIES - Estilo Instagram
       ======================================== */
    .stories-wrapper {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px 0;
        margin-bottom: 24px;
    }

    .stories-container {
        padding: 0 16px;
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .stories-container::-webkit-scrollbar {
        display: none;
    }

    .stories-list {
        display: flex;
        gap: 16px;
        padding-bottom: 4px;
    }

    .story-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .story-ring {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        padding: 2px;
        background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .story-item:hover .story-ring {
        transform: scale(1.05);
    }

    .story-ring.visto {
        background: var(--border);
    }

    .story-ring-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--card-bg);
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .story-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .story-avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
    }

    .story-username {
        font-size: 12px;
        color: var(--fg);
        max-width: 64px;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* ========================================
       POST CARD - Estilo Instagram
       ======================================== */
    .post-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    /* Header del Post */
    .post-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
    }

    .post-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        flex: 1;
        min-width: 0;
    }

    .post-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .post-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .post-user-details {
        flex: 1;
        min-width: 0;
    }

    .post-user-details h6 {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        margin: 0;
        line-height: 1.2;
    }

    .post-user-details small {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.2;
    }

    .post-menu-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--fg);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .post-menu-btn:hover {
        background: var(--hover);
    }

    /* Media del Post */
    .post-media {
        position: relative;
        background: #000;
        width: 100%;
        max-height: 600px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .post-media img,
    .post-media video {
        width: 100%;
        max-height: 600px;
        object-fit: contain;
        display: block;
    }

    /* Premium Overlay */
    .premium-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 20px;
        text-align: center;
    }

    .premium-lock-icon {
        width: 72px;
        height: 72px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 8px 32px rgba(50, 214, 123, 0.4);
    }

    .premium-lock-icon svg {
        width: 32px;
        height: 32px;
    }

    .premium-overlay h4 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px 0;
    }

    .premium-overlay p {
        font-size: 14px;
        opacity: 0.9;
        margin: 0 0 20px 0;
    }

    .unlock-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .unlock-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Acciones del Post */
    .post-actions {
        padding: 8px 16px;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 4px 0 8px;
    }

    .action-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--fg);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.15s;
    }

    .action-btn:hover {
        transform: scale(1.1);
    }

    .action-btn svg {
        width: 24px;
        height: 24px;
    }

    .action-btn-right {
        margin-left: auto;
    }

    /* Botón de Like */
    .like-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--fg);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.15s;
    }

    .like-btn:hover {
        transform: scale(1.1);
    }

    .like-btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        transition: all 0.2s;
    }

    .like-btn.liked {
        color: #ed4956;
    }

    .like-btn.liked svg {
        fill: #ed4956;
        stroke: #ed4956;
    }

    /* Likes y Reacciones */
    .post-likes {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reacciones-mini {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        font-size: 16px;
    }

    .reacciones-mini span {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    /* Descripción */
    .post-caption {
        font-size: 14px;
        line-height: 1.5;
        color: var(--fg);
        margin-bottom: 8px;
    }

    .post-caption .username {
        font-weight: 600;
        margin-right: 6px;
    }

    /* Comentarios */
    .post-comments {
        margin-bottom: 8px;
    }

    .view-comments {
        color: var(--muted);
        font-size: 14px;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        text-align: left;
        transition: color 0.2s;
    }

    .view-comments:hover {
        color: var(--fg);
    }

    .post-timestamp {
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.2px;
        margin-bottom: 12px;
    }

    /* Input de Comentario */
    .add-comment {
        border-top: 1px solid var(--border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        background: transparent;
        color: var(--fg);
    }

    .comment-input::placeholder {
        color: var(--muted);
    }

    .post-comment-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        padding: 0;
        transition: color 0.2s;
    }

    .post-comment-btn:hover:not(:disabled) {
        color: var(--primary-dark);
    }

    .post-comment-btn:disabled {
        opacity: 0.3;
        cursor: default;
    }

    /* ========================================
       SIDEBAR
       ======================================== */
    .suggestions-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
    }

    .suggestions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .suggestions-header h5 {
        font-size: 14px;
        font-weight: 600;
        color: var(--muted);
        margin: 0;
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .suggestion-item:last-child {
        margin-bottom: 0;
    }

    .suggestion-link {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        text-decoration: none;
        min-width: 0;
    }

    .suggestion-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .suggestion-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .suggestion-info {
        flex: 1;
        min-width: 0;
    }

    .suggestion-info h6 {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        margin: 0 0 2px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .suggestion-info p {
        font-size: 12px;
        color: var(--muted);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn-follow {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        white-space: nowrap;
    }

    .btn-follow:hover {
        color: var(--primary-dark);
    }

    /* ========================================
       MODAL DE REACCIONES
       ======================================== */
    .modal-reacciones-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9998;
        animation: fadeIn 0.2s;
    }

    .modal-reacciones {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        z-index: 9999;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
        animation: slideUp 0.3s;
    }

    .modal-reacciones h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        margin: 0 0 20px 0;
        text-align: center;
    }

    .reacciones-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .reaccion-btn {
        background: var(--hover);
        border: none;
        border-radius: 8px;
        padding: 16px 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .reaccion-btn:hover {
        transform: scale(1.05);
        background: var(--border);
    }

    .reaccion-btn .emoji {
        font-size: 32px;
    }

    .reaccion-btn span:not(.emoji) {
        font-size: 11px;
        font-weight: 600;
        color: var(--fg);
    }

    .btn-cancelar-reaccion {
        width: 100%;
        background: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-cancelar-reaccion:hover {
        background: var(--hover);
    }

    /* ========================================
       EMPTY STATE
       ======================================== */
    .empty-feed {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 60px 20px;
        text-align: center;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-icon svg {
        width: 40px;
        height: 40px;
        stroke: white;
    }

    .empty-feed h3 {
        font-size: 20px;
        font-weight: 700;
        color: var(--fg);
        margin: 0 0 8px 0;
    }

    .empty-feed p {
        font-size: 14px;
        color: var(--muted);
        margin: 0 0 24px 0;
        line-height: 1.5;
    }

    .explore-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .explore-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        color: white;
    }

    /* ========================================
       ANIMACIONES DE REACCIONES FLOTANTES
       ======================================== */
    .reaction-float {
        position: absolute;
        font-size: 48px;
        pointer-events: none;
        z-index: 100;
        animation: floatUp 2s ease-out forwards;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    @@keyframes floatUp {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0);
        }
        10% {
            transform: translateY(-10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translateY(-80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translateY(-150px) scale(0.8) rotate(10deg);
        }
    }

    .reaction-float.variant-1 {
        animation-duration: 1.8s;
    }

    .reaction-float.variant-2 {
        animation-duration: 2.2s;
    }

    .reaction-float.left {
        animation-name: floatUpLeft;
    }

    .reaction-float.right {
        animation-name: floatUpRight;
    }

    @@keyframes floatUpLeft {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(0);
        }
        10% {
            transform: translate(-5px, -10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translate(-40px, -80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(-60px, -150px) scale(0.8) rotate(-15deg);
        }
    }

    @@keyframes floatUpRight {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(0);
        }
        10% {
            transform: translate(5px, -10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translate(40px, -80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(60px, -150px) scale(0.8) rotate(15deg);
        }
    }

    /* ========================================
       ANIMACIONES GENERALES
       ======================================== */
    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            transform: translate(-50%, -40%);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -50%);
            opacity: 1;
        }
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.3);
        }
        100% {
            transform: scale(1);
        }
    }

    @@keyframes heartPop {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.3);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
        }
    }

    @@media (max-width: 1024px) {
        .feed-layout {
            grid-template-columns: 1fr;
            gap: 0;
            padding: 0;
        }

        .feed-sidebar {
            display: none;
        }

        .feed-main {
            max-width: 630px;
            margin: 0 auto;
        }

        .stories-wrapper,
        .post-card {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        .post-card {
            margin-bottom: 12px;
        }
    }

    @@media (max-width: 640px) {
        .feed-layout {
            padding: 0;
        }

        .stories-wrapper {
            margin-bottom: 12px;
        }

        .post-header {
            padding: 12px;
        }

        .post-actions {
            padding: 8px 12px;
        }

        .add-comment {
            padding: 12px;
        }

        .reacciones-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<div class="feed-layout">
    <!-- MAIN FEED -->
    <div class="feed-main">
        <!-- Stories -->
        @{
            var stories = ViewBag.Stories as IEnumerable<dynamic>;
        }
        @if (stories != null && stories.Any())
        {
            <div class="stories-wrapper">
                <div class="stories-container">
                    <div class="stories-list">
                        @foreach (var storyGroup in stories)
                        {
                            <div class="story-item" onclick="abrirStory('@storyGroup.CreadorId')">
                                <div class="story-ring @(storyGroup.TieneStorysSinVer ? "" : "visto")">
                                    <div class="story-ring-inner">
                                        @if (!string.IsNullOrEmpty(storyGroup.Creador.FotoPerfil))
                                        {
                                            <img src="@storyGroup.Creador.FotoPerfil" alt="@storyGroup.Creador.NombreCompleto" class="story-avatar">
                                        }
                                        else
                                        {
                                            <div class="story-avatar-placeholder">
                                                @storyGroup.Creador.NombreCompleto.Substring(0, 1)
                                            </div>
                                        }
                                    </div>
                                </div>
                                <span class="story-username">@storyGroup.Creador.NombreCompleto.Split(' ')[0]</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Posts -->
        @if (Model.Any())
        {
            @foreach (var contenido in Model)
            {
                <div class="post-card" data-content-id="@contenido.Id">
                    <!-- Header -->
                    <div class="post-header">
                        <a href="/Feed/Perfil/@contenido.UsuarioId" class="post-user-info">
                            <div class="post-avatar">
                                @if (!string.IsNullOrEmpty(contenido.Usuario?.FotoPerfil))
                                {
                                    <img src="@contenido.Usuario.FotoPerfil" alt="@contenido.Usuario.NombreCompleto">
                                }
                                else
                                {
                                    <div class="avatar-placeholder">
                                        @(contenido.Usuario?.NombreCompleto?.Substring(0, 1) ?? "U")
                                    </div>
                                }
                            </div>
                            <div class="post-user-details">
                                <h6>@(contenido.Usuario?.NombreCompleto ?? "Usuario")</h6>
                                <small>
                                    @{
                                        var tiempo = DateTime.Now - contenido.FechaPublicacion;
                                        var tiempoTexto = tiempo.TotalDays >= 1 ? $"{(int)tiempo.TotalDays}d" :
                                        tiempo.TotalHours >= 1 ? $"{(int)tiempo.TotalHours}h" : $"{(int)tiempo.TotalMinutes}m";
                                    }
                                    @tiempoTexto
                                </small>
                            </div>
                        </a>
                        <button class="post-menu-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="1.5" />
                                <circle cx="6" cy="12" r="1.5" />
                                <circle cx="18" cy="12" r="1.5" />
                            </svg>
                        </button>
                    </div>

                    <!-- Media -->
                    <div class="post-media">
                        @if (contenido.EsPremium && !(ViewBag.EstaSuscrito ?? true))
                        {
                            @if ((int)contenido.TipoContenido == 1)
                            {
                                <video src="@contenido.RutaArchivo" style="filter: blur(20px);" playsinline muted></video>
                            }
                            else
                            {
                                <img src="@(contenido.RutaArchivo ?? "/images/placeholder.jpg")" alt="Premium" style="filter: blur(20px);">
                            }
                            <div class="premium-overlay">
                                <div class="premium-lock-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                    </svg>
                                </div>
                                <h4>Contenido Premium</h4>
                                <p>Suscríbete para desbloquear</p>
                                <button class="unlock-btn" onclick="window.location.href='/Feed/Perfil/@contenido.UsuarioId'">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                    </svg>
                                    Suscribirse
                                </button>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(contenido.RutaArchivo))
                        {
                            @if ((int)contenido.TipoContenido == 0)
                            {
                                <img src="@contenido.RutaArchivo" alt="Post">
                            }
                            else if ((int)contenido.TipoContenido == 1)
                            {
                                <video src="@contenido.RutaArchivo" controls></video>
                            }
                        }
                    </div>

                    <!-- Actions -->
                    <div class="post-actions">
                        <div class="action-buttons">
                            <button class="action-btn like-btn" data-id="@contenido.Id">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                                </svg>
                            </button>

                            <button class="action-btn" onclick="window.location.href='/Feed/Detalle/@contenido.Id'">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                </svg>
                            </button>

                            <button class="action-btn share-btn" data-id="@contenido.Id" data-username="@contenido.Usuario?.UserName">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13" />
                                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                                </svg>
                            </button>

                            <button class="action-btn action-btn-right react-btn" onclick="mostrarReacciones(@contenido.Id)">
                                <span style="font-size: 20px;">😊</span>
                            </button>
                        </div>

                        <!-- Likes y Reacciones -->
                        @{
                            var reaccionesDict = ViewBag.ReaccionesPorContenido as IDictionary<int, dynamic>;
                            var reaccionesContenido = reaccionesDict != null && reaccionesDict.ContainsKey(contenido.Id)
                            ? reaccionesDict[contenido.Id]
                            : null;
                            var totalReacciones = reaccionesContenido?.TotalReacciones ?? 0;

                            var totalDisplay = contenido.NumeroLikes;
                            if (totalReacciones > 0)
                            {
                                totalDisplay = totalReacciones;
                            }
                        }

                        @if (totalDisplay > 0 || totalReacciones > 0)
                        {
                            <div class="post-likes" id="likes-container-@contenido.Id">
                                @if (totalReacciones > 0)
                                {
                                    <div class="reacciones-mini" id="reacciones-mini-@contenido.Id">
                                        <span>❤️</span>
                                        <span>🔥</span>
                                        <span>😍</span>
                                    </div>
                                    <span class="like-count" data-content-id="@contenido.Id">@totalReacciones</span>
                                    <span>reacciones</span>
                                }
                                else
                                {
                                    <span class="like-count" data-content-id="@contenido.Id">@contenido.NumeroLikes</span>
                                    <span>Me gusta</span>
                                }
                            </div>
                        }

                        <!-- Caption -->
                        @if (!string.IsNullOrEmpty(contenido.Descripcion))
                        {
                            <div class="post-caption">
                                <span class="username">@(contenido.Usuario?.NombreCompleto ?? "Usuario")</span>
                                @contenido.Descripcion
                            </div>
                        }

                        <!-- Comments -->
                        @if (contenido.NumeroComentarios > 0)
                        {
                            <div class="post-comments">
                                <button class="view-comments" onclick="window.location.href='/Feed/Detalle/@contenido.Id'">
                                    Ver los <span class="comment-count-display" data-content-id="@contenido.Id">@contenido.NumeroComentarios</span> comentarios
                                </button>
                            </div>
                        }

                        <!-- Timestamp -->
                        <div class="post-timestamp">
                            Hace @tiempoTexto
                        </div>
                    </div>

                    <!-- Add Comment -->
                    <div class="add-comment">
                        <input type="text" class="comment-input" placeholder="Añade un comentario..." data-content-id="@contenido.Id">
                        <button class="post-comment-btn" disabled data-content-id="@contenido.Id">Publicar</button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-feed">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 11a9 9 0 0 1 9 9" />
                        <path d="M4 4a16 16 0 0 1 16 16" />
                        <circle cx="5" cy="19" r="1" />
                    </svg>
                </div>
                <h3>Tu feed está vacío</h3>
                <p>Descubre contenido increíble suscribiéndote a tus creadores favoritos</p>
                <a href="/Feed/Explorar" class="explore-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                    </svg>
                    Explorar Creadores
                </a>
            </div>
        }
    </div>

    <!-- SIDEBAR -->
    <div class="feed-sidebar">
        <div class="suggestions-card">
            <div class="suggestions-header">
                <h5>Sugerencias para ti</h5>
            </div>

            @if (ViewBag.CreadoresSugeridos != null && ((List<Lado.Models.ApplicationUser>)ViewBag.CreadoresSugeridos).Any())
            {
                @foreach (var creador in (List<Lado.Models.ApplicationUser>)ViewBag.CreadoresSugeridos)
                {
                    <div class="suggestion-item">
                        <a href="/Feed/Perfil/@creador.Id" class="suggestion-link">
                            <div class="suggestion-avatar">
                                @if (!string.IsNullOrEmpty(creador.FotoPerfil))
                                {
                                    <img src="@creador.FotoPerfil" alt="@creador.NombreCompleto">
                                }
                                else
                                {
                                    <div class="avatar-placeholder">
                                        @creador.NombreCompleto.Substring(0, 1)
                                    </div>
                                }
                            </div>
                            <div class="suggestion-info">
                                <h6>@creador.NombreCompleto</h6>
                                <p>@@@creador.UserName</p>
                            </div>
                        </a>
                        <button class="btn-follow" onclick="window.location.href='/Feed/Perfil/@creador.Id'">Seguir</button>
                    </div>
                }
            }
        </div>
    </div>
</div>

<!-- Modal de Reacciones -->
<div class="modal-reacciones-overlay" id="reaccionesOverlay" onclick="cerrarReacciones()"></div>
<div class="modal-reacciones" id="reaccionesModal">
    <h3>Reacciona a este contenido</h3>
    <div class="reacciones-grid">
        <button class="reaccion-btn" onclick="enviarReaccion('fire')">
            <span class="emoji">🔥</span>
            <span>Fuego</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('heart')">
            <span class="emoji">❤️</span>
            <span>Me encanta</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('wow')">
            <span class="emoji">😍</span>
            <span>Wow</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('clap')">
            <span class="emoji">👏</span>
            <span>Aplauso</span>
        </button>
    </div>
    <button class="btn-cancelar-reaccion" onclick="cerrarReacciones()">Cancelar</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🎬 Feed Instagram-style iniciado');

        let contenidoSeleccionado = null;

        // ========================================
        // CARGAR ESTADO DE LIKES
        // ========================================
        cargarEstadoLikes();

        async function cargarEstadoLikes() {
            const contenidos = document.querySelectorAll('.post-card[data-content-id]');
            const contentIds = Array.from(contenidos).map(c => c.dataset.contentId);

            if (contentIds.length === 0) return;

            try {
                const response = await fetch('/Feed/ObtenerMisLikes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ contenidoIds: contentIds })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.likesUsuario) {
                        data.likesUsuario.forEach(contenidoId => {
                            const likeBtn = document.querySelector(`.like-btn[data-id="${contenidoId}"]`);
                            if (likeBtn) likeBtn.classList.add('liked');
                        });
                    }
                }
            } catch (error) {
                console.error('❌ Error al cargar estado de likes:', error);
            }
        }

        // ========================================
        // LIKES
        // ========================================
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const contentId = this.dataset.id;
                const wasLiked = this.classList.contains('liked');

                try {
                    const response = await fetch(`/Contenido/Like/${contentId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.success) {
                            if (data.liked) {
                                this.classList.add('liked');
                            } else {
                                this.classList.remove('liked');
                            }

                            actualizarContadorLikes(contentId, data.likes);

                            this.style.transform = 'scale(1.2)';
                            setTimeout(() => { this.style.transform = ''; }, 200);
                        }
                    }
                } catch (error) {
                    console.error('❌ Error al dar like:', error);
                }
            });
        });

        function actualizarContadorLikes(contentId, totalLikes) {
            let likesContainer = document.getElementById(`likes-container-${contentId}`);
            const hayReaccionesMini = likesContainer?.querySelector('.reacciones-mini');

            if (hayReaccionesMini) return;

            if (totalLikes > 0) {
                if (!likesContainer) {
                    const actionsDiv = document.querySelector(`[data-content-id="${contentId}"] .post-actions`);
                    likesContainer = document.createElement('div');
                    likesContainer.className = 'post-likes';
                    likesContainer.id = `likes-container-${contentId}`;

                    const actionButtons = actionsDiv.querySelector('.action-buttons');
                    actionButtons.after(likesContainer);
                }

                likesContainer.innerHTML = `
                    <span class="like-count" data-content-id="${contentId}">${totalLikes}</span>
                    <span>Me gusta</span>
                `;
            } else if (likesContainer && !hayReaccionesMini) {
                likesContainer.remove();
            }
        }

        // ========================================
        // STORIES
        // ========================================
        window.abrirStory = function (creadorId) {
            console.log('📖 Abrir stories:', creadorId);
            window.location.href = `/Feed/Perfil/${creadorId}`;
        };

        // ========================================
        // REACCIONES
        // ========================================
        window.mostrarReacciones = function (contenidoId) {
            contenidoSeleccionado = contenidoId;
            document.getElementById('reaccionesOverlay').style.display = 'block';
            document.getElementById('reaccionesModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            console.log('🎭 Modal de reacciones abierto para contenido:', contenidoId);
        };

        window.cerrarReacciones = function () {
            document.getElementById('reaccionesOverlay').style.display = 'none';
            document.getElementById('reaccionesModal').style.display = 'none';
            document.body.style.overflow = '';
            contenidoSeleccionado = null;
            console.log('✖️ Modal de reacciones cerrado');
        };

        window.enviarReaccion = async function (tipo) {
            if (!contenidoSeleccionado) {
                console.warn('⚠️ No hay contenido seleccionado');
                return;
            }

            console.log('📤 Enviando reacción:', tipo, 'para contenido:', contenidoSeleccionado);

            try {
                const formData = new FormData();
                formData.append('contenidoId', contenidoSeleccionado);
                formData.append('tipo', tipo);

                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Reacciones/Reaccionar', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('📥 Respuesta reacción:', data);

                if (data.success && data.reacciones) {
                    actualizarVisualizacionReacciones(contenidoSeleccionado, data.reacciones, data.totalReacciones);

                    const emojiMap = {
                        'fire': '🔥',
                        'heart': '❤️',
                        'wow': '😍',
                        'clap': '👏'
                    };
                    const emoji = emojiMap[tipo] || '😊';
                    crearAnimacionReaccion(contenidoSeleccionado, emoji);

                    const reactBtn = document.querySelector(`[data-content-id="${contenidoSeleccionado}"] .react-btn`);
                    if (reactBtn) {
                        reactBtn.style.animation = 'pulse 0.4s ease';
                        setTimeout(() => {
                            reactBtn.style.animation = '';
                        }, 400);
                    }

                    mostrarNotificacion('¡Reacción enviada!', 'success');
                    cerrarReacciones();
                } else {
                    console.error('❌ Error en respuesta:', data.message);
                    mostrarNotificacion(data.message || 'Error al reaccionar', 'error');
                }
            } catch (error) {
                console.error('❌ Error al enviar reacción:', error);
                mostrarNotificacion('Error al enviar reacción', 'error');
            }
        };

        function actualizarVisualizacionReacciones(contenidoId, reacciones, totalReacciones) {
            console.log('🎨 Actualizando visualización para contenido:', contenidoId);
            console.log('📊 Reacciones recibidas:', reacciones);
            console.log('📈 Total reacciones:', totalReacciones);

            let likesContainer = document.getElementById(`likes-container-${contenidoId}`);

            if (totalReacciones > 0 && reacciones && reacciones.length > 0) {
                if (!likesContainer) {
                    const actionsDiv = document.querySelector(`[data-content-id="${contenidoId}"] .post-actions`);
                    if (!actionsDiv) {
                        console.error('❌ No se encontró .post-actions para contenido:', contenidoId);
                        return;
                    }

                    likesContainer = document.createElement('div');
                    likesContainer.className = 'post-likes';
                    likesContainer.id = `likes-container-${contenidoId}`;

                    const actionButtons = actionsDiv.querySelector('.action-buttons');
                    if (actionButtons) {
                        actionButtons.after(likesContainer);
                        console.log('✅ Contenedor de likes creado');
                    }
                }

                const emojiMap = {
                    'fire': '🔥',
                    'heart': '❤️',
                    'wow': '😍',
                    'clap': '👏'
                };

                let html = '<div class="reacciones-mini">';

                reacciones.forEach((r, index) => {
                    const tipoNormalizado = r.tipo ? r.tipo.toLowerCase() : '';
                    const emoji = emojiMap[tipoNormalizado] || '❓';
                    html += `<span title="${r.count} ${tipoNormalizado}">${emoji}</span>`;
                });

                html += '</div>';
                html += `<span class="like-count" data-content-id="${contenidoId}">${totalReacciones}</span>`;
                html += `<span>reacciones</span>`;

                likesContainer.innerHTML = html;
            }
        }

        // ========================================
        // DOBLE CLICK EN IMAGEN (estilo Instagram)
        // ========================================
        document.querySelectorAll('.post-media').forEach(media => {
            let lastTap = 0;

            media.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;

                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    handleDoubleTap(this);
                }
                lastTap = currentTime;
            });

            media.addEventListener('dblclick', function(e) {
                e.preventDefault();
                handleDoubleTap(this);
            });
        });

        function handleDoubleTap(mediaElement) {
            const postCard = mediaElement.closest('.post-card');
            if (!postCard) return;

            const contentId = postCard.dataset.contentId;

            const bigHeart = document.createElement('div');
            bigHeart.innerHTML = '❤️';
            bigHeart.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                font-size: 120px;
                pointer-events: none;
                z-index: 200;
                animation: heartPop 0.8s ease-out;
                filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
            `;

            if (getComputedStyle(mediaElement).position === 'static') {
                mediaElement.style.position = 'relative';
            }

            mediaElement.appendChild(bigHeart);

            mostrarReacciones(contentId);

            setTimeout(() => {
                bigHeart.remove();
            }, 800);

            console.log('💗 Doble click - Modal abierto');
        }

        // ========================================
        // COMENTARIOS
        // ========================================
        document.querySelectorAll('.comment-input').forEach(input => {
            input.addEventListener('input', function () {
                const contentId = this.dataset.contentId;
                const btn = document.querySelector(`.post-comment-btn[data-content-id="${contentId}"]`);
                btn.disabled = this.value.trim() === '';
            });

            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const contentId = this.dataset.contentId;
                    const btn = document.querySelector(`.post-comment-btn[data-content-id="${contentId}"]`);
                    if (!btn.disabled) {
                        publicarComentario(contentId, this.value.trim());
                    }
                }
            });
        });

        document.querySelectorAll('.post-comment-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const contentId = this.dataset.contentId;
                const input = document.querySelector(`.comment-input[data-content-id="${contentId}"]`);
                const texto = input.value.trim();
                if (texto) publicarComentario(contentId, texto);
            });
        });

        async function publicarComentario(contentId, texto) {
            const btn = document.querySelector(`.post-comment-btn[data-content-id="${contentId}"]`);
            const input = document.querySelector(`.comment-input[data-content-id="${contentId}"]`);
            const commentCountSpan = document.querySelector(`.comment-count-display[data-content-id="${contentId}"]`);

            btn.disabled = true;
            btn.textContent = 'Publicando...';

            try {
                const response = await fetch('/Feed/Comentar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: `id=${contentId}&texto=${encodeURIComponent(texto)}`
                });

                const data = await response.json();

                if (data.success) {
                    input.value = '';
                    btn.disabled = true;
                    btn.textContent = 'Publicar';

                    if (commentCountSpan) {
                        commentCountSpan.textContent = data.totalComentarios;
                    } else if (data.totalComentarios === 1) {
                        const actionsDiv = document.querySelector(`[data-content-id="${contentId}"] .post-actions`);
                        const captionDiv = actionsDiv.querySelector('.post-caption');
                        const commentsSection = document.createElement('div');
                        commentsSection.className = 'post-comments';
                        commentsSection.innerHTML = `
                            <button class="view-comments" onclick="window.location.href='/Feed/Detalle/${contentId}'">
                                Ver el <span class="comment-count-display" data-content-id="${contentId}">1</span> comentario
                            </button>
                        `;

                        if (captionDiv) {
                            captionDiv.after(commentsSection);
                        } else {
                            const likesContainer = actionsDiv.querySelector('.post-likes');
                            if (likesContainer) {
                                likesContainer.after(commentsSection);
                            }
                        }
                    }

                    mostrarNotificacion('Comentario publicado ✓', 'success');
                    console.log('✅ Comentario publicado');
                } else {
                    mostrarNotificacion(data.message || 'Error', 'error');
                    btn.textContent = 'Publicar';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('❌ Error:', error);
                mostrarNotificacion('Error al publicar', 'error');
                btn.textContent = 'Publicar';
                btn.disabled = false;
            }
        }

        // ========================================
        // COMPARTIR
        // ========================================
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const contentId = this.dataset.id;
                const username = this.dataset.username;
                const url = `${window.location.origin}/Feed/Detalle/${contentId}`;
                const title = `Contenido de @@${username}`;
                const text = `Mira este contenido en Lado`;

                if (navigator.share) {
                    try {
                        await navigator.share({ title, text, url });
                        console.log('✅ Contenido compartido');
                    } catch (error) {
                        if (error.name !== 'AbortError') copiarAlPortapapeles(url);
                    }
                } else {
                    copiarAlPortapapeles(url);
                }
            });
        });

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                mostrarNotificacion('Enlace copiado ✓', 'success');
            }).catch(() => {
                mostrarNotificacion('No se pudo copiar', 'error');
            });
        }

        // ========================================
        // ANIMACIÓN FLOTANTE DE REACCIONES
        // ========================================
        function crearAnimacionReaccion(contenidoId, emoji) {
            const postCard = document.querySelector(`[data-content-id="${contenidoId}"]`);
            const mediaContainer = postCard?.querySelector('.post-media');

            if (!mediaContainer) {
                console.warn('⚠️ No se encontró contenedor de media para animación');
                return;
            }

            const cantidad = Math.floor(Math.random() * 3) + 3;

            for (let i = 0; i < cantidad; i++) {
                setTimeout(() => {
                    const reactionElement = document.createElement('div');
                    reactionElement.className = 'reaction-float';
                    reactionElement.textContent = emoji;

                    const variants = ['', 'variant-1', 'variant-2'];
                    const directions = ['', 'left', 'right'];
                    reactionElement.classList.add(
                        variants[Math.floor(Math.random() * variants.length)],
                        directions[Math.floor(Math.random() * directions.length)]
                    );

                    const rect = mediaContainer.getBoundingClientRect();
                    const randomX = Math.random() * (rect.width - 60) + 30;
                    const randomY = Math.random() * (rect.height - 60) + rect.height * 0.5;

                    reactionElement.style.left = randomX + 'px';
                    reactionElement.style.top = randomY + 'px';

                    if (getComputedStyle(mediaContainer).position === 'static') {
                        mediaContainer.style.position = 'relative';
                    }

                    mediaContainer.appendChild(reactionElement);

                    setTimeout(() => {
                        reactionElement.remove();
                    }, 2200);
                }, i * 150);
            }

            console.log(`🎨 Creadas ${cantidad} animaciones de ${emoji} en contenido ${contenidoId}`);
        }

        // ========================================
        // NOTIFICACIONES
        // ========================================
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 14px 20px;
                background: ${tipo === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: fadeIn 0.3s ease;
            `;
            notif.textContent = mensaje;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        const notifStyle = document.createElement('style');
        notifStyle.textContent = `
            @@keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @@keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
        `;
        document.head.appendChild(notifStyle);

        console.log('✅ Feed completamente inicializado');
    });
</script>