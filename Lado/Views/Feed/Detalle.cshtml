@model Lado.Models.Contenido
@{
    ViewData["Title"] = !string.IsNullOrEmpty(Model.Descripcion)
        ? (Model.Descripcion.Length > 60 ? Model.Descripcion.Substring(0, 60) + "..." : Model.Descripcion)
        : $"Contenido de {Model.Usuario?.Seudonimo ?? Model.Usuario?.UserName ?? "Creador"}";

    var estaSuscrito = ViewBag.EstaSuscrito ?? false;
    var esFavorito = ViewBag.EsFavorito ?? false;
    var estaAutenticado = ViewBag.EstaAutenticado ?? User.Identity?.IsAuthenticated ?? false;
    var currentUserId = ViewBag.CurrentUserId as string ?? "";
    var estaSiguiendo = ViewBag.EstaSiguiendo ?? false;
    var esPropio = ViewBag.EsPropio ?? false;
    var contenidoBloqueado = ViewBag.ContenidoBloqueado ?? false;
    var mensajeBloqueo = ViewBag.MensajeBloqueo as string ?? "Regístrate para ver este contenido";

    // Soporte para carrusel (múltiples archivos)
    var archivosCarrusel = Model.TodosLosArchivos;
    var esCarrusel = archivosCarrusel.Count > 1;

    // Configurar Open Graph para compartir en redes sociales
    var baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var creadorNombre = Model.Usuario?.Seudonimo ?? Model.Usuario?.UserName ?? "Creador";

    ViewData["OgTitle"] = !string.IsNullOrEmpty(Model.Descripcion)
        ? $"{creadorNombre}: {(Model.Descripcion.Length > 80 ? Model.Descripcion.Substring(0, 80) + "..." : Model.Descripcion)}"
        : $"Contenido exclusivo de {creadorNombre} en Lado";

    ViewData["OgDescription"] = !string.IsNullOrEmpty(Model.Descripcion)
        ? Model.Descripcion
        : $"Mira el contenido exclusivo de {creadorNombre} en Lado - La plataforma de creadores";

    // Usar thumbnail o imagen del contenido
    var imagenOg = !string.IsNullOrEmpty(Model.Thumbnail)
        ? $"{baseUrl}{Model.Thumbnail}"
        : (!string.IsNullOrEmpty(Model.RutaArchivo) && (Model.TipoContenido == Lado.Models.TipoContenido.Foto)
            ? $"{baseUrl}{Model.RutaArchivo}"
            : $"{baseUrl}/images/og-default.jpg");
    ViewData["OgImage"] = imagenOg;

    ViewData["OgUrl"] = $"{baseUrl}/Feed/Detalle/{Model.Id}";
    ViewData["OgType"] = "article";
}

@Html.AntiForgeryToken()

<style>
    :root {
        --primary: #4682B4;
        --primary-dark: #36648B;
        --bg: #fafafa;
        --card-bg: #ffffff;
        --fg: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --hover: #f3f4f6;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* LAYOUT PRINCIPAL */
    .detail-layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 20px 40px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
    }

    /* CARD DE CONTENIDO */
    .content-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    /* HEADER */
    .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
    }

    .creator-info {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        flex: 1;
        min-width: 0;
    }

    .creator-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        flex-shrink: 0;
    }

    .creator-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .creator-details {
        flex: 1;
        min-width: 0;
    }

    .creator-details h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        margin: 0 0 2px 0;
    }

    .creator-details span {
        font-size: 14px;
        color: var(--muted);
    }

    /* Botón Seguir en header */
    .header-follow-btn {
        padding: 6px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        margin-left: 12px;
    }

    .header-follow-btn.follow {
        background: var(--primary, #7c3aed);
        color: white;
    }

    .header-follow-btn.follow:hover {
        background: var(--primary-dark, #6d28d9);
    }

    .header-follow-btn.following {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
    }

    .header-follow-btn.following:hover {
        border-color: #ef4444;
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    /* Seguidores en común */
    .creator-info-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        flex: 1;
        min-width: 0;
    }

    .seguidores-comun-badge {
        position: absolute;
        bottom: -6px;
        left: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .seguidores-comun-avatars {
        display: flex;
    }

    .seguidores-comun-avatar {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--bg);
        margin-left: -6px;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        color: white;
        overflow: hidden;
    }

    .seguidores-comun-avatar:first-child {
        margin-left: 0;
    }

    .seguidores-comun-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .seguidores-comun-count {
        font-size: 10px;
        color: var(--muted);
        margin-left: 4px;
        white-space: nowrap;
    }

    .seguidores-comun-tooltip {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        color: var(--fg);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
        z-index: 10;
        margin-bottom: 8px;
    }

    .seguidores-comun-badge:hover .seguidores-comun-tooltip {
        opacity: 1;
        visibility: visible;
    }

    .post-menu {
        padding: 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--fg);
        position: relative;
    }

    .post-menu:hover {
        background: var(--hover);
        border-radius: 4px;
    }

    /* Post Menu Dropdown */
    .post-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 200px;
        z-index: 100;
        display: none;
        overflow: hidden;
    }

    .post-menu-dropdown.show {
        display: block;
    }

    .post-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: var(--fg);
        font-size: 14px;
        cursor: pointer;
        transition: background 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .post-menu-item:hover {
        background: var(--hover);
    }

    .post-menu-item.danger {
        color: #ed4956;
    }

    .post-menu-item.danger:hover {
        background: rgba(237, 73, 86, 0.1);
    }

    .post-menu-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .post-menu-divider {
        height: 1px;
        background: var(--border);
        margin: 4px 0;
    }

    /* BOOKMARK BUTTON */
    .action-spacer {
        flex: 1;
    }

    .bookmark-btn.bookmarked svg {
        fill: var(--fg);
        stroke: var(--fg);
    }

    /* MEDIA */
    .content-media {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        max-height: 600px;
        position: relative;
    }

    .content-media img,
    .content-media video {
        width: 100%;
        max-height: 600px;
        object-fit: contain;
        display: block;
    }

    /* Botón explorar contenido del creador */
    .explore-creator-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s ease;
        z-index: 100; /* Alto para estar sobre video controls */
    }

    /* Asegurar que content-media tenga position relative para el botón absoluto */
    .content-media {
        position: relative;
    }

    /* Hacer que el video no bloquee el botón */
    .content-media video {
        position: relative;
        z-index: 1;
    }

    .explore-creator-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
    }

    .explore-creator-btn svg {
        width: 22px;
        height: 22px;
    }

    /* MUSIC BADGE */
    .image-with-music-container {
        position: relative;
        width: 100%;
    }

    .music-badge {
        position: absolute;
        bottom: 16px;
        left: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        padding: 10px 14px;
        border-radius: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        max-width: calc(100% - 32px);
        z-index: 10;
    }

    .music-badge:hover {
        background: rgba(0, 0, 0, 0.85);
        transform: scale(1.02);
    }

    .music-badge-icon {
        width: 32px;
        height: 32px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        animation: none;
    }

    .music-badge-icon svg {
        width: 18px;
        height: 18px;
    }

    .music-badge.playing .music-badge-icon {
        animation: musicSpin 20s linear infinite !important;
    }

    @@keyframes musicSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .music-badge-info {
        overflow: hidden;
        color: white;
    }

    .music-badge-title {
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .music-badge-artist {
        font-size: 11px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    #photoAudioPlayer {
        display: none;
    }

    /* PREMIUM OVERLAY */
    .premium-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 20px;
        text-align: center;
    }

    .premium-lock-icon {
        width: 72px;
        height: 72px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 8px 32px rgba(70, 130, 180, 0.4);
    }

    .premium-lock-icon svg {
        width: 32px;
        height: 32px;
    }

    .premium-overlay h4 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px 0;
    }

    .premium-overlay p {
        font-size: 14px;
        opacity: 0.9;
        margin: 0 0 20px 0;
    }

    .unlock-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .unlock-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Estilos para contenido bloqueado (usuarios no autenticados) */
    .blocked-overlay {
        background: rgba(0, 0, 0, 0.7);
    }

    .blocked-cta-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
        width: 100%;
        max-width: 280px;
    }

    .blocked-cta-buttons .unlock-btn {
        width: 100%;
        justify-content: center;
        text-decoration: none;
    }

    .blocked-cta-buttons .primary-btn {
        background: var(--primary);
    }

    .blocked-cta-buttons .secondary-btn {
        background: transparent;
        border: 2px solid white;
    }

    .blocked-cta-buttons .secondary-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* ACCIONES */
    .content-actions {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 12px;
    }

    .action-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--fg);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.15s;
    }

    .action-btn:hover {
        transform: scale(1.1);
    }

    .action-btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        transition: all 0.2s;
    }

    /* BOTÓN DE LIKE */
    .like-btn.liked {
        color: #ed4956;
    }

    .like-btn.liked svg {
        fill: #ed4956;
        stroke: #ed4956;
    }

    /* CTA PARA USUARIOS NO AUTENTICADOS */
    .auth-cta {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(70, 130, 180, 0.1), rgba(70, 130, 180, 0.05));
        border-radius: 12px;
        text-align: center;
    }

    .auth-cta p {
        color: var(--muted);
        font-size: 14px;
        margin: 0;
    }

    .auth-cta-buttons {
        display: flex;
        gap: 12px;
    }

    .auth-cta .btn-login {
        background: var(--primary);
        color: white;
        padding: 10px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
    }

    .auth-cta .btn-login:hover {
        background: var(--primary-dark);
    }

    .auth-cta .btn-register {
        background: transparent;
        color: var(--primary);
        padding: 10px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        border: 1px solid var(--primary);
        transition: all 0.2s;
    }

    .auth-cta .btn-register:hover {
        background: rgba(70, 130, 180, 0.1);
    }

    /* BOTÓN REACCIONAR */
    .react-btn {
        background: var(--hover);
        border: 1px solid var(--border);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--muted);
        transition: all 0.2s;
    }

    .react-btn:hover {
        background: var(--border);
        color: var(--fg);
    }

    .content-stats {
        display: flex;
        gap: 24px;
        font-size: 14px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
    }

    .stat-item strong {
        color: var(--fg);
        font-weight: 600;
    }

    /* REACCIONES MINI */
    .reacciones-mini {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        font-size: 16px;
    }

    .reacciones-mini span {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    /* DESCRIPCIÓN */
    .content-description {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
    }

    .content-description p {
        font-size: 15px;
        line-height: 1.6;
        color: var(--fg);
        margin: 0;
    }

    /* COMENTARIOS */
    .comments-section {
        padding: 20px;
    }

    .comments-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .comments-header h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--fg);
        margin: 0;
    }

    /* FORMULARIO */
    .comment-form {
        background: var(--hover);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
    }

    .comment-textarea {
        width: 100%;
        border: none;
        background: var(--card-bg);
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        margin-bottom: 12px;
        color: var(--fg);
        font-family: inherit;
    }

    .comment-textarea:focus {
        outline: 2px solid var(--primary);
    }

    .comment-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .btn-comment {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-cancel {
        background: none;
        color: var(--muted);
        border: 1px solid var(--border);
    }

    .btn-cancel:hover {
        background: var(--hover);
    }

    .btn-submit {
        background: var(--primary);
        color: white;
    }

    .btn-submit:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ========================================
       COMENTARIOS ESTILO INSTAGRAM
       ======================================== */

    .comment-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
    }

    .comment-item:not(:last-child) {
        border-bottom: 1px solid var(--border);
    }

    /* Avatar con boton follow */
    .comment-avatar-wrapper {
        position: relative;
        flex-shrink: 0;
    }

    .comment-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--hover);
    }

    .comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .comment-avatar-initial {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        color: var(--fg);
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        color: white;
    }

    .comment-follow-btn {
        position: absolute;
        bottom: -4px;
        right: -4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0095f6;
        border: 2px solid var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .comment-follow-btn:hover {
        transform: scale(1.1);
    }

    .comment-follow-btn svg {
        width: 10px;
        height: 10px;
        fill: white;
    }

    /* Contenido del comentario */
    .comment-content {
        flex: 1;
        min-width: 0;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .comment-username {
        font-size: 14px;
        font-weight: 600;
        color: var(--fg);
        text-decoration: none;
    }

    .comment-username:hover {
        text-decoration: underline;
    }

    .comment-time {
        font-size: 13px;
        color: var(--muted);
    }

    .comment-menu-btn {
        margin-left: auto;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 8px;
        font-size: 16px;
        letter-spacing: 2px;
    }

    .comment-menu-btn:hover {
        color: var(--fg);
    }

    .comment-text {
        font-size: 15px;
        line-height: 1.5;
        color: var(--fg);
        margin-bottom: 8px;
        word-wrap: break-word;
    }

    /* Acciones del comentario - Estilo Instagram */
    .comment-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 8px;
    }

    .comment-action-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 14px;
        padding: 0;
        transition: all 0.2s;
    }

    .comment-action-btn:hover {
        color: var(--fg);
    }

    .comment-action-btn svg {
        width: 20px;
        height: 20px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
    }

    .comment-action-btn.like-btn svg.liked {
        fill: #ed4956;
        stroke: #ed4956;
    }

    .comment-action-btn.like-btn:hover svg:not(.liked) {
        color: #ed4956;
    }

    .comment-action-btn .count {
        font-weight: 500;
        font-size: 14px;
    }

    /* Animacion de like */
    @@keyframes heartPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    .comment-action-btn svg.liked {
        animation: heartPop 0.3s ease-out;
    }

    /* Mostrar respuestas con avatares */
    .show-replies-row {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 4px 0;
    }

    .show-replies-row:hover .show-replies-text {
        text-decoration: underline;
    }

    .reply-mini-avatars {
        display: flex;
        align-items: center;
    }

    .reply-mini-avatars img,
    .reply-mini-avatars .mini-avatar-initial {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--bg);
        margin-left: -8px;
        object-fit: cover;
    }

    .reply-mini-avatars img:first-child,
    .reply-mini-avatars .mini-avatar-initial:first-child {
        margin-left: 0;
    }

    .reply-mini-avatars .mini-avatar-initial {
        background: var(--accent);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
    }

    .show-replies-text {
        font-size: 13px;
        color: var(--muted);
        font-weight: 500;
    }

    /* Respuestas anidadas */
    .comment-respuesta {
        padding-left: 56px;
    }

    .comment-respuesta .comment-avatar {
        width: 36px;
        height: 36px;
    }

    .comment-respuesta .comment-follow-btn {
        width: 16px;
        height: 16px;
    }

    .comment-respuesta .comment-follow-btn svg {
        width: 8px;
        height: 8px;
    }

    /* MODAL REACCIONES */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9998;
    }

    .modal-reacciones {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        z-index: 9999;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
    }

    .modal-reacciones h3 {
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 20px;
        color: var(--fg);
    }

    .reacciones-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .reaccion-btn {
        background: var(--hover);
        border: none;
        border-radius: 8px;
        padding: 16px 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .reaccion-btn:hover {
        transform: scale(1.05);
        background: var(--border);
    }

    .reaccion-btn .emoji {
        font-size: 32px;
    }

    .reaccion-btn span:not(.emoji) {
        font-size: 11px;
        font-weight: 600;
        color: var(--fg);
    }

    /* ANIMACIONES DE REACCIONES FLOTANTES */
    .reaction-float {
        position: absolute;
        font-size: 48px;
        pointer-events: none;
        z-index: 100;
        animation: floatUp 2s ease-out forwards;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    @@keyframes floatUp {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0);
        }
        10% {
            transform: translateY(-10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translateY(-80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translateY(-150px) scale(0.8) rotate(10deg);
        }
    }

    .reaction-float.variant-1 {
        animation-duration: 1.8s;
    }

    .reaction-float.variant-2 {
        animation-duration: 2.2s;
    }

    .reaction-float.left {
        animation-name: floatUpLeft;
    }

    .reaction-float.right {
        animation-name: floatUpRight;
    }

    @@keyframes floatUpLeft {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(0);
        }
        10% {
            transform: translate(-5px, -10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translate(-40px, -80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(-60px, -150px) scale(0.8) rotate(-15deg);
        }
    }

    @@keyframes floatUpRight {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(0);
        }
        10% {
            transform: translate(5px, -10px) scale(1.2);
        }
        50% {
            opacity: 1;
            transform: translate(40px, -80px) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(60px, -150px) scale(0.8) rotate(15deg);
        }
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.3);
        }
        100% {
            transform: scale(1);
        }
    }

    /* ========================================
       ESTILOS COMENTARIOS EN HILO (BASE)
       ======================================== */
    .btn-responder {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 13px;
        padding: 4px 0;
        cursor: pointer;
        margin-top: 6px;
        transition: color 0.2s;
    }

    .btn-responder:hover {
        color: var(--primary);
    }

    .respuestas-container {
        margin-left: 60px;
        border-left: 2px solid var(--border);
        padding-left: 16px;
        margin-top: 8px;
    }

    /* Botones de cargar más comentarios y respuestas */
    .load-more-comments-container {
        padding: 16px 0;
        text-align: center;
    }

    .load-more-comments-btn,
    .load-more-replies-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 24px;
        color: var(--primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .load-more-comments-btn:hover,
    .load-more-replies-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .load-more-comments-btn:disabled,
    .load-more-replies-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .load-more-comments-btn i,
    .load-more-replies-btn i {
        font-size: 12px;
        transition: transform 0.2s;
    }

    .load-more-comments-btn.loading i,
    .load-more-replies-btn.loading i {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .load-more-replies-btn {
        margin: 12px 0 12px 16px;
        padding: 8px 16px;
        font-size: 13px;
        border-radius: 16px;
    }

    .comment-respuesta {
        padding: 10px 0 !important;
    }

    .comment-respuesta .comment-header {
        font-size: 13px;
    }

    .comment-respuesta .comment-text {
        font-size: 14px;
    }

    .btn-ver-respuestas {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 13px;
        padding: 8px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
    }

    .btn-ver-respuestas:hover {
        color: var(--primary);
    }

    .respuestas-lista.ocultas {
        display: none;
    }

    .reply-form-container {
        margin-left: 60px;
        padding: 16px;
        background: var(--hover);
        border-radius: 12px;
        margin-top: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
    }

    .reply-textarea {
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        color: var(--fg);
        resize: none;
        font-family: inherit;
    }

    .reply-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .reply-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
    }

    .btn-cancel-reply,
    .btn-submit-reply {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-cancel-reply {
        background: transparent;
        color: var(--muted);
    }

    .btn-cancel-reply:hover {
        background: var(--hover);
        color: var(--fg);
    }

    .btn-submit-reply {
        background: var(--primary);
        color: white;
    }

    .btn-submit-reply:hover {
        background: var(--primary-dark);
    }

    .btn-submit-reply:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ========================================
       RESPONSIVE - Tablets
       ======================================== */
    @@media (max-width: 768px) {
        .detail-layout {
            padding: 16px 12px 40px;
        }

        .content-header {
            padding: 12px 16px;
        }

        .creator-avatar {
            width: 42px;
            height: 42px;
        }

        .creator-details h3 {
            font-size: 15px;
        }

        .creator-details span {
            font-size: 13px;
        }

        .action-buttons {
            flex-wrap: wrap;
            gap: 8px;
        }

        .action-btn {
            padding: 6px;
            font-size: 13px;
        }

        .action-btn svg {
            width: 22px;
            height: 22px;
        }

        /* Ocultar texto en botones excepto en el principal */
        .share-btn,
        .dm-btn {
            font-size: 0;
            gap: 0;
        }

        .react-btn {
            padding: 8px 14px;
            font-size: 13px;
        }

        .content-stats {
            gap: 16px;
            font-size: 13px;
        }

        .content-actions {
            padding: 12px 16px;
        }

        .comments-section {
            padding: 16px;
        }
    }

    /* ========================================
       RESPONSIVE - Móviles (Estilo Instagram)
       ======================================== */
    @@media (max-width: 640px) {
        /* Layout fullscreen inmersivo */
        .detail-layout {
            padding: 0;
            max-width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .content-card {
            border-radius: 0;
            border: none;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Header estilo Instagram - sticky para evitar layout shift */
        .content-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 10px 16px;
            padding-top: max(10px, env(safe-area-inset-top, 10px));
            border-bottom: none;
        }

        .creator-info {
            gap: 12px;
        }

        .creator-avatar {
            width: 38px;
            height: 38px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .creator-details h3 {
            font-size: 14px;
            color: white;
        }

        .creator-details span {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }

        .post-menu {
            color: white;
        }

        /* Media - tamaño controlado */
        .content-media {
            max-height: 55vh;
            min-height: 35vh;
            position: relative;
            background: #000;
        }

        .content-media img,
        .content-media video {
            max-height: 55vh;
            height: auto;
            width: 100%;
            object-fit: contain;
        }

        /* Panel inferior con información */
        .mobile-bottom-panel {
            position: relative;
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            margin-top: -20px;
            z-index: 10;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        /* Barra de acciones estilo Instagram */
        .content-actions {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--card-bg);
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 10px;
        }

        .action-btn {
            padding: 8px 12px;
            font-size: 0;
            flex: none;
        }

        .action-btn svg {
            width: 26px;
            height: 26px;
        }

        .like-btn {
            padding-left: 0;
        }

        .react-btn {
            padding: 8px 12px;
            font-size: 0;
            border: none;
            background: transparent;
        }

        .react-btn span {
            font-size: 26px !important;
        }

        .action-spacer {
            flex: 1;
        }

        .bookmark-btn {
            padding-right: 0;
        }

        /* Stats compactos */
        .content-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .stat-item {
            flex-direction: row;
            gap: 6px;
        }

        .stat-item strong {
            font-size: 14px;
        }

        .reacciones-mini {
            font-size: 14px;
        }

        /* Descripción */
        .content-description {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .content-description p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Sección de comentarios */
        .comments-section {
            padding: 12px 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
        }

        .comments-header {
            margin-bottom: 16px;
        }

        .comments-header h3 {
            font-size: 15px;
            font-weight: 600;
        }

        .comment-form {
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 12px;
        }

        .comment-textarea {
            min-height: 50px;
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
        }

        .comment-actions {
            margin-top: 10px;
        }

        .btn-comment {
            padding: 10px 16px;
            font-size: 14px;
            border-radius: 8px;
        }

        .comment-item {
            padding: 12px 0;
            gap: 10px;
        }

        .comment-header {
            font-size: 13px;
        }

        .comment-text {
            font-size: 14px;
        }

        /* Estilos para comentarios en hilo */
        .btn-responder {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 12px;
            padding: 4px 0;
            cursor: pointer;
            margin-top: 4px;
        }

        .btn-responder:hover {
            color: var(--accent);
        }

        .respuestas-container {
            margin-left: 50px;
            border-left: 2px solid rgba(255,255,255,0.1);
            padding-left: 12px;
        }

        .comment-respuesta {
            padding: 8px 0 !important;
        }

        .comment-respuesta .comment-header {
            font-size: 12px;
        }

        .comment-respuesta .comment-text {
            font-size: 13px;
        }

        .btn-ver-respuestas {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 12px;
            padding: 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-ver-respuestas:hover {
            color: var(--accent);
        }

        .respuestas-lista.ocultas {
            display: none;
        }

        .reply-form-container {
            margin-left: 50px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .reply-textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            color: var(--text);
            resize: none;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .reply-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-cancel-reply,
        .btn-submit-reply {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .btn-cancel-reply {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .btn-submit-reply {
            background: var(--accent);
            color: white;
        }

        .btn-submit-reply:hover {
            opacity: 0.9;
        }

        /* Toggle de visibilidad */
        .visibility-toggle-container {
            padding: 10px 16px;
            flex-wrap: wrap;
            gap: 10px;
            border-radius: 12px;
            margin: 0 16px 12px;
        }

        .visibility-icon {
            width: 32px;
            height: 32px;
        }

        .visibility-label {
            font-size: 13px;
        }

        .visibility-desc {
            font-size: 11px;
        }

        /* Auth CTA */
        .auth-cta {
            padding: 16px;
            margin: 12px 16px;
            border-radius: 12px;
        }

        .auth-cta p {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .auth-cta-buttons {
            flex-direction: row;
            gap: 10px;
        }

        .auth-cta .btn-login,
        .auth-cta .btn-register {
            flex: 1;
            text-align: center;
            padding: 12px 16px;
            border-radius: 10px;
        }

        /* Modal de reacciones */
        .reacciones-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .reaccion-btn {
            padding: 12px 6px;
        }

        .reaccion-btn .emoji {
            font-size: 28px;
        }

        .reaccion-btn span:not(.emoji) {
            font-size: 10px;
        }

        /* Menú dropdown */
        .post-menu-dropdown {
            min-width: 200px;
            right: 0;
            top: calc(100% + 8px);
            border-radius: 12px;
        }

        .post-menu-item {
            padding: 14px 16px;
            font-size: 15px;
        }

        /* Premium overlay mejorado */
        .premium-overlay {
            background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.85) 100%);
        }

        .premium-overlay h4 {
            font-size: 18px;
        }

        .premium-overlay p {
            font-size: 14px;
        }

        .premium-lock-icon {
            width: 64px;
            height: 64px;
        }

        .unlock-btn {
            padding: 14px 32px;
            font-size: 15px;
            border-radius: 12px;
        }

        /* Music badge */
        .music-badge {
            padding: 8px 12px;
            bottom: 80px;
            left: 16px;
            border-radius: 20px;
        }

        .music-badge-icon {
            width: 28px;
            height: 28px;
        }

        .music-badge-title {
            font-size: 13px;
            max-width: 150px;
        }

        .music-badge-artist {
            font-size: 11px;
            max-width: 150px;
        }

        /* Carrusel */
        .detail-carousel .carousel-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
        }

        .detail-carousel .carousel-btn svg {
            width: 20px;
            height: 20px;
        }

        .detail-carousel .carousel-prev { left: 12px; }
        .detail-carousel .carousel-next { right: 12px; }

        .detail-carousel .carousel-counter {
            font-size: 13px;
            padding: 6px 12px;
            top: 60px;
            right: 16px;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
        }

        .detail-carousel .carousel-dots {
            bottom: 80px;
            gap: 8px;
        }

        .detail-carousel .carousel-dot {
            width: 8px;
            height: 8px;
        }

        .detail-carousel .carousel-dot.active {
            width: 20px;
            border-radius: 4px;
        }
    }

    /* ========================================
       RESPONSIVE - Móviles pequeños
       ======================================== */
    @@media (max-width: 400px) {
        .content-header {
            padding: 10px 12px;
            padding-top: max(10px, env(safe-area-inset-top, 10px));
        }

        .creator-avatar {
            width: 36px;
            height: 36px;
        }

        .creator-details h3 {
            font-size: 14px;
        }

        .creator-details span {
            font-size: 12px;
        }

        .action-btn {
            padding: 6px 10px;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
        }

        .react-btn span {
            font-size: 24px !important;
        }

        .content-stats {
            gap: 12px;
            font-size: 13px;
        }

        .stat-item strong {
            font-size: 13px;
        }

        .content-description p {
            font-size: 13px;
        }

        .comment-form {
            padding: 10px;
        }

        .btn-comment {
            padding: 8px 14px;
            font-size: 13px;
        }

        .auth-cta-buttons {
            flex-direction: column;
        }

        .modal-reacciones {
            padding: 16px;
            width: 95%;
        }

        .reacciones-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .reaccion-btn {
            padding: 10px 4px;
        }

        .reaccion-btn .emoji {
            font-size: 24px;
        }

        .reaccion-btn span:not(.emoji) {
            font-size: 9px;
        }
    }

    /* ========================================
       iOS Safe Areas
       ======================================== */
    @@supports (padding: max(0px)) {
        @@media (max-width: 640px) {
            .content-header {
                padding-top: max(12px, env(safe-area-inset-top));
            }

            .comments-section {
                padding-bottom: max(16px, calc(env(safe-area-inset-bottom) + 16px));
            }
        }

        @@media (min-width: 641px) {
            .detail-layout {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(40px, env(safe-area-inset-bottom));
            }

            .content-actions {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }
        }
    }

    /* Toggle de Visibilidad */
    .visibility-toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-bottom: 1px solid var(--border);
    }

    .visibility-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .visibility-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .visibility-icon svg {
        width: 18px;
        height: 18px;
        color: var(--primary);
    }

    .visibility-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .visibility-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--fg);
    }

    .visibility-desc {
        font-size: 11px;
        color: var(--muted);
    }

    .visibility-toggle {
        position: relative;
        width: 48px;
        height: 26px;
    }

    .visibility-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .visibility-toggle input:checked + .toggle-slider {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .visibility-toggle input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }

    .visibility-toggle.loading .toggle-slider {
        opacity: 0.6;
        pointer-events: none;
    }

    /* ========================================
       CARRUSEL EN DETALLE
       ======================================== */

    .detail-carousel {
        position: relative;
        width: 100%;
        background: #000;
        overflow: hidden;
        border-radius: 12px;
    }

    .detail-carousel .carousel-container {
        width: 100%;
        overflow: hidden;
    }

    .detail-carousel .carousel-track {
        display: flex;
        transition: transform 0.3s ease-out;
    }

    .detail-carousel .carousel-slide {
        flex-shrink: 0;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        max-height: 70vh;
    }

    .detail-carousel .carousel-media {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }

    .detail-carousel .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
    }

    .detail-carousel .carousel-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .detail-carousel .carousel-btn svg {
        width: 24px;
        height: 24px;
    }

    .detail-carousel .carousel-prev { left: 16px; }
    .detail-carousel .carousel-next { right: 16px; }
    .detail-carousel .carousel-prev.hidden,
    .detail-carousel .carousel-next.hidden { display: none; }

    .detail-carousel .carousel-dots {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .detail-carousel .carousel-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.2s;
    }

    .detail-carousel .carousel-dot.active {
        background: white;
        transform: scale(1.2);
    }

    .detail-carousel .carousel-counter {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 14px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 16px;
        z-index: 10;
    }

    /* ========================================
       TOOLTIP DE LIKES (Desktop hover)
       ======================================== */
    .likes-tooltip {
        position: fixed;
        z-index: 1000;
        background: var(--surface, #fff);
        border: 1px solid var(--line, #dbdbdb);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 12px;
        min-width: 200px;
        max-width: 280px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .likes-tooltip.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    .likes-tooltip-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--muted, #8e8e8e);
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--line, #efefef);
    }

    .likes-tooltip-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .likes-tooltip-user {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--fg, #262626);
        padding: 4px;
        border-radius: 8px;
        transition: background 0.15s;
    }

    .likes-tooltip-user:hover {
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-tooltip-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .likes-tooltip-info {
        flex: 1;
        min-width: 0;
    }

    .likes-tooltip-username {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .likes-tooltip-username .verified {
        color: var(--primary, #4682B4);
        font-size: 12px;
    }

    .likes-tooltip-name {
        font-size: 12px;
        color: var(--muted, #8e8e8e);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .likes-tooltip-more {
        font-size: 12px;
        color: var(--primary, #4682B4);
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid var(--line, #efefef);
        margin-top: 8px;
        cursor: pointer;
    }

    .likes-tooltip-loading {
        display: flex;
        justify-content: center;
        padding: 20px;
        color: var(--muted, #8e8e8e);
    }

    /* ========================================
       MODAL DE LIKES (Móvil - long press)
       ======================================== */
    .likes-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .likes-modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .likes-modal {
        background: var(--surface, #fff);
        border-radius: 16px 16px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 70vh;
        min-height: 50vh; /* Altura mínima */
        transform: translateY(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom, 20px); /* Safe area iOS */
    }

    .likes-modal-overlay.visible .likes-modal {
        transform: translateY(0);
    }

    .likes-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 20px 16px; /* Espacio para handle */
        border-bottom: 1px solid var(--line, #efefef);
        position: relative;
    }

    /* Handle visual estilo iOS */
    .likes-modal-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: var(--line, #dbdbdb);
        border-radius: 2px;
    }

    .likes-modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg, #262626);
    }

    .likes-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--muted, #8e8e8e);
        cursor: pointer;
        padding: 4px;
        line-height: 1;
    }

    .likes-modal-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 20px 20px;
        min-height: 200px; /* Altura mínima para el contenido */
    }

    .likes-modal-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Loading y empty states */
    .likes-modal-loading,
    .likes-modal-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--muted, #8e8e8e);
        text-align: center;
        min-height: 150px;
    }

    .likes-modal-user {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--fg, #262626);
        padding: 8px;
        border-radius: 12px;
        transition: background 0.15s;
    }

    .likes-modal-user:hover {
        background: var(--bg-tertiary, #fafafa);
    }

    .likes-modal-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
    }

    .likes-modal-info {
        flex: 1;
    }

    .likes-modal-username {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .likes-modal-username .verified {
        color: var(--primary, #4682B4);
        font-size: 14px;
    }

    .likes-modal-name {
        font-size: 13px;
        color: var(--muted, #8e8e8e);
    }

    .likes-modal-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted, #8e8e8e);
    }

    .likes-modal-empty i {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    /* Hacer clickeable el contador de likes */
    .like-count {
        cursor: pointer;
    }

    .like-count:hover {
        text-decoration: underline;
    }

    /* ========================================
       SIMPLIFICACIÓN MÓVIL - DETALLE
       ======================================== */

    /* Móvil Grande (< 768px) - Mejoras adicionales */
    @@media (max-width: 767px) {
        /* Layout edge-to-edge */
        .detail-layout {
            padding: 0 !important;
            gap: 0;
        }

        .content-card {
            border-radius: 0;
            border: none;
        }

        /* Header más compacto */
        .content-header {
            padding: 10px 12px;
            padding-top: max(10px, env(safe-area-inset-top));
        }

        .creator-avatar {
            width: 40px;
            height: 40px;
        }

        .creator-details h3 {
            font-size: 14px;
        }

        .creator-details span {
            font-size: 12px;
        }

        /* Media optimizado */
        .content-media {
            max-height: 60vh;
            min-height: 40vh;
        }

        .content-media img,
        .content-media video {
            max-height: 60vh;
        }

        /* Acciones con mejor touch target */
        .content-actions {
            padding: 10px 12px;
        }

        .action-btn {
            padding: 10px;
            margin: -6px;
            min-width: 44px;
            min-height: 44px;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Stats más compactos */
        .content-stats {
            gap: 12px;
            font-size: 13px;
        }

        .stat-item {
            gap: 4px;
        }

        .stat-item strong {
            font-size: 13px;
        }

        /* Descripción compacta */
        .content-description {
            padding: 10px 12px;
        }

        .content-description p {
            font-size: 14px;
            line-height: 1.4;
        }

        /* Comentarios optimizados */
        .comments-section {
            padding: 12px;
            padding-bottom: calc(70px + env(safe-area-inset-bottom, 16px));
        }

        .comments-header h3 {
            font-size: 14px;
        }

        .comment-form {
            padding: 10px;
            border-radius: 10px;
        }

        .comment-textarea {
            min-height: 44px;
            padding: 8px 10px;
            font-size: 14px;
        }

        .btn-comment {
            padding: 8px 14px;
            font-size: 13px;
        }

        .comment-item {
            padding: 10px 0;
            gap: 8px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
        }

        .comment-header {
            font-size: 12px;
        }

        .comment-text {
            font-size: 13px;
            line-height: 1.4;
        }

        /* Respuestas más compactas */
        .respuestas-container {
            margin-left: 40px;
            padding-left: 10px;
        }

        .reply-form-container {
            margin-left: 40px;
            padding: 10px;
        }

        /* Music badge más pequeño */
        .music-badge {
            padding: 8px 12px;
            gap: 8px;
        }

        .music-badge-icon {
            width: 28px;
            height: 28px;
        }

        .music-badge-title {
            font-size: 12px;
            max-width: 150px;
        }

        .music-badge-artist {
            font-size: 10px;
            max-width: 150px;
        }

        /* Carrusel */
        .carousel-nav-btn {
            width: 36px;
            height: 36px;
        }

        .carousel-dots {
            bottom: 12px;
        }

        .carousel-dot {
            width: 6px;
            height: 6px;
        }

        /* Menu de post */
        .post-menu {
            padding: 10px;
            margin: -6px;
        }

        .post-menu-dropdown {
            min-width: 160px;
        }

        .post-menu-item {
            padding: 12px 14px;
            font-size: 14px;
        }

        /* Premium overlay */
        .premium-overlay-content {
            padding: 20px;
        }

        .premium-overlay-icon {
            width: 48px;
            height: 48px;
        }

        .premium-overlay-title {
            font-size: 16px;
        }

        .premium-overlay-text {
            font-size: 13px;
        }

        /* Likes tooltip/modal */
        .likes-tooltip {
            display: none !important;
        }

        .likes-modal-content {
            max-height: 70vh;
            margin: auto 16px;
        }

        .likes-modal-header {
            padding: 14px 16px;
        }

        .likes-modal-list {
            max-height: 50vh;
        }

        .likes-modal-user {
            padding: 10px 16px;
        }

        .likes-modal-avatar {
            width: 40px;
            height: 40px;
        }
    }

    /* Móvil Pequeño (< 480px) */
    @@media (max-width: 479px) {
        .content-header {
            padding: 8px 10px;
        }

        .creator-avatar {
            width: 36px;
            height: 36px;
        }

        .creator-details h3 {
            font-size: 13px;
        }

        .creator-details span {
            font-size: 11px;
        }

        /* Media más grande en móvil pequeño */
        .content-media {
            max-height: 55vh;
            min-height: 35vh;
        }

        .content-media img,
        .content-media video {
            max-height: 55vh;
        }

        /* Acciones */
        .content-actions {
            padding: 8px 10px;
        }

        .action-btn svg {
            width: 22px;
            height: 22px;
        }

        .content-stats {
            gap: 10px;
            font-size: 12px;
        }

        /* Descripción */
        .content-description {
            padding: 8px 10px;
        }

        .content-description p {
            font-size: 13px;
        }

        /* Comentarios */
        .comments-section {
            padding: 10px;
        }

        .comment-avatar {
            width: 28px;
            height: 28px;
        }

        .comment-header {
            font-size: 11px;
        }

        .comment-text {
            font-size: 12px;
        }

        .respuestas-container {
            margin-left: 32px;
        }

        .reply-form-container {
            margin-left: 32px;
            padding: 8px;
        }

        /* Music badge ultra compacto */
        .music-badge {
            padding: 6px 10px;
            gap: 6px;
            bottom: 12px;
            left: 12px;
        }

        .music-badge-icon {
            width: 24px;
            height: 24px;
        }

        .music-badge-icon svg {
            width: 14px;
            height: 14px;
        }

        .music-badge-title {
            font-size: 11px;
            max-width: 120px;
        }

        .music-badge-artist {
            font-size: 9px;
            max-width: 120px;
        }
    }

    /* Pantallas muy pequeñas (< 360px) */
    @@media (max-width: 359px) {
        .creator-avatar {
            width: 32px;
            height: 32px;
        }

        .creator-details h3 {
            font-size: 12px;
        }

        .action-btn {
            padding: 8px;
        }

        .action-btn svg {
            width: 20px;
            height: 20px;
        }

        .content-stats {
            font-size: 11px;
            gap: 8px;
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
        }

        .respuestas-container,
        .reply-form-container {
            margin-left: 28px;
        }

        .music-badge-info {
            display: none;
        }

        .music-badge {
            border-radius: 50%;
            padding: 8px;
        }
    }

    /* Safe area para iPhone X+ */
    @@supports (padding-bottom: env(safe-area-inset-bottom)) {
        @@media (max-width: 767px) {
            .comments-section {
                padding-bottom: calc(70px + env(safe-area-inset-bottom)) !important;
            }

            .content-card {
                min-height: calc(100vh - env(safe-area-inset-bottom));
                min-height: calc(100dvh - env(safe-area-inset-bottom));
            }
        }
    }

    /* Optimizaciones de rendimiento móvil */
    @@media (max-width: 767px) {
        .content-media img,
        .content-media video {
            will-change: auto;
        }

        .content-card,
        .action-btn,
        .comment-item {
            transition-duration: 0.15s;
        }

        /* Desactivar hover effects en móvil */
        .action-btn:hover {
            opacity: 1;
        }

        .post-menu:hover {
            background: transparent;
        }

        /* Scroll suave en comentarios */
        .comments-list {
            -webkit-overflow-scrolling: touch;
        }
    }

    /* ========================================
       SHARE MODAL - Estilo Instagram
       ======================================== */
    .share-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .share-modal-overlay.active {
        display: flex;
    }

    .share-modal {
        background: var(--card-bg);
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        height: 70vh;
        max-height: 600px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: shareModalFadeIn 0.2s ease-out;
    }

    @@keyframes shareModalFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    .share-modal-header {
        padding: 16px;
        text-align: center;
        font-weight: 700;
        font-size: 16px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }

    .share-modal-close {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--fg);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        z-index: 10;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }

    .share-modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .share-modal-close:active {
        background: rgba(255, 255, 255, 0.2);
    }

    .share-search-box {
        padding: 12px 16px;
        flex-shrink: 0;
    }

    .share-search-wrapper {
        position: relative;
    }

    .share-search-input {
        width: 100%;
        background: var(--hover);
        border: none;
        border-radius: 10px;
        padding: 12px 16px 12px 42px;
        font-size: 15px;
        color: var(--fg);
        outline: none;
    }

    .share-search-input::placeholder {
        color: var(--muted);
    }

    .share-search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
    }

    .share-contacts-grid {
        flex: 1;
        overflow-y: auto;
        padding: 8px 12px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        align-content: start;
    }

    .share-contact-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 12px 4px;
        border-radius: 12px;
        transition: background 0.15s;
    }

    .share-contact-item:hover {
        background: var(--hover);
    }

    .share-contact-item.selected .share-contact-avatar {
        border-color: var(--primary);
    }

    .share-contact-avatar {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--hover);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 22px;
        color: var(--muted);
        border: 3px solid transparent;
    }

    .share-contact-name {
        font-size: 12px;
        color: var(--fg);
        text-align: center;
        max-width: 80px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .share-contacts-empty {
        grid-column: 1 / -1;
        text-align: center;
        color: var(--muted);
        padding: 40px 20px;
    }

    .share-apps-bar {
        border-top: 1px solid var(--border);
        padding: 12px 8px;
        flex-shrink: 0;
        display: flex;
        overflow-x: auto;
        gap: 4px;
        scrollbar-width: none;
    }

    .share-apps-bar::-webkit-scrollbar {
        display: none;
    }

    .share-app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 10px;
        min-width: 64px;
        flex-shrink: 0;
        text-decoration: none;
    }

    .share-app-item:hover {
        background: var(--hover);
    }

    .share-app-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .share-app-icon.link { background: var(--border); color: var(--fg); }
    .share-app-icon.whatsapp { background: #25D366; }
    .share-app-icon.telegram { background: #2AABEE; }
    .share-app-icon.email { background: var(--border); color: var(--fg); }
    .share-app-icon.twitter { background: #000; }

    .share-app-label {
        font-size: 11px;
        color: var(--fg);
        text-align: center;
        white-space: nowrap;
    }

    @@media (max-width: 600px) {
        .share-modal-overlay {
            padding: 0;
            align-items: flex-end;
        }

        .share-modal {
            max-width: 100%;
            height: 85vh;
            max-height: none;
            border-radius: 16px 16px 0 0;
        }

        .share-contacts-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .share-contact-avatar {
            width: 56px;
            height: 56px;
        }
    }

</style>

<div class="detail-layout">
    <div class="content-card">
        <!-- HEADER -->
        <div class="content-header">
            @{
                // ⭐ Determinar URL según TipoLado
                var urlPerfil = Model.TipoLado == TipoLado.LadoB
                ? $"/Feed/Perfil/{Model.UsuarioId}?verSeudonimo=true"
                : $"/Feed/Perfil/{Model.UsuarioId}";
            }

            <div class="creator-info-wrapper">
                <a href="@urlPerfil" class="creator-info">
                    <div class="creator-avatar">
                        @if (!string.IsNullOrEmpty(Model.Usuario?.FotoPerfil))
                        {
                            <img src="@Model.Usuario.FotoPerfil" alt="@Model.NombreMostrado">
                        }
                        else
                        {
                            @(Model.NombreMostrado?.Substring(0, 1) ?? "U")
                        }
                    </div>
                    <div class="creator-details">
                    <h3>@(Model.NombreMostrado ?? "Usuario")</h3>
                    <span>
                        @* ⭐ Mostrar @ del usuario correcto *@
                        @if (Model.TipoLado == TipoLado.LadoB && !string.IsNullOrEmpty(Model.Usuario?.Seudonimo))
                        {
                            @:@@@(Model.Usuario.Seudonimo.ToLower())
                        }
                        else
                        {
                            @:@@@(Model.Usuario?.UserName ?? "usuario")
                        }
                        ·
                        @{
                            var tiempo = DateTime.Now - Model.FechaPublicacion;
                            var tiempoTexto = tiempo.TotalDays >= 1 ? $"{(int)tiempo.TotalDays}d" :
                            tiempo.TotalHours >= 1 ? $"{(int)tiempo.TotalHours}h" : $"{(int)tiempo.TotalMinutes}m";
                        }
                        Hace @tiempoTexto
                    </span>
                </div>
                </a>

                @* Botón Seguir (solo si no es propio y está autenticado) *@
                @if (estaAutenticado && !esPropio)
                {
                    <button type="button"
                            class="header-follow-btn @(estaSiguiendo ? "following" : "follow")"
                            id="btnHeaderFollow"
                            onclick="toggleHeaderFollow('@Model.UsuarioId', @((int)Model.TipoLado))">
                        @(estaSiguiendo ? "Siguiendo" : "Seguir")
                    </button>
                }

                @* Badge de seguidores en común (solo para usuarios autenticados) *@
                @if (estaAutenticado)
                {
                    <div class="seguidores-comun-badge" id="seguidoresEnComunBadge" style="display: none;" data-creador-id="@Model.UsuarioId">
                        <div class="seguidores-comun-avatars" id="seguidoresAvatars"></div>
                        <span class="seguidores-comun-count" id="seguidoresCount"></span>
                        <div class="seguidores-comun-tooltip" id="seguidoresTooltip"></div>
                    </div>
                }
            </div>
            <div class="post-menu" onclick="togglePostMenu(event, this)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="1.5"></circle>
                    <circle cx="6" cy="12" r="1.5"></circle>
                    <circle cx="18" cy="12" r="1.5"></circle>
                </svg>
                <div class="post-menu-dropdown" data-post-id="@Model.Id" data-user-id="@Model.UsuarioId" data-tipo-lado="@((int)Model.TipoLado)">
                    <button class="post-menu-item" onclick="copiarEnlace(@Model.Id)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        Copiar enlace
                    </button>
                    <button class="post-menu-item" onclick="agregarFavorito(@Model.Id, this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span class="fav-text">@(esFavorito ? "Quitar de favoritos" : "Agregar a favoritos")</span>
                    </button>
                    @if (!(ViewBag.EsPropio ?? false))
                    {
                        <div class="post-menu-divider"></div>
                        <button class="post-menu-item" onclick="dejarDeSeguir('@Model.UsuarioId', @((int)Model.TipoLado), this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            Dejar de seguir
                        </button>
                        <button class="post-menu-item danger" onclick="bloquearUsuario('@Model.UsuarioId', '@(Model.Usuario?.NombreCompleto ?? "este usuario")')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                            </svg>
                            Bloquear usuario
                        </button>
                        <button class="post-menu-item danger" onclick="reportarContenido(@Model.Id)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                <line x1="4" y1="22" x2="4" y2="15"></line>
                            </svg>
                            Reportar
                        </button>
                    }
                </div>
            </div>
        </div>

        @if (esPropio)
        {
            <!-- Toggle de Visibilidad (solo para el propietario) -->
            <div class="visibility-toggle-container">
                <div class="visibility-info">
                    <div class="visibility-icon">
                        @if (Model.EsPublicoGeneral)
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        }
                        else
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        }
                    </div>
                    <div class="visibility-text">
                        <span class="visibility-label" id="visibilityLabel">
                            @(Model.EsPublicoGeneral ? "Público" : "Solo seguidores")
                        </span>
                        <span class="visibility-desc" id="visibilityDesc">
                            @(Model.EsPublicoGeneral ? "Visible para todos, incluso sin cuenta" : "Solo visible para tus seguidores")
                        </span>
                    </div>
                </div>
                <label class="visibility-toggle" id="visibilityToggle">
                    <input type="checkbox"
                           id="visibilityCheckbox"
                           @(Model.EsPublicoGeneral ? "checked" : "")
                           onchange="toggleVisibility(@Model.Id, this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        }

        <!-- MEDIA -->
        <div class="content-media">
            @if (contenidoBloqueado)
            {
                <!-- Contenido bloqueado para usuarios no autenticados (estilo Instagram) -->
                @if ((int)Model.TipoContenido == 2)
                {
                    <video src="@(Model.Thumbnail ?? "/images/placeholder.jpg")" style="filter: blur(30px); pointer-events: none;" playsinline muted></video>
                }
                else
                {
                    <img src="@(Model.Thumbnail ?? Model.RutaArchivo ?? "/images/placeholder.jpg")" alt="Contenido bloqueado" style="filter: blur(30px);">
                }
                <div class="premium-overlay blocked-overlay">
                    <div class="premium-lock-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                    </div>
                    <h4>Contenido Exclusivo</h4>
                    <p>@mensajeBloqueo</p>
                    <div class="blocked-cta-buttons">
                        <a href="@Url.Action("Registro", "Account")" class="unlock-btn primary-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            Crear cuenta gratis
                        </a>
                        <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="unlock-btn secondary-btn">
                            Iniciar sesion
                        </a>
                    </div>
                </div>
            }
            else if (Model.EsPremium && !estaSuscrito)
            {
                @if ((int)Model.TipoContenido == 2)
                {
                    <video src="@Model.RutaArchivo" style="filter: blur(20px);" playsinline muted></video>
                }
                else
                {
                    <img src="@(Model.RutaArchivo ?? "/images/placeholder.jpg")" alt="Premium" style="filter: blur(20px);">
                }
                <div class="premium-overlay">
                    <div class="premium-lock-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                    </div>
                    <h4>Contenido Premium</h4>
                    <p>Suscríbete para desbloquear</p>
                    <button class="unlock-btn" onclick="window.location.href='/Feed/Perfil/@Model.UsuarioId'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                        </svg>
                        Suscribirse
                    </button>
                </div>
            }
            else if (esCarrusel)
            {
                <!-- Carrusel de múltiples archivos -->
                <div class="detail-carousel" id="detailCarousel">
                    <div class="carousel-container">
                        <div class="carousel-track">
                            @for (int i = 0; i < archivosCarrusel.Count; i++)
                            {
                                var archivo = archivosCarrusel[i];
                                var esArchivoVideo = archivo.TipoArchivo == Lado.Models.TipoArchivo.Video;
                                <div class="carousel-slide">
                                    @if (esArchivoVideo)
                                    {
                                        <video src="@archivo.RutaArchivo" class="carousel-media" controls playsinline preload="metadata"></video>
                                    }
                                    else
                                    {
                                        <img src="@archivo.RutaArchivo" alt="" class="carousel-media">
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    @if (archivosCarrusel.Count > 1)
                    {
                        <button class="carousel-btn carousel-prev" onclick="detailCarouselNav(-1)">
                            <svg viewBox="0 0 24 24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <button class="carousel-btn carousel-next" onclick="detailCarouselNav(1)">
                            <svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </button>
                        <div class="carousel-dots">
                            @for (int i = 0; i < archivosCarrusel.Count; i++)
                            {
                                <span class="carousel-dot @(i == 0 ? "active" : "")" data-index="@i" onclick="detailCarouselGoTo(@i)"></span>
                            }
                        </div>
                        <div class="carousel-counter">1/@archivosCarrusel.Count</div>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.RutaArchivo))
            {
                @if ((int)Model.TipoContenido == 2)
                {
                    <video src="@Model.RutaArchivo" controls></video>
                }
                else
                {
                    <div class="image-with-music-container" onclick="openCreatorFullscreen()" style="cursor: pointer;">
                        <img src="@Model.RutaArchivo" alt="Contenido">
                        @if (Model.PistaMusical != null)
                        {
                            <!-- Badge de musica -->
                            <div class="music-badge" id="musicBadge">
                                <div class="music-badge-icon">
                                    <svg viewBox="0 0 24 24" fill="white">
                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                    </svg>
                                </div>
                                <div class="music-badge-info">
                                    <div class="music-badge-title">@Model.PistaMusical.Titulo</div>
                                    <div class="music-badge-artist">@Model.PistaMusical.Artista</div>
                                </div>
                            </div>
                            <!-- Audio player oculto -->
                            <audio id="photoAudioPlayer"
                                   src="@Model.PistaMusical.RutaArchivo"
                                   preload="metadata"
                                   loop
                                   data-start="@(Model.AudioTrimInicio ?? 0)"
                                   data-volume="@(((double)(Model.MusicaVolumen ?? 0.7m)).ToString(System.Globalization.CultureInfo.InvariantCulture))">
                            </audio>
                        }
                    </div>
                }
            }

            @* Botón para abrir fullscreen viewer del creador *@
            @if (!Model.EsPremium || estaSuscrito)
            {
                <button class="explore-creator-btn" onclick="openCreatorFullscreen()" title="Ver más contenido de @creadorNombre">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
            }
        </div>

        <!-- ACCIONES -->
        <div class="content-actions">
            @if (estaAutenticado)
            {
                <div class="action-buttons">
                    <button class="action-btn like-btn" data-id="@Model.Id">
                        <svg viewBox="0 0 24 24">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                        </svg>
                    </button>

                    <button class="action-btn share-btn" data-id="@Model.Id" data-username="@Model.Usuario?.UserName">
                        <svg viewBox="0 0 24 24">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                        Compartir
                    </button>

                    <button class="action-btn dm-btn" onclick="enviarMensajeDirecto('@Model.UsuarioId', '@(Model.NombreMostrado ?? Model.Usuario?.NombreCompleto ?? "Usuario")')">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
                        </svg>
                        Mensaje
                    </button>

                    <button class="react-btn" onclick="abrirModalReacciones()">
                        <span style="font-size: 20px;">😊</span>
                        Reaccionar
                    </button>

                    <div class="action-spacer"></div>

                    <button class="action-btn bookmark-btn @(esFavorito ? "bookmarked" : "")" onclick="toggleBookmark(@Model.Id, this)" title="@(esFavorito ? "Quitar de favoritos" : "Agregar a favoritos")">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
            }
            else
            {
                <div class="auth-cta">
                    <p>Inicia sesion para interactuar con este contenido</p>
                    <div class="auth-cta-buttons">
                        <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="btn-login">Iniciar sesion</a>
                        <a href="@Url.Action("Registro", "Account")" class="btn-register">Crear cuenta</a>
                    </div>
                </div>
            }

            <!-- STATS -->
            <div class="content-stats">
                @{
                    var reaccionesDict = ViewBag.ReaccionesPorContenido as IDictionary<int, dynamic>;
                    var reaccionesContenido = reaccionesDict != null && reaccionesDict.ContainsKey(Model.Id)
                    ? reaccionesDict[Model.Id]
                    : null;
                    var totalReacciones = reaccionesContenido?.TotalReacciones ?? 0;
                }

                <div class="stat-item like-count" id="likes-container" data-contenido-id="@Model.Id">
                    @if (totalReacciones > 0)
                    {
                        <div class="reacciones-mini">
                            <span>❤️</span>
                            <span>🔥</span>
                            <span>😍</span>
                        </div>
                        <strong id="likesCount">@totalReacciones</strong>
                        <span>reacciones</span>
                    }
                    else
                    {
                        <strong id="likesCount">@Model.NumeroLikes</strong>
                        <span>likes</span>
                    }
                </div>

                <div class="stat-item">
                    <strong id="commentsCount">@Model.NumeroComentarios</strong>
                    <span>comentarios</span>
                </div>

                <div class="stat-item">
                    <strong>@Model.NumeroVistas</strong>
                    <span>vistas</span>
                </div>
            </div>
        </div>

        <!-- DESCRIPCIÓN -->
        @if (!string.IsNullOrEmpty(Model.Descripcion))
        {
            <div class="content-description">
                <p>@Model.Descripcion</p>
            </div>
        }

        <!-- COMENTARIOS -->
        <div class="comments-section">
            <div class="comments-header">
                <h3>Comentarios (@Model.NumeroComentarios)</h3>
            </div>

            <!-- FORMULARIO -->
            @if (estaAutenticado)
            {
                <div class="comment-form">
                    <textarea id="commentText"
                              class="comment-textarea"
                              placeholder="Escribe un comentario..."
                              rows="3"></textarea>
                    <div class="comment-actions">
                        <button type="button" class="btn-comment btn-cancel" onclick="limpiarComentario()">Cancelar</button>
                        <button type="button" class="btn-comment btn-submit" id="btnSubmit" disabled onclick="publicarComentario()">
                            Publicar
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="auth-cta" style="margin-bottom: 16px;">
                    <p><a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })">Inicia sesion</a> para dejar un comentario</p>
                </div>
            }

            <!-- LISTA -->
            <div id="commentsList">
                @if (Model.Comentarios != null && Model.Comentarios.Any())
                {
                    // Separar comentarios principales de respuestas - LIMITAR A 10 INICIALES
                    var comentariosPrincipales = Model.Comentarios
                        .Where(c => c.ComentarioPadreId == null)
                        .OrderByDescending(c => c.FechaCreacion)
                        .Take(10)  // Solo cargar 10 inicialmente
                        .ToList();
                    var totalComentariosPrincipales = Model.Comentarios.Count(c => c.ComentarioPadreId == null);
                    var respuestasPorPadre = Model.Comentarios.Where(c => c.ComentarioPadreId != null)
                        .GroupBy(c => c.ComentarioPadreId)
                        .ToDictionary(g => g.Key ?? 0, g => g.OrderBy(r => r.FechaCreacion).ToList());

                    foreach (var comentario in comentariosPrincipales)
                    {
                        var tiempoComent = DateTime.Now - comentario.FechaCreacion;
                        var tiempoTextoComent = tiempoComent.TotalDays >= 1 ? $"{(int)tiempoComent.TotalDays} h" :
                            tiempoComent.TotalHours >= 1 ? $"{(int)tiempoComent.TotalHours} h" : $"{(int)tiempoComent.TotalMinutes} m";
                        var numRespuestas = Model.Comentarios?.Count(c => c.ComentarioPadreId == comentario.Id) ?? 0;
                        var respuestasDelComentario = respuestasPorPadre.ContainsKey(comentario.Id) ? respuestasPorPadre[comentario.Id] : new List<Lado.Models.Comentario>();

                        <div class="comment-item comment-principal" data-comment-id="@comentario.Id">
                            <!-- Avatar con boton follow -->
                            <div class="comment-avatar-wrapper">
                                <div class="comment-avatar">
                                    @if (!string.IsNullOrEmpty(comentario.Usuario?.FotoPerfil))
                                    {
                                        <img src="@comentario.Usuario.FotoPerfil" alt="@comentario.Usuario.UserName">
                                    }
                                    else
                                    {
                                        <div class="comment-avatar-initial">@(comentario.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "U")</div>
                                    }
                                </div>
                                @if (estaAutenticado && comentario.UsuarioId != currentUserId)
                                {
                                    <button class="comment-follow-btn" onclick="event.stopPropagation();" title="Seguir">
                                        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="3" fill="none"/></svg>
                                    </button>
                                }
                            </div>

                            <!-- Contenido -->
                            <div class="comment-content">
                                <div class="comment-header">
                                    <a href="/Feed/Perfil/@comentario.Usuario?.UserName" class="comment-username">@(comentario.Usuario?.UserName ?? "usuario")</a>
                                    <span class="comment-time">@tiempoTextoComent</span>
                                    <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                                </div>

                                <p class="comment-text">@comentario.Texto</p>

                                <!-- Acciones estilo Instagram -->
                                <div class="comment-actions">
                                    <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(@comentario.Id, this)" data-comment-id="@comentario.Id">
                                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                        <span class="count">@(comentario.NumeroLikes > 0 ? comentario.NumeroLikes.ToString() : "")</span>
                                    </button>
                                    <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(@comentario.Id, '@comentario.Usuario?.UserName')">
                                        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                        <span class="count">@(numRespuestas > 0 ? numRespuestas.ToString() : "")</span>
                                    </button>
                                    <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                                        <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                                    </button>
                                    <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                                        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                    </button>
                                </div>

                                <!-- Mostrar respuestas con mini avatares -->
                                @if (numRespuestas > 0)
                                {
                                    <div class="show-replies-row" onclick="toggleRespuestas(@comentario.Id, this)">
                                        <div class="reply-mini-avatars">
                                            @foreach (var resp in respuestasDelComentario.Take(3))
                                            {
                                                if (!string.IsNullOrEmpty(resp.Usuario?.FotoPerfil))
                                                {
                                                    <img src="@resp.Usuario.FotoPerfil" alt="">
                                                }
                                                else
                                                {
                                                    <div class="mini-avatar-initial">@(resp.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "U")</div>
                                                }
                                            }
                                        </div>
                                        <span class="show-replies-text">Mostrar respuestas</span>
                                    </div>
                                }
                            </div>
                        </div>

                        @* Respuestas anidadas - LIMITAR A 3 INICIALES *@
                        @if (respuestasPorPadre.ContainsKey(comentario.Id))
                        {
                            var todasRespuestas = respuestasPorPadre[comentario.Id];
                            var respuestasIniciales = todasRespuestas.Take(3).ToList();
                            var totalRespuestas = todasRespuestas.Count;
                            <div class="respuestas-container ocultas" id="respuestas-@comentario.Id" data-total="@totalRespuestas" data-loaded="@respuestasIniciales.Count">
                                @foreach (var respuesta in respuestasIniciales)
                                {
                                    var tiempoResp = DateTime.Now - respuesta.FechaCreacion;
                                    var tiempoTextoResp = tiempoResp.TotalDays >= 1 ? $"{(int)tiempoResp.TotalDays} h" :
                                        tiempoResp.TotalHours >= 1 ? $"{(int)tiempoResp.TotalHours} h" : $"{(int)tiempoResp.TotalMinutes} m";

                                    <div class="comment-item comment-respuesta" data-comment-id="@respuesta.Id">
                                        <div class="comment-avatar-wrapper">
                                            <div class="comment-avatar">
                                                @if (!string.IsNullOrEmpty(respuesta.Usuario?.FotoPerfil))
                                                {
                                                    <img src="@respuesta.Usuario.FotoPerfil" alt="@respuesta.Usuario.UserName">
                                                }
                                                else
                                                {
                                                    <div class="comment-avatar-initial">@(respuesta.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "U")</div>
                                                }
                                            </div>
                                            @if (estaAutenticado && respuesta.UsuarioId != currentUserId)
                                            {
                                                <button class="comment-follow-btn" onclick="event.stopPropagation();" title="Seguir">
                                                    <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="3" fill="none"/></svg>
                                                </button>
                                            }
                                        </div>
                                        <div class="comment-content">
                                            <div class="comment-header">
                                                <a href="/Feed/Perfil/@respuesta.Usuario?.UserName" class="comment-username">@(respuesta.Usuario?.UserName ?? "usuario")</a>
                                                <span class="comment-time">@tiempoTextoResp</span>
                                                <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                                            </div>
                                            <p class="comment-text">@respuesta.Texto</p>
                                            <div class="comment-actions">
                                                <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(@respuesta.Id, this)" data-comment-id="@respuesta.Id">
                                                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                                    <span class="count">@(respuesta.NumeroLikes > 0 ? respuesta.NumeroLikes.ToString() : "")</span>
                                                </button>
                                                <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(@comentario.Id, '@respuesta.Usuario?.UserName')">
                                                    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                                </button>
                                                <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                                                    <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                                                </button>
                                                <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                                                    <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                                @* Botón para cargar más respuestas *@
                                @if (totalRespuestas > 3)
                                {
                                    <button class="load-more-replies-btn"
                                            id="load-more-replies-@comentario.Id"
                                            onclick="cargarMasRespuestas(@comentario.Id, this)"
                                            data-comment-id="@comentario.Id">
                                        <i class="fas fa-chevron-down"></i>
                                        Ver @(totalRespuestas - 3) respuestas más
                                    </button>
                                }
                            </div>
                        }

                        @* Formulario de respuesta (oculto por defecto) *@
                        <div class="reply-form-container" id="reply-form-@comentario.Id" style="display: none;">
                            <textarea class="reply-textarea" placeholder="Escribe tu respuesta..." rows="2"></textarea>
                            <div class="reply-actions">
                                <button type="button" class="btn-cancel-reply" onclick="ocultarFormularioRespuesta(@comentario.Id)">Cancelar</button>
                                <button type="button" class="btn-submit-reply" onclick="publicarRespuesta(@comentario.Id)">Responder</button>
                            </div>
                        </div>
                    }

                    @* Botón para cargar más comentarios *@
                    @if (totalComentariosPrincipales > 10)
                    {
                        <div id="loadMoreCommentsContainer" class="load-more-comments-container">
                            <button class="load-more-comments-btn"
                                    id="loadMoreCommentsBtn"
                                    onclick="cargarMasComentarios()"
                                    data-page="1"
                                    data-total="@totalComentariosPrincipales"
                                    data-contenido-id="@Model.Id">
                                <i class="fas fa-chevron-down"></i>
                                <span>Cargar más comentarios (@(totalComentariosPrincipales - 10) restantes)</span>
                            </button>
                        </div>
                    }
                }
                else
                {
                    <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                        <p>No hay comentarios aún. ¡Sé el primero en comentar!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- MODAL REACCIONES -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal()"></div>
<div class="modal-reacciones" id="modalReacciones">
    <h3>Reacciona a este contenido</h3>
    <div class="reacciones-grid">
        <button class="reaccion-btn" onclick="enviarReaccion('fire')">
            <span class="emoji">🔥</span>
            <span>Fuego</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('heart')">
            <span class="emoji">❤️</span>
            <span>Me encanta</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('wow')">
            <span class="emoji">😍</span>
            <span>Wow</span>
        </button>
        <button class="reaccion-btn" onclick="enviarReaccion('clap')">
            <span class="emoji">👏</span>
            <span>Aplauso</span>
        </button>
    </div>
    <button class="btn-comment btn-cancel" style="width: 100%;" onclick="cerrarModal()">Cancelar</button>
</div>

<!-- TOOLTIP DE LIKES (Desktop) -->
<div class="likes-tooltip" id="likesTooltip">
    <div class="likes-tooltip-header" id="likesTooltipHeader">Me gusta</div>
    <div class="likes-tooltip-list" id="likesTooltipList">
        <div class="likes-tooltip-loading">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </div>
</div>

<!-- MODAL DE LIKES (Móvil) -->
<div class="likes-modal-overlay" id="likesModalOverlay" onclick="closeLikesModal()">
    <div class="likes-modal" onclick="event.stopPropagation()">
        <div class="likes-modal-header">
            <span class="likes-modal-title">Me gusta</span>
            <button class="likes-modal-close" onclick="closeLikesModal()">&times;</button>
        </div>
        <div class="likes-modal-content">
            <div class="likes-modal-list" id="likesModalList">
                <div class="likes-tooltip-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal - Estilo Instagram -->
<div class="share-modal-overlay" id="shareModal" onclick="if(event.target===this)closeShareModal()">
    <div class="share-modal">
        <div class="share-modal-header">
            <button type="button" class="share-modal-close" id="btnCloseShareModal" onclick="event.stopPropagation();closeShareModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="pointer-events:none">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            Compartir
        </div>
        <div class="share-search-box">
            <div class="share-search-wrapper">
                <svg class="share-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" class="share-search-input" id="shareSearchInput" placeholder="Buscar">
            </div>
        </div>
        <div class="share-contacts-grid" id="shareContactsGrid">
            <div class="share-contacts-empty">Cargando contactos...</div>
        </div>
        <div class="share-apps-bar">
            <div class="share-app-item" onclick="copyShareUrl()">
                <div class="share-app-icon link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                </div>
                <span class="share-app-label">Copiar enlace</span>
            </div>
            <a class="share-app-item" id="shareWhatsApp" target="_blank">
                <div class="share-app-icon whatsapp">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                </div>
                <span class="share-app-label">WhatsApp</span>
            </a>
            <a class="share-app-item" id="shareTelegram" target="_blank">
                <div class="share-app-icon telegram">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                    </svg>
                </div>
                <span class="share-app-label">Telegram</span>
            </a>
            <a class="share-app-item" id="shareEmail" href="" target="_blank">
                <div class="share-app-icon email">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </div>
                <span class="share-app-label">Email</span>
            </a>
            <a class="share-app-item" id="shareTwitter" target="_blank">
                <div class="share-app-icon twitter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </div>
                <span class="share-app-label">X</span>
            </a>
        </div>
    </div>
</div>

<script>
    // Función de escape para prevenir XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ⭐ VARIABLES GLOBALES - DECLARADAS PRIMERO
    const contenidoId = @Model.Id;
    let commentText, btnSubmit;

    // ========================================
    // NOTIFICACIONES (definida globalmente para iOS)
    // ========================================
    function mostrarNotificacion(mensaje, tipo = 'success') {
        const notif = document.createElement('div');
        notif.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 20px;
            background: ${tipo === 'success' ? '#4682B4' : '#ef4444'};
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        `;
        notif.textContent = mensaje;
        document.body.appendChild(notif);

        setTimeout(() => {
            notif.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }

    // Estilos de animación para notificaciones
    (function() {
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @@keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    })();

    // ========================================
    // TOGGLE VISIBILIDAD
    // ========================================
    async function toggleVisibility(id, esPublico) {
        const toggle = document.getElementById('visibilityToggle');
        const checkbox = document.getElementById('visibilityCheckbox');
        const label = document.getElementById('visibilityLabel');
        const desc = document.getElementById('visibilityDesc');
        const iconContainer = document.querySelector('.visibility-icon');

        // Mostrar estado de carga
        toggle.classList.add('loading');

        try {
            const response = await fetch('/Feed/CambiarVisibilidad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: `id=${id}&esPublico=${esPublico}`
            });

            const result = await response.json();

            if (result.success) {
                // Actualizar UI
                label.textContent = esPublico ? 'Público' : 'Solo seguidores';
                desc.textContent = esPublico
                    ? 'Visible para todos, incluso sin cuenta'
                    : 'Solo visible para tus seguidores';

                // Actualizar icono
                iconContainer.innerHTML = esPublico
                    ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                       </svg>`
                    : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                       </svg>`;

                // Mostrar mensaje de éxito
                showToast('Éxito', result.message, 'success');
            } else {
                // Revertir el checkbox
                checkbox.checked = !esPublico;
                showToast('Error', result.message, 'error');
            }
        } catch (error) {
            checkbox.checked = !esPublico;
            showToast('Error', 'Error al cambiar visibilidad', 'error');
        } finally {
            toggle.classList.remove('loading');
        }
    }

    // Toast notification helper
    function showToast(title, message, type) {
        // Crear toast si no existe uno
        let toast = document.getElementById('toast-notification');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            document.body.appendChild(toast);
        }

        toast.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
        toast.textContent = message;
        toast.style.opacity = '1';

        setTimeout(() => {
            toast.style.opacity = '0';
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar elementos del DOM
        commentText = document.getElementById('commentText');
        btnSubmit = document.getElementById('btnSubmit');

        // ========================================
        // AUDIO PLAYER PARA FOTOS CON MUSICA
        // ========================================
        initPhotoAudioPlayer();

        function initPhotoAudioPlayer() {
            const audioPlayer = document.getElementById('photoAudioPlayer');
            const musicBadge = document.getElementById('musicBadge');

            if (!audioPlayer || !musicBadge) return;

            // Configurar volumen y tiempo inicial
            const startTime = parseFloat(audioPlayer.dataset.start) || 0;
            let volume = parseFloat(audioPlayer.dataset.volume) || 0.7;

            // Normalizar volumen al rango [0, 1]
            if (volume > 1) {
                volume = volume / 10;
            }
            volume = Math.min(1, Math.max(0, volume));

            audioPlayer.currentTime = startTime;
            audioPlayer.volume = volume;

            // Intentar reproducir automaticamente
            audioPlayer.play().then(() => {
                musicBadge.classList.add('playing');
            }).catch(() => {
            });

            // Click en el badge para play/pause
            musicBadge.addEventListener('click', function(e) {
                e.stopPropagation();

                if (audioPlayer.paused) {
                    audioPlayer.currentTime = startTime;
                    audioPlayer.volume = volume;
                    audioPlayer.play();
                    musicBadge.classList.add('playing');
                } else {
                    audioPlayer.pause();
                    musicBadge.classList.remove('playing');
                }
            });

            // Cuando el audio termina (aunque tiene loop, por si acaso)
            audioPlayer.addEventListener('ended', function() {
                musicBadge.classList.remove('playing');
            });
        }

        // ========================================
        // CARGAR ESTADO DE LIKE
        // ========================================
        cargarEstadoLike();

        async function cargarEstadoLike() {
            try {
                const response = await fetch('/Feed/ObtenerMisLikes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ contenidoIds: [contenidoId] })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.likesUsuario && data.likesUsuario.includes(contenidoId)) {
                        const likeBtn = document.querySelector('.like-btn');
                        if (likeBtn) {
                            likeBtn.classList.add('liked');
                        }
                    }
                }
            } catch (error) {
            }
        }

        // ========================================
        // LIKES
        // ========================================
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch(`/Contenido/Like/${contenidoId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.success) {
                            if (data.liked) {
                                this.classList.add('liked');
                            } else {
                                this.classList.remove('liked');
                            }

                            document.getElementById('likesCount').textContent = data.likes;

                            this.style.transform = 'scale(1.2)';
                            setTimeout(() => { this.style.transform = ''; }, 200);
                        }
                    }
                } catch (error) {
                }
            });
        }

        // ========================================
        // COMENTARIOS
        // ========================================
        commentText.addEventListener('input', function() {
            btnSubmit.disabled = this.value.trim() === '';
        });

        commentText.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!btnSubmit.disabled) {
                    publicarComentario();
                }
            }
        });

        // ========================================
        // MODAL REACCIONES
        // ========================================
        window.abrirModalReacciones = function() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('modalReacciones').style.display = 'block';
            document.body.style.overflow = 'hidden';
        };

        window.cerrarModal = function() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('modalReacciones').style.display = 'none';
            document.body.style.overflow = '';
        };

        window.enviarReaccion = async function(tipo) {
            try {
                const formData = new FormData();
                formData.append('contenidoId', contenidoId);
                formData.append('tipo', tipo);

                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Reacciones/Reaccionar', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.reacciones) {
                    actualizarVisualizacionReacciones(data.reacciones, data.totalReacciones);

                    const emoji = getEmoji(tipo);
                    crearAnimacionReaccion(emoji);

                    const reactBtn = document.querySelector('.react-btn');
                    if (reactBtn) {
                        reactBtn.style.animation = 'pulse 0.4s ease';
                        setTimeout(() => { reactBtn.style.animation = ''; }, 400);
                    }

                    mostrarNotificacion('¡Reacción enviada! ' + emoji, 'success');
                    cerrarModal();
                } else {
                    mostrarNotificacion(data.message || 'Error al reaccionar', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error al enviar reacción', 'error');
            }
        };

        function actualizarVisualizacionReacciones(reacciones, totalReacciones) {
            const likesContainer = document.getElementById('likes-container');
            
            if (totalReacciones > 0 && reacciones && reacciones.length > 0) {
                const emojiMap = {
                    'fire': '🔥',
                    'heart': '❤️',
                    'wow': '😍',
                    'clap': '👏'
                };

                let html = '<div class="reacciones-mini">';
                reacciones.forEach(r => {
                    const emoji = emojiMap[r.tipo.toLowerCase()] || '❓';
                    html += `<span title="${r.count} ${r.tipo}">${emoji}</span>`;
                });
                html += '</div>';
                html += `<strong id="likesCount">${totalReacciones}</strong>`;
                html += `<span>reacciones</span>`;

                likesContainer.innerHTML = html;
            }
        }

        function getEmoji(tipo) {
            const emojis = { 'fire': '🔥', 'heart': '❤️', 'wow': '😍', 'clap': '👏' };
            return emojis[tipo] || '😊';
        }

        function crearAnimacionReaccion(emoji) {
            const mediaContainer = document.querySelector('.content-media');

            if (!mediaContainer) return;

            const cantidad = Math.floor(Math.random() * 3) + 3;

            for (let i = 0; i < cantidad; i++) {
                setTimeout(() => {
                    const reactionElement = document.createElement('div');
                    reactionElement.className = 'reaction-float';
                    reactionElement.textContent = emoji;

                    const variants = ['', 'variant-1', 'variant-2'];
                    const directions = ['', 'left', 'right'];
                    reactionElement.classList.add(
                        variants[Math.floor(Math.random() * variants.length)],
                        directions[Math.floor(Math.random() * directions.length)]
                    );

                    const rect = mediaContainer.getBoundingClientRect();
                    const randomX = Math.random() * (rect.width - 60) + 30;
                    const randomY = Math.random() * (rect.height - 60) + rect.height * 0.5;

                    reactionElement.style.left = randomX + 'px';
                    reactionElement.style.top = randomY + 'px';

                    if (getComputedStyle(mediaContainer).position === 'static') {
                        mediaContainer.style.position = 'relative';
                    }

                    mediaContainer.appendChild(reactionElement);

                    setTimeout(() => {
                        reactionElement.remove();
                    }, 2200);
                }, i * 150);
            }
        }

        // ========================================
        // COMPARTIR - Modal estilo Instagram
        // ========================================
        let shareContactsData = [];
        const shareUrl = window.location.href;

        document.querySelector('.share-btn')?.addEventListener('click', function() {
            openShareModal();
        });

        function openShareModal() {
            // Actualizar URLs de redes sociales
            document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${encodeURIComponent('Mira esto: ' + shareUrl)}`;
            document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}`;
            document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}`;
            document.getElementById('shareEmail').href = `mailto:?subject=${encodeURIComponent('Mira esto')}&body=${encodeURIComponent(shareUrl)}`;

            // Limpiar búsqueda
            const searchInput = document.getElementById('shareSearchInput');
            if (searchInput) searchInput.value = '';

            // Cargar contactos
            cargarContactosGrid();

            // Mostrar modal
            document.getElementById('shareModal').classList.add('active');
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.classList.remove('active');
                console.log('Modal cerrado');
            }
        }

        // Delegación de eventos global (funciona siempre)
        document.addEventListener('click', function(e) {
            // Cerrar con botón X
            if (e.target.closest('#btnCloseShareModal')) {
                e.preventDefault();
                e.stopPropagation();
                closeShareModal();
                return;
            }

            // Cerrar con click en overlay
            const overlay = document.getElementById('shareModal');
            if (e.target === overlay) {
                closeShareModal();
            }
        }, true);

        // Tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('shareModal');
                if (modal && modal.classList.contains('active')) {
                    closeShareModal();
                }
            }
        });

        async function cargarContactosGrid() {
            const grid = document.getElementById('shareContactsGrid');
            grid.innerHTML = '<div class="share-contacts-empty">Cargando...</div>';

            try {
                const res = await fetch('/Feed/ObtenerSiguiendo');
                if (!res.ok) throw new Error('Error');

                shareContactsData = await res.json();
                renderizarContactosGrid(shareContactsData);
            } catch (err) {
                grid.innerHTML = '<div class="share-contacts-empty">Error al cargar contactos</div>';
            }
        }

        function renderizarContactosGrid(contactos) {
            const grid = document.getElementById('shareContactsGrid');

            if (!contactos || contactos.length === 0) {
                grid.innerHTML = '<div class="share-contacts-empty">No sigues a nadie aún</div>';
                return;
            }

            grid.innerHTML = contactos.map(contacto => {
                const inicial = (contacto.nombre?.charAt(0) || contacto.username?.charAt(0) || 'U').toUpperCase();
                const nombre = contacto.nombre || contacto.username || 'Usuario';
                const foto = contacto.fotoPerfil;

                return `
                <div class="share-contact-item" onclick="enviarAContacto('${escapeHtml(contacto.id)}', this)">
                    ${foto
                        ? `<img src="${escapeHtml(foto)}" alt="" class="share-contact-avatar" onerror="this.outerHTML='<div class=share-contact-avatar>${escapeHtml(inicial)}</div>';">`
                        : `<div class="share-contact-avatar">${escapeHtml(inicial)}</div>`
                    }
                    <span class="share-contact-name">${escapeHtml(nombre)}</span>
                </div>`;
            }).join('');
        }

        async function enviarAContacto(contactId, element) {
            if (element) element.style.opacity = '0.5';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                const res = await fetch('/Feed/EnviarAAmigos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        ContenidoId: contenidoId,
                        AmigosIds: [contactId],
                        Url: shareUrl
                    })
                });

                if (res.ok) {
                    mostrarNotificacion('Enviado ✓', 'success');
                } else {
                    mostrarNotificacion('Error al enviar', 'error');
                }
            } catch (err) {
                mostrarNotificacion('Error al enviar', 'error');
            } finally {
                if (element) element.style.opacity = '1';
            }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(shareUrl).then(() => {
                mostrarNotificacion('Enlace copiado ✓', 'success');
                closeShareModal();
            }).catch(() => {
                mostrarNotificacion('No se pudo copiar', 'error');
            });
        }

        // Búsqueda de contactos
        document.getElementById('shareSearchInput')?.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            if (!query) {
                renderizarContactosGrid(shareContactsData);
                return;
            }
            const filtered = shareContactsData.filter(c =>
                (c.nombre || '').toLowerCase().includes(query) ||
                (c.username || '').toLowerCase().includes(query)
            );
            renderizarContactosGrid(filtered);
        });

        // Cargar seguidores en común
        cargarSeguidoresEnComun();
    });

    // ========================================
    // SEGUIDORES EN COMÚN
    // ========================================
    async function cargarSeguidoresEnComun() {
        const badge = document.getElementById('seguidoresEnComunBadge');
        if (!badge) return;

        const creadorId = badge.dataset.creadorId;
        if (!creadorId) return;

        try {
            const response = await fetch(`/Feed/ObtenerSeguidoresEnComun?creadorId=${encodeURIComponent(creadorId)}`);
            const data = await response.json();

            if (data.success && data.total > 0) {
                const avatarsContainer = document.getElementById('seguidoresAvatars');
                const countSpan = document.getElementById('seguidoresCount');
                const tooltip = document.getElementById('seguidoresTooltip');

                // Mostrar hasta 3 avatares
                const seguidoresMostrar = data.seguidoresEnComun.slice(0, 3);
                let avatarsHtml = '';

                seguidoresMostrar.forEach(s => {
                    if (s.fotoPerfil) {
                        avatarsHtml += `<div class="seguidores-comun-avatar"><img src="${escapeHtml(s.fotoPerfil)}" alt="${escapeHtml(s.username)}"></div>`;
                    } else {
                        avatarsHtml += `<div class="seguidores-comun-avatar">${escapeHtml(s.nombreCompleto?.substring(0, 1) || 'U')}</div>`;
                    }
                });

                avatarsContainer.innerHTML = avatarsHtml;

                // Mostrar texto "+N" si hay más
                if (data.total > 3) {
                    countSpan.textContent = `+${data.total - 3}`;
                } else {
                    countSpan.style.display = 'none';
                }

                // Tooltip con nombres
                const nombres = data.seguidoresEnComun.map(s => s.nombreCompleto || s.username).join(', ');
                tooltip.textContent = `${data.total} seguidor${data.total > 1 ? 'es' : ''} en común: ${nombres}`;

                badge.style.display = 'flex';
            }
        } catch (error) {
        }
    }

    // ========================================
    // FUNCIONES GLOBALES
    // ========================================
    function limpiarComentario() {
        commentText.value = '';
        btnSubmit.disabled = true;
    }

    async function publicarComentario() {
        const texto = commentText.value.trim();
        if (!texto) return;

        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Publicando...';

        try {
            const formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
            formData.append('id', contenidoId);
            formData.append('texto', texto);

            const response = await fetch('/Feed/Comentar', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('commentsCount').textContent = data.totalComentarios;

                const commentsList = document.getElementById('commentsList');
                const emptyMessage = commentsList.querySelector('[style*="text-align: center"]');
                if (emptyMessage) {
                    emptyMessage.remove();
                }

                const newComment = document.createElement('div');
                newComment.className = 'comment-item comment-principal';
                newComment.setAttribute('data-comment-id', data.comentario.id);

                let avatarHtml = '';
                if (data.comentario.avatar) {
                    avatarHtml = `<img src="${escapeHtml(data.comentario.avatar)}" alt="${escapeHtml(data.comentario.username)}">`;
                } else {
                    avatarHtml = `<div class="comment-avatar-initial">${escapeHtml(data.comentario.username?.substring(0, 1).toUpperCase() || 'U')}</div>`;
                }

                newComment.innerHTML = `
                    <div class="comment-avatar-wrapper">
                        <div class="comment-avatar">${avatarHtml}</div>
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="/Feed/Perfil/${escapeHtml(data.comentario.username)}" class="comment-username">${escapeHtml(data.comentario.username)}</a>
                            <span class="comment-time">Ahora</span>
                            <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                        </div>
                        <p class="comment-text">${escapeHtml(texto)}</p>
                        <div class="comment-actions">
                            <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(${data.comentario.id}, this)" data-comment-id="${data.comentario.id}">
                                <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                <span class="count"></span>
                            </button>
                            <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(${data.comentario.id}, '${escapeHtml(data.comentario.username)}')">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                <span class="count"></span>
                            </button>
                            <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                                <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                            </button>
                            <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                                <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                            </button>
                        </div>
                    </div>
                `;

                commentsList.insertBefore(newComment, commentsList.firstChild);

                limpiarComentario();
                mostrarNotificacion('Comentario publicado ✓', 'success');
            } else {
                mostrarNotificacion(data.message || 'Error al publicar', 'error');
            }
        } catch (error) {
            mostrarNotificacion('Error al publicar comentario', 'error');
        } finally {
            btnSubmit.textContent = 'Publicar';
        }
    }

    // ========================================
    // LIKES EN COMENTARIOS
    // ========================================

    async function toggleLikeComentario(comentarioId, btn) {
        try {
            const svg = btn.querySelector('svg');
            const countSpan = btn.querySelector('.count');
            const isLiked = svg.classList.contains('liked');

            // Actualización optimista
            if (isLiked) {
                svg.classList.remove('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount > 1 ? currentCount - 1 : '';
            } else {
                svg.classList.add('liked');
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = currentCount + 1;
            }

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const response = await fetch('/Feed/ToggleLikeComentario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comentarioId=${comentarioId}&__RequestVerificationToken=${encodeURIComponent(token || '')}`
            });

            const data = await response.json();

            if (data.success) {
                // Sincronizar con el servidor
                countSpan.textContent = data.likes > 0 ? data.likes : '';
                if (data.meDioLike) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            } else {
                // Revertir cambio optimista
                if (isLiked) {
                    svg.classList.add('liked');
                } else {
                    svg.classList.remove('liked');
                }
            }
        } catch (error) {
        }
    }

    // ========================================
    // FUNCIONES DE RESPUESTAS EN HILO
    // ========================================

    function mostrarFormularioRespuesta(comentarioId, username) {
        // Ocultar otros formularios de respuesta abiertos
        document.querySelectorAll('.reply-form-container').forEach(form => {
            form.style.display = 'none';
        });

        const formContainer = document.getElementById(`reply-form-${comentarioId}`);
        if (formContainer) {
            formContainer.style.display = 'block';
            const textarea = formContainer.querySelector('.reply-textarea');
            if (textarea) {
                textarea.focus();
                if (username) {
                    textarea.placeholder = 'Responder a @("@")' + username + '...';
                }
            }
        }
    }

    function ocultarFormularioRespuesta(comentarioId) {
        const formContainer = document.getElementById(`reply-form-${comentarioId}`);
        if (formContainer) {
            formContainer.style.display = 'none';
            const textarea = formContainer.querySelector('.reply-textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }

    async function publicarRespuesta(comentarioPadreId) {
        const formContainer = document.getElementById(`reply-form-${comentarioPadreId}`);
        const textarea = formContainer.querySelector('.reply-textarea');
        const texto = textarea.value.trim();

        if (!texto) {
            mostrarNotificacion('Escribe una respuesta', 'error');
            return;
        }

        const submitBtn = formContainer.querySelector('.btn-submit-reply');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Publicando...';

        try {
            const formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
            formData.append('id', contenidoId);
            formData.append('texto', texto);
            formData.append('comentarioPadreId', comentarioPadreId);

            const response = await fetch('/Feed/Comentar', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('commentsCount').textContent = data.totalComentarios;

                // Buscar o crear el contenedor de respuestas
                let respuestasContainer = document.getElementById(`respuestas-${comentarioPadreId}`);
                if (!respuestasContainer) {
                    respuestasContainer = document.createElement('div');
                    respuestasContainer.className = 'respuestas-container';
                    respuestasContainer.id = `respuestas-${comentarioPadreId}`;
                    respuestasContainer.innerHTML = '<div class="respuestas-lista"></div>';

                    // Insertar después del comentario padre
                    const comentarioPadre = document.querySelector(`[data-comment-id="${comentarioPadreId}"]`);
                    if (comentarioPadre) {
                        comentarioPadre.after(respuestasContainer);
                    }
                }

                let respuestasLista = respuestasContainer.querySelector('.respuestas-lista');
                if (!respuestasLista) {
                    respuestasLista = document.createElement('div');
                    respuestasLista.className = 'respuestas-lista';
                    respuestasContainer.appendChild(respuestasLista);
                }
                respuestasLista.classList.remove('ocultas');

                // Crear el nuevo elemento de respuesta
                const newReply = document.createElement('div');
                newReply.className = 'comment-item comment-respuesta';
                newReply.setAttribute('data-comment-id', data.comentario.id);

                let avatarHtml = '';
                if (data.comentario.avatar) {
                    avatarHtml = `<img src="${escapeHtml(data.comentario.avatar)}" alt="${escapeHtml(data.comentario.username)}">`;
                } else {
                    avatarHtml = `<div class="comment-avatar-initial">${escapeHtml(data.comentario.username?.substring(0, 1).toUpperCase() || 'U')}</div>`;
                }

                newReply.innerHTML = `
                    <div class="comment-avatar-wrapper">
                        <div class="comment-avatar">${avatarHtml}</div>
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="/Feed/Perfil/${escapeHtml(data.comentario.username)}" class="comment-username">${escapeHtml(data.comentario.username)}</a>
                            <span class="comment-time">Ahora</span>
                            <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                        </div>
                        <p class="comment-text">${escapeHtml(texto)}</p>
                        <div class="comment-actions">
                            <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(${data.comentario.id}, this)" data-comment-id="${data.comentario.id}">
                                <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                <span class="count"></span>
                            </button>
                            <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(${comentarioPadreId}, '${escapeHtml(data.comentario.username)}')">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            </button>
                            <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                                <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                            </button>
                            <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                                <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                            </button>
                        </div>
                    </div>
                `;

                respuestasLista.appendChild(newReply);

                ocultarFormularioRespuesta(comentarioPadreId);
                mostrarNotificacion('Respuesta publicada ✓', 'success');
            } else {
                mostrarNotificacion(data.message || 'Error al publicar respuesta', 'error');
            }
        } catch (error) {
            mostrarNotificacion('Error al publicar respuesta', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Responder';
        }
    }

    function toggleRespuestas(comentarioId, button) {
        const respuestasLista = document.querySelector(`#respuestas-${comentarioId} .respuestas-lista`);
        if (respuestasLista) {
            respuestasLista.classList.toggle('ocultas');
            if (respuestasLista.classList.contains('ocultas')) {
                button.textContent = button.textContent.replace('Ocultar', 'Ver');
            } else {
                button.textContent = button.textContent.replace('Ver', 'Ocultar');
            }
        }
    }

    // ========================================
    // CARGAR MÁS COMENTARIOS (PAGINACIÓN)
    // ========================================

    async function cargarMasComentarios() {
        const btn = document.getElementById('loadMoreCommentsBtn');
        if (!btn || btn.disabled) return;

        const currentPage = parseInt(btn.dataset.page) || 1;
        const total = parseInt(btn.dataset.total) || 0;
        const contenidoIdVal = parseInt(btn.dataset.contenidoId);
        const pageSize = 10;

        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Cargando...</span>';

        try {
            const response = await fetch(`/Feed/ObtenerComentarios?contenidoId=${contenidoIdVal}&page=${currentPage + 1}&pageSize=${pageSize}`);
            const data = await response.json();

            if (data.success && data.comentarios && data.comentarios.length > 0) {
                const commentsList = document.getElementById('commentsList');

                for (const comentario of data.comentarios) {
                    const commentHtml = renderComentarioHtml(comentario);
                    // Insertar antes del contenedor de "cargar más"
                    const loadMoreContainer = document.getElementById('loadMoreCommentsContainer');
                    if (loadMoreContainer) {
                        loadMoreContainer.insertAdjacentHTML('beforebegin', commentHtml);
                    } else {
                        commentsList.insertAdjacentHTML('beforeend', commentHtml);
                    }
                }

                // Actualizar el botón
                const loaded = (currentPage + 1) * pageSize;
                const remaining = total - loaded;

                if (remaining > 0) {
                    btn.dataset.page = currentPage + 1;
                    btn.innerHTML = `<i class="fas fa-chevron-down"></i> <span>Cargar más comentarios (${remaining} restantes)</span>`;
                    btn.disabled = false;
                } else {
                    // Ocultar botón si no hay más
                    const container = document.getElementById('loadMoreCommentsContainer');
                    if (container) container.style.display = 'none';
                }
            } else {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Error al cargar comentarios:', error);
            mostrarNotificacion('Error al cargar comentarios', 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    function renderComentarioHtml(comentario) {
        const tiempo = calcularTiempoRelativo(new Date(comentario.fechaCreacion));
        const username = comentario.usuario?.username || 'usuario';
        const foto = comentario.usuario?.fotoPerfil;
        const likedClass = comentario.meDioLike ? 'liked' : '';
        const likesCount = comentario.numeroLikes > 0 ? comentario.numeroLikes : '';
        const respuestasCount = comentario.totalRespuestas || 0;

        let avatarHtml = foto
            ? `<img src="${escapeHtml(foto)}" alt="${escapeHtml(username)}">`
            : `<div class="comment-avatar-initial">${escapeHtml(username.substring(0, 1).toUpperCase())}</div>`;

        let respuestasHtml = '';
        if (comentario.respuestas && comentario.respuestas.length > 0) {
            const respuestasIniciales = comentario.respuestas.slice(0, 3);
            const respuestasListHtml = respuestasIniciales.map(r => renderRespuestaHtml(r, comentario.id)).join('');
            const masRespuestas = respuestasCount > 3
                ? `<button class="load-more-replies-btn" id="load-more-replies-${comentario.id}" onclick="cargarMasRespuestas(${comentario.id}, this)" data-comment-id="${comentario.id}"><i class="fas fa-chevron-down"></i> Ver ${respuestasCount - 3} respuestas más</button>`
                : '';
            respuestasHtml = `<div class="respuestas-container" id="respuestas-${comentario.id}" data-total="${respuestasCount}" data-loaded="${respuestasIniciales.length}">${respuestasListHtml}${masRespuestas}</div>`;
        }

        return `
            <div class="comment-item comment-principal" data-comment-id="${comentario.id}">
                <div class="comment-avatar-wrapper">
                    <div class="comment-avatar">${avatarHtml}</div>
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <a href="/Feed/Perfil/${escapeHtml(username)}" class="comment-username">${escapeHtml(username)}</a>
                        <span class="comment-time">${tiempo}</span>
                        <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                    </div>
                    <p class="comment-text">${escapeHtml(comentario.texto)}</p>
                    <div class="comment-actions">
                        <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(${comentario.id}, this)" data-comment-id="${comentario.id}">
                            <svg class="${likedClass}" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            <span class="count">${likesCount}</span>
                        </button>
                        <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(${comentario.id}, '${escapeHtml(username)}')">
                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            <span class="count">${respuestasCount > 0 ? respuestasCount : ''}</span>
                        </button>
                        <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                            <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                        </button>
                        <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                            <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="reply-form-container" id="reply-form-${comentario.id}" style="display: none;">
                <textarea class="reply-textarea" placeholder="Escribe tu respuesta..." rows="2"></textarea>
                <div class="reply-actions">
                    <button type="button" class="btn-cancel-reply" onclick="ocultarFormularioRespuesta(${comentario.id})">Cancelar</button>
                    <button type="button" class="btn-submit-reply" onclick="publicarRespuesta(${comentario.id})">Responder</button>
                </div>
            </div>
            ${respuestasHtml}
        `;
    }

    function renderRespuestaHtml(respuesta, comentarioPadreId) {
        const tiempo = calcularTiempoRelativo(new Date(respuesta.fechaCreacion));
        const username = respuesta.usuario?.username || 'usuario';
        const foto = respuesta.usuario?.fotoPerfil;
        const likedClass = respuesta.meDioLike ? 'liked' : '';
        const likesCount = respuesta.numeroLikes > 0 ? respuesta.numeroLikes : '';

        let avatarHtml = foto
            ? `<img src="${escapeHtml(foto)}" alt="${escapeHtml(username)}">`
            : `<div class="comment-avatar-initial">${escapeHtml(username.substring(0, 1).toUpperCase())}</div>`;

        return `
            <div class="comment-item comment-respuesta" data-comment-id="${respuesta.id}">
                <div class="comment-avatar-wrapper">
                    <div class="comment-avatar">${avatarHtml}</div>
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <a href="/Feed/Perfil/${escapeHtml(username)}" class="comment-username">${escapeHtml(username)}</a>
                        <span class="comment-time">${tiempo}</span>
                        <button class="comment-menu-btn" onclick="event.stopPropagation();">...</button>
                    </div>
                    <p class="comment-text">${escapeHtml(respuesta.texto)}</p>
                    <div class="comment-actions">
                        <button class="comment-action-btn like-btn" onclick="toggleLikeComentario(${respuesta.id}, this)" data-comment-id="${respuesta.id}">
                            <svg class="${likedClass}" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            <span class="count">${likesCount}</span>
                        </button>
                        <button class="comment-action-btn reply-btn" onclick="mostrarFormularioRespuesta(${comentarioPadreId}, '${escapeHtml(username)}')">
                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </button>
                        <button class="comment-action-btn repost-btn" onclick="event.stopPropagation();">
                            <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                        </button>
                        <button class="comment-action-btn share-btn" onclick="event.stopPropagation();">
                            <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function calcularTiempoRelativo(fecha) {
        const ahora = new Date();
        const diff = ahora - fecha;
        const minutos = Math.floor(diff / 60000);
        const horas = Math.floor(diff / 3600000);
        const dias = Math.floor(diff / 86400000);

        if (minutos < 1) return 'Ahora';
        if (minutos < 60) return `${minutos} m`;
        if (horas < 24) return `${horas} h`;
        if (dias < 7) return `${dias} d`;
        return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }

    // ========================================
    // CARGAR MÁS RESPUESTAS (PAGINACIÓN)
    // ========================================

    async function cargarMasRespuestas(comentarioId, btn) {
        if (!btn || btn.disabled) return;

        const container = document.getElementById(`respuestas-${comentarioId}`);
        if (!container) return;

        const total = parseInt(container.dataset.total) || 0;
        const loaded = parseInt(container.dataset.loaded) || 0;

        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

        try {
            const response = await fetch(`/Feed/ObtenerRespuestasComentario?comentarioId=${comentarioId}&skip=${loaded}&take=10`);
            const data = await response.json();

            if (data.success && data.respuestas && data.respuestas.length > 0) {
                // Insertar respuestas antes del botón
                for (const respuesta of data.respuestas) {
                    const respuestaHtml = renderRespuestaHtml(respuesta, comentarioId);
                    btn.insertAdjacentHTML('beforebegin', respuestaHtml);
                }

                // Actualizar contador
                const newLoaded = loaded + data.respuestas.length;
                container.dataset.loaded = newLoaded;

                const remaining = total - newLoaded;
                if (remaining > 0) {
                    btn.innerHTML = `<i class="fas fa-chevron-down"></i> Ver ${remaining} respuestas más`;
                    btn.disabled = false;
                } else {
                    // Ocultar botón
                    btn.style.display = 'none';
                }
            } else {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Error al cargar respuestas:', error);
            mostrarNotificacion('Error al cargar respuestas', 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Función para enviar mensaje directo
    function enviarMensajeDirecto(userId, nombreUsuario) {
        // Verificar si existe el chat flotante en el layout
        if (typeof window.openChat === 'function') {
            // Usar el chat flotante
            window.openChat(userId, nombreUsuario);
        } else {
            // Redirigir a la página de mensajes con el usuario preseleccionado
            window.location.href = `/Mensajes?userId=${userId}`;
        }
    }

    // ========================================
    // FUNCIONES DEL MENÚ DROPDOWN
    // ========================================

    // Toggle del menú de post
    function togglePostMenu(e, element) {
        e.stopPropagation();
        const dropdown = element.querySelector('.post-menu-dropdown');

        // Cerrar otros dropdowns abiertos
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            if (d !== dropdown) d.classList.remove('show');
        });

        dropdown.classList.toggle('show');
    }

    // Cerrar menús al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Copiar enlace
    function copiarEnlace(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Enlace copiado al portapapeles');
        }).catch(() => {
            showToast('Error al copiar enlace');
        });
        cerrarMenus();
    }

    // Agregar/quitar favorito desde el menú
    async function agregarFavorito(postId, btn) {
        try {
            const res = await fetch('/Feed/ToggleFavorito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}`
            });
            const data = await res.json();

            if (data.success) {
                // Actualizar texto del botón del menú
                const favText = btn.querySelector('.fav-text');
                if (favText) {
                    favText.textContent = data.esFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos';
                }

                // Actualizar botón de bookmark
                const bookmarkBtn = document.querySelector('.bookmark-btn');
                if (bookmarkBtn) {
                    if (data.esFavorito) {
                        bookmarkBtn.classList.add('bookmarked');
                        bookmarkBtn.title = 'Quitar de favoritos';
                    } else {
                        bookmarkBtn.classList.remove('bookmarked');
                        bookmarkBtn.title = 'Agregar a favoritos';
                    }
                }

                showToast(data.message);
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
        cerrarMenus();
    }

    // Toggle bookmark desde el botón principal
    async function toggleBookmark(postId, btn) {
        try {
            const res = await fetch('/Feed/ToggleFavorito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}`
            });
            const data = await res.json();

            if (data.success) {
                if (data.esFavorito) {
                    btn.classList.add('bookmarked');
                    btn.title = 'Quitar de favoritos';
                } else {
                    btn.classList.remove('bookmarked');
                    btn.title = 'Agregar a favoritos';
                }

                // Actualizar texto en el menú dropdown si existe
                const menuFavText = document.querySelector('.post-menu-dropdown .fav-text');
                if (menuFavText) {
                    menuFavText.textContent = data.esFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos';
                }

                // Animación
                btn.style.transform = 'scale(1.2)';
                setTimeout(() => { btn.style.transform = ''; }, 200);

                showToast(data.message);
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
    }

    // Dejar de seguir
    async function dejarDeSeguir(userId, tipoLado, btn) {
        try {
            const res = await fetch('/Feed/DejarDeSeguir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                showToast(data.message || 'Has dejado de seguir a este usuario');
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            showToast('Error al procesar');
        }
        cerrarMenus();
    }

    // Toggle seguir/dejar de seguir desde header
    async function toggleHeaderFollow(userId, tipoLado) {
        const btn = document.getElementById('btnHeaderFollow');
        if (!btn) return;

        const isFollowing = btn.classList.contains('following');
        btn.disabled = true;

        try {
            const endpoint = isFollowing ? '/Feed/DejarDeSeguir' : '/Feed/Seguir';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${userId}&tipoLado=${tipoLado}`
            });
            const data = await res.json();

            if (data.success) {
                if (isFollowing) {
                    btn.classList.remove('following');
                    btn.classList.add('follow');
                    btn.textContent = 'Seguir';
                    showToast('Has dejado de seguir');
                } else {
                    btn.classList.remove('follow');
                    btn.classList.add('following');
                    btn.textContent = 'Siguiendo';
                    showToast('Ahora sigues a este usuario');
                }
            } else {
                showToast(data.message || 'Error al procesar');
            }
        } catch (err) {
            showToast('Error al procesar');
        } finally {
            btn.disabled = false;
        }
    }

    // Reportar contenido
    function reportarContenido(postId) {
        const motivo = prompt('Por favor, indica el motivo del reporte:');
        if (motivo) {
            fetch('/Feed/Reportar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${postId}&motivo=${encodeURIComponent(motivo)}`
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.message || (data.success ? 'Reporte enviado' : 'Error al reportar'));
            })
            .catch(() => showToast('Error al enviar reporte'));
        }
        cerrarMenus();
    }

    // Cerrar todos los menús
    function cerrarMenus() {
        document.querySelectorAll('.post-menu-dropdown.show').forEach(d => {
            d.classList.remove('show');
        });
    }

    // Toast notification
    function showToast(message) {
        // Remover toast existente si hay
        const existingToast = document.getElementById('toast-notification');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.cssText = `
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #262626;
            color: #fff;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 999999;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Mostrar
        setTimeout(() => {
            toast.style.transform = 'translateX(-50%) translateY(0)';
            toast.style.opacity = '1';
        }, 10);

        // Ocultar
        setTimeout(() => {
            toast.style.transform = 'translateX(-50%) translateY(100px)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }

    // ========================================
    // FUNCIONES DEL CARRUSEL EN DETALLE
    // ========================================

    let detailCarouselIndex = 0;
    const detailCarousel = document.getElementById('detailCarousel');

    function detailCarouselNav(direction) {
        if (!detailCarousel) return;

        const track = detailCarousel.querySelector('.carousel-track');
        const slides = detailCarousel.querySelectorAll('.carousel-slide');
        const totalSlides = slides.length;

        let newIndex = detailCarouselIndex + direction;
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= totalSlides) newIndex = totalSlides - 1;
        if (newIndex === detailCarouselIndex) return;

        detailCarouselIndex = newIndex;
        updateDetailCarousel();
    }

    function detailCarouselGoTo(index) {
        if (!detailCarousel) return;
        detailCarouselIndex = index;
        updateDetailCarousel();
    }

    function updateDetailCarousel() {
        if (!detailCarousel) return;

        const track = detailCarousel.querySelector('.carousel-track');
        const slides = detailCarousel.querySelectorAll('.carousel-slide');
        const dots = detailCarousel.querySelectorAll('.carousel-dot');
        const counter = detailCarousel.querySelector('.carousel-counter');
        const prevBtn = detailCarousel.querySelector('.carousel-prev');
        const nextBtn = detailCarousel.querySelector('.carousel-next');
        const totalSlides = slides.length;

        const offset = -detailCarouselIndex * 100;
        track.style.transform = `translateX(${offset}%)`;

        dots.forEach((dot, i) => dot.classList.toggle('active', i === detailCarouselIndex));
        if (counter) counter.textContent = `${detailCarouselIndex + 1}/${totalSlides}`;
        if (prevBtn) prevBtn.classList.toggle('hidden', detailCarouselIndex === 0);
        if (nextBtn) nextBtn.classList.toggle('hidden', detailCarouselIndex === totalSlides - 1);
    }

    // Inicializar carrusel si existe
    if (detailCarousel) {
        const prevBtn = detailCarousel.querySelector('.carousel-prev');
        if (prevBtn) prevBtn.classList.add('hidden');

        // Soporte táctil
        let startX = 0;
        let isDragging = false;

        detailCarousel.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
        }, { passive: true });

        detailCarousel.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                detailCarouselNav(diff > 0 ? 1 : -1);
            }
        }, { passive: true });
    }

    // ========================================
    // TOOLTIP DE LIKES (Desktop hover + Mobile long press)
    // ========================================

    let likesTooltipTimeout = null;
    let likesCache = {};
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 500;

    function isTouchDevice() {
        return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    async function fetchLikesUsuarios(contenidoId) {
        const cached = likesCache[contenidoId];
        if (cached && (Date.now() - cached.timestamp) < 300000) {
            return cached.data;
        }

        try {
            const response = await fetch(`/Feed/ObtenerLikesUsuarios?contenidoId=${contenidoId}&limit=10`);
            const data = await response.json();

            if (data.success) {
                likesCache[contenidoId] = { data: data, timestamp: Date.now() };
                return data;
            }
            return null;
        } catch (error) {
            return null;
        }
    }

    function renderLikesUsuarios(usuarios, total, hayMas, isModal = false) {
        if (!usuarios || usuarios.length === 0) {
            return isModal
                ? '<div class="likes-modal-empty"><i class="far fa-heart"></i><p>Aún no hay likes</p></div>'
                : '<div class="likes-tooltip-loading">Sin likes aún</div>';
        }

        const prefix = isModal ? 'likes-modal' : 'likes-tooltip';
        let html = '';

        usuarios.forEach(u => {
            const verifiedBadge = u.esVerificado ? '<i class="fas fa-check-circle verified"></i>' : '';
            html += `
                <a href="/Feed/Perfil/${u.id}" class="${prefix}-user">
                    <img src="${u.foto}" alt="" class="${prefix}-avatar" onerror="this.src='/images/default-avatar.svg'">
                    <div class="${prefix}-info">
                        <div class="${prefix}-username">${escapeHtml(u.username)}${verifiedBadge}</div>
                        <div class="${prefix}-name">${escapeHtml(u.nombre)}</div>
                    </div>
                </a>
            `;
        });

        if (hayMas && !isModal) {
            html += `<div class="likes-tooltip-more">y ${total - usuarios.length} más...</div>`;
        }

        return html;
    }

    function showLikesTooltip(element, contenidoId) {
        if (isTouchDevice()) return;

        const tooltip = document.getElementById('likesTooltip');
        const list = document.getElementById('likesTooltipList');

        const rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';

        list.innerHTML = '<div class="likes-tooltip-loading"><i class="fas fa-spinner fa-spin"></i></div>';
        tooltip.classList.add('visible');

        fetchLikesUsuarios(contenidoId).then(data => {
            if (data) {
                document.getElementById('likesTooltipHeader').textContent = `${data.total} Me gusta`;
                list.innerHTML = renderLikesUsuarios(data.usuarios, data.total, data.hayMas, false);
            } else {
                list.innerHTML = '<div class="likes-tooltip-loading">Error al cargar</div>';
            }
        });
    }

    function hideLikesTooltip() {
        document.getElementById('likesTooltip').classList.remove('visible');
    }

    function showLikesModal(contenidoId) {
        const overlay = document.getElementById('likesModalOverlay');
        const list = document.getElementById('likesModalList');

        list.innerHTML = '<div class="likes-tooltip-loading"><i class="fas fa-spinner fa-spin"></i></div>';
        overlay.classList.add('visible');
        document.body.style.overflow = 'hidden';

        fetchLikesUsuarios(contenidoId).then(data => {
            if (data) {
                list.innerHTML = renderLikesUsuarios(data.usuarios, data.total, data.hayMas, true);
            } else {
                list.innerHTML = '<div class="likes-modal-empty"><i class="fas fa-exclamation-circle"></i><p>Error al cargar</p></div>';
            }
        });
    }

    function closeLikesModal() {
        document.getElementById('likesModalOverlay').classList.remove('visible');
        document.body.style.overflow = '';
    }

    // Inicializar eventos en el contador de likes
    document.addEventListener('DOMContentLoaded', function() {
        const likesEl = document.querySelector('.like-count');
        if (!likesEl) return;

        const postId = likesEl.dataset.contenidoId;
        if (!postId) return;

        // Desktop: hover
        likesEl.addEventListener('mouseenter', function() {
            clearTimeout(likesTooltipTimeout);
            likesTooltipTimeout = setTimeout(() => {
                showLikesTooltip(this, postId);
            }, 300);
        });

        likesEl.addEventListener('mouseleave', function() {
            clearTimeout(likesTooltipTimeout);
            likesTooltipTimeout = setTimeout(() => {
                hideLikesTooltip();
            }, 200);
        });

        // Móvil: long press
        likesEl.addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(() => {
                e.preventDefault();
                showLikesModal(postId);
            }, LONG_PRESS_DURATION);
        }, { passive: false });

        likesEl.addEventListener('touchend', function() {
            clearTimeout(longPressTimer);
        });

        likesEl.addEventListener('touchmove', function() {
            clearTimeout(longPressTimer);
        });

        // Mantener tooltip visible al hover sobre él
        const tooltip = document.getElementById('likesTooltip');
        tooltip.addEventListener('mouseenter', function() {
            clearTimeout(likesTooltipTimeout);
        });

        tooltip.addEventListener('mouseleave', function() {
            likesTooltipTimeout = setTimeout(() => {
                hideLikesTooltip();
            }, 200);
        });
    });
</script>

@{
    var schemaBaseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var schemaCreadorNombre = Model.Usuario?.Seudonimo ?? Model.Usuario?.UserName ?? "Creador";
    var schemaDescripcion = !string.IsNullOrEmpty(Model.Descripcion)
        ? Model.Descripcion.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", "")
        : $"Contenido de {schemaCreadorNombre} en Lado";
    var schemaThumbnail = !string.IsNullOrEmpty(Model.Thumbnail)
        ? $"{schemaBaseUrl}{Model.Thumbnail}"
        : $"{schemaBaseUrl}/images/og-default.jpg";
    var schemaUrl = $"{schemaBaseUrl}/Feed/Detalle/{Model.Id}";
    var schemaFechaPublicacion = Model.FechaPublicacion.ToString("yyyy-MM-ddTHH:mm:ssZ");
}

@if (Model.TipoContenido == Lado.Models.TipoContenido.Video)
{
    <!-- Schema.org VideoObject -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "VideoObject",
        "name": "@(schemaDescripcion.Length > 100 ? schemaDescripcion.Substring(0, 100) : schemaDescripcion)",
        "description": "@schemaDescripcion",
        "thumbnailUrl": "@schemaThumbnail",
        "uploadDate": "@schemaFechaPublicacion",
        "contentUrl": "@schemaBaseUrl@Model.RutaArchivo",
        "embedUrl": "@schemaUrl",
        "interactionStatistic": {
            "@@type": "InteractionCounter",
            "interactionType": "https://schema.org/LikeAction",
            "userInteractionCount": @Model.NumeroLikes
        },
        "author": {
            "@@type": "Person",
            "name": "@schemaCreadorNombre",
            "url": "@schemaBaseUrl/@@@(Model.Usuario?.UserName ?? Model.Usuario?.Seudonimo)"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "Lado",
            "logo": {
                "@@type": "ImageObject",
                "url": "@schemaBaseUrl/images/logo-512.png"
            }
        }
    }
    </script>
}
else
{
    <!-- Schema.org Article/ImageObject -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "@(Model.TipoContenido == Lado.Models.TipoContenido.Foto ? "ImageObject" : "Article")",
        @if (Model.TipoContenido == Lado.Models.TipoContenido.Foto) {
            <text>"contentUrl": "@schemaBaseUrl@Model.RutaArchivo",</text>
        }
        "name": "@(schemaDescripcion.Length > 100 ? schemaDescripcion.Substring(0, 100) : schemaDescripcion)",
        "description": "@schemaDescripcion",
        "thumbnailUrl": "@schemaThumbnail",
        "datePublished": "@schemaFechaPublicacion",
        "url": "@schemaUrl",
        "interactionStatistic": {
            "@@type": "InteractionCounter",
            "interactionType": "https://schema.org/LikeAction",
            "userInteractionCount": @Model.NumeroLikes
        },
        "author": {
            "@@type": "Person",
            "name": "@schemaCreadorNombre",
            "url": "@schemaBaseUrl/@@@(Model.Usuario?.UserName ?? Model.Usuario?.Seudonimo)"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "Lado",
            "logo": {
                "@@type": "ImageObject",
                "url": "@schemaBaseUrl/images/logo-512.png"
            }
        }
    }
    </script>
}

<!-- ========================================
     FULLSCREEN VIEWER DEL CREADOR
     Muestra solo publicaciones del mismo creador
     ======================================== -->
<div id="creatorFullscreenViewer" class="creator-fullscreen-viewer">
    <div class="creator-fs-header">
        <button class="creator-fs-close" onclick="closeCreatorFullscreen()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="creator-fs-info">
            <img id="creatorFsAvatar" src="" alt="" class="creator-fs-avatar">
            <span id="creatorFsUsername"></span>
        </div>
        <div class="creator-fs-counter" id="creatorFsCounter">1 / 1</div>
    </div>
    <div class="creator-fs-container" id="creatorFsContainer"></div>
</div>

<style>
    .creator-fullscreen-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 10000;
        overflow: hidden;
    }
    .creator-fullscreen-viewer.active {
        display: flex;
        flex-direction: column;
    }

    /* Ocultar navegación cuando fullscreen está activo */
    body.fullscreen-active .top-navbar,
    body.fullscreen-active .bottom-nav,
    body.fullscreen-active .sidebar,
    body.fullscreen-active .navbar,
    body.fullscreen-active nav:not(.creator-fs-header) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    body.fullscreen-active {
        overflow: hidden !important;
    }

    html.fullscreen-active,
    body.fullscreen-active {
        background: #000 !important;
    }
    .creator-fs-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
        background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        z-index: 10;
    }
    .creator-fs-close {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(0,0,0,0.5);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    .creator-fs-close svg { width: 24px; height: 24px; }
    .creator-fs-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        font-weight: 600;
    }
    .creator-fs-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
    }
    .creator-fs-counter {
        color: white;
        font-size: 14px;
        background: rgba(0,0,0,0.5);
        padding: 6px 12px;
        border-radius: 20px;
    }
    .creator-fs-container {
        flex: 1;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
    }
    .creator-fs-container::-webkit-scrollbar { display: none; }
    .creator-fs-slide {
        width: 100%;
        height: 100vh;
        height: 100dvh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }
    .creator-fs-slide img, .creator-fs-slide video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .creator-fs-slide video { width: 100%; height: 100%; }
    .creator-fs-slide .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255,255,255,0.2);
        border-top-color: white;
        border-radius: 50%;
        animation: creatorSpin 1s linear infinite;
    }
    .creator-fs-slide.media-loaded .loading-spinner { display: none; }
    @@keyframes creatorSpin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    .creator-fs-credits {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 80px 20px 100px;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 100px);
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white;
    }
    .creator-fs-description {
        font-size: 15px;
        line-height: 1.5;
        margin-bottom: 12px;
        max-height: 80px;
        overflow: hidden;
    }
    .creator-fs-stats {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: rgba(255,255,255,0.8);
    }
    .creator-fs-stats span { display: flex; align-items: center; gap: 6px; }
    .creator-fs-stats svg { width: 18px; height: 18px; }
    .creator-fs-side-actions {
        position: absolute;
        right: 16px;
        bottom: 150px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 5;
    }
    .creator-fs-action-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(0,0,0,0.5);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: transform 0.2s;
    }
    .creator-fs-action-btn:active { transform: scale(0.9); }
    .creator-fs-action-btn svg { width: 24px; height: 24px; }
    .creator-fs-action-btn.liked svg { fill: #ff3b5c; color: #ff3b5c; }
    .creator-fs-action-count { font-size: 12px; text-align: center; color: white; margin-top: 4px; }
    .creator-fs-heart-animation {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
        z-index: 100;
        opacity: 0;
    }
    .creator-fs-heart-animation svg { width: 120px; height: 120px; fill: #ff3b5c; }
    .creator-fs-heart-animation.animate { animation: creatorHeartPop 0.8s ease-out forwards; }
    @@keyframes creatorHeartPop {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }
    .creator-fs-carousel { width: 100%; height: 100%; position: relative; }
    .creator-fs-carousel .swiper { width: 100%; height: 100%; }
    .creator-fs-carousel .swiper-slide { display: flex; align-items: center; justify-content: center; }
    .creator-fs-carousel .swiper-pagination-bullet { background: white; opacity: 0.5; }
    .creator-fs-carousel .swiper-pagination-bullet-active { opacity: 1; }
    .creator-fs-music-badge {
        position: absolute;
        bottom: 200px;
        left: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0,0,0,0.6);
        padding: 8px 12px;
        border-radius: 20px;
        color: white;
        font-size: 13px;
    }
    .creator-fs-music-badge svg { width: 20px; height: 20px; animation: creatorMusicSpin 3s linear infinite; }
    @@keyframes creatorMusicSpin { to { transform: rotate(360deg); } }
    @@media (min-width: 768px) {
        .creator-fs-slide { padding: 60px; }
        .creator-fs-side-actions { right: 40px; bottom: 200px; }
    }
</style>

<script>
(function() {
    const creatorId = '@Model.UsuarioId';
    const currentPostId = @Model.Id;
    const creatorUsername = '@Html.Raw((Model.Usuario?.Seudonimo ?? Model.Usuario?.UserName ?? "Creador").Replace("'", "\\'"))';
    const creatorAvatar = '@Html.Raw((Model.TipoLado == Lado.Models.TipoLado.LadoB ? (Model.Usuario?.FotoPerfilLadoB ?? Model.Usuario?.FotoPerfil ?? "") : (Model.Usuario?.FotoPerfil ?? "")).Replace("'", "\\'"))';

    let creatorPosts = [];
    let currentCreatorIndex = 0;
    let isCreatorFsActive = false;

    window.openCreatorFullscreen = async function() {
        const viewer = document.getElementById('creatorFullscreenViewer');
        if (!viewer) return;
        try {
            const response = await fetch(`/Feed/ObtenerPublicacionesUsuario?usuarioId=${creatorId}&contenidoActualId=${currentPostId}`);
            const data = await response.json();
            if (!data.success || !data.posts || data.posts.length === 0) {
                console.error('No se pudieron cargar las publicaciones');
                return;
            }
            creatorPosts = data.posts;
            currentCreatorIndex = data.indexActual;
            document.getElementById('creatorFsAvatar').src = creatorAvatar || '/images/default-avatar.png';
            document.getElementById('creatorFsUsername').textContent = creatorUsername;
            renderCreatorSlides();
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('fullscreen-active');
            document.documentElement.classList.add('fullscreen-active');
            isCreatorFsActive = true;
            setTimeout(() => {
                const container = document.getElementById('creatorFsContainer');
                const slideHeight = window.innerHeight;
                container.scrollTo({ top: slideHeight * currentCreatorIndex, behavior: 'instant' });
                updateCreatorCounter();
                playCurrentCreatorMedia();
            }, 100);
        } catch (error) {
            console.error('Error cargando publicaciones:', error);
        }
    };

    window.closeCreatorFullscreen = function() {
        const viewer = document.getElementById('creatorFullscreenViewer');
        if (!viewer) return;
        pauseAllCreatorMedia();
        viewer.classList.remove('active');
        document.body.style.overflow = '';
        document.body.classList.remove('fullscreen-active');
        document.documentElement.classList.remove('fullscreen-active');
        isCreatorFsActive = false;
    };

    function renderCreatorSlides() {
        const container = document.getElementById('creatorFsContainer');
        container.innerHTML = '';
        creatorPosts.forEach((post, index) => {
            const slide = document.createElement('div');
            slide.className = 'creator-fs-slide';
            slide.dataset.index = index;
            slide.dataset.postId = post.id;
            let html = '<div class="loading-spinner"></div>';
            if (post.tipo === 'video') {
                html += `<video src="${post.src}" playsinline webkit-playsinline loop preload="metadata"></video>`;
            } else if (post.tipo === 'carousel' && post.carouselFiles) {
                html += `<div class="creator-fs-carousel"><div class="swiper" data-post-id="${post.id}"><div class="swiper-wrapper">${post.carouselFiles.map(file => `<div class="swiper-slide">${file.tipo === 'video' ? `<video src="${file.src}" playsinline webkit-playsinline loop preload="metadata"></video>` : `<img src="${file.src}" alt="">`}</div>`).join('')}</div><div class="swiper-pagination"></div></div></div>`;
            } else {
                html += `<img src="${post.src}" alt="">`;
            }
            if (post.musica) {
                html += `<div class="creator-fs-music-badge" data-start="${post.musica.inicio}" data-volume="${post.musica.volumen}"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><span>${escapeHtml(post.musica.titulo)} - ${escapeHtml(post.musica.artista)}</span><audio src="${post.musica.rutaArchivo}" preload="metadata" loop></audio></div>`;
            }
            html += `<div class="creator-fs-heart-animation"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div>`;
            html += `<div class="creator-fs-side-actions"><div><button class="creator-fs-action-btn ${post.isLiked ? 'liked' : ''}" onclick="toggleCreatorLike(${post.id}, this)"><svg viewBox="0 0 24 24" fill="${post.isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button><div class="creator-fs-action-count">${formatCount(post.likes)}</div></div><div><button class="creator-fs-action-btn" onclick="window.location.href='/Feed/Detalle/${post.id}'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button><div class="creator-fs-action-count">${formatCount(post.comments)}</div></div><div><button class="creator-fs-action-btn" onclick="shareCreatorPost(${post.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg></button></div></div>`;
            html += `<div class="creator-fs-credits">${post.descripcion ? `<div class="creator-fs-description">${escapeHtml(post.descripcion)}</div>` : ''}<div class="creator-fs-stats"><span><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>${formatCount(post.likes)}</span><span><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>${formatCount(post.comments)}</span></div></div>`;
            slide.innerHTML = html;
            container.appendChild(slide);
            const img = slide.querySelector('img');
            const video = slide.querySelector('video');
            if (img) { img.onload = () => slide.classList.add('media-loaded'); if (img.complete) slide.classList.add('media-loaded'); }
            if (video) { video.onloadeddata = () => slide.classList.add('media-loaded'); }
        });
        initCreatorSwipers();
        container.addEventListener('scroll', onCreatorScroll);
        setupCreatorDoubleTap();
    }

    function initCreatorSwipers() {
        if (typeof Swiper !== 'undefined') {
            document.querySelectorAll('.creator-fs-carousel .swiper').forEach(swiperEl => {
                new Swiper(swiperEl, { slidesPerView: 1, spaceBetween: 0, pagination: { el: swiperEl.querySelector('.swiper-pagination'), clickable: true } });
            });
        }
    }

    let scrollTimeout;
    function onCreatorScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            const container = document.getElementById('creatorFsContainer');
            const slideHeight = window.innerHeight;
            const newIndex = Math.round(container.scrollTop / slideHeight);
            if (newIndex !== currentCreatorIndex && newIndex >= 0 && newIndex < creatorPosts.length) {
                pauseAllCreatorMedia();
                currentCreatorIndex = newIndex;
                updateCreatorCounter();
                playCurrentCreatorMedia();
            }
        }, 100);
    }

    function updateCreatorCounter() {
        const counter = document.getElementById('creatorFsCounter');
        if (counter) counter.textContent = `${currentCreatorIndex + 1} / ${creatorPosts.length}`;
    }

    function playCurrentCreatorMedia() {
        const slides = document.querySelectorAll('.creator-fs-slide');
        const currentSlide = slides[currentCreatorIndex];
        if (!currentSlide) return;
        const video = currentSlide.querySelector('video');
        if (video) { video.currentTime = 0; video.play().catch(() => {}); }
        const musicBadge = currentSlide.querySelector('.creator-fs-music-badge');
        if (musicBadge) {
            const audio = musicBadge.querySelector('audio');
            if (audio) {
                audio.currentTime = parseFloat(musicBadge.dataset.start) || 0;
                audio.volume = parseFloat(musicBadge.dataset.volume) || 0.7;
                audio.play().catch(() => {});
            }
        }
    }

    function pauseAllCreatorMedia() {
        document.querySelectorAll('.creator-fs-slide video').forEach(v => v.pause());
        document.querySelectorAll('.creator-fs-music-badge audio').forEach(a => a.pause());
    }

    window.toggleCreatorLike = async function(postId, btn) {
        const svg = btn.querySelector('svg');
        const countEl = btn.parentElement.querySelector('.creator-fs-action-count');
        const isLiked = btn.classList.contains('liked');
        btn.classList.toggle('liked');
        svg.setAttribute('fill', isLiked ? 'none' : 'currentColor');
        let currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = formatCount(isLiked ? currentCount - 1 : currentCount + 1);
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            await fetch('/Feed/Like/' + postId, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token } });
        } catch (error) {
            btn.classList.toggle('liked');
            svg.setAttribute('fill', isLiked ? 'currentColor' : 'none');
            countEl.textContent = formatCount(currentCount);
        }
    };

    window.shareCreatorPost = async function(postId) {
        const url = `${window.location.origin}/Feed/Detalle/${postId}`;
        if (navigator.share) { try { await navigator.share({ url }); } catch (e) {} }
        else { navigator.clipboard.writeText(url); alert('Enlace copiado'); }
    };

    let doubleTapSetup = false;
    function setupCreatorDoubleTap() {
        if (doubleTapSetup) return;
        doubleTapSetup = true;
        let lastTap = 0, tapTimeout;
        document.getElementById('creatorFsContainer').addEventListener('click', function(e) {
            if (e.target.closest('button, .creator-fs-action-btn, .swiper-pagination')) return;
            const now = Date.now();
            if (now - lastTap < 300) {
                clearTimeout(tapTimeout);
                const slide = e.target.closest('.creator-fs-slide');
                if (slide) {
                    const postId = parseInt(slide.dataset.postId);
                    const likeBtn = slide.querySelector('.creator-fs-action-btn');
                    if (likeBtn && !likeBtn.classList.contains('liked')) {
                        const heart = slide.querySelector('.creator-fs-heart-animation');
                        if (heart) { heart.classList.remove('animate'); void heart.offsetWidth; heart.classList.add('animate'); setTimeout(() => heart.classList.remove('animate'), 800); }
                        toggleCreatorLike(postId, likeBtn);
                    }
                }
                lastTap = 0;
            } else {
                lastTap = now;
                tapTimeout = setTimeout(() => {
                    const slide = e.target.closest('.creator-fs-slide');
                    if (slide) { const video = slide.querySelector('video'); if (video) { if (video.paused) video.play(); else video.pause(); } }
                }, 300);
            }
        });
    }

    function formatCount(num) { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'K'; return num.toString(); }
    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && isCreatorFsActive) closeCreatorFullscreen(); });

    let touchStartX = 0, touchStartY = 0;
    document.getElementById('creatorFsContainer')?.addEventListener('touchstart', function(e) { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: true });
    document.getElementById('creatorFsContainer')?.addEventListener('touchend', function(e) {
        const deltaX = e.changedTouches[0].clientX - touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].clientY - touchStartY);
        if (Math.abs(deltaX) > 100 && deltaY < 50 && deltaX > 0) closeCreatorFullscreen();
    }, { passive: true });
})();
</script>