@model Lado.Models.Subasta
@using Lado.Models
@{
    ViewData["Title"] = Model.Titulo;
    var usuarioActual = ViewBag.UsuarioActual as ApplicationUser;
    var puedePujar = ViewBag.PuedePujar as bool? ?? false;
    var esMiSubasta = ViewBag.EsMiSubasta as bool? ?? false;
    var esGanador = ViewBag.EsGanador as bool? ?? false;
    var tiempoRestante = Model.TiempoRestante();
    var estaActiva = Model.EstaActiva();
}

@Html.AntiForgeryToken()

<style>
    :root {
        --primary: #4682B4;
        --primary-dark: #36648B;
        --bg: #fafafa;
        --card-bg: #ffffff;
        --fg: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
    }

    [data-theme="dark"] {
        --bg: #0a0a0a;
        --card-bg: #1a1a1a;
        --fg: #f3f4f6;
        --muted: #9ca3af;
        --border: #374151;
    }

    .detalles-page {
        max-width: 1000px;
        margin: 0 auto;
        padding: 24px 20px 60px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 20px;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--primary);
    }

    .subasta-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 32px;
    }

    /* Card principal */
    .subasta-main {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        overflow: hidden;
    }

    .subasta-media {
        position: relative;
        width: 100%;
        aspect-ratio: 16/10;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .subasta-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .subasta-media-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.3);
    }

    .subasta-media-placeholder svg {
        width: 80px;
        height: 80px;
    }

    .status-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-badge.live {
        background: var(--danger);
        color: white;
        animation: pulse 2s infinite;
    }

    .status-badge.ended {
        background: var(--muted);
        color: white;
    }

    .status-badge.winner {
        background: var(--success);
        color: white;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .subasta-info {
        padding: 24px;
    }

    .creator-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .creator-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
        overflow: hidden;
    }

    .creator-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .creator-info h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        margin: 0;
    }

    .creator-info span {
        font-size: 13px;
        color: var(--muted);
    }

    .subasta-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--fg);
        margin: 0 0 12px 0;
        line-height: 1.3;
    }

    .subasta-description {
        font-size: 15px;
        color: var(--muted);
        line-height: 1.6;
        margin-bottom: 20px;
    }

    .subasta-stats {
        display: flex;
        gap: 24px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: var(--muted);
    }

    .stat-item svg {
        width: 18px;
        height: 18px;
    }

    /* Panel lateral */
    .subasta-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
    }

    /* Countdown */
    .countdown-card {
        text-align: center;
    }

    .countdown-label {
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }

    .countdown-display {
        display: flex;
        justify-content: center;
        gap: 16px;
    }

    .countdown-unit {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .countdown-value {
        font-size: 36px;
        font-weight: 800;
        color: var(--fg);
        font-family: 'SF Mono', 'Consolas', monospace;
        line-height: 1;
    }

    .countdown-text {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-top: 4px;
    }

    .countdown-separator {
        font-size: 36px;
        font-weight: 300;
        color: var(--muted);
    }

    .countdown-card.urgente .countdown-value {
        color: var(--danger);
    }

    /* Precio */
    .price-card {
        text-align: center;
    }

    .current-price-label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 8px;
    }

    .current-price {
        font-size: 48px;
        font-weight: 800;
        color: var(--success);
        line-height: 1;
    }

    .price-info {
        font-size: 14px;
        color: var(--muted);
        margin-top: 12px;
    }

    .compralo-ya {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px dashed var(--border);
    }

    .compralo-ya-label {
        font-size: 12px;
        color: var(--muted);
    }

    .compralo-ya-price {
        font-size: 24px;
        font-weight: 700;
        color: var(--warning);
    }

    /* Pujar */
    .bid-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        margin: 0 0 16px 0;
    }

    .bid-input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .bid-input {
        flex: 1;
        padding: 14px 16px;
        font-size: 18px;
        font-weight: 600;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--bg);
        color: var(--fg);
        text-align: center;
    }

    .bid-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .btn-pujar {
        padding: 14px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-pujar:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .btn-pujar:disabled {
        background: var(--muted);
        cursor: not-allowed;
    }

    .bid-hint {
        font-size: 13px;
        color: var(--muted);
        text-align: center;
    }

    .btn-compralo-ya {
        width: 100%;
        padding: 16px;
        background: var(--warning);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-compralo-ya:hover {
        background: #d97706;
    }

    /* Historial de pujas */
    .bids-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .bids-count {
        font-size: 13px;
        color: var(--muted);
        font-weight: 400;
    }

    .bids-list {
        max-height: 250px;
        overflow-y: auto;
    }

    .bid-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
    }

    .bid-item:last-child {
        border-bottom: none;
    }

    .bid-item.winner {
        background: rgba(16, 185, 129, 0.1);
        margin: 0 -24px;
        padding: 12px 24px;
        border-radius: 8px;
    }

    .bid-user {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bid-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
    }

    .bid-info span {
        font-size: 14px;
        color: var(--fg);
    }

    .bid-info small {
        font-size: 12px;
        color: var(--muted);
        display: block;
    }

    .bid-amount {
        font-size: 16px;
        font-weight: 700;
        color: var(--success);
    }

    .no-bids {
        text-align: center;
        padding: 20px;
        color: var(--muted);
    }

    /* Estados */
    .winner-banner {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
    }

    .winner-banner h3 {
        font-size: 20px;
        margin: 0 0 8px 0;
    }

    .winner-banner p {
        margin: 0;
        opacity: 0.9;
    }

    .ended-message {
        text-align: center;
        padding: 24px;
        color: var(--muted);
    }

    .login-prompt {
        text-align: center;
        padding: 16px;
        background: var(--bg);
        border-radius: 12px;
    }

    .login-prompt a {
        color: var(--primary);
        font-weight: 600;
    }

    /* Spinner */
    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .current-price {
        transition: transform 0.3s ease, color 0.3s ease;
    }

    .btn-cancelar-subasta {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px 16px;
        margin-top: 12px;
        background: transparent;
        color: var(--danger);
        border: 1px solid var(--danger);
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancelar-subasta:hover {
        background: var(--danger);
        color: white;
    }

    .btn-compartir {
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .btn-compartir:hover {
        background: rgba(70, 130, 180, 0.1);
        color: var(--primary);
    }

    .btn-compartir-grande {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        margin-top: 20px;
        padding: 14px 20px;
        background: linear-gradient(135deg, #4682B4 0%, #36648B 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-compartir-grande:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(70, 130, 180, 0.3);
    }

    @@media (max-width: 900px) {
        .subasta-layout {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="detalles-page">
    <a href="@Url.Action("Index")" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
        </svg>
        Volver a subastas
    </a>

    @if (esGanador && Model.Estado == EstadoSubasta.Finalizada)
    {
        <div class="winner-banner">
            <h3>Felicidades, ganaste esta subasta!</h3>
            <p>El creador te contactara pronto para entregar el contenido.</p>
        </div>
    }

    <div class="subasta-layout">
        <!-- Panel principal -->
        <div class="subasta-main">
            <div class="subasta-media">
                @if (!string.IsNullOrEmpty(Model.ImagenPreview))
                {
                    <img src="@Model.ImagenPreview" alt="@Model.Titulo" />
                }
                else if (Model.Contenido?.Thumbnail != null)
                {
                    <img src="@Model.Contenido.Thumbnail" alt="@Model.Titulo" />
                }
                else
                {
                    <div class="subasta-media-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </div>
                }

                @if (estaActiva)
                {
                    <div class="status-badge live">
                        <span style="width: 8px; height: 8px; background: white; border-radius: 50%;"></span>
                        ACTIVA
                    </div>
                }
                else if (esGanador)
                {
                    <div class="status-badge winner">GANADOR</div>
                }
                else
                {
                    <div class="status-badge ended">FINALIZADA</div>
                }
            </div>

            <div class="subasta-info">
                <div class="creator-row">
                    <a href="@Url.Action("Perfil", "Feed", new { id = Model.Creador?.UserName })" class="creator-avatar">
                        @if (!string.IsNullOrEmpty(Model.Creador?.FotoPerfil))
                        {
                            <img src="@Model.Creador.FotoPerfil" alt="" />
                        }
                        else
                        {
                            @(Model.Creador?.UserName?.Substring(0, 1).ToUpper() ?? "?")
                        }
                    </a>
                    <div class="creator-info">
                        <h3>@(Model.Creador?.Seudonimo ?? Model.Creador?.UserName)</h3>
                        <span>@@Model.Creador?.UserName</span>
                    </div>
                </div>

                <h1 class="subasta-title">@Model.Titulo</h1>

                @if (!string.IsNullOrEmpty(Model.Descripcion))
                {
                    <p class="subasta-description">@Model.Descripcion</p>
                }

                <div class="subasta-stats">
                    <div class="stat-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        @Model.NumeroVistas vistas
                    </div>
                    <div class="stat-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        @Model.NumeroPujas pujas
                    </div>
                    <div class="stat-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                        </svg>
                        @Model.FechaCreacion.ToString("dd MMM yyyy")
                    </div>
                </div>

                <button type="button" class="btn-compartir-grande" onclick="compartirSubasta()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    Compartir Subasta
                </button>
            </div>
        </div>

        <!-- Panel lateral -->
        <div class="subasta-sidebar">
            @if (estaActiva)
            {
                <!-- Countdown -->
                <div class="sidebar-card countdown-card @(tiempoRestante?.TotalMinutes <= 15 ? "urgente" : "")" id="countdownCard" data-fecha-fin="@Model.FechaFin.ToString("o")">
                    <div class="countdown-label">Termina en</div>
                    <div class="countdown-display">
                        <div class="countdown-unit">
                            <span class="countdown-value" id="hours">--</span>
                            <span class="countdown-text">Horas</span>
                        </div>
                        <span class="countdown-separator">:</span>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="minutes">--</span>
                            <span class="countdown-text">Min</span>
                        </div>
                        <span class="countdown-separator">:</span>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="seconds">--</span>
                            <span class="countdown-text">Seg</span>
                        </div>
                    </div>
                </div>
            }

            <!-- Precio actual -->
            <div class="sidebar-card price-card">
                <div class="current-price-label">Puja actual</div>
                <div class="current-price" id="currentPrice">$@Model.PrecioActual.ToString("N2")</div>
                <div class="price-info">
                    Minimo para pujar: $<span id="minBid">@((Model.PrecioActual + Model.IncrementoMinimo).ToString("N2"))</span>
                </div>

                @if (Model.PrecioCompraloYa.HasValue && estaActiva)
                {
                    <div class="compralo-ya">
                        <div class="compralo-ya-label">Compralo Ya por</div>
                        <div class="compralo-ya-price">$@Model.PrecioCompraloYa.Value.ToString("N2")</div>
                    </div>
                }
            </div>

            @if (estaActiva)
            {
                <!-- Formulario de puja -->
                <div class="sidebar-card bid-card">
                    <h3>Hacer una puja</h3>

                    @if (usuarioActual == null)
                    {
                        <div class="login-prompt">
                            <p>Debes <a href="@Url.Action("Login", "Account")">iniciar sesion</a> para pujar</p>
                        </div>
                    }
                    else if (esMiSubasta)
                    {
                        <div class="login-prompt">
                            <p>Esta es tu subasta</p>
                            @if (Model.NumeroPujas == 0)
                            {
                                <button type="button" class="btn-cancelar-subasta" onclick="cancelarSubasta()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="15" y1="9" x2="9" y2="15"/>
                                        <line x1="9" y1="9" x2="15" y2="15"/>
                                    </svg>
                                    Cancelar Subasta
                                </button>
                            }
                            else
                            {
                                <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">Tiene @Model.NumeroPujas puja(s), no se puede cancelar</p>
                            }
                        </div>
                    }
                    else if (!puedePujar && Model.SoloSuscriptores)
                    {
                        <div class="login-prompt">
                            <p>Solo suscriptores pueden pujar</p>
                            <a href="@Url.Action("Perfil", "Feed", new { id = Model.Creador?.UserName })">Ver perfil del creador</a>
                        </div>
                    }
                    else
                    {
                        <div class="bid-input-group">
                            <input type="number" class="bid-input" id="bidAmount"
                                   min="@((Model.PrecioActual + Model.IncrementoMinimo))"
                                   step="0.50"
                                   value="@((Model.PrecioActual + Model.IncrementoMinimo).ToString("0.00"))" />
                            <button type="button" class="btn-pujar" id="btnPujar" onclick="realizarPuja()">
                                Pujar
                            </button>
                        </div>
                        <div class="bid-hint">
                            Tu saldo: $@(usuarioActual?.Saldo.ToString("N2") ?? "0.00")
                        </div>

                        @if (Model.PrecioCompraloYa.HasValue)
                        {
                            <button type="button" class="btn-compralo-ya" onclick="compraloYa()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                                Compralo Ya - $@Model.PrecioCompraloYa.Value.ToString("N2")
                            </button>
                        }
                    }
                </div>
            }
            else
            {
                <div class="sidebar-card">
                    <div class="ended-message">
                        <h3>Subasta Finalizada</h3>
                        @if (Model.GanadorId != null)
                        {
                            <p>Ganador: @(Model.Ganador?.UserName ?? "Usuario")</p>
                            <p>Precio final: $@Model.PrecioActual.ToString("N2")</p>
                        }
                        else
                        {
                            <p>Esta subasta termino sin ofertas</p>
                        }
                    </div>
                </div>
            }

            <!-- Historial de pujas -->
            @if (Model.MostrarHistorialPujas)
            {
                <div class="sidebar-card bids-card">
                    <h3>
                        Historial de Pujas
                        <span class="bids-count" id="bidsCount">@Model.NumeroPujas pujas</span>
                    </h3>

                    <div class="bids-list" id="bidsList">
                        @if (Model.Pujas.Any())
                        {
                            @foreach (var puja in Model.Pujas.OrderByDescending(p => p.Monto).Take(10))
                            {
                                <div class="bid-item @(puja.EsGanadora ? "winner" : "")">
                                    <div class="bid-user">
                                        <div class="bid-avatar">
                                            @(puja.Usuario?.UserName?.Substring(0, 1).ToUpper() ?? "?")
                                        </div>
                                        <div class="bid-info">
                                            <span>@(puja.Usuario?.UserName?.Substring(0, 1).ToUpper())***</span>
                                            <small>@puja.FechaPuja.ToString("HH:mm")</small>
                                        </div>
                                    </div>
                                    <div class="bid-amount">$@puja.Monto.ToString("N2")</div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-bids">
                                <p>No hay pujas aun. Se el primero!</p>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const subastaId = @Model.Id;
        const fechaFin = new Date('@Model.FechaFin.ToString("o")');
        const incrementoMinimo = @Model.IncrementoMinimo.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture);

        // Countdown
        function updateCountdown() {
            const now = new Date();
            const diff = fechaFin - now;

            if (diff <= 0) {
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
                // Recargar pagina
                setTimeout(() => location.reload(), 2000);
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

            // Marcar como urgente
            if (diff <= 15 * 60 * 1000) {
                document.getElementById('countdownCard')?.classList.add('urgente');
            }
        }

        if (document.getElementById('countdownCard')) {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Actualizar estado cada 5 segundos
        let ultimoPrecio = @Model.PrecioActual.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture);

        async function updateState() {
            try {
                const response = await fetch(`/Subastas/Estado/${subastaId}`);
                if (response.ok) {
                    const data = await response.json();
                    const nuevoPrecio = parseFloat(data.precioActual);

                    // Si el precio cambió, actualizar con animación
                    if (nuevoPrecio !== ultimoPrecio) {
                        const priceEl = document.getElementById('currentPrice');
                        priceEl.style.transform = 'scale(1.1)';
                        priceEl.style.color = '#10b981';
                        priceEl.textContent = '$' + nuevoPrecio.toFixed(2);

                        setTimeout(() => {
                            priceEl.style.transform = 'scale(1)';
                            priceEl.style.color = '';
                        }, 300);

                        ultimoPrecio = nuevoPrecio;

                        // Actualizar historial de pujas
                        await updateBidHistory();
                    }

                    const minBid = nuevoPrecio + incrementoMinimo;
                    document.getElementById('minBid').textContent = minBid.toFixed(2);

                    const bidInput = document.getElementById('bidAmount');
                    if (bidInput && parseFloat(bidInput.value) < minBid) {
                        bidInput.value = minBid.toFixed(2);
                        bidInput.min = minBid;
                    }

                    const bidsCountEl = document.getElementById('bidsCount');
                    if (bidsCountEl) {
                        bidsCountEl.textContent = data.numeroPujas + ' pujas';
                    }
                }
            } catch (e) {
                console.log('Error actualizando:', e);
            }
        }

        // Actualizar historial de pujas
        async function updateBidHistory() {
            try {
                const response = await fetch(`/Subastas/PujasRecientes/${subastaId}?limit=10`);
                if (response.ok) {
                    const pujas = await response.json();
                    const bidsList = document.getElementById('bidsList');
                    if (bidsList && pujas.length > 0) {
                        let html = '';
                        pujas.forEach((puja, index) => {
                            const isFirst = index === 0;
                            html += `
                                <div class="bid-item ${isFirst ? 'winner' : ''}" style="${isFirst ? 'animation: fadeIn 0.3s ease;' : ''}">
                                    <div class="bid-user">
                                        <div class="bid-avatar">${puja.usuarioInicial}</div>
                                        <div class="bid-info">
                                            <span>${puja.usuarioInicial}</span>
                                            <small>${puja.fecha}</small>
                                        </div>
                                    </div>
                                    <div class="bid-amount">$${parseFloat(puja.monto).toFixed(2)}</div>
                                </div>
                            `;
                        });
                        bidsList.innerHTML = html;
                    }
                }
            } catch (e) {
                console.log('Error actualizando historial:', e);
            }
        }

        setInterval(updateState, 5000);

        // Realizar puja
        async function realizarPuja() {
            const btn = document.getElementById('btnPujar');
            const bidInput = document.getElementById('bidAmount');
            const monto = parseFloat(bidInput.value);

            if (isNaN(monto) || monto <= 0) {
                alert('Ingresa un monto valido');
                return;
            }

            btn.innerHTML = '<div class="spinner"></div>';
            btn.disabled = true;

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append('subastaId', subastaId);
                formData.append('monto', monto);
                formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Subastas/Pujar', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Actualizar precio actual con animacion
                    const priceEl = document.getElementById('currentPrice');
                    priceEl.style.transform = 'scale(1.1)';
                    priceEl.style.color = '#10b981';
                    priceEl.textContent = '$' + parseFloat(result.precioActual).toFixed(2);

                    setTimeout(() => {
                        priceEl.style.transform = 'scale(1)';
                        priceEl.style.color = '';
                    }, 300);

                    // Actualizar minimo para pujar
                    const newMin = parseFloat(result.precioActual) + incrementoMinimo;
                    bidInput.value = newMin.toFixed(2);
                    bidInput.min = newMin;
                    document.getElementById('minBid').textContent = newMin.toFixed(2);

                    // Actualizar contador de pujas
                    const bidsCountEl = document.getElementById('bidsCount');
                    if (bidsCountEl) {
                        bidsCountEl.textContent = result.numeroPujas + ' pujas';
                    }

                    // Actualizar historial de pujas desde el servidor
                    ultimoPrecio = parseFloat(result.precioActual);
                    await updateBidHistory();

                    // Mostrar mensaje de exito
                    btn.innerHTML = '✓ Puja realizada';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.innerHTML = 'Pujar';
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert(result.message || 'Error al pujar');
                    btn.innerHTML = 'Pujar';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error de conexion');
                btn.innerHTML = 'Pujar';
                btn.disabled = false;
            }
        }

        // Compralo Ya
        async function compraloYa() {
            if (!confirm('Estas seguro de comprar esta subasta inmediatamente?')) {
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append('subastaId', subastaId);
                formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Subastas/CompraloYa', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message || 'Error al comprar');
                }
            } catch (e) {
                alert('Error de conexion');
            }
        }

        // Compartir subasta
        async function compartirSubasta() {
            const url = window.location.href;
            const titulo = '@Model.Titulo.Replace("'", "\\'")';

            if (navigator.share) {
                // API nativa de compartir (móviles)
                try {
                    await navigator.share({
                        title: titulo,
                        text: `Mira esta subasta: ${titulo}`,
                        url: url
                    });
                } catch (e) {
                    // Usuario cancelo o error
                }
            } else {
                // Fallback: copiar al portapapeles
                try {
                    await navigator.clipboard.writeText(url);
                    alert('Link copiado al portapapeles');
                } catch (e) {
                    // Fallback manual
                    prompt('Copia este link:', url);
                }
            }
        }

        // Cancelar subasta (solo para el creador)
        async function cancelarSubasta() {
            if (!confirm('¿Estas seguro de cancelar esta subasta? Esta accion no se puede deshacer.')) {
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append('subastaId', subastaId);
                formData.append('__RequestVerificationToken', token);

                const response = await fetch('/Subastas/Cancelar', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert('Subasta cancelada exitosamente');
                    window.location.href = '/Subastas/MisSubastas';
                } else {
                    alert(result.message || 'Error al cancelar');
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error de conexion');
            }
        }
    </script>
}
