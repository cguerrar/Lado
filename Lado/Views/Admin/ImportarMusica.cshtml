@{
    ViewData["Title"] = "Importar Musica";
}

<style>
    /* Header */
    .import-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .import-header h2 {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--text-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .import-header h2 svg {
        width: 32px;
        height: 32px;
        color: var(--primary);
    }

    /* Tabs */
    .import-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
    }

    .tab-btn {
        padding: 14px 24px;
        background: transparent;
        border: none;
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-gray);
        cursor: pointer;
        position: relative;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .tab-btn svg {
        width: 20px;
        height: 20px;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary);
        border-radius: 3px 3px 0 0;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Section Card */
    .section-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        padding: 28px;
        margin-bottom: 24px;
    }

    .section-card h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-card h3 svg {
        width: 24px;
        height: 24px;
        color: var(--primary);
    }

    /* Folder Scanner */
    .folder-input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }

    .folder-input-group input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9375rem;
        background: var(--bg-light);
    }

    .folder-input-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-pale);
    }

    .info-box {
        background: var(--primary-pale);
        border: 1px solid var(--primary-light);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .info-box svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
        flex-shrink: 0;
        margin-top: 2px;
    }

    .info-box p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--primary-dark);
    }

    .info-box code {
        background: rgba(255,255,255,0.5);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }

    /* Scan Results */
    .scan-results {
        margin-top: 24px;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .results-header h4 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .results-count {
        font-size: 0.875rem;
        color: var(--text-gray);
    }

    /* Track Preview Card */
    .track-preview-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 500px;
        overflow-y: auto;
    }

    .track-preview-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        transition: var(--transition-fast);
    }

    .track-preview-card:hover {
        border-color: var(--primary);
    }

    .track-preview-card.selected {
        background: var(--primary-pale);
        border-color: var(--primary);
    }

    .track-checkbox {
        width: 20px;
        height: 20px;
        accent-color: var(--primary);
    }

    .track-cover-preview {
        width: 60px;
        height: 60px;
        border-radius: var(--radius-sm);
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
    }

    .track-cover-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .track-cover-preview svg {
        width: 28px;
        height: 28px;
        color: white;
    }

    .track-info-preview {
        flex: 1;
        min-width: 0;
    }

    .track-info-preview h5 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-info-preview p {
        font-size: 0.8125rem;
        color: var(--text-gray);
        margin: 0;
    }

    .track-meta {
        display: flex;
        gap: 16px;
        flex-shrink: 0;
    }

    .track-meta-item {
        text-align: center;
    }

    .track-meta-item span {
        display: block;
        font-size: 0.7rem;
        color: var(--text-light);
        text-transform: uppercase;
    }

    .track-meta-item strong {
        font-size: 0.875rem;
        color: var(--text-dark);
    }

    .track-actions-preview {
        display: flex;
        gap: 8px;
    }

    .btn-play-preview {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-fast);
    }

    .btn-play-preview:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-primary);
    }

    .btn-play-preview svg {
        width: 18px;
        height: 18px;
    }

    /* Pixabay Search */
    .search-form {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .search-input-wrapper {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-input-wrapper input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9375rem;
        background: var(--bg-light);
    }

    .search-input-wrapper svg {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        color: var(--text-light);
    }

    .filter-select {
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9375rem;
        background: var(--bg-light);
        min-width: 150px;
    }

    /* Pixabay Results Grid */
    .pixabay-results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }

    .pixabay-track-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: var(--transition-fast);
    }

    .pixabay-track-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .pixabay-track-cover {
        height: 140px;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .pixabay-track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .pixabay-track-cover svg {
        width: 48px;
        height: 48px;
        color: rgba(255,255,255,0.5);
    }

    .play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: var(--transition-fast);
    }

    .pixabay-track-card:hover .play-overlay {
        opacity: 1;
    }

    .play-overlay button {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: scale(0.8);
        transition: var(--transition-fast);
    }

    .pixabay-track-card:hover .play-overlay button {
        transform: scale(1);
    }

    .play-overlay button svg {
        width: 24px;
        height: 24px;
    }

    .pixabay-track-info {
        padding: 16px;
    }

    .pixabay-track-info h5 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .pixabay-track-info p {
        font-size: 0.8125rem;
        color: var(--text-gray);
        margin: 0 0 12px 0;
    }

    .pixabay-track-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .meta-tag {
        display: inline-flex;
        padding: 4px 10px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        color: var(--text-gray);
    }

    .btn-download {
        width: 100%;
        padding: 10px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: var(--transition-fast);
    }

    .btn-download:hover {
        box-shadow: var(--shadow-primary);
    }

    .btn-download:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-download svg {
        width: 18px;
        height: 18px;
    }

    /* Loading State */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        color: var(--text-light);
        margin-bottom: 16px;
    }

    .empty-state h4 {
        font-size: 1.125rem;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    /* API Key Config */
    .api-config {
        background: var(--bg-light);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 24px;
    }

    .api-config label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .api-config-row {
        display: flex;
        gap: 12px;
    }

    .api-config input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-family: monospace;
    }

    .api-config small {
        display: block;
        margin-top: 8px;
        color: var(--text-gray);
        font-size: 0.8125rem;
    }

    .api-config small a {
        color: var(--primary);
    }

    /* Import Progress */
    .import-progress {
        margin-top: 20px;
    }

    .progress-bar-container {
        background: var(--bg-light);
        border-radius: var(--radius-md);
        height: 8px;
        overflow: hidden;
        margin-bottom: 12px;
    }

    .progress-bar {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: var(--radius-md);
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 0.875rem;
        color: var(--text-gray);
        text-align: center;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .folder-input-group {
            flex-direction: column;
        }

        .search-form {
            flex-direction: column;
        }

        .search-input-wrapper {
            min-width: 100%;
        }

        .track-meta {
            display: none;
        }

        .pixabay-results {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Anti-Forgery Token -->
@Html.AntiForgeryToken()

<!-- Header -->
<div class="import-header">
    <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Importar Musica
    </h2>
    <a href="/Admin/Musica" class="btn btn-outline-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Volver a Biblioteca
    </a>
</div>

<!-- Tabs -->
<div class="import-tabs">
    <button class="tab-btn active" onclick="switchTab('folder')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        Escanear Carpeta
    </button>
    <button class="tab-btn" onclick="switchTab('pixabay')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        Jamendo Music (API)
    </button>
</div>

<!-- Tab 1: Folder Scanner -->
<div id="tabFolder" class="tab-content active">
    <div class="section-card">
        <h3>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            Escanear Carpeta del Servidor
        </h3>

        <div class="info-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <p>
                Coloca los archivos MP3 en la carpeta <code>wwwroot/audio/importar/</code> del servidor.
                El sistema leera automaticamente los metadatos ID3 (titulo, artista, album, genero, duracion)
                y extraera las portadas embebidas si existen.
            </p>
        </div>

        <div class="folder-input-group">
            <input type="text" id="folderPath" value="wwwroot/audio/importar" placeholder="Ruta de la carpeta">
            <button class="btn btn-primary" onclick="scanFolder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Escanear
            </button>
        </div>

        <div id="scanLoading" class="loading-spinner" style="display:none;">
            <div class="spinner"></div>
        </div>

        <div id="scanResults" class="scan-results" style="display:none;">
            <div class="results-header">
                <h4>Archivos Encontrados</h4>
                <div>
                    <span class="results-count" id="resultsCount">0 archivos</span>
                    <button class="btn btn-primary ms-3" onclick="importSelected()" id="btnImportSelected" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Importar Seleccionados
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label>
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Seleccionar todos
                </label>
            </div>

            <div class="track-preview-list" id="trackList">
                <!-- Tracks will be inserted here -->
            </div>

            <div id="importProgress" class="import-progress" style="display:none;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">Importando...</p>
            </div>
        </div>

        <div id="scanEmpty" class="empty-state" style="display:none;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <h4>No se encontraron archivos MP3</h4>
            <p>Coloca archivos MP3 en la carpeta indicada y vuelve a escanear.</p>
        </div>
    </div>
</div>

<!-- Tab 2: Jamendo API -->
<div id="tabJamendo" class="tab-content">
    <div class="section-card">
        <h3>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            Jamendo Music - Musica Creative Commons
        </h3>

        <div class="api-config">
            <label>Client ID de Jamendo</label>
            <div class="api-config-row">
                <input type="text" id="jamendoClientId" placeholder="Tu Client ID de Jamendo" value="@ViewBag.JamendoClientId">
                <button class="btn btn-primary" onclick="saveJamendoKey()">Guardar</button>
            </div>
            <small>
                Obtiene tu Client ID gratuito en <a href="https://developer.jamendo.com/v3.0" target="_blank">developer.jamendo.com</a>.
                Es gratis y permite hasta 2000 peticiones/dia. La musica es Creative Commons.
            </small>
        </div>

        <div class="search-form">
            <div class="search-input-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="jamendoSearch" placeholder="Buscar musica... (ej: happy, chill, cinematic)" onkeypress="if(event.key==='Enter')searchJamendo()">
            </div>
            <select class="filter-select" id="jamendoTags">
                <option value="">Todos los estilos</option>
                <option value="pop">Pop</option>
                <option value="rock">Rock</option>
                <option value="electronic">Electronica</option>
                <option value="hiphop">Hip Hop</option>
                <option value="jazz">Jazz</option>
                <option value="classical">Clasica</option>
                <option value="ambient">Ambient</option>
                <option value="chillout">Chillout</option>
                <option value="lounge">Lounge</option>
                <option value="folk">Folk</option>
                <option value="indie">Indie</option>
                <option value="metal">Metal</option>
                <option value="reggae">Reggae</option>
                <option value="latin">Latin</option>
                <option value="soundtrack">Soundtrack</option>
            </select>
            <button class="btn btn-primary" onclick="searchJamendo()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Buscar
            </button>
        </div>

        <div id="jamendoLoading" class="loading-spinner" style="display:none;">
            <div class="spinner"></div>
        </div>

        <div id="jamendoResults" class="pixabay-results">
            <!-- Results will be inserted here -->
        </div>

        <div id="jamendoEmpty" class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <h4>Busca musica libre de derechos</h4>
            <p>Ingresa un termino de busqueda para encontrar musica en Jamendo.</p>
        </div>
    </div>
</div>

<!-- Audio Player -->
<audio id="audioPlayer" style="display:none;"></audio>

@section Scripts {
<script>
    let scannedTracks = [];
    let currentAudio = null;
    let currentPlayingId = null;

    // Tab switching
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(tab === 'folder' ? 'tabFolder' : 'tabJamendo').classList.add('active');
    }

    // ========================================
    // FOLDER SCANNER
    // ========================================
    async function scanFolder() {
        const folderPath = document.getElementById('folderPath').value;

        document.getElementById('scanLoading').style.display = 'flex';
        document.getElementById('scanResults').style.display = 'none';
        document.getElementById('scanEmpty').style.display = 'none';

        try {
            const response = await fetch('/Admin/EscanearCarpetaMusica', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ carpeta: folderPath })
            });

            const result = await response.json();
            document.getElementById('scanLoading').style.display = 'none';

            if (result.success && result.tracks && result.tracks.length > 0) {
                scannedTracks = result.tracks;
                renderTrackList();
                document.getElementById('scanResults').style.display = 'block';
                document.getElementById('resultsCount').textContent = `${result.tracks.length} archivos`;
            } else {
                document.getElementById('scanEmpty').style.display = 'block';
                if (result.message) {
                    document.querySelector('#scanEmpty p').textContent = result.message;
                }
            }
        } catch (err) {
            document.getElementById('scanLoading').style.display = 'none';
            document.getElementById('scanEmpty').style.display = 'block';
            document.querySelector('#scanEmpty p').textContent = 'Error al escanear: ' + err.message;
        }
    }

    function renderTrackList() {
        const container = document.getElementById('trackList');
        container.innerHTML = scannedTracks.map((track, index) => `
            <div class="track-preview-card" data-index="${index}">
                <input type="checkbox" class="track-checkbox" data-index="${index}" onchange="updateImportButton()">
                <div class="track-cover-preview">
                    ${track.portadaBase64
                        ? `<img src="data:image/jpeg;base64,${track.portadaBase64}" alt="${track.titulo}">`
                        : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>`
                    }
                </div>
                <div class="track-info-preview">
                    <h5>${track.titulo || track.archivo}</h5>
                    <p>${track.artista || 'Artista desconocido'} ${track.album ? '- ' + track.album : ''}</p>
                </div>
                <div class="track-meta">
                    <div class="track-meta-item">
                        <span>Duracion</span>
                        <strong>${formatDuration(track.duracion)}</strong>
                    </div>
                    <div class="track-meta-item">
                        <span>Genero</span>
                        <strong>${track.genero || '-'}</strong>
                    </div>
                    <div class="track-meta-item">
                        <span>BPM</span>
                        <strong>${track.bpm || '-'}</strong>
                    </div>
                </div>
                <div class="track-actions-preview">
                    <button class="btn-play-preview" onclick="playPreview('${track.rutaTemporal}', ${index})">
                        <svg id="playIcon${index}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = selectAll);
        updateImportButton();
    }

    function updateImportButton() {
        const selected = document.querySelectorAll('.track-checkbox:checked').length;
        document.getElementById('btnImportSelected').disabled = selected === 0;
        document.getElementById('btnImportSelected').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Importar ${selected > 0 ? `(${selected})` : 'Seleccionados'}
        `;
    }

    async function importSelected() {
        const selectedIndices = Array.from(document.querySelectorAll('.track-checkbox:checked'))
            .map(cb => parseInt(cb.dataset.index));

        if (selectedIndices.length === 0) return;

        const tracksToImport = selectedIndices.map(i => scannedTracks[i]);

        document.getElementById('importProgress').style.display = 'block';
        document.getElementById('btnImportSelected').disabled = true;

        let imported = 0;
        for (const track of tracksToImport) {
            try {
                const response = await fetch('/Admin/ImportarPistaEscaneada', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(track)
                });

                const result = await response.json();
                if (result.success) imported++;
            } catch (err) {
            }

            const progress = ((imported) / tracksToImport.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `Importando ${imported} de ${tracksToImport.length}...`;
        }

        document.getElementById('progressText').textContent = `Importacion completada: ${imported} de ${tracksToImport.length} pistas`;

        setTimeout(() => {
            showToast(`${imported} pistas importadas exitosamente`, 'success');
        }, 500);
    }

    // ========================================
    // JAMENDO API
    // ========================================
    async function saveJamendoKey() {
        const clientId = document.getElementById('jamendoClientId').value;

        try {
            const response = await fetch('/Admin/GuardarJamendoClientId', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ clientId: clientId })
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client ID guardado correctamente', 'success');
            } else {
                showToast('Error al guardar Client ID', 'error');
            }
        } catch (err) {
            showToast('Error al guardar Client ID', 'error');
        }
    }

    async function searchJamendo() {
        const clientId = document.getElementById('jamendoClientId').value;
        const query = document.getElementById('jamendoSearch').value;
        const tags = document.getElementById('jamendoTags').value;

        if (!clientId) {
            showToast('Ingresa tu Client ID de Jamendo', 'warning');
            return;
        }

        document.getElementById('jamendoLoading').style.display = 'flex';
        document.getElementById('jamendoResults').innerHTML = '';
        document.getElementById('jamendoEmpty').style.display = 'none';

        try {
            const response = await fetch('/Admin/BuscarJamendoMusic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    clientId: clientId,
                    query: query,
                    tags: tags
                })
            });

            const result = await response.json();
            document.getElementById('jamendoLoading').style.display = 'none';

            if (result.success && result.tracks && result.tracks.length > 0) {
                renderJamendoResults(result.tracks);
            } else {
                document.getElementById('jamendoEmpty').style.display = 'block';
                document.querySelector('#jamendoEmpty h4').textContent = 'No se encontraron resultados';
                document.querySelector('#jamendoEmpty p').textContent = result.message || 'Intenta con otros terminos de busqueda.';
            }
        } catch (err) {
            document.getElementById('jamendoLoading').style.display = 'none';
            document.getElementById('jamendoEmpty').style.display = 'block';
            document.querySelector('#jamendoEmpty p').textContent = 'Error: ' + err.message;
        }
    }

    function renderJamendoResults(tracks) {
        const container = document.getElementById('jamendoResults');
        container.innerHTML = tracks.map((track, index) => `
            <div class="pixabay-track-card">
                <div class="pixabay-track-cover">
                    ${track.albumImage
                        ? `<img src="${track.albumImage}" alt="${track.title}">`
                        : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"></path>
                            <circle cx="6" cy="18" r="3"></circle>
                            <circle cx="18" cy="16" r="3"></circle>
                        </svg>`
                    }
                    <div class="play-overlay">
                        <button onclick="playJamendoPreview('${track.audioUrl}', 'jamendo${index}')">
                            <svg id="jamendoPlayIcon${index}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="pixabay-track-info">
                    <h5>${track.title}</h5>
                    <p>${track.artistName}</p>
                    <div class="pixabay-track-meta">
                        <span class="meta-tag">${formatDuration(track.duration)}</span>
                        <span class="meta-tag">${track.license || 'CC'}</span>
                    </div>
                    <button class="btn-download" onclick="downloadJamendoTrack(${JSON.stringify(track).replace(/"/g, '&quot;')}, this)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Importar a Biblioteca
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function downloadJamendoTrack(track, button) {
        button.disabled = true;
        button.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Descargando...';

        try {
            const response = await fetch('/Admin/DescargarJamendoTrack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(track)
            });

            const result = await response.json();

            if (result.success) {
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Importado';
                button.style.background = 'var(--success)';
                showToast('Pista importada correctamente', 'success');
            } else {
                button.disabled = false;
                button.innerHTML = 'Error - Reintentar';
                showToast(result.message || 'Error al importar', 'error');
            }
        } catch (err) {
            button.disabled = false;
            button.innerHTML = 'Error - Reintentar';
            showToast('Error: ' + err.message, 'error');
        }
    }

    // ========================================
    // AUDIO PLAYBACK
    // ========================================
    function playPreview(url, index) {
        const player = document.getElementById('audioPlayer');

        if (currentPlayingId === `local${index}` && !player.paused) {
            player.pause();
            currentPlayingId = null;
            return;
        }

        player.src = url;
        player.play();
        currentPlayingId = `local${index}`;
    }

    function playJamendoPreview(url, id) {
        const player = document.getElementById('audioPlayer');

        if (currentPlayingId === id && !player.paused) {
            player.pause();
            currentPlayingId = null;
            return;
        }

        player.src = url;
        player.play();
        currentPlayingId = id;
    }

    function formatDuration(seconds) {
        if (!seconds) return '-';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
</script>
}
