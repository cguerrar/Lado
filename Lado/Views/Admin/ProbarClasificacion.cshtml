@{
    ViewData["Title"] = "Probar Clasificacion con IA";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-robot text-primary"></i> Probar Clasificacion con IA</h2>
            <p class="text-muted">Prueba el sistema de clasificacion automatica de contenido</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="@Url.Action("Configuracion", "Admin")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Configuracion
            </a>
        </div>
    </div>

    <!-- Estado del sistema -->
    <div class="row mb-4">
        <div class="col-12">
            @if (!ViewBag.ApiKeyConfigurada)
            {
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>API Key no configurada.</strong>
                    Configura la API Key de Claude en user-secrets o variables de entorno.
                </div>
            }
            else if (!ViewBag.TieneCategorias)
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>No hay categorias.</strong>
                    Ejecuta el seed de categorias primero desde Configuracion.
                </div>
            }
            else
            {
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Sistema listo.</strong>
                    API Key configurada y @(((IEnumerable<dynamic>)ViewBag.Categorias).Count()) categorias disponibles.
                </div>
            }
        </div>
    </div>

    <div class="row g-4">
        <!-- Prueba por Texto -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-font"></i> Clasificar por Texto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Descripcion del contenido</label>
                        <textarea id="textoClasificar" class="form-control" rows="4"
                                  placeholder="Ej: Video de rutina de ejercicios para principiantes en casa..."></textarea>
                    </div>

                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="clasificarTexto()" id="btnClasificarTexto">
                            <i class="fas fa-magic"></i> Clasificar Texto
                        </button>
                    </div>

                    <div id="resultadoTexto" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Prueba por Imagen -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-image"></i> Clasificar por Imagen
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar imagen</label>
                        <input type="file" id="imagenClasificar" class="form-control" accept="image/*">
                        <small class="text-muted">Max 5MB - JPG, PNG, GIF, WEBP</small>
                    </div>

                    <div id="previewImagen" class="mb-3 text-center" style="display: none;">
                        <img id="imgPreview" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripcion (opcional)</label>
                        <input type="text" id="descripcionImagen" class="form-control"
                               placeholder="Descripcion adicional...">
                    </div>

                    <div class="d-grid">
                        <button type="button" class="btn btn-success" onclick="clasificarImagen()" id="btnClasificarImagen">
                            <i class="fas fa-magic"></i> Clasificar Imagen
                        </button>
                    </div>

                    <div id="resultadoImagen" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categorias disponibles -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tags"></i> Categorias Disponibles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        @if (ViewBag.Categorias != null)
                        {
                            foreach (var cat in ViewBag.Categorias)
                            {
                                <div class="col-auto">
                                    <span class="badge fs-6 py-2 px-3" style="background-color: @cat.Color;">
                                        <i class="@cat.Icono me-1"></i> @cat.Nombre
                                        <small class="ms-1 opacity-75">(ID: @cat.Id)</small>
                                    </span>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12">
                                <p class="text-muted mb-0">No hay categorias. Ejecuta el seed primero.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ejemplos de prueba -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Ejemplos de Prueba
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Haz clic en un ejemplo para probarlo:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Receta de pasta carbonara con ingredientes frescos y paso a paso')">
                            Cocina
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Rutina de ejercicios HIIT para quemar grasa en 20 minutos')">
                            Fitness
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Tutorial de maquillaje natural para el dia a dia')">
                            Belleza
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Gameplay de Fortnite con victoria epica')">
                            Gaming
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Cover acustico de una cancion de Bad Bunny')">
                            Musica
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Vlog de mi viaje a Cancun, las mejores playas')">
                            Viajes
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Sketch de comedia sobre situaciones cotidianas')">
                            Comedia
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Review del nuevo iPhone 15 Pro Max')">
                            Tecnologia
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Mi perrito aprendiendo trucos nuevos')">
                            Mascotas
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="probarEjemplo('Outfit del dia: look casual para oficina')">
                            Moda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Preview de imagen
    document.getElementById('imagenClasificar').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('previewImagen').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Probar ejemplo
    function probarEjemplo(texto) {
        document.getElementById('textoClasificar').value = texto;
        clasificarTexto();
    }

    // Clasificar por texto
    async function clasificarTexto() {
        const texto = document.getElementById('textoClasificar').value;
        if (!texto.trim()) {
            alert('Ingresa un texto para clasificar');
            return;
        }

        const btn = document.getElementById('btnClasificarTexto');
        const resultado = document.getElementById('resultadoTexto');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clasificando...';

        try {
            const response = await fetch('@Url.Action("ProbarClasificacionTexto", "Admin")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto: texto })
            });

            const data = await response.json();

            if (data.success) {
                resultado.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <div class="d-flex align-items-center">
                            <span class="badge fs-5 me-3" style="background-color: ${data.categoriaColor};">
                                <i class="${data.categoriaIcono}"></i>
                            </span>
                            <div>
                                <strong>${data.categoriaNombre}</strong>
                                <br><small class="text-muted">ID: ${data.categoriaId} | Tiempo: ${data.tiempoMs}ms</small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultado.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-times-circle"></i>
                        <strong>Error:</strong> ${data.message}
                        <br><small class="text-muted">Tiempo: ${data.tiempoMs || 0}ms</small>
                    </div>
                `;
            }
        } catch (error) {
            resultado.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-times-circle"></i>
                    <strong>Error de conexion:</strong> ${error.message}
                </div>
            `;
        }

        resultado.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Clasificar Texto';
    }

    // Clasificar por imagen
    async function clasificarImagen() {
        const fileInput = document.getElementById('imagenClasificar');
        const descripcion = document.getElementById('descripcionImagen').value;

        if (!fileInput.files || !fileInput.files[0]) {
            alert('Selecciona una imagen');
            return;
        }

        const btn = document.getElementById('btnClasificarImagen');
        const resultado = document.getElementById('resultadoImagen');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clasificando...';

        try {
            const formData = new FormData();
            formData.append('imagen', fileInput.files[0]);
            if (descripcion) {
                formData.append('descripcion', descripcion);
            }

            const response = await fetch('@Url.Action("ProbarClasificacionImagen", "Admin")', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                resultado.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <div class="d-flex align-items-center">
                            <span class="badge fs-5 me-3" style="background-color: ${data.categoriaColor};">
                                <i class="${data.categoriaIcono}"></i>
                            </span>
                            <div>
                                <strong>${data.categoriaNombre}</strong>
                                <br><small class="text-muted">ID: ${data.categoriaId} | Tiempo: ${data.tiempoMs}ms</small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultado.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-times-circle"></i>
                        <strong>Error:</strong> ${data.message}
                        <br><small class="text-muted">Tiempo: ${data.tiempoMs || 0}ms</small>
                    </div>
                `;
            }
        } catch (error) {
            resultado.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-times-circle"></i>
                    <strong>Error de conexion:</strong> ${error.message}
                </div>
            `;
        }

        resultado.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Clasificar Imagen';
    }
</script>
