@model List<Lado.Models.Transaccion>
@{
    ViewData["Title"] = "Gestionar Retiros";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var filtroActual = ViewBag.FiltroActual as string ?? "pendientes";
}

<div class="container-fluid px-0">
    <!-- Header con estadÃ­sticas -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card">
                <div class="stat-icon bg-warning">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Pendientes</p>
                    <h3 class="stat-value">@ViewBag.TotalPendientes</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card">
                <div class="stat-icon bg-danger">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Monto Pendiente</p>
                    <h3 class="stat-value">$@(((decimal)ViewBag.MontoPendiente).ToString("N2"))</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card">
                <div class="stat-icon bg-success">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Aprobados</p>
                    <h3 class="stat-value">@ViewBag.TotalAprobados</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card">
                <div class="stat-icon bg-info">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Total Pagado</p>
                    <h3 class="stat-value">$@(((decimal)ViewBag.MontoAprobado).ToString("N2"))</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <div class="d-flex gap-2 flex-wrap">
                <a href="?filtro=pendientes" class="btn @(filtroActual == "pendientes" ? "btn-warning" : "btn-outline-warning")">
                    <i class="fas fa-clock me-1"></i> Pendientes (@ViewBag.TotalPendientes)
                </a>
                <a href="?filtro=aprobados" class="btn @(filtroActual == "aprobados" ? "btn-success" : "btn-outline-success")">
                    <i class="fas fa-check me-1"></i> Aprobados (@ViewBag.TotalAprobados)
                </a>
                <a href="?filtro=rechazados" class="btn @(filtroActual == "rechazados" ? "btn-danger" : "btn-outline-danger")">
                    <i class="fas fa-times me-1"></i> Rechazados (@ViewBag.TotalRechazados)
                </a>
                <a href="?filtro=todos" class="btn @(filtroActual == "todos" ? "btn-secondary" : "btn-outline-secondary")">
                    <i class="fas fa-list me-1"></i> Todos
                </a>
            </div>
        </div>
    </div>

    <!-- Lista de retiros -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                @switch (filtroActual)
                {
                    case "pendientes":
                        <text>Retiros Pendientes de Aprobacion</text>
                        break;
                    case "aprobados":
                        <text>Retiros Aprobados</text>
                        break;
                    case "rechazados":
                        <text>Retiros Rechazados</text>
                        break;
                    default:
                        <text>Todos los Retiros</text>
                        break;
                }
            </h5>
            <span class="badge bg-primary">@Model.Count retiros</span>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5" class="mb-3">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    <h5 class="text-muted">No hay retiros en esta categoria</h5>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Monto Bruto</th>
                                <th>Comision</th>
                                <th>Impuestos</th>
                                <th>Neto</th>
                                <th>Metodo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th style="width: 150px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var retiro in Model)
                            {
                                <tr>
                                    <td><strong>#@retiro.Id</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            @if (!string.IsNullOrEmpty(retiro.Usuario?.FotoPerfil))
                                            {
                                                <img src="@retiro.Usuario.FotoPerfil" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 12px;">
                                                    @(retiro.Usuario?.NombreCompleto?.Substring(0, 1).ToUpper() ?? "?")
                                                </div>
                                            }
                                            <div>
                                                <div class="fw-semibold">@(retiro.Usuario?.NombreCompleto ?? "Usuario")</div>
                                                <small class="text-muted">@(retiro.Usuario?.Email ?? "")</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>$@retiro.Monto.ToString("N2")</td>
                                    <td class="text-danger">-$@(retiro.Comision?.ToString("N2") ?? "0.00")</td>
                                    <td class="text-danger">-$@(retiro.RetencionImpuestos?.ToString("N2") ?? "0.00")</td>
                                    <td class="fw-bold text-success">$@(retiro.MontoNeto?.ToString("N2") ?? "0.00")</td>
                                    <td>
                                        <span class="badge bg-secondary">@(retiro.MetodoPago ?? "N/A")</span>
                                    </td>
                                    <td>
                                        <small>@retiro.FechaTransaccion.ToString("dd/MM/yy HH:mm")</small>
                                    </td>
                                    <td>
                                        @switch (retiro.EstadoPago)
                                        {
                                            case "Pendiente":
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                                break;
                                            case "Completado":
                                            case "Aprobado":
                                                <span class="badge bg-success">Aprobado</span>
                                                break;
                                            case "Rechazado":
                                                <span class="badge bg-danger">Rechazado</span>
                                                break;
                                            default:
                                                <span class="badge bg-secondary">@retiro.EstadoPago</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="verDetalle(@retiro.Id)" title="Ver detalle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            @if (retiro.EstadoPago == "Pendiente")
                                            {
                                                <button class="btn btn-success" onclick="aprobarRetiro(@retiro.Id)" title="Aprobar">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="rechazarRetiro(@retiro.Id)" title="Rechazar">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Ver Detalle -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle del Retiro #<span id="detalleId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img id="detalleFoto" src="" class="rounded-circle mb-2" style="width: 64px; height: 64px; object-fit: cover;">
                    <h5 id="detalleUsuario" class="mb-0"></h5>
                    <small id="detalleEmail" class="text-muted"></small>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-6">
                        <label class="text-muted small">Monto Bruto</label>
                        <div class="fw-bold" id="detalleMonto"></div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Comision</label>
                        <div class="text-danger" id="detalleComision"></div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Retencion Impuestos</label>
                        <div class="text-danger" id="detalleRetencion"></div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Monto Neto</label>
                        <div class="fw-bold text-success" id="detalleNeto"></div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Metodo de Pago</label>
                        <div id="detalleMetodo"></div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Cuenta</label>
                        <div id="detalleCuenta"></div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small">Fecha Solicitud</label>
                        <div id="detalleFecha"></div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small">Estado</label>
                        <div id="detalleEstado"></div>
                    </div>
                    <div class="col-12" id="divNotas" style="display: none;">
                        <label class="text-muted small">Notas</label>
                        <div id="detalleNotas"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="footerAcciones">
            </div>
        </div>
    </div>
</div>

<!-- Modal Aprobar -->
<div class="modal fade" id="modalAprobar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="AprobarRetiro">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="aprobarId">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check me-2"></i>Aprobar Retiro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Estas por aprobar el retiro <strong>#<span id="aprobarIdText"></span></strong></p>
                    <p class="text-success fw-bold">Monto a pagar: $<span id="aprobarMonto"></span></p>
                    <div class="mb-3">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea name="notas" class="form-control" rows="2" placeholder="Ej: Transferencia realizada, numero de referencia..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Aprobar Retiro</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Rechazar -->
<div class="modal fade" id="modalRechazar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="RechazarRetiro">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="rechazarId">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-times me-2"></i>Rechazar Retiro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Al rechazar, el monto <strong>$<span id="rechazarMontoBruto"></span></strong> sera devuelto al saldo del usuario.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Razon del rechazo *</label>
                        <select name="razon" class="form-select" required>
                            <option value="">Selecciona una razon...</option>
                            <option value="Datos de cuenta incorrectos">Datos de cuenta incorrectos</option>
                            <option value="Cuenta bancaria no verificada">Cuenta bancaria no verificada</option>
                            <option value="Actividad sospechosa detectada">Actividad sospechosa detectada</option>
                            <option value="Documentacion incompleta">Documentacion incompleta</option>
                            <option value="Solicitud duplicada">Solicitud duplicada</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Rechazar y Devolver Saldo</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var retiroActual = null;

        async function verDetalle(id) {
            try {
                const response = await fetch(`/Admin/ObtenerRetiro/${id}`);
                if (!response.ok) throw new Error('Error al cargar');
                retiroActual = await response.json();

                document.getElementById('detalleId').textContent = retiroActual.id;
                document.getElementById('detalleFoto').src = retiroActual.foto || '/images/default-avatar.svg';
                document.getElementById('detalleUsuario').textContent = retiroActual.usuario;
                document.getElementById('detalleEmail').textContent = retiroActual.email;
                document.getElementById('detalleMonto').textContent = '$' + retiroActual.monto.toFixed(2);
                document.getElementById('detalleComision').textContent = '-$' + (retiroActual.comision || 0).toFixed(2);
                document.getElementById('detalleRetencion').textContent = '-$' + (retiroActual.retencion || 0).toFixed(2);
                document.getElementById('detalleNeto').textContent = '$' + (retiroActual.montoNeto || 0).toFixed(2);
                document.getElementById('detalleMetodo').textContent = retiroActual.metodoPago || 'N/A';
                document.getElementById('detalleCuenta').textContent = retiroActual.cuentaRetiro || 'No especificada';
                document.getElementById('detalleFecha').textContent = retiroActual.fecha;
                document.getElementById('detalleEstado').innerHTML = getEstadoBadge(retiroActual.estado);

                if (retiroActual.notas) {
                    document.getElementById('divNotas').style.display = 'block';
                    document.getElementById('detalleNotas').textContent = retiroActual.notas;
                } else {
                    document.getElementById('divNotas').style.display = 'none';
                }

                // Footer con acciones si esta pendiente
                var footer = document.getElementById('footerAcciones');
                if (retiroActual.estado === 'Pendiente') {
                    footer.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-success" onclick="aprobarRetiro(${retiroActual.id})">Aprobar</button>
                        <button type="button" class="btn btn-danger" onclick="rechazarRetiro(${retiroActual.id})">Rechazar</button>
                    `;
                } else {
                    footer.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>`;
                }

                const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
                modal.show();
            } catch (error) {
                alert('Error al cargar el detalle');
            }
        }

        function getEstadoBadge(estado) {
            switch (estado) {
                case 'Pendiente':
                    return '<span class="badge bg-warning text-dark">Pendiente</span>';
                case 'Completado':
                case 'Aprobado':
                    return '<span class="badge bg-success">Aprobado</span>';
                case 'Rechazado':
                    return '<span class="badge bg-danger">Rechazado</span>';
                default:
                    return `<span class="badge bg-secondary">${estado}</span>`;
            }
        }

        async function aprobarRetiro(id) {
            // Cerrar modal de detalle si esta abierto
            var modalDetalle = bootstrap.Modal.getInstance(document.getElementById('modalDetalle'));
            if (modalDetalle) modalDetalle.hide();

            // Cargar datos si no los tenemos
            if (!retiroActual || retiroActual.id !== id) {
                const response = await fetch(`/Admin/ObtenerRetiro/${id}`);
                retiroActual = await response.json();
            }

            document.getElementById('aprobarId').value = id;
            document.getElementById('aprobarIdText').textContent = id;
            document.getElementById('aprobarMonto').textContent = (retiroActual.montoNeto || 0).toFixed(2);

            const modal = new bootstrap.Modal(document.getElementById('modalAprobar'));
            modal.show();
        }

        async function rechazarRetiro(id) {
            // Cerrar modal de detalle si esta abierto
            var modalDetalle = bootstrap.Modal.getInstance(document.getElementById('modalDetalle'));
            if (modalDetalle) modalDetalle.hide();

            // Cargar datos si no los tenemos
            if (!retiroActual || retiroActual.id !== id) {
                const response = await fetch(`/Admin/ObtenerRetiro/${id}`);
                retiroActual = await response.json();
            }

            document.getElementById('rechazarId').value = id;
            document.getElementById('rechazarMontoBruto').textContent = retiroActual.monto.toFixed(2);

            const modal = new bootstrap.Modal(document.getElementById('modalRechazar'));
            modal.show();
        }
    </script>
}

<style>
    .table th {
        font-weight: 600;
        font-size: 0.8125rem;
        text-transform: uppercase;
        color: var(--text-gray);
        border-bottom-width: 2px;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-group .btn {
        padding: 0.375rem 0.5rem;
    }
</style>
