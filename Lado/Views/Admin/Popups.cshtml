@model List<Lado.Models.Popup>
@{
    ViewData["Title"] = "Administrar Popups";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    :root {
        --primary: #4682B4;
        --primary-dark: #36648B;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --text-dark: #1a1a2e;
        --text-gray: #64748b;
        --border-color: #e2e8f0;
        --bg-light: #f8fafc;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid var(--border-color);
    }

    .stat-card h3 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: var(--text-dark);
    }

    .stat-card p {
        font-size: 13px;
        color: var(--text-gray);
        margin: 4px 0 0;
    }

    /* Table */
    .table-container {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .popups-table {
        width: 100%;
        border-collapse: collapse;
    }

    .popups-table th {
        background: var(--bg-light);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        color: var(--text-gray);
        border-bottom: 1px solid var(--border-color);
    }

    .popups-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }

    .popups-table tr:last-child td {
        border-bottom: none;
    }

    .popup-name {
        font-weight: 600;
        color: var(--text-dark);
    }

    .popup-subtitle {
        font-size: 12px;
        color: var(--text-gray);
        margin-top: 2px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-modal { background: #e0f2fe; color: #0369a1; }
    .badge-banner { background: #fef3c7; color: #b45309; }
    .badge-toast { background: #f3e8ff; color: #7c3aed; }
    .badge-fullscreen { background: #fce7f3; color: #be185d; }
    .badge-slide { background: #d1fae5; color: #047857; }

    /* Toggle Switch */
    .toggle {
        position: relative;
        width: 44px;
        height: 24px;
    }

    .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    .toggle input:checked + .toggle-slider {
        background-color: var(--success);
    }

    .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    /* Actions */
    .actions {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-light);
        color: var(--text-gray);
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--border-color);
        color: var(--text-dark);
    }

    .btn-icon.danger:hover {
        background: #fee2e2;
        color: var(--danger);
    }

    .btn-icon svg {
        width: 16px;
        height: 16px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .modal-header h2 {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: var(--text-gray);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        position: sticky;
        bottom: 0;
        background: white;
    }

    /* Form */
    .form-section {
        margin-bottom: 24px;
    }

    .form-section h3 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group.full {
        grid-column: span 2;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 6px;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="datetime-local"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-row {
        display: flex;
        gap: 16px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checkbox-item label {
        margin: 0;
        cursor: pointer;
    }

    /* Image upload */
    .image-upload {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .image-upload:hover {
        border-color: var(--primary);
        background: var(--bg-light);
    }

    .image-upload.has-image {
        padding: 0;
        border-style: solid;
    }

    .image-upload img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 10px;
    }

    .image-upload-text {
        color: var(--text-gray);
        font-size: 14px;
    }

    .btn-secondary {
        background: var(--bg-light);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }

    /* Color picker */
    .color-input {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .color-input input[type="color"] {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        padding: 0;
    }

    .color-input input[type="text"] {
        flex: 1;
    }

    /* Toast notification */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--text-dark);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 2000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
    }

    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    .toast.success {
        background: var(--success);
    }

    .toast.error {
        background: var(--danger);
    }

    @@media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        .form-group.full {
            grid-column: span 1;
        }
        .form-row {
            flex-direction: column;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
        Popups
    </h1>
    <button class="btn-primary" onclick="abrirModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nuevo Popup
    </button>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>@Model.Count</h3>
        <p>Total Popups</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Count(p => p.EstaActivo)</h3>
        <p>Activos</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Sum(p => p.Impresiones).ToString("N0")</h3>
        <p>Impresiones</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Sum(p => p.Clics).ToString("N0")</h3>
        <p>Clics</p>
    </div>
</div>

<!-- Table -->
<div class="table-container">
    @if (Model.Any())
    {
        <table class="popups-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Impresiones</th>
                    <th>Clics</th>
                    <th>CTR</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var popup in Model)
                {
                    var badgeClass = popup.Tipo switch
                    {
                        Lado.Models.TipoPopup.Banner => "badge-banner",
                        Lado.Models.TipoPopup.Modal => "badge-modal",
                        Lado.Models.TipoPopup.Toast => "badge-toast",
                        Lado.Models.TipoPopup.FullScreen => "badge-fullscreen",
                        Lado.Models.TipoPopup.Slide => "badge-slide",
                        _ => "badge-modal"
                    };
                    <tr data-id="@popup.Id">
                        <td>
                            <div class="popup-name">@(popup.Nombre ?? "Sin nombre")</div>
                            @if (!string.IsNullOrEmpty(popup.Titulo))
                            {
                                <div class="popup-subtitle">@popup.Titulo</div>
                            }
                        </td>
                        <td>
                            <span class="badge @badgeClass">@popup.TipoDisplay</span>
                        </td>
                        <td>
                            <label class="toggle">
                                <input type="checkbox" @(popup.EstaActivo ? "checked" : "") onchange="togglePopup(@popup.Id, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td>@popup.Impresiones.ToString("N0")</td>
                        <td>@popup.Clics.ToString("N0")</td>
                        <td><strong>@popup.CTR.ToString("F1")%</strong></td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon" onclick="editarPopup(@popup.Id)" title="Editar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn-icon" onclick="duplicarPopup(@popup.Id)" title="Duplicar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                <button class="btn-icon danger" onclick="eliminarPopup(@popup.Id)" title="Eliminar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <h3>No hay popups</h3>
            <p>Crea tu primer popup para mostrar promociones o mensajes importantes</p>
            <button class="btn-primary" onclick="abrirModal()" style="margin-top:16px;">Crear Popup</button>
        </div>
    }
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">Nuevo Popup</h2>
            <button class="modal-close" onclick="cerrarModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="popupId" value="">

            <!-- Basico -->
            <div class="form-section">
                <h3>Informacion Basica</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre interno *</label>
                        <input type="text" id="nombre" placeholder="Ej: Popup Navidad 2024" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="tipo">
                            <option value="0">Banner</option>
                            <option value="1" selected>Modal</option>
                            <option value="2">Toast</option>
                            <option value="3">Pantalla Completa</option>
                            <option value="4">Panel Lateral</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Titulo (opcional)</label>
                        <input type="text" id="titulo" placeholder="Titulo del popup">
                    </div>
                    <div class="form-group full">
                        <label>Contenido HTML</label>
                        <textarea id="contenido" placeholder="<p>Tu mensaje aqui...</p>"></textarea>
                    </div>
                </div>
            </div>

            <!-- Imagen -->
            <div class="form-section">
                <h3>Imagen</h3>
                <div class="image-upload" id="dropzone" onclick="document.getElementById('imagenInput').click()">
                    <input type="file" id="imagenInput" accept="image/*" style="display:none;" onchange="subirImagen(this)">
                    <input type="hidden" id="imagenUrl">
                    <div id="imagePreview">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#ccc;margin-bottom:8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <div class="image-upload-text">Click para subir imagen</div>
                    </div>
                </div>
            </div>

            <!-- Diseno -->
            <div class="form-section">
                <h3>Diseno</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Posicion</label>
                        <select id="posicion">
                            <option value="0">Centro</option>
                            <option value="1">Arriba Izquierda</option>
                            <option value="2">Arriba Centro</option>
                            <option value="3">Arriba Derecha</option>
                            <option value="4">Abajo Izquierda</option>
                            <option value="5">Abajo Centro</option>
                            <option value="6">Abajo Derecha</option>
                            <option value="7">Izquierda</option>
                            <option value="8">Derecha</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Animacion</label>
                        <select id="animacion">
                            <option value="0">Fade In</option>
                            <option value="1">Slide Down</option>
                            <option value="2">Slide Up</option>
                            <option value="3">Slide Left</option>
                            <option value="4">Slide Right</option>
                            <option value="5">Scale</option>
                            <option value="6">Bounce</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Color de Fondo</label>
                        <div class="color-input">
                            <input type="color" id="colorFondoPicker" value="#ffffff" onchange="document.getElementById('colorFondo').value=this.value">
                            <input type="text" id="colorFondo" value="#ffffff" placeholder="#ffffff">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Color de Texto</label>
                        <div class="color-input">
                            <input type="color" id="colorTextoPicker" value="#111111" onchange="document.getElementById('colorTexto').value=this.value">
                            <input type="text" id="colorTexto" value="#111111" placeholder="#111111">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Color Boton</label>
                        <div class="color-input">
                            <input type="color" id="colorBotonPicker" value="#4682B4" onchange="document.getElementById('colorBoton').value=this.value">
                            <input type="text" id="colorBoton" value="#4682B4" placeholder="#4682B4">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ancho Maximo (px)</label>
                        <input type="number" id="anchoMaximo" value="400" min="200" max="1000">
                    </div>
                </div>
                <div class="checkbox-group" style="margin-top:16px;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="mostrarBotonCerrar" checked>
                        <label for="mostrarBotonCerrar">Mostrar boton cerrar</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cerrarAlClickFuera" checked>
                        <label for="cerrarAlClickFuera">Cerrar al click fuera</label>
                    </div>
                </div>
            </div>

            <!-- Trigger -->
            <div class="form-section">
                <h3>Disparador</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cuando mostrar</label>
                        <select id="trigger" onchange="toggleTriggerOptions()">
                            <option value="0">Inmediatamente</option>
                            <option value="1">Despues de X segundos</option>
                            <option value="2">Al hacer scroll</option>
                            <option value="3">Al intentar salir</option>
                            <option value="4">Despues de X visitas</option>
                        </select>
                    </div>
                    <div class="form-group" id="delayGroup" style="display:none;">
                        <label>Segundos de espera</label>
                        <input type="number" id="delaySegundos" value="5" min="1" max="60">
                    </div>
                    <div class="form-group" id="scrollGroup" style="display:none;">
                        <label>Porcentaje de scroll</label>
                        <input type="number" id="scrollPorcentaje" value="50" min="1" max="100">
                    </div>
                    <div class="form-group" id="visitasGroup" style="display:none;">
                        <label>Numero de visitas</label>
                        <input type="number" id="visitasRequeridas" value="3" min="1" max="100">
                    </div>
                </div>
            </div>

            <!-- Segmentacion -->
            <div class="form-section">
                <h3>Segmentacion</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="mostrarUsuariosLogueados" checked>
                        <label for="mostrarUsuariosLogueados">Usuarios logueados</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mostrarUsuariosAnonimos" checked>
                        <label for="mostrarUsuariosAnonimos">Usuarios anonimos</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mostrarEnMovil" checked>
                        <label for="mostrarEnMovil">Movil</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mostrarEnDesktop" checked>
                        <label for="mostrarEnDesktop">Desktop</label>
                    </div>
                </div>
                <div class="form-grid" style="margin-top:16px;">
                    <div class="form-group">
                        <label>Paginas incluidas (separadas por coma)</label>
                        <input type="text" id="paginasIncluidas" placeholder="Ej: /Feed,/Contenido o vacio para todas">
                    </div>
                    <div class="form-group">
                        <label>Paginas excluidas</label>
                        <input type="text" id="paginasExcluidas" placeholder="Ej: /Admin">
                    </div>
                </div>
            </div>

            <!-- Frecuencia -->
            <div class="form-section">
                <h3>Frecuencia y Estado</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Frecuencia</label>
                        <select id="frecuencia" onchange="toggleFrecuenciaOptions()">
                            <option value="0">Una vez por sesion</option>
                            <option value="1">Una vez por dia</option>
                            <option value="2">Una vez</option>
                            <option value="3">Cada X dias</option>
                            <option value="4">Siempre</option>
                        </select>
                    </div>
                    <div class="form-group" id="diasGroup" style="display:none;">
                        <label>Cada cuantos dias</label>
                        <input type="number" id="diasFrecuencia" value="7" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label>Prioridad (1-10)</label>
                        <input type="number" id="prioridad" value="5" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Fecha inicio (opcional)</label>
                        <input type="datetime-local" id="fechaInicio">
                    </div>
                    <div class="form-group">
                        <label>Fecha fin (opcional)</label>
                        <input type="datetime-local" id="fechaFin">
                    </div>
                </div>
                <div class="checkbox-group" style="margin-top:16px;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="estaActivo" checked>
                        <label for="estaActivo">Popup activo</label>
                    </div>
                </div>
            </div>

            <!-- PWA -->
            <div class="form-section">
                <h3>PWA (Instalacion de App)</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="esPWA" onchange="togglePWAOptions()">
                        <label for="esPWA">Habilitar funcionalidad PWA</label>
                    </div>
                </div>
                <div id="pwaOptions" style="display:none;margin-top:16px;">
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="soloSiInstalable">
                            <label for="soloSiInstalable">Solo si es instalable</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soloIOS">
                            <label for="soloIOS">Solo iOS</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soloAndroid">
                            <label for="soloAndroid">Solo Android</label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:16px;">
                        <label>Texto boton instalar</label>
                        <input type="text" id="textoBotonInstalar" placeholder="Instalar">
                    </div>
                    <div class="form-group">
                        <label>Contenido especial para iOS</label>
                        <textarea id="contenidoIOS" placeholder="Instrucciones para usuarios iOS..."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
            <button class="btn-primary" onclick="guardarPopup()">Guardar</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

@Html.AntiForgeryToken()

<script>
    let editandoId = null;

    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.className = 'toast', 3000);
    }

    function abrirModal() {
        editandoId = null;
        document.getElementById('popupId').value = '';
        document.getElementById('modalTitle').textContent = 'Nuevo Popup';
        resetForm();
        document.getElementById('modal').classList.add('active');
    }

    function cerrarModal() {
        document.getElementById('modal').classList.remove('active');
    }

    function resetForm() {
        document.getElementById('nombre').value = '';
        document.getElementById('tipo').value = '1';
        document.getElementById('titulo').value = '';
        document.getElementById('contenido').value = '';
        document.getElementById('imagenUrl').value = '';
        document.getElementById('imagePreview').innerHTML = `
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#ccc;margin-bottom:8px;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <div class="image-upload-text">Click para subir imagen</div>
        `;
        document.getElementById('dropzone').classList.remove('has-image');
        document.getElementById('posicion').value = '0';
        document.getElementById('animacion').value = '0';
        document.getElementById('colorFondo').value = '#ffffff';
        document.getElementById('colorFondoPicker').value = '#ffffff';
        document.getElementById('colorTexto').value = '#111111';
        document.getElementById('colorTextoPicker').value = '#111111';
        document.getElementById('colorBoton').value = '#4682B4';
        document.getElementById('colorBotonPicker').value = '#4682B4';
        document.getElementById('anchoMaximo').value = '400';
        document.getElementById('mostrarBotonCerrar').checked = true;
        document.getElementById('cerrarAlClickFuera').checked = true;
        document.getElementById('trigger').value = '0';
        document.getElementById('delaySegundos').value = '5';
        document.getElementById('scrollPorcentaje').value = '50';
        document.getElementById('visitasRequeridas').value = '3';
        document.getElementById('mostrarUsuariosLogueados').checked = true;
        document.getElementById('mostrarUsuariosAnonimos').checked = true;
        document.getElementById('mostrarEnMovil').checked = true;
        document.getElementById('mostrarEnDesktop').checked = true;
        document.getElementById('paginasIncluidas').value = '';
        document.getElementById('paginasExcluidas').value = '';
        document.getElementById('frecuencia').value = '0';
        document.getElementById('diasFrecuencia').value = '7';
        document.getElementById('prioridad').value = '5';
        document.getElementById('fechaInicio').value = '';
        document.getElementById('fechaFin').value = '';
        document.getElementById('estaActivo').checked = true;
        document.getElementById('esPWA').checked = false;
        document.getElementById('soloSiInstalable').checked = false;
        document.getElementById('soloIOS').checked = false;
        document.getElementById('soloAndroid').checked = false;
        document.getElementById('textoBotonInstalar').value = '';
        document.getElementById('contenidoIOS').value = '';
        toggleTriggerOptions();
        toggleFrecuenciaOptions();
        togglePWAOptions();
    }

    function toggleTriggerOptions() {
        const trigger = document.getElementById('trigger').value;
        document.getElementById('delayGroup').style.display = trigger === '1' ? 'block' : 'none';
        document.getElementById('scrollGroup').style.display = trigger === '2' ? 'block' : 'none';
        document.getElementById('visitasGroup').style.display = trigger === '4' ? 'block' : 'none';
    }

    function toggleFrecuenciaOptions() {
        const frecuencia = document.getElementById('frecuencia').value;
        document.getElementById('diasGroup').style.display = frecuencia === '3' ? 'block' : 'none';
    }

    function togglePWAOptions() {
        const esPWA = document.getElementById('esPWA').checked;
        document.getElementById('pwaOptions').style.display = esPWA ? 'block' : 'none';
    }

    async function subirImagen(input) {
        if (!input.files || !input.files[0]) return;

        const formData = new FormData();
        formData.append('imagen', input.files[0]);

        try {
            const response = await fetch('/Admin/SubirImagenPopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const result = await response.json();
            if (result.success) {
                document.getElementById('imagenUrl').value = result.url;
                document.getElementById('imagePreview').innerHTML = `<img src="${result.url}" alt="Preview">`;
                document.getElementById('dropzone').classList.add('has-image');
                showToast('Imagen subida', 'success');
            } else {
                showToast(result.message || 'Error al subir imagen', 'error');
            }
        } catch (error) {
            showToast('Error al subir imagen', 'error');
        }
    }

    async function editarPopup(id) {
        try {
            const response = await fetch(`/Admin/ObtenerPopup?id=${id}`);
            const result = await response.json();

            if (result.success) {
                const p = result.popup;
                editandoId = id;
                document.getElementById('popupId').value = id;
                document.getElementById('modalTitle').textContent = 'Editar Popup';

                document.getElementById('nombre').value = p.nombre || '';
                document.getElementById('tipo').value = p.tipo;
                document.getElementById('titulo').value = p.titulo || '';
                document.getElementById('contenido').value = p.contenido || '';

                if (p.imagenUrl) {
                    document.getElementById('imagenUrl').value = p.imagenUrl;
                    document.getElementById('imagePreview').innerHTML = `<img src="${p.imagenUrl}" alt="Preview">`;
                    document.getElementById('dropzone').classList.add('has-image');
                } else {
                    document.getElementById('imagenUrl').value = '';
                    document.getElementById('imagePreview').innerHTML = `
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#ccc;margin-bottom:8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <div class="image-upload-text">Click para subir imagen</div>
                    `;
                    document.getElementById('dropzone').classList.remove('has-image');
                }

                document.getElementById('posicion').value = p.posicion;
                document.getElementById('animacion').value = p.animacion;
                document.getElementById('colorFondo').value = p.colorFondo || '#ffffff';
                document.getElementById('colorFondoPicker').value = (p.colorFondo && !p.colorFondo.includes('00000000')) ? p.colorFondo : '#ffffff';
                document.getElementById('colorTexto').value = p.colorTexto || '#111111';
                document.getElementById('colorTextoPicker').value = p.colorTexto || '#111111';
                document.getElementById('colorBoton').value = p.colorBotonPrimario || '#4682B4';
                document.getElementById('colorBotonPicker').value = p.colorBotonPrimario || '#4682B4';
                document.getElementById('anchoMaximo').value = p.anchoMaximo || 400;
                document.getElementById('mostrarBotonCerrar').checked = p.mostrarBotonCerrar;
                document.getElementById('cerrarAlClickFuera').checked = p.cerrarAlClickFuera;
                document.getElementById('trigger').value = p.trigger;
                document.getElementById('delaySegundos').value = p.delaySegundos || 5;
                document.getElementById('scrollPorcentaje').value = p.scrollPorcentaje || 50;
                document.getElementById('visitasRequeridas').value = p.visitasRequeridas || 3;
                document.getElementById('mostrarUsuariosLogueados').checked = p.mostrarUsuariosLogueados;
                document.getElementById('mostrarUsuariosAnonimos').checked = p.mostrarUsuariosAnonimos;
                document.getElementById('mostrarEnMovil').checked = p.mostrarEnMovil;
                document.getElementById('mostrarEnDesktop').checked = p.mostrarEnDesktop;
                document.getElementById('paginasIncluidas').value = p.paginasIncluidas || '';
                document.getElementById('paginasExcluidas').value = p.paginasExcluidas || '';
                document.getElementById('frecuencia').value = p.frecuencia;
                document.getElementById('diasFrecuencia').value = p.diasFrecuencia || 7;
                document.getElementById('prioridad').value = p.prioridad || 5;
                document.getElementById('fechaInicio').value = p.fechaInicio || '';
                document.getElementById('fechaFin').value = p.fechaFin || '';
                document.getElementById('estaActivo').checked = p.estaActivo;
                document.getElementById('esPWA').checked = p.esPWA;
                document.getElementById('soloSiInstalable').checked = p.soloSiInstalable;
                document.getElementById('soloIOS').checked = p.soloIOS;
                document.getElementById('soloAndroid').checked = p.soloAndroid;
                document.getElementById('textoBotonInstalar').value = p.textoBotonInstalar || '';
                document.getElementById('contenidoIOS').value = p.contenidoIOS || '';

                toggleTriggerOptions();
                toggleFrecuenciaOptions();
                togglePWAOptions();

                document.getElementById('modal').classList.add('active');
            } else {
                showToast(result.message || 'Error al cargar popup', 'error');
            }
        } catch (error) {
            showToast('Error al cargar popup', 'error');
        }
    }

    async function guardarPopup() {
        const nombre = document.getElementById('nombre').value.trim();
        if (!nombre) {
            showToast('El nombre es requerido', 'error');
            return;
        }

        const formData = new FormData();
        const id = document.getElementById('popupId').value;
        if (id) formData.append('id', id);

        formData.append('nombre', nombre);
        formData.append('tipo', document.getElementById('tipo').value);
        formData.append('titulo', document.getElementById('titulo').value);
        formData.append('contenido', document.getElementById('contenido').value);
        formData.append('imagenUrl', document.getElementById('imagenUrl').value);
        formData.append('posicion', document.getElementById('posicion').value);
        formData.append('colorFondo', document.getElementById('colorFondo').value);
        formData.append('colorTexto', document.getElementById('colorTexto').value);
        formData.append('colorBotonPrimario', document.getElementById('colorBoton').value);
        formData.append('animacion', document.getElementById('animacion').value);
        formData.append('anchoMaximo', document.getElementById('anchoMaximo').value);
        formData.append('mostrarBotonCerrar', document.getElementById('mostrarBotonCerrar').checked);
        formData.append('cerrarAlClickFuera', document.getElementById('cerrarAlClickFuera').checked);
        formData.append('trigger', document.getElementById('trigger').value);
        formData.append('delaySegundos', document.getElementById('delaySegundos').value);
        formData.append('scrollPorcentaje', document.getElementById('scrollPorcentaje').value);
        formData.append('visitasRequeridas', document.getElementById('visitasRequeridas').value);
        formData.append('mostrarUsuariosLogueados', document.getElementById('mostrarUsuariosLogueados').checked);
        formData.append('mostrarUsuariosAnonimos', document.getElementById('mostrarUsuariosAnonimos').checked);
        formData.append('mostrarEnMovil', document.getElementById('mostrarEnMovil').checked);
        formData.append('mostrarEnDesktop', document.getElementById('mostrarEnDesktop').checked);
        formData.append('paginasIncluidas', document.getElementById('paginasIncluidas').value);
        formData.append('paginasExcluidas', document.getElementById('paginasExcluidas').value);
        formData.append('frecuencia', document.getElementById('frecuencia').value);
        formData.append('diasFrecuencia', document.getElementById('diasFrecuencia').value);
        formData.append('estaActivo', document.getElementById('estaActivo').checked);
        formData.append('fechaInicio', document.getElementById('fechaInicio').value);
        formData.append('fechaFin', document.getElementById('fechaFin').value);
        formData.append('prioridad', document.getElementById('prioridad').value);
        formData.append('esPWA', document.getElementById('esPWA').checked);
        formData.append('soloSiInstalable', document.getElementById('soloSiInstalable').checked);
        formData.append('soloIOS', document.getElementById('soloIOS').checked);
        formData.append('soloAndroid', document.getElementById('soloAndroid').checked);
        formData.append('textoBotonInstalar', document.getElementById('textoBotonInstalar').value);
        formData.append('contenidoIOS', document.getElementById('contenidoIOS').value);

        try {
            const response = await fetch('/Admin/GuardarPopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const result = await response.json();
            if (result.success) {
                showToast('Popup guardado', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(result.message || 'Error al guardar', 'error');
            }
        } catch (error) {
            showToast('Error al guardar popup', 'error');
        }
    }

    async function togglePopup(id, activo) {
        try {
            const formData = new FormData();
            formData.append('id', id);
            formData.append('activo', activo);

            const response = await fetch('/Admin/TogglePopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const result = await response.json();
            if (result.success) {
                showToast(activo ? 'Popup activado' : 'Popup desactivado', 'success');
            } else {
                showToast(result.message || 'Error', 'error');
                location.reload();
            }
        } catch (error) {
            showToast('Error', 'error');
            location.reload();
        }
    }

    async function duplicarPopup(id) {
        if (!confirm('¿Duplicar este popup?')) return;

        try {
            const formData = new FormData();
            formData.append('id', id);

            const response = await fetch('/Admin/DuplicarPopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const result = await response.json();
            if (result.success) {
                showToast('Popup duplicado', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(result.message || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error al duplicar', 'error');
        }
    }

    async function eliminarPopup(id) {
        if (!confirm('¿Eliminar este popup? Esta accion no se puede deshacer.')) return;

        try {
            const formData = new FormData();
            formData.append('id', id);

            const response = await fetch('/Admin/EliminarPopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            const result = await response.json();
            if (result.success) {
                showToast('Popup eliminado', 'success');
                document.querySelector(`tr[data-id="${id}"]`)?.remove();
            } else {
                showToast(result.message || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error al eliminar', 'error');
        }
    }

    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') cerrarModal();
    });

    // Cerrar modal al hacer click fuera
    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') cerrarModal();
    });
</script>
