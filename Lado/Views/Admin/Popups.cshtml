@model List<Lado.Models.Popup>
@{
    ViewData["Title"] = "Administrar Popups";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    :root {
        --primary: #4682B4;
        --primary-dark: #36648B;
        --primary-light: #B0C4DE;
        --primary-pale: rgba(70, 130, 180, 0.08);
        --primary-gradient: linear-gradient(135deg, #4682B4 0%, #36648B 100%);
        --text-dark: #1a1a2e;
        --text-gray: #64748b;
        --text-light: #94a3b8;
        --border-color: #e2e8f0;
        --border-light: #f1f5f9;
        --bg-light: #f8fafc;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
    }

    /* ========================================
       PAGE HEADER
       ======================================== */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 800;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-title svg {
        width: 32px;
        height: 32px;
        color: var(--primary);
    }

    .btn-nuevo {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(70, 130, 180, 0.3);
    }

    .btn-nuevo:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(70, 130, 180, 0.4);
    }

    /* ========================================
       STATS CARDS
       ======================================== */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 14px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

    .stat-content h3 {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .stat-content p {
        font-size: 13px;
        color: var(--text-gray);
        margin: 0;
    }

    /* ========================================
       POPUPS TABLE
       ======================================== */
    .popups-container {
        background: white;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .popups-table {
        width: 100%;
        border-collapse: collapse;
    }

    .popups-table th {
        background: var(--bg-light);
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-color);
    }

    .popups-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-light);
        vertical-align: middle;
    }

    .popups-table tr:hover {
        background: var(--primary-pale);
    }

    .popup-name {
        font-weight: 600;
        color: var(--text-dark);
    }

    .popup-tipo {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }

    .popup-tipo.banner { background: #dbeafe; color: #1e40af; }
    .popup-tipo.modal { background: #fce7f3; color: #9d174d; }
    .popup-tipo.toast { background: #d1fae5; color: #065f46; }
    .popup-tipo.fullscreen { background: #fef3c7; color: #92400e; }
    .popup-tipo.slide { background: #e0e7ff; color: #3730a3; }

    .popup-estado {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .estado-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .estado-dot.activo { background: var(--success); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
    .estado-dot.inactivo { background: var(--danger); }

    .popup-stats {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: var(--text-gray);
    }

    .popup-stats span {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .popup-actions {
        display: flex;
        gap: 6px;
    }

    .btn-action {
        width: 34px;
        height: 34px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: var(--text-gray);
    }

    .btn-action:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .btn-action.danger:hover {
        background: var(--danger);
        border-color: var(--danger);
    }

    .btn-action svg {
        width: 16px;
        height: 16px;
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #cbd5e1;
        border-radius: 24px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
        background: var(--success);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 40px;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: var(--primary-pale);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .empty-icon svg {
        width: 40px;
        height: 40px;
        color: var(--primary);
    }

    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 8px;
    }

    .empty-state p {
        color: var(--text-gray);
        margin: 0 0 20px;
    }

    /* ========================================
       MODAL
       ======================================== */
    .popup-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 20px;
        z-index: 10000;
        overflow-y: auto;
    }

    .popup-modal-overlay.active {
        display: flex;
    }

    .popup-modal {
        background: white;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 1100px;
        max-height: calc(100vh - 80px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-light);
    }

    .modal-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: var(--shadow-sm);
    }

    .modal-close:hover {
        background: var(--danger);
        color: white;
    }

    .modal-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* ========================================
       WIZARD STEPS
       ======================================== */
    .wizard-sidebar {
        width: 220px;
        background: var(--bg-light);
        border-right: 1px solid var(--border-color);
        padding: 20px 0;
        flex-shrink: 0;
    }

    .wizard-step {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .wizard-step:hover {
        background: white;
    }

    .wizard-step.active {
        background: white;
        border-left-color: var(--primary);
    }

    .wizard-step-number {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--border-color);
        color: var(--text-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
    }

    .wizard-step.active .wizard-step-number {
        background: var(--primary);
        color: white;
    }

    .wizard-step.completed .wizard-step-number {
        background: var(--success);
        color: white;
    }

    .wizard-step-info h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0;
    }

    .wizard-step-info p {
        font-size: 11px;
        color: var(--text-gray);
        margin: 0;
    }

    /* ========================================
       FORM CONTENT
       ======================================== */
    .form-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
    }

    .step-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 8px;
    }

    .step-description {
        color: var(--text-gray);
        font-size: 14px;
        margin: 0 0 24px;
    }

    /* Templates Grid */
    .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .template-card {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

    .template-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .template-card.selected {
        border-color: var(--primary);
        background: var(--primary-pale);
    }

    .template-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        background: var(--primary-pale);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 28px;
    }

    .template-card h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 4px;
    }

    .template-card p {
        font-size: 12px;
        color: var(--text-gray);
        margin: 0;
    }

    /* Form Groups */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 6px;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="datetime-local"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 14px;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-pale);
    }

    .form-group small {
        display: block;
        font-size: 11px;
        color: var(--text-light);
        margin-top: 4px;
    }

    /* ========================================
       IMAGE UPLOAD
       ======================================== */
    .image-upload-section {
        margin-bottom: 20px;
    }

    .image-dropzone {
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-md);
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-light);
    }

    .image-dropzone:hover,
    .image-dropzone.dragover {
        border-color: var(--primary);
        background: var(--primary-pale);
    }

    .image-dropzone.has-image {
        padding: 16px;
    }

    .dropzone-icon {
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        box-shadow: var(--shadow-sm);
    }

    .dropzone-icon svg {
        width: 28px;
        height: 28px;
        color: var(--primary);
    }

    .dropzone-text h4 {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0 0 4px;
    }

    .dropzone-text p {
        font-size: 13px;
        color: var(--text-gray);
        margin: 0;
    }

    .image-preview {
        position: relative;
        display: inline-block;
        max-width: 100%;
    }

    .image-preview img {
        max-width: 300px;
        max-height: 200px;
        border-radius: var(--radius-sm);
        object-fit: contain;
    }

    .image-preview-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-gallery-toggle {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--primary);
        font-size: 13px;
        cursor: pointer;
    }

    .image-gallery {
        display: none;
        margin-top: 16px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        max-height: 200px;
        overflow-y: auto;
    }

    .image-gallery.show {
        display: block;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }

    .gallery-item {
        aspect-ratio: 1;
        border-radius: var(--radius-sm);
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .gallery-item:hover {
        border-color: var(--primary);
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ========================================
       CONTENT EDITOR
       ======================================== */
    .content-editor-wrapper {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .editor-toolbar {
        display: flex;
        gap: 4px;
        padding: 8px 12px;
        background: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
    }

    .editor-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        transition: all 0.2s;
    }

    .editor-btn:hover {
        background: white;
        color: var(--primary);
    }

    .editor-btn.active {
        background: var(--primary);
        color: white;
    }

    .editor-divider {
        width: 1px;
        background: var(--border-color);
        margin: 0 4px;
    }

    .editor-content {
        min-height: 200px;
        padding: 16px;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
    }

    .editor-html {
        display: none;
        width: 100%;
        min-height: 200px;
        padding: 16px;
        border: none;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        resize: vertical;
    }

    .editor-html.show {
        display: block;
    }

    .editor-content.hidden {
        display: none;
    }

    /* ========================================
       POSITION SELECTOR
       ======================================== */
    .position-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        max-width: 240px;
    }

    .position-btn {
        aspect-ratio: 1;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        background: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s;
        font-size: 10px;
        color: var(--text-gray);
    }

    .position-btn:hover {
        border-color: var(--primary-light);
    }

    .position-btn.active {
        border-color: var(--primary);
        background: var(--primary-pale);
        color: var(--primary);
    }

    .position-btn .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--border-color);
    }

    .position-btn.active .dot {
        background: var(--primary);
    }

    /* ========================================
       COLOR PICKER
       ======================================== */
    .color-input {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .color-input input[type="color"] {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        padding: 0;
    }

    .color-input input[type="text"] {
        flex: 1;
    }

    /* ========================================
       CHECKBOX GROUP
       ======================================== */
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s;
    }

    .checkbox-item:hover {
        background: var(--primary-pale);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .checkbox-item span {
        font-size: 13px;
        color: var(--text-dark);
    }

    /* ========================================
       BUTTONS EDITOR
       ======================================== */
    .buttons-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }

    .button-item {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 12px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
    }

    .button-item input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 13px;
    }

    .button-item select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 13px;
    }

    .button-item-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--danger);
        cursor: pointer;
        border-radius: 4px;
    }

    .button-item-remove:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    .btn-add-button {
        padding: 10px 16px;
        border: 1px dashed var(--border-color);
        background: transparent;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 13px;
        color: var(--text-gray);
        transition: all 0.2s;
    }

    .btn-add-button:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    /* ========================================
       PREVIEW PANEL
       ======================================== */
    .preview-sidebar {
        width: 350px;
        background: #1a1a2e;
        border-left: 1px solid var(--border-color);
        padding: 20px;
        flex-shrink: 0;
        overflow-y: auto;
    }

    .preview-title {
        color: white;
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .preview-device-toggle {
        display: flex;
        gap: 4px;
        margin-bottom: 16px;
    }

    .device-btn {
        flex: 1;
        padding: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        background: transparent;
        border-radius: var(--radius-sm);
        color: rgba(255,255,255,0.6);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .device-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .preview-frame {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-md);
        overflow: hidden;
        aspect-ratio: 9/16;
        position: relative;
    }

    .preview-frame.desktop {
        aspect-ratio: 16/10;
    }

    /* Contenido simulado de fondo */
    .preview-frame::before {
        content: '';
        position: absolute;
        inset: 0;
        background:
            linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%),
            repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(255,255,255,0.05) 40px, rgba(255,255,255,0.05) 80px);
    }

    /* Overlay oscuro para Modal/FullScreen/Slide */
    .preview-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        z-index: 1;
    }

    .preview-overlay.active {
        display: block;
    }

    /* ========== MODAL ========== */
    .preview-popup {
        position: absolute;
        z-index: 2;
        text-align: center;
        transition: all 0.3s ease;
    }

    .preview-popup.tipo-modal {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 24px;
        max-width: 90%;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    /* ========== BANNER ========== */
    .preview-popup.tipo-banner {
        left: 0;
        right: 0;
        padding: 12px 16px;
        border-radius: 0;
        max-width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .preview-popup.tipo-banner.pos-top {
        top: 0;
    }

    .preview-popup.tipo-banner.pos-bottom {
        bottom: 0;
        top: auto;
    }

    /* ========== TOAST ========== */
    .preview-popup.tipo-toast {
        padding: 16px;
        border-radius: 12px;
        max-width: 280px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        text-align: left;
    }

    .preview-popup.tipo-toast.pos-top-left { top: 12px; left: 12px; }
    .preview-popup.tipo-toast.pos-top-center { top: 12px; left: 50%; transform: translateX(-50%); }
    .preview-popup.tipo-toast.pos-top-right { top: 12px; right: 12px; }
    .preview-popup.tipo-toast.pos-bottom-left { bottom: 12px; left: 12px; }
    .preview-popup.tipo-toast.pos-bottom-center { bottom: 12px; left: 50%; transform: translateX(-50%); }
    .preview-popup.tipo-toast.pos-bottom-right { bottom: 12px; right: 12px; }

    /* ========== FULLSCREEN ========== */
    .preview-popup.tipo-fullscreen {
        inset: 0;
        padding: 24px;
        border-radius: 0;
        max-width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* ========== SLIDE (Panel lateral) ========== */
    .preview-popup.tipo-slide {
        top: 0;
        bottom: 0;
        width: 70%;
        max-width: 280px;
        padding: 20px;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 40px rgba(0,0,0,0.3);
    }

    .preview-popup.tipo-slide.pos-left {
        left: 0;
    }

    .preview-popup.tipo-slide.pos-right {
        right: 0;
        left: auto;
    }

    /* ========== Boton cerrar ========== */
    .preview-close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: rgba(0,0,0,0.1);
        color: inherit;
        font-size: 14px;
        cursor: default;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3;
    }

    .tipo-banner .preview-close-btn {
        position: relative;
        top: auto;
        right: auto;
        margin-left: auto;
    }

    /* ========== Animaciones de preview ========== */
    .preview-popup.anim-bounce {
        animation: previewBounce 0.5s ease;
    }

    .preview-popup.anim-zoom {
        animation: previewZoom 0.3s ease;
    }

    .preview-popup.anim-shake {
        animation: previewShake 0.5s ease;
    }

    @@keyframes previewBounce {
        0% { transform: translate(-50%, -50%) scale(0.8); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }

    @@keyframes previewZoom {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    @@keyframes previewShake {
        0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
        25% { transform: translate(-50%, -50%) rotate(-2deg); }
        75% { transform: translate(-50%, -50%) rotate(2deg); }
    }

    /* Tipo badge en preview */
    .preview-type-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        z-index: 5;
    }

    /* ========================================
       IMAGEN CON MARCO - Selectores
       ======================================== */
    .imagen-marco-section {
        display: none;
        margin-bottom: 20px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .imagen-marco-section.visible {
        display: block;
    }

    .imagen-marco-section h4 {
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 12px;
        color: var(--text-dark);
    }

    /* Selector de marcos */
    .marcos-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-bottom: 16px;
    }

    .marco-option {
        aspect-ratio: 1;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        position: relative;
        overflow: hidden;
    }

    .marco-option:hover {
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .marco-option.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-pale);
    }

    .marco-option .marco-preview {
        width: 70%;
        height: 70%;
        background: linear-gradient(135deg, #ddd 0%, #bbb 100%);
    }

    /* Estilos de marcos */
    .marco-option[data-marco="none"] .marco-preview {
        border: none;
        border-radius: 4px;
    }

    .marco-option[data-marco="simple"] .marco-preview {
        border: 3px solid #333;
        border-radius: 0;
    }

    .marco-option[data-marco="rounded"] .marco-preview {
        border: 3px solid #333;
        border-radius: 12px;
    }

    .marco-option[data-marco="shadow"] .marco-preview {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .marco-option[data-marco="double"] .marco-preview {
        border: 4px double #333;
        border-radius: 0;
    }

    .marco-option[data-marco="golden"] .marco-preview {
        border: 4px solid;
        border-image: linear-gradient(135deg, #f5d442, #c9a227, #f5d442) 1;
    }

    .marco-option[data-marco="gradient"] .marco-preview {
        border: 4px solid;
        border-image: linear-gradient(135deg, var(--primary), #e91e63) 1;
    }

    .marco-option[data-marco="dotted"] .marco-preview {
        border: 3px dotted #333;
        border-radius: 0;
    }

    .marco-option[data-marco="dashed"] .marco-preview {
        border: 3px dashed #333;
        border-radius: 8px;
    }

    .marco-option[data-marco="polaroid"] .marco-preview {
        border: none;
        background: white;
        padding: 8% 8% 20% 8%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .marco-option[data-marco="polaroid"] .marco-preview::before {
        content: '';
        position: absolute;
        inset: 8%;
        bottom: 22%;
        background: linear-gradient(135deg, #ddd 0%, #bbb 100%);
    }

    .marco-option .marco-name {
        position: absolute;
        bottom: 2px;
        left: 0;
        right: 0;
        font-size: 8px;
        text-align: center;
        color: var(--text-gray);
    }

    /* Selector de proporcion */
    .proporcion-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .proporcion-option {
        padding: 12px 8px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        background: white;
    }

    .proporcion-option:hover {
        border-color: var(--primary);
    }

    .proporcion-option.selected {
        border-color: var(--primary);
        background: var(--primary-pale);
    }

    .proporcion-option .proporcion-icon {
        width: 40px;
        height: 40px;
        margin: 0 auto 6px;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .proporcion-option[data-ratio="1:1"] .proporcion-icon {
        aspect-ratio: 1;
        width: 36px;
        height: 36px;
    }

    .proporcion-option[data-ratio="4:3"] .proporcion-icon {
        width: 40px;
        height: 30px;
    }

    .proporcion-option[data-ratio="16:9"] .proporcion-icon {
        width: 48px;
        height: 27px;
    }

    .proporcion-option[data-ratio="9:16"] .proporcion-icon {
        width: 27px;
        height: 48px;
    }

    .proporcion-option .proporcion-name {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-dark);
    }

    /* Slider de ancho porcentaje */
    .ancho-porcentaje-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ancho-porcentaje-container input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, var(--primary) 0%, var(--primary) var(--value, 50%), #e5e7eb var(--value, 50%), #e5e7eb 100%);
        appearance: none;
        cursor: pointer;
    }

    .ancho-porcentaje-container input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        cursor: pointer;
    }

    .ancho-porcentaje-valor {
        min-width: 45px;
        text-align: center;
        font-weight: 600;
        color: var(--primary);
        font-size: 14px;
    }

    /* Preview con marco */
    .preview-popup.con-marco {
        padding: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
    }

    .preview-popup .popup-imagen-marco {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-popup .popup-imagen-marco img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    /* Marcos en preview */
    .marco-none img { border: none; border-radius: 8px; }
    .marco-simple img { border: 4px solid #333; border-radius: 0; }
    .marco-rounded img { border: 4px solid #333; border-radius: 16px; }
    .marco-shadow img { border: none; border-radius: 12px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
    .marco-double img { border: 6px double #333; border-radius: 0; }
    .marco-golden img { border: 6px solid; border-image: linear-gradient(135deg, #f5d442, #c9a227, #f5d442) 1; }
    .marco-gradient img { border: 6px solid; border-image: linear-gradient(135deg, #4682B4, #e91e63) 1; }
    .marco-dotted img { border: 4px dotted #333; border-radius: 0; }
    .marco-dashed img { border: 4px dashed #333; border-radius: 12px; }
    .marco-polaroid img {
        border: none;
        background: white;
        padding: 12px 12px 40px 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    /* ========================================
       MODAL FOOTER
       ======================================== */
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-light);
    }

    .footer-left {
        display: flex;
        gap: 8px;
    }

    .footer-right {
        display: flex;
        gap: 8px;
    }

    .btn-secondary {
        padding: 10px 20px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-primary {
        padding: 10px 24px;
        border: none;
        background: var(--primary-gradient);
        color: white;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(70, 130, 180, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(70, 130, 180, 0.4);
    }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @@media (max-width: 900px) {
        .modal-body {
            flex-direction: column;
        }

        .wizard-sidebar {
            width: 100%;
            display: flex;
            overflow-x: auto;
            padding: 12px;
            gap: 8px;
        }

        .wizard-step {
            flex-direction: column;
            padding: 10px 16px;
            border-left: none;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .wizard-step.active {
            border-bottom-color: var(--primary);
        }

        .preview-sidebar {
            width: 100%;
            order: -1;
        }

        .preview-frame {
            aspect-ratio: 16/9;
            max-height: 200px;
        }
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            Administrar Popups
        </h1>
        <button class="btn-nuevo" onclick="abrirModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nuevo Popup
        </button>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@Model.Count</h3>
                <p>Total popups</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@Model.Count(p => p.EstaActivo)</h3>
                <p>Activos</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@Model.Sum(p => p.Impresiones).ToString("N0")</h3>
                <p>Impresiones</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10 17 15 12 10 7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@Model.Sum(p => p.Clics).ToString("N0")</h3>
                <p>Clics totales</p>
            </div>
        </div>
    </div>

    <!-- Popups Table -->
    <div class="popups-container">
        @if (Model.Any())
        {
            <table class="popups-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Metricas</th>
                        <th>CTR</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var popup in Model)
                    {
                        var tipoClass = popup.Tipo.ToString().ToLower();
                        <tr>
                            <td>
                                <span class="popup-name">@popup.Nombre</span>
                                @if (!string.IsNullOrEmpty(popup.Titulo))
                                {
                                    <br><small style="color: var(--text-gray);">@popup.Titulo</small>
                                }
                            </td>
                            <td>
                                <span class="popup-tipo @tipoClass">@popup.TipoDisplay</span>
                            </td>
                            <td>
                                <div class="popup-estado">
                                    <label class="toggle-switch">
                                        <input type="checkbox" @(popup.EstaActivo ? "checked" : "") onchange="togglePopup(@popup.Id)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </td>
                            <td>
                                <div class="popup-stats">
                                    <span title="Impresiones">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        @popup.Impresiones.ToString("N0")
                                    </span>
                                    <span title="Clics">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                            <polyline points="10 17 15 12 10 7"></polyline>
                                        </svg>
                                        @popup.Clics.ToString("N0")
                                    </span>
                                </div>
                            </td>
                            <td>
                                <strong style="color: @(popup.CTR > 5 ? "var(--success)" : popup.CTR > 2 ? "var(--warning)" : "var(--text-gray)")">
                                    @popup.CTR.ToString("F1")%
                                </strong>
                            </td>
                            <td>
                                <div class="popup-actions">
                                    <button class="btn-action" onclick="editarPopup(@popup.Id)" title="Editar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-action" onclick="duplicarPopup(@popup.Id)" title="Duplicar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-action" onclick="previsualizarPopup(@popup.Id)" title="Previsualizar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                    <button class="btn-action danger" onclick="eliminarPopup(@popup.Id)" title="Eliminar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                </div>
                <h3>No hay popups</h3>
                <p>Crea tu primer popup para mostrar promociones, anuncios o mensajes importantes</p>
                <button class="btn-nuevo" onclick="abrirModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear Popup
                </button>
            </div>
        }
    </div>
</div>

<!-- Modal Crear/Editar Popup -->
<div class="popup-modal-overlay" id="popupModal">
    <div class="popup-modal">
        <div class="modal-header">
            <h2 id="modalTitle">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                Nuevo Popup
            </h2>
            <button class="modal-close" onclick="cerrarModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- Wizard Sidebar -->
            <div class="wizard-sidebar">
                <div class="wizard-step active" data-step="1" onclick="irAPaso(1)">
                    <span class="wizard-step-number">1</span>
                    <div class="wizard-step-info">
                        <h4>Plantilla</h4>
                        <p>Elige un tipo</p>
                    </div>
                </div>
                <div class="wizard-step" data-step="2" onclick="irAPaso(2)">
                    <span class="wizard-step-number">2</span>
                    <div class="wizard-step-info">
                        <h4>Contenido</h4>
                        <p>Texto e imagen</p>
                    </div>
                </div>
                <div class="wizard-step" data-step="3" onclick="irAPaso(3)">
                    <span class="wizard-step-number">3</span>
                    <div class="wizard-step-info">
                        <h4>Diseno</h4>
                        <p>Colores y posicion</p>
                    </div>
                </div>
                <div class="wizard-step" data-step="4" onclick="irAPaso(4)">
                    <span class="wizard-step-number">4</span>
                    <div class="wizard-step-info">
                        <h4>Configuracion</h4>
                        <p>Cuando mostrar</p>
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="form-content">
                <form id="popupForm">
                    <input type="hidden" id="popupId" name="id">

                    <!-- Step 1: Template -->
                    <div class="step-content active" data-step="1">
                        <h3 class="step-title">Elige una plantilla</h3>
                        <p class="step-description">Selecciona un tipo de popup para comenzar rapidamente</p>

                        <div class="templates-grid">
                            <div class="template-card selected" data-template="modal-promo" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Promocion</h4>
                                <p>Modal centrado con oferta</p>
                            </div>
                            <div class="template-card" data-template="banner-top" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Banner Superior</h4>
                                <p>Anuncio en la parte superior</p>
                            </div>
                            <div class="template-card" data-template="toast-notif" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Notificacion</h4>
                                <p>Toast en esquina inferior</p>
                            </div>
                            <div class="template-card" data-template="pwa-install" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Instalar App</h4>
                                <p>Prompt PWA personalizado</p>
                            </div>
                            <div class="template-card" data-template="fullscreen" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Pantalla Completa</h4>
                                <p>Maximo impacto visual</p>
                            </div>
                            <div class="template-card" data-template="slide-panel" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Panel Lateral</h4>
                                <p>Slide desde el lado</p>
                            </div>
                            <div class="template-card" data-template="imagen-marco" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>Imagen con Marco</h4>
                                <p>Solo imagen decorativa</p>
                            </div>
                            <div class="template-card" data-template="empty" onclick="seleccionarPlantilla(this)">
                                <div class="template-icon"></div>
                                <h4>En Blanco</h4>
                                <p>Empieza desde cero</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Nombre interno *</label>
                            <input type="text" id="nombre" name="nombre" required placeholder="Ej: Promo Enero 2026">
                            <small>Solo visible en el admin para identificar el popup</small>
                        </div>
                    </div>

                    <!-- Step 2: Content -->
                    <div class="step-content" data-step="2">
                        <h3 class="step-title">Contenido del Popup</h3>
                        <p class="step-description">Define el titulo, texto e imagen que se mostrara</p>

                        <div class="form-group">
                            <label>Titulo</label>
                            <input type="text" id="titulo" name="titulo" placeholder="Ej: Oferta especial!" oninput="actualizarPreview()">
                        </div>

                        <!-- Image Upload -->
                        <div class="form-group">
                            <label>Imagen</label>
                            <div class="image-upload-section">
                                <div class="image-dropzone" id="imageDropzone" onclick="document.getElementById('imageInput').click()">
                                    <div id="dropzoneContent">
                                        <div class="dropzone-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                <polyline points="21 15 16 10 5 21"></polyline>
                                            </svg>
                                        </div>
                                        <div class="dropzone-text">
                                            <h4>Arrastra una imagen aqui</h4>
                                            <p>o haz clic para seleccionar (JPG, PNG, GIF, WebP - Max 5MB)</p>
                                        </div>
                                    </div>
                                    <div id="imagePreviewContainer" style="display: none;">
                                        <div class="image-preview">
                                            <img id="imagePreviewImg" src="" alt="Preview">
                                            <button type="button" class="image-preview-remove" onclick="event.stopPropagation(); quitarImagen()"></button>
                                        </div>
                                    </div>
                                </div>
                                <input type="file" id="imageInput" accept="image/*" style="display: none" onchange="handleImageSelect(this)">
                                <input type="hidden" id="imagenUrl" name="imagenUrl">

                                <div class="image-gallery-toggle" onclick="toggleGallery()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    Ver imagenes subidas anteriormente
                                </div>
                                <div class="image-gallery" id="imageGallery">
                                    <div class="gallery-grid" id="galleryGrid">
                                        <!-- Se llena dinamicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seccion especial para Imagen con Marco -->
                        <div class="imagen-marco-section" id="imagenMarcoSection">
                            <h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>Opciones de Marco</h4>

                            <label style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; display: block;">Estilo del marco</label>
                            <div class="marcos-grid">
                                <div class="marco-option selected" data-marco="none" onclick="seleccionarMarco('none')" title="Sin marco">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Ninguno</span>
                                </div>
                                <div class="marco-option" data-marco="simple" onclick="seleccionarMarco('simple')" title="Marco simple">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Simple</span>
                                </div>
                                <div class="marco-option" data-marco="rounded" onclick="seleccionarMarco('rounded')" title="Marco redondeado">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Redondo</span>
                                </div>
                                <div class="marco-option" data-marco="shadow" onclick="seleccionarMarco('shadow')" title="Con sombra">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Sombra</span>
                                </div>
                                <div class="marco-option" data-marco="double" onclick="seleccionarMarco('double')" title="Marco doble">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Doble</span>
                                </div>
                                <div class="marco-option" data-marco="golden" onclick="seleccionarMarco('golden')" title="Marco dorado">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Dorado</span>
                                </div>
                                <div class="marco-option" data-marco="gradient" onclick="seleccionarMarco('gradient')" title="Marco degradado">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Degradado</span>
                                </div>
                                <div class="marco-option" data-marco="dotted" onclick="seleccionarMarco('dotted')" title="Marco punteado">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Punteado</span>
                                </div>
                                <div class="marco-option" data-marco="dashed" onclick="seleccionarMarco('dashed')" title="Marco discontinuo">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Discontinuo</span>
                                </div>
                                <div class="marco-option" data-marco="polaroid" onclick="seleccionarMarco('polaroid')" title="Estilo Polaroid">
                                    <div class="marco-preview"></div>
                                    <span class="marco-name">Polaroid</span>
                                </div>
                            </div>
                            <input type="hidden" id="marcoEstilo" name="marcoEstilo" value="none">

                            <label style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; display: block;">Proporcion del popup</label>
                            <div class="proporcion-grid">
                                <div class="proporcion-option selected" data-ratio="1:1" onclick="seleccionarProporcion('1:1')" title="Cuadrado">
                                    <div class="proporcion-icon"></div>
                                    <span class="proporcion-name">Cuadrado</span>
                                </div>
                                <div class="proporcion-option" data-ratio="4:3" onclick="seleccionarProporcion('4:3')" title="Horizontal 4:3">
                                    <div class="proporcion-icon"></div>
                                    <span class="proporcion-name">4:3</span>
                                </div>
                                <div class="proporcion-option" data-ratio="16:9" onclick="seleccionarProporcion('16:9')" title="Horizontal 16:9">
                                    <div class="proporcion-icon"></div>
                                    <span class="proporcion-name">16:9</span>
                                </div>
                                <div class="proporcion-option" data-ratio="9:16" onclick="seleccionarProporcion('9:16')" title="Vertical 9:16">
                                    <div class="proporcion-icon"></div>
                                    <span class="proporcion-name">Vertical</span>
                                </div>
                            </div>
                            <input type="hidden" id="proporcionPopup" name="proporcionPopup" value="1:1">

                            <label style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; margin-top: 16px; display: block;">Ancho del popup (% de pantalla)</label>
                            <div class="ancho-porcentaje-container">
                                <input type="range" id="anchoPorcentaje" name="anchoPorcentaje" value="50" min="20" max="90" step="5" oninput="actualizarAnchoPorcentaje(this.value)">
                                <span class="ancho-porcentaje-valor" id="anchoPorcentajeValor">50%</span>
                            </div>
                            <input type="hidden" id="anchoPorcentajeHidden" name="anchoPorcentajeHidden" value="50">
                        </div>

                        <!-- Campos de texto (se ocultan en modo imagen-marco) -->
                        <div id="camposTextoSection">
                        <!-- Content Editor -->
                        <div class="form-group">
                            <label>Contenido</label>
                            <div class="content-editor-wrapper">
                                <div class="editor-toolbar">
                                    <button type="button" class="editor-btn" onclick="formatText('bold')" title="Negrita">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                                            <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                                        </svg>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatText('italic')" title="Italica">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="19" y1="4" x2="10" y2="4"></line>
                                            <line x1="14" y1="20" x2="5" y2="20"></line>
                                            <line x1="15" y1="4" x2="9" y2="20"></line>
                                        </svg>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatText('underline')" title="Subrayado">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path>
                                            <line x1="4" y1="21" x2="20" y2="21"></line>
                                        </svg>
                                    </button>
                                    <div class="editor-divider"></div>
                                    <button type="button" class="editor-btn" onclick="formatText('justifyLeft')" title="Alinear izquierda">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="17" y1="10" x2="3" y2="10"></line>
                                            <line x1="21" y1="6" x2="3" y2="6"></line>
                                            <line x1="21" y1="14" x2="3" y2="14"></line>
                                            <line x1="17" y1="18" x2="3" y2="18"></line>
                                        </svg>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatText('justifyCenter')" title="Centrar">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="10" x2="6" y2="10"></line>
                                            <line x1="21" y1="6" x2="3" y2="6"></line>
                                            <line x1="21" y1="14" x2="3" y2="14"></line>
                                            <line x1="18" y1="18" x2="6" y2="18"></line>
                                        </svg>
                                    </button>
                                    <div class="editor-divider"></div>
                                    <button type="button" class="editor-btn" onclick="insertEmoji()" title="Insertar emoji"></button>
                                    <div style="flex: 1;"></div>
                                    <button type="button" class="editor-btn" id="toggleHtmlBtn" onclick="toggleHtmlMode()" title="Ver HTML">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="16 18 22 12 16 6"></polyline>
                                            <polyline points="8 6 2 12 8 18"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                <div class="editor-content" id="editorContent" contenteditable="true" oninput="syncHtmlFromEditor()"></div>
                                <textarea class="editor-html" id="editorHtml" oninput="syncEditorFromHtml()"></textarea>
                            </div>
                            <input type="hidden" id="contenido" name="contenido">
                        </div>

                        <!-- Buttons -->
                        <div class="form-group">
                            <label>Botones</label>
                            <div class="buttons-list" id="buttonsList"></div>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn-add-button" onclick="agregarBoton('link')">+ Boton con URL</button>
                                <button type="button" class="btn-add-button" onclick="agregarBoton('close')">+ Boton Cerrar</button>
                            </div>
                            <input type="hidden" id="botonesJson" name="botonesJson">
                        </div>
                        </div><!-- Fin camposTextoSection -->
                    </div>

                    <!-- Step 3: Design -->
                    <div class="step-content" data-step="3">
                        <h3 class="step-title">Diseno Visual</h3>
                        <p class="step-description">Personaliza los colores y la posicion del popup</p>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de popup</label>
                                <select id="tipo" name="tipo" onchange="cambiarTipoPopup()">
                                    <option value="0">Banner</option>
                                    <option value="1" selected>Modal</option>
                                    <option value="2">Toast</option>
                                    <option value="3">Pantalla completa</option>
                                    <option value="4">Panel lateral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Animacion</label>
                                <select id="animacion" name="animacion" onchange="actualizarPreview()">
                                    <option value="0">Sin animacion</option>
                                    <option value="1" selected>Fade In</option>
                                    <option value="2">Slide Up</option>
                                    <option value="3">Slide Down</option>
                                    <option value="6">Bounce</option>
                                    <option value="7">Zoom</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Posicion</label>
                            <div class="position-grid">
                                <button type="button" class="position-btn" data-pos="1" onclick="seleccionarPosicion(1)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="2" onclick="seleccionarPosicion(2)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="3" onclick="seleccionarPosicion(3)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="7" onclick="seleccionarPosicion(7)"><span class="dot"></span></button>
                                <button type="button" class="position-btn active" data-pos="0" onclick="seleccionarPosicion(0)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="8" onclick="seleccionarPosicion(8)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="4" onclick="seleccionarPosicion(4)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="5" onclick="seleccionarPosicion(5)"><span class="dot"></span></button>
                                <button type="button" class="position-btn" data-pos="6" onclick="seleccionarPosicion(6)"><span class="dot"></span></button>
                            </div>
                            <input type="hidden" id="posicion" name="posicion" value="0">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Color de fondo</label>
                                <div class="color-input">
                                    <input type="color" id="colorFondoPicker" value="#ffffff" onchange="document.getElementById('colorFondo').value = this.value; actualizarPreview();">
                                    <input type="text" id="colorFondo" name="colorFondo" value="#ffffff" oninput="actualizarPreview()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Color de texto</label>
                                <div class="color-input">
                                    <input type="color" id="colorTextoPicker" value="#111111" onchange="document.getElementById('colorTexto').value = this.value; actualizarPreview();">
                                    <input type="text" id="colorTexto" name="colorTexto" value="#111111" oninput="actualizarPreview()">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Color boton primario</label>
                                <div class="color-input">
                                    <input type="color" id="colorBotonPicker" value="#4682B4" onchange="document.getElementById('colorBotonPrimario').value = this.value; actualizarPreview();">
                                    <input type="text" id="colorBotonPrimario" name="colorBotonPrimario" value="#4682B4" oninput="actualizarPreview()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ancho maximo (px)</label>
                                <input type="number" id="anchoMaximo" name="anchoMaximo" value="400" min="200" max="800" oninput="actualizarPreview()">
                            </div>
                        </div>

                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="mostrarBotonCerrar" name="mostrarBotonCerrar" checked onchange="actualizarPreview()">
                                <span>Mostrar boton cerrar (X)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="cerrarAlClickFuera" name="cerrarAlClickFuera" checked>
                                <span>Cerrar al click fuera</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>CSS personalizado (opcional)</label>
                            <textarea id="cssPersonalizado" name="cssPersonalizado" rows="3" placeholder=".popup-container { }"></textarea>
                        </div>
                    </div>

                    <!-- Step 4: Configuration -->
                    <div class="step-content" data-step="4">
                        <h3 class="step-title">Configuracion</h3>
                        <p class="step-description">Define cuando y a quien mostrar el popup</p>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cuando mostrar</label>
                                <select id="trigger" name="trigger" onchange="toggleTriggerOptions()">
                                    <option value="0">Inmediato (al cargar)</option>
                                    <option value="1">Despues de X segundos</option>
                                    <option value="2">Al hacer scroll X%</option>
                                    <option value="3">Exit intent (al salir)</option>
                                    <option value="4">Despues de X visitas</option>
                                </select>
                            </div>
                            <div class="form-group" id="triggerDelayGroup" style="display: none;">
                                <label>Segundos de espera</label>
                                <input type="number" id="delaySegundos" name="delaySegundos" value="5" min="1" max="60">
                            </div>
                            <div class="form-group" id="triggerScrollGroup" style="display: none;">
                                <label>Porcentaje de scroll</label>
                                <input type="number" id="scrollPorcentaje" name="scrollPorcentaje" value="50" min="10" max="100">
                            </div>
                            <div class="form-group" id="triggerVisitasGroup" style="display: none;">
                                <label>Numero de visitas</label>
                                <input type="number" id="visitasRequeridas" name="visitasRequeridas" value="3" min="1" max="100">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Frecuencia</label>
                            <select id="frecuencia" name="frecuencia">
                                <option value="0">Una sola vez</option>
                                <option value="1">Una vez por sesion</option>
                                <option value="2">Siempre</option>
                                <option value="3">Cada X dias</option>
                            </select>
                        </div>

                        <div class="form-group" id="diasFrecuenciaGroup" style="display: none;">
                            <label>Dias entre mostrar</label>
                            <input type="number" id="diasFrecuencia" name="diasFrecuencia" value="7" min="1" max="365">
                        </div>

                        <h4 style="margin: 24px 0 12px; font-size: 15px; color: var(--text-dark);">Segmentacion</h4>

                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="mostrarUsuariosLogueados" name="mostrarUsuariosLogueados" checked>
                                <span>Usuarios logueados</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="mostrarUsuariosAnonimos" name="mostrarUsuariosAnonimos" checked>
                                <span>Usuarios anonimos</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="mostrarEnMovil" name="mostrarEnMovil" checked>
                                <span>Dispositivos moviles</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="mostrarEnDesktop" name="mostrarEnDesktop" checked>
                                <span>Desktop</span>
                            </label>
                        </div>

                        <div class="form-row" style="margin-top: 20px;">
                            <div class="form-group">
                                <label>Paginas donde mostrar</label>
                                <input type="text" id="paginasIncluidas" name="paginasIncluidas" placeholder="*, /Feed, /Home">
                                <small>Separadas por coma. * = todas</small>
                            </div>
                            <div class="form-group">
                                <label>Paginas donde NO mostrar</label>
                                <input type="text" id="paginasExcluidas" name="paginasExcluidas" placeholder="/Admin, /Account">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha inicio (opcional)</label>
                                <input type="datetime-local" id="fechaInicio" name="fechaInicio">
                            </div>
                            <div class="form-group">
                                <label>Fecha fin (opcional)</label>
                                <input type="datetime-local" id="fechaFin" name="fechaFin">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Prioridad (1-10)</label>
                                <input type="number" id="prioridad" name="prioridad" value="5" min="1" max="10">
                                <small>Mayor numero = mas prioritario</small>
                            </div>
                            <div class="form-group">
                                <label>Estado</label>
                                <label class="checkbox-item" style="margin-top: 8px;">
                                    <input type="checkbox" id="estaActivo" name="estaActivo" checked>
                                    <span>Popup activo</span>
                                </label>
                            </div>
                        </div>

                        <!-- PWA Options -->
                        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label class="checkbox-item" style="margin-bottom: 16px;">
                                <input type="checkbox" id="esPWA" name="esPWA" onchange="togglePWAOptions()">
                                <span><strong>Es popup de instalacion PWA</strong></span>
                            </label>

                            <div id="pwaOptions" style="display: none;">
                                <div class="checkbox-grid">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="soloSiInstalable" name="soloSiInstalable" checked>
                                        <span>Solo si es instalable</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="soloIOS" name="soloIOS">
                                        <span>Solo iOS</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="soloAndroid" name="soloAndroid">
                                        <span>Solo Android</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 12px;">
                                    <label>Texto boton instalar</label>
                                    <input type="text" id="textoBotonInstalar" name="textoBotonInstalar" placeholder="Instalar">
                                </div>
                                <div class="form-group">
                                    <label>Contenido especial para iOS</label>
                                    <textarea id="contenidoIOS" name="contenidoIOS" rows="3" placeholder="Instrucciones para iOS..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Preview Sidebar -->
            <div class="preview-sidebar">
                <div class="preview-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Vista Previa
                </div>
                <div class="preview-device-toggle">
                    <button class="device-btn active" onclick="cambiarDispositivo('mobile')">Movil</button>
                    <button class="device-btn" onclick="cambiarDispositivo('desktop')">Desktop</button>
                </div>
                <div class="preview-frame" id="previewFrame">
                    <span class="preview-type-badge" id="previewTypeBadge">Modal</span>
                    <div class="preview-overlay" id="previewOverlay"></div>
                    <div class="preview-popup tipo-modal" id="previewPopup">
                        <button class="preview-close-btn" id="previewCloseBtn"></button>
                        <div id="previewContent">
                            <h3 style="margin: 0 0 8px;">Titulo del popup</h3>
                            <p style="margin: 0; color: #666;">Contenido del popup...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <div class="footer-left">
                <button type="button" class="btn-secondary" id="btnAnterior" onclick="pasoAnterior()" style="display: none;">Anterior</button>
            </div>
            <div class="footer-right">
                <button type="button" class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="button" class="btn-primary" id="btnSiguiente" onclick="pasoSiguiente()">Siguiente</button>
                <button type="button" class="btn-primary" id="btnGuardar" onclick="guardarPopup()" style="display: none;">Guardar Popup</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let pasoActual = 1;
    let botones = [];
    let editandoId = null;

    // ========================================
    // MODAL
    // ========================================
    function abrirModal() {
        editandoId = null;
        document.getElementById('modalTitle').innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            Nuevo Popup
        `;
        document.getElementById('popupForm').reset();
        document.getElementById('popupId').value = '';
        botones = [];
        renderizarBotones();
        quitarImagen();
        irAPaso(1);
        document.getElementById('popupModal').classList.add('active');
        actualizarPreview();
    }

    function cerrarModal() {
        document.getElementById('popupModal').classList.remove('active');
    }

    // ========================================
    // WIZARD STEPS
    // ========================================
    function irAPaso(paso) {
        pasoActual = paso;

        // Update steps
        document.querySelectorAll('.wizard-step').forEach(s => {
            const stepNum = parseInt(s.dataset.step);
            s.classList.remove('active', 'completed');
            if (stepNum === paso) s.classList.add('active');
            if (stepNum < paso) s.classList.add('completed');
        });

        // Update content
        document.querySelectorAll('.step-content').forEach(c => {
            c.classList.remove('active');
            if (parseInt(c.dataset.step) === paso) c.classList.add('active');
        });

        // Update buttons
        document.getElementById('btnAnterior').style.display = paso > 1 ? 'inline-block' : 'none';
        document.getElementById('btnSiguiente').style.display = paso < 4 ? 'inline-block' : 'none';
        document.getElementById('btnGuardar').style.display = paso === 4 ? 'inline-block' : 'none';
    }

    function pasoSiguiente() {
        if (pasoActual === 1 && !document.getElementById('nombre').value.trim()) {
            alert('Por favor ingresa un nombre para el popup');
            document.getElementById('nombre').focus();
            return;
        }
        if (pasoActual < 4) irAPaso(pasoActual + 1);
    }

    function pasoAnterior() {
        if (pasoActual > 1) irAPaso(pasoActual - 1);
    }

    // ========================================
    // TEMPLATES
    // ========================================
    function seleccionarPlantilla(card) {
        document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        const template = card.dataset.template;
        aplicarPlantilla(template);
    }

    function aplicarPlantilla(template) {
        const templates = {
            'modal-promo': {
                tipo: 1, posicion: 0, animacion: 1,
                titulo: 'Oferta Especial!',
                colorFondo: '#ffffff', colorTexto: '#111111', colorBoton: '#4682B4',
                contenido: '<div style="text-align:center;padding:16px;"><p style="font-size:18px;margin:0 0 16px;">Aprovecha esta increible promocion</p></div>'
            },
            'banner-top': {
                tipo: 0, posicion: 2, animacion: 3,
                titulo: 'Anuncio importante',
                colorFondo: '#4682B4', colorTexto: '#ffffff', colorBoton: '#ffffff',
                contenido: '<div style="text-align:center;padding:8px;"></div>'
            },
            'toast-notif': {
                tipo: 2, posicion: 6, animacion: 5,
                titulo: 'Notificacion',
                colorFondo: '#1a1a2e', colorTexto: '#ffffff', colorBoton: '#10b981',
                contenido: '<p style="margin:0;">Tienes un nuevo mensaje</p>'
            },
            'pwa-install': {
                tipo: 1, posicion: 5, animacion: 2,
                titulo: 'Instala nuestra App!',
                colorFondo: '#ffffff', colorTexto: '#111111', colorBoton: '#4682B4',
                contenido: '<div style="text-align:center;"><div style="font-size:48px;margin-bottom:12px;"></div><p>Instala la app para una mejor experiencia</p></div>'
            },
            'fullscreen': {
                tipo: 3, posicion: 0, animacion: 7,
                titulo: '',
                colorFondo: '#1a1a2e', colorTexto: '#ffffff', colorBoton: '#4682B4',
                contenido: '<div style="text-align:center;padding:40px;"><h2 style="margin:0 0 16px;font-size:32px;">Bienvenido!</h2><p style="opacity:0.8;">Descubre todo lo que tenemos para ti</p></div>'
            },
            'slide-panel': {
                tipo: 4, posicion: 8, animacion: 5,
                titulo: 'Menu',
                colorFondo: '#ffffff', colorTexto: '#111111', colorBoton: '#4682B4',
                contenido: '<nav style="padding:20px;"></nav>'
            },
            'empty': {
                tipo: 1, posicion: 0, animacion: 1,
                titulo: '',
                colorFondo: '#ffffff', colorTexto: '#111111', colorBoton: '#4682B4',
                contenido: ''
            },
            'imagen-marco': {
                tipo: 1, posicion: 0, animacion: 7,
                titulo: '',
                colorFondo: '#00000000', colorTexto: '#111111', colorBoton: '#4682B4',
                contenido: '',
                esImagenMarco: true
            }
        };

        const t = templates[template] || templates['empty'];

        // Mostrar/ocultar secciones segun plantilla
        const esImagenMarco = t.esImagenMarco || false;
        document.getElementById('imagenMarcoSection').classList.toggle('visible', esImagenMarco);
        document.getElementById('camposTextoSection').style.display = esImagenMarco ? 'none' : 'block';

        // Actualizar variable global
        window.modoImagenMarco = esImagenMarco;

        document.getElementById('tipo').value = t.tipo;
        document.getElementById('posicion').value = t.posicion;
        seleccionarPosicion(t.posicion);
        document.getElementById('animacion').value = t.animacion;
        document.getElementById('titulo').value = t.titulo;
        document.getElementById('colorFondo').value = t.colorFondo;
        // El picker de color no soporta valores transparentes (#00000000), usar blanco como fallback
        const esTransparenteTpl = t.colorFondo?.toLowerCase() === 'transparent' ||
                                  t.colorFondo?.toLowerCase() === '#00000000';
        document.getElementById('colorFondoPicker').value = esTransparenteTpl ? '#ffffff' : t.colorFondo;
        document.getElementById('colorTexto').value = t.colorTexto;
        document.getElementById('colorTextoPicker').value = t.colorTexto;
        document.getElementById('colorBotonPrimario').value = t.colorBoton;
        document.getElementById('colorBotonPicker').value = t.colorBoton;
        document.getElementById('editorContent').innerHTML = t.contenido;
        document.getElementById('editorHtml').value = t.contenido;

        if (template === 'pwa-install') {
            document.getElementById('esPWA').checked = true;
            togglePWAOptions();
        }

        actualizarPreview();
    }

    // ========================================
    // IMAGE UPLOAD
    // ========================================
    const dropzone = document.getElementById('imageDropzone');

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageFile(files[0]);
        }
    });

    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            handleImageFile(input.files[0]);
        }
    }

    async function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Por favor selecciona un archivo de imagen');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('La imagen no puede superar los 5MB');
            return;
        }

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('imagePreviewImg').src = e.target.result;
            document.getElementById('dropzoneContent').style.display = 'none';
            document.getElementById('imagePreviewContainer').style.display = 'block';
            dropzone.classList.add('has-image');
        };
        reader.readAsDataURL(file);

        // Upload to server
        const formData = new FormData();
        formData.append('archivo', file);

        // Agregar token anti-forgery al FormData
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        if (token) {
            formData.append('__RequestVerificationToken', token);
        }

        try {
            const response = await fetch('/Admin/SubirImagenPopup', {
                method: 'POST',
                body: formData
                // No incluir headers - FormData establece el Content-Type automaticamente
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.success) {
                document.getElementById('imagenUrl').value = result.url;
                actualizarPreview();
            } else {
                alert('Error al subir: ' + result.message);
                quitarImagen();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al subir la imagen: ' + error.message);
            quitarImagen();
        }
    }

    function quitarImagen() {
        document.getElementById('imagenUrl').value = '';
        document.getElementById('imagePreviewImg').src = '';
        document.getElementById('dropzoneContent').style.display = 'block';
        document.getElementById('imagePreviewContainer').style.display = 'none';
        dropzone.classList.remove('has-image');
        document.getElementById('imageInput').value = '';
        actualizarPreview();
    }

    function toggleGallery() {
        const gallery = document.getElementById('imageGallery');
        gallery.classList.toggle('show');
        if (gallery.classList.contains('show')) {
            cargarGaleria();
        }
    }

    async function cargarGaleria() {
        try {
            const response = await fetch('/Admin/ObtenerImagenesPopup');
            const result = await response.json();
            if (result.success) {
                const grid = document.getElementById('galleryGrid');
                grid.innerHTML = result.imagenes.map(img => `
                    <div class="gallery-item" onclick="seleccionarDeGaleria('${img.url}')">
                        <img src="${img.url}" alt="${img.nombre}">
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function seleccionarDeGaleria(url) {
        document.getElementById('imagenUrl').value = url;
        document.getElementById('imagePreviewImg').src = url;
        document.getElementById('dropzoneContent').style.display = 'none';
        document.getElementById('imagePreviewContainer').style.display = 'block';
        dropzone.classList.add('has-image');
        document.getElementById('imageGallery').classList.remove('show');
        actualizarPreview();
    }

    // ========================================
    // CONTENT EDITOR
    // ========================================
    function formatText(command) {
        document.execCommand(command, false, null);
        document.getElementById('editorContent').focus();
        syncHtmlFromEditor();
    }

    function insertEmoji() {
        const emojis = ['', '', '', '', '', '', '', '', '', ''];
        const emoji = prompt('Selecciona un emoji:\n' + emojis.join(' '));
        if (emoji && emojis.includes(emoji)) {
            document.execCommand('insertText', false, emoji);
            syncHtmlFromEditor();
        }
    }

    function toggleHtmlMode() {
        const content = document.getElementById('editorContent');
        const html = document.getElementById('editorHtml');
        const btn = document.getElementById('toggleHtmlBtn');

        if (html.classList.contains('show')) {
            html.classList.remove('show');
            content.classList.remove('hidden');
            btn.classList.remove('active');
            syncEditorFromHtml();
        } else {
            syncHtmlFromEditor();
            html.classList.add('show');
            content.classList.add('hidden');
            btn.classList.add('active');
        }
    }

    function syncHtmlFromEditor() {
        document.getElementById('editorHtml').value = document.getElementById('editorContent').innerHTML;
        document.getElementById('contenido').value = document.getElementById('editorContent').innerHTML;
        actualizarPreview();
    }

    function syncEditorFromHtml() {
        document.getElementById('editorContent').innerHTML = document.getElementById('editorHtml').value;
        document.getElementById('contenido').value = document.getElementById('editorHtml').value;
        actualizarPreview();
    }

    // ========================================
    // BUTTONS EDITOR
    // ========================================
    function agregarBoton(tipo) {
        botones.push({
            texto: tipo === 'close' ? 'Cerrar' : 'Saber mas',
            url: tipo === 'close' ? '' : 'https://',
            estilo: tipo === 'close' ? 'secondary' : 'primary',
            accion: tipo
        });
        renderizarBotones();
    }

    function eliminarBoton(index) {
        botones.splice(index, 1);
        renderizarBotones();
    }

    function renderizarBotones() {
        const container = document.getElementById('buttonsList');
        container.innerHTML = botones.map((btn, i) => `
            <div class="button-item">
                <input type="text" value="${btn.texto}" placeholder="Texto" onchange="botones[${i}].texto = this.value; actualizarPreview()">
                ${btn.accion !== 'close' ? `<input type="text" value="${btn.url}" placeholder="URL" onchange="botones[${i}].url = this.value">` : ''}
                <select onchange="botones[${i}].estilo = this.value; actualizarPreview()">
                    <option value="primary" ${btn.estilo === 'primary' ? 'selected' : ''}>Primario</option>
                    <option value="secondary" ${btn.estilo === 'secondary' ? 'selected' : ''}>Secundario</option>
                </select>
                <button type="button" class="button-item-remove" onclick="eliminarBoton(${i})"></button>
            </div>
        `).join('');

        document.getElementById('botonesJson').value = JSON.stringify(botones);
        actualizarPreview();
    }

    // ========================================
    // TIPO DE POPUP
    // ========================================
    function cambiarTipoPopup() {
        const tipo = parseInt(document.getElementById('tipo').value);
        const positionBtns = document.querySelectorAll('.position-btn');

        // Resetear todos los botones
        positionBtns.forEach(btn => {
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
            btn.classList.remove('active');
        });

        // Configurar posiciones segun tipo
        if (tipo === 0) {
            // Banner: solo arriba (1,2,3) o abajo (4,5,6)
            positionBtns.forEach(btn => {
                const pos = parseInt(btn.dataset.pos);
                // Solo habilitar fila superior e inferior
                if (pos === 0 || pos === 7 || pos === 8) {
                    btn.style.opacity = '0.2';
                    btn.style.pointerEvents = 'none';
                }
            });
            // Seleccionar arriba-centro por defecto
            seleccionarPosicion(2);
        } else if (tipo === 3) {
            // FullScreen: solo centro
            positionBtns.forEach(btn => {
                const pos = parseInt(btn.dataset.pos);
                if (pos !== 0) {
                    btn.style.opacity = '0.2';
                    btn.style.pointerEvents = 'none';
                }
            });
            seleccionarPosicion(0);
        } else if (tipo === 4) {
            // Slide: solo izquierda (7) o derecha (8)
            positionBtns.forEach(btn => {
                const pos = parseInt(btn.dataset.pos);
                if (pos !== 7 && pos !== 8) {
                    btn.style.opacity = '0.2';
                    btn.style.pointerEvents = 'none';
                }
            });
            seleccionarPosicion(8);
        } else {
            // Modal o Toast: todas las posiciones
            seleccionarPosicion(0);
        }

        actualizarPreview();
    }

    // ========================================
    // POSITION SELECTOR
    // ========================================
    function seleccionarPosicion(pos) {
        document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.position-btn[data-pos="${pos}"]`)?.classList.add('active');
        document.getElementById('posicion').value = pos;
        actualizarPreview();
    }

    // ========================================
    // MARCO Y PROPORCION (Imagen con Marco)
    // ========================================
    let marcoSeleccionado = 'none';
    let proporcionSeleccionada = '1:1';

    function seleccionarMarco(marco) {
        marcoSeleccionado = marco;
        document.querySelectorAll('.marco-option').forEach(m => m.classList.remove('selected'));
        document.querySelector(`.marco-option[data-marco="${marco}"]`)?.classList.add('selected');
        document.getElementById('marcoEstilo').value = marco;
        actualizarPreview();
    }

    function seleccionarProporcion(ratio) {
        proporcionSeleccionada = ratio;
        document.querySelectorAll('.proporcion-option').forEach(p => p.classList.remove('selected'));
        document.querySelector(`.proporcion-option[data-ratio="${ratio}"]`)?.classList.add('selected');
        document.getElementById('proporcionPopup').value = ratio;
        actualizarPreview();
    }

    // Variable global para ancho porcentaje
    let anchoPorcentajeSeleccionado = 50;

    function actualizarAnchoPorcentaje(valor) {
        anchoPorcentajeSeleccionado = parseInt(valor);
        document.getElementById('anchoPorcentajeValor').textContent = valor + '%';
        document.getElementById('anchoPorcentajeHidden').value = valor;

        // Actualizar el gradiente del slider
        const slider = document.getElementById('anchoPorcentaje');
        const porcentaje = ((valor - 20) / (90 - 20)) * 100;
        slider.style.setProperty('--value', porcentaje + '%');

        actualizarPreview();
    }

    // Convertir ratio a aspect-ratio CSS
    function getRatioValue(ratio) {
        switch(ratio) {
            case '1:1': return '1 / 1';
            case '4:3': return '4 / 3';
            case '16:9': return '16 / 9';
            case '9:16': return '9 / 16';
            default: return '1 / 1';
        }
    }

    // Obtener ancho en % para imagen con marco
    function getAnchoPorcentaje() {
        return anchoPorcentajeSeleccionado || 50;
    }

    // ========================================
    // PREVIEW
    // ========================================
    function cambiarDispositivo(device) {
        document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const frame = document.getElementById('previewFrame');
        frame.classList.toggle('desktop', device === 'desktop');
    }

    function actualizarPreview() {
        const popup = document.getElementById('previewPopup');
        const content = document.getElementById('previewContent');
        const closeBtn = document.getElementById('previewCloseBtn');
        const overlay = document.getElementById('previewOverlay');
        const typeBadge = document.getElementById('previewTypeBadge');

        // Obtener valores
        const tipo = parseInt(document.getElementById('tipo').value) || 1;
        const posicion = parseInt(document.getElementById('posicion')?.value) || 0;
        const animacion = parseInt(document.getElementById('animacion').value) || 0;
        const colorFondo = document.getElementById('colorFondo').value || '#ffffff';
        const colorTexto = document.getElementById('colorTexto').value || '#111111';
        const colorBoton = document.getElementById('colorBotonPrimario').value || '#4682B4';
        let anchoMaximo = document.getElementById('anchoMaximo').value || 400;
        const cssPersonalizado = document.getElementById('cssPersonalizado')?.value || '';
        const imagen = document.getElementById('imagenUrl').value;

        // Modo Imagen con Marco
        const esImagenMarco = window.modoImagenMarco || false;
        const marco = marcoSeleccionado || 'none';
        const proporcion = proporcionSeleccionada || '1:1';

        // Nombres de tipos
        let tipoNombre = ['Banner', 'Modal', 'Toast', 'Pantalla Completa', 'Panel Lateral'][tipo] || 'Modal';
        if (esImagenMarco) tipoNombre = 'Imagen';
        typeBadge.textContent = tipoNombre;

        // Limpiar clases anteriores
        popup.className = 'preview-popup';

        // Aplicar clase de tipo
        const tipoClases = ['tipo-banner', 'tipo-modal', 'tipo-toast', 'tipo-fullscreen', 'tipo-slide'];
        popup.classList.add(tipoClases[tipo] || 'tipo-modal');

        // Si es imagen con marco, agregar clase especial
        if (esImagenMarco) {
            popup.classList.add('con-marco');
        }

        // Mostrar/ocultar overlay segun tipo
        // Modal (1), FullScreen (3), Slide (4) usan overlay
        const usaOverlay = [1, 3, 4].includes(tipo);
        overlay.classList.toggle('active', usaOverlay);

        // Aplicar posicion segun tipo
        popup.classList.remove('pos-top', 'pos-bottom', 'pos-left', 'pos-right',
            'pos-top-left', 'pos-top-center', 'pos-top-right',
            'pos-bottom-left', 'pos-bottom-center', 'pos-bottom-right');

        if (tipo === 0) {
            // Banner: arriba o abajo
            popup.classList.add(posicion >= 4 ? 'pos-bottom' : 'pos-top');
        } else if (tipo === 2) {
            // Toast: 9 posiciones
            const posToast = ['pos-bottom-right', 'pos-top-left', 'pos-top-center', 'pos-top-right',
                              'pos-bottom-left', 'pos-bottom-center', 'pos-bottom-right', 'pos-top-left', 'pos-top-right'];
            popup.classList.add(posToast[posicion] || 'pos-bottom-right');
        } else if (tipo === 4) {
            // Slide: izquierda o derecha
            popup.classList.add(posicion === 7 ? 'pos-left' : 'pos-right');
        }

        // Aplicar animacion
        popup.classList.remove('anim-bounce', 'anim-zoom', 'anim-shake');
        if (animacion === 6) popup.classList.add('anim-bounce');
        else if (animacion === 7) popup.classList.add('anim-zoom');
        else if (animacion === 8) popup.classList.add('anim-shake');

        // Colores y estilos base
        let estiloInline = '';

        if (esImagenMarco) {
            // Modo imagen: fondo transparente, ancho en porcentaje
            const anchoPct = getAnchoPorcentaje();
            estiloInline = `background:transparent;width:${anchoPct}%;max-width:${anchoPct}%;`;
        } else {
            estiloInline = `background:${colorFondo};color:${colorTexto};`;
            // Ancho maximo (no aplica a Banner ni FullScreen)
            if (tipo !== 0 && tipo !== 3) {
                estiloInline += `max-width:${anchoMaximo}px;`;
            }
        }

        // CSS personalizado
        if (cssPersonalizado) {
            estiloInline += cssPersonalizado;
        }

        popup.style.cssText = estiloInline;

        // Boton cerrar - ocultar en modo imagen con marco
        closeBtn.style.display = (!esImagenMarco && document.getElementById('mostrarBotonCerrar').checked) ? 'flex' : 'none';

        // Contenido
        let html = '';

        if (esImagenMarco) {
            // Modo imagen con marco
            if (imagen) {
                const aspectRatio = getRatioValue(proporcion);
                html = `<div class="popup-imagen-marco marco-${marco}" style="aspect-ratio:${aspectRatio};display:flex;align-items:center;justify-content:center;">
                    <img src="${imagen}" style="max-width:100%;max-height:100%;object-fit:contain;">
                </div>`;
            } else {
                html = `<div class="popup-imagen-marco" style="aspect-ratio:${getRatioValue(proporcion)};background:linear-gradient(135deg,#ddd,#bbb);display:flex;align-items:center;justify-content:center;border-radius:8px;">
                    <span style="color:#999;font-size:12px;">Sube una imagen</span>
                </div>`;
            }
        } else {
            // Modo normal
            const titulo = document.getElementById('titulo').value;
            const contenido = document.getElementById('editorContent').innerHTML || document.getElementById('editorHtml').value;

            // Imagen (no en Banner ni Toast)
            if (imagen && tipo !== 0 && tipo !== 2) {
                html += `<img src="${imagen}" style="max-width:100%;border-radius:8px;margin-bottom:12px;">`;
            }

            if (titulo) {
                const tituloSize = tipo === 0 ? '14px' : '18px';
                const tituloMargin = tipo === 0 ? '0' : '0 0 8px';
                html += `<h3 style="margin:${tituloMargin};font-size:${tituloSize};font-weight:600;">${titulo}</h3>`;
            }

            if (contenido && tipo !== 0) {
                html += `<div style="font-size:14px;line-height:1.5;">${contenido}</div>`;
            }

            // Botones
            if (botones.length > 0) {
                const btnJustify = tipo === 0 ? 'flex-start' : 'center';
                const btnMargin = tipo === 0 ? '0 0 0 auto' : '16px 0 0';
                html += `<div style="margin:${btnMargin};display:flex;gap:8px;justify-content:${btnJustify};flex-wrap:wrap;">`;
                botones.forEach(btn => {
                    if (btn.estilo === 'primary') {
                        html += `<a style="background:${colorBoton};color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;">${btn.texto}</a>`;
                    } else {
                        html += `<a style="background:transparent;color:inherit;border:1px solid currentColor;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;">${btn.texto}</a>`;
                    }
                });
                html += '</div>';
            }
        }

        content.innerHTML = html || '<p style="color:#999;margin:0;">Vista previa del popup...</p>';
    }

    // ========================================
    // TRIGGER OPTIONS
    // ========================================
    function toggleTriggerOptions() {
        const trigger = document.getElementById('trigger').value;
        document.getElementById('triggerDelayGroup').style.display = trigger === '1' ? 'block' : 'none';
        document.getElementById('triggerScrollGroup').style.display = trigger === '2' ? 'block' : 'none';
        document.getElementById('triggerVisitasGroup').style.display = trigger === '4' ? 'block' : 'none';
    }

    function togglePWAOptions() {
        document.getElementById('pwaOptions').style.display = document.getElementById('esPWA').checked ? 'block' : 'none';
    }

    // Watch frequency change
    document.getElementById('frecuencia').addEventListener('change', function() {
        document.getElementById('diasFrecuenciaGroup').style.display = this.value === '3' ? 'block' : 'none';
    });

    // ========================================
    // VALIDACION CSS
    // ========================================
    function validarCssPersonalizado(css) {
        if (!css) return { valid: true };

        // Selectores peligrosos que pueden romper la pagina
        const selectoresPeligrosos = [
            /\bbody\s*\{/i,
            /\bhtml\s*\{/i,
            /\*\s*\{/,
            /\bhead\s*\{/i,
            /\b(display|visibility)\s*:\s*none/i,
            /position\s*:\s*fixed.*inset/i,
            /z-index\s*:\s*(9999|[1-9]\d{4,})/i
        ];

        for (const regex of selectoresPeligrosos) {
            if (regex.test(css)) {
                return {
                    valid: false,
                    mensaje: 'El CSS contiene selectores o propiedades no permitidos que podrian afectar toda la pagina.'
                };
            }
        }
        return { valid: true };
    }

    // ========================================
    // CRUD OPERATIONS
    // ========================================
    async function guardarPopup() {
        // Validar CSS personalizado antes de guardar
        const cssPersonalizado = document.getElementById('cssPersonalizado')?.value || '';
        const validacionCss = validarCssPersonalizado(cssPersonalizado);
        if (!validacionCss.valid) {
            alert('Error: ' + validacionCss.mensaje);
            return;
        }

        // Validar popup con fondo transparente
        const colorFondo = document.getElementById('colorFondo').value || '';
        const imagen = document.getElementById('imagenUrl').value || '';
        const titulo = document.getElementById('titulo').value || '';
        const contenido = document.getElementById('editorContent').innerHTML || document.getElementById('editorHtml').value || '';
        const contenidoLimpio = contenido.replace(/<[^>]*>/g, '').trim(); // Quitar tags HTML
        const esImagenMarco = window.modoImagenMarco || false;

        // Validar: fondo transparente requiere imagen o contenido
        const esTransparente = colorFondo.toLowerCase() === 'transparent' ||
                               colorFondo === '' ||
                               colorFondo.toLowerCase() === '#00000000';
        if (esTransparente) {
            if (!imagen && !contenidoLimpio && !titulo) {
                alert('Error: Un popup con fondo transparente requiere al menos una imagen, titulo o contenido.');
                return;
            }
            if (esImagenMarco && !imagen) {
                alert('Error: El modo "Imagen con Marco" requiere subir una imagen.');
                return;
            }
        }

        // Sync content
        document.getElementById('contenido').value = document.getElementById('editorContent').innerHTML || document.getElementById('editorHtml').value;
        document.getElementById('botonesJson').value = JSON.stringify(botones);

        // Si es modo imagen con marco, usar el porcentaje como anchoMaximo
        if (esImagenMarco) {
            document.getElementById('anchoMaximo').value = anchoPorcentajeSeleccionado || 50;
        }

        const form = document.getElementById('popupForm');
        const formData = new FormData(form);

        // Convert checkboxes
        ['mostrarBotonCerrar', 'cerrarAlClickFuera', 'mostrarUsuariosLogueados', 'mostrarUsuariosAnonimos',
         'mostrarEnMovil', 'mostrarEnDesktop', 'estaActivo', 'esPWA', 'soloSiInstalable', 'soloIOS', 'soloAndroid'].forEach(field => {
            formData.set(field, document.getElementById(field).checked);
        });

        try {
            const response = await fetch('/Admin/GuardarPopup', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });

            const result = await response.json();
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar el popup');
        }
    }

    async function editarPopup(id) {
        try {
            const response = await fetch(`/Admin/ObtenerPopup?id=${id}`);
            const result = await response.json();

            if (result.success) {
                const p = result.popup;
                editandoId = id;

                document.getElementById('modalTitle').innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Editar Popup
                `;

                // Fill form
                document.getElementById('popupId').value = p.id;
                document.getElementById('nombre').value = p.nombre || '';
                document.getElementById('tipo').value = p.tipo;
                document.getElementById('titulo').value = p.titulo || '';
                document.getElementById('editorContent').innerHTML = p.contenido || '';
                document.getElementById('editorHtml').value = p.contenido || '';
                document.getElementById('contenido').value = p.contenido || '';

                if (p.imagenUrl) {
                    document.getElementById('imagenUrl').value = p.imagenUrl;
                    document.getElementById('imagePreviewImg').src = p.imagenUrl;
                    document.getElementById('dropzoneContent').style.display = 'none';
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    dropzone.classList.add('has-image');
                } else {
                    quitarImagen();
                }

                document.getElementById('posicion').value = p.posicion;
                seleccionarPosicion(p.posicion);
                // Manejar fondo transparente para el color picker
                const esTransparenteEdit = p.colorFondo?.toLowerCase() === 'transparent' ||
                                           p.colorFondo?.toLowerCase() === '#00000000';
                document.getElementById('colorFondo').value = p.colorFondo || '#ffffff';
                // El picker de color no soporta transparente, usar blanco como fallback visual
                document.getElementById('colorFondoPicker').value = esTransparenteEdit ? '#ffffff' : (p.colorFondo || '#ffffff');
                document.getElementById('colorTexto').value = p.colorTexto || '#111111';
                document.getElementById('colorTextoPicker').value = p.colorTexto || '#111111';
                document.getElementById('colorBotonPrimario').value = p.colorBotonPrimario || '#4682B4';
                document.getElementById('colorBotonPicker').value = p.colorBotonPrimario || '#4682B4';
                document.getElementById('animacion').value = p.animacion;
                document.getElementById('anchoMaximo').value = p.anchoMaximo || 400;
                document.getElementById('mostrarBotonCerrar').checked = p.mostrarBotonCerrar;
                document.getElementById('cerrarAlClickFuera').checked = p.cerrarAlClickFuera;
                document.getElementById('cssPersonalizado').value = p.cssPersonalizado || '';

                document.getElementById('trigger').value = p.trigger;
                toggleTriggerOptions();
                document.getElementById('delaySegundos').value = p.delaySegundos || 5;
                document.getElementById('scrollPorcentaje').value = p.scrollPorcentaje || 50;
                document.getElementById('visitasRequeridas').value = p.visitasRequeridas || 3;

                document.getElementById('frecuencia').value = p.frecuencia;
                document.getElementById('diasFrecuencia').value = p.diasFrecuencia || 7;
                document.getElementById('diasFrecuenciaGroup').style.display = p.frecuencia === 3 ? 'block' : 'none';

                document.getElementById('mostrarUsuariosLogueados').checked = p.mostrarUsuariosLogueados;
                document.getElementById('mostrarUsuariosAnonimos').checked = p.mostrarUsuariosAnonimos;
                document.getElementById('mostrarEnMovil').checked = p.mostrarEnMovil;
                document.getElementById('mostrarEnDesktop').checked = p.mostrarEnDesktop;
                document.getElementById('paginasIncluidas').value = p.paginasIncluidas || '';
                document.getElementById('paginasExcluidas').value = p.paginasExcluidas || '';
                document.getElementById('fechaInicio').value = p.fechaInicio || '';
                document.getElementById('fechaFin').value = p.fechaFin || '';
                document.getElementById('prioridad').value = p.prioridad || 5;
                document.getElementById('estaActivo').checked = p.estaActivo;

                document.getElementById('esPWA').checked = p.esPWA;
                togglePWAOptions();
                document.getElementById('soloSiInstalable').checked = p.soloSiInstalable;
                document.getElementById('soloIOS').checked = p.soloIOS;
                document.getElementById('soloAndroid').checked = p.soloAndroid;
                document.getElementById('textoBotonInstalar').value = p.textoBotonInstalar || '';
                document.getElementById('contenidoIOS').value = p.contenidoIOS || '';

                // Buttons
                try {
                    botones = p.botonesJson ? JSON.parse(p.botonesJson) : [];
                } catch { botones = []; }
                renderizarBotones();

                // Open modal
                document.getElementById('popupModal').classList.add('active');
                irAPaso(2); // Go to content step
                actualizarPreview();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al cargar el popup');
        }
    }

    async function togglePopup(id) {
        try {
            const formData = new FormData();
            const response = await fetch(`/Admin/TogglePopup?id=${id}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });
            const result = await response.json();
            if (!result.success) {
                alert('Error: ' + result.message);
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            location.reload();
        }
    }

    async function duplicarPopup(id) {
        if (!confirm('Duplicar este popup?')) return;

        try {
            const response = await fetch(`/Admin/DuplicarPopup?id=${id}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function eliminarPopup(id) {
        if (!confirm('Eliminar este popup? Esta accion no se puede deshacer.')) return;

        try {
            const response = await fetch(`/Admin/EliminarPopup?id=${id}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function previsualizarPopup(id) {
        // Open in new window with preview mode
        window.open(`/?previewPopup=${id}`, '_blank');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        actualizarPreview();
    });
</script>

@Html.AntiForgeryToken()
