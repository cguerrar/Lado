@model List<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "Moderacion de Contenido";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-eye text-success"></i> Moderacion de Contenido</h2>
            <p class="text-muted">Total: @Model.Count contenidos</p>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#reclasificarTodoModal">
                <i class="fas fa-brain"></i> Reclasificar Todo con IA
            </button>
            <a href="@Url.Action("Index", "Admin")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <!-- Barra de Acciones Masivas -->
    <div id="bulkActionBar" class="card border-0 shadow-sm mb-4" style="display: none;">
        <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center">
                <input type="checkbox" id="selectAll" class="form-check-input me-3" style="width: 20px; height: 20px;" onchange="toggleSelectAll(this)">
                <span id="selectedCount" class="fw-bold me-3">0 seleccionados</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                    <i class="fas fa-times"></i> Deseleccionar
                </button>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-warning" onclick="openBulkCensorModal()">
                    <i class="fas fa-ban"></i> Censurar
                </button>
                <button type="button" class="btn btn-success" onclick="bulkUncensor()">
                    <i class="fas fa-check"></i> Descensurar
                </button>
                <button type="button" class="btn btn-danger" onclick="openBulkDeleteModal()">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Grid de Contenido -->
    @if (Model.Any())
    {
        <div class="row g-3">
            @foreach (var contenido in Model)
            {
                <div class="col-md-4 col-lg-3">
                    <div class="card border-0 shadow-sm h-100 position-relative content-card" data-id="@contenido.Id">
                        <!-- Checkbox de seleccion -->
                        <div class="position-absolute top-0 end-0 p-2" style="z-index: 15;">
                            <input type="checkbox" class="form-check-input content-checkbox" value="@contenido.Id"
                                   style="width: 22px; height: 22px; cursor: pointer;" onchange="updateSelection()">
                        </div>
                        <!-- Badge de estado -->
                        <div class="position-absolute top-0 start-0 p-2" style="z-index: 10;">
                            @if (contenido.Censurado)
                            {
                                <span class="badge bg-danger">
                                    <i class="fas fa-ban"></i> CENSURADO
                                </span>
                            }
                            else if (contenido.EsContenidoSensible)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-eye-slash"></i> SENSIBLE
                                </span>
                            }
                        </div>

                        <!-- Imagen de preview -->
                        @{
                            var objetosTexto = contenido.ObjetosDetectados?.Any() == true
                                ? string.Join(", ", contenido.ObjetosDetectados.OrderByDescending(o => o.Confianza).Select(o => o.NombreObjeto))
                                : "Sin objetos detectados";
                            var tieneObjetos = contenido.ObjetosDetectados?.Any() == true;
                        }
                        <div class="position-relative" style="height: 250px; overflow: hidden;">
                            @if ((int)contenido.TipoContenido == 1 && !string.IsNullOrEmpty(contenido.RutaArchivo))
                            {
                                <img src="@contenido.RutaArchivo" class="w-100 h-100 imagen-con-objetos"
                                     style="object-fit: cover; @(contenido.EsContenidoSensible ? "filter: blur(20px);" : "")"
                                     alt="Contenido"
                                     data-bs-toggle="tooltip"
                                     data-bs-placement="bottom"
                                     data-bs-html="true"
                                     title="<i class='fas fa-tags me-1'></i> @objetosTexto">
                                @if (contenido.Censurado)
                                {
                                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center">
                                        <i class="fas fa-eye-slash fa-3x text-white"></i>
                                    </div>
                                }
                                else if (contenido.EsContenidoSensible)
                                {
                                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center" style="background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                            <line x1="1" y1="1" x2="23" y2="23"></line>
                                        </svg>
                                        <strong class="text-white mt-2" style="font-size: 0.9rem;">Contenido Sensible</strong>
                                    </div>
                                }
                            }
                            else if ((int)contenido.TipoContenido == 2)
                            {
                                <div class="bg-dark d-flex align-items-center justify-content-center h-100">
                                    <i class="fas fa-play-circle fa-4x text-white"></i>
                                </div>
                            }
                            else if ((int)contenido.TipoContenido == 3)
                            {
                                <div class="d-flex align-items-center justify-content-center h-100" style="background: #4682B4;">
                                    <i class="fas fa-music fa-4x text-white"></i>
                                </div>
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center h-100">
                                    <i class="fas fa-file-alt fa-4x text-muted"></i>
                                </div>
                            }
                        </div>

                        <div class="card-body p-3">
                            @* Header: Usuario + Fecha *@
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                @if (contenido.Usuario != null)
                                {
                                    <div class="d-flex align-items-center">
                                        @if (!string.IsNullOrEmpty(contenido.Usuario.FotoPerfil))
                                        {
                                            <img src="@contenido.Usuario.FotoPerfil" alt="@contenido.Usuario.UserName"
                                                 class="rounded-circle me-2" style="width: 28px; height: 28px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="rounded-circle bg-gradient text-white me-2 d-flex align-items-center justify-content-center"
                                                 style="width: 28px; height: 28px; font-size: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                <strong>@(contenido.Usuario.UserName?.Substring(0, 1).ToUpper() ?? "?")</strong>
                                            </div>
                                        }
                                        <span class="fw-medium small">@(contenido.Usuario.UserName ?? "?")</span>
                                    </div>
                                }
                                <small class="text-muted">@contenido.FechaPublicacion.ToString("dd MMM")</small>
                            </div>

                            @* Descripcion *@
                            <p class="card-text small text-secondary mb-2" style="min-height: 36px;">
                                @if (!string.IsNullOrEmpty(contenido.Descripcion))
                                {
                                    @(contenido.Descripcion.Length > 50 ? contenido.Descripcion.Substring(0, 50) + "..." : contenido.Descripcion)
                                }
                                else
                                {
                                    <span class="fst-italic opacity-50">Sin descripcion</span>
                                }
                            </p>

                            @* Badges de tipo y categoria *@
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                <span class="badge rounded-pill bg-dark bg-opacity-75">
                                    @if ((int)contenido.TipoContenido == 1)
                                    {<i class="fas fa-image"></i>}
                                    else if ((int)contenido.TipoContenido == 2)
                                    {<i class="fas fa-video"></i>}
                                    else
                                    {<i class="fas fa-images"></i>}
                                    @contenido.TipoContenido
                                </span>
                                @if (contenido.PistaMusicalId != null)
                                {
                                    <span class="badge rounded-pill bg-info" title="Con audio"><i class="fas fa-music"></i></span>
                                }
                                @if (contenido.EsPrivado)
                                {
                                    <span class="badge rounded-pill" style="background-color: #8B5CF6;" title="Privado"><i class="fas fa-lock"></i></span>
                                }
                            </div>

                            @* Categoria IA - Destacada *@
                            <div class="mb-2" id="categoria-@contenido.Id">
                                @if (contenido.CategoriaInteres != null)
                                {
                                    <div class="d-flex align-items-center gap-2 p-2 rounded" style="background-color: @(contenido.CategoriaInteres.Color)15;">
                                        <span class="badge" style="background-color: @contenido.CategoriaInteres.Color;">
                                            <i class="@contenido.CategoriaInteres.Icono"></i>
                                        </span>
                                        <small class="fw-medium" style="color: @contenido.CategoriaInteres.Color;">@contenido.CategoriaInteres.Nombre</small>
                                        <i class="fas fa-robot ms-auto text-muted" style="font-size: 0.7rem;" title="Clasificado por IA"></i>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center gap-2 p-2 rounded bg-light">
                                        <span class="badge bg-secondary"><i class="fas fa-question"></i></span>
                                        <small class="text-muted">Sin clasificar</small>
                                    </div>
                                }
                            </div>

                            @* Stats *@
                            <div class="d-flex justify-content-around text-center py-2 mb-3 border-top border-bottom">
                                <div>
                                    <i class="fas fa-heart text-danger"></i>
                                    <span class="small fw-bold ms-1">@(contenido.Likes?.Count ?? 0)</span>
                                </div>
                                <div>
                                    <i class="fas fa-comment text-primary"></i>
                                    <span class="small fw-bold ms-1">@(contenido.Comentarios?.Count ?? 0)</span>
                                </div>
                                <div>
                                    <i class="fas fa-eye text-secondary"></i>
                                    <span class="small fw-bold ms-1">@contenido.NumeroVistas</span>
                                </div>
                            </div>

                            @* Botones Grupo 1: Moderacion *@
                            <div class="d-flex gap-1 mb-2">
                                @if (contenido.Censurado)
                                {
                                    <form method="post" action="@Url.Action("DescensurarContenido", new { id = contenido.Id })"
                                          class="flex-fill" onsubmit="return confirm('Descensurar?')">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-success w-100">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-warning flex-fill" data-bs-toggle="modal"
                                            data-bs-target="#censurarModal" data-contentid="@contenido.Id" title="Censurar">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                }

                                @if (contenido.EsContenidoSensible)
                                {
                                    <form method="post" action="@Url.Action("QuitarContenidoSensible", new { id = contenido.Id })"
                                          class="flex-fill" onsubmit="return confirm('Quitar sensible?')">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-success w-100" title="Quitar Sensible">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <form method="post" action="@Url.Action("MarcarContenidoSensible", new { id = contenido.Id })"
                                          class="flex-fill" onsubmit="return confirm('Marcar sensible?')">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-secondary w-100" title="Marcar Sensible">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                    </form>
                                }
                            </div>

                            @* Botones Grupo 2: IA + Transferir *@
                            <div class="d-flex gap-1 mb-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill"
                                        onclick="reclasificarContenido(@contenido.Id)" title="Reclasificar con IA">
                                    <i class="fas fa-robot" id="icon-reclasificar-@contenido.Id"></i>
                                    <span class="d-none d-xl-inline ms-1">IA</span>
                                </button>
                                <button class="btn btn-sm btn-outline-info flex-fill" data-bs-toggle="modal"
                                        data-bs-target="#transferirModal"
                                        data-contentid="@contenido.Id"
                                        data-username="@(contenido.Usuario?.UserName ?? "?")" title="Transferir">
                                    <i class="fas fa-exchange-alt"></i>
                                    <span class="d-none d-xl-inline ms-1">Transferir</span>
                                </button>
                            </div>

                            @* Boton Eliminar *@
                            <button class="btn btn-sm btn-outline-danger w-100" data-bs-toggle="modal"
                                    data-bs-target="#eliminarModal" data-contentid="@contenido.Id">
                                <i class="fas fa-trash"></i>
                                <span class="ms-1">Eliminar</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontro contenido</h5>
            </div>
        </div>
    }
</div>

<!-- Modal Censurar Individual -->
<div class="modal fade" id="censurarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Censurar Contenido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formCensurar">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <p>Especifica la razon de la censura:</p>
                    <select name="razon" class="form-select mb-3" required>
                        <option value="">Selecciona una razon...</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Violacion de terminos de uso">Violacion de terminos de uso</option>
                        <option value="Contenido ofensivo">Contenido ofensivo</option>
                        <option value="Spam o publicidad no autorizada">Spam o publicidad</option>
                        <option value="Violacion de derechos de autor">Derechos de autor</option>
                        <option value="Contenido violento">Contenido violento</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <textarea name="detalles" class="form-control" rows="3"
                              placeholder="Detalles adicionales (opcional)"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Censurar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Individual -->
<div class="modal fade" id="eliminarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Eliminar Contenido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formEliminar">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ADVERTENCIA!</strong> Esta accion es permanente.
                    </div>
                    <p>Estas seguro de eliminar este contenido?</p>
                    <p class="text-muted small">Se eliminaran tambien todos sus likes y comentarios.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar Permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Censurar Masivo -->
<div class="modal fade" id="bulkCensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-ban"></i> Censurar Contenidos Seleccionados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="@Url.Action("CensurarMasivo", "Admin")" id="formBulkCensor">
                @Html.AntiForgeryToken()
                <div id="bulkCensorIds"></div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Se censuraran <strong id="bulkCensorCount">0</strong> contenidos.
                    </div>
                    <p>Especifica la razon de la censura masiva:</p>
                    <select name="razon" class="form-select mb-3" required>
                        <option value="">Selecciona una razon...</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Violacion de terminos de uso">Violacion de terminos de uso</option>
                        <option value="Contenido ofensivo">Contenido ofensivo</option>
                        <option value="Spam o publicidad no autorizada">Spam o publicidad</option>
                        <option value="Violacion de derechos de autor">Derechos de autor</option>
                        <option value="Contenido violento">Contenido violento</option>
                        <option value="Censura masiva por administrador">Otro</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Censurar Todos</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Masivo -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash"></i> Eliminar Contenidos Seleccionados</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="@Url.Action("EliminarMasivo", "Admin")" id="formBulkDelete">
                @Html.AntiForgeryToken()
                <div id="bulkDeleteIds"></div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ADVERTENCIA!</strong> Esta accion es IRREVERSIBLE.
                    </div>
                    <p>Se eliminaran permanentemente <strong id="bulkDeleteCount">0</strong> contenidos junto con todos sus likes y comentarios.</p>
                    <p class="text-muted">Esta accion no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar Permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Form oculto para Descensurar Masivo -->
<form method="post" action="@Url.Action("DescensurarMasivo", "Admin")" id="formBulkUncensor" style="display: none;">
    @Html.AntiForgeryToken()
    <div id="bulkUncensorIds"></div>
</form>

<!-- Modal Transferir Contenido -->
<div class="modal fade" id="transferirModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Transferir Contenido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formTransferir">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Propietario actual:</strong> <span id="transferirUsuarioActual"></span>
                    </div>
                    <p>Selecciona el nuevo propietario del contenido:</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Buscar usuario por nombre</label>
                        <input type="text" class="form-control" id="buscarUsuario" placeholder="Escribe el nombre de usuario..."
                               autocomplete="off">
                        <div id="resultadosUsuarios" class="list-group mt-2" style="max-height: 200px; overflow-y: auto; display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Usuario seleccionado</label>
                        <input type="hidden" name="nuevoUsuarioId" id="nuevoUsuarioId" required>
                        <div id="usuarioSeleccionado" class="alert alert-secondary">
                            <em>Ninguno seleccionado</em>
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="cambiarTipoLado" name="cambiarTipoLado" value="true">
                        <label class="form-check-label" for="cambiarTipoLado">
                            Cambiar de Lado A a Lado B (o viceversa)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info" id="btnTransferir" disabled>Transferir Contenido</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Reclasificar Todo con IA -->
<div class="modal fade" id="reclasificarTodoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-brain"></i> Reclasificar Todo el Contenido con IA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <h5><i class="fas fa-exclamation-triangle"></i> ADVERTENCIA DE COSTO</h5>
                    <p class="mb-2">Esta operacion usa la API de Claude (Anthropic) para clasificar cada imagen individualmente.</p>
                    <ul class="mb-2">
                        <li><strong>Costo estimado:</strong> ~$0.001 - $0.003 USD por imagen</li>
                        <li><strong>Total contenidos:</strong> @Model.Count</li>
                        <li><strong>Costo maximo estimado:</strong> ~$@((Model.Count * 0.003m).ToString("F2")) USD</li>
                    </ul>
                    <p class="mb-0 text-danger"><strong>El costo real depende del tamano de las imagenes y la respuesta de la IA.</strong></p>
                </div>

                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Que hace esta operacion?</h6>
                    <ol class="mb-0">
                        <li>Elimina TODAS las categorias existentes</li>
                        <li>Procesa hasta 200 contenidos con imagenes</li>
                        <li>Claude analiza cada imagen y asigna/crea categorias</li>
                        <li>Crea subcategorias automaticamente si una categoria tiene 10+ items</li>
                    </ol>
                </div>

                <div id="reclasificarProgreso" style="display: none;">
                    <hr>
                    <h6><i class="fas fa-spinner fa-spin"></i> Procesando...</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted small" id="reclasificarStatus">Iniciando...</p>
                </div>

                <div id="reclasificarResultado" style="display: none;">
                    <hr>
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Proceso completado</h6>
                        <ul class="mb-0" id="reclasificarStats"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex-wrap gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarReclasificar">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnClasificarPendientes" onclick="clasificarPendientes()">
                    <i class="fas fa-forward"></i> Solo Clasificar Pendientes
                </button>
                <button type="button" class="btn btn-danger" id="btnIniciarReclasificar" onclick="iniciarReclasificacionMasiva()">
                    <i class="fas fa-trash-alt"></i> Limpiar Todo y Reclasificar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Inicializar tooltips de Bootstrap para mostrar objetos detectados
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { show: 200, hide: 100 }
            });
        });
    });

    // Función de escape para prevenir XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Reclasificar contenido con IA
    async function reclasificarContenido(id) {
        const icon = document.getElementById('icon-reclasificar-' + id);
        const categoriaContainer = document.getElementById('categoria-' + id);

        // Mostrar loading
        icon.className = 'fas fa-spinner fa-spin';

        try {
            const response = await fetch('@Url.Action("ReclasificarContenido", "Admin")?id=' + id, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                // Actualizar la UI con la nueva categoria
                const esNueva = data.categoriaCreada ? '<i class="fas fa-sparkles text-warning ms-1" title="Categoria creada por IA"></i>' : '';
                categoriaContainer.innerHTML = `
                    <div class="d-flex align-items-center gap-2 p-2 rounded" style="background-color: ${data.categoriaColor}15;">
                        <span class="badge" style="background-color: ${data.categoriaColor};">
                            <i class="${data.categoriaIcono}"></i>
                        </span>
                        <small class="fw-medium" style="color: ${data.categoriaColor};">${data.categoriaNombre}${esNueva}</small>
                        <i class="fas fa-robot ms-auto text-muted" style="font-size: 0.7rem;" title="Clasificado por IA (${data.tiempoMs}ms)"></i>
                    </div>
                `;

                // Actualizar tooltip con objetos detectados
                const card = document.querySelector(`.content-card[data-id="${id}"]`);
                const img = card?.querySelector('img.imagen-con-objetos');
                if (img && data.objetosDetectados && data.objetosDetectados.length > 0) {
                    const objetosTexto = data.objetosDetectados.join(', ');
                    const tooltipInstance = bootstrap.Tooltip.getInstance(img);
                    if (tooltipInstance) {
                        tooltipInstance.setContent({ '.tooltip-inner': `<i class="fas fa-tags me-1"></i> ${objetosTexto}` });
                    } else {
                        img.setAttribute('title', `<i class="fas fa-tags me-1"></i> ${objetosTexto}`);
                        new bootstrap.Tooltip(img, { delay: { show: 200, hide: 100 } });
                    }
                }

                icon.className = 'fas fa-check text-success';
                setTimeout(() => { icon.className = 'fas fa-robot'; }, 2000);
            } else {
                // Mostrar error visual sin alert - el detalle queda en el log del servidor
                icon.className = 'fas fa-times text-danger';
                categoriaContainer.innerHTML = `
                    <small class="text-danger" title="${data.detalle || data.message || 'Error'}">
                        <i class="fas fa-exclamation-triangle"></i> Error IA
                    </small>
                `;
                console.warn('Error clasificacion IA:', data.message, data.detalle);
                setTimeout(() => { icon.className = 'fas fa-robot'; }, 3000);
            }
        } catch (error) {
            // Error de conexion - mostrar visual sin alert
            icon.className = 'fas fa-times text-danger';
            console.error('Error conexion clasificacion:', error.message);
            setTimeout(() => { icon.className = 'fas fa-robot'; }, 3000);
        }
    }

    // Modal Censurar Individual
    document.getElementById('censurarModal').addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var contentId = button.getAttribute('data-contentid');
        document.getElementById('formCensurar').action = '/Admin/CensurarContenido/' + contentId;
    });

    // Modal Eliminar Individual
    document.getElementById('eliminarModal').addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var contentId = button.getAttribute('data-contentid');
        document.getElementById('formEliminar').action = '/Admin/EliminarContenido/' + contentId;
    });

    // Modal Transferir Contenido
    var transferirContentId = null;
    document.getElementById('transferirModal').addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        transferirContentId = button.getAttribute('data-contentid');
        var username = button.getAttribute('data-username');
        document.getElementById('transferirUsuarioActual').textContent = username;
        document.getElementById('formTransferir').action = '/Admin/TransferirContenido/' + transferirContentId;
        // Reset form
        document.getElementById('buscarUsuario').value = '';
        document.getElementById('nuevoUsuarioId').value = '';
        document.getElementById('usuarioSeleccionado').innerHTML = '<em>Ninguno seleccionado</em>';
        document.getElementById('btnTransferir').disabled = true;
        document.getElementById('resultadosUsuarios').style.display = 'none';
    });

    // Buscar usuarios para transferir
    var timeoutBusqueda = null;
    document.getElementById('buscarUsuario').addEventListener('input', function() {
        var query = this.value.trim();
        if (query.length < 2) {
            document.getElementById('resultadosUsuarios').style.display = 'none';
            return;
        }

        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(function() {
            fetch('/Admin/BuscarUsuarios?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('resultadosUsuarios');
                    container.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(function(user) {
                            var item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action d-flex align-items-center gap-2';
                            item.innerHTML = (user.fotoPerfil ?
                                '<img src="' + escapeHtml(user.fotoPerfil) + '" class="rounded-circle" style="width:30px;height:30px;object-fit:cover;">' :
                                '<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:30px;height:30px;font-size:0.8rem;"><strong>' + escapeHtml(user.userName?.substring(0,1)?.toUpperCase() || '') + '</strong></div>') +
                                '<span><strong>' + escapeHtml(user.userName) + '</strong>' + (user.esCreador ? ' <span class="badge bg-success">Creador</span>' : '') + '</span>';
                            item.onclick = function() {
                                seleccionarUsuario(user.id, user.userName, user.fotoPerfil);
                            };
                            container.appendChild(item);
                        });
                        container.style.display = 'block';
                    } else {
                        container.innerHTML = '<div class="list-group-item text-muted">No se encontraron usuarios</div>';
                        container.style.display = 'block';
                    }
                });
        }, 300);
    });

    function seleccionarUsuario(id, userName, fotoPerfil) {
        document.getElementById('nuevoUsuarioId').value = id;
        document.getElementById('usuarioSeleccionado').innerHTML =
            '<div class="d-flex align-items-center gap-2">' +
            (fotoPerfil ?
                '<img src="' + escapeHtml(fotoPerfil) + '" class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">' :
                '<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:40px;height:40px;"><strong>' + escapeHtml(userName?.substring(0,1)?.toUpperCase() || '') + '</strong></div>') +
            '<strong>' + escapeHtml(userName) + '</strong></div>';
        document.getElementById('btnTransferir').disabled = false;
        document.getElementById('resultadosUsuarios').style.display = 'none';
        document.getElementById('buscarUsuario').value = '';
    }

    // Funciones para acciones masivas
    function getSelectedIds() {
        var checkboxes = document.querySelectorAll('.content-checkbox:checked');
        var ids = [];
        checkboxes.forEach(function(cb) {
            ids.push(cb.value);
        });
        return ids;
    }

    function updateSelection() {
        var ids = getSelectedIds();
        var count = ids.length;
        var bar = document.getElementById('bulkActionBar');
        var countSpan = document.getElementById('selectedCount');

        if (count > 0) {
            bar.style.display = 'block';
            countSpan.textContent = count + ' seleccionado' + (count > 1 ? 's' : '');
        } else {
            bar.style.display = 'none';
        }

        var allCheckboxes = document.querySelectorAll('.content-checkbox');
        var selectAll = document.getElementById('selectAll');
        selectAll.checked = (count === allCheckboxes.length && count > 0);
        selectAll.indeterminate = (count > 0 && count < allCheckboxes.length);
    }

    function toggleSelectAll(checkbox) {
        var checkboxes = document.querySelectorAll('.content-checkbox');
        checkboxes.forEach(function(cb) {
            cb.checked = checkbox.checked;
        });
        updateSelection();
    }

    function deselectAll() {
        var checkboxes = document.querySelectorAll('.content-checkbox');
        checkboxes.forEach(function(cb) {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateSelection();
    }

    function openBulkCensorModal() {
        var ids = getSelectedIds();
        if (ids.length === 0) {
            alert('Selecciona al menos un contenido');
            return;
        }

        document.getElementById('bulkCensorCount').textContent = ids.length;
        var container = document.getElementById('bulkCensorIds');
        container.innerHTML = '';
        ids.forEach(function(id) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            container.appendChild(input);
        });

        var modal = new bootstrap.Modal(document.getElementById('bulkCensorModal'));
        modal.show();
    }

    function openBulkDeleteModal() {
        var ids = getSelectedIds();
        if (ids.length === 0) {
            alert('Selecciona al menos un contenido');
            return;
        }

        document.getElementById('bulkDeleteCount').textContent = ids.length;
        var container = document.getElementById('bulkDeleteIds');
        container.innerHTML = '';
        ids.forEach(function(id) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            container.appendChild(input);
        });

        var modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
        modal.show();
    }

    function bulkUncensor() {
        var ids = getSelectedIds();
        if (ids.length === 0) {
            alert('Selecciona al menos un contenido');
            return;
        }

        if (!confirm('Descensurar ' + ids.length + ' contenido(s) seleccionado(s)?')) {
            return;
        }

        var container = document.getElementById('bulkUncensorIds');
        container.innerHTML = '';
        ids.forEach(function(id) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            container.appendChild(input);
        });

        document.getElementById('formBulkUncensor').submit();
    }

    // Variables globales para el proceso
    let reclasificarCancelado = false;
    let totalClasificados = 0;
    let totalErrores = 0;
    let totalCategoriasCreadas = 0;
    let totalSubcategoriasCreadas = 0;

    // Reclasificar todo el contenido con IA (en lotes)
    async function iniciarReclasificacionMasiva() {
        const btnIniciar = document.getElementById('btnIniciarReclasificar');
        const btnPendientes = document.getElementById('btnClasificarPendientes');
        const btnCancelar = document.getElementById('btnCancelarReclasificar');
        const progreso = document.getElementById('reclasificarProgreso');
        const resultado = document.getElementById('reclasificarResultado');
        const progressBar = progreso.querySelector('.progress-bar');
        const status = document.getElementById('reclasificarStatus');
        const stats = document.getElementById('reclasificarStats');

        // Reset
        reclasificarCancelado = false;
        totalClasificados = 0;
        totalErrores = 0;
        totalCategoriasCreadas = 0;
        totalSubcategoriasCreadas = 0;

        // UI
        btnIniciar.disabled = true;
        btnPendientes.disabled = true;
        btnIniciar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        btnCancelar.textContent = 'Detener';
        btnCancelar.onclick = function() { reclasificarCancelado = true; };
        progreso.style.display = 'block';
        resultado.style.display = 'none';
        progressBar.style.width = '5%';
        progressBar.classList.add('progress-bar-animated');
        status.textContent = 'Limpiando categorias existentes...';

        try {
            // Paso 1: Limpiar categorías
            const limpiarResp = await fetch('@Url.Action("ReclasificarContenidoIA", "Admin")', { method: 'POST' });
            const limpiarData = await limpiarResp.json();

            if (!limpiarData.success) {
                throw new Error(limpiarData.message || 'Error al limpiar');
            }

            let pendientes = limpiarData.pendientes;
            const totalInicial = pendientes;
            progressBar.style.width = '10%';
            status.textContent = `Iniciando clasificacion de ${pendientes} contenidos...`;

            // Paso 2: Clasificar en lotes de 5
            while (pendientes > 0 && !reclasificarCancelado) {
                const loteResp = await fetch('@Url.Action("ReclasificarLoteIA", "Admin")', { method: 'POST' });
                const loteData = await loteResp.json();

                if (!loteData.success) {
                    throw new Error(loteData.message || 'Error en lote');
                }

                totalClasificados += loteData.clasificados || 0;
                totalErrores += loteData.errores || 0;
                totalCategoriasCreadas += loteData.categoriasCreadas || 0;
                totalSubcategoriasCreadas += loteData.subcategoriasCreadas || 0;
                pendientes = loteData.pendientes;

                // Mostrar errores en consola si hay
                if (loteData.detallesErrores && loteData.detallesErrores.length > 0) {
                    console.warn('Errores en lote:', loteData.detallesErrores);
                }

                // Actualizar progreso
                const porcentaje = totalInicial > 0 ? Math.round(((totalInicial - pendientes) / totalInicial) * 90) + 10 : 100;
                progressBar.style.width = porcentaje + '%';
                status.textContent = `Clasificados: ${totalClasificados} | Errores: ${totalErrores} | Pendientes: ${pendientes}`;

                if (loteData.terminado) break;
            }

            // Finalizado
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progreso.style.display = 'none';
            resultado.style.display = 'block';

            const estadoFinal = reclasificarCancelado ? '(Detenido por usuario)' : '';
            stats.innerHTML = `
                <li><strong>Contenidos clasificados:</strong> ${totalClasificados} ${estadoFinal}</li>
                <li><strong>Errores:</strong> ${totalErrores}</li>
                <li><strong>Categorias creadas:</strong> ${totalCategoriasCreadas}</li>
                <li><strong>Subcategorias creadas:</strong> ${totalSubcategoriasCreadas}</li>
            `;

            btnCancelar.textContent = 'Cerrar y Recargar';
            btnCancelar.onclick = function() { window.location.reload(); };
            btnIniciar.style.display = 'none';
            btnPendientes.style.display = 'none';

        } catch (error) {
            status.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> Error: ' + error.message + '</span>';
            btnCancelar.disabled = false;
            btnIniciar.disabled = false;
            btnPendientes.disabled = false;
            btnIniciar.innerHTML = '<i class="fas fa-trash-alt"></i> Reintentar';
        }
    }

    // Solo clasificar pendientes (sin limpiar)
    async function clasificarPendientes() {
        const btnIniciar = document.getElementById('btnIniciarReclasificar');
        const btnPendientes = document.getElementById('btnClasificarPendientes');
        const btnCancelar = document.getElementById('btnCancelarReclasificar');
        const progreso = document.getElementById('reclasificarProgreso');
        const resultado = document.getElementById('reclasificarResultado');
        const progressBar = progreso.querySelector('.progress-bar');
        const status = document.getElementById('reclasificarStatus');
        const stats = document.getElementById('reclasificarStats');

        reclasificarCancelado = false;
        totalClasificados = 0;
        totalErrores = 0;
        totalCategoriasCreadas = 0;
        totalSubcategoriasCreadas = 0;

        btnIniciar.disabled = true;
        btnPendientes.disabled = true;
        btnPendientes.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        btnCancelar.textContent = 'Detener';
        btnCancelar.onclick = function() { reclasificarCancelado = true; };
        progreso.style.display = 'block';
        resultado.style.display = 'none';
        progressBar.style.width = '5%';
        progressBar.classList.add('progress-bar-animated');

        try {
            // Obtener estado inicial
            const estadoResp = await fetch('@Url.Action("EstadoClasificacionIA", "Admin")');
            const estado = await estadoResp.json();

            let pendientes = estado.sinClasificar;
            const totalInicial = pendientes;

            if (pendientes === 0) {
                status.textContent = 'No hay contenidos pendientes de clasificar.';
                btnCancelar.textContent = 'Cerrar';
                btnCancelar.onclick = function() { bootstrap.Modal.getInstance(document.getElementById('reclasificarTodoModal')).hide(); };
                return;
            }

            status.textContent = `Clasificando ${pendientes} contenidos pendientes...`;

            while (pendientes > 0 && !reclasificarCancelado) {
                const loteResp = await fetch('@Url.Action("ReclasificarLoteIA", "Admin")', { method: 'POST' });
                const loteData = await loteResp.json();

                if (!loteData.success) throw new Error(loteData.message);

                totalClasificados += loteData.clasificados || 0;
                totalErrores += loteData.errores || 0;
                totalCategoriasCreadas += loteData.categoriasCreadas || 0;
                totalSubcategoriasCreadas += loteData.subcategoriasCreadas || 0;
                pendientes = loteData.pendientes;

                // Mostrar errores en consola si hay
                if (loteData.detallesErrores && loteData.detallesErrores.length > 0) {
                    console.warn('Errores en lote:', loteData.detallesErrores);
                }

                const porcentaje = totalInicial > 0 ? Math.round(((totalInicial - pendientes) / totalInicial) * 100) : 100;
                progressBar.style.width = porcentaje + '%';
                status.textContent = `Clasificados: ${totalClasificados} | Errores: ${totalErrores} | Pendientes: ${pendientes}`;

                if (loteData.terminado) break;
            }

            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progreso.style.display = 'none';
            resultado.style.display = 'block';
            stats.innerHTML = `
                <li><strong>Contenidos clasificados:</strong> ${totalClasificados}</li>
                <li><strong>Errores:</strong> ${totalErrores}</li>
                <li><strong>Categorias creadas:</strong> ${totalCategoriasCreadas}</li>
                <li><strong>Subcategorias creadas:</strong> ${totalSubcategoriasCreadas}</li>
            `;
            btnCancelar.textContent = 'Cerrar y Recargar';
            btnCancelar.onclick = function() { window.location.reload(); };
            btnIniciar.style.display = 'none';
            btnPendientes.style.display = 'none';

        } catch (error) {
            status.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> Error: ' + error.message + '</span>';
            btnIniciar.disabled = false;
            btnPendientes.disabled = false;
            btnPendientes.innerHTML = '<i class="fas fa-forward"></i> Solo Clasificar Pendientes';
        }
    }
</script>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }

    .content-checkbox {
        background-color: white;
        border: 2px solid #dee2e6;
    }

    .content-checkbox:checked {
        background-color: #4682B4;
        border-color: #4682B4;
    }

    #bulkActionBar {
        position: sticky;
        top: 70px;
        z-index: 100;
        background: white;
    }
</style>
