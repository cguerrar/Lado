@model List<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "Moderacion de Contenido";

    string FormatearTamano(long? bytes)
    {
        if (!bytes.HasValue || bytes.Value == 0) return "-";
        if (bytes.Value < 1024) return $"{bytes.Value} B";
        if (bytes.Value < 1024 * 1024) return $"{bytes.Value / 1024.0:F1} KB";
        return $"{bytes.Value / (1024.0 * 1024.0):F1} MB";
    }

    string ObtenerCodec(string? ext)
    {
        if (string.IsNullOrEmpty(ext)) return "-";
        return ext.ToLower() switch
        {
            ".mp4" => "H.264",
            ".mov" => "ProRes",
            ".webm" => "VP9",
            ".avi" => "AVI",
            ".mkv" => "MKV",
            ".jpg" or ".jpeg" => "JPEG",
            ".png" => "PNG",
            ".gif" => "GIF",
            ".webp" => "WebP",
            ".heic" or ".heif" => "HEIC",
            _ => ext.ToUpper().TrimStart('.')
        };
    }

    string FormatearDuracion(int? segundos)
    {
        if (!segundos.HasValue || segundos.Value == 0) return "-";
        var mins = segundos.Value / 60;
        var secs = segundos.Value % 60;
        return mins > 0 ? $"{mins}:{secs:D2}" : $"0:{secs:D2}";
    }

    string ObtenerAspectRatio(int? ancho, int? alto)
    {
        if (!ancho.HasValue || !alto.HasValue || ancho.Value == 0 || alto.Value == 0) return "-";
        var gcd = GCD(ancho.Value, alto.Value);
        var w = ancho.Value / gcd;
        var h = alto.Value / gcd;
        // Simplificar ratios comunes
        if ((w == 16 && h == 9) || (w == 9 && h == 16)) return $"{w}:{h}";
        if ((w == 4 && h == 3) || (w == 3 && h == 4)) return $"{w}:{h}";
        if (w == h) return "1:1";
        // Para otros, mostrar aproximado
        var ratio = (double)ancho.Value / alto.Value;
        if (Math.Abs(ratio - 1.78) < 0.1) return "16:9";
        if (Math.Abs(ratio - 0.56) < 0.1) return "9:16";
        if (Math.Abs(ratio - 1.33) < 0.1) return "4:3";
        return $"{w}:{h}";
    }

    int GCD(int a, int b) => b == 0 ? a : GCD(b, a % b);
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-lg-5 mb-3 mb-lg-0">
                    <h2 class="h4 mb-1"><i class="fas fa-photo-video text-primary"></i> Moderacion de Contenido</h2>
                    <div class="d-flex gap-3 text-muted small">
                        <span><i class="fas fa-database"></i> @Model.Count total</span>
                        <span><i class="fas fa-image text-success"></i> @Model.Count(c => c.TipoContenido == TipoContenido.Foto) fotos</span>
                        <span><i class="fas fa-video text-primary"></i> @Model.Count(c => c.TipoContenido == TipoContenido.Video) videos</span>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                        <div class="btn-group">
                            <a href="@Url.Action("ActualizarMetadatos", "Admin")" class="btn btn-outline-info" title="Extraer dimensiones, peso y duracion">
                                <i class="fas fa-info-circle"></i> Metadatos
                            </a>
                            <a href="@Url.Action("MigracionMedias", "Admin")" class="btn btn-outline-warning" title="Convertir formatos">
                                <i class="fas fa-sync-alt"></i> Migrar
                            </a>
                            <a href="@Url.Action("AnalizarVideos", "Admin")" class="btn btn-outline-danger" title="Analizar codec real de videos">
                                <i class="fas fa-video"></i> Videos
                            </a>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reclasificarTodoModal" title="Clasificar con IA">
                                <i class="fas fa-brain"></i> IA
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="?"><i class="fas fa-list"></i> Todos</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?tipo=foto"><i class="fas fa-image"></i> Solo Fotos</a></li>
                                <li><a class="dropdown-item" href="?tipo=video"><i class="fas fa-video"></i> Solo Videos</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?estado=censurado"><i class="fas fa-ban text-danger"></i> Censurados</a></li>
                                <li><a class="dropdown-item" href="?estado=sensible"><i class="fas fa-eye-slash text-warning"></i> Sensibles</a></li>
                            </ul>
                        </div>
                        <a href="@Url.Action("Index", "Admin")" class="btn btn-outline-dark">
                            <i class="fas fa-arrow-left"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Acciones Masivas -->
    <div id="bulkActionBar" class="alert alert-primary py-2 mb-4" style="display: none;">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <input type="checkbox" id="selectAll" class="form-check-input" style="width: 18px; height: 18px;" onchange="toggleSelectAll(this)">
                <span id="selectedCount" class="fw-bold">0 seleccionados</span>
                <button type="button" class="btn btn-sm btn-link p-0" onclick="deselectAll()">Limpiar</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-warning" onclick="openBulkCensorModal()"><i class="fas fa-ban"></i> Censurar</button>
                <button type="button" class="btn btn-success" onclick="bulkUncensor()"><i class="fas fa-check"></i> Descensurar</button>
                <button type="button" class="btn btn-danger" onclick="openBulkDeleteModal()"><i class="fas fa-trash"></i> Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Grid de Contenido -->
    @if (Model.Any())
    {
        <div class="row g-3">
            @foreach (var contenido in Model)
            {
                var ext = System.IO.Path.GetExtension(contenido.RutaArchivo ?? "").ToLower();
                var esVideo = contenido.TipoContenido == TipoContenido.Video;
                var esCarrusel = contenido.Archivos?.Count > 1;
                var numArchivos = contenido.Archivos?.Count ?? (string.IsNullOrEmpty(contenido.RutaArchivo) ? 0 : 1);
                var primerArchivo = contenido.Archivos?.OrderBy(a => a.Orden).FirstOrDefault();

                // Info del archivo
                var ancho = primerArchivo?.Ancho;
                var alto = primerArchivo?.Alto;
                var tamano = primerArchivo?.TamanoBytes;
                var duracion = primerArchivo?.DuracionSegundos;

                <div class="col-sm-6 col-lg-4 col-xl-3">
                    <div class="card border-0 shadow-sm h-100 content-card" data-id="@contenido.Id">
                        <div class="row g-0 h-100">
                            <!-- Columna izquierda: Preview -->
                            <div class="col-5 position-relative">
                                <!-- Checkbox -->
                                <div class="position-absolute" style="top: 6px; left: 6px; z-index: 10;">
                                    <input type="checkbox" class="form-check-input content-checkbox bg-white shadow-sm"
                                           value="@contenido.Id" style="width: 18px; height: 18px;" onchange="updateSelection()">
                                </div>

                                <!-- Preview -->
                                <div class="h-100" style="min-height: 200px;">
                                    @if (contenido.TipoContenido == TipoContenido.Foto && !string.IsNullOrEmpty(contenido.RutaArchivo))
                                    {
                                        <img src="@contenido.RutaArchivo" class="w-100 h-100 rounded-start"
                                             style="object-fit: cover; @(contenido.Censurado || contenido.EsContenidoSensible ? "filter: blur(12px);" : "")"
                                             alt="" loading="lazy">
                                    }
                                    else if (esVideo)
                                    {
                                        @if (!string.IsNullOrEmpty(contenido.Thumbnail))
                                        {
                                            <img src="@contenido.Thumbnail" class="w-100 h-100 rounded-start"
                                                 style="object-fit: cover; @(contenido.Censurado || contenido.EsContenidoSensible ? "filter: blur(12px);" : "")"
                                                 alt="" loading="lazy">
                                        }
                                        else
                                        {
                                            <div class="w-100 h-100 bg-dark d-flex align-items-center justify-content-center rounded-start">
                                                <i class="fas fa-video fa-2x text-white-50"></i>
                                            </div>
                                        }
                                        <div class="position-absolute top-50 start-50 translate-middle">
                                            <i class="fas fa-play-circle fa-2x text-white" style="text-shadow: 0 2px 6px rgba(0,0,0,0.6);"></i>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center rounded-start">
                                            <i class="fas fa-file fa-2x text-muted"></i>
                                        </div>
                                    }

                                    <!-- Overlay estados -->
                                    @if (contenido.Censurado)
                                    {
                                        <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center rounded-start">
                                            <span class="badge bg-danger"><i class="fas fa-ban"></i> CENSURADO</span>
                                        </div>
                                    }

                                    <!-- Badges esquina inferior -->
                                    <div class="position-absolute bottom-0 start-0 p-1 d-flex gap-1">
                                        @if (contenido.EsContenidoSensible && !contenido.Censurado)
                                        {
                                            <span class="badge bg-warning text-dark" style="font-size: 0.65rem;"><i class="fas fa-eye-slash"></i></span>
                                        }
                                        @if (contenido.EsPrivado)
                                        {
                                            <span class="badge bg-purple" style="font-size: 0.65rem; background-color: #8B5CF6;"><i class="fas fa-lock"></i></span>
                                        }
                                        @if (esCarrusel)
                                        {
                                            <span class="badge bg-info" style="font-size: 0.65rem;"><i class="fas fa-images"></i> @numArchivos</span>
                                        }
                                        @if (contenido.EsReel)
                                        {
                                            <span class="badge bg-danger" style="font-size: 0.65rem;"><i class="fas fa-film"></i></span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Columna derecha: Info -->
                            <div class="col-7">
                                <div class="card-body p-2 d-flex flex-column h-100">
                                    <!-- Usuario y fecha -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center text-truncate" style="max-width: 70%;">
                                            @if (contenido.Usuario != null)
                                            {
                                                @if (!string.IsNullOrEmpty(contenido.Usuario.FotoPerfil))
                                                {
                                                    <img src="@contenido.Usuario.FotoPerfil" class="rounded-circle me-1"
                                                         style="width: 20px; height: 20px; object-fit: cover;">
                                                }
                                                <small class="fw-medium text-truncate">@contenido.Usuario.UserName</small>
                                            }
                                        </div>
                                        <small class="text-muted">@contenido.FechaPublicacion.ToString("dd/MM")</small>
                                    </div>

                                    <!-- Info tecnica del archivo -->
                                    <div class="small bg-light rounded p-2 mb-2" style="font-size: 0.75rem;">
                                        <table class="w-100 mb-0">
                                            <tr>
                                                <td class="text-muted pe-2">Tipo:</td>
                                                <td class="fw-medium">
                                                    @if (esVideo)
                                                    {<i class="fas fa-video text-primary"></i>}
                                                    else
                                                    {<i class="fas fa-image text-success"></i>}
                                                    @(ext.ToUpper().TrimStart('.'))
                                                    <span class="text-muted">(@ObtenerCodec(ext))</span>
                                                </td>
                                            </tr>
                                            @if (ancho.HasValue && alto.HasValue)
                                            {
                                                <tr>
                                                    <td class="text-muted pe-2">Res:</td>
                                                    <td class="fw-medium">@(ancho)x@(alto) <span class="text-muted">(@ObtenerAspectRatio(ancho, alto))</span></td>
                                                </tr>
                                            }
                                            @if (tamano.HasValue && tamano.Value > 0)
                                            {
                                                <tr>
                                                    <td class="text-muted pe-2">Peso:</td>
                                                    <td class="fw-medium">@FormatearTamano(tamano)</td>
                                                </tr>
                                            }
                                            @if (esVideo && duracion.HasValue && duracion.Value > 0)
                                            {
                                                <tr>
                                                    <td class="text-muted pe-2">Dur:</td>
                                                    <td class="fw-medium"><i class="fas fa-clock text-info"></i> @FormatearDuracion(duracion)</td>
                                                </tr>
                                            }
                                            @if (esCarrusel)
                                            {
                                                <tr>
                                                    <td class="text-muted pe-2">Arch:</td>
                                                    <td class="fw-medium">@numArchivos archivos</td>
                                                </tr>
                                            }
                                        </table>
                                    </div>

                                    <!-- Categoria IA -->
                                    <div class="mb-2" id="categoria-@contenido.Id">
                                        @if (contenido.CategoriaInteres != null)
                                        {
                                            <div class="d-flex align-items-center gap-1">
                                                <span class="badge" style="background-color: @contenido.CategoriaInteres.Color; font-size: 0.6rem;">
                                                    <i class="@contenido.CategoriaInteres.Icono"></i>
                                                </span>
                                                <small class="text-truncate" style="color: @contenido.CategoriaInteres.Color; font-size: 0.7rem;">
                                                    @contenido.CategoriaInteres.Nombre
                                                </small>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary" style="font-size: 0.6rem;"><i class="fas fa-question"></i> Sin clasificar</span>
                                        }
                                    </div>

                                    <!-- Stats -->
                                    <div class="d-flex gap-3 text-muted mb-2" style="font-size: 0.75rem;">
                                        <span><i class="fas fa-heart text-danger"></i> @(contenido.NumeroLikes)</span>
                                        <span><i class="fas fa-comment text-primary"></i> @(contenido.NumeroComentarios)</span>
                                        <span><i class="fas fa-eye"></i> @contenido.NumeroVistas</span>
                                    </div>

                                    <!-- Botones de accion -->
                                    <div class="mt-auto d-flex gap-1">
                                        <!-- Dropdown Moderacion -->
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow">
                                                <li class="dropdown-header">Moderacion</li>
                                                @if (contenido.Censurado)
                                                {
                                                    <li>
                                                        <form method="post" action="@Url.Action("DescensurarContenido", new { id = contenido.Id })">
                                                            @Html.AntiForgeryToken()
                                                            <button type="submit" class="dropdown-item"><i class="fas fa-check text-success"></i> Descensurar</button>
                                                        </form>
                                                    </li>
                                                }
                                                else
                                                {
                                                    <li>
                                                        <button type="button" class="dropdown-item" data-bs-toggle="modal"
                                                                data-bs-target="#censurarModal" data-contentid="@contenido.Id">
                                                            <i class="fas fa-ban text-warning"></i> Censurar
                                                        </button>
                                                    </li>
                                                }
                                                @if (contenido.EsContenidoSensible)
                                                {
                                                    <li>
                                                        <form method="post" action="@Url.Action("QuitarContenidoSensible", new { id = contenido.Id })">
                                                            @Html.AntiForgeryToken()
                                                            <button type="submit" class="dropdown-item"><i class="fas fa-eye text-success"></i> Quitar Sensible</button>
                                                        </form>
                                                    </li>
                                                }
                                                else
                                                {
                                                    <li>
                                                        <form method="post" action="@Url.Action("MarcarContenidoSensible", new { id = contenido.Id })">
                                                            @Html.AntiForgeryToken()
                                                            <button type="submit" class="dropdown-item"><i class="fas fa-eye-slash text-warning"></i> Sensible</button>
                                                        </form>
                                                    </li>
                                                }
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#transferirModal"
                                                            data-contentid="@contenido.Id" data-username="@(contenido.Usuario?.UserName ?? "?")">
                                                        <i class="fas fa-exchange-alt text-info"></i> Transferir
                                                    </button>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal"
                                                            data-bs-target="#eliminarModal" data-contentid="@contenido.Id">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                        <!-- Boton IA -->
                                        <button type="button" class="btn btn-sm btn-outline-primary flex-fill" onclick="reclasificarContenido(@contenido.Id)" title="IA">
                                            <i class="fas fa-robot" id="icon-reclasificar-@contenido.Id"></i>
                                        </button>
                                        <!-- Boton Ver -->
                                        <a href="/Feed/Perfil/@(contenido.Usuario?.UserName)?post=@contenido.Id" target="_blank"
                                           class="btn btn-sm btn-outline-dark flex-fill" title="Ver">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontro contenido</h5>
            </div>
        </div>
    }
</div>

<!-- Modal Censurar Individual -->
<div class="modal fade" id="censurarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-ban"></i> Censurar Contenido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formCensurar">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <select name="razon" class="form-select mb-3" required>
                        <option value="">Selecciona razon...</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Violacion de terminos">Violacion de terminos</option>
                        <option value="Spam">Spam</option>
                        <option value="Derechos de autor">Derechos de autor</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <textarea name="detalles" class="form-control" rows="2" placeholder="Detalles (opcional)"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Censurar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Individual -->
<div class="modal fade" id="eliminarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash"></i> Eliminar Contenido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formEliminar">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Esta accion es permanente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Censurar Masivo -->
<div class="modal fade" id="bulkCensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-ban"></i> Censurar Seleccionados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="@Url.Action("CensurarMasivo", "Admin")" id="formBulkCensor">
                @Html.AntiForgeryToken()
                <div id="bulkCensorIds"></div>
                <div class="modal-body">
                    <p>Se censuraran <strong id="bulkCensorCount">0</strong> contenidos.</p>
                    <select name="razon" class="form-select" required>
                        <option value="">Selecciona razon...</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Spam">Spam</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Censurar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Masivo -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash"></i> Eliminar Seleccionados</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="@Url.Action("EliminarMasivo", "Admin")" id="formBulkDelete">
                @Html.AntiForgeryToken()
                <div id="bulkDeleteIds"></div>
                <div class="modal-body">
                    <div class="alert alert-danger mb-0">
                        Se eliminaran <strong id="bulkDeleteCount">0</strong> contenidos permanentemente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form method="post" action="@Url.Action("DescensurarMasivo", "Admin")" id="formBulkUncensor" style="display: none;">
    @Html.AntiForgeryToken()
    <div id="bulkUncensorIds"></div>
</form>

<!-- Modal Transferir -->
<div class="modal fade" id="transferirModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Transferir</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formTransferir">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        <small>Propietario: <strong id="transferirUsuarioActual"></strong></small>
                    </div>
                    <input type="text" class="form-control mb-2" id="buscarUsuario" placeholder="Buscar usuario..." autocomplete="off">
                    <div id="resultadosUsuarios" class="list-group mb-2" style="max-height: 150px; overflow-y: auto; display: none;"></div>
                    <input type="hidden" name="nuevoUsuarioId" id="nuevoUsuarioId" required>
                    <div id="usuarioSeleccionado" class="alert alert-secondary py-2 mb-2">
                        <small>Ninguno seleccionado</small>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="cambiarTipoLado" name="cambiarTipoLado" value="true">
                        <label class="form-check-label small" for="cambiarTipoLado">Cambiar Lado A/B</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info" id="btnTransferir" disabled>Transferir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Reclasificar IA -->
<div class="modal fade" id="reclasificarTodoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-brain"></i> Clasificacion IA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <small>Costo: ~$0.001-0.003/imagen | Total: @Model.Count | Max: ~$@((Model.Count * 0.003m).ToString("F2"))</small>
                </div>
                <div id="reclasificarProgreso" style="display: none;">
                    <div class="progress mb-2"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div></div>
                    <p class="text-muted small text-center" id="reclasificarStatus">Iniciando...</p>
                </div>
                <div id="reclasificarResultado" style="display: none;">
                    <div class="alert alert-success mb-0"><ul class="mb-0 small" id="reclasificarStats"></ul></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarReclasificar">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnClasificarPendientes" onclick="clasificarPendientes()">Solo Pendientes</button>
                <button type="button" class="btn btn-danger" id="btnIniciarReclasificar" onclick="iniciarReclasificacionMasiva()">Reclasificar Todo</button>
            </div>
        </div>
    </div>
</div>

<script>
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    async function reclasificarContenido(id) {
        const icon = document.getElementById('icon-reclasificar-' + id);
        const cat = document.getElementById('categoria-' + id);
        icon.className = 'fas fa-spinner fa-spin';
        try {
            const r = await fetch('@Url.Action("ReclasificarContenido", "Admin")?id=' + id, { method: 'POST' });
            const d = await r.json();
            if (d.success) {
                cat.innerHTML = `<div class="d-flex align-items-center gap-1">
                    <span class="badge" style="background-color: ${d.categoriaColor}; font-size: 0.6rem;"><i class="${d.categoriaIcono}"></i></span>
                    <small class="text-truncate" style="color: ${d.categoriaColor}; font-size: 0.7rem;">${d.categoriaNombre}</small></div>`;
                icon.className = 'fas fa-check text-success';
            } else { icon.className = 'fas fa-times text-danger'; }
        } catch { icon.className = 'fas fa-times text-danger'; }
        setTimeout(() => icon.className = 'fas fa-robot', 2000);
    }

    document.getElementById('censurarModal').addEventListener('show.bs.modal', e => {
        document.getElementById('formCensurar').action = '/Admin/CensurarContenido/' + e.relatedTarget.getAttribute('data-contentid');
    });
    document.getElementById('eliminarModal').addEventListener('show.bs.modal', e => {
        document.getElementById('formEliminar').action = '/Admin/EliminarContenido/' + e.relatedTarget.getAttribute('data-contentid');
    });
    document.getElementById('transferirModal').addEventListener('show.bs.modal', e => {
        const id = e.relatedTarget.getAttribute('data-contentid');
        document.getElementById('transferirUsuarioActual').textContent = e.relatedTarget.getAttribute('data-username');
        document.getElementById('formTransferir').action = '/Admin/TransferirContenido/' + id;
        document.getElementById('buscarUsuario').value = '';
        document.getElementById('nuevoUsuarioId').value = '';
        document.getElementById('usuarioSeleccionado').innerHTML = '<small>Ninguno seleccionado</small>';
        document.getElementById('btnTransferir').disabled = true;
        document.getElementById('resultadosUsuarios').style.display = 'none';
    });

    let timeout = null;
    document.getElementById('buscarUsuario').addEventListener('input', function() {
        const q = this.value.trim();
        if (q.length < 2) { document.getElementById('resultadosUsuarios').style.display = 'none'; return; }
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            fetch('/Admin/BuscarUsuarios?q=' + encodeURIComponent(q)).then(r => r.json()).then(data => {
                const c = document.getElementById('resultadosUsuarios');
                c.innerHTML = data.length ? data.map(u => `<button type="button" class="list-group-item list-group-item-action py-1 small" onclick="seleccionarUsuario('${u.id}','${escapeHtml(u.userName)}')">${escapeHtml(u.userName)}</button>`).join('') : '<div class="list-group-item small text-muted">Sin resultados</div>';
                c.style.display = 'block';
            });
        }, 300);
    });

    function seleccionarUsuario(id, name) {
        document.getElementById('nuevoUsuarioId').value = id;
        document.getElementById('usuarioSeleccionado').innerHTML = '<small><strong>' + escapeHtml(name) + '</strong></small>';
        document.getElementById('btnTransferir').disabled = false;
        document.getElementById('resultadosUsuarios').style.display = 'none';
    }

    function getSelectedIds() { return Array.from(document.querySelectorAll('.content-checkbox:checked')).map(c => c.value); }
    function updateSelection() {
        const ids = getSelectedIds();
        document.getElementById('selectedCount').textContent = ids.length + ' seleccionado' + (ids.length !== 1 ? 's' : '');
        document.getElementById('bulkActionBar').style.display = ids.length > 0 ? 'block' : 'none';
        const all = document.querySelectorAll('.content-checkbox');
        const sa = document.getElementById('selectAll');
        sa.checked = ids.length === all.length && ids.length > 0;
        sa.indeterminate = ids.length > 0 && ids.length < all.length;
    }
    function toggleSelectAll(cb) { document.querySelectorAll('.content-checkbox').forEach(c => c.checked = cb.checked); updateSelection(); }
    function deselectAll() { document.querySelectorAll('.content-checkbox').forEach(c => c.checked = false); document.getElementById('selectAll').checked = false; updateSelection(); }

    function openBulkCensorModal() {
        const ids = getSelectedIds();
        if (!ids.length) return;
        document.getElementById('bulkCensorCount').textContent = ids.length;
        document.getElementById('bulkCensorIds').innerHTML = ids.map(id => `<input type="hidden" name="ids" value="${id}">`).join('');
        new bootstrap.Modal(document.getElementById('bulkCensorModal')).show();
    }
    function openBulkDeleteModal() {
        const ids = getSelectedIds();
        if (!ids.length) return;
        document.getElementById('bulkDeleteCount').textContent = ids.length;
        document.getElementById('bulkDeleteIds').innerHTML = ids.map(id => `<input type="hidden" name="ids" value="${id}">`).join('');
        new bootstrap.Modal(document.getElementById('bulkDeleteModal')).show();
    }
    function bulkUncensor() {
        const ids = getSelectedIds();
        if (!ids.length || !confirm('Descensurar ' + ids.length + ' contenido(s)?')) return;
        document.getElementById('bulkUncensorIds').innerHTML = ids.map(id => `<input type="hidden" name="ids" value="${id}">`).join('');
        document.getElementById('formBulkUncensor').submit();
    }

    let cancelado = false, totalOk = 0, totalErr = 0;
    async function iniciarReclasificacionMasiva() {
        const btnI = document.getElementById('btnIniciarReclasificar'), btnP = document.getElementById('btnClasificarPendientes');
        const btnC = document.getElementById('btnCancelarReclasificar'), prog = document.getElementById('reclasificarProgreso');
        const res = document.getElementById('reclasificarResultado'), bar = prog.querySelector('.progress-bar'), stat = document.getElementById('reclasificarStatus');
        cancelado = false; totalOk = totalErr = 0;
        btnI.disabled = btnP.disabled = true; prog.style.display = 'block'; res.style.display = 'none'; bar.style.width = '5%';
        btnC.textContent = 'Detener'; btnC.onclick = () => cancelado = true;
        try {
            const l = await (await fetch('@Url.Action("ReclasificarContenidoIA", "Admin")', { method: 'POST' })).json();
            if (!l.success) throw new Error(l.message);
            let pend = l.pendientes, total = pend; bar.style.width = '10%';
            while (pend > 0 && !cancelado) {
                const r = await (await fetch('@Url.Action("ReclasificarLoteIA", "Admin")', { method: 'POST' })).json();
                if (!r.success) throw new Error(r.message);
                totalOk += r.clasificados || 0; totalErr += r.errores || 0; pend = r.pendientes;
                bar.style.width = (total > 0 ? Math.round(((total - pend) / total) * 90) + 10 : 100) + '%';
                stat.textContent = `${totalOk} ok | ${totalErr} err | ${pend} pend`;
                if (r.terminado) break;
            }
            prog.style.display = 'none'; res.style.display = 'block';
            document.getElementById('reclasificarStats').innerHTML = `<li>Clasificados: ${totalOk}</li><li>Errores: ${totalErr}</li>`;
            btnC.textContent = 'Cerrar'; btnC.onclick = () => location.reload(); btnI.style.display = btnP.style.display = 'none';
        } catch (e) { stat.innerHTML = '<span class="text-danger">' + e.message + '</span>'; btnI.disabled = btnP.disabled = false; }
    }
    async function clasificarPendientes() {
        const btnI = document.getElementById('btnIniciarReclasificar'), btnP = document.getElementById('btnClasificarPendientes');
        const btnC = document.getElementById('btnCancelarReclasificar'), prog = document.getElementById('reclasificarProgreso');
        const res = document.getElementById('reclasificarResultado'), bar = prog.querySelector('.progress-bar'), stat = document.getElementById('reclasificarStatus');
        cancelado = false; totalOk = totalErr = 0;
        btnI.disabled = btnP.disabled = true; prog.style.display = 'block'; res.style.display = 'none';
        btnC.textContent = 'Detener'; btnC.onclick = () => cancelado = true;
        try {
            const e = await (await fetch('@Url.Action("EstadoClasificacionIA", "Admin")')).json();
            let pend = e.sinClasificar, total = pend;
            if (!pend) { stat.textContent = 'No hay pendientes'; btnC.textContent = 'Cerrar'; return; }
            while (pend > 0 && !cancelado) {
                const r = await (await fetch('@Url.Action("ReclasificarLoteIA", "Admin")', { method: 'POST' })).json();
                if (!r.success) throw new Error(r.message);
                totalOk += r.clasificados || 0; totalErr += r.errores || 0; pend = r.pendientes;
                bar.style.width = (total > 0 ? Math.round(((total - pend) / total) * 100) : 100) + '%';
                stat.textContent = `${totalOk} ok | ${pend} pend`;
                if (r.terminado) break;
            }
            prog.style.display = 'none'; res.style.display = 'block';
            document.getElementById('reclasificarStats').innerHTML = `<li>Clasificados: ${totalOk}</li><li>Errores: ${totalErr}</li>`;
            btnC.textContent = 'Cerrar'; btnC.onclick = () => location.reload(); btnI.style.display = btnP.style.display = 'none';
        } catch (e) { stat.innerHTML = '<span class="text-danger">' + e.message + '</span>'; btnI.disabled = btnP.disabled = false; }
    }
</script>

<style>
    .content-card { transition: transform 0.15s, box-shadow 0.15s; position: relative; z-index: 1; }
    .content-card:hover { transform: translateY(-2px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1) !important; }
    .content-card.dropdown-open { z-index: 1000 !important; transform: none; }
    .content-card .dropdown-menu { z-index: 1050; }
    #bulkActionBar { position: sticky; top: 56px; z-index: 100; }
    .dropdown-item { font-size: 0.8rem; padding: 0.35rem 0.75rem; }
    .dropdown-header { font-size: 0.7rem; padding: 0.25rem 0.75rem; }
    .btn-sm { padding: 0.2rem 0.5rem; font-size: 0.75rem; }
</style>

<script>
    // Manejar z-index del dropdown para que no se esconda detras de otras tarjetas
    document.addEventListener('show.bs.dropdown', function(e) {
        const card = e.target.closest('.content-card');
        if (card) card.classList.add('dropdown-open');
    });
    document.addEventListener('hide.bs.dropdown', function(e) {
        const card = e.target.closest('.content-card');
        if (card) card.classList.remove('dropdown-open');
    });
</script>
