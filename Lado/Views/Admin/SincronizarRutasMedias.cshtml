@{
    ViewData["Title"] = "Sincronizar Rutas de Medios";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var problemas = ViewBag.Problemas as List<(string tipo, int id, string rutaBD, string? rutaEncontrada, string estado)> ?? new();
}

@Html.AntiForgeryToken()

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Sincronizar Rutas de Medios</h1>
            <p class="text-muted mb-0">Reparar rutas en BD cuando archivos fueron convertidos pero la BD no se actualizo</p>
        </div>
        <a href="/Admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <!-- Resumen -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Analizados</h5>
                    <h2 class="mb-0">@(ViewBag.TotalContenidos + ViewBag.TotalArchivos + ViewBag.TotalStories)</h2>
                    <small class="text-muted">contenidos + archivos + stories</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm @(ViewBag.ConProblemas > 0 ? "border-warning" : "border-success")" style="border-left: 4px solid !important;">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Con Problemas</h5>
                    <h2 class="mb-0 @(ViewBag.ConProblemas > 0 ? "text-warning" : "text-success")">@ViewBag.ConProblemas</h2>
                    <small class="text-muted">rutas que no coinciden</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm border-success" style="border-left: 4px solid !important;">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Reparables</h5>
                    <h2 class="mb-0 text-success">@ViewBag.Reparables</h2>
                    <small class="text-muted">archivo convertido existe</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm border-danger" style="border-left: 4px solid !important;">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Huerfanos</h5>
                    <h2 class="mb-0 text-danger">@ViewBag.Huerfanos</h2>
                    <small class="text-muted">archivo no existe</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">Acciones</h5>
        </div>
        <div class="card-body">
            @if (ViewBag.ConProblemas == 0)
            {
                <div class="alert alert-success mb-0">
                    <i class="fas fa-check-circle"></i> Todas las rutas estan sincronizadas correctamente. No hay nada que reparar.
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>@ViewBag.Reparables</strong> rutas pueden repararse automaticamente (el archivo convertido existe).
                    <strong>@ViewBag.Huerfanos</strong> contenidos seran desactivados (el archivo no existe).
                </div>

                <button id="btnSincronizar" class="btn btn-primary btn-lg" onclick="ejecutarSincronizacion()">
                    <i class="fas fa-sync-alt"></i> Ejecutar Sincronizacion
                </button>

                <div id="resultado" class="mt-3" style="display: none;"></div>
            }
        </div>
    </div>

    <!-- Detalle de problemas -->
    @if (problemas.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Detalle de Problemas (@problemas.Count)</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="filtrarProblemas('todos')">Todos</button>
                    <button class="btn btn-outline-success" onclick="filtrarProblemas('reparable')">Reparables</button>
                    <button class="btn btn-outline-danger" onclick="filtrarProblemas('huerfano')">Huerfanos</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">Tipo</th>
                                <th style="width: 60px;">ID</th>
                                <th>Ruta en BD</th>
                                <th>Archivo Encontrado</th>
                                <th style="width: 100px;">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in problemas.Take(100))
                            {
                                var esReparable = p.estado == "convertido_existe";
                                <tr class="problema-row" data-tipo="@(esReparable ? "reparable" : "huerfano")">
                                    <td><span class="badge bg-secondary">@p.tipo</span></td>
                                    <td>@p.id</td>
                                    <td class="text-truncate" style="max-width: 300px;" title="@p.rutaBD">
                                        <code class="small text-danger">@p.rutaBD</code>
                                    </td>
                                    <td class="text-truncate" style="max-width: 300px;" title="@(p.rutaEncontrada ?? "-")">
                                        @if (esReparable)
                                        {
                                            <code class="small text-success">@p.rutaEncontrada</code>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (esReparable)
                                        {
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Reparable</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger"><i class="fas fa-times"></i> Huerfano</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (problemas.Count > 100)
                {
                    <div class="p-3 bg-light text-center">
                        <small class="text-muted">Mostrando 100 de @problemas.Count problemas</small>
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
    function ejecutarSincronizacion() {
        if (!confirm('Esto reparara @ViewBag.Reparables rutas y desactivara @ViewBag.Huerfanos contenidos huerfanos. Continuar?')) {
            return;
        }

        const btn = document.getElementById('btnSincronizar');
        const resultado = document.getElementById('resultado');
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

        fetch('/Admin/EjecutarSincronizacionRutas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `__RequestVerificationToken=${encodeURIComponent(token)}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                resultado.className = 'mt-3 alert alert-success';
                resultado.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
                btn.innerHTML = '<i class="fas fa-check"></i> Completado';

                // Recargar despues de 2 segundos
                setTimeout(() => location.reload(), 2000);
            } else {
                resultado.className = 'mt-3 alert alert-danger';
                resultado.innerHTML = `<i class="fas fa-times-circle"></i> ${data.message}`;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Reintentar';
            }
            resultado.style.display = 'block';
        })
        .catch(err => {
            resultado.className = 'mt-3 alert alert-danger';
            resultado.innerHTML = `<i class="fas fa-times-circle"></i> Error: ${err.message}`;
            resultado.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Reintentar';
        });
    }

    function filtrarProblemas(tipo) {
        const rows = document.querySelectorAll('.problema-row');
        rows.forEach(row => {
            if (tipo === 'todos' || row.dataset.tipo === tipo) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Actualizar botones activos
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
</script>
}
