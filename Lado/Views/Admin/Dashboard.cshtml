@model Lado.Services.DashboardMetrics
@{
    ViewData["Title"] = "Dashboard Analytics";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-graph-up-arrow me-2"></i>Dashboard Analytics</h2>
            <small class="text-muted">Última actualización: @Model.FechaActualizacion.ToString("dd/MM/yyyy HH:mm")</small>
        </div>
        <div class="d-flex gap-2">
            <select id="periodoGraficos" class="form-select form-select-sm" style="width: auto;" onchange="cambiarPeriodo()">
                <option value="7">Últimos 7 días</option>
                <option value="14">Últimos 14 días</option>
                <option value="30" selected>Últimos 30 días</option>
                <option value="90">Últimos 90 días</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="actualizarDatos()">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
            </button>
        </div>
    </div>

    <!-- KPIs principales -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Usuarios Totales</h6>
                            <h2 class="mb-0" id="kpiUsuarios">@Model.TotalUsuarios.ToString("N0")</h2>
                            <small><i class="bi bi-arrow-up"></i> +@Model.UsuariosNuevos24h hoy</small>
                        </div>
                        <i class="bi bi-people fs-1 text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Ingresos del Mes</h6>
                            <h2 class="mb-0" id="kpiIngresos">$@Model.IngresosMes.ToString("N0")</h2>
                            <small><i class="bi bi-arrow-up"></i> $@Model.IngresosHoy.ToString("N0") hoy</small>
                        </div>
                        <i class="bi bi-currency-dollar fs-1 text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Contenidos</h6>
                            <h2 class="mb-0" id="kpiContenidos">@Model.TotalContenidos.ToString("N0")</h2>
                            <small><i class="bi bi-arrow-up"></i> +@Model.ContenidosHoy hoy</small>
                        </div>
                        <i class="bi bi-images fs-1 text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-dark-50 mb-1">Suscripciones Activas</h6>
                            <h2 class="mb-0" id="kpiSuscripciones">@Model.TotalSuscripciones.ToString("N0")</h2>
                            <small><i class="bi bi-arrow-up"></i> +@Model.SuscripcionesNuevasMes este mes</small>
                        </div>
                        <i class="bi bi-credit-card fs-1 text-dark opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos principales -->
    <div class="row g-4 mb-4">
        <!-- Gráfico de tendencias -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Tendencias</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="cambiarTipoGrafico('usuarios', this)">Usuarios</button>
                        <button type="button" class="btn btn-outline-primary" onclick="cambiarTipoGrafico('contenidos', this)">Contenidos</button>
                        <button type="button" class="btn btn-outline-primary" onclick="cambiarTipoGrafico('ingresos', this)">Ingresos</button>
                        <button type="button" class="btn btn-outline-primary" onclick="cambiarTipoGrafico('suscripciones', this)">Suscripciones</button>
                    </div>
                </div>
                <div class="card-body" style="height: 320px;">
                    <canvas id="chartTendencias"></canvas>
                </div>
            </div>
        </div>

        <!-- Estadísticas de engagement -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-heart me-2"></i>Engagement</h5>
                </div>
                <div class="card-body">
                    <div style="height: 200px;">
                        <canvas id="chartEngagement"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-heart-fill text-danger me-2"></i>Likes Hoy</span>
                            <strong>@Model.LikesHoy.ToString("N0")</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-chat-fill text-primary me-2"></i>Comentarios Hoy</span>
                            <strong>@Model.ComentariosHoy.ToString("N0")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-play-circle-fill text-info me-2"></i>Stories Activas</span>
                            <strong>@Model.StoriesActivas.ToString("N0")</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda fila de métricas -->
    <div class="row g-4 mb-4">
        <!-- Creadores -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Creadores</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h3 class="mb-0 text-primary">@Model.TotalCreadores.ToString("N0")</h3>
                            <small class="text-muted">Total Creadores</small>
                        </div>
                        <div class="col-6">
                            <h3 class="mb-0 text-success">@Model.CreadoresVerificados.ToString("N0")</h3>
                            <small class="text-muted">Verificados</small>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 25px;">
                        @{
                            var porcentajeVerificados = Model.TotalCreadores > 0 ? (Model.CreadoresVerificados * 100.0 / Model.TotalCreadores) : 0;
                        }
                        <div class="progress-bar bg-success" style="width: @porcentajeVerificados.ToString("F1")%">
                            @porcentajeVerificados.ToString("F1")% verificados
                        </div>
                    </div>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-plus-circle me-1"></i>@Model.CreadoresNuevosMes nuevos creadores este mes
                    </p>
                </div>
            </div>
        </div>

        <!-- Moderación -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Moderación</h5>
                    <a href="/Admin/Reportes" class="btn btn-sm btn-outline-primary">Ver todos</a>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Reportes Pendientes</span>
                        <span class="badge @(Model.ReportesPendientes > 10 ? "bg-danger" : Model.ReportesPendientes > 0 ? "bg-warning text-dark" : "bg-success") fs-6">
                            @Model.ReportesPendientes
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Cola Moderación</span>
                        <span class="badge @(Model.ColaModeraciónPendiente > 20 ? "bg-danger" : Model.ColaModeraciónPendiente > 0 ? "bg-warning text-dark" : "bg-success") fs-6">
                            @Model.ColaModeraciónPendiente
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Apelaciones Pendientes</span>
                        <span class="badge @(Model.ApelacionesPendientes > 0 ? "bg-warning text-dark" : "bg-success") fs-6">
                            @Model.ApelacionesPendientes
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Resueltos (7 días)</span>
                        <span class="badge bg-info fs-6">@Model.ReportesResueltos7d</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finanzas -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Finanzas</h5>
                    <a href="/Admin/Retiros" class="btn btn-sm btn-outline-primary">Ver retiros</a>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Retiros Pendientes</span>
                        <span class="badge @(Model.RetirosPendientes > 5 ? "bg-danger" : Model.RetirosPendientes > 0 ? "bg-warning text-dark" : "bg-success") fs-6">
                            @Model.RetirosPendientes
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Monto Pendiente</span>
                        <strong class="text-danger">$@Model.MontoRetirosPendientes.ToString("N0")</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Tips Hoy</span>
                        <strong>@Model.TipsHoy ($@Model.MontoTipsHoy.ToString("N0"))</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Tips Totales</span>
                        <strong>@Model.TotalTips.ToString("N0")</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera fila: Actividad y Seguridad -->
    <div class="row g-4">
        <!-- Actividad de usuarios -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Actividad de Usuarios</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-3 rounded bg-light">
                                <h4 class="mb-0 text-success">@Model.UsuariosActivos24h.ToString("N0")</h4>
                                <small class="text-muted">Activos 24h</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded bg-light">
                                <h4 class="mb-0 text-primary">@Model.UsuariosActivos7d.ToString("N0")</h4>
                                <small class="text-muted">Activos 7 días</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded bg-light">
                                <h4 class="mb-0 text-info">@Model.UsuariosNuevosMes.ToString("N0")</h4>
                                <small class="text-muted">Nuevos (mes)</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4" style="height: 150px;">
                        <canvas id="chartActividad"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seguridad -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Seguridad</h5>
                    <a href="/Admin/IpsBloqueadas" class="btn btn-sm btn-outline-danger">Ver IPs</a>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="p-3 border rounded @(Model.IntentosAtaque24h > 10 ? "border-danger bg-danger bg-opacity-10" : "")">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle fs-2 @(Model.IntentosAtaque24h > 10 ? "text-danger" : "text-warning") me-3"></i>
                                    <div>
                                        <h4 class="mb-0">@Model.IntentosAtaque24h</h4>
                                        <small class="text-muted">Intentos de ataque (24h)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-ban fs-2 text-danger me-3"></i>
                                    <div>
                                        <h4 class="mb-0">@Model.IpsBloqueadas</h4>
                                        <small class="text-muted">IPs Bloqueadas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-x fs-2 text-warning me-3"></i>
                                    <div>
                                        <h4 class="mb-0">@Model.UsuariosSuspendidos</h4>
                                        <small class="text-muted">Usuarios Suspendidos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-patch-check fs-2 text-info me-3"></i>
                                    <div>
                                        <h4 class="mb-0">@Model.VerificacionesPendientes</h4>
                                        <small class="text-muted">Verificaciones Pendientes</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartTendencias, chartEngagement, chartActividad;
        let tipoActual = 'usuarios';
        let periodoActual = 30;

        // Inicializar gráficos
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            cargarDatosGraficos();
        });

        function initCharts() {
            // Gráfico de tendencias
            const ctxTendencias = document.getElementById('chartTendencias').getContext('2d');
            chartTendencias = new Chart(ctxTendencias, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Usuarios',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico de engagement (doughnut)
            const ctxEngagement = document.getElementById('chartEngagement').getContext('2d');
            chartEngagement = new Chart(ctxEngagement, {
                type: 'doughnut',
                data: {
                    labels: ['Likes', 'Comentarios', 'Stories'],
                    datasets: [{
                        data: [@Model.TotalLikes, @Model.TotalComentarios, @Model.StoriesActivas],
                        backgroundColor: ['#dc3545', '#0d6efd', '#0dcaf0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gráfico de actividad
            const ctxActividad = document.getElementById('chartActividad').getContext('2d');
            chartActividad = new Chart(ctxActividad, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nuevos usuarios',
                        data: [],
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function cargarDatosGraficos() {
            try {
                const response = await fetch(`/Admin/ObtenerSerieTemporal?tipo=${tipoActual}&dias=${periodoActual}`);
                const result = await response.json();

                if (result.success) {
                    const labels = result.data.map(d => d.label);
                    const valores = result.data.map(d => d.valor);

                    chartTendencias.data.labels = labels;
                    chartTendencias.data.datasets[0].data = valores;
                    chartTendencias.data.datasets[0].label = tipoActual.charAt(0).toUpperCase() + tipoActual.slice(1);

                    // Colores según tipo
                    const colores = {
                        usuarios: { border: '#0d6efd', bg: 'rgba(13, 110, 253, 0.1)' },
                        contenidos: { border: '#0dcaf0', bg: 'rgba(13, 202, 240, 0.1)' },
                        ingresos: { border: '#198754', bg: 'rgba(25, 135, 84, 0.1)' },
                        suscripciones: { border: '#ffc107', bg: 'rgba(255, 193, 7, 0.1)' }
                    };
                    chartTendencias.data.datasets[0].borderColor = colores[tipoActual]?.border || '#0d6efd';
                    chartTendencias.data.datasets[0].backgroundColor = colores[tipoActual]?.bg || 'rgba(13, 110, 253, 0.1)';

                    chartTendencias.update();

                    // Cargar datos para gráfico de actividad
                    const resUsuarios = await fetch(`/Admin/ObtenerSerieTemporal?tipo=usuarios&dias=7`);
                    const dataUsuarios = await resUsuarios.json();
                    if (dataUsuarios.success) {
                        chartActividad.data.labels = dataUsuarios.data.map(d => d.label);
                        chartActividad.data.datasets[0].data = dataUsuarios.data.map(d => d.valor);
                        chartActividad.update();
                    }
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        function cambiarTipoGrafico(tipo, btn) {
            tipoActual = tipo;
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            cargarDatosGraficos();
        }

        function cambiarPeriodo() {
            periodoActual = parseInt(document.getElementById('periodoGraficos').value);
            cargarDatosGraficos();
        }

        async function actualizarDatos() {
            try {
                const response = await fetch('/Admin/ObtenerMetricasDashboard');
                const result = await response.json();

                if (result.success) {
                    // Actualizar KPIs
                    document.getElementById('kpiUsuarios').textContent = result.data.totalUsuarios.toLocaleString();
                    document.getElementById('kpiIngresos').textContent = '$' + result.data.ingresosMes.toLocaleString();
                    document.getElementById('kpiContenidos').textContent = result.data.totalContenidos.toLocaleString();
                    document.getElementById('kpiSuscripciones').textContent = result.data.totalSuscripciones.toLocaleString();

                    // Recargar gráficos
                    cargarDatosGraficos();

                    // Toast de éxito
                    mostrarToast('success', 'Datos actualizados');
                }
            } catch (error) {
                mostrarToast('danger', 'Error al actualizar');
            }
        }

        function mostrarToast(type, message) {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1100';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-warning';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass}" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        }

        // Auto-actualización cada 5 minutos
        setInterval(actualizarDatos, 300000);
    </script>
}
