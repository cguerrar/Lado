@model List<Lado.Models.LogEvento>
@{
    ViewData["Title"] = "Probar Emails";
    Layout = "_AdminLayout";
}

<style>
    .email-test-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 28px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .config-status {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
    }

    .config-status.success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .config-status.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .config-status .icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .config-status.success .icon {
        background: var(--success);
        color: white;
    }

    .config-status.error .icon {
        background: var(--danger);
        color: white;
    }

    .config-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .config-item {
        background: var(--bg-light);
        padding: 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .config-item label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .config-item .value {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .config-item .value.ok {
        color: var(--success);
    }

    .config-item .value.error {
        color: var(--danger);
    }

    .test-form {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 16px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        font-family: inherit;
        background: var(--bg-white);
        transition: all var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-pale);
    }

    .btn-send {
        padding: 12px 24px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-primary);
    }

    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(70, 130, 180, 0.45);
    }

    .email-types {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 20px;
    }

    .email-type-card {
        background: var(--bg-light);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 16px;
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
    }

    .email-type-card:hover {
        border-color: var(--primary);
        background: var(--primary-pale);
    }

    .email-type-card.selected {
        border-color: var(--primary);
        background: var(--primary-pale);
    }

    .email-type-card input[type="radio"] {
        display: none;
    }

    .email-type-card .icon {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .email-type-card .name {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.875rem;
    }

    .email-type-card .desc {
        font-size: 0.75rem;
        color: var(--text-gray);
        margin-top: 4px;
    }

    .logs-section {
        margin-top: 32px;
    }

    .logs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .logs-header h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--bg-white);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .logs-table th,
    .logs-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .logs-table th {
        background: var(--bg-light);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-gray);
    }

    .logs-table td {
        font-size: 0.875rem;
        color: var(--text-dark);
    }

    .logs-table tr:last-child td {
        border-bottom: none;
    }

    .logs-table tr:hover {
        background: var(--bg-light);
    }

    .log-type {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .log-type.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .log-type.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .log-type.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .log-message {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .log-date {
        font-size: 0.8rem;
        color: var(--text-gray);
        white-space: nowrap;
    }

    .empty-logs {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }

    .empty-logs i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    @@media (max-width: 768px) {
        .test-form {
            grid-template-columns: 1fr;
        }

        .config-details {
            grid-template-columns: 1fr;
        }

        .email-types {
            grid-template-columns: repeat(2, 1fr);
        }

        .logs-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>

<div class="email-test-card">
    <h2 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700;">
        <i class="fas fa-envelope" style="color: var(--primary); margin-right: 10px;"></i>
        Configuracion de Mailjet
    </h2>

    <div class="config-status @(ViewBag.MailjetConfigurado ? "success" : "error")">
        <div class="icon">
            <i class="fas @(ViewBag.MailjetConfigurado ? "fa-check" : "fa-times")"></i>
        </div>
        <div>
            <strong>@(ViewBag.MailjetConfigurado ? "Mailjet Configurado" : "Mailjet No Configurado")</strong>
            <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.8;">
                @(ViewBag.MailjetConfigurado ? "Las credenciales de API estan presentes en la configuracion." : "Faltan las credenciales de API. Revisa appsettings.json o las variables de entorno.")
            </p>
        </div>
    </div>

    <div class="config-details">
        <div class="config-item">
            <label>API Key</label>
            <span class="value @(ViewBag.ApiKeyPresente ? "ok" : "error")">
                @(ViewBag.ApiKeyPresente ? "Configurada" : "No configurada")
            </span>
        </div>
        <div class="config-item">
            <label>Secret Key</label>
            <span class="value @(ViewBag.SecretKeyPresente ? "ok" : "error")">
                @(ViewBag.SecretKeyPresente ? "Configurada" : "No configurada")
            </span>
        </div>
        <div class="config-item">
            <label>Email Remitente</label>
            <span class="value">@ViewBag.FromEmail</span>
        </div>
        <div class="config-item">
            <label>Nombre Remitente</label>
            <span class="value">@ViewBag.FromName</span>
        </div>
    </div>
</div>

<div class="email-test-card">
    <h2 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700;">
        <i class="fas fa-paper-plane" style="color: var(--primary); margin-right: 10px;"></i>
        Enviar Email de Prueba
    </h2>

    <form asp-action="EnviarEmailPrueba" method="post" id="emailTestForm">
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="destinatario">Email Destinatario</label>
            <input type="email" id="destinatario" name="destinatario"
                   placeholder="correo@ejemplo.com" required
                   style="max-width: 400px;">
        </div>

        <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-dark); margin-bottom: 12px; display: block;">
            Tipo de Email
        </label>

        <div class="email-types">
            <label class="email-type-card selected">
                <input type="radio" name="tipoEmail" value="simple" checked>
                <div class="icon"><i class="fas fa-envelope"></i></div>
                <div class="name">Simple</div>
                <div class="desc">Email basico de prueba</div>
            </label>

            <label class="email-type-card">
                <input type="radio" name="tipoEmail" value="confirmacion">
                <div class="icon"><i class="fas fa-check-circle"></i></div>
                <div class="name">Confirmacion</div>
                <div class="desc">Confirmar cuenta</div>
            </label>

            <label class="email-type-card">
                <input type="radio" name="tipoEmail" value="recuperar">
                <div class="icon"><i class="fas fa-key"></i></div>
                <div class="name">Recuperar</div>
                <div class="desc">Reset de password</div>
            </label>

            <label class="email-type-card">
                <input type="radio" name="tipoEmail" value="bienvenida">
                <div class="icon"><i class="fas fa-hand-wave"></i></div>
                <div class="name">Bienvenida</div>
                <div class="desc">Usuario nuevo</div>
            </label>

            <label class="email-type-card">
                <input type="radio" name="tipoEmail" value="suscriptor">
                <div class="icon"><i class="fas fa-user-plus"></i></div>
                <div class="name">Suscriptor</div>
                <div class="desc">Nuevo suscriptor</div>
            </label>

            <label class="email-type-card">
                <input type="radio" name="tipoEmail" value="pago">
                <div class="icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="name">Pago</div>
                <div class="desc">Pago recibido</div>
            </label>
        </div>

        <div style="margin-top: 24px;">
            <button type="submit" class="btn-send">
                <i class="fas fa-paper-plane"></i>
                Enviar Email de Prueba
            </button>
        </div>
    </form>
</div>

@if (TempData["ErrorDetails"] != null)
{
    <div class="email-test-card" style="border-left: 4px solid var(--danger);">
        <h2 style="margin: 0 0 16px 0; font-size: 1.125rem; font-weight: 700; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
            Detalles del Error de Mailjet
        </h2>
        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto;">@TempData["ErrorDetails"]</div>
        <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.875rem; color: var(--text-dark);">
                <i class="fas fa-lightbulb" style="color: #f59e0b; margin-right: 8px;"></i>
                <strong>Posibles soluciones:</strong>
            </p>
            <ul style="margin: 8px 0 0 20px; font-size: 0.85rem; color: var(--text-gray);">
                <li>Verifica que el remitente (<code>@ViewBag.FromEmail</code>) este verificado en Mailjet</li>
                <li>Revisa que las API Keys sean correctas y esten activas</li>
                <li>Confirma que el dominio tenga los registros DNS (SPF, DKIM) configurados</li>
                <li>Verifica que no hayas excedido el limite de envios de tu plan</li>
            </ul>
        </div>
    </div>
}

<div class="email-test-card logs-section">
    <div class="logs-header">
        <h3>
            <i class="fas fa-history" style="color: var(--primary); margin-right: 10px;"></i>
            Historial de Emails (ultimos 50 logs)
        </h3>
        <a href="@Url.Action("Logs")" class="btn btn-outline-primary" style="font-size: 0.8rem; padding: 8px 16px;">
            Ver todos los logs
        </a>
    </div>

    @if (Model != null && Model.Any())
    {
        <table class="logs-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Mensaje</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in Model)
                {
                    <tr>
                        <td class="log-date">@log.Fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</td>
                        <td>
                            <span class="log-type @(log.Tipo == Lado.Models.TipoLogEvento.Error ? "error" : log.Tipo == Lado.Models.TipoLogEvento.Warning ? "warning" : "info")">
                                @if (log.Tipo == Lado.Models.TipoLogEvento.Error)
                                {
                                    <i class="fas fa-times-circle"></i>
                                }
                                else if (log.Tipo == Lado.Models.TipoLogEvento.Warning)
                                {
                                    <i class="fas fa-exclamation-triangle"></i>
                                }
                                else
                                {
                                    <i class="fas fa-info-circle"></i>
                                }
                                @log.Tipo.ToString()
                            </span>
                        </td>
                        <td class="log-message" title="@log.Mensaje">@log.Mensaje</td>
                        <td>@(log.UsuarioNombre ?? "-")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-logs">
            <i class="fas fa-inbox"></i>
            <p>No hay logs de email disponibles.</p>
            <p style="font-size: 0.85rem;">Los logs apareceran aqui despues de enviar emails de prueba.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Manejar seleccion de tipo de email
        document.querySelectorAll('.email-type-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.email-type-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // Feedback al enviar
        document.getElementById('emailTestForm').addEventListener('submit', function(e) {
            const btn = this.querySelector('.btn-send');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;
        });
    </script>
}
