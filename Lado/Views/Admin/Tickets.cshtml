@using Lado.Models
@{
    ViewData["Title"] = "Tickets Internos";
    Layout = "_AdminLayout";
    var tickets = ViewBag.Tickets as List<TicketInterno>;
    var stats = ViewBag.Stats as Dictionary<string, int>;
    var admins = ViewBag.Admins;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Tickets Internos</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTicket" onclick="nuevoTicket()">
            <i class="bi bi-plus-lg me-1"></i>Nuevo Ticket
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3">
                <h3 class="mb-0 text-primary">@stats["total"]</h3>
                <small class="text-muted">Total</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3 @(stats["abiertos"] > 0 ? "bg-warning bg-opacity-10" : "")">
                <h3 class="mb-0 text-warning">@stats["abiertos"]</h3>
                <small class="text-muted">Abiertos</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3">
                <h3 class="mb-0 text-info">@stats["enProgreso"]</h3>
                <small class="text-muted">En Progreso</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3">
                <h3 class="mb-0 text-secondary">@stats["enEspera"]</h3>
                <small class="text-muted">En Espera</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3">
                <h3 class="mb-0 text-success">@stats["resueltos"]</h3>
                <small class="text-muted">Resueltos</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center py-3 @(stats["criticos"] > 0 ? "bg-danger bg-opacity-10" : "")">
                <h3 class="mb-0 text-danger">@stats["criticos"]</h3>
                <small class="text-muted">Criticos</small>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-3">
                    @{
                        var estadoFiltro = ViewBag.EstadoFiltro != null ? (int)ViewBag.EstadoFiltro : -1;
                    }
                    <select id="filtroEstado" class="form-select form-select-sm" onchange="filtrar()">
                        <option value="">Todos los estados</option>
                        <option value="0" selected="@(estadoFiltro == 0)">Abierto</option>
                        <option value="1" selected="@(estadoFiltro == 1)">En Progreso</option>
                        <option value="2" selected="@(estadoFiltro == 2)">En Espera</option>
                        <option value="3" selected="@(estadoFiltro == 3)">Resuelto</option>
                        <option value="4" selected="@(estadoFiltro == 4)">Cerrado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filtroCategoria" class="form-select form-select-sm" onchange="filtrar()">
                        <option value="">Todas las categorias</option>
                        <option value="0">General</option>
                        <option value="1">Tecnico</option>
                        <option value="2">Moderacion</option>
                        <option value="3">Finanzas</option>
                        <option value="4">Legal</option>
                        <option value="5">Sugerencia</option>
                        <option value="6">Bug</option>
                        <option value="7">Urgente</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" id="busqueda" class="form-control form-control-sm" placeholder="Buscar...">
                </div>
                <div class="col-md-3 text-end">
                    <span class="text-muted small">@ViewBag.Total tickets encontrados</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Tickets -->
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="60">#</th>
                        <th>Titulo</th>
                        <th width="120">Categoria</th>
                        <th width="100">Prioridad</th>
                        <th width="110">Estado</th>
                        <th width="130">Asignado a</th>
                        <th width="120">Fecha</th>
                        <th width="80">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (tickets?.Any() == true)
                    {
                        @foreach (var ticket in tickets)
                        {
                            <tr class="ticket-row" data-id="@ticket.Id">
                                <td><strong>@ticket.Id</strong></td>
                                <td>
                                    <a href="/Admin/DetalleTicket?id=@ticket.Id" class="text-decoration-none">
                                        @ticket.Titulo
                                    </a>
                                    @if (!string.IsNullOrEmpty(ticket.Etiquetas))
                                    {
                                        <div class="mt-1">
                                            @foreach (var etiqueta in ticket.Etiquetas.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                            {
                                                <span class="badge bg-light text-dark me-1">@etiqueta.Trim()</span>
                                            }
                                        </div>
                                    }
                                </td>
                                <td>
                                    <span class="badge @GetCategoriaBadge(ticket.Categoria)">@ticket.Categoria</span>
                                </td>
                                <td>
                                    <span class="badge @GetPrioridadBadge(ticket.Prioridad)">@ticket.Prioridad</span>
                                </td>
                                <td>
                                    <span class="badge @GetEstadoBadge(ticket.Estado)">@ticket.Estado</span>
                                </td>
                                <td>
                                    @if (ticket.AsignadoA != null)
                                    {
                                        <span class="text-truncate d-block" style="max-width: 120px;">@ticket.AsignadoA.UserName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Sin asignar</span>
                                    }
                                </td>
                                <td>
                                    <small>@ticket.FechaCreacion.ToString("dd/MM/yyyy")</small>
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="/Admin/DetalleTicket?id=@ticket.Id"><i class="bi bi-eye me-2"></i>Ver</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="asignarTicket(@ticket.Id); return false;"><i class="bi bi-person-plus me-2"></i>Asignar</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-success" href="#" onclick="cambiarEstado(@ticket.Id, 3); return false;"><i class="bi bi-check-circle me-2"></i>Resolver</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="cambiarEstado(@ticket.Id, 4); return false;"><i class="bi bi-x-circle me-2"></i>Cerrar</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <i class="bi bi-ticket fs-1 text-muted d-block mb-2"></i>
                                <p class="text-muted">No hay tickets</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginacion -->
    @if (ViewBag.TotalPaginas > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPaginas; i++)
                {
                    <li class="page-item @(i == ViewBag.Pagina ? "active" : "")">
                        <a class="page-link" href="?pagina=@i&estado=@ViewBag.EstadoFiltro&categoria=@ViewBag.CategoriaFiltro">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<!-- Modal Nuevo/Editar Ticket -->
<div class="modal fade" id="modalTicket" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTicketTitle"><i class="bi bi-ticket me-2"></i>Nuevo Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ticketId">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Titulo <span class="text-danger">*</span></label>
                        <input type="text" id="ticketTitulo" class="form-control" maxlength="200" placeholder="Describe brevemente el problema o solicitud">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Categoria</label>
                        <select id="ticketCategoria" class="form-select">
                            <option value="0">General</option>
                            <option value="1">Tecnico</option>
                            <option value="2">Moderacion</option>
                            <option value="3">Finanzas</option>
                            <option value="4">Legal</option>
                            <option value="5">Sugerencia</option>
                            <option value="6">Bug</option>
                            <option value="7">Urgente</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Prioridad</label>
                        <select id="ticketPrioridad" class="form-select">
                            <option value="0">Baja</option>
                            <option value="1" selected>Normal</option>
                            <option value="2">Alta</option>
                            <option value="3">Critica</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Asignar a</label>
                        <select id="ticketAsignado" class="form-select">
                            <option value="">Sin asignar</option>
                            @foreach (var admin in (IEnumerable<dynamic>)admins)
                            {
                                <option value="@admin.Id">@admin.UserName</option>
                            }
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Descripcion <span class="text-danger">*</span></label>
                        <textarea id="ticketDescripcion" class="form-control" rows="5" placeholder="Describe el problema en detalle..."></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Etiquetas</label>
                        <input type="text" id="ticketEtiquetas" class="form-control" placeholder="Separadas por coma (ej: urgente, pagos, bug)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarTicket()">
                    <i class="bi bi-check-lg me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Asignar -->
<div class="modal fade" id="modalAsignar" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="asignarTicketId">
                <select id="asignarUsuario" class="form-select">
                    <option value="">Sin asignar</option>
                    @foreach (var admin in (IEnumerable<dynamic>)admins)
                    {
                        <option value="@admin.Id">@admin.UserName</option>
                    }
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarAsignacion()">Asignar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value ||
                      document.querySelector('meta[name="csrf-token"]')?.content;

        function nuevoTicket() {
            document.getElementById('modalTicketTitle').innerHTML = '<i class="bi bi-ticket me-2"></i>Nuevo Ticket';
            document.getElementById('ticketId').value = '';
            document.getElementById('ticketTitulo').value = '';
            document.getElementById('ticketCategoria').value = '0';
            document.getElementById('ticketPrioridad').value = '1';
            document.getElementById('ticketAsignado').value = '';
            document.getElementById('ticketDescripcion').value = '';
            document.getElementById('ticketEtiquetas').value = '';
        }

        async function guardarTicket() {
            const id = document.getElementById('ticketId').value;
            const data = {
                id: id ? parseInt(id) : 0,
                titulo: document.getElementById('ticketTitulo').value,
                descripcion: document.getElementById('ticketDescripcion').value,
                categoria: parseInt(document.getElementById('ticketCategoria').value),
                prioridad: parseInt(document.getElementById('ticketPrioridad').value),
                asignadoAId: document.getElementById('ticketAsignado').value || null,
                etiquetas: document.getElementById('ticketEtiquetas').value || null
            };

            if (!data.titulo || !data.descripcion) {
                showToast('Titulo y descripcion son requeridos', 'warning');
                return;
            }

            try {
                const url = id ? '/Admin/ActualizarTicket' : '/Admin/CrearTicket';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    showToast(result.mensaje, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalTicket')).hide();
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error al guardar', 'error');
            }
        }

        function asignarTicket(id) {
            document.getElementById('asignarTicketId').value = id;
            new bootstrap.Modal(document.getElementById('modalAsignar')).show();
        }

        async function confirmarAsignacion() {
            const id = document.getElementById('asignarTicketId').value;
            const asignadoAId = document.getElementById('asignarUsuario').value;

            try {
                const formData = new FormData();
                formData.append('id', id);
                formData.append('asignadoAId', asignadoAId);

                const response = await fetch('/Admin/AsignarTicket', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast(result.mensaje, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide();
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error al asignar', 'error');
            }
        }

        async function cambiarEstado(id, estado) {
            const estados = ['Abrir', 'En Progreso', 'En Espera', 'Resolver', 'Cerrar'];
            if (!confirm(`Â¿${estados[estado]} el ticket #${id}?`)) return;

            try {
                const formData = new FormData();
                formData.append('id', id);
                formData.append('estado', estado);

                const response = await fetch('/Admin/CambiarEstadoTicket', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast(result.mensaje, 'success');
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error al cambiar estado', 'error');
            }
        }

        function filtrar() {
            const estado = document.getElementById('filtroEstado').value;
            const categoria = document.getElementById('filtroCategoria').value;

            let url = '/Admin/Tickets?';
            if (estado) url += `estado=${estado}&`;
            if (categoria) url += `categoria=${categoria}`;

            window.location.href = url;
        }
    </script>
}

@functions {
    string GetCategoriaBadge(CategoriaTicket categoria)
    {
        return categoria switch
        {
            CategoriaTicket.Tecnico => "bg-info",
            CategoriaTicket.Moderacion => "bg-primary",
            CategoriaTicket.Finanzas => "bg-success",
            CategoriaTicket.Legal => "bg-dark",
            CategoriaTicket.Bug => "bg-danger",
            CategoriaTicket.Urgente => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetPrioridadBadge(PrioridadTicket prioridad)
    {
        return prioridad switch
        {
            PrioridadTicket.Baja => "bg-secondary",
            PrioridadTicket.Normal => "bg-info",
            PrioridadTicket.Alta => "bg-warning text-dark",
            PrioridadTicket.Critica => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetEstadoBadge(EstadoTicket estado)
    {
        return estado switch
        {
            EstadoTicket.Abierto => "bg-warning text-dark",
            EstadoTicket.EnProgreso => "bg-info",
            EstadoTicket.EnEspera => "bg-secondary",
            EstadoTicket.Resuelto => "bg-success",
            EstadoTicket.Cerrado => "bg-dark",
            _ => "bg-secondary"
        };
    }
}
