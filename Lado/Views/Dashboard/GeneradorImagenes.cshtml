@{
    ViewData["Title"] = "Editor de Imagenes";
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Lado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&family=Montserrat:wght@700;900&family=Bebas+Neue&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* Tema Oscuro (default) */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --accent: #a78bfa;
            --bg: #0f0f14;
            --bg-secondary: #18181f;
            --surface: #1e1e28;
            --surface-hover: #282836;
            --border: #2e2e3a;
            --fg: #f8fafc;
            --fg-secondary: #94a3b8;
            --muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }

        /* Tema Claro */
        [data-theme="light"] {
            --bg: #f8fafc;
            --bg-secondary: #ffffff;
            --surface: #f1f5f9;
            --surface-hover: #e2e8f0;
            --border: #e2e8f0;
            --fg: #1e293b;
            --fg-secondary: #475569;
            --muted: #94a3b8;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --glow: 0 0 20px rgba(99, 102, 241, 0.1);
        }

        [data-theme="light"] .canvas-wrapper {
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
        }

        [data-theme="light"] .canvas-frame {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            overflow: hidden;
        }

        /* ========== LAYOUT PRINCIPAL ========== */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn-back {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--fg);
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
        }

        .editor-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            transition: all 0.2s;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--fg);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.35);
        }

        /* Body */
        .editor-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== SIDEBAR ========== */
        .editor-sidebar {
            width: 76px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 16px 0;
            gap: 4px;
        }

        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 8px;
            margin: 0 8px;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.2s ease;
            border: none;
            background: none;
            gap: 6px;
            border-radius: 12px;
            position: relative;
        }

        .tool-btn:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tool-btn.active {
            color: white;
            background: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }

        .tool-btn.active::before {
            display: none;
        }

        .tool-btn i {
            font-size: 1.3rem;
        }

        .tool-btn span {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========== PANEL DE OPCIONES ========== */
        .options-panel {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: none;
        }

        .options-panel::-webkit-scrollbar {
            width: 6px;
        }

        .options-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .options-panel::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .options-panel::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        .options-panel.active {
            display: block;
            animation: slideIn 0.2s ease;
        }

        @@keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .options-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .options-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .options-header h3 i {
            color: var(--primary);
        }

        .options-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .options-close:hover {
            background: var(--surface);
            color: var(--fg);
        }

        .options-content {
            padding: 16px;
        }

        .options-section {
            margin-bottom: 24px;
        }

        .options-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* Grid de items */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .items-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-item {
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
        }

        .grid-item:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .grid-item.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Colores */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .color-item {
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-item:hover {
            transform: scale(1.15);
        }

        .color-item.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        /* Degradados */
        .gradient-item {
            height: 60px;
            border-radius: var(--radius-md);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .gradient-item:hover {
            transform: scale(1.02);
        }

        .gradient-item.active {
            border-color: var(--primary);
        }

        /* Boton subir */
        .upload-btn {
            width: 100%;
            padding: 30px 20px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--muted);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--primary) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upload-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
            transform: translateY(-2px);
        }

        .upload-btn:hover::after {
            opacity: 0.05;
        }

        .upload-btn i {
            font-size: 2rem;
            position: relative;
            z-index: 1;
        }

        .upload-btn span {
            position: relative;
            z-index: 1;
        }

        /* Texto presets */
        .text-preset {
            padding: 14px 18px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.25s ease;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .text-preset::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--accent) 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .text-preset:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .text-preset:hover::before {
            opacity: 1;
        }

        .text-preset-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--fg);
        }

        .text-preset-sub {
            font-size: 0.75rem;
            color: var(--muted);
        }

        /* ========== CANVAS AREA ========== */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
        }

        /* Format tabs - Estilo pills moderno */
        .format-tabs {
            display: flex;
            gap: 8px;
            padding: 14px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .format-tabs::-webkit-scrollbar {
            display: none;
        }

        .format-tab {
            padding: 10px 20px;
            border-radius: 24px;
            background: var(--surface);
            border: none;
            color: var(--muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .format-tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .format-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }

        /* Canvas container */
        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: auto;
            background: radial-gradient(circle at 50% 50%, var(--bg-secondary) 0%, var(--bg) 100%);
        }

        .canvas-frame {
            background: white;
            box-shadow: var(--shadow), 0 0 60px rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .canvas-frame:hover {
            box-shadow: var(--shadow), 0 0 80px rgba(99, 102, 241, 0.15);
        }

        #fabricCanvas {
            display: block;
        }

        /* Canvas controls */
        .canvas-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--surface);
            padding: 6px 12px;
            border-radius: var(--radius-md);
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--fg);
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .zoom-btn:hover {
            background: var(--bg-secondary);
        }

        .zoom-level {
            font-size: 0.85rem;
            color: var(--fg-secondary);
            min-width: 50px;
            text-align: center;
        }

        .control-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* ========== PROPERTIES BAR ========== */
        .properties-bar {
            position: fixed;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px 20px;
            display: none;
            align-items: center;
            gap: 14px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .properties-bar.active {
            display: flex;
            animation: fadeSlideDown 0.2s ease;
        }

        @@keyframes fadeSlideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .prop-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .prop-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .prop-btn:hover {
            background: var(--surface-hover);
        }

        .prop-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .prop-separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 6px;
        }

        .prop-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--fg);
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .prop-color {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            cursor: pointer;
        }

        /* ========== STICKERS GRID ========== */
        .sticker-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: var(--surface);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sticker-item:hover {
            transform: scale(1.1);
            background: var(--surface-hover);
        }

        /* ========== EFFECTS PANEL ========== */
        .filter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .filter-item:hover {
            background: var(--surface-hover);
        }

        .filter-item.active {
            background: rgba(99, 102, 241, 0.2);
        }

        /* Grid 4 columnas */
        .items-grid-4 {
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 6px;
        }

        /* Emoji tabs - Estilo pills */
        .emoji-tabs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .emoji-tab {
            padding: 8px 14px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--surface);
            border: none;
            border-radius: 20px;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emoji-tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .emoji-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Badges grid */
        .badges-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge-item {
            padding: 6px 12px;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Social icon items */
        .social-icon-item i {
            font-size: 1.3rem;
        }

        /* Sticker items mejorados */
        .sticker-item {
            font-size: 1.4rem;
            transition: transform 0.15s ease;
        }

        .sticker-item:hover {
            transform: scale(1.2);
        }

        /* Photo library items */
        .grid-item {
            position: relative;
        }

        .grid-item .photo-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 6px;
            font-size: 0.6rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .grid-item:hover .photo-name {
            opacity: 1;
        }

        .custom-photo-item .delete-photo-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            color: white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            z-index: 5;
        }

        .custom-photo-item:hover .delete-photo-btn {
            display: flex;
        }

        .custom-photo-item .delete-photo-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .upload-btn-enhanced {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none !important;
            color: white;
            padding: 20px !important;
        }

        .upload-btn-enhanced:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .upload-btn-enhanced::after {
            display: none;
        }

        .upload-btn-library {
            cursor: pointer;
        }

        .upload-btn-library:hover {
            background: rgba(70, 130, 180, 0.2) !important;
        }

        .profile-photo-item {
            border: 2px solid var(--primary);
        }

        /* Template previews */
        .template-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .template-label {
            font-size: 0.55rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            letter-spacing: 0.5px;
            text-align: center;
            padding: 2px 4px;
        }

        .filter-preview {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border);
        }

        .filter-item span {
            font-size: 0.7rem;
            color: var(--fg-secondary);
        }

        .effect-hint {
            font-size: 0.75rem;
            color: var(--muted);
            margin-bottom: 12px;
            font-style: italic;
        }

        .effect-slider {
            margin-bottom: 16px;
        }

        .effect-slider label {
            display: block;
            font-size: 0.8rem;
            color: var(--fg-secondary);
            margin-bottom: 6px;
        }

        .effect-slider input[type="range"] {
            width: calc(100% - 40px);
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .effect-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .effect-slider span {
            display: inline-block;
            width: 35px;
            text-align: right;
            font-size: 0.75rem;
            color: var(--muted);
            vertical-align: middle;
            margin-left: 5px;
        }

        /* ========== RESPONSIVE ========== */
        @@media (max-width: 768px) {
            .editor-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-around;
                border-right: none;
                border-top: 1px solid var(--border);
                z-index: 100;
            }

            .tool-btn {
                padding: 10px 6px;
            }

            .tool-btn span {
                display: none;
            }

            .options-panel {
                position: fixed;
                bottom: 60px;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 50vh;
                border-right: none;
                border-top: 1px solid var(--border);
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            }

            .canvas-wrapper {
                padding: 20px;
                padding-bottom: 80px;
            }

            .format-tabs {
                padding: 10px 15px;
            }
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 28px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
            box-shadow: var(--shadow), 0 0 30px rgba(34, 197, 94, 0.2);
        }
        .toast.success i { color: var(--success); }
        .toast.error {
            border-color: var(--danger);
            box-shadow: var(--shadow), 0 0 30px rgba(239, 68, 68, 0.2);
        }
        .toast.error i { color: var(--danger); }
        .toast.info {
            border-color: var(--primary);
            box-shadow: var(--shadow), 0 0 30px rgba(99, 102, 241, 0.2);
        }
        .toast.info i { color: var(--primary); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--surface);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.25s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--fg);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            background: var(--bg);
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--fg);
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Draft indicator */
        .draft-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            color: var(--warning);
        }

        .draft-indicator.show {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Header -->
        <div class="editor-header">
            <div class="header-left">
                <a href="/Dashboard" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <span class="editor-title">Editor de Imagenes Promocionales</span>
            </div>
            <div class="header-right">
                <button class="btn btn-icon btn-secondary" id="btnTheme" title="Cambiar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="btn btn-icon btn-secondary" id="btnUndo" title="Deshacer">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn-icon btn-secondary" id="btnRedo" title="Rehacer">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="btn btn-secondary" id="btnSaveDraft" title="Guardar borrador">
                    <i class="fas fa-save"></i>
                    <span>Guardar</span>
                </button>
                <button class="btn btn-secondary" id="btnDownload">
                    <i class="fas fa-download"></i>
                    <span>Descargar</span>
                </button>
                <button class="btn btn-primary" id="btnPublish">
                    <i class="fas fa-paper-plane"></i>
                    <span>Publicar</span>
                </button>
            </div>
        </div>

        <div class="editor-body">
            <!-- Sidebar -->
            <div class="editor-sidebar">
                <button class="tool-btn active" data-tool="templates">
                    <i class="fas fa-th-large"></i>
                    <span>Plantillas</span>
                </button>
                <button class="tool-btn" data-tool="backgrounds">
                    <i class="fas fa-palette"></i>
                    <span>Fondos</span>
                </button>
                <button class="tool-btn" data-tool="photos">
                    <i class="fas fa-image"></i>
                    <span>Fotos</span>
                </button>
                <button class="tool-btn" data-tool="text">
                    <i class="fas fa-font"></i>
                    <span>Texto</span>
                </button>
                <button class="tool-btn" data-tool="stickers">
                    <i class="fas fa-smile"></i>
                    <span>Stickers</span>
                </button>
                <button class="tool-btn" data-tool="elements">
                    <i class="fas fa-shapes"></i>
                    <span>Formas</span>
                </button>
                <button class="tool-btn" data-tool="effects">
                    <i class="fas fa-magic"></i>
                    <span>Efectos</span>
                </button>
            </div>

            <!-- Panel de opciones -->
            <div class="options-panel active" id="optionsPanel">
                <!-- Contenido dinamico -->
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="format-tabs">
                    <button class="format-tab active" data-format="instagram-feed">
                        <i class="fab fa-instagram"></i> Feed 1:1
                    </button>
                    <button class="format-tab" data-format="instagram-story">
                        <i class="fab fa-instagram"></i> Story 9:16
                    </button>
                    <button class="format-tab" data-format="tiktok">
                        <i class="fab fa-tiktok"></i> TikTok
                    </button>
                    <button class="format-tab" data-format="facebook">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="format-tab" data-format="twitter">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                </div>

                <div class="canvas-wrapper">
                    <div class="canvas-frame">
                        <canvas id="fabricCanvas"></canvas>
                    </div>
                </div>

                <div class="canvas-controls">
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="zoomOut"><i class="fas fa-minus"></i></button>
                        <span class="zoom-level" id="zoomLevel">100%</span>
                        <button class="zoom-btn" id="zoomIn"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="control-divider"></div>
                    <button class="btn btn-icon btn-secondary" id="btnBringFront" title="Traer al frente">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="btn btn-icon btn-secondary" id="btnSendBack" title="Enviar atras">
                        <i class="fas fa-layer-group fa-flip-vertical"></i>
                    </button>
                    <div class="control-divider"></div>
                    <button class="btn btn-icon btn-danger" id="btnDelete" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Properties bar -->
        <div class="properties-bar" id="propertiesBar">
            <div class="prop-group" id="textProps" style="display:none;">
                <select class="prop-select" id="fontFamily">
                    <option value="Inter">Inter</option>
                    <option value="Montserrat">Montserrat</option>
                    <option value="Playfair Display">Playfair</option>
                    <option value="Bebas Neue">Bebas Neue</option>
                    <option value="Pacifico">Pacifico</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <select class="prop-select" id="fontSize">
                    <option value="18">18</option>
                    <option value="24">24</option>
                    <option value="32">32</option>
                    <option value="48" selected>48</option>
                    <option value="64">64</option>
                    <option value="72">72</option>
                    <option value="96">96</option>
                    <option value="120">120</option>
                </select>
                <div class="prop-separator"></div>
                <button class="prop-btn" id="btnBold" title="Negrita"><i class="fas fa-bold"></i></button>
                <button class="prop-btn" id="btnItalic" title="Cursiva"><i class="fas fa-italic"></i></button>
                <button class="prop-btn" id="btnUnderline" title="Subrayado"><i class="fas fa-underline"></i></button>
                <div class="prop-separator"></div>
                <button class="prop-btn" id="btnAlignLeft" title="Alinear izquierda"><i class="fas fa-align-left"></i></button>
                <button class="prop-btn" id="btnAlignCenter" title="Centrar"><i class="fas fa-align-center"></i></button>
                <button class="prop-btn" id="btnAlignRight" title="Alinear derecha"><i class="fas fa-align-right"></i></button>
                <button class="prop-btn" id="btnAlignJustify" title="Justificar"><i class="fas fa-align-justify"></i></button>
                <div class="prop-separator"></div>
                <input type="color" class="prop-color" id="textColor" value="#ffffff" title="Color de texto">
            </div>
            <div class="prop-group" id="imageProps" style="display:none;">
                <button class="prop-btn" id="btnFlipH" title="Voltear horizontal"><i class="fas fa-arrows-alt-h"></i></button>
                <button class="prop-btn" id="btnFlipV" title="Voltear vertical"><i class="fas fa-arrows-alt-v"></i></button>
            </div>
        </div>
    </div>

    <!-- Hidden inputs -->
    <input type="file" id="imageUpload" class="hidden-input" accept="image/*">

    <!-- Toast notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Mensaje</span>
    </div>

    <!-- Modal de publicar -->
    <div class="modal-overlay" id="publishModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-paper-plane"></i> Publicar en Feed</h3>
                <button class="modal-close" id="closePublishModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <img class="modal-preview" id="publishPreview" src="" alt="Preview">
                <textarea class="modal-input" id="publishCaption" placeholder="Escribe una descripcion para tu publicacion... (opcional)"></textarea>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--muted);">
                    <i class="fas fa-info-circle"></i>
                    <span>La imagen se publicara en tu feed como contenido publico</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPublish">Cancelar</button>
                <button class="btn btn-success" id="confirmPublish">
                    <i class="fas fa-check"></i> Publicar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de borrador guardado -->
    <div class="modal-overlay" id="draftModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Borrador encontrado</h3>
                <button class="modal-close" id="closeDraftModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Tienes un borrador guardado del <strong id="draftDate"></strong></p>
                <p style="color: var(--muted); font-size: 0.9rem;">Â¿Deseas continuar donde lo dejaste o empezar de nuevo?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="discardDraft">Empezar nuevo</button>
                <button class="btn btn-primary" id="loadDraft">
                    <i class="fas fa-folder-open"></i> Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Fabric.js -->
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <!-- QR Code - usando qrcode generator que funciona bien en browser -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <script>
        // ========== CONFIGURACION ==========
        const CREATOR_CONFIG = {
            seudonimo: '@Html.Raw(ViewBag.Seudonimo)',
            fotoPerfil: '@Html.Raw(ViewBag.FotoPerfil)',
            linkPerfil: '@Html.Raw(ViewBag.LinkPerfil)',
            precio: @(ViewBag.Precio ?? 0),
            baseUrl: '@Html.Raw(ViewBag.BaseUrl)'
        };

        const FORMATS = {
            'instagram-feed': { width: 1080, height: 1080, scale: 0.45 },
            'instagram-story': { width: 1080, height: 1920, scale: 0.3 },
            'tiktok': { width: 1080, height: 1920, scale: 0.3 },
            'facebook': { width: 1200, height: 630, scale: 0.5 },
            'twitter': { width: 1200, height: 675, scale: 0.48 }
        };

        const GRADIENTS = [
            { name: 'Sunset', colors: ['#ff512f', '#f09819'] },
            { name: 'Ocean', colors: ['#2193b0', '#6dd5ed'] },
            { name: 'Purple', colors: ['#667eea', '#764ba2'] },
            { name: 'Fire', colors: ['#f83600', '#f9d423'] },
            { name: 'Mint', colors: ['#11998e', '#38ef7d'] },
            { name: 'Pink', colors: ['#ee9ca7', '#ffdde1'] },
            { name: 'Dark', colors: ['#0f0c29', '#302b63', '#24243e'] },
            { name: 'Gold', colors: ['#f7971e', '#ffd200'] }
        ];

        const SOLID_COLORS = [
            '#ffffff', '#000000', '#ef4444', '#f97316', '#eab308', '#22c55e',
            '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'
        ];

        // Emojis organizados por categorias
        const EMOJI_CATEGORIES = {
            'Populares': ['ğŸ”¥', 'ğŸ’œ', 'âœ¨', 'ğŸ’«', 'â­', 'â¤ï¸', 'ğŸ’–', 'ğŸŒŸ', 'ğŸ’', 'ğŸ‘‘', 'ğŸ¦‹', 'ğŸŒ¸'],
            'Corazones': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’', 'â£ï¸', 'ğŸ’”', 'ğŸ’“'],
            'Estrellas': ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸŒ ', 'âš¡', 'ğŸ’¥', 'ğŸ”†', 'ğŸ”…', 'âœ´ï¸', 'ğŸŒˆ', 'â˜€ï¸'],
            'Manos': ['ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤™', 'ğŸ‘‹', 'ğŸ’ª', 'ğŸ™', 'ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘ˆ', 'ğŸ‘‰'],
            'Caras': ['ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜Š', 'ğŸ¤©', 'ğŸ˜', 'ğŸ¥µ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜‹', 'ğŸ¤­', 'ğŸ˜ˆ', 'ğŸ‘€', 'ğŸ«£', 'ğŸ¤«', 'ğŸ˜œ'],
            'Celebracion': ['ğŸ‰', 'ğŸŠ', 'ğŸ', 'ğŸˆ', 'ğŸ€', 'ğŸ‚', 'ğŸ¾', 'ğŸ¥‚', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¯', 'ğŸª'],
            'Dinero': ['ğŸ’°', 'ğŸ’µ', 'ğŸ’¸', 'ğŸ’³', 'ğŸ’²', 'ğŸ¤‘', 'ğŸ’', 'ğŸ‘‘', 'ğŸ¦', 'ğŸ“ˆ', 'ğŸ’¹', 'ğŸ°'],
            'Naturaleza': ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ¹', 'ğŸŒ·', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸ€', 'ğŸŒ¿', 'ğŸƒ', 'ğŸŒ´', 'ğŸŒ™', 'ğŸ¦‹'],
            'Comida': ['ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸŒ', 'ğŸ†', 'ğŸ¥‘', 'ğŸ•', 'ğŸ”', 'ğŸŸ', 'ğŸŒ®', 'ğŸ¦', 'ğŸ©'],
            'Flechas': ['â¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†”ï¸', 'â†•ï¸', 'ğŸ”„', 'ğŸ”ƒ'],
            'Simbolos': ['âœ…', 'âŒ', 'â­•', 'â—', 'â“', 'ğŸ’¯', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âš«', 'âšª', 'ğŸ”¶', 'ğŸ”·'],
            'Otros': ['ğŸ“¸', 'ğŸ¬', 'ğŸ¥', 'ğŸ“±', 'ğŸ’»', 'ğŸ§', 'ğŸ¤', 'ğŸ“¢', 'ğŸ””', 'â°', 'ğŸ“Œ', 'ğŸ”—', 'âœï¸', 'ğŸ“', 'ğŸ—ï¸', 'ğŸ”']
        };

        // Para compatibilidad
        const STICKERS = EMOJI_CATEGORIES['Populares'];

        // SVG paths de logos de redes sociales (simplificados)
        const SOCIAL_ICONS = [
            {
                name: 'Instagram',
                color: '#E4405F',
                gradient: ['#f09433','#e6683c','#dc2743','#cc2366','#bc1888'],
                svg: 'M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z'
            },
            {
                name: 'TikTok',
                color: '#000000',
                svg: 'M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z',
                iconColor: '#fff'
            },
            {
                name: 'X (Twitter)',
                color: '#000000',
                svg: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z',
                iconColor: '#fff'
            },
            {
                name: 'YouTube',
                color: '#FF0000',
                svg: 'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z',
                iconColor: '#fff'
            },
            {
                name: 'Facebook',
                color: '#1877F2',
                svg: 'M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z',
                iconColor: '#fff'
            },
            {
                name: 'WhatsApp',
                color: '#25D366',
                svg: 'M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z',
                iconColor: '#fff'
            },
            {
                name: 'Telegram',
                color: '#0088cc',
                svg: 'M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z',
                iconColor: '#fff'
            },
            {
                name: 'Twitch',
                color: '#9146FF',
                svg: 'M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714z',
                iconColor: '#fff'
            },
            {
                name: 'Discord',
                color: '#5865F2',
                svg: 'M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z',
                iconColor: '#fff'
            },
            {
                name: 'Snapchat',
                color: '#FFFC00',
                svg: 'M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z',
                iconColor: '#000'
            },
            {
                name: 'Pinterest',
                color: '#E60023',
                svg: 'M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z',
                iconColor: '#fff'
            },
            {
                name: 'LinkedIn',
                color: '#0A66C2',
                svg: 'M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z',
                iconColor: '#fff'
            }
        ];

        // Marcos/Frames para fotos
        const PHOTO_FRAMES = [
            { name: 'Ninguno', type: 'none' },
            { name: 'Circulo', type: 'circle' },
            { name: 'Borde blanco', type: 'border-white' },
            { name: 'Borde negro', type: 'border-black' },
            { name: 'Polaroid', type: 'polaroid' },
            { name: 'Sombra', type: 'shadow' }
        ];

        // Elementos decorativos
        const DECORATIVE_ELEMENTS = [
            { name: 'Flecha derecha', icon: 'â†’', type: 'arrow-right' },
            { name: 'Flecha izquierda', icon: 'â†', type: 'arrow-left' },
            { name: 'Flecha abajo', icon: 'â†“', type: 'arrow-down' },
            { name: 'Separador', icon: 'â€•', type: 'divider' },
            { name: 'Punto', icon: 'â—', type: 'bullet' },
            { name: 'Estrella', icon: 'â˜…', type: 'star' }
        ];

        // Badges/Etiquetas prediseÃ±adas
        const BADGES = [
            { text: 'NUEVO', bg: '#ef4444', color: '#fff' },
            { text: 'HOT', bg: '#f97316', color: '#fff' },
            { text: 'GRATIS', bg: '#22c55e', color: '#fff' },
            { text: 'VIP', bg: '#ffd700', color: '#000' },
            { text: 'EXCLUSIVO', bg: '#8b5cf6', color: '#fff' },
            { text: 'OFERTA', bg: '#ec4899', color: '#fff' },
            { text: '18+', bg: '#000', color: '#fff' },
            { text: 'PREMIUM', bg: '#0ea5e9', color: '#fff' }
        ];

        // Patrones de fondo
        const PATTERNS = [
            { name: 'Puntos', type: 'dots' },
            { name: 'Lineas', type: 'lines' },
            { name: 'Cuadricula', type: 'grid' },
            { name: 'Ondas', type: 'waves' }
        ];

        // Biblioteca de fondos con imagenes
        const BACKGROUND_IMAGES = [
            { name: 'Neon Rosa', url: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800&q=80', category: 'abstract' },
            { name: 'Neon Azul', url: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=800&q=80', category: 'abstract' },
            { name: 'Degradado Suave', url: 'https://images.unsplash.com/photo-1557682250-33bd709cbe85?w=800&q=80', category: 'abstract' },
            { name: 'Humo Colores', url: 'https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?w=800&q=80', category: 'abstract' },
            { name: 'Luces Bokeh', url: 'https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?w=800&q=80', category: 'abstract' },
            { name: 'Galaxia', url: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=800&q=80', category: 'space' },
            { name: 'Estrellas', url: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800&q=80', category: 'space' },
            { name: 'Marmol Blanco', url: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&q=80', category: 'texture' },
            { name: 'Marmol Negro', url: 'https://images.unsplash.com/photo-1551731409-43eb3e517a1a?w=800&q=80', category: 'texture' },
            { name: 'Madera', url: 'https://images.unsplash.com/photo-1558618047-f4b511ab7b44?w=800&q=80', category: 'texture' },
            { name: 'Ladrillo', url: 'https://images.unsplash.com/photo-1528297506728-9533d2ac3fa4?w=800&q=80', category: 'texture' },
            { name: 'Holografico', url: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800&q=80', category: 'abstract' },
            { name: 'Geometrico', url: 'https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=800&q=80', category: 'pattern' },
            { name: 'Palmeras', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80', category: 'nature' },
            { name: 'Atardecer', url: 'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?w=800&q=80', category: 'nature' },
            { name: 'Ciudad Noche', url: 'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800&q=80', category: 'urban' }
        ];

        // Biblioteca de fotos stock
        const STOCK_PHOTOS = [
            { name: 'Manos Corazon', url: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=600&q=80', category: 'lifestyle' },
            { name: 'Smartphone', url: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=600&q=80', category: 'tech' },
            { name: 'Laptop', url: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=600&q=80', category: 'tech' },
            { name: 'Cafe', url: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=600&q=80', category: 'lifestyle' },
            { name: 'Regalo', url: 'https://images.unsplash.com/photo-1513885535751-8b9238bd345a?w=600&q=80', category: 'objects' },
            { name: 'Confeti', url: 'https://images.unsplash.com/photo-1513151233558-d860c5398176?w=600&q=80', category: 'celebration' },
            { name: 'Flores', url: 'https://images.unsplash.com/photo-1490750967868-88aa4486c946?w=600&q=80', category: 'nature' },
            { name: 'Luces', url: 'https://images.unsplash.com/photo-1530103862676-de8c9debad1d?w=600&q=80', category: 'celebration' },
            { name: 'Auriculares', url: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=600&q=80', category: 'tech' },
            { name: 'Camara', url: 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=600&q=80', category: 'tech' },
            { name: 'Reloj', url: 'https://images.unsplash.com/photo-1524592094714-0f0654e20314?w=600&q=80', category: 'objects' },
            { name: 'Maquillaje', url: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=600&q=80', category: 'beauty' }
        ];

        // ========== CLASE PRINCIPAL ==========
        class PromoEditor {
            constructor() {
                this.canvas = null;
                this.currentFormat = 'instagram-feed';
                this.currentTool = 'templates';
                this.zoom = 1;
                this.history = [];
                this.historyIndex = -1;
            }

            init() {
                this.initCanvas();
                this.bindEvents();
                this.renderToolPanel('templates');
                this.setFormat('instagram-feed');
                this.checkForDraft();
            }

            initCanvas() {
                const format = FORMATS[this.currentFormat];
                this.canvas = new fabric.Canvas('fabricCanvas', {
                    width: format.width * format.scale,
                    height: format.height * format.scale,
                    backgroundColor: '#667eea',
                    preserveObjectStacking: true,
                    enableRetinaScaling: false,
                    renderOnAddRemove: true
                });

                // Configurar controles de seleccion para evitar problemas de escala
                fabric.Object.prototype.set({
                    transparentCorners: false,
                    cornerColor: '#4682B4',
                    cornerStyle: 'circle',
                    cornerSize: 10,
                    borderColor: '#4682B4',
                    borderScaleFactor: 2
                });

                // Eventos de seleccion
                this.canvas.on('selection:created', () => this.showProperties());
                this.canvas.on('selection:updated', () => this.showProperties());
                this.canvas.on('selection:cleared', () => this.hideProperties());
                this.canvas.on('object:modified', () => this.saveHistory());
            }

            bindEvents() {
                // Tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentTool = btn.dataset.tool;
                        this.renderToolPanel(this.currentTool);
                    });
                });

                // Format tabs
                document.querySelectorAll('.format-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.setFormat(tab.dataset.format);
                    });
                });

                // Zoom
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());

                // Delete
                document.getElementById('btnDelete').addEventListener('click', () => this.deleteSelected());

                // Layers
                document.getElementById('btnBringFront').addEventListener('click', () => {
                    const obj = this.canvas.getActiveObject();
                    if (obj) { this.canvas.bringToFront(obj); this.canvas.renderAll(); }
                });
                document.getElementById('btnSendBack').addEventListener('click', () => {
                    const obj = this.canvas.getActiveObject();
                    if (obj) { this.canvas.sendToBack(obj); this.canvas.renderAll(); }
                });

                // Undo/Redo
                document.getElementById('btnUndo').addEventListener('click', () => this.undo());
                document.getElementById('btnRedo').addEventListener('click', () => this.redo());

                // Download
                document.getElementById('btnDownload').addEventListener('click', () => this.download());

                // Save Draft
                document.getElementById('btnSaveDraft').addEventListener('click', () => this.saveDraft());

                // Publish
                document.getElementById('btnPublish').addEventListener('click', () => this.openPublishModal());
                document.getElementById('closePublishModal').addEventListener('click', () => this.closePublishModal());
                document.getElementById('cancelPublish').addEventListener('click', () => this.closePublishModal());
                document.getElementById('confirmPublish').addEventListener('click', () => this.publishToFeed());

                // Draft modal
                document.getElementById('closeDraftModal').addEventListener('click', () => this.closeDraftModal(false));
                document.getElementById('discardDraft').addEventListener('click', () => this.closeDraftModal(false));
                document.getElementById('loadDraft').addEventListener('click', () => this.closeDraftModal(true));

                // Image upload
                document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));

                // Text properties
                document.getElementById('fontFamily').addEventListener('change', (e) => this.updateTextProperty('fontFamily', e.target.value));
                document.getElementById('fontSize').addEventListener('change', (e) => this.updateTextProperty('fontSize', parseInt(e.target.value)));
                document.getElementById('textColor').addEventListener('input', (e) => this.updateTextProperty('fill', e.target.value));
                document.getElementById('btnBold').addEventListener('click', () => this.toggleTextBold());
                document.getElementById('btnItalic').addEventListener('click', () => this.toggleTextItalic());
                document.getElementById('btnUnderline').addEventListener('click', () => this.toggleTextUnderline());

                // Alineacion de texto
                document.getElementById('btnAlignLeft').addEventListener('click', () => this.setTextAlign('left'));
                document.getElementById('btnAlignCenter').addEventListener('click', () => this.setTextAlign('center'));
                document.getElementById('btnAlignRight').addEventListener('click', () => this.setTextAlign('right'));
                document.getElementById('btnAlignJustify').addEventListener('click', () => this.setTextAlign('justify'));

                // Image properties
                document.getElementById('btnFlipH').addEventListener('click', () => this.flipImage('x'));
                document.getElementById('btnFlipV').addEventListener('click', () => this.flipImage('y'));

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' || e.key === 'Backspace') {
                        if (document.activeElement.tagName !== 'INPUT') {
                            this.deleteSelected();
                        }
                    }
                });
            }

            // ========== FORMATOS ==========
            setFormat(format) {
                this.currentFormat = format;
                const f = FORMATS[format];

                // Guardar objetos actuales
                const objects = this.canvas.getObjects();
                const json = this.canvas.toJSON();

                // Redimensionar canvas
                this.canvas.setWidth(f.width * f.scale);
                this.canvas.setHeight(f.height * f.scale);
                this.canvas.setZoom(f.scale);

                // Re-escalar objetos
                objects.forEach(obj => {
                    obj.scaleX = obj.scaleX || 1;
                    obj.scaleY = obj.scaleY || 1;
                });

                this.canvas.renderAll();
                document.getElementById('zoomLevel').textContent = Math.round(f.scale * 100) + '%';
            }

            // ========== ZOOM ==========
            zoomIn() {
                const f = FORMATS[this.currentFormat];
                f.scale = Math.min(f.scale + 0.1, 1);
                this.setFormat(this.currentFormat);
            }

            zoomOut() {
                const f = FORMATS[this.currentFormat];
                f.scale = Math.max(f.scale - 0.1, 0.2);
                this.setFormat(this.currentFormat);
            }

            // ========== HERRAMIENTAS ==========
            renderToolPanel(tool) {
                const panel = document.getElementById('optionsPanel');
                panel.classList.add('active');

                switch(tool) {
                    case 'templates':
                        panel.innerHTML = this.getTemplatesPanel();
                        break;
                    case 'backgrounds':
                        panel.innerHTML = this.getBackgroundsPanel();
                        break;
                    case 'photos':
                        panel.innerHTML = this.getPhotosPanel();
                        break;
                    case 'text':
                        panel.innerHTML = this.getTextPanel();
                        break;
                    case 'stickers':
                        panel.innerHTML = this.getStickersPanel();
                        break;
                    case 'elements':
                        panel.innerHTML = this.getElementsPanel();
                        break;
                    case 'effects':
                        panel.innerHTML = this.getEffectsPanel();
                        break;
                }

                this.bindPanelEvents(tool);
            }

            getTemplatesPanel() {
                return `
                    <div class="options-header">
                        <h3>Plantillas</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <div class="options-section-title">â­ Promocionar Lado</div>
                            <div class="items-grid">
                                <div class="grid-item template-preview" data-template="promo-lado" style="background: linear-gradient(135deg, #6366f1, #a78bfa)">
                                    <div class="template-label">LADO APP</div>
                                </div>
                                <div class="grid-item template-preview" data-template="promo-lado-dark" style="background: linear-gradient(135deg, #1e1b4b, #312e81)">
                                    <div class="template-label">LADO DARK</div>
                                </div>
                                <div class="grid-item template-preview" data-template="promo-lado-creator" style="background: linear-gradient(135deg, #f59e0b, #ef4444)">
                                    <div class="template-label">CREATOR</div>
                                </div>
                                <div class="grid-item template-preview" data-template="promo-lado-join" style="background: linear-gradient(135deg, #10b981, #3b82f6)">
                                    <div class="template-label">JOIN</div>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Promocion de Suscripcion</div>
                            <div class="items-grid">
                                <div class="grid-item template-preview" data-template="suscribete" style="background: linear-gradient(135deg, #667eea, #764ba2)">
                                    <div class="template-label">SUSCRIBETE</div>
                                </div>
                                <div class="grid-item template-preview" data-template="vip-access" style="background: linear-gradient(135deg, #f7971e, #ffd200)">
                                    <div class="template-label">VIP</div>
                                </div>
                                <div class="grid-item template-preview" data-template="precio-especial" style="background: linear-gradient(135deg, #11998e, #38ef7d)">
                                    <div class="template-label">OFERTA</div>
                                </div>
                                <div class="grid-item template-preview" data-template="exclusivo" style="background: linear-gradient(135deg, #0f0c29, #302b63)">
                                    <div class="template-label">EXCLUSIVO</div>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Elaboradas Premium</div>
                            <div class="items-grid">
                                <div class="grid-item template-preview" data-template="flash-sale" style="background: linear-gradient(135deg, #ff0844, #ffb199)">
                                    <div class="template-label">FLASH SALE</div>
                                </div>
                                <div class="grid-item template-preview" data-template="limited-time" style="background: linear-gradient(135deg, #1a1a2e, #16213e)">
                                    <div class="template-label">LIMITED</div>
                                </div>
                                <div class="grid-item template-preview" data-template="black-friday" style="background: linear-gradient(135deg, #000000, #434343)">
                                    <div class="template-label">BLACK</div>
                                </div>
                                <div class="grid-item template-preview" data-template="giveaway" style="background: linear-gradient(135deg, #f093fb, #f5576c)">
                                    <div class="template-label">GIVEAWAY</div>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Nuevo Contenido</div>
                            <div class="items-grid">
                                <div class="grid-item template-preview" data-template="nuevo-post" style="background: linear-gradient(135deg, #ee9ca7, #ffdde1)">
                                    <div class="template-label">NUEVO</div>
                                </div>
                                <div class="grid-item template-preview" data-template="preview" style="background: linear-gradient(135deg, #232526, #414345)">
                                    <div class="template-label">PREVIEW</div>
                                </div>
                                <div class="grid-item template-preview" data-template="coming-soon" style="background: linear-gradient(135deg, #ff512f, #f09819)">
                                    <div class="template-label">PRONTO</div>
                                </div>
                                <div class="grid-item template-preview" data-template="trending" style="background: linear-gradient(135deg, #ec4899, #8b5cf6)">
                                    <div class="template-label">TRENDING</div>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Engagement</div>
                            <div class="items-grid">
                                <div class="grid-item template-preview" data-template="link-bio" style="background: linear-gradient(135deg, #2193b0, #6dd5ed)">
                                    <div class="template-label">LINK BIO</div>
                                </div>
                                <div class="grid-item template-preview" data-template="sigueme" style="background: linear-gradient(135deg, #f83600, #f9d423)">
                                    <div class="template-label">SIGUEME</div>
                                </div>
                                <div class="grid-item template-preview" data-template="gracias" style="background: linear-gradient(135deg, #a18cd1, #fbc2eb)">
                                    <div class="template-label">GRACIAS</div>
                                </div>
                                <div class="grid-item template-preview" data-template="preguntame" style="background: linear-gradient(135deg, #4facfe, #00f2fe)">
                                    <div class="template-label">Q&A</div>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Minimalistas</div>
                            <div class="items-grid">
                                <div class="grid-item" data-template="minimal" style="background: linear-gradient(135deg, #667eea, #764ba2)"></div>
                                <div class="grid-item" data-template="neon" style="background: linear-gradient(135deg, #0f0c29, #302b63)"></div>
                                <div class="grid-item" data-template="sunset" style="background: linear-gradient(135deg, #ff512f, #f09819)"></div>
                                <div class="grid-item" data-template="ocean" style="background: linear-gradient(135deg, #2193b0, #6dd5ed)"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getBackgroundsPanel() {
                let gradientItems = GRADIENTS.map((g, i) =>
                    `<div class="gradient-item" data-gradient="${i}" style="background: linear-gradient(135deg, ${g.colors.join(', ')})"></div>`
                ).join('');

                let colorItems = SOLID_COLORS.map(c =>
                    `<div class="color-item" data-color="${c}" style="background: ${c}"></div>`
                ).join('');

                // Imagenes de fondo por categoria
                const bgCategories = {
                    'abstract': 'Abstractos',
                    'space': 'Espacio',
                    'texture': 'Texturas',
                    'nature': 'Naturaleza',
                    'urban': 'Urbano',
                    'pattern': 'Patrones'
                };

                let bgImageItems = BACKGROUND_IMAGES.map((bg, i) =>
                    `<div class="grid-item bg-image-item" data-bgimage="${i}" title="${bg.name}" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>`
                ).join('');

                return `
                    <div class="options-header">
                        <h3>Fondos</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <label class="upload-btn" id="uploadBgBtn">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Subir imagen de fondo</span>
                            </label>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Imagenes de Fondo</div>
                            <div class="items-grid items-grid-3">${bgImageItems}</div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Colores Solidos</div>
                            <div class="color-grid">${colorItems}</div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Degradados</div>
                            ${gradientItems}
                        </div>
                    </div>
                `;
            }

            getPhotosPanel() {
                // Agrupar fotos por categoria
                const categories = {
                    'lifestyle': 'Estilo de vida',
                    'tech': 'Tecnologia',
                    'objects': 'Objetos',
                    'celebration': 'Celebracion',
                    'nature': 'Naturaleza',
                    'beauty': 'Belleza'
                };

                // Cargar fotos personalizadas de localStorage
                const customPhotos = JSON.parse(localStorage.getItem('customPhotos') || '[]');

                let stockPhotoItems = STOCK_PHOTOS.map((photo, i) =>
                    `<div class="grid-item stock-photo-item" data-stockphoto="${i}" title="${photo.name}" style="background-image: url('${photo.url}'); background-size: cover; background-position: center;">
                        <span class="photo-name">${photo.name}</span>
                    </div>`
                ).join('');

                let customPhotoItems = customPhotos.map((photo, i) =>
                    `<div class="grid-item custom-photo-item" data-customphoto="${i}" title="${photo.name}" style="background-image: url('${photo.url}'); background-size: cover; background-position: center;">
                        <button class="delete-photo-btn" data-deletephoto="${i}" title="Eliminar"><i class="fas fa-times"></i></button>
                        <span class="photo-name">${photo.name}</span>
                    </div>`
                ).join('');

                return `
                    <div class="options-header">
                        <h3><i class="fas fa-images"></i> Fotos</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <label class="upload-btn upload-btn-enhanced" id="uploadPhotoBtn">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Subir imagen al canvas</span>
                            </label>
                            <button class="upload-btn upload-btn-library" id="saveToLibraryBtn" style="margin-top: 8px; padding: 12px 16px; border: 1px dashed var(--primary); background: rgba(70, 130, 180, 0.1);">
                                <i class="fas fa-plus-circle"></i>
                                <span>Guardar en mi biblioteca</span>
                            </button>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title"><i class="fas fa-user-circle"></i> Tu perfil</div>
                            <div class="items-grid">
                                <div class="grid-item profile-photo-item" id="useProfilePhoto" title="Tu foto de perfil" style="background-image: url('${CREATOR_CONFIG.fotoPerfil}'); background-size: cover; background-position: center;">
                                    <span class="photo-name">Tu foto</span>
                                </div>
                            </div>
                        </div>
                        ${customPhotos.length > 0 ? `
                        <div class="options-section">
                            <div class="options-section-title"><i class="fas fa-folder-open"></i> Mi biblioteca (${customPhotos.length})</div>
                            <div class="items-grid items-grid-3">${customPhotoItems}</div>
                        </div>
                        ` : ''}
                        <div class="options-section">
                            <div class="options-section-title"><i class="fas fa-photo-video"></i> Fotos de stock (${STOCK_PHOTOS.length})</div>
                            <div class="items-grid items-grid-3">${stockPhotoItems}</div>
                        </div>
                    </div>
                `;
            }

            getTextPanel() {
                return `
                    <div class="options-header">
                        <h3>Texto</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <div class="text-preset" data-text="heading">
                                <div class="text-preset-title">Agregar titulo</div>
                                <div class="text-preset-sub">Texto grande y destacado</div>
                            </div>
                            <div class="text-preset" data-text="subheading">
                                <div class="text-preset-title" style="font-size: 0.95rem;">Agregar subtitulo</div>
                                <div class="text-preset-sub">Texto mediano</div>
                            </div>
                            <div class="text-preset" data-text="body">
                                <div class="text-preset-title" style="font-size: 0.85rem; font-weight: 400;">Agregar texto</div>
                                <div class="text-preset-sub">Parrafo normal</div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Textos rapidos</div>
                            <div class="text-preset" data-quicktext="@@${CREATOR_CONFIG.seudonimo}">
                                <div class="text-preset-title">@@${CREATOR_CONFIG.seudonimo}</div>
                            </div>
                            <div class="text-preset" data-quicktext="Sigueme">
                                <div class="text-preset-title">Sigueme</div>
                            </div>
                            <div class="text-preset" data-quicktext="Link en bio">
                                <div class="text-preset-title">Link en bio</div>
                            </div>
                            <div class="text-preset" data-quicktext="Contenido Exclusivo">
                                <div class="text-preset-title">Contenido Exclusivo</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getStickersPanel() {
                // Generar tabs de categorias de emojis
                const categories = Object.keys(EMOJI_CATEGORIES);
                let categoryTabs = categories.map((cat, i) =>
                    `<button class="emoji-tab ${i === 0 ? 'active' : ''}" data-emoji-cat="${cat}">${cat}</button>`
                ).join('');

                // Emojis de la primera categoria por defecto
                let defaultEmojis = EMOJI_CATEGORIES[categories[0]].map(s =>
                    `<div class="sticker-item" data-sticker="${s}">${s}</div>`
                ).join('');

                // Iconos sociales con SVG
                let socialItems = SOCIAL_ICONS.map((s, i) => {
                    const bgStyle = s.gradient
                        ? `background: linear-gradient(45deg, ${s.gradient.join(', ')})`
                        : `background: ${s.color}`;
                    return `<div class="sticker-item social-icon-item" data-social="${i}" title="${s.name}" style="${bgStyle}; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="${s.iconColor || '#fff'}">
                            <path d="${s.svg}"/>
                        </svg>
                    </div>`;
                }).join('');

                // Badges prediseÃ±ados
                let badgeItems = BADGES.map((b, i) =>
                    `<div class="badge-item" data-badge="${i}" style="background: ${b.bg}; color: ${b.color};">
                        ${b.text}
                    </div>`
                ).join('');

                return `
                    <div class="options-header">
                        <h3>Stickers y Emojis</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <div class="options-section-title">Emojis</div>
                            <div class="emoji-tabs-container">${categoryTabs}</div>
                            <div class="items-grid items-grid-4" id="emojiGrid">${defaultEmojis}</div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Etiquetas</div>
                            <div class="badges-grid">${badgeItems}</div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Redes Sociales</div>
                            <div class="items-grid items-grid-4">${socialItems}</div>
                        </div>
                    </div>
                `;
            }

            getElementsPanel() {
                return `
                    <div class="options-header">
                        <h3>Formas y Elementos</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <div class="options-section-title">Formas basicas</div>
                            <div class="items-grid">
                                <div class="grid-item shape-item" data-shape="rect" style="background: #6366f1; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-square" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="circle" style="background: #ec4899; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-circle" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="triangle" style="background: #f59e0b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-play" style="color: white; font-size: 1.5rem; transform: rotate(-90deg);"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="star" style="background: #fbbf24; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-star" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Lineas y Flechas</div>
                            <div class="items-grid">
                                <div class="grid-item shape-item" data-shape="line" style="background: #10b981; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-minus" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="arrow-right" style="background: #0ea5e9; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-arrow-right" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="arrow-down" style="background: #8b5cf6; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-arrow-down" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="divider" style="background: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-grip-lines" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Decorativos</div>
                            <div class="items-grid">
                                <div class="grid-item shape-item" data-shape="heart" style="background: #ef4444; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-heart" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="sparkle" style="background: linear-gradient(135deg, #fbbf24, #ec4899); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <span style="color: white; font-size: 1.5rem;">âœ¨</span>
                                </div>
                                <div class="grid-item shape-item" data-shape="fire" style="background: linear-gradient(135deg, #f97316, #ef4444); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <span style="color: white; font-size: 1.5rem;">ğŸ”¥</span>
                                </div>
                                <div class="grid-item shape-item" data-shape="crown" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <span style="color: white; font-size: 1.5rem;">ğŸ‘‘</span>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Marcos para fotos</div>
                            <div class="items-grid">
                                <div class="grid-item shape-item" data-shape="frame-circle" style="background: #1e293b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="far fa-circle" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="frame-square" style="background: #1e293b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="far fa-square" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="frame-rounded" style="background: #1e293b; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <i class="fas fa-square" style="color: white; font-size: 1.5rem; border-radius: 6px;"></i>
                                </div>
                                <div class="grid-item shape-item" data-shape="frame-polaroid" style="background: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #e2e8f0;">
                                    <i class="fas fa-image" style="color: #64748b; font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Codigo QR</div>
                            <div class="text-preset shape-item" data-shape="qr" style="cursor: pointer;">
                                <div class="text-preset-title"><i class="fas fa-qrcode"></i> Agregar QR de mi perfil</div>
                                <div class="text-preset-sub">Los usuarios pueden escanear para visitarte</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getEffectsPanel() {
                return `
                    <div class="options-header">
                        <h3>Efectos</h3>
                    </div>
                    <div class="options-content">
                        <div class="options-section">
                            <div class="options-section-title">Filtros rapidos</div>
                            <div class="items-grid">
                                <div class="filter-item" data-filter="none">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #667eea, #764ba2)"></div>
                                    <span>Normal</span>
                                </div>
                                <div class="filter-item" data-filter="grayscale">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #555, #888)"></div>
                                    <span>B/N</span>
                                </div>
                                <div class="filter-item" data-filter="sepia">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #704214, #c4a35a)"></div>
                                    <span>Sepia</span>
                                </div>
                                <div class="filter-item" data-filter="vintage">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #d4a574, #8b7355)"></div>
                                    <span>Vintage</span>
                                </div>
                                <div class="filter-item" data-filter="vibrant">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #ff0080, #00ff80)"></div>
                                    <span>Vibrante</span>
                                </div>
                                <div class="filter-item" data-filter="cool">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #00c9ff, #92fe9d)"></div>
                                    <span>Frio</span>
                                </div>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Ajustes de imagen</div>
                            <p class="effect-hint">Selecciona una imagen primero</p>
                            <div class="effect-slider">
                                <label>Brillo</label>
                                <input type="range" id="brightnessSlider" min="-1" max="1" step="0.1" value="0">
                                <span id="brightnessValue">0</span>
                            </div>
                            <div class="effect-slider">
                                <label>Contraste</label>
                                <input type="range" id="contrastSlider" min="-1" max="1" step="0.1" value="0">
                                <span id="contrastValue">0</span>
                            </div>
                            <div class="effect-slider">
                                <label>Saturacion</label>
                                <input type="range" id="saturationSlider" min="-1" max="1" step="0.1" value="0">
                                <span id="saturationValue">0</span>
                            </div>
                        </div>
                        <div class="options-section">
                            <div class="options-section-title">Sombras</div>
                            <div class="text-preset" data-shadow="soft">
                                <div class="text-preset-title">Sombra suave</div>
                                <div class="text-preset-sub">Efecto de profundidad sutil</div>
                            </div>
                            <div class="text-preset" data-shadow="hard">
                                <div class="text-preset-title">Sombra dura</div>
                                <div class="text-preset-sub">Borde marcado</div>
                            </div>
                            <div class="text-preset" data-shadow="glow">
                                <div class="text-preset-title">Resplandor</div>
                                <div class="text-preset-sub">Efecto neon brillante</div>
                            </div>
                            <div class="text-preset" data-shadow="none">
                                <div class="text-preset-title">Sin sombra</div>
                                <div class="text-preset-sub">Quitar efecto</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            bindPanelEvents(tool) {
                // Templates
                document.querySelectorAll('[data-template]').forEach(el => {
                    el.addEventListener('click', () => this.applyTemplate(el.dataset.template));
                });

                // Colors
                document.querySelectorAll('[data-color]').forEach(el => {
                    el.addEventListener('click', () => this.setBackgroundColor(el.dataset.color));
                });

                // Gradients
                document.querySelectorAll('[data-gradient]').forEach(el => {
                    el.addEventListener('click', () => this.setBackgroundGradient(parseInt(el.dataset.gradient)));
                });

                // Upload photo
                const uploadBtn = document.getElementById('uploadPhotoBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => document.getElementById('imageUpload').click());
                }

                // Upload background image
                const uploadBgBtn = document.getElementById('uploadBgBtn');
                if (uploadBgBtn) {
                    uploadBgBtn.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    this.setBackgroundImage(event.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                        input.click();
                    });
                }

                // Background images from library
                document.querySelectorAll('[data-bgimage]').forEach(el => {
                    el.addEventListener('click', () => {
                        const index = parseInt(el.dataset.bgimage);
                        const bg = BACKGROUND_IMAGES[index];
                        if (bg) this.setBackgroundImage(bg.url);
                    });
                });

                // Stock photos from library
                document.querySelectorAll('[data-stockphoto]').forEach(el => {
                    el.addEventListener('click', () => {
                        const index = parseInt(el.dataset.stockphoto);
                        const photo = STOCK_PHOTOS[index];
                        if (photo) this.addImage(photo.url);
                    });
                });

                // Custom photos from library
                document.querySelectorAll('[data-customphoto]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-photo-btn')) return;
                        const index = parseInt(el.dataset.customphoto);
                        const customPhotos = JSON.parse(localStorage.getItem('customPhotos') || '[]');
                        if (customPhotos[index]) this.addImage(customPhotos[index].url);
                    });
                });

                // Delete custom photos
                document.querySelectorAll('[data-deletephoto]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(el.dataset.deletephoto);
                        this.deleteCustomPhoto(index);
                    });
                });

                // Save to library button
                const saveToLibraryBtn = document.getElementById('saveToLibraryBtn');
                if (saveToLibraryBtn) {
                    saveToLibraryBtn.addEventListener('click', () => this.showSaveToLibraryDialog());
                }

                // Profile photo
                const profileBtn = document.getElementById('useProfilePhoto');
                if (profileBtn) {
                    profileBtn.addEventListener('click', () => this.addImage(CREATOR_CONFIG.fotoPerfil));
                }

                // Text presets
                document.querySelectorAll('[data-text]').forEach(el => {
                    el.addEventListener('click', () => this.addTextPreset(el.dataset.text));
                });

                document.querySelectorAll('[data-quicktext]').forEach(el => {
                    el.addEventListener('click', () => this.addQuickText(el.dataset.quicktext));
                });

                // Stickers
                document.querySelectorAll('[data-sticker]').forEach(el => {
                    el.addEventListener('click', () => this.addSticker(el.dataset.sticker));
                });

                // Emoji category tabs
                document.querySelectorAll('[data-emoji-cat]').forEach(el => {
                    el.addEventListener('click', () => this.switchEmojiCategory(el.dataset.emojiCat));
                });

                // Badges
                document.querySelectorAll('[data-badge]').forEach(el => {
                    el.addEventListener('click', () => this.addBadge(parseInt(el.dataset.badge)));
                });

                document.querySelectorAll('[data-social]').forEach(el => {
                    el.addEventListener('click', () => this.addSocialIcon(parseInt(el.dataset.social)));
                });

                // Shapes
                document.querySelectorAll('[data-shape]').forEach(el => {
                    el.addEventListener('click', () => this.addShape(el.dataset.shape));
                });

                // Filters
                document.querySelectorAll('[data-filter]').forEach(el => {
                    el.addEventListener('click', () => this.applyFilter(el.dataset.filter));
                });

                // Shadows
                document.querySelectorAll('[data-shadow]').forEach(el => {
                    el.addEventListener('click', () => this.applyShadow(el.dataset.shadow));
                });

                // Effect sliders
                const brightnessSlider = document.getElementById('brightnessSlider');
                const contrastSlider = document.getElementById('contrastSlider');
                const saturationSlider = document.getElementById('saturationSlider');

                if (brightnessSlider) {
                    brightnessSlider.addEventListener('input', (e) => {
                        document.getElementById('brightnessValue').textContent = e.target.value;
                        this.applyImageAdjustment('brightness', parseFloat(e.target.value));
                    });
                }
                if (contrastSlider) {
                    contrastSlider.addEventListener('input', (e) => {
                        document.getElementById('contrastValue').textContent = e.target.value;
                        this.applyImageAdjustment('contrast', parseFloat(e.target.value));
                    });
                }
                if (saturationSlider) {
                    saturationSlider.addEventListener('input', (e) => {
                        document.getElementById('saturationValue').textContent = e.target.value;
                        this.applyImageAdjustment('saturation', parseFloat(e.target.value));
                    });
                }
            }

            // ========== ACCIONES ==========
            loadDefaultTemplate() {
                this.applyTemplate('minimal');
            }

            applyTemplate(template) {
                this.canvas.clear();
                const f = FORMATS[this.currentFormat];
                const w = f.width;
                const h = f.height;
                const isVertical = h > w;

                // Definir gradientes
                const gradients = {
                    'minimal': [{ offset: 0, color: '#667eea' }, { offset: 1, color: '#764ba2' }],
                    'neon': [{ offset: 0, color: '#0f0c29' }, { offset: 0.5, color: '#302b63' }, { offset: 1, color: '#24243e' }],
                    'sunset': [{ offset: 0, color: '#ff512f' }, { offset: 1, color: '#f09819' }],
                    'ocean': [{ offset: 0, color: '#2193b0' }, { offset: 1, color: '#6dd5ed' }],
                    'suscribete': [{ offset: 0, color: '#667eea' }, { offset: 1, color: '#764ba2' }],
                    'vip-access': [{ offset: 0, color: '#f7971e' }, { offset: 1, color: '#ffd200' }],
                    'precio-especial': [{ offset: 0, color: '#11998e' }, { offset: 1, color: '#38ef7d' }],
                    'exclusivo': [{ offset: 0, color: '#0f0c29' }, { offset: 0.5, color: '#302b63' }, { offset: 1, color: '#24243e' }],
                    'nuevo-post': [{ offset: 0, color: '#ee9ca7' }, { offset: 1, color: '#ffdde1' }],
                    'preview': [{ offset: 0, color: '#232526' }, { offset: 1, color: '#414345' }],
                    'coming-soon': [{ offset: 0, color: '#ff512f' }, { offset: 1, color: '#f09819' }],
                    'trending': [{ offset: 0, color: '#ec4899' }, { offset: 1, color: '#8b5cf6' }],
                    'link-bio': [{ offset: 0, color: '#2193b0' }, { offset: 1, color: '#6dd5ed' }],
                    'sigueme': [{ offset: 0, color: '#f83600' }, { offset: 1, color: '#f9d423' }],
                    'gracias': [{ offset: 0, color: '#a18cd1' }, { offset: 1, color: '#fbc2eb' }],
                    'preguntame': [{ offset: 0, color: '#4facfe' }, { offset: 1, color: '#00f2fe' }],
                    // Plantillas Promo Lado
                    'promo-lado': [{ offset: 0, color: '#6366f1' }, { offset: 1, color: '#a78bfa' }],
                    'promo-lado-dark': [{ offset: 0, color: '#1e1b4b' }, { offset: 1, color: '#312e81' }],
                    'promo-lado-creator': [{ offset: 0, color: '#f59e0b' }, { offset: 1, color: '#ef4444' }],
                    'promo-lado-join': [{ offset: 0, color: '#10b981' }, { offset: 1, color: '#3b82f6' }],
                    // Plantillas Elaboradas Premium
                    'flash-sale': [{ offset: 0, color: '#ff0844' }, { offset: 1, color: '#ffb199' }],
                    'limited-time': [{ offset: 0, color: '#1a1a2e' }, { offset: 1, color: '#16213e' }],
                    'black-friday': [{ offset: 0, color: '#000000' }, { offset: 1, color: '#434343' }],
                    'giveaway': [{ offset: 0, color: '#f093fb' }, { offset: 1, color: '#f5576c' }]
                };

                const stops = gradients[template] || gradients['minimal'];
                const bgColor = new fabric.Gradient({
                    type: 'linear',
                    coords: { x1: 0, y1: 0, x2: w, y2: h },
                    colorStops: stops
                });

                this.canvas.setBackgroundColor(bgColor, this.canvas.renderAll.bind(this.canvas));

                // Aplicar elementos segun plantilla
                switch(template) {
                    case 'suscribete':
                        this._templateSuscribete(w, h, isVertical);
                        break;
                    case 'vip-access':
                        this._templateVipAccess(w, h, isVertical);
                        break;
                    case 'precio-especial':
                        this._templatePrecioEspecial(w, h, isVertical);
                        break;
                    case 'exclusivo':
                        this._templateExclusivo(w, h, isVertical);
                        break;
                    case 'nuevo-post':
                        this._templateNuevoPost(w, h, isVertical);
                        break;
                    case 'preview':
                        this._templatePreview(w, h, isVertical);
                        break;
                    case 'coming-soon':
                        this._templateComingSoon(w, h, isVertical);
                        break;
                    case 'trending':
                        this._templateTrending(w, h, isVertical);
                        break;
                    case 'link-bio':
                        this._templateLinkBio(w, h, isVertical);
                        break;
                    case 'sigueme':
                        this._templateSigueme(w, h, isVertical);
                        break;
                    case 'gracias':
                        this._templateGracias(w, h, isVertical);
                        break;
                    case 'preguntame':
                        this._templatePreguntame(w, h, isVertical);
                        break;
                    // Plantillas Promo Lado
                    case 'promo-lado':
                        this._templatePromoLado(w, h, isVertical);
                        break;
                    case 'promo-lado-dark':
                        this._templatePromoLadoDark(w, h, isVertical);
                        break;
                    case 'promo-lado-creator':
                        this._templatePromoLadoCreator(w, h, isVertical);
                        break;
                    case 'promo-lado-join':
                        this._templatePromoLadoJoin(w, h, isVertical);
                        break;
                    // Plantillas Elaboradas Premium
                    case 'flash-sale':
                        this._templateFlashSale(w, h, isVertical);
                        break;
                    case 'limited-time':
                        this._templateLimitedTime(w, h, isVertical);
                        break;
                    case 'black-friday':
                        this._templateBlackFriday(w, h, isVertical);
                        break;
                    case 'giveaway':
                        this._templateGiveaway(w, h, isVertical);
                        break;
                    default:
                        // Plantillas minimalistas - solo username
                        this._templateMinimal(w, h);
                        break;
                }

                this.canvas.renderAll();
                this.saveHistory();
            }

            // ========== PLANTILLAS FUNCIONALES ==========
            _templateMinimal(w, h) {
                const text = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h / 2,
                    fontSize: 72,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10, offsetX: 2, offsetY: 2 })
                });
                this.canvas.add(text);
            }

            _templateSuscribete(w, h, isVertical) {
                // Titulo principal
                const titulo = new fabric.IText('SUSCRIBETE', {
                    left: w / 2,
                    top: isVertical ? h * 0.2 : h * 0.25,
                    fontSize: isVertical ? 80 : 90,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.4)', blur: 15, offsetX: 0, offsetY: 4 })
                });

                // Subtitulo
                const subtitulo = new fabric.IText('Contenido exclusivo cada semana', {
                    left: w / 2,
                    top: isVertical ? h * 0.28 : h * 0.38,
                    fontSize: isVertical ? 32 : 28,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.9)',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h / 2,
                    fontSize: isVertical ? 64 : 56,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 8, offsetX: 2, offsetY: 2 })
                });

                // Precio (si existe)
                if (CREATOR_CONFIG.precio > 0) {
                    const precio = new fabric.IText('$' + CREATOR_CONFIG.precio + '/mes', {
                        left: w / 2,
                        top: isVertical ? h * 0.62 : h * 0.65,
                        fontSize: isVertical ? 48 : 42,
                        fontFamily: 'Montserrat',
                        fontWeight: 'bold',
                        fill: '#ffffff',
                        originX: 'center',
                        originY: 'center'
                    });
                    this.canvas.add(precio);
                }

                // CTA
                const cta = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.8,
                    width: 280,
                    height: 60,
                    fill: '#ffffff',
                    rx: 30,
                    ry: 30,
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.2)', blur: 10, offsetX: 0, offsetY: 4 })
                });

                const ctaText = new fabric.IText('Link en bio', {
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.8,
                    fontSize: 24,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#667eea',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(titulo, subtitulo, username, cta, ctaText);
            }

            _templateVipAccess(w, h, isVertical) {
                // Corona emoji
                const corona = new fabric.IText('ğŸ‘‘', {
                    left: w / 2,
                    top: isVertical ? h * 0.18 : h * 0.2,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('ACCESO VIP', {
                    left: w / 2,
                    top: isVertical ? h * 0.32 : h * 0.38,
                    fontSize: isVertical ? 72 : 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10, offsetX: 0, offsetY: 3 })
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h / 2,
                    fontSize: 48,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Beneficios
                const beneficios = new fabric.IText('âœ“ Fotos exclusivas\nâœ“ Videos privados\nâœ“ Mensajes directos', {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.7,
                    fontSize: 26,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center',
                    lineHeight: 1.5
                });

                this.canvas.add(corona, titulo, username, beneficios);
            }

            _templatePrecioEspecial(w, h, isVertical) {
                // Badge oferta
                const badge = new fabric.Circle({
                    left: w * 0.8,
                    top: h * 0.15,
                    radius: 60,
                    fill: '#ef4444',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10 })
                });

                const badgeText = new fabric.IText('OFERTA', {
                    left: w * 0.8,
                    top: h * 0.15,
                    fontSize: 18,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('PRECIO ESPECIAL', {
                    left: w / 2,
                    top: isVertical ? h * 0.28 : h * 0.3,
                    fontSize: isVertical ? 64 : 70,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h * 0.45,
                    fontSize: 42,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Precio
                const precioText = CREATOR_CONFIG.precio > 0 ? '$' + CREATOR_CONFIG.precio : 'GRATIS';
                const precio = new fabric.IText(precioText, {
                    left: w / 2,
                    top: h * 0.6,
                    fontSize: 72,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 8 })
                });

                // Tiempo limitado
                const tiempo = new fabric.IText('Por tiempo limitado', {
                    left: w / 2,
                    top: isVertical ? h * 0.72 : h * 0.75,
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fontStyle: 'italic',
                    fill: 'rgba(255,255,255,0.9)',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(badge, badgeText, titulo, username, precio, tiempo);
            }

            _templateExclusivo(w, h, isVertical) {
                // Linea decorativa superior
                const lineaTop = new fabric.Line([w * 0.2, h * 0.15, w * 0.8, h * 0.15], {
                    stroke: 'rgba(255,255,255,0.3)',
                    strokeWidth: 2
                });

                // Icono
                const icono = new fabric.IText('ğŸ”’', {
                    left: w / 2,
                    top: isVertical ? h * 0.25 : h * 0.28,
                    fontSize: 60,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('CONTENIDO\nEXCLUSIVO', {
                    left: w / 2,
                    top: isVertical ? h * 0.4 : h * 0.45,
                    fontSize: isVertical ? 60 : 65,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center',
                    lineHeight: 1.1,
                    shadow: new fabric.Shadow({ color: 'rgba(99,102,241,0.5)', blur: 20, offsetX: 0, offsetY: 0 })
                });

                // Username con glow
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.58 : h * 0.65,
                    fontSize: 44,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(139,92,246,0.8)', blur: 25 })
                });

                // Subtitulo
                const sub = new fabric.IText('Solo para suscriptores', {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.78,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.7)',
                    originX: 'center',
                    originY: 'center'
                });

                // Linea decorativa inferior
                const lineaBot = new fabric.Line([w * 0.2, h * 0.85, w * 0.8, h * 0.85], {
                    stroke: 'rgba(255,255,255,0.3)',
                    strokeWidth: 2
                });

                this.canvas.add(lineaTop, icono, titulo, username, sub, lineaBot);
            }

            _templateNuevoPost(w, h, isVertical) {
                // Badge NUEVO
                const badge = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    width: 160,
                    height: 45,
                    fill: '#ef4444',
                    rx: 22,
                    ry: 22,
                    originX: 'center',
                    originY: 'center'
                });

                const badgeText = new fabric.IText('NUEVO', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: 22,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Icono de foto
                const icono = new fabric.IText('ğŸ“¸', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.4,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // Texto principal
                const titulo = new fabric.IText('Nuevo contenido\ndisponible', {
                    left: w / 2,
                    top: h * 0.55,
                    fontSize: isVertical ? 48 : 44,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#333333',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center',
                    lineHeight: 1.2
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.72 : h * 0.75,
                    fontSize: 36,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ec4899',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(badge, badgeText, icono, titulo, username);
            }

            _templatePreview(w, h, isVertical) {
                // Efecto blur overlay
                const overlay = new fabric.Rect({
                    left: w / 2,
                    top: h / 2,
                    width: w * 0.85,
                    height: h * 0.5,
                    fill: 'rgba(255,255,255,0.1)',
                    rx: 20,
                    ry: 20,
                    originX: 'center',
                    originY: 'center'
                });

                // Icono ojo
                const icono = new fabric.IText('ğŸ‘€', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.38,
                    fontSize: 70,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('PREVIEW', {
                    left: w / 2,
                    top: h * 0.5,
                    fontSize: isVertical ? 72 : 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Subtitulo
                const sub = new fabric.IText('Suscribete para ver el contenido completo', {
                    left: w / 2,
                    top: isVertical ? h * 0.6 : h * 0.62,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.8)',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.75 : h * 0.78,
                    fontSize: 40,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(overlay, icono, titulo, sub, username);
            }

            _templateComingSoon(w, h, isVertical) {
                // Icono fuego
                const icono = new fabric.IText('ğŸ”¥', {
                    left: w / 2,
                    top: isVertical ? h * 0.22 : h * 0.25,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('MUY PRONTO', {
                    left: w / 2,
                    top: isVertical ? h * 0.38 : h * 0.42,
                    fontSize: isVertical ? 68 : 75,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.4)', blur: 10 })
                });

                // Descripcion
                const desc = new fabric.IText('Algo increible viene en camino...', {
                    left: w / 2,
                    top: h * 0.52,
                    fontSize: 26,
                    fontFamily: 'Inter',
                    fontStyle: 'italic',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.7,
                    fontSize: 44,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Notificacion
                const noti = new fabric.IText('Activa las notificaciones', {
                    left: w / 2,
                    top: isVertical ? h * 0.82 : h * 0.85,
                    fontSize: 20,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.8)',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(icono, titulo, desc, username, noti);
            }

            _templateTrending(w, h, isVertical) {
                // Badge trending
                const badge = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    width: 180,
                    height: 45,
                    fill: '#ffffff',
                    rx: 22,
                    ry: 22,
                    originX: 'center',
                    originY: 'center'
                });

                const badgeText = new fabric.IText('ğŸ“ˆ TRENDING', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: 18,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ec4899',
                    originX: 'center',
                    originY: 'center'
                });

                // Estrellas
                const estrellas = new fabric.IText('âœ¨', {
                    left: w / 2,
                    top: isVertical ? h * 0.28 : h * 0.32,
                    fontSize: 60,
                    originX: 'center',
                    originY: 'center'
                });

                // Username grande
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h * 0.45,
                    fontSize: isVertical ? 56 : 52,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10 })
                });

                // Subtitulo
                const sub = new fabric.IText('El contenido que todos buscan', {
                    left: w / 2,
                    top: isVertical ? h * 0.56 : h * 0.58,
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.9)',
                    originX: 'center',
                    originY: 'center'
                });

                // CTA
                const cta = new fabric.IText('No te lo pierdas', {
                    left: w / 2,
                    top: isVertical ? h * 0.75 : h * 0.78,
                    fontSize: 28,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(badge, badgeText, estrellas, username, sub, cta);
            }

            _templateLinkBio(w, h, isVertical) {
                // Icono link
                const icono = new fabric.IText('ğŸ”—', {
                    left: w / 2,
                    top: isVertical ? h * 0.2 : h * 0.22,
                    fontSize: 70,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('LINK EN BIO', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.38,
                    fontSize: isVertical ? 72 : 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h * 0.5,
                    fontSize: 48,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Flecha
                const flecha = new fabric.IText('â¬‡ï¸', {
                    left: w / 2,
                    top: isVertical ? h * 0.65 : h * 0.68,
                    fontSize: 50,
                    originX: 'center',
                    originY: 'center'
                });

                // Instruccion
                const inst = new fabric.IText('Entra a mi perfil y haz clic en el link', {
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.82,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center'
                });

                this.canvas.add(icono, titulo, username, flecha, inst);
            }

            _templateSigueme(w, h, isVertical) {
                // Icono corazon
                const icono = new fabric.IText('â¤ï¸', {
                    left: w / 2,
                    top: isVertical ? h * 0.2 : h * 0.22,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('SIGUEME', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.4,
                    fontSize: isVertical ? 80 : 90,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10 })
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: h * 0.52,
                    fontSize: 52,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Motivo
                const motivo = new fabric.IText('Para no perderte nada', {
                    left: w / 2,
                    top: isVertical ? h * 0.65 : h * 0.68,
                    fontSize: 28,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Emojis sociales
                const sociales = new fabric.IText('ğŸ“± ğŸ’¬ ğŸ””', {
                    left: w / 2,
                    top: isVertical ? h * 0.8 : h * 0.82,
                    fontSize: 40,
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(icono, titulo, username, motivo, sociales);
            }

            _templateGracias(w, h, isVertical) {
                // Corazones
                const corazones = new fabric.IText('ğŸ’œğŸ’–ğŸ’œ', {
                    left: w / 2,
                    top: isVertical ? h * 0.18 : h * 0.2,
                    fontSize: 50,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('GRACIAS', {
                    left: w / 2,
                    top: isVertical ? h * 0.32 : h * 0.35,
                    fontSize: isVertical ? 80 : 90,
                    fontFamily: 'Pacifico',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.2)', blur: 10 })
                });

                // Mensaje
                const mensaje = new fabric.IText('Por todo su apoyo y carino', {
                    left: w / 2,
                    top: h * 0.48,
                    fontSize: 28,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.62 : h * 0.65,
                    fontSize: 44,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Estrellas
                const estrellas = new fabric.IText('âœ¨ Los quiero âœ¨', {
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.8,
                    fontSize: 26,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(corazones, titulo, mensaje, username, estrellas);
            }

            _templatePreguntame(w, h, isVertical) {
                // Icono pregunta
                const icono = new fabric.IText('â“', {
                    left: w / 2,
                    top: isVertical ? h * 0.18 : h * 0.2,
                    fontSize: 70,
                    originX: 'center',
                    originY: 'center'
                });

                // Titulo
                const titulo = new fabric.IText('PREGUNTAME', {
                    left: w / 2,
                    top: isVertical ? h * 0.32 : h * 0.35,
                    fontSize: isVertical ? 68 : 75,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Subtitulo
                const sub = new fabric.IText('Lo que quieras saber', {
                    left: w / 2,
                    top: isVertical ? h * 0.42 : h * 0.46,
                    fontSize: 26,
                    fontFamily: 'Inter',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Caja de pregunta simulada
                const caja = new fabric.Rect({
                    left: w / 2,
                    top: h * 0.58,
                    width: w * 0.75,
                    height: 80,
                    fill: 'rgba(255,255,255,0.2)',
                    rx: 15,
                    ry: 15,
                    originX: 'center',
                    originY: 'center'
                });

                const placeholder = new fabric.IText('Escribe tu pregunta...', {
                    left: w / 2,
                    top: h * 0.58,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.6)',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.8,
                    fontSize: 40,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(icono, titulo, sub, caja, placeholder, username);
            }

            // ========== PLANTILLAS PROMO LADO ==========
            _templatePromoLado(w, h, isVertical) {
                // Logo/Brand text
                const brand = new fabric.IText('LADO', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: isVertical ? 90 : 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 15 })
                });

                // Tagline
                const tagline = new fabric.IText('Tu plataforma de contenido exclusivo', {
                    left: w / 2,
                    top: isVertical ? h * 0.2 : h * 0.25,
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.9)',
                    originX: 'center',
                    originY: 'center'
                });

                // Emoji highlight
                const emoji = new fabric.IText('âœ¨', {
                    left: w / 2,
                    top: h * 0.35,
                    fontSize: 60,
                    originX: 'center',
                    originY: 'center'
                });

                // Feature boxes
                const features = ['Contenido Premium', 'Creadores Verificados', 'Suscripciones Exclusivas'];
                features.forEach((feat, i) => {
                    const box = new fabric.Rect({
                        left: w / 2,
                        top: isVertical ? h * (0.42 + i * 0.1) : h * (0.45 + i * 0.12),
                        width: w * 0.7,
                        height: 50,
                        fill: 'rgba(255,255,255,0.15)',
                        rx: 25,
                        ry: 25,
                        originX: 'center',
                        originY: 'center'
                    });
                    const text = new fabric.IText('âœ“ ' + feat, {
                        left: w / 2,
                        top: isVertical ? h * (0.42 + i * 0.1) : h * (0.45 + i * 0.12),
                        fontSize: 20,
                        fontFamily: 'Inter',
                        fontWeight: '600',
                        fill: '#ffffff',
                        originX: 'center',
                        originY: 'center'
                    });
                    this.canvas.add(box, text);
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.78 : h * 0.85,
                    fontSize: 36,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // CTA
                const cta = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.88 : h * 0.92,
                    width: 200,
                    height: 50,
                    fill: '#ffffff',
                    rx: 25,
                    ry: 25,
                    originX: 'center',
                    originY: 'center'
                });

                const ctaText = new fabric.IText('Unete ahora', {
                    left: w / 2,
                    top: isVertical ? h * 0.88 : h * 0.92,
                    fontSize: 18,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#6366f1',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(brand, tagline, emoji, username, cta, ctaText);
            }

            _templatePromoLadoDark(w, h, isVertical) {
                // Decorative circles
                const circle1 = new fabric.Circle({
                    left: w * 0.1,
                    top: h * 0.1,
                    radius: 100,
                    fill: 'rgba(99, 102, 241, 0.2)',
                    originX: 'center',
                    originY: 'center'
                });

                const circle2 = new fabric.Circle({
                    left: w * 0.9,
                    top: h * 0.8,
                    radius: 150,
                    fill: 'rgba(167, 139, 250, 0.15)',
                    originX: 'center',
                    originY: 'center'
                });

                // Brand
                const brand = new fabric.IText('LADO', {
                    left: w / 2,
                    top: isVertical ? h * 0.15 : h * 0.2,
                    fontSize: 100,
                    fontFamily: 'Bebas Neue',
                    fill: '#a78bfa',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: '#6366f1', blur: 30 })
                });

                // Main message
                const mensaje = new fabric.IText('CONTENIDO\nEXCLUSIVO', {
                    left: w / 2,
                    top: h * 0.4,
                    fontSize: isVertical ? 70 : 60,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });

                // Description
                const desc = new fabric.IText('Suscribete y accede a contenido\nque no encontraras en otro lugar', {
                    left: w / 2,
                    top: isVertical ? h * 0.55 : h * 0.58,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.8)',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.72 : h * 0.75,
                    fontSize: 40,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#a78bfa',
                    originX: 'center',
                    originY: 'center'
                });

                // Stars decoration
                const stars = new fabric.IText('â­ â­ â­', {
                    left: w / 2,
                    top: isVertical ? h * 0.85 : h * 0.88,
                    fontSize: 30,
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(circle1, circle2, brand, mensaje, desc, username, stars);
            }

            _templatePromoLadoCreator(w, h, isVertical) {
                // Fire emoji top
                const fire = new fabric.IText('ğŸ”¥', {
                    left: w / 2,
                    top: isVertical ? h * 0.1 : h * 0.12,
                    fontSize: 70,
                    originX: 'center',
                    originY: 'center'
                });

                // Main title
                const titulo = new fabric.IText('SE UN CREADOR', {
                    left: w / 2,
                    top: isVertical ? h * 0.22 : h * 0.25,
                    fontSize: isVertical ? 65 : 55,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.4)', blur: 10 })
                });

                // Subtitle
                const sub = new fabric.IText('en LADO', {
                    left: w / 2,
                    top: isVertical ? h * 0.32 : h * 0.35,
                    fontSize: 50,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Benefits
                const benefits = [
                    'ğŸ’° Monetiza tu contenido',
                    'ğŸ¯ Llega a tu audiencia',
                    'ğŸš€ Sin limites de ganancias',
                    'ğŸ”’ Tu contenido protegido'
                ];

                benefits.forEach((b, i) => {
                    const text = new fabric.IText(b, {
                        left: w * 0.15,
                        top: isVertical ? h * (0.45 + i * 0.08) : h * (0.48 + i * 0.1),
                        fontSize: 22,
                        fontFamily: 'Inter',
                        fontWeight: '500',
                        fill: '#ffffff',
                        originX: 'left',
                        originY: 'center'
                    });
                    this.canvas.add(text);
                });

                // CTA button
                const cta = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.82 : h * 0.88,
                    width: 280,
                    height: 60,
                    fill: '#ffffff',
                    rx: 30,
                    ry: 30,
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 15 })
                });

                const ctaText = new fabric.IText('Empieza hoy', {
                    left: w / 2,
                    top: isVertical ? h * 0.82 : h * 0.88,
                    fontSize: 22,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ef4444',
                    originX: 'center',
                    originY: 'center'
                });

                // URL
                const url = new fabric.IText('ladoapp.com', {
                    left: w / 2,
                    top: isVertical ? h * 0.92 : h * 0.95,
                    fontSize: 18,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.8)',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(fire, titulo, sub, cta, ctaText, url);
            }

            _templatePromoLadoJoin(w, h, isVertical) {
                // Rocket emoji
                const rocket = new fabric.IText('ğŸš€', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // Title
                const titulo = new fabric.IText('UNETE A', {
                    left: w / 2,
                    top: isVertical ? h * 0.25 : h * 0.28,
                    fontSize: 50,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // LADO brand
                const brand = new fabric.IText('LADO', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.4,
                    fontSize: 120,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 20 })
                });

                // Description
                const desc = new fabric.IText('La comunidad de creadores\nmas grande de habla hispana', {
                    left: w / 2,
                    top: isVertical ? h * 0.5 : h * 0.55,
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.9)',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });

                // Stats boxes
                const stats = [
                    { num: '10K+', label: 'Creadores' },
                    { num: '50K+', label: 'Usuarios' },
                    { num: '$$$', label: 'Ganancias' }
                ];

                stats.forEach((s, i) => {
                    const boxX = w * (0.2 + i * 0.3);
                    const box = new fabric.Rect({
                        left: boxX,
                        top: isVertical ? h * 0.65 : h * 0.7,
                        width: w * 0.25,
                        height: 80,
                        fill: 'rgba(255,255,255,0.15)',
                        rx: 15,
                        ry: 15,
                        originX: 'center',
                        originY: 'center'
                    });
                    const num = new fabric.IText(s.num, {
                        left: boxX,
                        top: isVertical ? h * 0.63 : h * 0.68,
                        fontSize: 28,
                        fontFamily: 'Montserrat',
                        fontWeight: 'bold',
                        fill: '#ffffff',
                        originX: 'center',
                        originY: 'center'
                    });
                    const label = new fabric.IText(s.label, {
                        left: boxX,
                        top: isVertical ? h * 0.69 : h * 0.74,
                        fontSize: 14,
                        fontFamily: 'Inter',
                        fill: 'rgba(255,255,255,0.8)',
                        originX: 'center',
                        originY: 'center'
                    });
                    this.canvas.add(box, num, label);
                });

                // Username
                const username = new fabric.IText('Sigueme: @@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.85 : h * 0.88,
                    fontSize: 26,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(rocket, titulo, brand, desc, username);
            }

            // ========== PLANTILLAS ELABORADAS PREMIUM ==========
            _templateFlashSale(w, h, isVertical) {
                // Lightning emoji
                const lightning = new fabric.IText('âš¡', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // FLASH
                const flash = new fabric.IText('FLASH', {
                    left: w / 2,
                    top: isVertical ? h * 0.25 : h * 0.28,
                    fontSize: 90,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // SALE
                const sale = new fabric.IText('SALE', {
                    left: w / 2,
                    top: isVertical ? h * 0.36 : h * 0.42,
                    fontSize: 100,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 15 })
                });

                // Discount
                const discount = new fabric.IText('-50%', {
                    left: w / 2,
                    top: isVertical ? h * 0.52 : h * 0.58,
                    fontSize: 120,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffff00',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 10 })
                });

                // Timer box
                const timerBox = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.72,
                    width: w * 0.6,
                    height: 50,
                    fill: 'rgba(0,0,0,0.5)',
                    rx: 10,
                    ry: 10,
                    originX: 'center',
                    originY: 'center'
                });

                const timer = new fabric.IText('â° Solo por 24 horas', {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.72,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.85 : h * 0.88,
                    fontSize: 36,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(lightning, flash, sale, discount, timerBox, timer, username);
            }

            _templateLimitedTime(w, h, isVertical) {
                // Clock emoji
                const clock = new fabric.IText('â³', {
                    left: w / 2,
                    top: isVertical ? h * 0.12 : h * 0.15,
                    fontSize: 70,
                    originX: 'center',
                    originY: 'center'
                });

                // LIMITED
                const limited = new fabric.IText('LIMITED', {
                    left: w / 2,
                    top: isVertical ? h * 0.25 : h * 0.28,
                    fontSize: 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#f59e0b',
                    originX: 'center',
                    originY: 'center'
                });

                // TIME OFFER
                const offer = new fabric.IText('TIME OFFER', {
                    left: w / 2,
                    top: isVertical ? h * 0.35 : h * 0.4,
                    fontSize: 60,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Price info
                const priceOld = new fabric.IText('Antes: $19.99', {
                    left: w / 2,
                    top: isVertical ? h * 0.48 : h * 0.52,
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.6)',
                    originX: 'center',
                    originY: 'center',
                    linethrough: true
                });

                const priceNew = new fabric.IText('AHORA: $9.99', {
                    left: w / 2,
                    top: isVertical ? h * 0.56 : h * 0.6,
                    fontSize: 40,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#10b981',
                    originX: 'center',
                    originY: 'center'
                });

                // Urgency
                const urgency = new fabric.IText('Quedan pocas unidades', {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.72,
                    fontSize: 22,
                    fontFamily: 'Inter',
                    fill: '#ef4444',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.85 : h * 0.88,
                    fontSize: 36,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(clock, limited, offer, priceOld, priceNew, urgency, username);
            }

            _templateBlackFriday(w, h, isVertical) {
                // Black Friday text
                const black = new fabric.IText('BLACK', {
                    left: w / 2,
                    top: isVertical ? h * 0.18 : h * 0.2,
                    fontSize: 100,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                const friday = new fabric.IText('FRIDAY', {
                    left: w / 2,
                    top: isVertical ? h * 0.3 : h * 0.35,
                    fontSize: 100,
                    fontFamily: 'Bebas Neue',
                    fill: '#f59e0b',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: '#f59e0b', blur: 20 })
                });

                // Discount badge
                const badge = new fabric.Circle({
                    left: w * 0.75,
                    top: h * 0.2,
                    radius: 60,
                    fill: '#ef4444',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 15 })
                });

                const badgeText = new fabric.IText('-70%', {
                    left: w * 0.75,
                    top: h * 0.2,
                    fontSize: 36,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Main offer
                const mainOffer = new fabric.IText('DESCUENTOS\nINCREIBLES', {
                    left: w / 2,
                    top: h * 0.5,
                    fontSize: 55,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });

                // Timer
                const timerBg = new fabric.Rect({
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.7,
                    width: w * 0.8,
                    height: 60,
                    fill: '#f59e0b',
                    rx: 10,
                    ry: 10,
                    originX: 'center',
                    originY: 'center'
                });

                const timerText = new fabric.IText('Solo este viernes', {
                    left: w / 2,
                    top: isVertical ? h * 0.68 : h * 0.7,
                    fontSize: 26,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#000000',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.85 : h * 0.88,
                    fontSize: 36,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(black, friday, badge, badgeText, mainOffer, timerBg, timerText, username);
            }

            _templateGiveaway(w, h, isVertical) {
                // Gift emoji
                const gift = new fabric.IText('ğŸ', {
                    left: w / 2,
                    top: isVertical ? h * 0.1 : h * 0.12,
                    fontSize: 80,
                    originX: 'center',
                    originY: 'center'
                });

                // GIVEAWAY
                const giveaway = new fabric.IText('GIVEAWAY', {
                    left: w / 2,
                    top: isVertical ? h * 0.22 : h * 0.25,
                    fontSize: 80,
                    fontFamily: 'Bebas Neue',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10 })
                });

                // Prize
                const prize = new fabric.IText('GANA UN MES GRATIS', {
                    left: w / 2,
                    top: isVertical ? h * 0.34 : h * 0.38,
                    fontSize: 32,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                // Steps
                const steps = [
                    '1. Sigueme',
                    '2. Dale like a este post',
                    '3. Etiqueta a 2 amigos',
                    '4. Comparte en tu historia'
                ];

                steps.forEach((s, i) => {
                    const stepBox = new fabric.Rect({
                        left: w / 2,
                        top: isVertical ? h * (0.45 + i * 0.09) : h * (0.48 + i * 0.1),
                        width: w * 0.75,
                        height: 45,
                        fill: 'rgba(255,255,255,0.15)',
                        rx: 10,
                        ry: 10,
                        originX: 'center',
                        originY: 'center'
                    });
                    const stepText = new fabric.IText(s, {
                        left: w / 2,
                        top: isVertical ? h * (0.45 + i * 0.09) : h * (0.48 + i * 0.1),
                        fontSize: 20,
                        fontFamily: 'Inter',
                        fontWeight: '500',
                        fill: '#ffffff',
                        originX: 'center',
                        originY: 'center'
                    });
                    this.canvas.add(stepBox, stepText);
                });

                // End date
                const endDate = new fabric.IText('Sorteo: 31 de Diciembre', {
                    left: w / 2,
                    top: isVertical ? h * 0.82 : h * 0.88,
                    fontSize: 20,
                    fontFamily: 'Inter',
                    fill: 'rgba(255,255,255,0.8)',
                    originX: 'center',
                    originY: 'center'
                });

                // Username
                const username = new fabric.IText('@@' + CREATOR_CONFIG.seudonimo, {
                    left: w / 2,
                    top: isVertical ? h * 0.9 : h * 0.94,
                    fontSize: 30,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(gift, giveaway, prize, endDate, username);
            }

            setBackgroundColor(color) {
                this.canvas.setBackgroundColor(color, this.canvas.renderAll.bind(this.canvas));
                this.saveHistory();
            }

            setBackgroundGradient(index) {
                const g = GRADIENTS[index];
                const f = FORMATS[this.currentFormat];
                const gradient = new fabric.Gradient({
                    type: 'linear',
                    coords: { x1: 0, y1: 0, x2: f.width, y2: f.height },
                    colorStops: g.colors.map((c, i) => ({ offset: i / (g.colors.length - 1), color: c }))
                });
                this.canvas.setBackgroundColor(gradient, this.canvas.renderAll.bind(this.canvas));
                this.saveHistory();
            }

            setBackgroundImage(url) {
                const self = this;
                const f = FORMATS[this.currentFormat];

                this.showToast('Cargando imagen de fondo...', 'info');

                fabric.Image.fromURL(url, function(img) {
                    if (!img) {
                        self.showToast('Error al cargar la imagen', 'error');
                        return;
                    }

                    // Escalar para cubrir todo el canvas
                    const scaleX = f.width / img.width;
                    const scaleY = f.height / img.height;
                    const scale = Math.max(scaleX, scaleY);

                    img.set({
                        scaleX: scale,
                        scaleY: scale,
                        originX: 'center',
                        originY: 'center',
                        left: f.width / 2,
                        top: f.height / 2
                    });

                    self.canvas.setBackgroundImage(img, self.canvas.renderAll.bind(self.canvas));
                    self.saveHistory();
                    self.showToast('Fondo aplicado', 'success');
                }, { crossOrigin: 'anonymous' });
            }

            addImage(url) {
                fabric.Image.fromURL(url, (img) => {
                    const f = FORMATS[this.currentFormat];
                    const maxSize = Math.min(f.width, f.height) * 0.4;
                    const scale = maxSize / Math.max(img.width, img.height);

                    img.set({
                        left: f.width / 2,
                        top: f.height / 2,
                        scaleX: scale,
                        scaleY: scale,
                        originX: 'center',
                        originY: 'center'
                    });

                    this.canvas.add(img);
                    this.canvas.setActiveObject(img);
                    this.canvas.renderAll();
                    this.saveHistory();
                }, { crossOrigin: 'anonymous' });
            }

            handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    this.addImage(event.target.result);
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            }

            addTextPreset(type) {
                const f = FORMATS[this.currentFormat];
                let fontSize = 48;
                let fontWeight = 'normal';
                let textContent = 'Texto';

                switch(type) {
                    case 'heading':
                        textContent = 'Titulo';
                        fontSize = 72;
                        fontWeight = 'bold';
                        break;
                    case 'subheading':
                        textContent = 'Subtitulo';
                        fontSize = 48;
                        fontWeight = 'bold';
                        break;
                    case 'body':
                        textContent = 'Escribe aqui...';
                        fontSize = 32;
                        fontWeight = 'normal';
                        break;
                }

                const text = new fabric.IText(textContent, {
                    left: f.width / 2 - 80,
                    top: f.height / 2 - fontSize / 2,
                    fill: '#ffffff',
                    fontFamily: 'Montserrat',
                    fontSize: fontSize,
                    fontWeight: fontWeight,
                    objectCaching: false,
                    noScaleCache: true,
                    strokeUniform: true,
                    paintFirst: 'stroke'
                });
                this.canvas.add(text);
                this.canvas.setActiveObject(text);
                this.canvas.renderAll();
                this.saveHistory();
            }

            addQuickText(content) {
                const f = FORMATS[this.currentFormat];
                const text = new fabric.IText(content, {
                    left: f.width / 2 - 80,
                    top: f.height / 2 - 28,
                    fontSize: 56,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    objectCaching: false,
                    noScaleCache: true,
                    strokeUniform: true,
                    paintFirst: 'stroke',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 8, offsetX: 2, offsetY: 2 })
                });

                this.canvas.add(text);
                this.canvas.setActiveObject(text);
                this.canvas.renderAll();
                this.saveHistory();
            }

            addSticker(emoji, size = 80) {
                const f = FORMATS[this.currentFormat];
                const text = new fabric.IText(emoji, {
                    left: f.width / 2 - size / 2,
                    top: f.height / 2 - size / 2,
                    fontSize: size,
                    objectCaching: false,
                    noScaleCache: true
                });

                this.canvas.add(text);
                this.canvas.setActiveObject(text);
                this.canvas.renderAll();
                this.saveHistory();
            }

            addSocialIcon(index) {
                const icon = SOCIAL_ICONS[index];
                const f = FORMATS[this.currentFormat];
                const self = this;

                // TamaÃ±o del icono (mÃ¡s pequeÃ±o para verse proporcional)
                const iconSize = 80;
                const svgSize = 48; // TamaÃ±o del SVG dentro del fondo

                // Crear SVG completo como string
                const svgString = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${svgSize}" height="${svgSize}">
                        <path d="${icon.svg}" fill="${icon.iconColor || '#fff'}"/>
                    </svg>
                `;

                // Cargar SVG usando fabric
                fabric.loadSVGFromString(svgString, function(objects, options) {
                    if (!objects || objects.length === 0) {
                        console.error('No se pudo cargar el SVG');
                        self.addSocialIconFallback(icon, f, iconSize);
                        return;
                    }

                    const svgGroup = fabric.util.groupSVGElements(objects, options);
                    svgGroup.set({
                        originX: 'center',
                        originY: 'center'
                    });

                    // Crear fondo
                    let bgShape;
                    if (icon.gradient && icon.gradient.length > 0) {
                        bgShape = new fabric.Rect({
                            width: iconSize,
                            height: iconSize,
                            rx: 16,
                            ry: 16,
                            originX: 'center',
                            originY: 'center'
                        });
                        bgShape.set('fill', new fabric.Gradient({
                            type: 'radial',
                            coords: { x1: iconSize * 0.1, y1: iconSize * 0.9, x2: iconSize * 0.5, y2: iconSize * 0.5, r1: 0, r2: iconSize * 0.7 },
                            colorStops: [
                                { offset: 0, color: icon.gradient[0] },
                                { offset: 0.25, color: icon.gradient[1] },
                                { offset: 0.5, color: icon.gradient[2] },
                                { offset: 0.75, color: icon.gradient[3] },
                                { offset: 1, color: icon.gradient[4] }
                            ]
                        }));
                    } else {
                        bgShape = new fabric.Rect({
                            width: iconSize,
                            height: iconSize,
                            rx: 16,
                            ry: 16,
                            fill: icon.color,
                            originX: 'center',
                            originY: 'center'
                        });
                    }

                    const group = new fabric.Group([bgShape, svgGroup], {
                        left: f.width / 2,
                        top: f.height / 2,
                        originX: 'center',
                        originY: 'center'
                    });

                    self.canvas.add(group);
                    self.canvas.setActiveObject(group);
                    self.canvas.renderAll();
                    self.saveHistory();
                    console.log('Icono social agregado:', icon.name);
                });
            }

            // Fallback si el SVG falla - usa letra inicial
            addSocialIconFallback(icon, f, iconSize) {
                const abbr = icon.name.charAt(0).toUpperCase();

                const bgShape = new fabric.Rect({
                    width: iconSize,
                    height: iconSize,
                    rx: 16,
                    ry: 16,
                    fill: icon.color,
                    originX: 'center',
                    originY: 'center'
                });

                const text = new fabric.Text(abbr, {
                    fontSize: 36,
                    fill: icon.iconColor || '#fff',
                    originX: 'center',
                    originY: 'center',
                    fontFamily: 'Arial',
                    fontWeight: 'bold'
                });

                const group = new fabric.Group([bgShape, text], {
                    left: f.width / 2,
                    top: f.height / 2,
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(group);
                this.canvas.setActiveObject(group);
                this.canvas.renderAll();
                this.saveHistory();
            }

            switchEmojiCategory(category) {
                // Actualizar tabs activos
                document.querySelectorAll('.emoji-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.emojiCat === category);
                });

                // Actualizar grid de emojis
                const grid = document.getElementById('emojiGrid');
                if (grid && EMOJI_CATEGORIES[category]) {
                    grid.innerHTML = EMOJI_CATEGORIES[category].map(s =>
                        `<div class="sticker-item" data-sticker="${s}">${s}</div>`
                    ).join('');

                    // Re-bind eventos para los nuevos emojis
                    grid.querySelectorAll('[data-sticker]').forEach(el => {
                        el.addEventListener('click', () => this.addSticker(el.dataset.sticker));
                    });
                }
            }

            addBadge(index) {
                const badge = BADGES[index];
                const f = FORMATS[this.currentFormat];

                // Crear badge con fondo redondeado
                const paddingX = 24;
                const paddingY = 12;
                const fontSize = 28;

                // Texto temporal para medir
                const tempText = new fabric.Text(badge.text, {
                    fontSize: fontSize,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold'
                });

                const textWidth = tempText.width;
                const textHeight = tempText.height;

                const rect = new fabric.Rect({
                    width: textWidth + paddingX * 2,
                    height: textHeight + paddingY * 2,
                    fill: badge.bg,
                    rx: (textHeight + paddingY * 2) / 2,
                    ry: (textHeight + paddingY * 2) / 2,
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 10, offsetX: 0, offsetY: 4 })
                });

                const text = new fabric.Text(badge.text, {
                    fontSize: fontSize,
                    fontFamily: 'Montserrat',
                    fontWeight: 'bold',
                    fill: badge.color,
                    originX: 'center',
                    originY: 'center'
                });

                const group = new fabric.Group([rect, text], {
                    left: f.width / 2,
                    top: f.height / 2,
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(group);
                this.canvas.setActiveObject(group);
                this.canvas.renderAll();
                this.saveHistory();
            }

            addShape(shape) {
                console.log('addShape llamado:', shape);
                const f = FORMATS[this.currentFormat];
                let obj;

                switch(shape) {
                    case 'rect':
                        obj = new fabric.Rect({
                            left: f.width / 2,
                            top: f.height / 2,
                            width: 200,
                            height: 200,
                            fill: '#6366f1',
                            originX: 'center',
                            originY: 'center',
                            rx: 10,
                            ry: 10
                        });
                        break;
                    case 'circle':
                        obj = new fabric.Circle({
                            left: f.width / 2,
                            top: f.height / 2,
                            radius: 100,
                            fill: '#ec4899',
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'triangle':
                        obj = new fabric.Triangle({
                            left: f.width / 2,
                            top: f.height / 2,
                            width: 200,
                            height: 180,
                            fill: '#f59e0b',
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'star':
                        // Crear estrella de 5 puntas
                        const starPoints = this.createStarPoints(100, 50, 5);
                        obj = new fabric.Polygon(starPoints, {
                            left: f.width / 2,
                            top: f.height / 2,
                            fill: '#fbbf24',
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'heart':
                        // Crear corazon con path SVG
                        obj = new fabric.Path('M 0 -50 C -50 -100, -100 -50, -100 0 C -100 50, -50 100, 0 130 C 50 100, 100 50, 100 0 C 100 -50, 50 -100, 0 -50 Z', {
                            left: f.width / 2,
                            top: f.height / 2,
                            fill: '#ef4444',
                            originX: 'center',
                            originY: 'center',
                            scaleX: 1,
                            scaleY: 1
                        });
                        break;
                    case 'line':
                        obj = new fabric.Line([f.width / 2 - 100, f.height / 2, f.width / 2 + 100, f.height / 2], {
                            stroke: '#ffffff',
                            strokeWidth: 4,
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'arrow-right':
                        this.addArrow('right');
                        return;
                    case 'arrow-down':
                        this.addArrow('down');
                        return;
                    case 'divider':
                        this.addDivider();
                        return;
                    case 'sparkle':
                    case 'fire':
                    case 'crown':
                        // Agregar como emoji grande
                        const emojiMap = { 'sparkle': 'âœ¨', 'fire': 'ğŸ”¥', 'crown': 'ğŸ‘‘' };
                        this.addSticker(emojiMap[shape], 120);
                        return;
                    case 'frame-circle':
                    case 'frame-square':
                    case 'frame-rounded':
                    case 'frame-polaroid':
                        this.addPhotoFrame(shape.replace('frame-', ''));
                        return;
                    case 'qr':
                        this.addQRCode();
                        return;
                }

                if (obj) {
                    this.canvas.add(obj);
                    this.canvas.setActiveObject(obj);
                    this.canvas.renderAll();
                    this.saveHistory();
                    console.log('Forma agregada:', shape);
                }
            }

            addQRCode() {
                const self = this;
                const f = FORMATS[this.currentFormat];

                // Verificar que la libreria qrcode-generator este cargada
                if (typeof qrcode === 'undefined') {
                    console.error('qrcode-generator library no cargada');
                    this.showToast('Error: libreria QR no disponible. Recarga la pagina.', 'error');
                    return;
                }

                try {
                    // Verificar que exista el link
                    let linkPerfil = CREATOR_CONFIG.linkPerfil;

                    // Fallback si linkPerfil no esta definido
                    if (!linkPerfil || linkPerfil === '' || linkPerfil === 'undefined') {
                        linkPerfil = CREATOR_CONFIG.baseUrl + '/Feed/Creador/' + CREATOR_CONFIG.seudonimo;
                    }

                    console.log('Generando QR para:', linkPerfil);

                    if (!linkPerfil || linkPerfil.includes('undefined') || linkPerfil === '') {
                        this.showToast('No se pudo generar el QR: configura tu seudonimo primero', 'error');
                        return;
                    }

                    // Generar QR usando qrcode-generator
                    const qr = qrcode(0, 'M'); // typeNumber 0 = auto, errorCorrectionLevel M
                    qr.addData(linkPerfil);
                    qr.make();

                    // Crear imagen desde el QR
                    const qrSize = 200;
                    const cellSize = Math.floor(qrSize / qr.getModuleCount());
                    const actualSize = cellSize * qr.getModuleCount();

                    // Crear canvas para dibujar el QR
                    const qrCanvas = document.createElement('canvas');
                    qrCanvas.width = actualSize;
                    qrCanvas.height = actualSize;
                    const ctx = qrCanvas.getContext('2d');

                    // Fondo blanco
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, actualSize, actualSize);

                    // Dibujar modulos del QR
                    ctx.fillStyle = '#000000';
                    for (let row = 0; row < qr.getModuleCount(); row++) {
                        for (let col = 0; col < qr.getModuleCount(); col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }

                    const qrDataUrl = qrCanvas.toDataURL('image/png');
                    console.log('QR generado correctamente');

                    // Crear imagen Fabric
                    fabric.Image.fromURL(qrDataUrl, function(img) {
                        if (!img) {
                            console.error('No se pudo crear la imagen del QR');
                            self.showToast('Error al crear imagen QR', 'error');
                            return;
                        }

                        // Escalar a 200x200
                        img.scaleToWidth(200);
                        img.scaleToHeight(200);

                        // Agregar borde blanco
                        const border = new fabric.Rect({
                            width: 220,
                            height: 220,
                            fill: '#ffffff',
                            rx: 8,
                            ry: 8,
                            originX: 'center',
                            originY: 'center',
                            shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.2)', blur: 10, offsetX: 2, offsetY: 2 })
                        });

                        img.set({
                            originX: 'center',
                            originY: 'center'
                        });

                        const group = new fabric.Group([border, img], {
                            left: f.width / 2,
                            top: f.height / 2,
                            originX: 'center',
                            originY: 'center'
                        });

                        self.canvas.add(group);
                        self.canvas.setActiveObject(group);
                        self.canvas.renderAll();
                        self.saveHistory();
                        self.showToast('QR agregado correctamente', 'success');
                        console.log('QR agregado exitosamente');
                    }, { crossOrigin: 'anonymous' });

                } catch (err) {
                    console.error('Error generando QR:', err);
                    this.showToast('Error al generar QR: ' + (err.message || 'desconocido'), 'error');
                }
            }

            // Crear puntos de estrella
            createStarPoints(outerRadius, innerRadius, points) {
                const result = [];
                const step = Math.PI / points;
                for (let i = 0; i < 2 * points; i++) {
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const angle = i * step - Math.PI / 2;
                    result.push({
                        x: radius * Math.cos(angle),
                        y: radius * Math.sin(angle)
                    });
                }
                return result;
            }

            // Agregar flecha
            addArrow(direction) {
                const f = FORMATS[this.currentFormat];
                const size = 80;
                let points;

                if (direction === 'right') {
                    points = [
                        { x: 0, y: size/3 },
                        { x: size*0.6, y: size/3 },
                        { x: size*0.6, y: 0 },
                        { x: size, y: size/2 },
                        { x: size*0.6, y: size },
                        { x: size*0.6, y: size*2/3 },
                        { x: 0, y: size*2/3 }
                    ];
                } else {
                    points = [
                        { x: size/3, y: 0 },
                        { x: size/3, y: size*0.6 },
                        { x: 0, y: size*0.6 },
                        { x: size/2, y: size },
                        { x: size, y: size*0.6 },
                        { x: size*2/3, y: size*0.6 },
                        { x: size*2/3, y: 0 }
                    ];
                }

                const arrow = new fabric.Polygon(points, {
                    left: f.width / 2,
                    top: f.height / 2,
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 8, offsetX: 2, offsetY: 2 })
                });

                this.canvas.add(arrow);
                this.canvas.setActiveObject(arrow);
                this.canvas.renderAll();
                this.saveHistory();
            }

            // Agregar linea divisora decorativa
            addDivider() {
                const f = FORMATS[this.currentFormat];
                const width = f.width * 0.6;

                // Crear grupo con linea y decoraciones
                const line = new fabric.Line([-width/2, 0, width/2, 0], {
                    stroke: '#ffffff',
                    strokeWidth: 2,
                    originX: 'center',
                    originY: 'center'
                });

                const leftDot = new fabric.Circle({
                    left: -width/2 - 10,
                    top: 0,
                    radius: 5,
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                const rightDot = new fabric.Circle({
                    left: width/2 + 10,
                    top: 0,
                    radius: 5,
                    fill: '#ffffff',
                    originX: 'center',
                    originY: 'center'
                });

                const group = new fabric.Group([line, leftDot, rightDot], {
                    left: f.width / 2,
                    top: f.height / 2,
                    originX: 'center',
                    originY: 'center'
                });

                this.canvas.add(group);
                this.canvas.setActiveObject(group);
                this.canvas.renderAll();
                this.saveHistory();
            }

            // Agregar marco para foto
            addPhotoFrame(type) {
                const f = FORMATS[this.currentFormat];
                const size = 250;
                let frame;

                switch(type) {
                    case 'circle':
                        frame = new fabric.Circle({
                            left: f.width / 2,
                            top: f.height / 2,
                            radius: size / 2,
                            fill: 'transparent',
                            stroke: '#ffffff',
                            strokeWidth: 8,
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'square':
                        frame = new fabric.Rect({
                            left: f.width / 2,
                            top: f.height / 2,
                            width: size,
                            height: size,
                            fill: 'transparent',
                            stroke: '#ffffff',
                            strokeWidth: 8,
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'rounded':
                        frame = new fabric.Rect({
                            left: f.width / 2,
                            top: f.height / 2,
                            width: size,
                            height: size,
                            fill: 'transparent',
                            stroke: '#ffffff',
                            strokeWidth: 8,
                            rx: 30,
                            ry: 30,
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                    case 'polaroid':
                        // Crear efecto polaroid
                        const outer = new fabric.Rect({
                            width: size + 40,
                            height: size + 80,
                            fill: '#ffffff',
                            originX: 'center',
                            originY: 'center',
                            shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 15, offsetX: 5, offsetY: 5 })
                        });

                        const inner = new fabric.Rect({
                            width: size,
                            height: size,
                            fill: '#e5e7eb',
                            top: -20,
                            originX: 'center',
                            originY: 'center'
                        });

                        frame = new fabric.Group([outer, inner], {
                            left: f.width / 2,
                            top: f.height / 2,
                            originX: 'center',
                            originY: 'center'
                        });
                        break;
                }

                if (frame) {
                    this.canvas.add(frame);
                    this.canvas.setActiveObject(frame);
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            // ========== PROPIEDADES ==========
            showProperties() {
                const obj = this.canvas.getActiveObject();
                if (!obj) return;

                const bar = document.getElementById('propertiesBar');
                const textProps = document.getElementById('textProps');
                const imageProps = document.getElementById('imageProps');

                bar.classList.add('active');

                if (obj.type === 'i-text' || obj.type === 'text') {
                    textProps.style.display = 'flex';
                    imageProps.style.display = 'none';
                    document.getElementById('fontFamily').value = obj.fontFamily || 'Inter';
                    document.getElementById('fontSize').value = obj.fontSize || 48;
                    document.getElementById('textColor').value = obj.fill || '#ffffff';

                    // Actualizar estado de botones de formato
                    document.getElementById('btnBold').classList.toggle('active', obj.fontWeight === 'bold');
                    document.getElementById('btnItalic').classList.toggle('active', obj.fontStyle === 'italic');
                    document.getElementById('btnUnderline').classList.toggle('active', obj.underline === true);

                    // Actualizar estado de botones de alineacion
                    const align = obj.textAlign || 'left';
                    document.querySelectorAll('[id^="btnAlign"]').forEach(btn => btn.classList.remove('active'));
                    const alignBtn = document.getElementById('btnAlign' + align.charAt(0).toUpperCase() + align.slice(1));
                    if (alignBtn) alignBtn.classList.add('active');
                } else if (obj.type === 'image') {
                    textProps.style.display = 'none';
                    imageProps.style.display = 'flex';
                } else {
                    textProps.style.display = 'none';
                    imageProps.style.display = 'none';
                }
            }

            hideProperties() {
                document.getElementById('propertiesBar').classList.remove('active');
            }

            updateTextProperty(prop, value) {
                const obj = this.canvas.getActiveObject();
                if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                    obj.set(prop, value);
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            toggleTextBold() {
                const obj = this.canvas.getActiveObject();
                if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                    obj.set('fontWeight', obj.fontWeight === 'bold' ? 'normal' : 'bold');
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            toggleTextItalic() {
                const obj = this.canvas.getActiveObject();
                if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                    obj.set('fontStyle', obj.fontStyle === 'italic' ? 'normal' : 'italic');
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            toggleTextUnderline() {
                const obj = this.canvas.getActiveObject();
                if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                    obj.set('underline', !obj.underline);
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            setTextAlign(align) {
                const obj = this.canvas.getActiveObject();
                if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                    obj.set('textAlign', align);
                    // Actualizar botones activos
                    document.querySelectorAll('[id^="btnAlign"]').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('btnAlign' + align.charAt(0).toUpperCase() + align.slice(1)).classList.add('active');
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            flipImage(axis) {
                const obj = this.canvas.getActiveObject();
                if (obj && obj.type === 'image') {
                    if (axis === 'x') obj.set('flipX', !obj.flipX);
                    if (axis === 'y') obj.set('flipY', !obj.flipY);
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            // ========== EFECTOS Y FILTROS ==========
            applyFilter(filterName) {
                const obj = this.canvas.getActiveObject();
                if (!obj || obj.type !== 'image') {
                    // Si no hay imagen seleccionada, aplicar a todas las imagenes
                    this.canvas.getObjects('image').forEach(img => {
                        this._setImageFilter(img, filterName);
                    });
                } else {
                    this._setImageFilter(obj, filterName);
                }
                this.canvas.renderAll();
                this.saveHistory();

                // Marcar filtro activo
                document.querySelectorAll('[data-filter]').forEach(el => el.classList.remove('active'));
                document.querySelector('[data-filter="' + filterName + '"]')?.classList.add('active');
            }

            _setImageFilter(img, filterName) {
                img.filters = [];
                switch(filterName) {
                    case 'grayscale':
                        img.filters.push(new fabric.Image.filters.Grayscale());
                        break;
                    case 'sepia':
                        img.filters.push(new fabric.Image.filters.Sepia());
                        break;
                    case 'vintage':
                        img.filters.push(new fabric.Image.filters.Sepia());
                        img.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.1 }));
                        img.filters.push(new fabric.Image.filters.Brightness({ brightness: -0.1 }));
                        break;
                    case 'vibrant':
                        img.filters.push(new fabric.Image.filters.Saturation({ saturation: 0.5 }));
                        img.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.2 }));
                        break;
                    case 'cool':
                        img.filters.push(new fabric.Image.filters.Saturation({ saturation: -0.2 }));
                        img.filters.push(new fabric.Image.filters.Brightness({ brightness: 0.1 }));
                        break;
                    case 'none':
                    default:
                        break;
                }
                img.applyFilters();
            }

            applyImageAdjustment(type, value) {
                const obj = this.canvas.getActiveObject();
                if (!obj || obj.type !== 'image') return;

                // Remover filtro del mismo tipo si existe
                obj.filters = obj.filters.filter(f => {
                    if (type === 'brightness') return !(f instanceof fabric.Image.filters.Brightness);
                    if (type === 'contrast') return !(f instanceof fabric.Image.filters.Contrast);
                    if (type === 'saturation') return !(f instanceof fabric.Image.filters.Saturation);
                    return true;
                });

                // Agregar nuevo filtro si valor != 0
                if (value !== 0) {
                    switch(type) {
                        case 'brightness':
                            obj.filters.push(new fabric.Image.filters.Brightness({ brightness: value }));
                            break;
                        case 'contrast':
                            obj.filters.push(new fabric.Image.filters.Contrast({ contrast: value }));
                            break;
                        case 'saturation':
                            obj.filters.push(new fabric.Image.filters.Saturation({ saturation: value }));
                            break;
                    }
                }

                obj.applyFilters();
                this.canvas.renderAll();
            }

            applyShadow(shadowType) {
                const obj = this.canvas.getActiveObject();
                if (!obj) return;

                let shadow = null;
                switch(shadowType) {
                    case 'soft':
                        shadow = new fabric.Shadow({
                            color: 'rgba(0,0,0,0.4)',
                            blur: 20,
                            offsetX: 5,
                            offsetY: 5
                        });
                        break;
                    case 'hard':
                        shadow = new fabric.Shadow({
                            color: 'rgba(0,0,0,0.8)',
                            blur: 2,
                            offsetX: 8,
                            offsetY: 8
                        });
                        break;
                    case 'glow':
                        shadow = new fabric.Shadow({
                            color: 'rgba(99, 102, 241, 0.8)',
                            blur: 25,
                            offsetX: 0,
                            offsetY: 0
                        });
                        break;
                    case 'none':
                    default:
                        shadow = null;
                        break;
                }

                obj.set('shadow', shadow);
                this.canvas.renderAll();
                this.saveHistory();
            }

            deleteSelected() {
                const obj = this.canvas.getActiveObject();
                if (obj) {
                    this.canvas.remove(obj);
                    this.canvas.renderAll();
                    this.saveHistory();
                }
            }

            // ========== HISTORIAL ==========
            saveHistory() {
                const json = JSON.stringify(this.canvas.toJSON());
                this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push(json);
                this.historyIndex++;
                if (this.history.length > 30) {
                    this.history.shift();
                    this.historyIndex--;
                }
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.canvas.loadFromJSON(this.history[this.historyIndex], () => {
                        this.canvas.renderAll();
                    });
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.canvas.loadFromJSON(this.history[this.historyIndex], () => {
                        this.canvas.renderAll();
                    });
                }
            }

            // ========== EXPORTAR ==========
            download() {
                const f = FORMATS[this.currentFormat];

                // Crear canvas temporal a resolucion completa
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = f.width;
                tempCanvas.height = f.height;
                const tempCtx = tempCanvas.getContext('2d');

                // Dibujar fondo
                const bgColor = this.canvas.backgroundColor;
                if (bgColor) {
                    if (typeof bgColor === 'string') {
                        tempCtx.fillStyle = bgColor;
                        tempCtx.fillRect(0, 0, f.width, f.height);
                    } else {
                        // Es un gradiente
                        const gradient = tempCtx.createLinearGradient(0, 0, f.width, f.height);
                        bgColor.colorStops.forEach(stop => {
                            gradient.addColorStop(stop.offset, stop.color);
                        });
                        tempCtx.fillStyle = gradient;
                        tempCtx.fillRect(0, 0, f.width, f.height);
                    }
                }

                // Escalar para exportar a resolucion completa
                const multiplier = f.width / this.canvas.getWidth();

                const dataURL = this.canvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: multiplier
                });

                const link = document.createElement('a');
                link.download = CREATOR_CONFIG.seudonimo + '_' + this.currentFormat + '.png';
                link.href = dataURL;
                link.click();
            }

            // ========== BORRADORES ==========
            checkForDraft() {
                const draft = localStorage.getItem('promo_editor_draft');
                if (draft) {
                    try {
                        const data = JSON.parse(draft);
                        const date = new Date(data.savedAt);
                        document.getElementById('draftDate').textContent = date.toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        document.getElementById('draftModal').classList.add('active');
                    } catch (e) {
                        this.loadDefaultTemplate();
                    }
                } else {
                    this.loadDefaultTemplate();
                }
            }

            closeDraftModal(loadDraft) {
                document.getElementById('draftModal').classList.remove('active');
                if (loadDraft) {
                    this.loadDraftData();
                } else {
                    localStorage.removeItem('promo_editor_draft');
                    this.loadDefaultTemplate();
                }
            }

            saveDraft() {
                try {
                    const canvasJSON = this.canvas.toJSON();
                    const data = {
                        canvas: canvasJSON,
                        format: this.currentFormat,
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem('promo_editor_draft', JSON.stringify(data));
                    this.showToast('Borrador guardado', 'success');
                } catch (e) {
                    this.showToast('Error al guardar borrador', 'error');
                    console.error(e);
                }
            }

            loadDraftData() {
                try {
                    const draft = localStorage.getItem('promo_editor_draft');
                    if (draft) {
                        const data = JSON.parse(draft);

                        // Cambiar formato si es diferente
                        if (data.format && data.format !== this.currentFormat) {
                            document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
                            document.querySelector('[data-format="' + data.format + '"]')?.classList.add('active');
                            this.setFormat(data.format);
                        }

                        // Cargar canvas
                        this.canvas.loadFromJSON(data.canvas, () => {
                            this.canvas.renderAll();
                            this.saveHistory();
                            this.showToast('Borrador cargado', 'success');
                        });
                    }
                } catch (e) {
                    this.showToast('Error al cargar borrador', 'error');
                    this.loadDefaultTemplate();
                }
            }

            // ========== PUBLICAR ==========
            openPublishModal() {
                const f = FORMATS[this.currentFormat];
                const multiplier = f.width / this.canvas.getWidth();
                const dataURL = this.canvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: multiplier
                });

                document.getElementById('publishPreview').src = dataURL;
                document.getElementById('publishCaption').value = '';
                document.getElementById('publishModal').classList.add('active');
            }

            closePublishModal() {
                document.getElementById('publishModal').classList.remove('active');
            }

            async publishToFeed() {
                const btn = document.getElementById('confirmPublish');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';

                try {
                    const f = FORMATS[this.currentFormat];
                    const multiplier = f.width / this.canvas.getWidth();
                    const dataURL = this.canvas.toDataURL({
                        format: 'png',
                        quality: 1,
                        multiplier: multiplier
                    });

                    const caption = document.getElementById('publishCaption').value.trim();

                    // Convertir base64 a blob
                    const response = await fetch(dataURL);
                    const blob = await response.blob();

                    // Crear FormData
                    const formData = new FormData();
                    formData.append('archivo', blob, 'promo_' + Date.now() + '.png');
                    formData.append('descripcion', caption);
                    formData.append('esPublico', 'true');

                    // Enviar al servidor
                    const result = await fetch('/Contenido/CrearRapido', {
                        method: 'POST',
                        body: formData
                    });

                    if (result.ok) {
                        const data = await result.json();
                        this.closePublishModal();
                        localStorage.removeItem('promo_editor_draft');
                        this.showToast('Publicado exitosamente', 'success');

                        // Redirigir al contenido o al feed
                        setTimeout(() => {
                            if (data.contenidoId) {
                                window.location.href = '/Contenido/Ver/' + data.contenidoId;
                            } else {
                                window.location.href = '/Feed';
                            }
                        }, 1500);
                    } else {
                        throw new Error('Error del servidor');
                    }
                } catch (e) {
                    console.error(e);
                    this.showToast('Error al publicar. Intenta de nuevo.', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            // ========== BIBLIOTECA DE FOTOS ==========
            showSaveToLibraryDialog() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validar tamano (max 2MB para localStorage)
                        if (file.size > 2 * 1024 * 1024) {
                            this.showToast('La imagen es muy grande (max 2MB)', 'error');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const photoName = prompt('Nombre para esta foto:', file.name.replace(/\.[^/.]+$/, ''));
                            if (photoName) {
                                this.savePhotoToLibrary(event.target.result, photoName);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }

            savePhotoToLibrary(dataUrl, name) {
                try {
                    const customPhotos = JSON.parse(localStorage.getItem('customPhotos') || '[]');

                    // Limitar a 20 fotos personalizadas
                    if (customPhotos.length >= 20) {
                        this.showToast('Has alcanzado el limite de 20 fotos. Elimina algunas primero.', 'error');
                        return;
                    }

                    customPhotos.push({
                        name: name,
                        url: dataUrl,
                        date: new Date().toISOString()
                    });

                    localStorage.setItem('customPhotos', JSON.stringify(customPhotos));
                    this.showToast('Foto guardada en tu biblioteca', 'success');

                    // Refrescar el panel de fotos
                    this.renderToolPanel('photos');
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        this.showToast('Almacenamiento lleno. Elimina algunas fotos.', 'error');
                    } else {
                        this.showToast('Error al guardar la foto', 'error');
                    }
                }
            }

            deleteCustomPhoto(index) {
                if (!confirm('Eliminar esta foto de tu biblioteca?')) return;

                const customPhotos = JSON.parse(localStorage.getItem('customPhotos') || '[]');
                customPhotos.splice(index, 1);
                localStorage.setItem('customPhotos', JSON.stringify(customPhotos));

                this.showToast('Foto eliminada', 'success');
                this.renderToolPanel('photos');
            }

            // ========== UTILIDADES ==========
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const icon = toast.querySelector('i');

                toast.className = 'toast ' + type;

                // Icono segun tipo
                const iconClass = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'info': 'fas fa-info-circle'
                };
                icon.className = iconClass[type] || iconClass.success;
                document.getElementById('toastMessage').textContent = message;

                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // ========== INICIALIZAR ==========
        document.addEventListener('DOMContentLoaded', () => {
            window.editor = new PromoEditor();
            window.editor.init();

            // Tema dÃ­a/noche
            const btnTheme = document.getElementById('btnTheme');
            const savedTheme = localStorage.getItem('editor-theme') || 'dark';

            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                btnTheme.innerHTML = '<i class="fas fa-moon"></i>';
            }

            btnTheme.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    document.body.removeAttribute('data-theme');
                    btnTheme.innerHTML = '<i class="fas fa-sun"></i>';
                    localStorage.setItem('editor-theme', 'dark');
                } else {
                    document.body.setAttribute('data-theme', 'light');
                    btnTheme.innerHTML = '<i class="fas fa-moon"></i>';
                    localStorage.setItem('editor-theme', 'light');
                }
            });
        });
    </script>
</body>
</html>
