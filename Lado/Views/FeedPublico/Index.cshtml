@model IEnumerable<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "Explorar Contenido - LadoApp";
    Layout = null; // Sin layout - pantalla completa negra
    var contenidoLista = Model?.ToList() ?? new List<Contenido>();
    var estaAutenticado = ViewBag.EstaAutenticado as bool? ?? false;

    // SEO Variables
    var baseUrl = "https://ladoapp.com";
    var pageUrl = $"{baseUrl}/FeedPublico";
    var ogImage = $"{baseUrl}/images/og-default.jpg";
    var description = "Explora contenido exclusivo de creadores verificados en LadoApp. Descubre fotos, videos e historias de tus creadores favoritos.";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <title>@ViewData["Title"]</title>
    <meta name="description" content="@description" />
    <meta name="keywords" content="explorar contenido, creadores, fotos exclusivas, videos, LadoApp, red social" />
    <meta name="robots" content="index, follow" />

    <!-- Canonical URL -->
    <link rel="canonical" href="@pageUrl" />

    <!-- Open Graph -->
    <meta property="og:site_name" content="LadoApp" />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="@pageUrl" />
    <meta property="og:title" content="Explorar Contenido Exclusivo - LadoApp" />
    <meta property="og:description" content="@description" />
    <meta property="og:image" content="@ogImage" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@@LadoApp" />
    <meta name="twitter:title" content="Explorar Contenido - LadoApp" />
    <meta name="twitter:description" content="@description" />
    <meta name="twitter:image" content="@ogImage" />

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "Explorar Contenido - LadoApp",
        "description": "@description",
        "url": "@pageUrl",
        "isPartOf": {
            "@@type": "WebSite",
            "name": "LadoApp",
            "url": "@baseUrl"
        }
    }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/feedpublico.css" asp-append-version="true" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            overflow: hidden;
            height: 100%;
            width: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
</head>
<body>

<div class="mosaic-page">
    <!-- Mosaico de imagenes -->
    <div class="mosaic-container" id="mosaicGrid">
        @{
            // Grid con contenido - OPTIMIZADO para rendimiento
            var itemsNecesarios = 150;  // Reducido para mejor rendimiento

            var contenidoOriginal = contenidoLista.ToList();
            var contenidoFinal = new List<Contenido>();
            var random = new Random();

            // Duplicar contenido si es necesario (solo si hay poco contenido)
            if (contenidoOriginal.Count > 0)
            {
                while (contenidoFinal.Count < itemsNecesarios)
                {
                    contenidoFinal.AddRange(contenidoOriginal.OrderBy(_ => random.Next()));
                }
            }

            var itemsParaMostrar = contenidoFinal.Take(itemsNecesarios).ToList();
            var hayContenido = itemsParaMostrar.Any();
        }

        @if (hayContenido)
        {
            foreach (var item in itemsParaMostrar)
            {
                var esVideo = item.TipoContenido == TipoContenido.Video;
                var carpetaUsuario = item.Usuario?.UserName ?? "default";
                var rutaArchivo = LimpiarRuta(item.RutaArchivo, carpetaUsuario);
                var thumbnailUrl = LimpiarRuta(item.Thumbnail, carpetaUsuario);

                // Videos sin archivo válido se saltan
                if (esVideo && string.IsNullOrEmpty(rutaArchivo))
                {
                    continue;
                }

                // Fotos: usar thumbnail si existe, sino la imagen directa
                var imagenSrc = !string.IsNullOrEmpty(thumbnailUrl) ? thumbnailUrl : rutaArchivo;

                <div class="mosaic-item" onclick="window.location.href='@Url.Action("Login", "Account")'">
                    @if (esVideo)
                    {
                        <video src="@rutaArchivo" autoplay muted loop playsinline preload="metadata" poster="@thumbnailUrl" onloadeddata="this.classList.add('loaded')" onerror="this.parentElement.classList.add('has-error');this.style.display='none'"></video>
                        <div class="video-badge">
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                    }
                    else
                    {
                        <img src="@imagenSrc" alt="" loading="eager" onload="this.classList.add('loaded')" onerror="this.parentElement.classList.add('has-error');this.style.display='none'">
                    }
                </div>
            }
        }
        else
        {
            <!-- Fallback cuando no hay contenido -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 20px; opacity: 0.5;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 10px; color: white;">Bienvenido a LADO</h3>
                <p style="font-size: 1rem; opacity: 0.8; max-width: 400px;">Pronto habrá contenido increíble para descubrir.</p>
            </div>
        }
    </div>

    <!-- Overlays oscuros -->
    <div class="mosaic-overlay"></div>
    <div class="mosaic-overlay-left"></div>
    <div class="mosaic-overlay-right"></div>

    <!-- Contenido central -->
    <div class="mosaic-content">
        <div class="mosaic-logo">LADO</div>
        <div class="mosaic-tagline">Descubre contenido exclusivo</div>

        @if (!estaAutenticado)
        {
            <div class="mosaic-buttons">
                <a href="@Url.Action("Register", "Account")" class="mosaic-btn mosaic-btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Crear cuenta gratis
                </a>
                <a href="@Url.Action("Login", "Account")" class="mosaic-btn mosaic-btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Iniciar sesión
                </a>
                <a href="/Home/Index?desktop=true" class="mosaic-btn-info">
                    <i class="fas fa-info-circle"></i>
                    ¿Qué es Lado?
                </a>
            </div>
        }
        else
        {
            <div class="mosaic-buttons">
                <a href="@Url.Action("Index", "Feed")" class="mosaic-btn mosaic-btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                    Ir al Feed
                </a>
            </div>
        }
    </div>
</div>

@functions {
    /// <summary>
    /// Limpia y normaliza rutas de archivos (maneja datos legacy con comillas)
    /// </summary>
    string LimpiarRuta(string? ruta, string carpetaUsuario)
    {
        if (string.IsNullOrEmpty(ruta)) return "";

        var limpia = ruta.Trim().Trim('"', '\'', '\\');
        limpia = limpia.Replace("\"", "").Replace("'", "").Replace("&quot;", "").Replace("%22", "");

        if (string.IsNullOrEmpty(limpia)) return "";

        // Si solo es nombre de archivo, construir ruta completa
        if (!limpia.Contains("/") && !limpia.Contains("\\"))
        {
            return $"/uploads/{carpetaUsuario}/{limpia}";
        }

        // Asegurar que comienza con /
        if (!limpia.StartsWith("/") && !limpia.StartsWith("http"))
        {
            limpia = "/" + limpia;
        }

        return limpia;
    }
}

<script>
        // MOSAICO SIMPLIFICADO - Igual que el landing para carga rápida
        (function() {
            const grid = document.getElementById('mosaicGrid');
            if (!grid) return;

            const items = grid.querySelectorAll('.mosaic-item');
            if (items.length === 0) return;

            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            // Configurar grid - IGUAL QUE LANDING
            function setupGrid() {
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const gap = 4;

                // Items grandes como el landing
                let itemSize = vw > 1200 ? 120 : vw > 768 ? 100 : vw > 480 ? 80 : 70;

                const cols = Math.ceil(vw / (itemSize + gap)) + 2;
                const rows = Math.ceil(vh / (itemSize + gap)) + 2;

                grid.style.gridTemplateColumns = `repeat(${cols}, ${itemSize}px)`;
                grid.style.gridTemplateRows = `repeat(${rows}, ${itemSize}px)`;
                grid.style.gap = `${gap}px`;

                const maxItems = cols * rows;
                items.forEach((item, index) => {
                    item.style.display = index < maxItems ? 'block' : 'none';
                });
            }

            // Ejecutar inmediatamente
            setupGrid();
            window.addEventListener('resize', setupGrid);

            // Parallax solo en desktop con throttle para rendimiento
            if (!isTouchDevice) {
                let ticking = false;
                document.addEventListener('mousemove', (e) => {
                    if (!ticking) {
                        requestAnimationFrame(() => {
                            const x = (e.clientX / window.innerWidth - 0.5) * 10;
                            const y = (e.clientY / window.innerHeight - 0.5) * 10;
                            grid.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                            ticking = false;
                        });
                        ticking = true;
                    }
                });
            }

            // iOS fixes
            if (isIOS) {
                document.body.style.cssText = 'position: fixed; width: 100%; height: 100%;';
            }
        })();
</script>
</body>
</html>
