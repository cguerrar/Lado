@model IEnumerable<Lado.Models.Contenido>
@using Lado.Models
@{
    ViewData["Title"] = "LADO - Descubre";
    Layout = null; // Sin layout - pantalla completa negra
    var contenidoLista = Model?.ToList() ?? new List<Contenido>();
    var estaAutenticado = ViewBag.EstaAutenticado as bool? ?? false;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/feedpublico.css" asp-append-version="true" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            overflow: hidden;
            height: 100%;
            width: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
</head>
<body>

<div class="mosaic-page">
    <!-- Mosaico de imagenes -->
    <div class="mosaic-container" id="mosaicGrid">
        @{
            // Grid con contenido aleatorio del servidor - 200 items para mosaico denso
            var itemsNecesarios = 200;
            var cargarDirecto = 24;   // Primeras 24 imágenes cargan inmediatamente
            var videosConAutoplay = 12;

            var contenidoFinal = contenidoLista.ToList();

            // Solo duplicar si hay muy poco contenido
            if (contenidoFinal.Count > 0 && contenidoFinal.Count < itemsNecesarios)
            {
                var random = new Random();
                while (contenidoFinal.Count < itemsNecesarios)
                {
                    contenidoFinal.AddRange(contenidoLista.OrderBy(x => random.Next()));
                }
            }

            var itemsParaMostrar = contenidoFinal.Take(itemsNecesarios).ToList();
            var hayContenido = itemsParaMostrar.Any();
            var contador = 0;
            var contadorVideos = 0;
        }

        @if (hayContenido)
        {
            foreach (var item in itemsParaMostrar)
            {
                var esVideo = item.TipoContenido == TipoContenido.Video;
                var carpetaUsuario = item.Usuario?.UserName ?? "default";

                // Limpiar rutas (datos legacy con comillas)
                var rutaArchivo = LimpiarRuta(item.RutaArchivo, carpetaUsuario);
                var thumbnailUrl = LimpiarRuta(item.Thumbnail, carpetaUsuario);
                var imagenSrc = !string.IsNullOrEmpty(thumbnailUrl) ? thumbnailUrl : rutaArchivo;

                var usarLazy = contador >= cargarDirecto;
                var videoAutoplay = esVideo && contadorVideos < videosConAutoplay;
                if (esVideo) contadorVideos++;
                contador++;

                <div class="mosaic-item @(usarLazy ? "" : "media-loaded")" data-tipo="@(esVideo ? "video" : "image")" onclick="window.location.href='@Url.Action("Login", "Account")'">
                    @if (esVideo)
                    {
                        var posterUrl = !string.IsNullOrEmpty(thumbnailUrl) ? thumbnailUrl : "";
                        if (!string.IsNullOrEmpty(posterUrl))
                        {
                            <img src="@posterUrl" alt="" class="loaded" loading="eager"
                                 onload="this.parentElement.classList.add('media-loaded');"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E'; this.parentElement.classList.add('media-loaded');">
                            <div class="video-badge">
                                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                        }
                        else
                        {
                            <video data-video-src="@rutaArchivo" @(videoAutoplay ? "autoplay" : "") muted loop playsinline webkit-playsinline preload="metadata" style="background:#000;" class="video-placeholder"></video>
                            <div class="video-badge">
                                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                        }
                    }
                    else
                    {
                        if (usarLazy)
                        {
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                 data-src="@imagenSrc" alt="" loading="lazy" decoding="async"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E'; this.classList.add('loaded'); this.parentElement.classList.add('media-loaded');">
                        }
                        else
                        {
                            <img src="@imagenSrc" alt="" class="loaded" loading="eager"
                                 onload="this.parentElement.classList.add('media-loaded');"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%231a1a2e%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E'; this.parentElement.classList.add('media-loaded');">
                        }
                    }
                </div>
            }
        }
        else
        {
            <!-- Fallback cuando no hay contenido -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 20px; opacity: 0.5;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 10px; color: white;">Bienvenido a LADO</h3>
                <p style="font-size: 1rem; opacity: 0.8; max-width: 400px;">Pronto habrá contenido increíble para descubrir.</p>
            </div>
        }
    </div>

    <!-- Overlays oscuros -->
    <div class="mosaic-overlay"></div>
    <div class="mosaic-overlay-left"></div>
    <div class="mosaic-overlay-right"></div>

    <!-- Contenido central -->
    <div class="mosaic-content">
        <div class="mosaic-logo">LADO</div>
        <div class="mosaic-tagline">Descubre contenido exclusivo</div>

        @if (!estaAutenticado)
        {
            <div class="mosaic-buttons">
                <a href="@Url.Action("Register", "Account")" class="mosaic-btn mosaic-btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Crear cuenta gratis
                </a>
                <a href="@Url.Action("Login", "Account")" class="mosaic-btn mosaic-btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Iniciar sesión
                </a>
                <a href="/Home/Index?desktop=true" class="mosaic-btn-info">
                    <i class="fas fa-info-circle"></i>
                    ¿Qué es Lado?
                </a>
            </div>
        }
        else
        {
            <div class="mosaic-buttons">
                <a href="@Url.Action("Index", "Feed")" class="mosaic-btn mosaic-btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                    Ir al Feed
                </a>
            </div>
        }
    </div>
</div>

@functions {
    /// <summary>
    /// Limpia y normaliza rutas de archivos (maneja datos legacy con comillas)
    /// </summary>
    string LimpiarRuta(string? ruta, string carpetaUsuario)
    {
        if (string.IsNullOrEmpty(ruta)) return "";

        var limpia = ruta.Trim().Trim('"', '\'', '\\');
        limpia = limpia.Replace("\"", "").Replace("'", "").Replace("&quot;", "").Replace("%22", "");

        if (string.IsNullOrEmpty(limpia)) return "";

        // Si solo es nombre de archivo, construir ruta completa
        if (!limpia.Contains("/") && !limpia.Contains("\\"))
        {
            return $"/uploads/{carpetaUsuario}/{limpia}";
        }

        // Asegurar que comienza con /
        if (!limpia.StartsWith("/") && !limpia.StartsWith("http"))
        {
            limpia = "/" + limpia;
        }

        return limpia;
    }
}

<script>
        (function() {
            // MOSAICO OPTIMIZADO v2 - Carga rápida sin verificación HTTP previa
            const grid = document.getElementById('mosaicGrid');
            if (!grid) return;

            const items = grid.querySelectorAll('.mosaic-item');
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const fallbackSrc = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%231a1a2e' width='100' height='100'/%3E%3C/svg%3E";

            // Control de carga paralela - aumentado para 200 items
            const MAX_CONCURRENT = 16;
            let activeLoads = 0;
            const loadQueue = [];
            const loadedItems = new Set();

            // Suprimir errores de recursos en consola
            window.addEventListener('error', (e) => {
                if (e.target?.tagName === 'IMG' || e.target?.tagName === 'VIDEO') {
                    e.preventDefault();
                    return false;
                }
            }, true);

            function processQueue() {
                while (activeLoads < MAX_CONCURRENT && loadQueue.length > 0) {
                    const item = loadQueue.shift();
                    if (item && !loadedItems.has(item)) loadItem(item);
                }
            }

            function queueItem(item, priority = false) {
                if (loadedItems.has(item)) return;
                priority ? loadQueue.unshift(item) : loadQueue.push(item);
                processQueue();
            }

            function loadItem(item) {
                loadedItems.add(item);
                activeLoads++;
                item.classList.add('media-loaded');

                const img = item.querySelector('img[data-src]');
                const video = item.querySelector('video[data-video-src]');

                if (img) loadImage(img);
                else if (video) loadVideo(video);
                else {
                    item.querySelector('img')?.classList.add('loaded');
                    activeLoads--;
                    processQueue();
                }
            }

            function loadImage(img) {
                const src = img.getAttribute('data-src');
                img.removeAttribute('data-src');

                const timeout = setTimeout(() => {
                    if (!img.classList.contains('loaded')) {
                        img.src = fallbackSrc;
                        img.classList.add('loaded');
                    }
                    activeLoads--;
                    processQueue();
                }, 1500); // Reducido de 3000ms a 1500ms

                img.onload = () => {
                    clearTimeout(timeout);
                    img.classList.add('loaded');
                    activeLoads--;
                    processQueue();
                };

                img.onerror = () => {
                    clearTimeout(timeout);
                    img.src = fallbackSrc;
                    img.classList.add('loaded');
                    activeLoads--;
                    processQueue();
                };

                img.src = src;
            }

            function loadVideo(video) {
                const src = video.getAttribute('data-video-src');
                video.removeAttribute('data-video-src');

                const timeout = setTimeout(() => {
                    if (!video.classList.contains('loaded')) replaceWithPlaceholder(video);
                    activeLoads--;
                    processQueue();
                }, 2500);

                video.onloadeddata = () => {
                    clearTimeout(timeout);
                    video.classList.remove('video-placeholder');
                    video.classList.add('loaded');
                    video.muted = true;
                    video.loop = true;
                    video.play().catch(() => {});
                    activeLoads--;
                    processQueue();
                };

                video.onerror = () => {
                    clearTimeout(timeout);
                    replaceWithPlaceholder(video);
                    activeLoads--;
                    processQueue();
                };

                video.src = src;
            }

            function replaceWithPlaceholder(video) {
                const placeholder = document.createElement('div');
                placeholder.className = 'video-error-placeholder loaded';
                placeholder.innerHTML = '<svg viewBox="0 0 24 24" fill="rgba(255,255,255,0.3)"><path d="M8 5v14l11-7z"/></svg>';
                video.replaceWith(placeholder);
            }

            // IntersectionObserver para lazy loading
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        queueItem(entry.target, true);
                        observer.unobserve(entry.target);
                    }
                });
            }, { rootMargin: '400px', threshold: 0 }); // Aumentado de 200px a 400px

            // Configurar grid responsive
            function setupGrid() {
                const vw = window.innerWidth;
                const vh = window.innerHeight;

                // Items más pequeños para más densidad, con espacio negro arriba/abajo
                let itemSize, gap;
                if (vw > 1600) { itemSize = 90; gap = 3; }
                else if (vw > 1200) { itemSize = 80; gap = 3; }
                else if (vw > 1024) { itemSize = 70; gap = 3; }
                else if (vw > 768) { itemSize = 60; gap = 2; }
                else if (vw > 480) { itemSize = 50; gap = 2; }
                else { itemSize = 45; gap = 2; }

                // Usar solo 65% del alto para dejar espacio negro arriba y abajo
                const visibleHeight = vh * 0.65;
                const cols = Math.ceil(vw / (itemSize + gap)) + 4; // Más columnas para 200 items
                const rows = Math.max(Math.ceil(visibleHeight / (itemSize + gap)), 6);

                grid.style.gridTemplateColumns = `repeat(${cols}, ${itemSize}px)`;
                grid.style.gridTemplateRows = `repeat(${rows}, ${itemSize}px)`;
                grid.style.gap = `${gap}px`;

                const maxItems = cols * rows;
                items.forEach((item, index) => {
                    const shouldShow = index < maxItems;
                    item.style.display = shouldShow ? 'block' : 'none';
                    if (shouldShow && !loadedItems.has(item)) observer.observe(item);
                });
            }

            // Inicializar
            function init() {
                setupGrid();

                // Marcar items y cargar primeros 16 inmediatamente
                items.forEach((item, index) => {
                    item.classList.add('media-loaded');
                    const img = item.querySelector('img:not([data-src])');
                    if (img) img.classList.add('loaded');

                    if (index < 24 && item.style.display !== 'none') {
                        queueItem(item, true);
                    } else if (item.style.display !== 'none' && !loadedItems.has(item)) {
                        observer.observe(item);
                    }
                });
            }

            // Ejecutar
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                requestAnimationFrame(init);
            } else {
                document.addEventListener('DOMContentLoaded', init);
            }

            // Resize handler con debounce
            let resizeTimeout;
            const handleResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(setupGrid, 100);
            };
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', () => setTimeout(setupGrid, 100));

            // Parallax solo en desktop
            if (!isTouchDevice) {
                document.addEventListener('mousemove', (e) => {
                    const x = (e.clientX / window.innerWidth - 0.5) * 10;
                    const y = (e.clientY / window.innerHeight - 0.5) * 10;
                    grid.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                });
            }

            // iOS fixes
            if (isIOS) {
                document.body.style.cssText = 'position: fixed; width: 100%; height: 100%;';
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) e.preventDefault();
                    lastTouchEnd = now;
                }, false);
            }

            // Animacion de estadisticas (si existen los elementos)
            function animateValue(id, end, duration) {
                const obj = document.getElementById(id);
                if (!obj) return;
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const current = Math.floor((1 - Math.pow(1 - progress, 3)) * end);
                    obj.textContent = current >= 1000 ? (current / 1000).toFixed(1) + 'K' : current;
                    if (progress < 1) requestAnimationFrame(step);
                };
                requestAnimationFrame(step);
            }

            setTimeout(() => {
                animateValue('statCreadores', @(ViewBag.TotalCreadores ?? 50), 2000);
                animateValue('statContenido', @(ViewBag.TotalContenido ?? 500), 2000);
                animateValue('statComunidad', @(ViewBag.TotalUsuarios ?? 1000), 2000);
            }, 500);
        })();
</script>
</body>
</html>
