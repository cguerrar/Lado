@{
    var modo = ViewBag.Modo ?? "story";
    var titulo = ViewBag.Titulo ?? "Crear Historia";
    var textoPublicar = ViewBag.TextoPublicar ?? "Publicar";
    ViewData["Title"] = titulo;
    Layout = null; // Full screen sin layout
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>@ViewData["Title"] - Lado</title>
    <link rel="icon" type="image/png" href="/images/favicon.png" />

    <!-- Google Fonts para variedad de tipografías -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Lobster&family=Montserrat:wght@600;800&family=Oswald:wght@600&family=Pacifico&family=Permanent+Marker&family=Playfair+Display:wght@700&family=Poppins:wght@600;700&family=Roboto:wght@500;700&family=Satisfy&family=Anton&display=swap" rel="stylesheet">

    <!-- Fabric.js para canvas interactivo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <style>
        /* ========================================
           TEMA - Sincronizado con el sistema
           ======================================== */
        :root {
            /* Colores base - Modo claro (default) */
            --primary: #4682B4;
            --primary-dark: #36648B;
            --primary-light: #B0C4DE;
            --primary-hover: #5a9fd4;
            --primary-rgb: 70, 130, 180;
            --danger: #dc3545;
            --success: #28a745;

            /* Modo claro */
            --bg: #f1f5f9;
            --bg-secondary: #e2e8f0;
            --surface: #ffffff;
            --surface-hover: #f8fafc;
            --surface-elevated: #ffffff;
            --fg: #0f172a;
            --fg-secondary: #475569;
            --muted: #64748b;
            --line: #e2e8f0;
            --line-light: #f1f5f9;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.15);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.3);
            --canvas-bg: #1a1a1a;
        }

        [data-theme="dark"] {
            /* Modo oscuro */
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --surface: #1e293b;
            --surface-hover: #334155;
            --surface-elevated: #334155;
            --fg: #f8fafc;
            --fg-secondary: #e2e8f0;
            --muted: #94a3b8;
            --line: #334155;
            --line-light: #1e293b;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-strong: rgba(0, 0, 0, 0.5);
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(51, 65, 85, 0.5);
            --canvas-bg: #000000;
            --primary: #6CA6CD;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--fg);
            overflow: hidden;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height para móviles */
            width: 100vw;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ========================================
           LAYOUT PRINCIPAL
           ======================================== */
        .story-editor {
            display: flex;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            position: relative;
        }

        /* Panel izquierdo - Herramientas (Desktop) */
        .tools-panel {
            width: 72px;
            background: var(--surface);
            border-right: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            gap: 6px;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            transition: all 0.2s ease;
            position: relative;
        }

        .tool-btn:hover {
            background: var(--surface-hover);
            color: var(--fg);
            transform: scale(1.05);
        }

        .tool-btn:active {
            transform: scale(0.95);
        }

        .tool-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }

        .tool-btn svg {
            width: 22px;
            height: 22px;
        }

        /* Tooltip para herramientas */
        .tool-btn::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            margin-left: 8px;
            padding: 6px 10px;
            background: var(--surface-elevated);
            color: var(--fg);
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--line);
            z-index: 100;
        }

        .tool-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .tools-divider {
            height: 1px;
            background: var(--line);
            margin: 8px 4px;
        }

        /* Botón de salir del editor */
        .close-editor-btn {
            background: rgba(220, 53, 69, 0.1) !important;
            color: var(--danger) !important;
        }

        .close-editor-btn:hover {
            background: var(--danger) !important;
            color: white !important;
        }

        .desktop-only {
            display: block;
        }

        /* Panel central - Canvas */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            position: relative;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 380px;
            aspect-ratio: 9/16;
            background: var(--canvas-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px var(--shadow-strong), 0 0 0 1px var(--line);
            transition: box-shadow 0.3s ease;
        }

        .canvas-wrapper:hover {
            box-shadow: 0 25px 70px var(--shadow-strong), 0 0 0 1px var(--primary);
        }

        /* Video de fondo */
        #videoBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            display: none;
            transform-origin: center center;
            transition: filter 0.3s ease, transform 0.3s ease;
        }

        #videoBackground.active {
            display: block;
        }

        /* Canvas de Fabric.js */
        #storyCanvas {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 2;
        }

        /* El contenedor que Fabric.js genera automaticamente */
        .canvas-wrapper > .canvas-container {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 2;
        }

        /* Upper canvas de Fabric (el que maneja interacciones) */
        .canvas-wrapper .upper-canvas {
            z-index: 3 !important;
        }

        /* Panel derecho - Opciones (Desktop) */
        .options-panel {
            width: 340px;
            background: var(--surface);
            border-left: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .options-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
        }

        .options-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--fg);
        }

        .options-header .close-btn {
            display: none;
        }

        @@media (max-width: 768px) {
            .options-header .close-btn {
                display: flex;
                width: 36px;
                height: 36px;
            }
        }

        .options-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--line) transparent;
        }

        .options-content::-webkit-scrollbar {
            width: 6px;
        }

        .options-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .options-content::-webkit-scrollbar-thumb {
            background: var(--line);
            border-radius: 3px;
        }

        .options-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--line);
            display: flex;
            gap: 12px;
            background: var(--surface);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            flex: 1;
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.25);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(var(--primary-rgb), 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-hover);
            color: var(--fg);
            border: 1px solid var(--line);
        }

        .btn-secondary:hover {
            background: var(--line);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ========================================
           SECCIONES DE OPCIONES
           ======================================== */
        .option-section {
            display: none;
        }

        .option-section.active {
            display: block;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }

        /* Input de texto */
        .text-input {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg);
            font-size: 14px;
            resize: none;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Selector de fuentes */
        .font-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .font-option {
            padding: 10px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .font-option:hover {
            border-color: var(--muted);
        }

        .font-option.selected {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.1);
        }

        /* Selector de colores */
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--fg);
        }

        /* Slider de tamaño */
        .size-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--line);
            outline: none;
        }

        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        /* Grid de stickers */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: calc(100vh - 280px);
            min-height: 350px;
            overflow-y: auto;
            padding: 4px;
        }

        .sticker-item {
            width: 100%;
            aspect-ratio: 1;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .sticker-item:hover {
            background: var(--surface-hover);
            transform: scale(1.1);
            border-color: var(--primary);
        }

        /* Buscador de menciones */
        .mention-search {
            position: relative;
        }

        .mention-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .mention-results.active {
            display: block;
        }

        .mention-item {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mention-item:hover {
            background: var(--surface-hover);
        }

        .mention-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--primary);
        }

        /* ========================================
           MÚSICA - Estilo TikTok
           ======================================== */
        .music-selector {
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
        }

        /* Tabs de música */
        .music-tabs {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--line);
            padding: 0 12px;
            gap: 4px;
        }

        .music-tab {
            padding: 12px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .music-tab:hover {
            color: var(--fg);
        }

        .music-tab.active {
            color: var(--fg);
            font-weight: 600;
        }

        .music-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 2px;
            background: var(--fg);
            border-radius: 2px;
        }

        .music-search-btn {
            margin-left: auto;
            padding: 8px;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .music-search-btn:hover {
            background: var(--surface-hover);
            color: var(--fg);
        }

        .music-search-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Búsqueda expandida */
        .music-search-container {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            display: none;
        }

        .music-search-container.active {
            display: block;
        }

        .music-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--line);
            border-radius: 20px;
            background: var(--bg-secondary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .music-search-input:focus {
            border-color: var(--primary);
        }

        .music-search-input::placeholder {
            color: var(--muted);
        }

        /* Lista de música */
        .music-list-container {
            max-height: calc(100vh - 380px);
            min-height: 300px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .music-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 8px;
            margin: 4px 0;
        }

        .music-item:hover {
            background: var(--surface-hover);
        }

        .music-item.playing .music-title {
            color: #fe2c55;
        }

        .music-item.selected {
            background: rgba(254, 44, 85, 0.1);
            border: 1px solid rgba(254, 44, 85, 0.3);
        }

        .music-cover {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            background: var(--line);
            object-fit: cover;
            flex-shrink: 0;
        }

        .music-info {
            flex: 1;
            min-width: 0;
        }

        .music-title-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .music-playing-icon {
            display: none;
            color: #fe2c55;
        }

        .music-item.playing .music-playing-icon {
            display: flex;
        }

        .music-playing-icon svg {
            width: 14px;
            height: 14px;
        }

        .music-title {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--fg);
        }

        .music-meta {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 3px;
        }

        .music-meta span {
            margin-right: 4px;
        }

        .music-meta span:not(:last-child)::after {
            content: '·';
            margin-left: 4px;
            color: var(--muted);
        }

        /* Acciones de música */
        .music-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .music-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-action-btn:hover {
            background: var(--surface-hover);
            color: var(--fg);
        }

        .music-action-btn.favorited {
            color: #fe2c55;
        }

        .music-action-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Estado vacío */
        .music-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--muted);
        }

        .music-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .music-empty p {
            font-size: 14px;
        }

        /* =============================================
           AUDIO CUTTER - Waveform Editor
           ============================================= */
        .audio-cutter {
            background: linear-gradient(135deg, #1a9be6 0%, #0d7bc5 100%);
            border-radius: 12px;
            padding: 14px;
            color: white;
        }

        .audio-cutter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .audio-cutter-filename {
            font-weight: 600;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-cutter-info {
            opacity: 0.8;
            font-size: 11px;
        }

        .btn-remove-music {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .btn-remove-music:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .btn-remove-music svg {
            width: 14px;
            height: 14px;
        }

        /* Waveform container */
        .waveform-container {
            position: relative;
            height: 70px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Selection overlay */
        .waveform-selection {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(45, 212, 191, 0.4);
            border-left: 3px solid #2dd4bf;
            border-right: 3px solid #2dd4bf;
        }

        /* Selection handles */
        .selection-handle {
            position: absolute;
            top: 0;
            width: 18px;
            height: 100%;
            cursor: ew-resize;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        .selection-handle .handle-bar {
            width: 5px;
            height: 40px;
            background: white;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .selection-handle:hover .handle-bar,
        .selection-handle.dragging .handle-bar {
            background: #2dd4bf;
            transform: scaleY(1.1);
        }

        .selection-handle.dragging {
            z-index: 30;
        }

        .selection-handle.handle-left {
            left: 0;
            transform: translateX(-50%);
        }

        .selection-handle.handle-right {
            right: 0;
            transform: translateX(50%);
        }

        /* Playhead */
        .waveform-playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: white;
            pointer-events: none;
            display: none;
            z-index: 5;
        }

        /* Waveform time display */
        .waveform-time {
            position: absolute;
            top: 5px;
            left: 6px;
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            z-index: 10;
        }

        /* Controls row */
        .audio-cutter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cutter-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.15s;
        }

        .cutter-play-btn:hover {
            transform: scale(1.05);
        }

        .cutter-play-btn:active {
            transform: scale(0.95);
        }

        .cutter-play-btn svg {
            width: 18px;
            height: 18px;
            fill: #1a9be6;
        }

        .cutter-play-btn .pause-icon {
            display: none;
        }

        .cutter-play-btn.playing .play-icon {
            display: none;
        }

        .cutter-play-btn.playing .pause-icon {
            display: block;
        }

        /* Time inputs */
        .cutter-time-inputs {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .time-input-group label {
            font-size: 9px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-input {
            width: 58px;
            padding: 5px 6px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 11px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            text-align: center;
        }

        .time-input:focus {
            outline: none;
            background: rgba(255,255,255,0.25);
        }

        .duration-group .selection-duration {
            font-size: 13px;
            font-weight: 600;
            color: #2dd4bf;
        }

        /* Volume control */
        .cutter-volume {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .cutter-volume svg {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        .cutter-volume .volume-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
        }

        .cutter-volume .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .cutter-volume .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
        }

        .cutter-volume .volume-value {
            font-size: 11px;
            opacity: 0.8;
            min-width: 30px;
        }

        /* Cutter hint */
        .cutter-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 11px;
            opacity: 0.7;
        }

        .cutter-hint svg {
            flex-shrink: 0;
            width: 14px;
            height: 14px;
        }

        /* Loading state */
        .audio-cutter.loading .waveform-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-cutter.loading .waveform-container::after {
            content: 'Cargando audio...';
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }

        .audio-cutter.loading .waveform-canvas,
        .audio-cutter.loading .waveform-selection,
        .audio-cutter.loading .selection-handle {
            display: none;
        }

        /* Botón confirmar música */
        .btn-confirm-music {
            width: 100%;
            padding: 14px 20px;
            margin-top: 12px;
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);
        }

        .btn-confirm-music:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(45, 212, 191, 0.4);
        }

        .btn-confirm-music:active {
            transform: scale(0.98);
        }

        .btn-confirm-music svg {
            width: 18px;
            height: 18px;
        }

        .btn-confirm-music.confirmed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            pointer-events: none;
        }

        /* Upload música propia */
        .music-upload-section {
            padding: 16px;
            border-bottom: 1px solid var(--line);
        }

        .music-upload-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px dashed var(--line);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .music-upload-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .music-upload-btn svg {
            width: 22px;
            height: 22px;
        }

        .music-upload-btn input[type="file"] {
            display: none;
        }

        /* Diseño mejorado del selector */
        .music-selector {
            background: var(--bg);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--line);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .music-selector-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(254, 44, 85, 0.08) 0%, rgba(254, 44, 85, 0.02) 100%);
            border-bottom: 1px solid var(--line);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .music-selector-header svg {
            width: 22px;
            height: 22px;
            color: #fe2c55;
        }

        .music-selector-header span {
            font-weight: 600;
            font-size: 15px;
        }

        /* Tabs mejorados */
        .music-tabs {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--line);
            padding: 0;
            gap: 0;
            background: var(--bg-secondary);
        }

        .music-tab {
            flex: 1;
            padding: 12px 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            text-align: center;
        }

        .music-tab:hover {
            color: var(--fg);
            background: rgba(254, 44, 85, 0.05);
        }

        .music-tab.active {
            color: #fe2c55;
            font-weight: 600;
            background: var(--bg);
        }

        .music-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #fe2c55;
        }

        .music-search-btn {
            padding: 10px;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
            margin: 0 8px;
            flex-shrink: 0;
        }

        /* Items de música mejorados */
        .music-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 1px solid transparent;
        }

        .music-item:hover {
            background: var(--surface-hover);
        }

        .music-item.selected {
            background: linear-gradient(90deg, rgba(254, 44, 85, 0.1) 0%, rgba(254, 44, 85, 0.02) 100%);
            border-left: 3px solid #fe2c55;
        }

        .music-cover {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--line) 0%, var(--bg-secondary) 100%);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .music-title {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--fg);
            line-height: 1.3;
        }

        .music-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .music-meta .dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--muted);
        }

        /* Herramientas de dibujo */
        .brush-sizes {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .brush-size {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            border: 2px solid var(--line);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-size:hover {
            border-color: var(--muted);
        }

        .brush-size.selected {
            border-color: var(--primary);
        }

        .brush-size-dot {
            border-radius: 50%;
            background: var(--fg);
        }

        /* Grid de estilos de Link */
        .link-styles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .link-style-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-style-option:hover {
            border-color: var(--muted);
            background: var(--surface-hover);
        }

        .link-style-option.selected {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.1);
        }

        .link-style-option span {
            font-size: 10px;
            color: var(--muted);
        }

        /* Previews de estilos de link */
        .link-preview-pill {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-rounded {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-square {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-outline-pill {
            background: transparent;
            color: white;
            padding: 3px 9px;
            border: 1.5px solid white;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-outline-square {
            background: transparent;
            color: white;
            padding: 3px 9px;
            border: 1.5px solid white;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 600;
        }

        .link-preview-swipe {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .link-preview-swipe svg {
            transform: rotate(-90deg);
        }

        .link-preview-minimal {
            color: white;
            font-size: 9px;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        /* Grid de fuentes para Link */
        .link-fonts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .link-font-option {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
        }

        .link-font-option:hover {
            border-color: var(--muted);
            background: var(--surface-hover);
        }

        .link-font-option.selected {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.15);
        }

        .link-font-option span {
            font-size: 11px;
            color: var(--fg);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========================================
           HERRAMIENTAS DE AJUSTE (Voltear, Rotar, Filtros)
           ======================================== */
        .adjust-buttons {
            display: flex;
            gap: 8px;
        }

        .adjust-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--fg);
            font-size: 12px;
            font-weight: 500;
        }

        .adjust-btn:hover {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.1);
        }

        .adjust-btn:active {
            transform: scale(0.95);
        }

        .adjust-btn svg {
            color: var(--muted);
            transition: color 0.2s;
        }

        .adjust-btn:hover svg {
            color: var(--primary);
        }

        /* Grid de filtros */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .filter-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 8px 4px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-option:hover {
            border-color: var(--muted);
        }

        .filter-option.selected {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.15);
        }

        .filter-preview {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: var(--line);
        }

        .filter-option span {
            font-size: 10px;
            color: var(--muted);
            text-align: center;
        }

        .filter-option.selected span {
            color: var(--primary);
            font-weight: 600;
        }

        /* Selector Lado A/B */
        .lado-selector {
            display: flex;
            gap: 12px;
        }

        .lado-option {
            flex: 1;
            padding: 12px;
            background: var(--bg);
            border: 2px solid var(--line);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lado-option:hover {
            border-color: var(--muted);
        }

        .lado-option.selected {
            border-color: var(--primary);
            background: rgba(70, 130, 180, 0.1);
        }

        /* Upload inicial */
        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            cursor: pointer;
            z-index: 100;
        }

        .upload-overlay.hidden {
            display: none;
        }

        .upload-overlay svg {
            width: 64px;
            height: 64px;
            color: var(--muted);
        }

        .upload-overlay p {
            color: var(--muted);
            font-size: 14px;
        }

        .upload-overlay span {
            color: var(--primary);
            font-weight: 600;
        }

        /* ========================================
           RESPONSIVE - Tablet (1024px - 768px)
           ======================================== */
        @@media (max-width: 1024px) {
            .options-panel {
                width: 300px;
            }

            .canvas-wrapper {
                max-width: 340px;
            }
        }

        /* ========================================
           RESPONSIVE - Móvil (< 768px)
           ======================================== */
        @@media (max-width: 768px) {
            /* Ocultar tooltip en móvil */
            .tool-btn::after {
                display: none;
            }

            /* Panel de opciones como bottom sheet */
            .options-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 55vh;
                max-height: 55vh;
                z-index: 200;
                border-left: none;
                border-top: none;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 -10px 40px var(--shadow-strong);
            }

            .options-panel::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: var(--line);
                border-radius: 2px;
            }

            .options-panel.open {
                transform: translateY(0);
            }

            .options-header {
                padding-top: 24px;
            }

            /* Backdrop para cerrar el panel */
            .options-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 199;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }

            .options-backdrop.active {
                opacity: 1;
                visibility: visible;
            }

            /* Panel de herramientas inferior */
            .tools-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 8px 12px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
                border-right: none;
                border-top: 1px solid var(--line);
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                z-index: 100;
            }

            .tools-panel .tools-divider,
            .tools-panel .desktop-only {
                display: none;
            }

            .close-editor-btn {
                display: none !important;
            }

            .tool-btn {
                width: 44px;
                height: 44px;
            }

            .tool-btn svg {
                width: 20px;
                height: 20px;
            }

            /* Canvas centrado con espacio para paneles */
            .canvas-area {
                padding: 0;
                padding-top: 60px;
                padding-bottom: 72px;
            }

            .canvas-wrapper {
                max-width: 100%;
                width: 100%;
                border-radius: 0;
                box-shadow: none;
            }

            .canvas-wrapper:hover {
                box-shadow: none;
            }
        }

        /* Header móvil */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--line);
            padding: 0 12px;
            align-items: center;
            justify-content: space-between;
            z-index: 150;
        }

        @@media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }
        }

        .close-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            color: var(--fg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .close-btn:hover {
            background: var(--surface-hover);
        }

        .close-btn:active {
            transform: scale(0.9);
        }

        .mobile-header .title {
            font-weight: 600;
            font-size: 16px;
            color: var(--fg);
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 8px;
        }

        .mobile-header .btn-primary {
            padding: 8px 16px;
            font-size: 13px;
            flex-shrink: 0;
        }

        /* ========================================
           RESPONSIVE - Móvil pequeño (< 400px)
           ======================================== */
        @@media (max-width: 400px) {
            .tool-btn {
                width: 40px;
                height: 40px;
            }

            .tool-btn svg {
                width: 18px;
                height: 18px;
            }

            .options-content {
                padding: 16px;
            }

            .sticker-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .font-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--line);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           CROP / RECORTE
           ======================================== */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
        }

        .crop-overlay.active {
            display: flex;
            flex-direction: column;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
        }

        .crop-header h4 {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .crop-actions {
            display: flex;
            gap: 8px;
        }

        .crop-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .crop-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .crop-btn-apply {
            background: var(--primary);
            color: white;
        }

        .crop-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .crop-box {
            position: absolute;
            border: 2px solid white;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            cursor: move;
        }

        .crop-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .crop-handle-tl { top: -10px; left: -10px; cursor: nwse-resize; }
        .crop-handle-tr { top: -10px; right: -10px; cursor: nesw-resize; }
        .crop-handle-bl { bottom: -10px; left: -10px; cursor: nesw-resize; }
        .crop-handle-br { bottom: -10px; right: -10px; cursor: nwse-resize; }

        .crop-footer {
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .aspect-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aspect-btn:hover, .aspect-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* ========================================
           FONDOS / BACKGROUNDS
           ======================================== */
        .backgrounds-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .bg-option {
            aspect-ratio: 9/16;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .bg-option:hover {
            transform: scale(1.05);
            border-color: var(--muted);
        }

        .bg-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.3);
        }

        .bg-colors-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .bg-color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .bg-color-option:hover {
            transform: scale(1.1);
        }

        .bg-color-option.selected {
            border-color: var(--fg);
        }

        .gradient-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* ========================================
           PLANTILLAS / TEMPLATES
           ======================================== */
        .templates-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) transparent;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .templates-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .templates-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .templates-tabs::-webkit-scrollbar-thumb {
            background: var(--line);
            border-radius: 4px;
        }

        .templates-tabs::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .template-tab {
            padding: 8px 14px;
            background: var(--bg);
            border: 1px solid var(--line);
            border-radius: 20px;
            color: var(--muted);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .template-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .template-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: calc(100vh - 280px);
            min-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }

        @@media (min-width: 769px) {
            .templates-grid {
                grid-template-columns: repeat(2, 1fr);
                max-height: calc(100vh - 200px);
            }
        }

        .template-item {
            aspect-ratio: 9/16;
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--line);
            transition: all 0.2s;
            min-height: 180px;
        }

        .template-item:hover {
            transform: scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .template-item:active {
            transform: scale(0.98);
        }

        .template-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            text-align: center;
            gap: 2px;
        }

        .template-preview span {
            display: block;
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            color: white;
            font-size: 10px;
            font-weight: 500;
            text-align: center;
        }

        .template-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            font-size: 9px;
            font-weight: 600;
            border-radius: 10px;
            text-transform: uppercase;
        }

        @@media (max-width: 400px) {
            .templates-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .backgrounds-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .template-item {
                min-height: 150px;
            }
        }

        /* ========================================
           BEAT SYNC - Video musical sincronizado
           ======================================== */
        .beatsync-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .beatsync-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
        }

        .beatsync-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .beatsync-section-title svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }

        /* Upload de música */
        .beatsync-music-upload {
            border: 2px dashed var(--line);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .beatsync-music-upload:hover {
            border-color: var(--primary);
            background: var(--primary-alpha);
        }

        .beatsync-music-upload.has-music {
            border-style: solid;
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .beatsync-music-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            color: var(--muted);
        }

        .beatsync-music-upload.has-music .beatsync-music-icon {
            color: var(--success);
        }

        .beatsync-music-text {
            font-size: 13px;
            color: var(--muted);
        }

        .beatsync-music-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Upload de fotos */
        .beatsync-photos-upload {
            border: 2px dashed var(--line);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 100px;
        }

        .beatsync-photos-upload:hover {
            border-color: var(--primary);
            background: var(--primary-alpha);
        }

        .beatsync-photos-upload.has-photos {
            border-style: solid;
            padding: 12px;
        }

        .beatsync-photos-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .beatsync-photo-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }

        .beatsync-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .beatsync-photo-item .photo-number {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beatsync-photo-item .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .beatsync-photo-item:hover .photo-remove {
            display: flex;
        }

        .beatsync-add-more {
            aspect-ratio: 1;
            border: 2px dashed var(--line);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--muted);
            font-size: 24px;
            transition: all 0.2s;
        }

        .beatsync-add-more:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .beatsync-photos-count {
            margin-top: 8px;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        .beatsync-photos-actions {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .beatsync-photos-hint {
            font-size: 11px;
            color: var(--muted);
        }

        .beatsync-shuffle-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            font-size: 11px;
            background: var(--bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            color: var(--fg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .beatsync-shuffle-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Configuración */
        .beatsync-config {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .beatsync-config-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .beatsync-config-label {
            font-size: 13px;
            color: var(--fg-secondary);
            flex-shrink: 0;
        }

        .beatsync-select {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: var(--bg);
            color: var(--fg);
            font-size: 13px;
            cursor: pointer;
            max-width: 160px;
        }

        .beatsync-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 180px;
        }

        .beatsync-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--line);
            border-radius: 3px;
            outline: none;
        }

        .beatsync-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .beatsync-slider-value {
            font-size: 12px;
            color: var(--muted);
            min-width: 30px;
            text-align: right;
        }

        /* Visualizador de audio con timeline */
        .beatsync-waveform-container {
            margin-top: 12px;
        }

        .beatsync-waveform {
            height: 80px;
            background: var(--bg);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .beatsync-waveform canvas {
            width: 100%;
            height: 100%;
        }

        .beatsync-waveform-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            pointer-events: none;
            display: none;
            z-index: 2;
        }

        .beatsync-waveform-playhead::after {
            content: '';
            position: absolute;
            top: 0;
            left: -4px;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
        }

        .beatsync-time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
            padding: 0 4px;
        }

        .beatsync-beats-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px 12px;
            background: var(--bg);
            border-radius: 8px;
            gap: 12px;
        }

        .beatsync-beats-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .beatsync-beats-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
        }

        .beatsync-beats-dot.active {
            animation: beatPulse 0.3s ease-out;
        }

        .beatsync-beats-text {
            font-size: 12px;
            color: var(--muted);
        }

        .beatsync-beats-count {
            font-weight: 600;
            color: var(--primary);
        }

        .beatsync-reanalyze-btn {
            padding: 6px 12px;
            font-size: 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--line);
            border-radius: 6px;
            color: var(--fg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .beatsync-reanalyze-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .beatsync-reanalyze-btn svg {
            width: 12px;
            height: 12px;
        }

        @@keyframes beatPulse {
            0% { transform: scale(1); background: var(--primary); }
            50% { transform: scale(1.8); background: #ef4444; }
            100% { transform: scale(1); background: var(--primary); }
        }

        /* Modo de detección */
        .beatsync-mode-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .beatsync-mode-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            background: var(--bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .beatsync-mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .beatsync-mode-btn:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Recortador de audio */
        .beatsync-trim-section {
            margin-top: 12px;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--line);
        }

        .beatsync-trim-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 10px;
        }

        .beatsync-trim-header svg {
            color: var(--primary);
        }

        .beatsync-trim-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .beatsync-trim-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 120px;
        }

        .beatsync-trim-row label {
            font-size: 11px;
            color: var(--fg-secondary);
            min-width: 40px;
        }

        .beatsync-trim-input {
            flex: 1;
            padding: 6px 8px;
            font-size: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--line);
            border-radius: 6px;
            color: var(--fg);
            width: 60px;
            text-align: center;
        }

        .beatsync-trim-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .beatsync-trim-unit {
            font-size: 10px;
            color: var(--muted);
        }

        .beatsync-trim-duration {
            margin-top: 8px;
            font-size: 11px;
            color: var(--fg-secondary);
            text-align: center;
        }

        .beatsync-trim-duration strong {
            color: var(--primary);
        }

        /* Preview mejorado */
        .beatsync-preview-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            margin-top: 8px;
        }

        .beatsync-preview {
            position: relative;
            aspect-ratio: 9/16;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            max-height: 280px;
            margin: 0 auto;
        }

        .beatsync-preview-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .beatsync-preview-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .beatsync-preview:hover .beatsync-preview-overlay:not(.playing) {
            opacity: 1;
        }

        .beatsync-preview-overlay.playing {
            opacity: 0;
            pointer-events: none;
        }

        .beatsync-preview-play {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.9);
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .beatsync-preview-play:hover {
            transform: scale(1.1);
            background: white;
        }

        .beatsync-preview-play svg {
            width: 28px;
            height: 28px;
            margin-left: 4px;
        }

        .beatsync-preview-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 8px 0;
        }

        .beatsync-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg);
            color: var(--fg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .beatsync-control-btn:hover {
            background: var(--primary);
            color: white;
        }

        .beatsync-control-btn.active {
            background: var(--primary);
            color: white;
        }

        .beatsync-control-btn svg {
            width: 16px;
            height: 16px;
        }

        .beatsync-control-btn.main {
            width: 44px;
            height: 44px;
            background: var(--primary);
            color: white;
        }

        .beatsync-control-btn.main svg {
            width: 20px;
            height: 20px;
        }

        .beatsync-control-btn.main:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }

        .beatsync-timeline {
            flex: 1;
            height: 4px;
            background: var(--line);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .beatsync-timeline-progress {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .beatsync-timeline-time {
            font-size: 11px;
            color: var(--muted);
            min-width: 70px;
            text-align: right;
        }

        .beatsync-beat-flash {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.05s;
        }

        .beatsync-beat-flash.active {
            opacity: 1;
        }

        /* Photo counter en preview */
        .beatsync-photo-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            border-radius: 12px;
            font-size: 11px;
            color: white;
            font-weight: 500;
        }

        /* Botones de acción */
        .beatsync-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .beatsync-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .beatsync-btn-secondary {
            background: var(--bg-secondary);
            color: var(--fg);
            border: 1px solid var(--line);
        }

        .beatsync-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .beatsync-btn-primary {
            background: var(--primary);
            color: white;
        }

        .beatsync-btn-primary:hover {
            filter: brightness(1.1);
        }

        .beatsync-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .beatsync-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Progress durante generación */
        .beatsync-progress {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 12px;
        }

        .beatsync-progress.active {
            display: flex;
        }

        .beatsync-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--line);
            border-radius: 4px;
            overflow: hidden;
        }

        .beatsync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .beatsync-progress-text {
            font-size: 13px;
            color: var(--muted);
        }

        @@media (max-width: 768px) {
            .beatsync-container {
                max-height: calc(100vh - 280px);
            }

            .beatsync-photos-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .beatsync-config-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .beatsync-select, .beatsync-slider-container {
                max-width: 100%;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()

    <!-- Script para detectar y aplicar tema guardado (sincronizado con Layout) -->
    <script>
        // ThemeStorage - copia del Layout para consistencia
        const ThemeStorage = {
            _storage: null,
            _memoryFallback: {},

            init: function() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    this._storage = localStorage;
                } catch (e) {
                    this._storage = null;
                }
            },

            getItem: function(key) {
                if (this._storage) {
                    return this._storage.getItem(key);
                }
                return this._memoryFallback[key] || null;
            },

            setItem: function(key, value) {
                if (this._storage) {
                    try {
                        this._storage.setItem(key, value);
                    } catch (e) {
                        this._memoryFallback[key] = value;
                    }
                } else {
                    this._memoryFallback[key] = value;
                }
            }
        };

        ThemeStorage.init();

        (function() {
            // Detectar tema guardado
            var savedTheme = ThemeStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body?.classList.remove('theme-light', 'theme-dark');
            document.body?.classList.add('theme-' + savedTheme);
        })();

        // Escuchar cambios de tema desde otras pestanas
        window.addEventListener('storage', function(e) {
            if (e.key === 'theme') {
                var newTheme = e.newValue || 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                document.body.classList.remove('theme-light', 'theme-dark');
                document.body.classList.add('theme-' + newTheme);
            }
        });
    </script>

    <!-- Backdrop para cerrar panel en móvil -->
    <div class="options-backdrop" id="optionsBackdrop" onclick="cerrarPanelOpciones()"></div>

    <div class="story-editor">
        <!-- Header móvil -->
        <div class="mobile-header">
            <button class="close-btn" onclick="cancelarEditor()" aria-label="Cerrar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <span class="title">@titulo</span>
            <button class="btn btn-primary" onclick="publicarStory()">@textoPublicar</button>
        </div>

        <!-- Panel de herramientas -->
        <div class="tools-panel">
            <!-- Botón de salir (visible en desktop) -->
            <button class="tool-btn close-editor-btn" title="Salir" onclick="cancelarEditor()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
            <div class="tools-divider desktop-only"></div>
            <button class="tool-btn active" data-tool="text" title="Texto" onclick="seleccionarHerramienta('text')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="sticker" title="Stickers" onclick="seleccionarHerramienta('sticker')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="mention" title="Mencionar" onclick="seleccionarHerramienta('mention')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="4"/>
                    <path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="draw" title="Dibujar" onclick="seleccionarHerramienta('draw')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="music" title="Música" onclick="seleccionarHerramienta('music')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="link" title="Enlace" onclick="seleccionarHerramienta('link')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="adjust" title="Ajustes" onclick="seleccionarHerramienta('adjust')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="crop" title="Recortar" onclick="seleccionarHerramienta('crop')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2v14a2 2 0 0 0 2 2h14"/>
                    <path d="M18 22V8a2 2 0 0 0-2-2H2"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="background" title="Fondos" onclick="seleccionarHerramienta('background')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="template" title="Plantillas" onclick="seleccionarHerramienta('template')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="9"/>
                    <rect x="14" y="3" width="7" height="5"/>
                    <rect x="14" y="12" width="7" height="9"/>
                    <rect x="3" y="16" width="7" height="5"/>
                </svg>
            </button>
            <button class="tool-btn" data-tool="beatsync" title="Beat Sync" onclick="seleccionarHerramienta('beatsync')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 12h2l2-6 3 12 3-8 2 4h8"/>
                    <circle cx="20" cy="12" r="2"/>
                </svg>
            </button>

            <div class="tools-divider"></div>

            <button class="tool-btn" title="Deshacer" onclick="deshacerCambio()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                </svg>
            </button>
            <button class="tool-btn" title="Eliminar selección" onclick="eliminarSeleccion()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
        </div>

        <!-- Canvas central -->
        <div class="canvas-area">
            <div class="canvas-wrapper" id="canvasWrapper">
                <!-- Overlay de upload inicial -->
                <div class="upload-overlay" id="uploadOverlay" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <p><span>Toca para subir</span> una foto o video</p>
                </div>
                <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;" onchange="cargarMedia(this)">

                <!-- Video de fondo (para cuando se sube un video) -->
                <video id="videoBackground" muted loop playsinline></video>

                <!-- Canvas de Fabric.js (superpuesto) -->
                <canvas id="storyCanvas"></canvas>
            </div>
        </div>

        <!-- Panel de opciones -->
        <div class="options-panel" id="optionsPanel">
            <div class="options-header">
                <h3 id="optionsTitle">Texto</h3>
                <button class="close-btn" onclick="cerrarPanelOpciones()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="options-content">
                <!-- TEXTO -->
                <div class="option-section active" id="textOptions">
                    <div class="option-group">
                        <label class="option-label">Tu texto</label>
                        <textarea class="text-input" id="textInput" rows="3" placeholder="Escribe aquí..." oninput="actualizarTextoSeleccionado()"></textarea>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Fuente</label>
                        <div class="link-fonts-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="link-font-option selected" data-font="Poppins" onclick="cambiarFuente('Poppins', this)">
                                <span style="font-family: 'Poppins';">Poppins</span>
                            </div>
                            <div class="link-font-option" data-font="Montserrat" onclick="cambiarFuente('Montserrat', this)">
                                <span style="font-family: 'Montserrat';">Montserrat</span>
                            </div>
                            <div class="link-font-option" data-font="Roboto" onclick="cambiarFuente('Roboto', this)">
                                <span style="font-family: 'Roboto';">Roboto</span>
                            </div>
                            <div class="link-font-option" data-font="Oswald" onclick="cambiarFuente('Oswald', this)">
                                <span style="font-family: 'Oswald';">Oswald</span>
                            </div>
                            <div class="link-font-option" data-font="Bebas Neue" onclick="cambiarFuente('Bebas Neue', this)">
                                <span style="font-family: 'Bebas Neue';">BEBAS</span>
                            </div>
                            <div class="link-font-option" data-font="Anton" onclick="cambiarFuente('Anton', this)">
                                <span style="font-family: 'Anton';">ANTON</span>
                            </div>
                            <div class="link-font-option" data-font="Playfair Display" onclick="cambiarFuente('Playfair Display', this)">
                                <span style="font-family: 'Playfair Display';">Playfair</span>
                            </div>
                            <div class="link-font-option" data-font="Lobster" onclick="cambiarFuente('Lobster', this)">
                                <span style="font-family: 'Lobster';">Lobster</span>
                            </div>
                            <div class="link-font-option" data-font="Pacifico" onclick="cambiarFuente('Pacifico', this)">
                                <span style="font-family: 'Pacifico';">Pacifico</span>
                            </div>
                            <div class="link-font-option" data-font="Dancing Script" onclick="cambiarFuente('Dancing Script', this)">
                                <span style="font-family: 'Dancing Script';">Dancing</span>
                            </div>
                            <div class="link-font-option" data-font="Permanent Marker" onclick="cambiarFuente('Permanent Marker', this)">
                                <span style="font-family: 'Permanent Marker';">Marker</span>
                            </div>
                            <div class="link-font-option" data-font="Satisfy" onclick="cambiarFuente('Satisfy', this)">
                                <span style="font-family: 'Satisfy';">Satisfy</span>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Tamaño: <span id="fontSizeLabel">32</span>px</label>
                        <input type="range" class="size-slider" id="fontSizeSlider" min="16" max="72" value="32" oninput="cambiarTamanoTexto(this.value)">
                    </div>
                    <div class="option-group">
                        <label class="option-label">Color del texto</label>
                        <div class="color-picker" id="textColorPicker">
                            <div class="color-option selected" style="background: #ffffff;" onclick="cambiarColorTexto('#ffffff', this)"></div>
                            <div class="color-option" style="background: #000000;" onclick="cambiarColorTexto('#000000', this)"></div>
                            <div class="color-option" style="background: #ff3b5c;" onclick="cambiarColorTexto('#ff3b5c', this)"></div>
                            <div class="color-option" style="background: #00d4ff;" onclick="cambiarColorTexto('#00d4ff', this)"></div>
                            <div class="color-option" style="background: #ffdd00;" onclick="cambiarColorTexto('#ffdd00', this)"></div>
                            <div class="color-option" style="background: #00ff88;" onclick="cambiarColorTexto('#00ff88', this)"></div>
                            <div class="color-option" style="background: #ff00ff;" onclick="cambiarColorTexto('#ff00ff', this)"></div>
                            <div class="color-option" style="background: #ff8800;" onclick="cambiarColorTexto('#ff8800', this)"></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Fondo del texto</label>
                        <div class="color-picker" id="textBgPicker">
                            <div class="color-option selected" style="background: transparent; border: 2px dashed #666;" onclick="cambiarFondoTexto('transparent', this)"></div>
                            <div class="color-option" style="background: rgba(0,0,0,0.7);" onclick="cambiarFondoTexto('rgba(0,0,0,0.7)', this)"></div>
                            <div class="color-option" style="background: rgba(255,255,255,0.9);" onclick="cambiarFondoTexto('rgba(255,255,255,0.9)', this)"></div>
                            <div class="color-option" style="background: rgba(70,130,180,0.8);" onclick="cambiarFondoTexto('rgba(70,130,180,0.8)', this)"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="agregarTexto()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Agregar texto
                    </button>
                </div>

                <!-- STICKERS -->
                <div class="option-section" id="stickerOptions">
                    <div class="option-group">
                        <label class="option-label">Emojis populares</label>
                        <div class="sticker-grid" id="emojiGrid">
                            <!-- Se llena con JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- MENCIONES -->
                <div class="option-section" id="mentionOptions">
                    <div class="option-group">
                        <label class="option-label">Buscar usuario</label>
                        <div class="mention-search">
                            <input type="text" class="text-input" id="mentionSearch" placeholder="@@usuario" oninput="buscarUsuarios(this.value)">
                            <div class="mention-results" id="mentionResults"></div>
                        </div>
                    </div>
                </div>

                <!-- DIBUJO -->
                <div class="option-section" id="drawOptions">
                    <div class="option-group">
                        <label class="option-label">Grosor del pincel</label>
                        <div class="brush-sizes">
                            <div class="brush-size selected" onclick="cambiarGrosorPincel(3, this)">
                                <div class="brush-size-dot" style="width: 6px; height: 6px;"></div>
                            </div>
                            <div class="brush-size" onclick="cambiarGrosorPincel(6, this)">
                                <div class="brush-size-dot" style="width: 10px; height: 10px;"></div>
                            </div>
                            <div class="brush-size" onclick="cambiarGrosorPincel(12, this)">
                                <div class="brush-size-dot" style="width: 16px; height: 16px;"></div>
                            </div>
                            <div class="brush-size" onclick="cambiarGrosorPincel(20, this)">
                                <div class="brush-size-dot" style="width: 22px; height: 22px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Color del pincel</label>
                        <div class="color-picker" id="brushColorPicker">
                            <div class="color-option selected" style="background: #ff3b5c;" onclick="cambiarColorPincel('#ff3b5c', this)"></div>
                            <div class="color-option" style="background: #ffffff;" onclick="cambiarColorPincel('#ffffff', this)"></div>
                            <div class="color-option" style="background: #000000;" onclick="cambiarColorPincel('#000000', this)"></div>
                            <div class="color-option" style="background: #00d4ff;" onclick="cambiarColorPincel('#00d4ff', this)"></div>
                            <div class="color-option" style="background: #ffdd00;" onclick="cambiarColorPincel('#ffdd00', this)"></div>
                            <div class="color-option" style="background: #00ff88;" onclick="cambiarColorPincel('#00ff88', this)"></div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="borrarDibujo()">
                        Borrar todo el dibujo
                    </button>
                </div>

                <!-- MÚSICA -->
                <div class="option-section" id="musicOptions">
                    <!-- Audio Cutter - Canción seleccionada -->
                    <div class="option-group" id="selectedMusicContainer" style="display: none;">
                        <div class="audio-cutter" id="audioCutterContainer">
                            <div class="audio-cutter-header">
                                <div class="audio-cutter-filename" id="selectedMusicTitle">-</div>
                                <div style="display: flex; align-items: center;">
                                    <div class="audio-cutter-info">
                                        <span id="cutterDuration">00:00</span>
                                    </div>
                                    <button type="button" class="btn-remove-music" onclick="quitarMusica()" title="Quitar musica">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Contenedor de forma de onda -->
                            <div class="waveform-container" id="waveformContainer">
                                <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                                <div class="waveform-selection" id="waveformSelection">
                                    <div class="selection-handle handle-left" id="handleLeft">
                                        <div class="handle-bar"></div>
                                    </div>
                                    <div class="selection-handle handle-right" id="handleRight">
                                        <div class="handle-bar"></div>
                                    </div>
                                </div>
                                <div class="waveform-playhead" id="waveformPlayhead"></div>
                                <div class="waveform-time" id="waveformTime">00:00.0</div>
                            </div>

                            <!-- Controles del cutter -->
                            <div class="audio-cutter-controls">
                                <button type="button" class="cutter-play-btn" id="cutterPlayBtn">
                                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                    </svg>
                                </button>

                                <div class="cutter-time-inputs">
                                    <div class="time-input-group">
                                        <label>Desde</label>
                                        <input type="text" class="time-input" id="cutStartInput" value="00:00.0" readonly>
                                    </div>
                                    <div class="time-input-group">
                                        <label>Hasta</label>
                                        <input type="text" class="time-input" id="cutEndInput" value="00:15.0" readonly>
                                    </div>
                                    <div class="time-input-group duration-group">
                                        <label>Duracion</label>
                                        <span class="selection-duration" id="selectionDuration">15.0s</span>
                                    </div>
                                </div>

                                <div class="cutter-volume">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                    <input type="range" class="volume-slider" id="cutterVolumeSlider" min="0" max="100" value="70">
                                    <span class="volume-value" id="cutterVolumeValue">70%</span>
                                </div>
                            </div>

                            <div class="cutter-hint">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                Arrastra los controles para seleccionar el fragmento
                            </div>

                            <!-- Botón confirmar música -->
                            <button type="button" class="btn-confirm-music" id="btnConfirmMusic" onclick="confirmarMusica()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Usar esta música</span>
                            </button>
                        </div>
                    </div>

                    <!-- Selector de música estilo TikTok -->
                    <div class="music-selector">
                        <!-- Header -->
                        <div class="music-selector-header">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                            <span>Agregar música</span>
                        </div>

                        <!-- Subir música propia -->
                        <div class="music-upload-section">
                            <label class="music-upload-btn" for="musicFileInput">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span>Subir tu propia música</span>
                                <input type="file" id="musicFileInput" accept="audio/*" onchange="handleMusicUpload(this)">
                            </label>
                        </div>

                        <!-- Tabs -->
                        <div class="music-tabs">
                            <button type="button" class="music-tab active" data-tab="popular" onclick="cambiarTabMusica('popular', this)">Popular</button>
                            <button type="button" class="music-tab" data-tab="parati" onclick="cambiarTabMusica('parati', this)">Para ti</button>
                            <button type="button" class="music-tab" data-tab="favoritos" onclick="cambiarTabMusica('favoritos', this)">Favoritos</button>
                            <button type="button" class="music-tab" data-tab="recientes" onclick="cambiarTabMusica('recientes', this)">Recientes</button>
                            <button type="button" class="music-search-btn" onclick="toggleMusicSearch()" title="Buscar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Búsqueda -->
                        <div class="music-search-container" id="musicSearchContainer">
                            <input type="text" class="music-search-input" id="musicSearch" placeholder="Buscar canciones..." oninput="buscarMusica(this.value)">
                        </div>

                        <!-- Lista de canciones -->
                        <div id="musicList" class="music-list-container">
                            <div class="music-empty">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                                <p>Cargando musica...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LINK -->
                <div class="option-section" id="linkOptions">
                    <div class="option-group">
                        <label class="option-label">URL del enlace</label>
                        <input type="url" class="text-input" id="linkUrl" placeholder="https://ejemplo.com" />
                    </div>
                    <div class="option-group">
                        <label class="option-label">Texto del boton</label>
                        <input type="text" class="text-input" id="linkText" placeholder="Ver mas" maxlength="25" value="Ver mas" />
                    </div>
                    <div class="option-group">
                        <label class="option-label">Estilo del boton</label>
                        <div class="link-styles-grid">
                            <!-- Fila 1: Botones solidos -->
                            <div class="link-style-option selected" data-style="pill" onclick="cambiarEstiloLink('pill', this)">
                                <div class="link-preview-pill">Ver mas</div>
                                <span>Pill</span>
                            </div>
                            <div class="link-style-option" data-style="rounded" onclick="cambiarEstiloLink('rounded', this)">
                                <div class="link-preview-rounded">Ver mas</div>
                                <span>Rounded</span>
                            </div>
                            <div class="link-style-option" data-style="square" onclick="cambiarEstiloLink('square', this)">
                                <div class="link-preview-square">Ver mas</div>
                                <span>Square</span>
                            </div>
                            <!-- Fila 2: Botones con borde -->
                            <div class="link-style-option" data-style="outline-pill" onclick="cambiarEstiloLink('outline-pill', this)">
                                <div class="link-preview-outline-pill">Ver mas</div>
                                <span>Outline</span>
                            </div>
                            <div class="link-style-option" data-style="outline-square" onclick="cambiarEstiloLink('outline-square', this)">
                                <div class="link-preview-outline-square">Ver mas</div>
                                <span>Border</span>
                            </div>
                            <div class="link-style-option" data-style="glass" onclick="cambiarEstiloLink('glass', this)">
                                <div class="link-preview-glass">Ver mas</div>
                                <span>Glass</span>
                            </div>
                            <!-- Fila 3: Estilos especiales -->
                            <div class="link-style-option" data-style="gradient" onclick="cambiarEstiloLink('gradient', this)">
                                <div class="link-preview-gradient">Ver mas</div>
                                <span>Gradient</span>
                            </div>
                            <div class="link-style-option" data-style="swipe" onclick="cambiarEstiloLink('swipe', this)">
                                <div class="link-preview-swipe">
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                                    Desliza
                                </div>
                                <span>Swipe</span>
                            </div>
                            <div class="link-style-option" data-style="minimal" onclick="cambiarEstiloLink('minimal', this)">
                                <div class="link-preview-minimal">Ver mas →</div>
                                <span>Minimal</span>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Color del boton</label>
                        <div class="color-picker" id="linkColorPicker">
                            <div class="color-option selected" style="background: #4682B4;" onclick="cambiarColorLink('#4682B4', this)"></div>
                            <div class="color-option" style="background: #000000;" onclick="cambiarColorLink('#000000', this)"></div>
                            <div class="color-option" style="background: #ffffff;" onclick="cambiarColorLink('#ffffff', this)"></div>
                            <div class="color-option" style="background: #ff3b5c;" onclick="cambiarColorLink('#ff3b5c', this)"></div>
                            <div class="color-option" style="background: #00d4ff;" onclick="cambiarColorLink('#00d4ff', this)"></div>
                            <div class="color-option" style="background: #ffdd00;" onclick="cambiarColorLink('#ffdd00', this)"></div>
                            <div class="color-option" style="background: #00ff88;" onclick="cambiarColorLink('#00ff88', this)"></div>
                            <div class="color-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="cambiarColorLink('gradient-purple', this)"></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Tipografia</label>
                        <div class="link-fonts-grid">
                            <div class="link-font-option selected" data-font="Poppins" onclick="cambiarFuenteLink('Poppins', this)">
                                <span style="font-family: 'Poppins', sans-serif; font-weight: 600;">Poppins</span>
                            </div>
                            <div class="link-font-option" data-font="Montserrat" onclick="cambiarFuenteLink('Montserrat', this)">
                                <span style="font-family: 'Montserrat', sans-serif; font-weight: 700;">Montserrat</span>
                            </div>
                            <div class="link-font-option" data-font="Roboto" onclick="cambiarFuenteLink('Roboto', this)">
                                <span style="font-family: 'Roboto', sans-serif; font-weight: 700;">Roboto</span>
                            </div>
                            <div class="link-font-option" data-font="Oswald" onclick="cambiarFuenteLink('Oswald', this)">
                                <span style="font-family: 'Oswald', sans-serif; font-weight: 600;">Oswald</span>
                            </div>
                            <div class="link-font-option" data-font="Bebas Neue" onclick="cambiarFuenteLink('Bebas Neue', this)">
                                <span style="font-family: 'Bebas Neue', sans-serif;">BEBAS</span>
                            </div>
                            <div class="link-font-option" data-font="Anton" onclick="cambiarFuenteLink('Anton', this)">
                                <span style="font-family: 'Anton', sans-serif;">ANTON</span>
                            </div>
                            <div class="link-font-option" data-font="Playfair Display" onclick="cambiarFuenteLink('Playfair Display', this)">
                                <span style="font-family: 'Playfair Display', serif; font-weight: 700;">Playfair</span>
                            </div>
                            <div class="link-font-option" data-font="Lobster" onclick="cambiarFuenteLink('Lobster', this)">
                                <span style="font-family: 'Lobster', cursive;">Lobster</span>
                            </div>
                            <div class="link-font-option" data-font="Pacifico" onclick="cambiarFuenteLink('Pacifico', this)">
                                <span style="font-family: 'Pacifico', cursive;">Pacifico</span>
                            </div>
                            <div class="link-font-option" data-font="Dancing Script" onclick="cambiarFuenteLink('Dancing Script', this)">
                                <span style="font-family: 'Dancing Script', cursive; font-weight: 700;">Dancing</span>
                            </div>
                            <div class="link-font-option" data-font="Permanent Marker" onclick="cambiarFuenteLink('Permanent Marker', this)">
                                <span style="font-family: 'Permanent Marker', cursive;">Marker</span>
                            </div>
                            <div class="link-font-option" data-font="Satisfy" onclick="cambiarFuenteLink('Satisfy', this)">
                                <span style="font-family: 'Satisfy', cursive;">Satisfy</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="agregarLink()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        Agregar enlace
                    </button>
                    <div id="linkAddedIndicator" style="display: none; margin-top: 12px; padding: 10px; background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; text-align: center;">
                        <span style="color: #00ff88; font-size: 13px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="vertical-align: middle; margin-right: 4px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Enlace agregado - puedes moverlo
                        </span>
                        <button onclick="eliminarLinkActual()" style="display: block; margin: 8px auto 0; padding: 4px 12px; background: transparent; border: 1px solid #ff3b5c; color: #ff3b5c; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Eliminar enlace
                        </button>
                    </div>
                </div>

                <!-- AJUSTES DE IMAGEN/VIDEO -->
                <div class="option-section" id="adjustOptions">
                    <!-- Voltear -->
                    <div class="option-group">
                        <label class="option-label">Voltear</label>
                        <div class="adjust-buttons">
                            <button class="adjust-btn" onclick="voltearHorizontal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/>
                                </svg>
                                Horizontal
                            </button>
                            <button class="adjust-btn" onclick="voltearVertical()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M21 8V3h-5M3 16l18-13M3 8V3h5M9 9L3 3M21 16v5h-5M15 15l6 6"/>
                                </svg>
                                Vertical
                            </button>
                        </div>
                    </div>

                    <!-- Rotar -->
                    <div class="option-group">
                        <label class="option-label">Rotar</label>
                        <div class="adjust-buttons">
                            <button class="adjust-btn" onclick="rotarImagen(-90)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/>
                                </svg>
                                -90°
                            </button>
                            <button class="adjust-btn" onclick="rotarImagen(90)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                                </svg>
                                +90°
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="option-group">
                        <label class="option-label">Filtros</label>
                        <div class="filters-grid">
                            <div class="filter-option selected" onclick="aplicarFiltro('none', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                                <span>Original</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('grayscale', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #555, #999); filter: grayscale(100%);"></div>
                                <span>B&N</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('sepia', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #704214, #c4a35a);"></div>
                                <span>Sepia</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('vintage', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #8b7355, #d4a574);"></div>
                                <span>Vintage</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('cold', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #1e3c72, #2a5298);"></div>
                                <span>Frio</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('warm', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #f12711, #f5af19);"></div>
                                <span>Calido</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('contrast', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #000, #fff);"></div>
                                <span>Contraste</span>
                            </div>
                            <div class="filter-option" onclick="aplicarFiltro('brightness', this)">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);"></div>
                                <span>Brillo</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ajustes manuales -->
                    <div class="option-group">
                        <label class="option-label">Brillo: <span id="brightnessLabel">0</span></label>
                        <input type="range" class="size-slider" id="brightnessSlider" min="-100" max="100" value="0" oninput="ajustarBrillo(this.value)">
                    </div>
                    <div class="option-group">
                        <label class="option-label">Contraste: <span id="contrastLabel">0</span></label>
                        <input type="range" class="size-slider" id="contrastSlider" min="-100" max="100" value="0" oninput="ajustarContraste(this.value)">
                    </div>
                    <div class="option-group">
                        <label class="option-label">Saturacion: <span id="saturationLabel">0</span></label>
                        <input type="range" class="size-slider" id="saturationSlider" min="-100" max="100" value="0" oninput="ajustarSaturacion(this.value)">
                    </div>

                    <!-- Resetear -->
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="resetearAjustes()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                            <path d="M3 3v5h5"/>
                        </svg>
                        Resetear ajustes
                    </button>
                </div>

                <!-- RECORTAR / CROP -->
                <div class="option-section" id="cropOptions">
                    <div class="option-group">
                        <label class="option-label">Proporcion</label>
                        <div class="adjust-buttons" style="flex-wrap: wrap;">
                            <button class="adjust-btn active" data-aspect="free" onclick="seleccionarAspectRatio('free', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                </svg>
                                Libre
                            </button>
                            <button class="adjust-btn" data-aspect="9:16" onclick="seleccionarAspectRatio('9:16', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <rect x="6" y="2" width="12" height="20" rx="2"/>
                                </svg>
                                9:16
                            </button>
                            <button class="adjust-btn" data-aspect="1:1" onclick="seleccionarAspectRatio('1:1', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                                </svg>
                                1:1
                            </button>
                            <button class="adjust-btn" data-aspect="4:5" onclick="seleccionarAspectRatio('4:5', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <rect x="5" y="3" width="14" height="18" rx="2"/>
                                </svg>
                                4:5
                            </button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Zoom</label>
                        <input type="range" class="size-slider" id="cropZoomSlider" min="100" max="200" value="100" oninput="ajustarZoomCrop(this.value)">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="abrirRecortador()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M6 2v14a2 2 0 0 0 2 2h14"/>
                            <path d="M18 22V8a2 2 0 0 0-2-2H2"/>
                        </svg>
                        Abrir recortador
                    </button>
                    <p style="font-size: 11px; color: var(--muted); margin-top: 8px; text-align: center;">
                        Tambien puedes hacer zoom con pinch o scroll sobre la imagen
                    </p>
                </div>

                <!-- FONDOS / BACKGROUNDS -->
                <div class="option-section" id="backgroundOptions">
                    <div class="option-group">
                        <label class="option-label">Colores solidos</label>
                        <div class="bg-colors-grid">
                            <div class="bg-color-option" style="background: #000000;" onclick="aplicarFondoColor('#000000', this)"></div>
                            <div class="bg-color-option" style="background: #ffffff;" onclick="aplicarFondoColor('#ffffff', this)"></div>
                            <div class="bg-color-option" style="background: #1a1a2e;" onclick="aplicarFondoColor('#1a1a2e', this)"></div>
                            <div class="bg-color-option" style="background: #16213e;" onclick="aplicarFondoColor('#16213e', this)"></div>
                            <div class="bg-color-option" style="background: #0f3460;" onclick="aplicarFondoColor('#0f3460', this)"></div>
                            <div class="bg-color-option" style="background: #e94560;" onclick="aplicarFondoColor('#e94560', this)"></div>
                            <div class="bg-color-option" style="background: #ff6b6b;" onclick="aplicarFondoColor('#ff6b6b', this)"></div>
                            <div class="bg-color-option" style="background: #feca57;" onclick="aplicarFondoColor('#feca57', this)"></div>
                            <div class="bg-color-option" style="background: #48dbfb;" onclick="aplicarFondoColor('#48dbfb', this)"></div>
                            <div class="bg-color-option" style="background: #1dd1a1;" onclick="aplicarFondoColor('#1dd1a1', this)"></div>
                            <div class="bg-color-option" style="background: #5f27cd;" onclick="aplicarFondoColor('#5f27cd', this)"></div>
                            <div class="bg-color-option" style="background: #ff9ff3;" onclick="aplicarFondoColor('#ff9ff3', this)"></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Gradientes</label>
                        <div class="backgrounds-grid" id="gradientsGrid">
                            <div class="bg-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #667eea 0%, #764ba2 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #fa709a 0%, #fee140 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #ff0844 0%, #ffb199 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #30cfd0 0%, #330867 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);" onclick="aplicarFondoGradiente('linear-gradient(180deg, #2c3e50 0%, #3498db 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(180deg, #232526 0%, #414345 100%);" onclick="aplicarFondoGradiente('linear-gradient(180deg, #232526 0%, #414345 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #ee0979 0%, #ff6a00 100%)', this)"></div>
                            <div class="bg-option" style="background: linear-gradient(135deg, #7f00ff 0%, #e100ff 100%);" onclick="aplicarFondoGradiente('linear-gradient(135deg, #7f00ff 0%, #e100ff 100%)', this)"></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Efecto blur del fondo</label>
                        <input type="range" class="size-slider" id="bgBlurSlider" min="0" max="20" value="0" oninput="aplicarBlurFondo(this.value)">
                    </div>
                </div>

                <!-- PLANTILLAS / TEMPLATES -->
                <div class="option-section" id="templateOptions">
                    <div class="templates-tabs" id="templatesTabs">
                        <button class="template-tab active" data-category="all" onclick="filtrarPlantillas('all', this)">Todas</button>
                        <button class="template-tab" data-category="promo" onclick="filtrarPlantillas('promo', this)">Promo</button>
                        <button class="template-tab" data-category="quote" onclick="filtrarPlantillas('quote', this)">Frases</button>
                        <button class="template-tab" data-category="social" onclick="filtrarPlantillas('social', this)">Social</button>
                        <button class="template-tab" data-category="neon" onclick="filtrarPlantillas('neon', this)">Neon</button>
                        <button class="template-tab" data-category="minimal" onclick="filtrarPlantillas('minimal', this)">Minimal</button>
                        <button class="template-tab" data-category="birthday" onclick="filtrarPlantillas('birthday', this)">Cumple</button>
                        <button class="template-tab" data-category="sale" onclick="filtrarPlantillas('sale', this)">Ventas</button>
                    </div>
                    <div class="templates-grid" id="templatesGrid">
                        <!-- Se llenan dinámicamente -->
                    </div>
                </div>

                <!-- BEAT SYNC - Video musical -->
                <div class="option-section" id="beatsyncOptions">
                    <div class="beatsync-container">
                        <!-- Sección: Subir música -->
                        <div class="beatsync-section">
                            <div class="beatsync-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                                Música
                            </div>
                            <div class="beatsync-music-upload" id="beatsyncMusicUpload" onclick="document.getElementById('beatsyncMusicInput').click()">
                                <svg class="beatsync-music-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                                <div class="beatsync-music-text">Toca para subir una canción</div>
                                <div class="beatsync-music-name" id="beatsyncMusicName" style="display: none;"></div>
                            </div>
                            <input type="file" id="beatsyncMusicInput" accept="audio/*" style="display: none;" onchange="handleBeatSyncMusic(event)">

                            <!-- Waveform mejorado -->
                            <div class="beatsync-waveform-container" id="beatsyncWaveformContainer" style="display: none;">
                                <div class="beatsync-waveform" id="beatsyncWaveform" onclick="seekBeatSyncWaveform(event)">
                                    <canvas id="beatsyncWaveformCanvas"></canvas>
                                    <div class="beatsync-waveform-playhead" id="beatsyncPlayhead"></div>
                                </div>
                                <div class="beatsync-time-display">
                                    <span id="beatsyncCurrentTime">0:00</span>
                                    <span id="beatsyncTotalTime">0:00</span>
                                </div>

                                <!-- Info de beats y botón re-analizar -->
                                <div class="beatsync-beats-info">
                                    <div class="beatsync-beats-stat">
                                        <div class="beatsync-beats-dot" id="beatsyncBeatDot"></div>
                                        <span class="beatsync-beats-text">
                                            <span class="beatsync-beats-count" id="beatsyncBeatsCount">0</span> beats detectados
                                        </span>
                                    </div>
                                    <button class="beatsync-reanalyze-btn" onclick="reanalyzeBeatSync()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                            <path d="M3 3v5h5"/>
                                        </svg>
                                        Re-analizar
                                    </button>
                                </div>

                                <!-- Modo de detección -->
                                <div class="beatsync-mode-selector">
                                    <button class="beatsync-mode-btn active" data-mode="auto" onclick="setBeatSyncMode('auto', this)">Auto</button>
                                    <button class="beatsync-mode-btn" data-mode="bass" onclick="setBeatSyncMode('bass', this)">Solo Bajos</button>
                                    <button class="beatsync-mode-btn" data-mode="all" onclick="setBeatSyncMode('all', this)">Todos</button>
                                </div>

                                <!-- Recortador de audio -->
                                <div class="beatsync-trim-section">
                                    <div class="beatsync-trim-header">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <circle cx="6" cy="6" r="2"/>
                                            <circle cx="6" cy="18" r="2"/>
                                            <line x1="6" y1="8" x2="6" y2="16"/>
                                            <path d="M6 6l12 6-12 6"/>
                                        </svg>
                                        <span>Recortar Audio</span>
                                    </div>
                                    <div class="beatsync-trim-controls">
                                        <div class="beatsync-trim-row">
                                            <label>Inicio:</label>
                                            <input type="number" class="beatsync-trim-input" id="beatsyncTrimStart" value="0" min="0" step="0.5" onchange="onTrimChange()">
                                            <span class="beatsync-trim-unit">seg</span>
                                        </div>
                                        <div class="beatsync-trim-row">
                                            <label>Fin:</label>
                                            <input type="number" class="beatsync-trim-input" id="beatsyncTrimEnd" value="30" min="1" step="0.5" onchange="onTrimChange()">
                                            <span class="beatsync-trim-unit">seg</span>
                                        </div>
                                    </div>
                                    <div class="beatsync-trim-duration" id="beatsyncTrimDuration">
                                        Duración: <strong>30.0s</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Subir fotos -->
                        <div class="beatsync-section">
                            <div class="beatsync-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                Fotos (<span id="beatsyncPhotosCountLabel">0</span>)
                            </div>
                            <div class="beatsync-photos-upload" id="beatsyncPhotosUpload" onclick="document.getElementById('beatsyncPhotosInput').click()">
                                <svg class="beatsync-music-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="12" y1="8" x2="12" y2="16"/>
                                    <line x1="8" y1="12" x2="16" y2="12"/>
                                </svg>
                                <div class="beatsync-music-text">Toca para agregar fotos</div>
                            </div>
                            <div class="beatsync-photos-grid" id="beatsyncPhotosGrid" style="display: none;"></div>
                            <div class="beatsync-photos-actions" id="beatsyncPhotosInfo" style="display: none;">
                                <span class="beatsync-photos-hint">Arrastra para reordenar</span>
                                <button class="beatsync-shuffle-btn" onclick="shuffleBeatSyncPhotos()" title="Orden aleatorio">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="16 3 21 3 21 8"/>
                                        <line x1="4" y1="20" x2="21" y2="3"/>
                                        <polyline points="21 16 21 21 16 21"/>
                                        <line x1="15" y1="15" x2="21" y2="21"/>
                                        <line x1="4" y1="4" x2="9" y2="9"/>
                                    </svg>
                                    Mezclar
                                </button>
                            </div>
                            <input type="file" id="beatsyncPhotosInput" accept="image/*" multiple style="display: none;" onchange="handleBeatSyncPhotos(event)">
                        </div>

                        <!-- Sección: Configuración -->
                        <div class="beatsync-section">
                            <div class="beatsync-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                                </svg>
                                Configuración
                            </div>
                            <div class="beatsync-config">
                                <div class="beatsync-config-row">
                                    <span class="beatsync-config-label">Transición</span>
                                    <select class="beatsync-select" id="beatsyncTransition">
                                        <option value="cut">Corte directo</option>
                                        <option value="fade">Fundido</option>
                                        <option value="zoom">Zoom</option>
                                        <option value="flash">Flash</option>
                                        <option value="slide">Deslizar</option>
                                    </select>
                                </div>
                                <div class="beatsync-config-row">
                                    <span class="beatsync-config-label">Sensibilidad</span>
                                    <div class="beatsync-slider-container">
                                        <input type="range" class="beatsync-slider" id="beatsyncSensitivity" min="1" max="10" value="5" oninput="updateSensitivityLabel(this.value)" onchange="onSensitivityChange()">
                                        <span class="beatsync-slider-value" id="beatsyncSensitivityValue">5</span>
                                    </div>
                                </div>
                                <div class="beatsync-config-row">
                                    <span class="beatsync-config-label">Intervalo mín.</span>
                                    <div class="beatsync-slider-container">
                                        <input type="range" class="beatsync-slider" id="beatsyncMinInterval" min="0.2" max="2" step="0.1" value="0.3" oninput="updateMinIntervalLabel(this.value)" onchange="onSensitivityChange()">
                                        <span class="beatsync-slider-value" id="beatsyncMinIntervalValue">0.3s</span>
                                    </div>
                                </div>
                                <div class="beatsync-config-row">
                                    <span class="beatsync-config-label">Duración</span>
                                    <select class="beatsync-select" id="beatsyncDuration">
                                        <option value="15">15 segundos</option>
                                        <option value="30" selected>30 segundos</option>
                                        <option value="60">60 segundos</option>
                                        <option value="auto">Toda la canción</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Preview mejorado -->
                        <div class="beatsync-preview-container" id="beatsyncPreviewSection" style="display: none;">
                            <div class="beatsync-preview" id="beatsyncPreviewWrapper">
                                <canvas id="beatsyncPreviewCanvas" class="beatsync-preview-canvas"></canvas>
                                <div class="beatsync-beat-flash" id="beatsyncBeatFlash"></div>
                                <div class="beatsync-photo-indicator" id="beatsyncPhotoIndicator">1 / 1</div>
                                <div class="beatsync-preview-overlay" id="beatsyncPreviewOverlay">
                                    <button class="beatsync-preview-play" onclick="toggleBeatSyncPreview()">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="beatsync-preview-controls">
                                <button class="beatsync-control-btn" id="beatsyncStopBtn" onclick="stopBeatSyncPreview()" title="Detener">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="6" y="6" width="12" height="12"/>
                                    </svg>
                                </button>
                                <button class="beatsync-control-btn main" id="beatsyncPlayPauseBtn" onclick="toggleBeatSyncPreview()" title="Play/Pause">
                                    <svg id="beatsyncPlayIcon" viewBox="0 0 24 24" fill="currentColor">
                                        <polygon points="5 3 19 12 5 21 5 3"/>
                                    </svg>
                                </button>
                                <div class="beatsync-timeline" id="beatsyncTimeline" onclick="seekBeatSyncTimeline(event)">
                                    <div class="beatsync-timeline-progress" id="beatsyncTimelineProgress"></div>
                                </div>
                                <span class="beatsync-timeline-time" id="beatsyncTimeDisplay">0:00 / 0:00</span>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="beatsync-progress" id="beatsyncProgress">
                            <div class="beatsync-progress-bar">
                                <div class="beatsync-progress-fill" id="beatsyncProgressFill" style="width: 0%;"></div>
                            </div>
                            <div class="beatsync-progress-text" id="beatsyncProgressText">Analizando audio...</div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="beatsync-actions">
                            <button class="beatsync-btn beatsync-btn-secondary" id="beatsyncPreviewBtn" onclick="previewBeatSync()" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                Preview
                            </button>
                            <button class="beatsync-btn beatsync-btn-primary" id="beatsyncGenerateBtn" onclick="generateBeatSync()" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2 12h2l2-6 3 12 3-8 2 4h8"/>
                                    <circle cx="20" cy="12" r="2"/>
                                </svg>
                                Generar Video
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PUBLICAR -->
                <div class="option-section" id="publishOptions">
                    <div class="option-group">
                        <label class="option-label">Visibilidad</label>
                        <div class="lado-selector">
                            <div class="lado-option selected" data-lado="LadoA" onclick="seleccionarLado('LadoA', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="margin-bottom: 4px;">
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                                <div style="font-weight: 600;">Lado A</div>
                                <div style="font-size: 11px; color: var(--muted);">Visible para todos</div>
                            </div>
                            <div class="lado-option" data-lado="LadoB" onclick="seleccionarLado('LadoB', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="margin-bottom: 4px;">
                                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zM2 12h20"/>
                                </svg>
                                <div style="font-weight: 600;">Lado B</div>
                                <div style="font-size: 11px; color: var(--muted);">Solo suscriptores</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="options-footer">
                <button class="btn btn-secondary" onclick="cancelarEditor()">Cancelar</button>
                <button class="btn btn-primary" id="publishBtn" onclick="publicarStory()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    @textoPublicar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p id="loadingText">Publicando @(modo == "reel" ? "reel" : "historia")...</p>
    </div>

    <!-- Crop overlay -->
    <div class="crop-overlay" id="cropOverlay">
        <div class="crop-header">
            <h4>Recortar</h4>
            <div class="crop-actions">
                <button class="crop-btn crop-btn-cancel" onclick="cancelarCrop()">Cancelar</button>
                <button class="crop-btn crop-btn-apply" onclick="aplicarCrop()">Aplicar</button>
            </div>
        </div>
        <div class="crop-container" id="cropContainer">
            <canvas id="cropCanvas"></canvas>
            <div class="crop-box" id="cropBox">
                <div class="crop-handle crop-handle-tl" data-handle="tl"></div>
                <div class="crop-handle crop-handle-tr" data-handle="tr"></div>
                <div class="crop-handle crop-handle-bl" data-handle="bl"></div>
                <div class="crop-handle crop-handle-br" data-handle="br"></div>
            </div>
        </div>
        <div class="crop-footer">
            <button class="aspect-btn active" onclick="setCropAspect('free', this)">Libre</button>
            <button class="aspect-btn" onclick="setCropAspect('9:16', this)">9:16</button>
            <button class="aspect-btn" onclick="setCropAspect('1:1', this)">1:1</button>
            <button class="aspect-btn" onclick="setCropAspect('4:5', this)">4:5</button>
            <button class="aspect-btn" onclick="setCropAspect('16:9', this)">16:9</button>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        const MODO_EDITOR = '@modo';
        const URL_CREAR = MODO_EDITOR === 'reel' ? '/Stories/CrearReel' : '/Stories/Crear';
        const URL_REDIRECT = MODO_EDITOR === 'reel' ? '/Feed' : '/Feed';

        let canvas;
        let currentTool = 'text';
        let selectedLado = 'LadoA';
        let selectedMusic = null;
        let musicDuration = 0;
        let musicTrimStart = 0;
        let musicVolume = 70;
        let previewAudio = null;
        let listPreviewAudio = null;
        let mediaFile = null;
        let mediaUrl = null;
        let canvasHistory = [];
        let historyIndex = -1;

        // Configuración de texto
        let textConfig = {
            font: 'Poppins',
            size: 32,
            color: '#ffffff',
            backgroundColor: 'transparent'
        };

        // Configuración de dibujo
        let drawConfig = {
            color: '#ff3b5c',
            width: 3
        };

        // Configuración de link
        let linkConfig = {
            url: '',
            text: 'Ver mas',
            style: 'pill',
            color: '#4682B4',
            font: 'Poppins'
        };
        let storyLinkObject = null; // El objeto fabric del link en canvas

        // Configuración de crop
        let cropConfig = {
            aspectRatio: 'free',
            zoom: 100
        };
        let originalMediaUrl = null;

        // Configuración de fondo
        let backgroundConfig = {
            type: 'none', // none, color, gradient
            value: null,
            blur: 0
        };

        // Plantillas estilo Canva - 70+ plantillas
        const templates = [
            // ============ PROMO (10) ============
            { id: 1, category: 'promo', name: 'Oferta Flash', bg: 'linear-gradient(135deg, #ff0844 0%, #ffb199 100%)', texts: [{ text: 'OFERTA', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 30 }, { text: '50% OFF', font: 'Anton', size: 64, color: '#ffdd00', y: 50 }, { text: 'Solo por hoy', font: 'Poppins', size: 20, color: '#ffffff', y: 70 }] },
            { id: 2, category: 'promo', name: 'Nuevo Producto', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', texts: [{ text: 'NUEVO', font: 'Oswald', size: 36, color: '#ffffff', y: 25 }, { text: 'Descubre', font: 'Playfair Display', size: 42, color: '#ffffff', y: 50 }, { text: 'Disponible ahora', font: 'Poppins', size: 18, color: 'rgba(255,255,255,0.8)', y: 75 }] },
            { id: 3, category: 'promo', name: 'Descuento', bg: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)', texts: [{ text: '-30%', font: 'Anton', size: 72, color: '#e94560', y: 45 }, { text: 'EN TODO', font: 'Montserrat', size: 28, color: '#ffffff', y: 65 }] },
            { id: 4, category: 'promo', name: 'Coming Soon', bg: 'linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%)', texts: [{ text: 'COMING', font: 'Bebas Neue', size: 42, color: '#ffffff', y: 38 }, { text: 'SOON', font: 'Bebas Neue', size: 56, color: '#e94560', y: 55 }] },
            { id: 5, category: 'promo', name: 'Lanzamiento', bg: 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)', texts: [{ text: '🚀', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'NUEVO', font: 'Anton', size: 44, color: '#ffffff', y: 45 }, { text: 'LANZAMIENTO', font: 'Anton', size: 36, color: '#ffffff', y: 62 }] },
            { id: 6, category: 'promo', name: 'Exclusivo', bg: 'linear-gradient(135deg, #c9b037 0%, #dcce82 50%, #c9b037 100%)', texts: [{ text: '✦ EXCLUSIVO ✦', font: 'Playfair Display', size: 32, color: '#1a1a1a', y: 45 }, { text: 'Solo para ti', font: 'Poppins', size: 20, color: '#333', y: 60 }] },
            { id: 7, category: 'promo', name: 'Gratis', bg: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)', texts: [{ text: 'GRATIS', font: 'Anton', size: 64, color: '#ffffff', y: 40 }, { text: 'Por tiempo limitado', font: 'Poppins', size: 18, color: '#ffffff', y: 60 }] },
            { id: 8, category: 'promo', name: 'Hot Deal', bg: 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)', texts: [{ text: '🔥', font: 'Poppins', size: 56, color: '#ffffff', y: 25 }, { text: 'HOT DEAL', font: 'Bebas Neue', size: 52, color: '#ffffff', y: 50 }] },
            { id: 9, category: 'promo', name: 'Limited Edition', bg: '#1a1a1a', texts: [{ text: 'LIMITED', font: 'Oswald', size: 36, color: '#c9b037', y: 38 }, { text: 'EDITION', font: 'Oswald', size: 48, color: '#ffffff', y: 55 }] },
            { id: 10, category: 'promo', name: '2x1', bg: 'linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%)', texts: [{ text: '2x1', font: 'Anton', size: 80, color: '#ffffff', y: 42 }, { text: 'HOY', font: 'Montserrat', size: 28, color: '#ffffff', y: 65 }] },

            // ============ QUOTE / FRASES (12) ============
            { id: 11, category: 'quote', name: 'Cita Inspiradora', bg: 'linear-gradient(135deg, #232526 0%, #414345 100%)', texts: [{ text: '"', font: 'Playfair Display', size: 80, color: 'rgba(255,255,255,0.3)', y: 20 }, { text: 'La vida es bella', font: 'Playfair Display', size: 32, color: '#ffffff', y: 45 }, { text: '- Autor', font: 'Poppins', size: 16, color: 'rgba(255,255,255,0.6)', y: 70 }] },
            { id: 12, category: 'quote', name: 'Motivacional', bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', texts: [{ text: 'NUNCA', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 35 }, { text: 'te rindas', font: 'Dancing Script', size: 44, color: '#ffffff', y: 55 }] },
            { id: 13, category: 'quote', name: 'Good Vibes', bg: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', texts: [{ text: 'good', font: 'Pacifico', size: 42, color: '#5d4e37', y: 40 }, { text: 'vibes only', font: 'Pacifico', size: 36, color: '#5d4e37', y: 58 }] },
            { id: 14, category: 'quote', name: 'Dream Big', bg: 'linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%)', texts: [{ text: 'DREAM', font: 'Bebas Neue', size: 52, color: '#ffffff', y: 38 }, { text: 'BIG', font: 'Bebas Neue', size: 64, color: '#f39c12', y: 58 }] },
            { id: 15, category: 'quote', name: 'Positive', bg: 'linear-gradient(135deg, #74ebd5 0%, #acb6e5 100%)', texts: [{ text: '☀️', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'Piensa', font: 'Dancing Script', size: 36, color: '#2d3436', y: 45 }, { text: 'POSITIVO', font: 'Montserrat', size: 32, color: '#2d3436', y: 62 }] },
            { id: 16, category: 'quote', name: 'Be Yourself', bg: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)', texts: [{ text: 'Be', font: 'Pacifico', size: 36, color: '#c0392b', y: 35 }, { text: 'YOURSELF', font: 'Montserrat', size: 40, color: '#2d3436', y: 52 }] },
            { id: 17, category: 'quote', name: 'Love Yourself', bg: 'linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%)', texts: [{ text: '💕', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'Love', font: 'Dancing Script', size: 44, color: '#c0392b', y: 45 }, { text: 'YOURSELF', font: 'Montserrat', size: 28, color: '#2d3436', y: 62 }] },
            { id: 18, category: 'quote', name: 'Hustle', bg: '#0a0a0a', texts: [{ text: 'HUSTLE', font: 'Anton', size: 52, color: '#ffffff', y: 38 }, { text: 'harder', font: 'Dancing Script', size: 44, color: '#f39c12', y: 58 }] },
            { id: 19, category: 'quote', name: 'Stay Strong', bg: 'linear-gradient(135deg, #434343 0%, #000000 100%)', texts: [{ text: 'STAY', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 35 }, { text: 'STRONG', font: 'Bebas Neue', size: 56, color: '#e74c3c', y: 55 }] },
            { id: 20, category: 'quote', name: 'Make It Happen', bg: 'linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #ffaf7b 100%)', texts: [{ text: 'MAKE IT', font: 'Oswald', size: 36, color: '#ffffff', y: 38 }, { text: 'HAPPEN', font: 'Anton', size: 52, color: '#ffffff', y: 55 }] },
            { id: 21, category: 'quote', name: 'Blessed', bg: 'linear-gradient(135deg, #c9d6ff 0%, #e2e2e2 100%)', texts: [{ text: '🙏', font: 'Poppins', size: 48, color: '#ffffff', y: 30 }, { text: 'BLESSED', font: 'Playfair Display', size: 44, color: '#2d3436', y: 55 }] },
            { id: 22, category: 'quote', name: 'Keep Going', bg: 'linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)', texts: [{ text: 'KEEP', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 35 }, { text: 'GOING', font: 'Bebas Neue', size: 56, color: '#ffffff', y: 55 }] },

            // ============ SOCIAL (10) ============
            { id: 23, category: 'social', name: 'Pregunta', bg: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', texts: [{ text: '¿Que opinas?', font: 'Montserrat', size: 36, color: '#ffffff', y: 45 }, { text: 'Responde en DM', font: 'Poppins', size: 18, color: 'rgba(255,255,255,0.8)', y: 65 }] },
            { id: 24, category: 'social', name: 'Encuesta', bg: 'linear-gradient(180deg, #ee0979 0%, #ff6a00 100%)', texts: [{ text: 'ESTO O', font: 'Anton', size: 42, color: '#ffffff', y: 35 }, { text: 'AQUELLO', font: 'Anton', size: 42, color: '#ffffff', y: 55 }] },
            { id: 25, category: 'social', name: 'AMA', bg: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)', texts: [{ text: 'ASK ME', font: 'Bebas Neue', size: 56, color: '#ffffff', y: 40 }, { text: 'ANYTHING', font: 'Bebas Neue', size: 56, color: '#30cfd0', y: 55 }] },
            { id: 26, category: 'social', name: 'Link Bio', bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', texts: [{ text: 'LINK EN', font: 'Montserrat', size: 28, color: '#ffffff', y: 40 }, { text: 'BIO', font: 'Anton', size: 64, color: '#ffffff', y: 58 }] },
            { id: 27, category: 'social', name: 'New Post', bg: 'linear-gradient(135deg, #f857a6 0%, #ff5858 100%)', texts: [{ text: '📸', font: 'Poppins', size: 48, color: '#ffffff', y: 28 }, { text: 'NEW POST', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 52 }] },
            { id: 28, category: 'social', name: 'DM Me', bg: 'linear-gradient(135deg, #0052d4 0%, #65c7f7 50%, #9cecfb 100%)', texts: [{ text: '💬', font: 'Poppins', size: 48, color: '#ffffff', y: 28 }, { text: 'DM ME', font: 'Anton', size: 52, color: '#ffffff', y: 52 }] },
            { id: 29, category: 'social', name: 'Tag Me', bg: 'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)', texts: [{ text: '@@', font: 'Anton', size: 64, color: '#ffffff', y: 35 }, { text: 'TAG ME', font: 'Montserrat', size: 32, color: '#ffffff', y: 58 }] },
            { id: 30, category: 'social', name: 'Follow', bg: 'linear-gradient(135deg, #e1eec3 0%, #f05053 100%)', texts: [{ text: '👆', font: 'Poppins', size: 48, color: '#ffffff', y: 28 }, { text: 'FOLLOW', font: 'Anton', size: 48, color: '#ffffff', y: 52 }] },
            { id: 31, category: 'social', name: 'Rate This', bg: 'linear-gradient(135deg, #ff9966 0%, #ff5e62 100%)', texts: [{ text: '⭐⭐⭐⭐⭐', font: 'Poppins', size: 24, color: '#ffffff', y: 35 }, { text: 'RATE THIS', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 55 }] },
            { id: 32, category: 'social', name: 'Giveaway', bg: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', texts: [{ text: '🎁', font: 'Poppins', size: 56, color: '#ffffff', y: 25 }, { text: 'GIVEAWAY', font: 'Anton', size: 44, color: '#ffffff', y: 52 }, { text: 'Participa ahora', font: 'Poppins', size: 16, color: '#ffffff', y: 70 }] },

            // ============ NEON (8) ============
            { id: 33, category: 'neon', name: 'Neon Pink', bg: '#0a0a0a', texts: [{ text: 'VIBES', font: 'Bebas Neue', size: 56, color: '#ff00ff', y: 45, shadow: '0 0 20px #ff00ff, 0 0 40px #ff00ff' }] },
            { id: 34, category: 'neon', name: 'Neon Blue', bg: '#0a0a0a', texts: [{ text: 'GLOW', font: 'Anton', size: 64, color: '#00ffff', y: 45, shadow: '0 0 20px #00ffff, 0 0 40px #00ffff' }] },
            { id: 35, category: 'neon', name: 'Neon Multi', bg: 'linear-gradient(180deg, #0a0a0a 0%, #1a0a2e 100%)', texts: [{ text: 'NEON', font: 'Bebas Neue', size: 48, color: '#ff00ff', y: 35, shadow: '0 0 15px #ff00ff' }, { text: 'NIGHTS', font: 'Bebas Neue', size: 48, color: '#00ffff', y: 55, shadow: '0 0 15px #00ffff' }] },
            { id: 36, category: 'neon', name: 'Neon Green', bg: '#0a0a0a', texts: [{ text: 'FRESH', font: 'Anton', size: 56, color: '#39ff14', y: 45, shadow: '0 0 20px #39ff14, 0 0 40px #39ff14' }] },
            { id: 37, category: 'neon', name: 'Neon Orange', bg: '#0a0a0a', texts: [{ text: 'FIRE', font: 'Bebas Neue', size: 64, color: '#ff6600', y: 45, shadow: '0 0 20px #ff6600, 0 0 40px #ff6600' }] },
            { id: 38, category: 'neon', name: 'Electric', bg: 'linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%)', texts: [{ text: '⚡', font: 'Poppins', size: 48, color: '#ffff00', y: 28, shadow: '0 0 20px #ffff00' }, { text: 'ELECTRIC', font: 'Anton', size: 44, color: '#ffff00', y: 55, shadow: '0 0 15px #ffff00' }] },
            { id: 39, category: 'neon', name: 'Retro Wave', bg: 'linear-gradient(180deg, #0a0a0a 0%, #1a0a2e 100%)', texts: [{ text: 'RETRO', font: 'Bebas Neue', size: 44, color: '#ff00ff', y: 35, shadow: '0 0 15px #ff00ff' }, { text: 'WAVE', font: 'Bebas Neue', size: 44, color: '#00ffff', y: 52, shadow: '0 0 15px #00ffff' }, { text: '1985', font: 'Oswald', size: 24, color: '#ffff00', y: 68, shadow: '0 0 10px #ffff00' }] },
            { id: 40, category: 'neon', name: 'Cyber', bg: '#0a0a0a', texts: [{ text: 'CYBER', font: 'Anton', size: 52, color: '#ff00ff', y: 38, shadow: '0 0 20px #ff00ff' }, { text: 'PUNK', font: 'Anton', size: 52, color: '#00ffff', y: 58, shadow: '0 0 20px #00ffff' }] },

            // ============ MINIMAL (8) ============
            { id: 41, category: 'minimal', name: 'Clean White', bg: '#ffffff', texts: [{ text: 'SIMPLE', font: 'Montserrat', size: 32, color: '#000000', y: 45 }, { text: 'is better', font: 'Poppins', size: 20, color: '#666666', y: 58 }] },
            { id: 42, category: 'minimal', name: 'Dark Minimal', bg: '#1a1a1a', texts: [{ text: 'MENOS', font: 'Oswald', size: 36, color: '#ffffff', y: 42 }, { text: 'es mas', font: 'Poppins', size: 22, color: '#888888', y: 56 }] },
            { id: 43, category: 'minimal', name: 'Lineas', bg: '#f5f5f5', texts: [{ text: '___', font: 'Poppins', size: 24, color: '#333', y: 35 }, { text: 'Tu texto', font: 'Poppins', size: 20, color: '#333', y: 50 }, { text: '___', font: 'Poppins', size: 24, color: '#333', y: 65 }] },
            { id: 44, category: 'minimal', name: 'Beige', bg: '#f5f0e8', texts: [{ text: 'ELEGANT', font: 'Playfair Display', size: 36, color: '#5d4e37', y: 45 }, { text: '& simple', font: 'Poppins', size: 18, color: '#8b7355', y: 60 }] },
            { id: 45, category: 'minimal', name: 'B&W', bg: '#ffffff', texts: [{ text: '●', font: 'Poppins', size: 32, color: '#000000', y: 35 }, { text: 'BLACK', font: 'Montserrat', size: 28, color: '#000000', y: 50 }, { text: '& WHITE', font: 'Poppins', size: 20, color: '#666', y: 62 }] },
            { id: 46, category: 'minimal', name: 'Grid', bg: '#f8f8f8', texts: [{ text: '+', font: 'Montserrat', size: 48, color: '#e0e0e0', y: 30 }, { text: 'MINIMAL', font: 'Oswald', size: 32, color: '#333', y: 50 }] },
            { id: 47, category: 'minimal', name: 'Soft Gray', bg: '#e8e8e8', texts: [{ text: 'Breathe', font: 'Dancing Script', size: 44, color: '#555', y: 45 }] },
            { id: 48, category: 'minimal', name: 'Pure', bg: '#ffffff', texts: [{ text: '○', font: 'Poppins', size: 64, color: '#ddd', y: 35 }, { text: 'PURE', font: 'Montserrat', size: 36, color: '#333', y: 60 }] },

            // ============ BIRTHDAY (10) ============
            { id: 49, category: 'birthday', name: 'Feliz Cumple', bg: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', texts: [{ text: '🎂', font: 'Poppins', size: 64, color: '#ffffff', y: 25 }, { text: 'FELIZ', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 50 }, { text: 'CUMPLEAÑOS', font: 'Bebas Neue', size: 36, color: '#ffffff', y: 65 }] },
            { id: 50, category: 'birthday', name: 'Party Time', bg: 'linear-gradient(135deg, #7f00ff 0%, #e100ff 100%)', texts: [{ text: '🎉', font: 'Poppins', size: 48, color: '#ffffff', y: 20 }, { text: 'PARTY', font: 'Anton', size: 56, color: '#ffffff', y: 45 }, { text: 'TIME', font: 'Anton', size: 56, color: '#ffdd00', y: 62 }] },
            { id: 51, category: 'birthday', name: 'Celebremos', bg: 'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)', texts: [{ text: '✨', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'Celebremos', font: 'Dancing Script', size: 44, color: '#ffffff', y: 48 }, { text: 'JUNTOS', font: 'Montserrat', size: 28, color: '#ffffff', y: 68 }] },
            { id: 52, category: 'birthday', name: 'Happy Bday', bg: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)', texts: [{ text: '🎈', font: 'Poppins', size: 48, color: '#ffffff', y: 22 }, { text: 'HAPPY', font: 'Anton', size: 44, color: '#ffffff', y: 45 }, { text: 'BIRTHDAY', font: 'Anton', size: 36, color: '#ffffff', y: 62 }] },
            { id: 53, category: 'birthday', name: 'Wishes', bg: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', texts: [{ text: '🎁', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'Best', font: 'Dancing Script', size: 36, color: '#5d4e37', y: 45 }, { text: 'WISHES', font: 'Montserrat', size: 32, color: '#5d4e37', y: 62 }] },
            { id: 54, category: 'birthday', name: 'Surprise', bg: 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)', texts: [{ text: '🎊', font: 'Poppins', size: 56, color: '#ffffff', y: 25 }, { text: 'SURPRISE', font: 'Bebas Neue', size: 48, color: '#c0392b', y: 52 }] },
            { id: 55, category: 'birthday', name: 'Its My Bday', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', texts: [{ text: '👑', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'ITS MY', font: 'Montserrat', size: 28, color: '#ffffff', y: 45 }, { text: 'BIRTHDAY', font: 'Anton', size: 44, color: '#ffdd00', y: 62 }] },
            { id: 56, category: 'birthday', name: 'Cheers', bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', texts: [{ text: '🥳', font: 'Poppins', size: 56, color: '#ffffff', y: 28 }, { text: 'CHEERS', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 55 }] },
            { id: 57, category: 'birthday', name: 'Make a Wish', bg: 'linear-gradient(135deg, #0c3483 0%, #a2b6df 100%)', texts: [{ text: '🌟', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'Make a', font: 'Dancing Script', size: 32, color: '#ffffff', y: 45 }, { text: 'WISH', font: 'Anton', size: 52, color: '#ffffff', y: 62 }] },
            { id: 58, category: 'birthday', name: 'Age Up', bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', texts: [{ text: '🎂', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'LEVEL UP', font: 'Anton', size: 44, color: '#ffffff', y: 50 }, { text: '+1 Year', font: 'Poppins', size: 20, color: '#ffffff', y: 68 }] },

            // ============ SALE (10) ============
            { id: 59, category: 'sale', name: 'Black Friday', bg: '#000000', texts: [{ text: 'BLACK', font: 'Anton', size: 48, color: '#ffffff', y: 35 }, { text: 'FRIDAY', font: 'Anton', size: 48, color: '#ff0000', y: 52 }, { text: 'Hasta 70% OFF', font: 'Poppins', size: 18, color: '#ffffff', y: 72 }] },
            { id: 60, category: 'sale', name: 'Flash Sale', bg: 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)', texts: [{ text: '⚡', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'FLASH SALE', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 50 }, { text: '24 HORAS', font: 'Montserrat', size: 22, color: '#ffffff', y: 68 }] },
            { id: 61, category: 'sale', name: 'Liquidacion', bg: 'linear-gradient(180deg, #2c3e50 0%, #3498db 100%)', texts: [{ text: 'LIQUIDACION', font: 'Oswald', size: 36, color: '#ffffff', y: 35 }, { text: 'TOTAL', font: 'Oswald', size: 48, color: '#ffdd00', y: 52 }, { text: 'Ultimas unidades', font: 'Poppins', size: 16, color: 'rgba(255,255,255,0.8)', y: 72 }] },
            { id: 62, category: 'sale', name: 'Cyber Monday', bg: 'linear-gradient(135deg, #0052d4 0%, #4364f7 50%, #6fb1fc 100%)', texts: [{ text: 'CYBER', font: 'Anton', size: 44, color: '#ffffff', y: 35 }, { text: 'MONDAY', font: 'Anton', size: 44, color: '#00ff88', y: 52 }] },
            { id: 63, category: 'sale', name: 'Super Oferta', bg: 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)', texts: [{ text: '🔥', font: 'Poppins', size: 48, color: '#ffffff', y: 22 }, { text: 'SUPER', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 42 }, { text: 'OFERTA', font: 'Bebas Neue', size: 52, color: '#ffdd00', y: 60 }] },
            { id: 64, category: 'sale', name: 'Mega Sale', bg: 'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)', texts: [{ text: 'MEGA', font: 'Anton', size: 52, color: '#ffffff', y: 38 }, { text: 'SALE', font: 'Anton', size: 64, color: '#ffdd00', y: 58 }] },
            { id: 65, category: 'sale', name: 'Last Chance', bg: 'linear-gradient(135deg, #200122 0%, #6f0000 100%)', texts: [{ text: '⏰', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'LAST', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 45 }, { text: 'CHANCE', font: 'Bebas Neue', size: 48, color: '#ff0000', y: 62 }] },
            { id: 66, category: 'sale', name: 'Hot Price', bg: 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)', texts: [{ text: 'HOT', font: 'Anton', size: 56, color: '#ffffff', y: 35 }, { text: 'PRICE', font: 'Anton', size: 56, color: '#ffdd00', y: 55 }] },
            { id: 67, category: 'sale', name: 'Rebajas', bg: 'linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%)', texts: [{ text: 'REBAJAS', font: 'Bebas Neue', size: 52, color: '#ffffff', y: 40 }, { text: 'Hasta -60%', font: 'Montserrat', size: 24, color: '#ffffff', y: 60 }] },
            { id: 68, category: 'sale', name: 'Outlet', bg: '#1a1a1a', texts: [{ text: 'OUTLET', font: 'Anton', size: 52, color: '#ffffff', y: 40 }, { text: '-70% OFF', font: 'Montserrat', size: 28, color: '#ff0000', y: 60 }] },

            // ============ EXTRAS / BONUS (12) ============
            { id: 69, category: 'promo', name: 'Save Date', bg: 'linear-gradient(135deg, #c9b037 0%, #dcce82 50%, #c9b037 100%)', texts: [{ text: 'SAVE', font: 'Playfair Display', size: 36, color: '#1a1a1a', y: 35 }, { text: 'THE DATE', font: 'Playfair Display', size: 32, color: '#1a1a1a', y: 52 }] },
            { id: 70, category: 'social', name: 'POV', bg: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)', texts: [{ text: 'POV:', font: 'Montserrat', size: 28, color: '#ffffff', y: 40 }, { text: 'Tu texto', font: 'Poppins', size: 22, color: 'rgba(255,255,255,0.8)', y: 55 }] },
            { id: 71, category: 'quote', name: 'Mood', bg: 'linear-gradient(135deg, #654ea3 0%, #eaafc8 100%)', texts: [{ text: 'mood:', font: 'Montserrat', size: 24, color: '#ffffff', y: 40 }, { text: '💭', font: 'Poppins', size: 48, color: '#ffffff', y: 58 }] },
            { id: 72, category: 'social', name: 'Swipe Up', bg: 'linear-gradient(135deg, #00b09b 0%, #96c93d 100%)', texts: [{ text: '👆', font: 'Poppins', size: 48, color: '#ffffff', y: 30 }, { text: 'SWIPE UP', font: 'Bebas Neue', size: 44, color: '#ffffff', y: 55 }] },
            { id: 73, category: 'neon', name: 'Vaporwave', bg: 'linear-gradient(180deg, #0a0a0a 0%, #240046 50%, #3c096c 100%)', texts: [{ text: 'VAPOR', font: 'Bebas Neue', size: 44, color: '#ff00ff', y: 35, shadow: '0 0 15px #ff00ff' }, { text: 'WAVE', font: 'Bebas Neue', size: 44, color: '#00ffff', y: 52, shadow: '0 0 15px #00ffff' }, { text: '美学', font: 'Poppins', size: 24, color: '#ff00ff', y: 68 }] },
            { id: 74, category: 'minimal', name: 'Aesthetic', bg: '#f5f0e8', texts: [{ text: 'a e s t h e t i c', font: 'Montserrat', size: 20, color: '#8b7355', y: 45 }] },
            { id: 75, category: 'quote', name: 'Weekend', bg: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)', texts: [{ text: '🌴', font: 'Poppins', size: 48, color: '#ffffff', y: 25 }, { text: 'WEEKEND', font: 'Bebas Neue', size: 44, color: '#c0392b', y: 48 }, { text: 'vibes', font: 'Dancing Script', size: 32, color: '#5d4e37', y: 65 }] },
            { id: 76, category: 'promo', name: 'Disponible', bg: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)', texts: [{ text: '✓', font: 'Poppins', size: 56, color: '#ffffff', y: 30 }, { text: 'DISPONIBLE', font: 'Montserrat', size: 32, color: '#ffffff', y: 55 }] },
            { id: 77, category: 'social', name: 'Collab', bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', texts: [{ text: '🤝', font: 'Poppins', size: 48, color: '#ffffff', y: 28 }, { text: 'COLLAB', font: 'Anton', size: 48, color: '#ffffff', y: 52 }] },
            { id: 78, category: 'quote', name: 'Thank You', bg: 'linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%)', texts: [{ text: '💖', font: 'Poppins', size: 48, color: '#ffffff', y: 28 }, { text: 'THANK', font: 'Playfair Display', size: 36, color: '#c0392b', y: 48 }, { text: 'YOU', font: 'Playfair Display', size: 36, color: '#c0392b', y: 65 }] },
            { id: 79, category: 'birthday', name: 'Confetti', bg: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)', texts: [{ text: '🎊🎉🎊', font: 'Poppins', size: 32, color: '#ffffff', y: 28 }, { text: 'PARTY', font: 'Anton', size: 52, color: '#ffffff', y: 52 }] },
            { id: 80, category: 'sale', name: 'Final Sale', bg: '#1a1a1a', texts: [{ text: 'FINAL', font: 'Bebas Neue', size: 48, color: '#ffffff', y: 35 }, { text: 'SALE', font: 'Bebas Neue', size: 64, color: '#ff0000', y: 55 }] },
        ];

        // Emojis populares
        const emojis = [
            '😀', '😍', '🥳', '😎', '🤩', '😂', '🥰', '😘', '🤗', '🙌',
            '❤️', '🔥', '✨', '💯', '🎉', '🎊', '💪', '👏', '🙏', '💕',
            '🌟', '⭐', '💫', '🌈', '☀️', '🌙', '💖', '💝', '💗', '💓',
            '👑', '🦋', '🌸', '🌺', '🌻', '🍀', '🎵', '🎶', '🎤', '🎧',
            '📸', '🎬', '🎨', '✌️', '🤟', '👍', '💋', '👀', '💅', '💄'
        ];

        // ========================================
        // INICIALIZACIÓN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Reaplicar tema al cargar el DOM (por si acaso)
            var savedTheme = ThemeStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.classList.remove('theme-light', 'theme-dark');
            document.body.classList.add('theme-' + savedTheme);

            initCanvas();
            initEmojis();
        });

        function initCanvas() {
            const wrapper = document.getElementById('canvasWrapper');
            const width = wrapper.clientWidth || 380;
            const height = wrapper.clientHeight || 675;

            canvas = new fabric.Canvas('storyCanvas', {
                width: width,
                height: height,
                backgroundColor: '#000',
                selection: true,
                preserveObjectStacking: true,
                allowTouchScrolling: false,
                stopContextMenu: true,
                fireRightClick: true
            });

            // Inicializar brush de dibujo
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = drawConfig.color;
            canvas.freeDrawingBrush.width = drawConfig.width;
            canvas.freeDrawingBrush.decimate = 5;

            // Guardar estado inicial
            saveHistory();

            // Eventos de selección
            canvas.on('selection:created', onObjectSelected);
            canvas.on('selection:updated', onObjectSelected);
            canvas.on('selection:cleared', onSelectionCleared);

        }

        function initEmojis() {
            const grid = document.getElementById('emojiGrid');
            emojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.textContent = emoji;
                item.onclick = () => agregarSticker(emoji);
                grid.appendChild(item);
            });
        }

        // ========================================
        // CARGAR MEDIA
        // ========================================
        let isVideoMedia = false; // Para saber si el media actual es video

        function cargarMedia(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                mediaFile = file;

                const reader = new FileReader();
                reader.onload = function(e) {
                    mediaUrl = e.target.result;
                    const videoElement = document.getElementById('videoBackground');

                    if (file.type.startsWith('image/')) {
                        // Es una imagen
                        isVideoMedia = false;
                        videoElement.classList.remove('active');
                        videoElement.pause();
                        videoElement.src = '';

                        fabric.Image.fromURL(mediaUrl, function(img) {
                            // Escalar para cubrir todo el canvas
                            const scale = Math.max(
                                canvas.width / img.width,
                                canvas.height / img.height
                            );
                            img.scale(scale);
                            img.set({
                                left: canvas.width / 2,
                                top: canvas.height / 2,
                                originX: 'center',
                                originY: 'center',
                                selectable: false,
                                evented: false,
                                lockMovementX: true,
                                lockMovementY: true
                            });
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                            saveHistory();
                        });
                    } else if (file.type.startsWith('video/')) {
                        // Es un video
                        isVideoMedia = true;

                        // Limpiar fondo del canvas (hacerlo transparente)
                        canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                        canvas.backgroundColor = 'transparent';
                        canvas.renderAll();

                        // Configurar el video
                        videoElement.src = mediaUrl;
                        videoElement.classList.add('active');

                        // Esperar a que el video cargue para mostrar el primer frame
                        videoElement.onloadeddata = function() {
                            // Ir a un frame visible (0.1 segundos)
                            videoElement.currentTime = 0.1;
                        };

                        // Cuando esté listo para reproducir
                        videoElement.oncanplay = function() {
                            // Reproducir automáticamente
                            videoElement.play().catch(err => {
                                videoElement.currentTime = 0.1;
                            });
                        };

                        // Cargar el video
                        videoElement.load();
                        saveHistory();
                    }

                    // Ocultar overlay de upload
                    document.getElementById('uploadOverlay').classList.add('hidden');
                    document.getElementById('publishBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // ========================================
        // HERRAMIENTAS
        // ========================================
        function seleccionarHerramienta(tool) {
            currentTool = tool;

            // Actualizar botones
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });

            // Mostrar panel de opciones correspondiente
            document.querySelectorAll('.option-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tool + 'Options').classList.add('active');

            // Actualizar título
            const titles = {
                'text': 'Texto',
                'sticker': 'Stickers',
                'mention': 'Mencionar',
                'draw': 'Dibujar',
                'music': 'Música',
                'link': 'Enlace',
                'adjust': 'Ajustes',
                'crop': 'Recortar',
                'background': 'Fondos',
                'template': 'Plantillas',
                'beatsync': 'Beat Sync'
            };
            document.getElementById('optionsTitle').textContent = titles[tool] || 'Opciones';

            // Modo dibujo
            canvas.isDrawingMode = (tool === 'draw');
            if (tool === 'draw') {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = drawConfig.color;
                canvas.freeDrawingBrush.width = drawConfig.width;
                canvas.freeDrawingBrush.decimate = 5;
            }

            // Cargar música cuando se selecciona esa herramienta
            if (tool === 'music') {
                cargarMusicaPopular();
            }

            // Cargar plantillas cuando se selecciona esa herramienta
            if (tool === 'template') {
                renderizarPlantillas('all');
            }

            // Abrir panel en móvil
            if (window.innerWidth <= 768) {
                abrirPanelOpciones();
            }
        }

        function abrirPanelOpciones() {
            document.getElementById('optionsPanel').classList.add('open');
            document.getElementById('optionsBackdrop').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function cerrarPanelOpciones() {
            document.getElementById('optionsPanel').classList.remove('open');
            document.getElementById('optionsBackdrop').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ========================================
        // TEXTO
        // ========================================
        function agregarTexto() {
            const texto = document.getElementById('textInput').value.trim();
            if (!texto) return;

            const textObj = new fabric.IText(texto, {
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center',
                fontFamily: textConfig.font,
                fontSize: textConfig.size,
                fill: textConfig.color,
                textBackgroundColor: textConfig.backgroundColor === 'transparent' ? '' : textConfig.backgroundColor,
                padding: 8,
                borderRadius: 4,
                // Propiedades de interaccion
                selectable: true,
                evented: true,
                hasControls: true,
                hasBorders: true,
                cornerColor: '#4682B4',
                cornerStyle: 'circle',
                borderColor: '#4682B4',
                transparentCorners: false,
                cornerSize: 10
            });

            canvas.add(textObj);
            canvas.setActiveObject(textObj);
            canvas.bringToFront(textObj);
            canvas.renderAll();
            saveHistory();

            // Limpiar input
            document.getElementById('textInput').value = '';
        }

        function actualizarTextoSeleccionado() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set('text', document.getElementById('textInput').value);
                canvas.renderAll();
            }
        }

        function cambiarFuente(font, el) {
            textConfig.font = font;
            // Deseleccionar en el grupo de fuentes de texto
            el.closest('.link-fonts-grid').querySelectorAll('.link-font-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');

            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set('fontFamily', font);
                canvas.renderAll();
            }
        }

        function cambiarTamanoTexto(size) {
            textConfig.size = parseInt(size);
            document.getElementById('fontSizeLabel').textContent = size;

            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set('fontSize', parseInt(size));
                canvas.renderAll();
            }
        }

        function cambiarColorTexto(color, el) {
            textConfig.color = color;
            document.querySelectorAll('#textColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');

            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set('fill', color);
                canvas.renderAll();
            }
        }

        function cambiarFondoTexto(color, el) {
            textConfig.backgroundColor = color;
            document.querySelectorAll('#textBgPicker .color-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');

            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set('textBackgroundColor', color === 'transparent' ? '' : color);
                canvas.renderAll();
            }
        }

        // ========================================
        // STICKERS
        // ========================================
        function agregarSticker(emoji) {
            const text = new fabric.Text(emoji, {
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center',
                fontSize: 64,
                selectable: true,
                evented: true,
                hasControls: true,
                hasBorders: true,
                cornerColor: '#4682B4',
                cornerStyle: 'circle',
                borderColor: '#4682B4',
                transparentCorners: false,
                cornerSize: 10
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.bringToFront(text);
            canvas.renderAll();
            saveHistory();
        }

        // ========================================
        // MENCIONES
        // ========================================
        let searchTimeout;

        async function buscarUsuarios(query) {
            clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('mentionResults');

            if (query.length < 2) {
                resultsDiv.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/Stories/BuscarUsuarios?query=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success && data.usuarios && data.usuarios.length > 0) {
                        resultsDiv.innerHTML = data.usuarios.map(u => `
                            <div class="mention-item" onclick="agregarMencion('${escapeHtml(u.id)}', '${escapeHtml(u.username)}', '${escapeHtml(u.avatar || '')}')">
                                ${u.avatar
                                    ? `<img src="${escapeHtml(u.avatar)}" class="mention-avatar" />`
                                    : `<div class="mention-avatar" style="display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;">${escapeHtml(u.nombre?.charAt(0) || '?')}</div>`
                                }
                                <div>
                                    <div style="font-weight:600;">@@${escapeHtml(u.username)}</div>
                                    <div style="font-size:12px;color:var(--muted);">${escapeHtml(u.nombre)}</div>
                                </div>
                            </div>
                        `).join('');
                        resultsDiv.classList.add('active');
                    } else {
                        resultsDiv.innerHTML = '<div style="padding:12px;color:var(--muted);">No se encontraron usuarios</div>';
                        resultsDiv.classList.add('active');
                    }
                } catch (error) {
                }
            }, 300);
        }

        function agregarMencion(userId, username, avatar) {
            const text = new fabric.IText('@@' + username, {
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center',
                fontFamily: 'Arial',
                fontSize: 28,
                fill: '#ffffff',
                fontWeight: 'bold',
                textBackgroundColor: 'rgba(0,0,0,0.5)',
                padding: 6,
                userId: userId,     // Metadata para guardar
                username: username  // Username sin arroba
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            saveHistory();

            // Cerrar resultados
            document.getElementById('mentionResults').classList.remove('active');
            document.getElementById('mentionSearch').value = '';
        }

        // ========================================
        // DIBUJO
        // ========================================
        function cambiarGrosorPincel(width, el) {
            drawConfig.width = width;
            canvas.freeDrawingBrush.width = width;
            document.querySelectorAll('.brush-size').forEach(btn => btn.classList.remove('selected'));
            el.classList.add('selected');
        }

        function cambiarColorPincel(color, el) {
            drawConfig.color = color;
            canvas.freeDrawingBrush.color = color;
            document.querySelectorAll('#brushColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function borrarDibujo() {
            const objects = canvas.getObjects().filter(obj => obj.type === 'path');
            objects.forEach(obj => canvas.remove(obj));
            canvas.renderAll();
            saveHistory();
        }

        // ========================================
        // MÚSICA - Estilo TikTok
        // ========================================
        let currentMusicTab = 'popular';
        let musicaFavoritos = JSON.parse(localStorage.getItem('musicaFavoritos') || '[]');
        let musicaRecientes = JSON.parse(localStorage.getItem('musicaRecientes') || '[]');

        function toggleMusicSearch() {
            const container = document.getElementById('musicSearchContainer');
            const input = document.getElementById('musicSearch');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                input.focus();
            } else {
                input.value = '';
                cargarMusicaTab(currentMusicTab);
            }
        }

        function cambiarTabMusica(tab, el) {
            currentMusicTab = tab;
            document.querySelectorAll('.music-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            // Cerrar búsqueda si está abierta
            document.getElementById('musicSearchContainer').classList.remove('active');
            document.getElementById('musicSearch').value = '';

            cargarMusicaTab(tab);
        }

        async function cargarMusicaTab(tab) {
            const listDiv = document.getElementById('musicList');
            listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>Cargando...</p></div>';

            if (tab === 'favoritos') {
                if (musicaFavoritos.length > 0) {
                    mostrarListaMusica(musicaFavoritos);
                } else {
                    listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><p>No tienes favoritos</p></div>';
                }
                return;
            }

            if (tab === 'recientes') {
                if (musicaRecientes.length > 0) {
                    mostrarListaMusica(musicaRecientes);
                } else {
                    listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><p>No hay recientes</p></div>';
                }
                return;
            }

            try {
                const response = await fetch('/Stories/BuscarMusica?query=');
                const data = await response.json();

                if (data.success && data.pistas && data.pistas.length > 0) {
                    mostrarListaMusica(data.pistas);
                } else {
                    listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No hay canciones disponibles</p></div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>Error al cargar</p></div>';
            }
        }

        async function buscarMusica(query) {
            const listDiv = document.getElementById('musicList');

            if (query.length < 2) {
                cargarMusicaTab(currentMusicTab);
                return;
            }

            listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>Buscando...</p></div>';

            try {
                const response = await fetch(`/Stories/BuscarMusica?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success && data.pistas && data.pistas.length > 0) {
                    mostrarListaMusica(data.pistas);
                } else {
                    listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No se encontraron canciones</p></div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>Error al buscar</p></div>';
            }
        }

        async function cargarMusicaPopular() {
            cargarMusicaTab('popular');
        }

        function toggleFavorito(pista, btn, e) {
            e.stopPropagation();
            const index = musicaFavoritos.findIndex(f => f.id === pista.id);

            if (index > -1) {
                musicaFavoritos.splice(index, 1);
                btn.classList.remove('favorited');
            } else {
                musicaFavoritos.unshift(pista);
                btn.classList.add('favorited');
            }

            localStorage.setItem('musicaFavoritos', JSON.stringify(musicaFavoritos));
        }

        function agregarARecientes(pista) {
            // Remover si ya existe
            musicaRecientes = musicaRecientes.filter(r => r.id !== pista.id);
            // Agregar al inicio
            musicaRecientes.unshift(pista);
            // Mantener solo los últimos 20
            musicaRecientes = musicaRecientes.slice(0, 20);
            localStorage.setItem('musicaRecientes', JSON.stringify(musicaRecientes));
        }

        function mostrarListaMusica(pistas) {
            const listDiv = document.getElementById('musicList');

            if (!pistas || pistas.length === 0) {
                listDiv.innerHTML = '<div class="music-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No hay canciones</p></div>';
                return;
            }

            listDiv.innerHTML = pistas.map(p => {
                const isFavorito = musicaFavoritos.some(f => f.id === p.id);
                const isSelected = selectedMusic?.id === p.id;
                const pistaJson = JSON.stringify(p).replace(/"/g, '&quot;');

                return `
                <div class="music-item ${isSelected ? 'selected' : ''}" data-music-id="${p.id}" onclick="seleccionarMusica(${pistaJson})">
                    <img src="${escapeHtml(p.portada) || '/images/music-placeholder.svg'}" class="music-cover" onerror="this.src='/images/music-placeholder.svg'" />
                    <div class="music-info">
                        <div class="music-title-row">
                            <span class="music-playing-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                            </span>
                            <span class="music-title">${escapeHtml(p.titulo)}</span>
                        </div>
                        <div class="music-meta">
                            <span>${escapeHtml(p.artista)}</span>
                            <span>${formatDuration(p.duracion || 0)}</span>
                        </div>
                    </div>
                    <div class="music-actions">
                        <button type="button" class="music-action-btn" onclick="event.stopPropagation(); seleccionarMusica(${pistaJson})" title="Usar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="15" y2="15"/>
                            </svg>
                        </button>
                        <button type="button" class="music-action-btn ${isFavorito ? 'favorited' : ''}" onclick="toggleFavorito(${pistaJson}, this, event)" title="${isFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
                            <svg viewBox="0 0 24 24" fill="${isFavorito ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ========================================
        // AUDIO CUTTER - Waveform Editor
        // ========================================
        const audioCutter = document.getElementById('audioCutterContainer');
        const waveformCanvas = document.getElementById('waveformCanvas');
        const waveformContainer = document.getElementById('waveformContainer');
        const waveformSelection = document.getElementById('waveformSelection');
        const handleLeft = document.getElementById('handleLeft');
        const handleRight = document.getElementById('handleRight');
        const waveformPlayhead = document.getElementById('waveformPlayhead');
        const waveformTime = document.getElementById('waveformTime');
        const cutStartInput = document.getElementById('cutStartInput');
        const cutEndInput = document.getElementById('cutEndInput');
        const selectionDurationSpan = document.getElementById('selectionDuration');
        const cutterPlayBtn = document.getElementById('cutterPlayBtn');
        const cutterVolumeSlider = document.getElementById('cutterVolumeSlider');
        const cutterVolumeValue = document.getElementById('cutterVolumeValue');
        const cutterDuration = document.getElementById('cutterDuration');

        let audioContext = null;
        let audioBuffer = null;
        let audioDuration = 0;
        let selectionStart = 0;
        let selectionEnd = 15;
        let isPlaying = false;
        let playbackSource = null;
        let playbackStartTime = 0;
        let playbackAnimationId = null;
        let isDragging = false;
        let dragHandle = null;

        function seleccionarMusica(pista) {
            // Detener cualquier preview en reproducción
            stopAllPreviews();

            selectedMusic = pista;
            musicDuration = pista.duracion || 180;
            musicTrimStart = 0;
            musicVolume = 70;
            selectionStart = 0;
            selectionEnd = Math.min(15, musicDuration);

            // Agregar a recientes (solo si no es personalizada)
            if (!pista.esPersonalizada) {
                agregarARecientes(pista);
            }

            // Marcar como seleccionada en la lista
            document.querySelectorAll('.music-item').forEach(item => item.classList.remove('selected'));
            const musicItem = document.querySelector(`.music-item[data-music-id="${pista.id}"]`);
            if (musicItem) musicItem.classList.add('selected');

            // Mostrar el panel de música seleccionada
            const container = document.getElementById('selectedMusicContainer');
            container.style.display = 'block';

            // Mostrar el selector de música (por si estaba oculto)
            const selector = document.querySelector('.music-selector');
            if (selector) selector.style.display = 'block';

            // Resetear botón de confirmar
            const btnConfirm = document.getElementById('btnConfirmMusic');
            if (btnConfirm) {
                btnConfirm.classList.remove('confirmed');
                btnConfirm.querySelector('span').textContent = 'Usar esta música';
            }

            // Actualizar info de la canción
            document.getElementById('selectedMusicTitle').textContent = `${pista.titulo} - ${pista.artista}`;

            // Inicializar audio cutter
            if (pista.audioUrl) {
                initAudioCutter(pista.audioUrl);
            }
        }

        async function initAudioCutter(url) {
            if (!waveformCanvas || !url) return;

            audioCutter.classList.add('loading');

            try {
                // Crear AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Cargar audio
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioDuration = audioBuffer.duration;

                // Actualizar UI
                if (cutterDuration) cutterDuration.textContent = formatTime(audioDuration);
                selectionEnd = Math.min(15, audioDuration);

                // Dibujar forma de onda
                drawWaveform();
                updateSelection();
                setupDragHandles();

                audioCutter.classList.remove('loading');
            } catch (error) {
                audioCutter.classList.remove('loading');
            }
        }

        function drawWaveform() {
            if (!audioBuffer || !waveformCanvas) return;

            const ctx = waveformCanvas.getContext('2d');
            const width = waveformContainer.offsetWidth;
            const height = waveformContainer.offsetHeight;

            waveformCanvas.width = width * window.devicePixelRatio;
            waveformCanvas.height = height * window.devicePixelRatio;
            waveformCanvas.style.width = width + 'px';
            waveformCanvas.style.height = height + 'px';
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            // Combinar canales si es stereo
            const channelData = audioBuffer.getChannelData(0);
            const data = audioBuffer.numberOfChannels > 1
                ? mergeChannels(channelData, audioBuffer.getChannelData(1))
                : channelData;

            // Calcular pico máximo para normalizar
            let maxPeak = 0;
            for (let i = 0; i < data.length; i++) {
                const absVal = Math.abs(data[i]);
                if (absVal > maxPeak) maxPeak = absVal;
            }
            maxPeak = maxPeak || 1;

            // Configuración de barras
            const barWidth = 3;
            const barGap = 1;
            const barCount = Math.floor(width / (barWidth + barGap));
            const samplesPerBar = Math.floor(data.length / barCount);
            const centerY = height / 2;

            ctx.clearRect(0, 0, width, height);

            for (let i = 0; i < barCount; i++) {
                const startSample = i * samplesPerBar;
                const endSample = startSample + samplesPerBar;

                let sumSquares = 0;
                let peakInBar = 0;
                for (let j = startSample; j < endSample && j < data.length; j++) {
                    const val = Math.abs(data[j]);
                    sumSquares += val * val;
                    if (val > peakInBar) peakInBar = val;
                }
                const rms = Math.sqrt(sumSquares / samplesPerBar);
                const normalizedValue = ((rms * 0.7) + (peakInBar * 0.3)) / maxPeak;
                const barHeight = Math.max(2, normalizedValue * height * 0.9);

                const x = i * (barWidth + barGap);
                const y = centerY - (barHeight / 2);

                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, 1);
                ctx.fill();
            }
        }

        function mergeChannels(ch1, ch2) {
            const merged = new Float32Array(ch1.length);
            for (let i = 0; i < ch1.length; i++) {
                merged[i] = (ch1[i] + ch2[i]) / 2;
            }
            return merged;
        }

        function updateSelection() {
            if (!waveformContainer || !waveformSelection || !audioDuration) return;

            const startPercent = (selectionStart / audioDuration) * 100;
            const endPercent = (selectionEnd / audioDuration) * 100;

            waveformSelection.style.left = startPercent + '%';
            waveformSelection.style.width = (endPercent - startPercent) + '%';

            // Actualizar inputs de tiempo
            if (cutStartInput) cutStartInput.value = formatTimeMs(selectionStart);
            if (cutEndInput) cutEndInput.value = formatTimeMs(selectionEnd);
            if (selectionDurationSpan) {
                selectionDurationSpan.textContent = (selectionEnd - selectionStart).toFixed(1) + 's';
            }

            // Guardar valores
            musicTrimStart = Math.round(selectionStart);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTimeMs(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins.toString().padStart(2, '0')}:${secs.padStart(4, '0')}`;
        }

        // Drag handles para selección
        function setupDragHandles() {
            if (!handleLeft || !handleRight || !waveformContainer) return;

            const startDrag = (e, handle) => {
                e.preventDefault();
                e.stopPropagation();
                isDragging = true;
                dragHandle = handle;

                document.body.style.cursor = 'ew-resize';
                if (handle === 'left') {
                    handleLeft.classList.add('dragging');
                } else {
                    handleRight.classList.add('dragging');
                }

                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            };

            handleLeft.addEventListener('mousedown', (e) => startDrag(e, 'left'));
            handleRight.addEventListener('mousedown', (e) => startDrag(e, 'right'));
            handleLeft.addEventListener('touchstart', (e) => startDrag(e, 'left'), { passive: false });
            handleRight.addEventListener('touchstart', (e) => startDrag(e, 'right'), { passive: false });
        }

        function onDrag(e) {
            if (!isDragging || !waveformContainer || !audioDuration) return;
            e.preventDefault();

            const rect = waveformContainer.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let x = clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));

            const time = (x / rect.width) * audioDuration;

            if (dragHandle === 'left') {
                selectionStart = Math.min(time, selectionEnd - 1);
                selectionStart = Math.max(0, selectionStart);
            } else {
                selectionEnd = Math.max(time, selectionStart + 1);
                selectionEnd = Math.min(audioDuration, selectionEnd);
            }

            updateSelection();
        }

        function stopDrag() {
            isDragging = false;
            document.body.style.cursor = '';

            if (handleLeft) handleLeft.classList.remove('dragging');
            if (handleRight) handleRight.classList.remove('dragging');

            dragHandle = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        // Click en waveform para mover selección
        if (waveformContainer) {
            waveformContainer.addEventListener('click', function(e) {
                if (isDragging) return;
                if (e.target.closest('.selection-handle')) return;
                if (!audioDuration) return;

                const rect = waveformContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const clickTime = (x / rect.width) * audioDuration;

                const duration = selectionEnd - selectionStart;
                let newStart = clickTime - (duration / 2);
                newStart = Math.max(0, Math.min(newStart, audioDuration - duration));

                selectionStart = newStart;
                selectionEnd = newStart + duration;
                updateSelection();
            });
        }

        // Reproducir selección
        if (cutterPlayBtn) {
            cutterPlayBtn.addEventListener('click', function() {
                if (isPlaying) {
                    stopPlayback();
                } else {
                    playSelection();
                }
            });
        }

        function playSelection() {
            if (!audioBuffer || !audioContext) return;

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const volume = (cutterVolumeSlider?.value || 70) / 100;

            playbackSource = audioContext.createBufferSource();
            playbackSource.buffer = audioBuffer;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            playbackSource.connect(gainNode);
            gainNode.connect(audioContext.destination);

            const duration = selectionEnd - selectionStart;
            playbackStartTime = audioContext.currentTime;
            playbackSource.start(0, selectionStart, duration);

            playbackSource.onended = () => {
                stopPlayback();
            };

            isPlaying = true;
            updatePlayButton(true);
            animatePlayhead();
        }

        function stopPlayback() {
            if (playbackSource) {
                try { playbackSource.stop(); } catch(e) {}
                playbackSource = null;
            }
            if (playbackAnimationId) {
                cancelAnimationFrame(playbackAnimationId);
                playbackAnimationId = null;
            }
            isPlaying = false;
            updatePlayButton(false);
            if (waveformPlayhead) {
                waveformPlayhead.style.display = 'none';
            }
        }

        function animatePlayhead() {
            if (!isPlaying || !waveformPlayhead || !audioContext) return;

            const elapsed = audioContext.currentTime - playbackStartTime;
            const currentTime = selectionStart + elapsed;

            if (currentTime >= selectionEnd) {
                stopPlayback();
                return;
            }

            const percent = (currentTime / audioDuration) * 100;
            waveformPlayhead.style.display = 'block';
            waveformPlayhead.style.left = percent + '%';

            if (waveformTime) {
                waveformTime.textContent = formatTimeMs(currentTime);
            }

            playbackAnimationId = requestAnimationFrame(animatePlayhead);
        }

        function updatePlayButton(playing) {
            if (!cutterPlayBtn) return;
            const playIcon = cutterPlayBtn.querySelector('.play-icon');
            const pauseIcon = cutterPlayBtn.querySelector('.pause-icon');

            if (playing) {
                cutterPlayBtn.classList.add('playing');
                if (playIcon) playIcon.style.display = 'none';
                if (pauseIcon) pauseIcon.style.display = 'block';
            } else {
                cutterPlayBtn.classList.remove('playing');
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
            }
        }

        // Control de volumen
        if (cutterVolumeSlider) {
            cutterVolumeSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                musicVolume = value;
                if (cutterVolumeValue) {
                    cutterVolumeValue.textContent = value + '%';
                }
            });
        }

        function stopAllPreviews() {
            stopPlayback();
            if (listPreviewAudio) {
                listPreviewAudio.pause();
                listPreviewAudio = null;
            }
            // Resetear iconos de play en la lista
            document.querySelectorAll('.music-play-btn').forEach(btn => {
                const playIcon = btn.querySelector('.play-icon');
                const pauseIcon = btn.querySelector('.pause-icon');
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
            });
            document.querySelectorAll('.music-item').forEach(item => item.classList.remove('playing'));
        }

        function quitarMusica() {
            stopAllPreviews();
            selectedMusic = null;
            musicDuration = 0;
            musicTrimStart = 0;
            musicVolume = 70;
            audioDuration = 0;
            selectionStart = 0;
            selectionEnd = 15;
            audioBuffer = null;

            document.getElementById('selectedMusicContainer').style.display = 'none';
            document.querySelectorAll('.music-item').forEach(item => item.classList.remove('selected'));

            // Resetear botón de confirmar
            const btnConfirm = document.getElementById('btnConfirmMusic');
            if (btnConfirm) {
                btnConfirm.classList.remove('confirmed');
                btnConfirm.querySelector('span').textContent = 'Usar esta música';
            }
        }

        // Función para confirmar la selección de música
        function confirmarMusica() {
            if (!selectedMusic) return;

            const btnConfirm = document.getElementById('btnConfirmMusic');
            btnConfirm.classList.add('confirmed');
            btnConfirm.querySelector('span').textContent = '¡Música agregada!';

            // Guardar los valores actuales
            musicTrimStart = selectionStart;
            musicVolume = parseInt(document.getElementById('cutterVolumeSlider').value);

            // Mostrar notificación
            mostrarNotificacion(`Música "${selectedMusic.titulo}" agregada`, 'success');

            // Ocultar el selector después de un momento
            setTimeout(() => {
                document.querySelector('.music-selector').style.display = 'none';
            }, 500);
        }

        // Función para manejar subida de música propia
        function handleMusicUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validar que sea un archivo de audio
            if (!file.type.startsWith('audio/')) {
                mostrarNotificacion('Por favor selecciona un archivo de audio válido', 'error');
                return;
            }

            // Validar tamaño (máximo 20MB)
            if (file.size > 20 * 1024 * 1024) {
                mostrarNotificacion('El archivo es muy grande. Máximo 20MB', 'error');
                return;
            }

            // Crear URL temporal para el archivo
            const audioUrl = URL.createObjectURL(file);

            // Obtener nombre sin extensión
            const fileName = file.name.replace(/\.[^/.]+$/, '');

            // Crear objeto de pista personalizada
            const customTrack = {
                id: 'custom_' + Date.now(),
                titulo: fileName,
                artista: 'Tu música',
                duracion: 0,
                audioUrl: audioUrl,
                portadaUrl: null,
                esPersonalizada: true
            };

            // Obtener duración del audio
            const tempAudio = new Audio(audioUrl);
            tempAudio.addEventListener('loadedmetadata', function() {
                customTrack.duracion = Math.floor(tempAudio.duration);

                // Seleccionar la pista
                seleccionarMusica(customTrack);

                mostrarNotificacion(`"${fileName}" cargado correctamente`, 'success');
            });

            tempAudio.addEventListener('error', function() {
                mostrarNotificacion('Error al cargar el archivo de audio', 'error');
                URL.revokeObjectURL(audioUrl);
            });

            // Limpiar el input para permitir seleccionar el mismo archivo otra vez
            input.value = '';
        }

        function toggleMusicPreview(url, btn) {
            if (!url) {
                return;
            }

            const musicItem = btn.closest('.music-item');
            const playIcon = btn.querySelector('.play-icon');
            const pauseIcon = btn.querySelector('.pause-icon');

            if (listPreviewAudio && !listPreviewAudio.paused) {
                const wasPlaying = musicItem.classList.contains('playing');
                stopAllPreviews();
                if (wasPlaying) return;
            }

            stopAllPreviews();

            listPreviewAudio = new Audio(url);
            listPreviewAudio.volume = 0.7;

            listPreviewAudio.addEventListener('error', function(e) {
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
                musicItem.classList.remove('playing');
            });

            listPreviewAudio.addEventListener('ended', function() {
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
                musicItem.classList.remove('playing');
            });

            listPreviewAudio.play().then(() => {
                if (playIcon) playIcon.style.display = 'none';
                if (pauseIcon) pauseIcon.style.display = 'block';
                musicItem.classList.add('playing');
            }).catch(err => {
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
                musicItem.classList.remove('playing');
            });
        }

        // ========================================
        // LINK
        // ========================================
        function cambiarEstiloLink(style, el) {
            linkConfig.style = style;
            document.querySelectorAll('.link-style-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function cambiarColorLink(color, el) {
            linkConfig.color = color;
            document.querySelectorAll('#linkColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function cambiarFuenteLink(font, el) {
            linkConfig.font = font;
            document.querySelectorAll('.link-font-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function getTextColorForBg(bgColor) {
            // Devuelve blanco o negro según el color de fondo
            if (bgColor === '#ffffff' || bgColor === '#ffdd00') return '#000000';
            return '#ffffff';
        }

        function getLinkFillColor() {
            if (linkConfig.color === 'gradient-purple') {
                // Fabric.js no soporta gradientes CSS, usar color sólido
                return '#764ba2';
            }
            return linkConfig.color;
        }

        function eliminarLinkActual() {
            if (storyLinkObject) {
                canvas.remove(storyLinkObject);
                storyLinkObject = null;
                canvas.renderAll();
                saveHistory();
                document.getElementById('linkAddedIndicator').style.display = 'none';
            }
        }

        function agregarLink() {
            const url = document.getElementById('linkUrl').value.trim();
            const text = document.getElementById('linkText').value.trim() || 'Ver mas';

            if (!url) {
                alert('Por favor ingresa una URL');
                return;
            }

            // Validar URL
            let validUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                validUrl = 'https://' + url;
            }

            try {
                new URL(validUrl);
            } catch (e) {
                alert('La URL no es valida');
                return;
            }

            // Guardar configuración del link
            linkConfig.url = validUrl;
            linkConfig.text = text;

            // Eliminar link anterior si existe
            if (storyLinkObject) {
                canvas.remove(storyLinkObject);
                storyLinkObject = null;
            }

            // Calcular dimensiones
            const btnWidth = Math.max(text.length * 10 + 50, 100);
            const btnHeight = 40;
            const posX = canvas.width / 2;
            const posY = canvas.height - 100;
            const fillColor = getLinkFillColor();
            const textColor = getTextColorForBg(linkConfig.color);
            const style = linkConfig.style;
            const fontFamily = linkConfig.font;

            // Crear un Textbox con fondo simulado usando fabric.Rect + Text como objetos separados
            // pero agrupados visualmente. Para mejor interaccion, usamos un solo objeto Rect
            // y lo decoramos con texto encima usando toObject override

            // Enfoque simplificado: crear el boton como un Textbox con backgroundColor
            let linkObj;

            if (style === 'minimal') {
                // Estilo minimal: solo texto subrayado
                linkObj = new fabric.IText(text + ' →', {
                    left: posX,
                    top: posY,
                    originX: 'center',
                    originY: 'center',
                    fontSize: 16,
                    fontFamily: fontFamily,
                    fontWeight: 'bold',
                    fill: fillColor,
                    underline: true,
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 4, offsetX: 0, offsetY: 2 }),
                    editable: false
                });
            } else {
                // Para otros estilos, crear Group pero con configuracion correcta
                const rx = style === 'pill' || style === 'glass' || style === 'swipe' ? btnHeight / 2 :
                           style === 'rounded' ? 10 :
                           style === 'outline-pill' ? btnHeight / 2 : 3;

                let bgFill, bgStroke = null, bgStrokeWidth = 0, labelColor = textColor;

                switch (style) {
                    case 'outline-pill':
                    case 'outline-square':
                        bgFill = 'transparent';
                        bgStroke = fillColor;
                        bgStrokeWidth = 3;
                        labelColor = fillColor;
                        break;
                    case 'glass':
                        bgFill = 'rgba(255, 255, 255, 0.25)';
                        bgStroke = 'rgba(255, 255, 255, 0.4)';
                        bgStrokeWidth = 1;
                        labelColor = '#ffffff';
                        break;
                    case 'swipe':
                        bgFill = 'rgba(0, 0, 0, 0.7)';
                        labelColor = '#ffffff';
                        break;
                    case 'gradient':
                        bgFill = fillColor; // Se vera como color solido en canvas
                        break;
                    default:
                        bgFill = fillColor;
                }

                const rect = new fabric.Rect({
                    width: btnWidth,
                    height: btnHeight,
                    rx: rx,
                    ry: rx,
                    fill: bgFill,
                    stroke: bgStroke,
                    strokeWidth: bgStrokeWidth,
                    originX: 'center',
                    originY: 'center',
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 8, offsetX: 0, offsetY: 4 })
                });

                const displayText = style === 'swipe' ? '↑ ' + text : text;
                const label = new fabric.Text(displayText, {
                    fontSize: style === 'swipe' ? 14 : 15,
                    fontFamily: fontFamily,
                    fontWeight: 'bold',
                    fill: labelColor,
                    originX: 'center',
                    originY: 'center'
                });

                // Crear grupo con configuracion para interaccion
                linkObj = new fabric.Group([rect, label], {
                    left: posX,
                    top: posY,
                    originX: 'center',
                    originY: 'center',
                    // Propiedades criticas para movimiento
                    subTargetCheck: false,
                    interactive: false
                });
            }

            // Propiedades importantes para visibilidad y movimiento
            linkObj.set({
                selectable: true,
                evented: true,
                hasControls: true,
                hasBorders: true,
                lockScalingFlip: true,
                cornerColor: '#4682B4',
                cornerStyle: 'circle',
                borderColor: '#4682B4',
                borderScaleFactor: 2,
                transparentCorners: false,
                cornerSize: 12,
                padding: 10,
                // Asegurar que el objeto responda a eventos
                hoverCursor: 'move',
                moveCursor: 'move'
            });

            // Marcar como link para identificarlo
            linkObj.isStoryLink = true;
            linkObj.linkUrl = validUrl;
            linkObj.linkText = text;
            linkObj.linkStyle = style;
            linkObj.linkColor = linkConfig.color;
            linkObj.linkFont = fontFamily;

            // Agregar al canvas
            canvas.add(linkObj);

            // Forzar la seleccion del objeto
            canvas.discardActiveObject();
            canvas.setActiveObject(linkObj);
            canvas.bringToFront(linkObj);
            canvas.requestRenderAll();

            // Guardar referencia
            storyLinkObject = linkObj;
            saveHistory();

            // Mostrar indicador
            document.getElementById('linkAddedIndicator').style.display = 'block';
        }

        // ========================================
        // AJUSTES DE IMAGEN/VIDEO (Voltear, Rotar, Filtros)
        // ========================================

        // Estado de ajustes
        let adjustState = {
            flipX: false,
            flipY: false,
            rotation: 0,
            filter: 'none',
            brightness: 0,
            contrast: 0,
            saturation: 0
        };

        function voltearHorizontal() {
            adjustState.flipX = !adjustState.flipX;
            aplicarTransformaciones();
        }

        function voltearVertical() {
            adjustState.flipY = !adjustState.flipY;
            aplicarTransformaciones();
        }

        function rotarImagen(grados) {
            adjustState.rotation = (adjustState.rotation + grados) % 360;
            aplicarTransformaciones();
        }

        function aplicarFiltro(filtro, elemento) {
            adjustState.filter = filtro;

            // Actualizar seleccion visual
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            if (elemento) elemento.classList.add('selected');

            aplicarTransformaciones();
        }

        function ajustarBrillo(valor) {
            adjustState.brightness = parseInt(valor);
            document.getElementById('brightnessLabel').textContent = valor;
            aplicarTransformaciones();
        }

        function ajustarContraste(valor) {
            adjustState.contrast = parseInt(valor);
            document.getElementById('contrastLabel').textContent = valor;
            aplicarTransformaciones();
        }

        function ajustarSaturacion(valor) {
            adjustState.saturation = parseInt(valor);
            document.getElementById('saturationLabel').textContent = valor;
            aplicarTransformaciones();
        }

        function resetearAjustes() {
            adjustState = {
                flipX: false,
                flipY: false,
                rotation: 0,
                filter: 'none',
                brightness: 0,
                contrast: 0,
                saturation: 0
            };

            // Resetear sliders
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('contrastSlider').value = 0;
            document.getElementById('saturationSlider').value = 0;
            document.getElementById('brightnessLabel').textContent = '0';
            document.getElementById('contrastLabel').textContent = '0';
            document.getElementById('saturationLabel').textContent = '0';

            // Resetear seleccion de filtro
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.filter-option')?.classList.add('selected');

            aplicarTransformaciones();
        }

        function aplicarTransformaciones() {
            const videoElement = document.getElementById('videoBackground');
            const bgImage = canvas.backgroundImage;

            // Construir filtro CSS
            let cssFilter = '';

            // Filtros predefinidos
            switch (adjustState.filter) {
                case 'grayscale':
                    cssFilter += 'grayscale(100%) ';
                    break;
                case 'sepia':
                    cssFilter += 'sepia(80%) ';
                    break;
                case 'vintage':
                    cssFilter += 'sepia(30%) contrast(90%) saturate(85%) ';
                    break;
                case 'cold':
                    cssFilter += 'saturate(80%) hue-rotate(180deg) brightness(95%) ';
                    break;
                case 'warm':
                    cssFilter += 'saturate(130%) sepia(20%) brightness(105%) ';
                    break;
                case 'contrast':
                    cssFilter += 'contrast(140%) ';
                    break;
                case 'brightness':
                    cssFilter += 'brightness(120%) contrast(95%) ';
                    break;
            }

            // Ajustes manuales
            if (adjustState.brightness !== 0) {
                cssFilter += `brightness(${100 + adjustState.brightness}%) `;
            }
            if (adjustState.contrast !== 0) {
                cssFilter += `contrast(${100 + adjustState.contrast}%) `;
            }
            if (adjustState.saturation !== 0) {
                cssFilter += `saturate(${100 + adjustState.saturation}%) `;
            }

            // Construir transformacion
            let transform = '';
            if (adjustState.flipX) transform += 'scaleX(-1) ';
            if (adjustState.flipY) transform += 'scaleY(-1) ';
            if (adjustState.rotation !== 0) transform += `rotate(${adjustState.rotation}deg) `;

            // Aplicar a video si esta activo
            if (isVideoMedia && videoElement) {
                videoElement.style.filter = cssFilter.trim() || 'none';
                videoElement.style.transform = transform.trim() || 'none';
            }

            // Aplicar a imagen de fondo del canvas si existe
            // IMPORTANTE: No aplicar transforms al contenedor de Fabric porque rompe la interactividad
            // En su lugar, aplicamos al lower-canvas que contiene la imagen de fondo
            if (bgImage && !isVideoMedia) {
                const lowerCanvas = document.querySelector('.canvas-wrapper .lower-canvas');
                if (lowerCanvas) {
                    lowerCanvas.style.filter = cssFilter.trim() || 'none';
                    lowerCanvas.style.transform = transform.trim() || 'none';
                    lowerCanvas.style.transformOrigin = 'center center';
                }
            }
        }

        // ========================================
        // UTILIDADES
        // ========================================

        // Escapar HTML para prevenir XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function onObjectSelected(e) {
            const obj = e.selected[0];
            if (obj && obj.type === 'i-text') {
                document.getElementById('textInput').value = obj.text;
            }
        }

        function onSelectionCleared() {
            // Opcional: limpiar inputs
        }

        function eliminarSeleccion() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.remove(obj);
                canvas.renderAll();
                saveHistory();
            }
        }

        function saveHistory() {
            historyIndex++;
            canvasHistory = canvasHistory.slice(0, historyIndex);
            canvasHistory.push(canvas.toJSON());
        }

        function deshacerCambio() {
            if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(canvasHistory[historyIndex], function() {
                    canvas.renderAll();
                });
            }
        }

        function seleccionarLado(lado, el) {
            selectedLado = lado;
            document.querySelectorAll('.lado-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        // ========================================
        // PUBLICAR
        // ========================================
        async function publicarStory() {
            if (!mediaFile) {
                alert(MODO_EDITOR === 'reel' ? 'Debes subir una imagen o video para el reel' : 'Debes subir una imagen o video');
                return;
            }

            document.getElementById('loadingOverlay').classList.add('active');

            try {
                // Recopilar elementos del canvas
                const elementos = {
                    textos: [],
                    stickers: [],
                    dibujos: [],
                    menciones: [],
                    link: null,
                    canvasWidth: canvas.width,
                    canvasHeight: canvas.height
                };

                const mencionesIds = [];

                // Obtener dimensiones del canvas para convertir a porcentajes
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;

                // Función para convertir path de Fabric.js a string SVG
                function fabricPathToSvg(pathArray) {
                    if (!pathArray || !Array.isArray(pathArray)) return '';
                    return pathArray.map(cmd => {
                        if (Array.isArray(cmd)) {
                            return cmd.join(' ');
                        }
                        return cmd;
                    }).join(' ');
                }

                // Agregar marca de agua automáticamente
                const watermarkText = {
                    id: 9999,
                    texto: 'Creado con Ladoapp.com',
                    x: 50, // Centrado horizontalmente
                    y: 97, // Muy abajo (97% desde arriba)
                    fontSize: 10,
                    fontFamily: 'Poppins',
                    color: 'rgba(255, 255, 255, 0.6)',
                    backgroundColor: null,
                    rotation: 0,
                    isWatermark: true
                };
                elementos.textos.push(watermarkText);

                canvas.getObjects().forEach((obj, index) => {
                    // Convertir coordenadas a porcentajes
                    const xPercent = (obj.left / canvasWidth) * 100;
                    const yPercent = (obj.top / canvasHeight) * 100;

                    if (obj.type === 'i-text') {
                        if (obj.userId) {
                            // Es una mención
                            elementos.menciones.push({
                                id: index,
                                usuarioId: obj.userId,
                                username: obj.username || obj.text.replace('@@', ''),
                                x: xPercent,
                                y: yPercent,
                                fontSize: obj.fontSize,
                                color: obj.fill
                            });
                            mencionesIds.push(obj.userId);
                        } else {
                            // Es texto normal
                            elementos.textos.push({
                                id: index,
                                texto: obj.text,
                                x: xPercent,
                                y: yPercent,
                                fontSize: obj.fontSize,
                                fontFamily: obj.fontFamily,
                                color: obj.fill,
                                backgroundColor: obj.textBackgroundColor,
                                rotation: obj.angle
                            });
                        }
                    } else if (obj.type === 'text' && obj.text.length <= 4) {
                        // Es un sticker/emoji
                        elementos.stickers.push({
                            id: index,
                            valor: obj.text,
                            x: xPercent,
                            y: yPercent,
                            scale: obj.scaleX,
                            rotation: obj.angle
                        });
                    } else if (obj.type === 'path') {
                        // Es un dibujo - convertir path a SVG string
                        elementos.dibujos.push({
                            id: index,
                            pathData: fabricPathToSvg(obj.path),
                            color: obj.stroke,
                            strokeWidth: obj.strokeWidth
                        });
                    } else if (obj.isStoryLink) {
                        // Es un link
                        elementos.link = {
                            url: obj.linkUrl,
                            text: obj.linkText,
                            style: obj.linkStyle,
                            color: obj.linkColor || '#4682B4',
                            font: obj.linkFont || 'Poppins',
                            x: xPercent,
                            y: yPercent,
                            scale: obj.scaleX || 1,
                            rotation: obj.angle || 0
                        };
                    }
                });

                // Crear FormData
                const formData = new FormData();
                formData.append('archivo', mediaFile);
                formData.append('tipoLado', selectedLado);
                formData.append('elementosJson', JSON.stringify(elementos));
                formData.append('mencionesIds', mencionesIds.join(','));

                if (selectedMusic) {
                    formData.append('pistaMusicalId', selectedMusic.id);
                    formData.append('musicaTrimStart', musicTrimStart);
                    formData.append('musicaVolumen', musicVolume);
                }

                // Obtener token
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) {
                    formData.append('__RequestVerificationToken', tokenInput.value);
                }

                const response = await fetch(URL_CREAR, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = URL_REDIRECT;
                } else {
                    alert(data.message || 'Error al publicar');
                    document.getElementById('loadingOverlay').classList.remove('active');
                }
            } catch (error) {
                alert(MODO_EDITOR === 'reel' ? 'Error al publicar el reel' : 'Error al publicar la historia');
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function cancelarEditor() {
            const mensaje = MODO_EDITOR === 'reel' ? '¿Descartar reel?' : '¿Descartar historia?';
            if (confirm(mensaje)) {
                window.location.href = '/Feed';
            }
        }

        // ========================================
        // CROP / RECORTE
        // ========================================
        let cropCanvas = null;
        let cropCtx = null;
        let cropImage = null;
        let cropAspect = 'free';
        let cropBox = { x: 50, y: 50, w: 200, h: 300 };
        let isDraggingCrop = false;
        let isResizingCrop = false;
        let activeHandle = null;
        let dragStart = { x: 0, y: 0 };

        function seleccionarAspectRatio(ratio, el) {
            cropConfig.aspectRatio = ratio;
            document.querySelectorAll('#cropOptions .adjust-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
        }

        function ajustarZoomCrop(value) {
            cropConfig.zoom = parseInt(value);
            if (canvas.backgroundImage) {
                const bgImg = canvas.backgroundImage;
                const baseScale = Math.max(canvas.width / bgImg.width, canvas.height / bgImg.height);
                const newScale = baseScale * (value / 100);
                bgImg.scale(newScale);
                bgImg.set({
                    left: canvas.width / 2,
                    top: canvas.height / 2
                });
                canvas.renderAll();
                saveHistory();
            }
        }

        function abrirRecortador() {
            if (!mediaUrl) {
                alert('Primero sube una imagen o video');
                return;
            }

            const overlay = document.getElementById('cropOverlay');
            const container = document.getElementById('cropContainer');
            overlay.classList.add('active');

            // Inicializar canvas de crop
            cropCanvas = document.getElementById('cropCanvas');
            cropCtx = cropCanvas.getContext('2d');

            const containerRect = container.getBoundingClientRect();
            cropCanvas.width = containerRect.width;
            cropCanvas.height = containerRect.height - 20;

            if (isVideoMedia) {
                // Capturar frame del video
                const video = document.getElementById('videoBackground');
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0);
                cropImage = new Image();
                cropImage.onload = () => dibujarCropPreview();
                cropImage.src = tempCanvas.toDataURL();
            } else {
                cropImage = new Image();
                cropImage.onload = () => dibujarCropPreview();
                cropImage.src = mediaUrl;
            }

            // Inicializar crop box
            initCropBox();
            setupCropEvents();
        }

        function initCropBox() {
            const box = document.getElementById('cropBox');
            const containerRect = document.getElementById('cropContainer').getBoundingClientRect();

            // Calcular tamaño inicial del crop box (80% del container)
            const boxW = containerRect.width * 0.7;
            const boxH = containerRect.height * 0.7;

            cropBox = {
                x: (containerRect.width - boxW) / 2,
                y: (containerRect.height - boxH) / 2,
                w: boxW,
                h: boxH
            };

            actualizarCropBox();
        }

        function actualizarCropBox() {
            const box = document.getElementById('cropBox');
            box.style.left = cropBox.x + 'px';
            box.style.top = cropBox.y + 'px';
            box.style.width = cropBox.w + 'px';
            box.style.height = cropBox.h + 'px';
        }

        function dibujarCropPreview() {
            if (!cropImage || !cropCtx) return;

            const scale = Math.min(
                cropCanvas.width / cropImage.width,
                cropCanvas.height / cropImage.height
            ) * 0.9;

            const drawW = cropImage.width * scale;
            const drawH = cropImage.height * scale;
            const drawX = (cropCanvas.width - drawW) / 2;
            const drawY = (cropCanvas.height - drawH) / 2;

            cropCtx.fillStyle = '#000';
            cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.drawImage(cropImage, drawX, drawY, drawW, drawH);
        }

        function setupCropEvents() {
            const box = document.getElementById('cropBox');
            const handles = box.querySelectorAll('.crop-handle');

            box.addEventListener('mousedown', startDragCrop);
            box.addEventListener('touchstart', startDragCrop);

            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResizeCrop);
                handle.addEventListener('touchstart', startResizeCrop);
            });

            document.addEventListener('mousemove', moveCrop);
            document.addEventListener('touchmove', moveCrop);
            document.addEventListener('mouseup', endCrop);
            document.addEventListener('touchend', endCrop);
        }

        function startDragCrop(e) {
            if (e.target.classList.contains('crop-handle')) return;
            e.preventDefault();
            isDraggingCrop = true;
            const pos = getEventPos(e);
            dragStart = { x: pos.x - cropBox.x, y: pos.y - cropBox.y };
        }

        function startResizeCrop(e) {
            e.preventDefault();
            e.stopPropagation();
            isResizingCrop = true;
            activeHandle = e.target.dataset.handle;
            const pos = getEventPos(e);
            dragStart = { x: pos.x, y: pos.y };
        }

        function moveCrop(e) {
            if (!isDraggingCrop && !isResizingCrop) return;

            const container = document.getElementById('cropContainer');
            const containerRect = container.getBoundingClientRect();
            const pos = getEventPos(e);

            if (isDraggingCrop) {
                cropBox.x = Math.max(0, Math.min(containerRect.width - cropBox.w, pos.x - dragStart.x));
                cropBox.y = Math.max(0, Math.min(containerRect.height - cropBox.h, pos.y - dragStart.y));
            } else if (isResizingCrop) {
                const dx = pos.x - dragStart.x;
                const dy = pos.y - dragStart.y;

                switch (activeHandle) {
                    case 'br':
                        cropBox.w = Math.max(50, cropBox.w + dx);
                        cropBox.h = Math.max(50, cropBox.h + dy);
                        break;
                    case 'bl':
                        cropBox.x += dx;
                        cropBox.w = Math.max(50, cropBox.w - dx);
                        cropBox.h = Math.max(50, cropBox.h + dy);
                        break;
                    case 'tr':
                        cropBox.y += dy;
                        cropBox.w = Math.max(50, cropBox.w + dx);
                        cropBox.h = Math.max(50, cropBox.h - dy);
                        break;
                    case 'tl':
                        cropBox.x += dx;
                        cropBox.y += dy;
                        cropBox.w = Math.max(50, cropBox.w - dx);
                        cropBox.h = Math.max(50, cropBox.h - dy);
                        break;
                }
                dragStart = { x: pos.x, y: pos.y };
            }

            actualizarCropBox();
        }

        function endCrop() {
            isDraggingCrop = false;
            isResizingCrop = false;
            activeHandle = null;
        }

        function getEventPos(e) {
            const container = document.getElementById('cropContainer');
            const rect = container.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        function setCropAspect(aspect, el) {
            cropAspect = aspect;
            document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            // Ajustar cropBox según aspect ratio
            const container = document.getElementById('cropContainer');
            const containerRect = container.getBoundingClientRect();

            if (aspect !== 'free') {
                const [w, h] = aspect.split(':').map(Number);
                const ratio = w / h;
                const maxW = containerRect.width * 0.8;
                const maxH = containerRect.height * 0.8;

                if (maxW / ratio <= maxH) {
                    cropBox.w = maxW;
                    cropBox.h = maxW / ratio;
                } else {
                    cropBox.h = maxH;
                    cropBox.w = maxH * ratio;
                }

                cropBox.x = (containerRect.width - cropBox.w) / 2;
                cropBox.y = (containerRect.height - cropBox.h) / 2;
                actualizarCropBox();
            }
        }

        function cancelarCrop() {
            document.getElementById('cropOverlay').classList.remove('active');
            document.removeEventListener('mousemove', moveCrop);
            document.removeEventListener('touchmove', moveCrop);
            document.removeEventListener('mouseup', endCrop);
            document.removeEventListener('touchend', endCrop);
        }

        function aplicarCrop() {
            if (!cropImage) {
                cancelarCrop();
                return;
            }

            // Calcular las coordenadas de recorte en la imagen original
            const scale = Math.min(
                cropCanvas.width / cropImage.width,
                cropCanvas.height / cropImage.height
            ) * 0.9;

            const drawW = cropImage.width * scale;
            const drawH = cropImage.height * scale;
            const drawX = (cropCanvas.width - drawW) / 2;
            const drawY = (cropCanvas.height - drawH) / 2;

            // Convertir cropBox a coordenadas de la imagen original
            const srcX = (cropBox.x - drawX) / scale;
            const srcY = (cropBox.y - drawY) / scale;
            const srcW = cropBox.w / scale;
            const srcH = cropBox.h / scale;

            // Crear canvas temporal para el recorte
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = srcW;
            tempCanvas.height = srcH;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(cropImage, srcX, srcY, srcW, srcH, 0, 0, srcW, srcH);

            // Actualizar la imagen de fondo del canvas principal
            const croppedUrl = tempCanvas.toDataURL('image/jpeg', 0.9);

            fabric.Image.fromURL(croppedUrl, function(img) {
                const scaleToFit = Math.max(
                    canvas.width / img.width,
                    canvas.height / img.height
                );
                img.scale(scaleToFit);
                img.set({
                    left: canvas.width / 2,
                    top: canvas.height / 2,
                    originX: 'center',
                    originY: 'center',
                    selectable: false,
                    evented: false
                });
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                saveHistory();
            });

            cancelarCrop();
        }

        // ========================================
        // FONDOS / BACKGROUNDS
        // ========================================
        function aplicarFondoColor(color, el) {
            document.querySelectorAll('.bg-color-option, .bg-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');

            backgroundConfig.type = 'color';
            backgroundConfig.value = color;

            // Aplicar al canvas
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            canvas.backgroundColor = color;
            canvas.renderAll();
            saveHistory();

            // Habilitar botón publicar si no hay media
            document.getElementById('uploadOverlay').classList.add('hidden');
            document.getElementById('publishBtn').disabled = false;
        }

        function aplicarFondoGradiente(gradient, el) {
            document.querySelectorAll('.bg-color-option, .bg-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');

            backgroundConfig.type = 'gradient';
            backgroundConfig.value = gradient;

            // Crear gradiente como imagen
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // Parsear el gradiente y dibujarlo
            const gradientMatch = gradient.match(/linear-gradient\((\d+)deg,\s*(.+)\)/);
            if (gradientMatch) {
                const angle = parseInt(gradientMatch[1]);
                const colors = gradientMatch[2].split(',').map(c => c.trim());

                // Calcular puntos del gradiente
                const rad = (angle - 90) * Math.PI / 180;
                const x1 = tempCanvas.width / 2 - Math.cos(rad) * tempCanvas.width;
                const y1 = tempCanvas.height / 2 - Math.sin(rad) * tempCanvas.height;
                const x2 = tempCanvas.width / 2 + Math.cos(rad) * tempCanvas.width;
                const y2 = tempCanvas.height / 2 + Math.sin(rad) * tempCanvas.height;

                const grad = tempCtx.createLinearGradient(x1, y1, x2, y2);

                colors.forEach(colorStop => {
                    const match = colorStop.match(/(#[a-fA-F0-9]{6}|rgba?\([^)]+\))\s*(\d+)?%?/);
                    if (match) {
                        const color = match[1];
                        const stop = match[2] ? parseInt(match[2]) / 100 : colors.indexOf(colorStop) / (colors.length - 1);
                        grad.addColorStop(stop, color);
                    }
                });

                tempCtx.fillStyle = grad;
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            }

            fabric.Image.fromURL(tempCanvas.toDataURL(), function(img) {
                img.set({
                    left: 0,
                    top: 0,
                    originX: 'left',
                    originY: 'top',
                    selectable: false,
                    evented: false
                });
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                saveHistory();
            });

            // Habilitar botón publicar
            document.getElementById('uploadOverlay').classList.add('hidden');
            document.getElementById('publishBtn').disabled = false;
        }

        function aplicarBlurFondo(value) {
            backgroundConfig.blur = parseInt(value);

            const wrapper = document.getElementById('canvasWrapper');
            const bgImage = canvas.backgroundImage;

            if (bgImage && value > 0) {
                // Aplicar blur al background image
                bgImage.filters = [new fabric.Image.filters.Blur({ blur: value / 100 })];
                bgImage.applyFilters();
                canvas.renderAll();
            } else if (bgImage) {
                bgImage.filters = [];
                bgImage.applyFilters();
                canvas.renderAll();
            }
        }

        // ========================================
        // PLANTILLAS / TEMPLATES
        // ========================================
        function renderizarPlantillas(category) {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = '';

            const filteredTemplates = category === 'all'
                ? templates
                : templates.filter(t => t.category === category);

            filteredTemplates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.onclick = () => aplicarPlantilla(template);

                const preview = document.createElement('div');
                preview.className = 'template-preview';
                preview.style.background = template.bg;

                // Agregar textos de preview con tamaños proporcionales
                template.texts.forEach(t => {
                    const span = document.createElement('span');
                    span.textContent = t.text;
                    span.style.fontFamily = t.font;
                    // Escalar el tamaño para que se vea bien en preview (dividir por 2.2)
                    const scaledSize = Math.max(10, Math.round(t.size / 2.2));
                    span.style.fontSize = scaledSize + 'px';
                    span.style.color = t.color;
                    span.style.fontWeight = t.font.includes('Anton') || t.font.includes('Bebas') || t.font.includes('Oswald') ? '400' : '600';
                    if (t.shadow) {
                        // Escalar también el shadow
                        span.style.textShadow = t.shadow.replace(/(\d+)px/g, (match, num) => Math.round(parseInt(num) / 2) + 'px');
                    }
                    preview.appendChild(span);
                });

                const name = document.createElement('div');
                name.className = 'template-name';
                name.textContent = template.name;

                item.appendChild(preview);
                item.appendChild(name);
                grid.appendChild(item);
            });
        }

        function filtrarPlantillas(category, el) {
            document.querySelectorAll('.template-tab').forEach(tab => tab.classList.remove('active'));
            el.classList.add('active');
            renderizarPlantillas(category);
        }

        function aplicarPlantilla(template) {
            // Limpiar canvas
            canvas.clear();

            // Aplicar fondo
            if (template.bg.startsWith('linear-gradient') || template.bg.startsWith('#')) {
                if (template.bg.startsWith('linear-gradient')) {
                    // Crear gradiente como imagen
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');

                    const gradientMatch = template.bg.match(/linear-gradient\((\d+)deg,\s*(.+)\)/);
                    if (gradientMatch) {
                        const angle = parseInt(gradientMatch[1]);
                        const colors = gradientMatch[2].split(',').map(c => c.trim());

                        const rad = (angle - 90) * Math.PI / 180;
                        const x1 = tempCanvas.width / 2 - Math.cos(rad) * tempCanvas.width;
                        const y1 = tempCanvas.height / 2 - Math.sin(rad) * tempCanvas.height;
                        const x2 = tempCanvas.width / 2 + Math.cos(rad) * tempCanvas.width;
                        const y2 = tempCanvas.height / 2 + Math.sin(rad) * tempCanvas.height;

                        const grad = tempCtx.createLinearGradient(x1, y1, x2, y2);

                        colors.forEach((colorStop, idx) => {
                            const match = colorStop.match(/(#[a-fA-F0-9]{6}|rgba?\([^)]+\))\s*(\d+)?%?/);
                            if (match) {
                                const color = match[1];
                                const stop = match[2] ? parseInt(match[2]) / 100 : idx / (colors.length - 1);
                                grad.addColorStop(stop, color);
                            }
                        });

                        tempCtx.fillStyle = grad;
                        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    }

                    fabric.Image.fromURL(tempCanvas.toDataURL(), function(img) {
                        img.set({
                            left: 0,
                            top: 0,
                            originX: 'left',
                            originY: 'top',
                            selectable: false,
                            evented: false
                        });
                        canvas.setBackgroundImage(img, function() {
                            agregarTextosPlantilla(template);
                        });
                    });
                } else {
                    canvas.backgroundColor = template.bg;
                    canvas.renderAll();
                    agregarTextosPlantilla(template);
                }
            }

            // Ocultar overlay y habilitar publicar
            document.getElementById('uploadOverlay').classList.add('hidden');
            document.getElementById('publishBtn').disabled = false;

            // Cerrar panel en móvil
            if (window.innerWidth <= 768) {
                cerrarPanelOpciones();
            }
        }

        function agregarTextosPlantilla(template) {
            template.texts.forEach(t => {
                const textObj = new fabric.IText(t.text, {
                    left: canvas.width / 2,
                    top: (t.y / 100) * canvas.height,
                    originX: 'center',
                    originY: 'center',
                    fontFamily: t.font,
                    fontSize: t.size,
                    fill: t.color,
                    selectable: true,
                    evented: true,
                    hasControls: true,
                    hasBorders: true,
                    cornerColor: '#4682B4',
                    cornerStyle: 'circle',
                    borderColor: '#4682B4',
                    transparentCorners: false,
                    cornerSize: 10
                });

                if (t.shadow) {
                    textObj.set('shadow', new fabric.Shadow({
                        color: t.shadow.split(',')[0].match(/#[a-fA-F0-9]+/)?.[0] || '#000',
                        blur: 20,
                        offsetX: 0,
                        offsetY: 0
                    }));
                }

                canvas.add(textObj);
            });

            canvas.renderAll();
            saveHistory();
        }

        // ========================================
        // BEAT SYNC - Video musical sincronizado (Mejorado)
        // ========================================
        const beatSyncConfig = {
            audioContext: null,
            audioBuffer: null,
            audioFile: null,
            photos: [],
            beats: [],
            isPlaying: false,
            isPaused: false,
            previewAnimationId: null,
            currentPhotoIndex: 0,
            currentTime: 0,
            startTime: 0,
            pausedAt: 0,
            audioSource: null,
            mode: 'auto', // 'auto', 'bass', 'all'
            preloadedImages: [],
            duration: 30,
            trimStart: 0,
            trimEnd: 30
        };

        // Formatear tiempo mm:ss
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Actualizar label de sensibilidad
        function updateSensitivityLabel(value) {
            document.getElementById('beatsyncSensitivityValue').textContent = value;
        }

        // Actualizar label de intervalo mínimo
        function updateMinIntervalLabel(value) {
            document.getElementById('beatsyncMinIntervalValue').textContent = value + 's';
        }

        // Cuando cambia la sensibilidad o intervalo, re-analizar
        function onSensitivityChange() {
            if (beatSyncConfig.audioBuffer) {
                // Auto re-analizar cuando cambia la sensibilidad
                reanalyzeBeatSync();
            }
        }

        // Cuando cambia el trim del audio
        function onTrimChange() {
            if (!beatSyncConfig.audioBuffer) return;

            const totalDuration = beatSyncConfig.audioBuffer.duration;
            const startInput = document.getElementById('beatsyncTrimStart');
            const endInput = document.getElementById('beatsyncTrimEnd');
            const durationEl = document.getElementById('beatsyncTrimDuration');

            let start = parseFloat(startInput.value) || 0;
            let end = parseFloat(endInput.value) || totalDuration;

            // Validaciones
            start = Math.max(0, Math.min(start, totalDuration - 1));
            end = Math.max(start + 1, Math.min(end, totalDuration));

            // Actualizar inputs con valores corregidos
            startInput.value = start.toFixed(1);
            endInput.value = end.toFixed(1);

            // Guardar en config
            beatSyncConfig.trimStart = start;
            beatSyncConfig.trimEnd = end;

            // Actualizar display de duración
            const trimDuration = end - start;
            durationEl.innerHTML = `Duración: <strong>${trimDuration.toFixed(1)}s</strong>`;

            // Re-analizar con los nuevos límites
            reanalyzeBeatSync();

            // Actualizar waveform para mostrar zona de recorte
            drawBeatSyncWaveform();
        }

        // Inicializar trim cuando se carga audio
        function initTrimControls(duration) {
            const startInput = document.getElementById('beatsyncTrimStart');
            const endInput = document.getElementById('beatsyncTrimEnd');
            const durationEl = document.getElementById('beatsyncTrimDuration');

            // Máximo según duración del audio
            endInput.max = duration;
            startInput.max = duration - 1;

            // Valores por defecto: inicio 0, fin mín(30, duración total)
            const defaultEnd = Math.min(30, duration);
            startInput.value = 0;
            endInput.value = defaultEnd.toFixed(1);

            // Guardar en config
            beatSyncConfig.trimStart = 0;
            beatSyncConfig.trimEnd = defaultEnd;

            // Actualizar display
            durationEl.innerHTML = `Duración: <strong>${defaultEnd.toFixed(1)}s</strong>`;
        }

        // Cambiar modo de detección
        function setBeatSyncMode(mode, btn) {
            beatSyncConfig.mode = mode;
            document.querySelectorAll('.beatsync-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (beatSyncConfig.audioBuffer) {
                reanalyzeBeatSync();
            }
        }

        // Re-analizar beats
        async function reanalyzeBeatSync() {
            if (!beatSyncConfig.audioBuffer) return;

            // Detener preview si está corriendo
            if (beatSyncConfig.isPlaying) {
                stopBeatSyncPreview();
            }

            const progressEl = document.getElementById('beatsyncProgress');
            progressEl.classList.add('active');
            updateBeatSyncProgress(30, 'Re-analizando ritmo...');

            await detectBeats();
            drawBeatSyncWaveform();

            updateBeatSyncProgress(100, 'Listo!');
            setTimeout(() => progressEl.classList.remove('active'), 300);
        }

        // Manejar subida de música
        async function handleBeatSyncMusic(event) {
            const file = event.target.files[0];
            if (!file) return;

            beatSyncConfig.audioFile = file;

            // Actualizar UI
            const uploadEl = document.getElementById('beatsyncMusicUpload');
            const nameEl = document.getElementById('beatsyncMusicName');
            const textEl = uploadEl.querySelector('.beatsync-music-text');

            uploadEl.classList.add('has-music');
            textEl.style.display = 'none';
            nameEl.style.display = 'block';
            nameEl.textContent = file.name;

            // Mostrar progress
            const progressEl = document.getElementById('beatsyncProgress');
            progressEl.classList.add('active');
            updateBeatSyncProgress(10, 'Cargando audio...');

            try {
                // Crear AudioContext si no existe
                if (!beatSyncConfig.audioContext) {
                    beatSyncConfig.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Leer archivo
                const arrayBuffer = await file.arrayBuffer();
                updateBeatSyncProgress(30, 'Decodificando audio...');

                // Decodificar audio
                beatSyncConfig.audioBuffer = await beatSyncConfig.audioContext.decodeAudioData(arrayBuffer);
                updateBeatSyncProgress(50, 'Analizando ritmo...');

                // Detectar beats
                await detectBeats();
                updateBeatSyncProgress(100, 'Listo!');

                // Mostrar waveform container
                document.getElementById('beatsyncWaveformContainer').style.display = 'block';

                // Actualizar tiempo total
                const totalTime = beatSyncConfig.audioBuffer.duration;
                document.getElementById('beatsyncTotalTime').textContent = formatTime(totalTime);

                // Inicializar controles de recorte
                initTrimControls(totalTime);

                drawBeatSyncWaveform();

                // Ocultar progress después de un momento
                setTimeout(() => {
                    progressEl.classList.remove('active');
                    checkBeatSyncReady();
                }, 500);

            } catch (error) {
                console.error('Error procesando audio:', error);
                progressEl.classList.remove('active');
                alert('Error al procesar el audio. Intenta con otro archivo.');
            }
        }

        // Detectar beats usando análisis de energía mejorado
        async function detectBeats() {
            const buffer = beatSyncConfig.audioBuffer;
            const sampleRate = buffer.sampleRate;
            const mode = beatSyncConfig.mode;

            // Configuración basada en sensibilidad e intervalo mínimo
            const sensitivity = parseInt(document.getElementById('beatsyncSensitivity').value);
            const minIntervalSlider = parseFloat(document.getElementById('beatsyncMinInterval').value) || 0.3;
            const windowSize = Math.floor(sampleRate * 0.04); // 40ms ventana

            // Usar el intervalo del slider directamente (más control para el usuario)
            const minBeatInterval = minIntervalSlider;

            // Obtener límites de trim
            const trimStart = beatSyncConfig.trimStart || 0;
            const trimEnd = beatSyncConfig.trimEnd || buffer.duration;

            let channelData;

            // Si el modo es 'bass', aplicar filtro de paso bajo
            if (mode === 'bass') {
                channelData = await applyLowPassFilter(buffer, 150); // Solo frecuencias < 150Hz
            } else {
                channelData = buffer.getChannelData(0);
            }

            const beats = [];
            let lastBeatTime = trimStart - minBeatInterval;

            // Calcular energía por ventanas
            const energies = [];
            for (let i = 0; i < channelData.length; i += windowSize) {
                let energy = 0;
                const end = Math.min(i + windowSize, channelData.length);
                for (let j = i; j < end; j++) {
                    energy += channelData[j] * channelData[j];
                }
                energies.push(Math.sqrt(energy / (end - i)));
            }

            // Calcular threshold dinámico basado en la sensibilidad
            const threshold = 1.3 - (sensitivity * 0.08);

            // Encontrar picos de energía (beats) - solo dentro del rango de trim
            const avgEnergy = energies.reduce((a, b) => a + b, 0) / energies.length;

            for (let i = 1; i < energies.length - 1; i++) {
                const time = (i * windowSize) / sampleRate;

                // Solo detectar beats dentro del rango de trim
                if (time < trimStart || time > trimEnd) continue;

                // Para modo 'all', usar threshold más bajo
                const actualThreshold = mode === 'all' ? threshold * 0.7 : threshold;

                // Es un pico local y supera el threshold
                if (energies[i] > energies[i - 1] &&
                    energies[i] > energies[i + 1] &&
                    energies[i] > avgEnergy * actualThreshold &&
                    time - lastBeatTime > minBeatInterval) {

                    beats.push(time);
                    lastBeatTime = time;
                }
            }

            beatSyncConfig.beats = beats;
            document.getElementById('beatsyncBeatsCount').textContent = beats.length;

            return beats;
        }

        // Aplicar filtro de paso bajo para detectar solo bajos
        async function applyLowPassFilter(buffer, cutoffFreq) {
            const offlineCtx = new OfflineAudioContext(1, buffer.length, buffer.sampleRate);
            const source = offlineCtx.createBufferSource();
            source.buffer = buffer;

            const filter = offlineCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = cutoffFreq;
            filter.Q.value = 1;

            source.connect(filter);
            filter.connect(offlineCtx.destination);
            source.start();

            const filteredBuffer = await offlineCtx.startRendering();
            return filteredBuffer.getChannelData(0);
        }

        // Dibujar waveform mejorado
        function drawBeatSyncWaveform() {
            const waveformCanvas = document.getElementById('beatsyncWaveformCanvas');
            if (!waveformCanvas) return;
            const ctx = waveformCanvas.getContext('2d');
            const buffer = beatSyncConfig.audioBuffer;
            if (!buffer) return;

            // Ajustar tamaño del canvas
            const rect = waveformCanvas.parentElement.getBoundingClientRect();
            waveformCanvas.width = rect.width * window.devicePixelRatio;
            waveformCanvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const width = rect.width;
            const height = rect.height;
            const duration = buffer.duration;
            const channelData = buffer.getChannelData(0);
            const step = Math.ceil(channelData.length / width);

            // Obtener límites de trim
            const trimStart = beatSyncConfig.trimStart || 0;
            const trimEnd = beatSyncConfig.trimEnd || duration;

            // Limpiar
            ctx.clearRect(0, 0, width, height);

            // Dibujar zona fuera de trim (oscurecida)
            const trimStartX = (trimStart / duration) * width;
            const trimEndX = (trimEnd / duration) * width;

            // Zona antes del inicio del trim
            if (trimStartX > 0) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, trimStartX, height);
            }

            // Zona después del fin del trim
            if (trimEndX < width) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(trimEndX, 0, width - trimEndX, height);
            }

            // Dibujar waveform
            ctx.beginPath();
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#3b82f6';
            ctx.lineWidth = 1;

            const mid = height / 2;
            for (let i = 0; i < width; i++) {
                let min = 1.0, max = -1.0;
                for (let j = 0; j < step; j++) {
                    const datum = channelData[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                // Color diferente dentro y fuera del trim
                const time = (i / width) * duration;
                if (time >= trimStart && time <= trimEnd) {
                    ctx.strokeStyle = primaryColor;
                } else {
                    ctx.strokeStyle = 'rgba(100, 100, 100, 0.5)';
                }
                ctx.beginPath();
                ctx.moveTo(i, mid + min * mid * 0.8);
                ctx.lineTo(i, mid + max * mid * 0.8);
                ctx.stroke();
            }

            // Dibujar líneas de límite de trim
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);

            // Línea de inicio
            ctx.beginPath();
            ctx.moveTo(trimStartX, 0);
            ctx.lineTo(trimStartX, height);
            ctx.stroke();

            // Línea de fin
            ctx.beginPath();
            ctx.moveTo(trimEndX, 0);
            ctx.lineTo(trimEndX, height);
            ctx.stroke();

            ctx.setLineDash([]);

            // Dibujar marcadores de beats (solo dentro del trim)
            ctx.fillStyle = 'rgba(239, 68, 68, 0.7)';
            beatSyncConfig.beats.forEach(beatTime => {
                if (beatTime >= trimStart && beatTime <= trimEnd) {
                    const x = (beatTime / duration) * width;
                    ctx.fillRect(x - 1, 0, 2, height);
                }
            });
        }

        // Buscar en waveform (click para posicionar)
        function seekBeatSyncWaveform(event) {
            if (!beatSyncConfig.audioBuffer) return;

            const waveform = document.getElementById('beatsyncWaveform');
            const rect = waveform.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percent = clickX / rect.width;

            const totalDuration = beatSyncConfig.audioBuffer.duration;
            const clickedTime = percent * totalDuration;

            // Actualizar el tiempo actual mostrado
            const currentTimeEl = document.getElementById('beatsyncCurrentTime');
            if (currentTimeEl) currentTimeEl.textContent = formatTime(clickedTime);

            // Mover el playhead
            const playhead = document.getElementById('beatsyncPlayhead');
            if (playhead) {
                playhead.style.display = 'block';
                playhead.style.left = `${percent * 100}%`;
            }
        }

        // Manejar subida de fotos
        async function handleBeatSyncPhotos(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            // Filtrar solo imágenes
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            if (!imageFiles.length) return;

            // Leer todas las imágenes en paralelo
            const readPromises = imageFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            src: e.target.result,
                            file: file
                        });
                    };
                    reader.onerror = () => resolve(null);
                    reader.readAsDataURL(file);
                });
            });

            // Esperar a que todas las imágenes se carguen
            const loadedPhotos = await Promise.all(readPromises);

            // Agregar solo las que se cargaron correctamente
            loadedPhotos.forEach(photo => {
                if (photo) {
                    beatSyncConfig.photos.push(photo);
                }
            });

            // Renderizar una sola vez con todas las fotos
            renderBeatSyncPhotos();
            checkBeatSyncReady();

            // Reset input para permitir seleccionar los mismos archivos
            event.target.value = '';
        }

        // Renderizar fotos subidas
        function renderBeatSyncPhotos() {
            const photos = beatSyncConfig.photos;
            const container = document.getElementById('beatsyncPhotosUpload');
            const grid = document.getElementById('beatsyncPhotosGrid');
            const info = document.getElementById('beatsyncPhotosInfo');
            const countLabel = document.getElementById('beatsyncPhotosCountLabel');

            countLabel.textContent = photos.length;

            if (photos.length === 0) {
                container.style.display = 'block';
                grid.style.display = 'none';
                info.style.display = 'none';
                return;
            }

            container.style.display = 'none';
            grid.style.display = 'grid';
            info.style.display = 'block';

            grid.innerHTML = photos.map((photo, idx) => `
                <div class="beatsync-photo-item" draggable="true" data-index="${idx}">
                    <img src="${photo.src}" alt="Foto ${idx + 1}">
                    <span class="photo-number">${idx + 1}</span>
                    <button class="photo-remove" onclick="removeBeatSyncPhoto(${idx})">&times;</button>
                </div>
            `).join('') + `
                <div class="beatsync-add-more" onclick="document.getElementById('beatsyncPhotosInput').click()">+</div>
            `;

            // Setup drag and drop
            setupPhotoDragDrop();
        }

        // Eliminar foto
        function removeBeatSyncPhoto(index) {
            beatSyncConfig.photos.splice(index, 1);
            renderBeatSyncPhotos();
            checkBeatSyncReady();
        }

        // Mezclar fotos aleatoriamente
        function shuffleBeatSyncPhotos() {
            if (beatSyncConfig.photos.length < 2) return;

            // Algoritmo Fisher-Yates para shuffle
            const photos = beatSyncConfig.photos;
            for (let i = photos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [photos[i], photos[j]] = [photos[j], photos[i]];
            }

            renderBeatSyncPhotos();
        }

        // Setup drag and drop para reordenar
        function setupPhotoDragDrop() {
            const grid = document.getElementById('beatsyncPhotosGrid');
            const items = grid.querySelectorAll('.beatsync-photo-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    item.style.opacity = '0.5';
                });

                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.style.transform = 'scale(1.05)';
                });

                item.addEventListener('dragleave', () => {
                    item.style.transform = '';
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.style.transform = '';

                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(item.dataset.index);

                    if (fromIndex !== toIndex) {
                        const photos = beatSyncConfig.photos;
                        const [moved] = photos.splice(fromIndex, 1);
                        photos.splice(toIndex, 0, moved);
                        renderBeatSyncPhotos();
                    }
                });
            });
        }

        // Verificar si está listo para generar
        function checkBeatSyncReady() {
            const hasMusic = beatSyncConfig.audioBuffer !== null;
            const hasPhotos = beatSyncConfig.photos.length >= 2;
            const generateBtn = document.getElementById('beatsyncGenerateBtn');
            const previewBtn = document.getElementById('beatsyncPreviewBtn');

            const isReady = hasMusic && hasPhotos;
            generateBtn.disabled = !isReady;
            previewBtn.disabled = !isReady;
        }

        // Actualizar barra de progreso
        function updateBeatSyncProgress(percent, text) {
            document.getElementById('beatsyncProgressFill').style.width = percent + '%';
            document.getElementById('beatsyncProgressText').textContent = text;
        }

        // Preview del Beat Sync
        async function previewBeatSync() {
            if (!beatSyncConfig.audioBuffer || beatSyncConfig.photos.length < 2) {
                alert('Necesitas subir música y al menos 2 fotos');
                return;
            }

            // Asegurar que AudioContext esté activo (navegadores bloquean autoplay)
            if (beatSyncConfig.audioContext && beatSyncConfig.audioContext.state === 'suspended') {
                await beatSyncConfig.audioContext.resume();
            }

            // Mostrar sección de preview
            document.getElementById('beatsyncPreviewSection').style.display = 'block';

            // Iniciar preview
            startBeatSyncPreview();
        }

        // Iniciar preview animado
        async function startBeatSyncPreview() {
            const previewCanvas = document.getElementById('beatsyncPreviewCanvas');
            if (!previewCanvas) {
                console.error('Canvas de preview no encontrado');
                return;
            }
            const ctx = previewCanvas.getContext('2d');

            // Configurar canvas 9:16
            previewCanvas.width = 360;
            previewCanvas.height = 640;

            const photos = beatSyncConfig.photos;
            const beats = beatSyncConfig.beats;
            const transitionEl = document.getElementById('beatsyncTransition');
            const transition = transitionEl ? transitionEl.value : 'cut';

            // Usar valores de trim
            const trimStart = beatSyncConfig.trimStart || 0;
            const trimEnd = beatSyncConfig.trimEnd || (beatSyncConfig.audioBuffer ? beatSyncConfig.audioBuffer.duration : 30);
            const duration = trimEnd - trimStart;

            console.log('Beat Sync Preview - Duration:', duration, 'Beats:', beats.length, 'Photos:', photos.length);

            // Los beats ya están filtrados al rango de trim, pero los ajustamos relativo al inicio
            let validBeats = beats.map(b => b - trimStart).filter(b => b >= 0 && b <= duration);

            // Si no hay beats detectados, crear beats automáticos
            if (validBeats.length === 0) {
                const interval = Math.max(0.3, duration / Math.max(photos.length, 5));
                for (let t = 0; t < duration; t += interval) {
                    validBeats.push(t);
                }
                console.log('Beats automáticos creados:', validBeats.length);
            }

            // Crear secuencia de fotos para cada beat
            const photoSequence = [];
            let lastPhotoIndex = -1;
            for (let i = 0; i < validBeats.length; i++) {
                if (photos.length === 1) {
                    photoSequence.push(0);
                } else if (i < photos.length) {
                    photoSequence.push(i);
                    lastPhotoIndex = i;
                } else {
                    let randomIndex;
                    let attempts = 0;
                    do {
                        randomIndex = Math.floor(Math.random() * photos.length);
                        attempts++;
                    } while (randomIndex === lastPhotoIndex && photos.length > 1 && attempts < 10);
                    photoSequence.push(randomIndex);
                    lastPhotoIndex = randomIndex;
                }
            }

            console.log('Photo sequence:', photoSequence);

            // Precargar imágenes
            const images = await Promise.all(photos.map((photo, idx) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        console.log('Imagen', idx, 'cargada:', img.width, 'x', img.height);
                        resolve(img);
                    };
                    img.onerror = (e) => {
                        console.error('Error cargando imagen', idx, e);
                        resolve(null);
                    };
                    img.src = photo.src;
                });
            }));

            const validImages = images.filter(img => img !== null);
            if (validImages.length === 0) {
                alert('Error: No se pudieron cargar las imágenes');
                return;
            }

            console.log('Imágenes válidas:', validImages.length);

            // Detener preview anterior si existe
            if (beatSyncConfig.isPlaying) {
                stopBeatSyncPreview();
                await new Promise(r => setTimeout(r, 100));
            }

            // Asegurar AudioContext activo
            if (beatSyncConfig.audioContext.state === 'suspended') {
                await beatSyncConfig.audioContext.resume();
            }

            // Crear source de audio
            const source = beatSyncConfig.audioContext.createBufferSource();
            source.buffer = beatSyncConfig.audioBuffer;
            source.connect(beatSyncConfig.audioContext.destination);

            beatSyncConfig.isPlaying = true;
            beatSyncConfig.audioSource = source;
            beatSyncConfig.currentPhotoIndex = 0;

            const seekOffset = beatSyncConfig.pausedAt || 0;
            const audioStartOffset = trimStart + seekOffset;
            const startTime = beatSyncConfig.audioContext.currentTime;

            console.log('Iniciando audio desde:', audioStartOffset, 'duración:', duration - seekOffset);

            try {
                source.start(0, audioStartOffset, duration - seekOffset);
            } catch (e) {
                console.error('Error iniciando audio:', e);
                beatSyncConfig.isPlaying = false;
                return;
            }

            // Cambiar icono a pause
            const playIcon = document.getElementById('beatsyncPlayIcon');
            if (playIcon) playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';

            // Elementos de UI
            const timelineProgress = document.getElementById('beatsyncTimelineProgress');
            const timeDisplay = document.getElementById('beatsyncTimeDisplay');
            const photoIndicator = document.getElementById('beatsyncPhotoIndicator');
            const beatFlash = document.getElementById('beatsyncBeatFlash');

            // Función de animación
            let lastBeatIndex = -1;

            function animate() {
                if (!beatSyncConfig.isPlaying) return;

                const currentTime = seekOffset + (beatSyncConfig.audioContext.currentTime - startTime);
                beatSyncConfig.currentTime = currentTime;

                if (currentTime >= duration) {
                    stopBeatSyncPreview();
                    return;
                }

                // Actualizar timeline progress
                const progressPercent = (currentTime / duration) * 100;
                if (timelineProgress) timelineProgress.style.width = `${progressPercent}%`;

                // Actualizar tiempo
                if (timeDisplay) timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;

                // Encontrar el beat actual
                let currentBeatIndex = 0;
                for (let i = 0; i < validBeats.length; i++) {
                    if (validBeats[i] <= currentTime) {
                        currentBeatIndex = i;
                    } else {
                        break;
                    }
                }

                // Cambiar imagen en cada beat usando la secuencia pre-calculada
                const photoIndex = photoSequence[currentBeatIndex] || 0;

                if (currentBeatIndex !== lastBeatIndex) {
                    lastBeatIndex = currentBeatIndex;

                    // Usar la imagen correspondiente (validar que exista)
                    const imgToShow = validImages[photoIndex % validImages.length];
                    drawPhotoWithTransition(ctx, imgToShow, previewCanvas.width, previewCanvas.height, transition);

                    // Actualizar indicador de foto
                    if (photoIndicator) photoIndicator.textContent = `${(photoIndex % photos.length) + 1} / ${photos.length}`;

                    // Mostrar flash de beat
                    if (beatFlash && currentBeatIndex > 0) {
                        beatFlash.style.opacity = '1';
                        setTimeout(() => {
                            beatFlash.style.opacity = '0';
                        }, 100);
                    }
                }

                beatSyncConfig.previewAnimationId = requestAnimationFrame(animate);
            }

            // Determinar el índice inicial basado en el tiempo de inicio
            let initialBeatIndex = 0;
            for (let i = 0; i < validBeats.length; i++) {
                if (validBeats[i] <= seekOffset) {
                    initialBeatIndex = i;
                } else {
                    break;
                }
            }
            const initialPhotoIndex = photoSequence[initialBeatIndex] || 0;

            // Dibujar imagen inicial
            const initialImg = validImages[initialPhotoIndex % validImages.length];
            drawPhotoWithTransition(ctx, initialImg, previewCanvas.width, previewCanvas.height, 'cut');

            // Actualizar indicador de foto inicial
            if (photoIndicator) photoIndicator.textContent = `${(initialPhotoIndex % photos.length) + 1} / ${photos.length}`;

            // Iniciar UI
            if (timeDisplay) timeDisplay.textContent = `${formatTime(seekOffset)} / ${formatTime(duration)}`;
            if (timelineProgress) timelineProgress.style.width = `${(seekOffset / duration) * 100}%`;

            animate();

            // Detener cuando termine
            source.onended = () => {
                stopBeatSyncPreview();
            };

            beatSyncConfig.audioSource = source;
            beatSyncConfig.pausedAt = 0; // Reset para la próxima vez
        }

        // Dibujar foto con transición
        function drawPhotoWithTransition(ctx, img, width, height, transition) {
            // Calcular dimensiones para cover
            const imgRatio = img.width / img.height;
            const canvasRatio = width / height;

            let drawWidth, drawHeight, drawX, drawY;

            if (imgRatio > canvasRatio) {
                drawHeight = height;
                drawWidth = height * imgRatio;
                drawX = (width - drawWidth) / 2;
                drawY = 0;
            } else {
                drawWidth = width;
                drawHeight = width / imgRatio;
                drawX = 0;
                drawY = (height - drawHeight) / 2;
            }

            // Aplicar transición
            switch (transition) {
                case 'fade':
                    ctx.globalAlpha = 0;
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);

                    let fadeAlpha = 0;
                    const fadeIn = setInterval(() => {
                        fadeAlpha += 0.1;
                        ctx.globalAlpha = fadeAlpha;
                        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                        if (fadeAlpha >= 1) {
                            clearInterval(fadeIn);
                            ctx.globalAlpha = 1;
                        }
                    }, 20);
                    break;

                case 'flash':
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, width, height);
                    setTimeout(() => {
                        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                    }, 50);
                    break;

                case 'zoom':
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);

                    let scale = 1.2;
                    const zoomIn = setInterval(() => {
                        scale -= 0.02;
                        ctx.clearRect(0, 0, width, height);
                        ctx.fillStyle = '#000';
                        ctx.fillRect(0, 0, width, height);

                        const zoomWidth = drawWidth * scale;
                        const zoomHeight = drawHeight * scale;
                        const zoomX = drawX - (zoomWidth - drawWidth) / 2;
                        const zoomY = drawY - (zoomHeight - drawHeight) / 2;

                        ctx.drawImage(img, zoomX, zoomY, zoomWidth, zoomHeight);

                        if (scale <= 1) {
                            clearInterval(zoomIn);
                        }
                    }, 20);
                    break;

                default:
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            }
        }

        // Toggle preview play/pause
        function toggleBeatSyncPreview() {
            if (beatSyncConfig.isPlaying) {
                stopBeatSyncPreview();
            } else {
                startBeatSyncPreview();
            }
        }

        // Detener preview
        function stopBeatSyncPreview() {
            beatSyncConfig.isPlaying = false;
            beatSyncConfig.isPaused = false;
            beatSyncConfig.currentTime = 0;
            beatSyncConfig.pausedAt = 0;

            if (beatSyncConfig.previewAnimationId) {
                cancelAnimationFrame(beatSyncConfig.previewAnimationId);
                beatSyncConfig.previewAnimationId = null;
            }

            if (beatSyncConfig.audioSource) {
                try {
                    beatSyncConfig.audioSource.stop();
                } catch (e) {}
                beatSyncConfig.audioSource = null;
            }

            // Cambiar icono a play
            const playIcon = document.getElementById('beatsyncPlayIcon');
            if (playIcon) playIcon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';

            // Resetear UI
            const timelineProgress = document.getElementById('beatsyncTimelineProgress');
            if (timelineProgress) timelineProgress.style.width = '0%';

            const timeDisplay = document.getElementById('beatsyncTimeDisplay');
            const duration = beatSyncConfig.audioBuffer ? beatSyncConfig.audioBuffer.duration : 0;
            if (timeDisplay) timeDisplay.textContent = `0:00 / ${formatTime(duration)}`;

            const photoIndicator = document.getElementById('beatsyncPhotoIndicator');
            if (photoIndicator) photoIndicator.textContent = `1 / ${beatSyncConfig.photos.length}`;

            // Ocultar flash
            const beatFlash = document.getElementById('beatsyncBeatFlash');
            if (beatFlash) beatFlash.style.opacity = '0';
        }

        // Buscar en timeline
        function seekBeatSyncTimeline(event) {
            if (!beatSyncConfig.audioBuffer) return;

            const timeline = document.getElementById('beatsyncTimeline');
            const rect = timeline.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percent = clickX / rect.width;

            // Usar valores de trim
            const trimStart = beatSyncConfig.trimStart || 0;
            const trimEnd = beatSyncConfig.trimEnd || beatSyncConfig.audioBuffer.duration;
            const duration = trimEnd - trimStart;
            const seekTime = percent * duration;

            // Si está reproduciendo, reiniciar desde la nueva posición
            if (beatSyncConfig.isPlaying) {
                stopBeatSyncPreview();
                beatSyncConfig.pausedAt = seekTime;
                startBeatSyncPreview();
            } else {
                // Solo actualizar el indicador visual
                const timelineProgress = document.getElementById('beatsyncTimelineProgress');
                if (timelineProgress) timelineProgress.style.width = `${percent * 100}%`;

                const timeDisplay = document.getElementById('beatsyncTimeDisplay');
                if (timeDisplay) timeDisplay.textContent = `${formatTime(seekTime)} / ${formatTime(duration)}`;

                beatSyncConfig.pausedAt = seekTime;
            }
        }

        // Generar video final usando MediaRecorder
        async function generateBeatSync() {
            if (!beatSyncConfig.audioBuffer || beatSyncConfig.photos.length < 2) {
                alert('Necesitas subir música y al menos 2 fotos');
                return;
            }

            const progressEl = document.getElementById('beatsyncProgress');
            progressEl.classList.add('active');
            updateBeatSyncProgress(0, 'Preparando grabación...');

            try {
                const photos = beatSyncConfig.photos;
                const beats = beatSyncConfig.beats;
                const transitionEl = document.getElementById('beatsyncTransition');
                const transition = transitionEl ? transitionEl.value : 'cut';

                // Usar valores de trim
                const trimStart = beatSyncConfig.trimStart || 0;
                const trimEnd = beatSyncConfig.trimEnd || beatSyncConfig.audioBuffer.duration;
                const duration = trimEnd - trimStart;

                // Preparar beats válidos
                let validBeats = beats.map(b => b - trimStart).filter(b => b >= 0 && b <= duration);
                if (validBeats.length === 0) {
                    const interval = Math.max(0.3, duration / Math.max(photos.length, 5));
                    for (let t = 0; t < duration; t += interval) {
                        validBeats.push(t);
                    }
                }

                // Crear secuencia de fotos
                const photoSequence = [];
                let lastPhotoIndex = -1;
                for (let i = 0; i < validBeats.length; i++) {
                    if (photos.length === 1) {
                        photoSequence.push(0);
                    } else if (i < photos.length) {
                        photoSequence.push(i);
                        lastPhotoIndex = i;
                    } else {
                        let randomIndex;
                        let attempts = 0;
                        do {
                            randomIndex = Math.floor(Math.random() * photos.length);
                            attempts++;
                        } while (randomIndex === lastPhotoIndex && photos.length > 1 && attempts < 10);
                        photoSequence.push(randomIndex);
                        lastPhotoIndex = randomIndex;
                    }
                }

                // Crear canvas para grabación (resolución alta)
                const recordCanvas = document.createElement('canvas');
                recordCanvas.width = 720;
                recordCanvas.height = 1280;
                const recordCtx = recordCanvas.getContext('2d');

                // Precargar imágenes
                updateBeatSyncProgress(10, 'Cargando imágenes...');
                const images = await Promise.all(photos.map(photo => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => resolve(img);
                        img.onerror = () => resolve(null);
                        img.src = photo.src;
                    });
                }));

                const validImages = images.filter(img => img !== null);
                if (validImages.length === 0) {
                    throw new Error('No se pudieron cargar las imágenes');
                }

                updateBeatSyncProgress(20, 'Configurando grabación...');

                // Asegurar AudioContext activo
                if (beatSyncConfig.audioContext.state === 'suspended') {
                    await beatSyncConfig.audioContext.resume();
                }

                // Crear MediaRecorder del canvas
                const canvasStream = recordCanvas.captureStream(30); // 30 FPS

                // Crear audio destination para capturar audio
                const audioDestination = beatSyncConfig.audioContext.createMediaStreamDestination();
                const audioSource = beatSyncConfig.audioContext.createBufferSource();
                audioSource.buffer = beatSyncConfig.audioBuffer;
                audioSource.connect(audioDestination);
                audioSource.connect(beatSyncConfig.audioContext.destination); // También reproducir

                // Combinar streams
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioDestination.stream.getAudioTracks()
                ]);

                // Configurar MediaRecorder
                const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
                    ? 'video/webm;codecs=vp9,opus'
                    : 'video/webm';

                const mediaRecorder = new MediaRecorder(combinedStream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 2500000
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                // Promesa para esperar que termine la grabación
                const recordingComplete = new Promise((resolve, reject) => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        resolve(blob);
                    };
                    mediaRecorder.onerror = (e) => reject(e);
                });

                updateBeatSyncProgress(30, 'Grabando video...');

                // Iniciar grabación
                mediaRecorder.start(100);

                // Iniciar audio
                const startTime = beatSyncConfig.audioContext.currentTime;
                audioSource.start(0, trimStart, duration);

                // Dibujar primera imagen
                let lastBeatIndex = -1;
                drawPhotoToCanvas(recordCtx, validImages[photoSequence[0] || 0], recordCanvas.width, recordCanvas.height);

                // Animar durante la duración
                const animationDuration = duration * 1000;
                const animationStart = performance.now();

                function animateRecording() {
                    const elapsed = performance.now() - animationStart;
                    const currentTime = elapsed / 1000;

                    // Actualizar progreso
                    const recordProgress = Math.min(currentTime / duration, 1);
                    updateBeatSyncProgress(30 + Math.floor(recordProgress * 60), `Grabando... ${Math.floor(recordProgress * 100)}%`);

                    if (currentTime >= duration) {
                        // Detener grabación
                        mediaRecorder.stop();
                        try { audioSource.stop(); } catch(e) {}
                        return;
                    }

                    // Encontrar beat actual
                    let currentBeatIndex = 0;
                    for (let i = 0; i < validBeats.length; i++) {
                        if (validBeats[i] <= currentTime) {
                            currentBeatIndex = i;
                        } else {
                            break;
                        }
                    }

                    // Cambiar imagen en cada beat
                    if (currentBeatIndex !== lastBeatIndex) {
                        lastBeatIndex = currentBeatIndex;
                        const photoIndex = photoSequence[currentBeatIndex] || 0;
                        const imgToShow = validImages[photoIndex % validImages.length];

                        // Efecto de transición simple para grabación
                        if (transition === 'flash') {
                            recordCtx.fillStyle = '#fff';
                            recordCtx.fillRect(0, 0, recordCanvas.width, recordCanvas.height);
                            setTimeout(() => {
                                drawPhotoToCanvas(recordCtx, imgToShow, recordCanvas.width, recordCanvas.height);
                            }, 30);
                        } else {
                            drawPhotoToCanvas(recordCtx, imgToShow, recordCanvas.width, recordCanvas.height);
                        }
                    }

                    requestAnimationFrame(animateRecording);
                }

                animateRecording();

                // Esperar a que termine la grabación
                const videoBlob = await recordingComplete;

                updateBeatSyncProgress(95, 'Finalizando...');

                // Crear archivo de video
                mediaFile = new File([videoBlob], 'beatsync_' + Date.now() + '.webm', { type: 'video/webm' });
                mediaType = 'video';

                // Guardar info del Beat Sync
                beatSyncConfig.generated = true;
                beatSyncConfig.videoBlob = videoBlob;

                // Configurar música (ya está incluida en el video)
                selectedMusic = null; // El audio ya está en el video

                // Mostrar primera imagen en el canvas principal de Fabric
                const firstImg = validImages[0];
                const fabricDataUrl = recordCanvas.toDataURL('image/jpeg', 0.9);

                fabric.Image.fromURL(fabricDataUrl, function(img) {
                    const scale = Math.max(
                        canvas.width / img.width,
                        canvas.height / img.height
                    );
                    img.set({
                        scaleX: scale,
                        scaleY: scale,
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        originX: 'center',
                        originY: 'center',
                        selectable: false,
                        evented: false
                    });
                    canvas.clear();
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });

                updateBeatSyncProgress(100, 'Video listo!');

                setTimeout(() => {
                    progressEl.classList.remove('active');

                    const publishBtn = document.getElementById('publishBtn');
                    if (publishBtn) publishBtn.disabled = false;

                    document.getElementById('uploadOverlay').style.display = 'none';

                    alert('Video Beat Sync creado! Duración: ' + duration.toFixed(1) + ' segundos. Puedes agregar textos/stickers y publicar.');

                    if (window.innerWidth <= 768) {
                        cerrarPanelOpciones();
                    }

                    saveHistory();
                }, 500);

            } catch (error) {
                console.error('Error generando Beat Sync:', error);
                progressEl.classList.remove('active');
                alert('Error al generar el video: ' + error.message);
            }
        }

        // Dibujar foto en canvas (cover mode)
        function drawPhotoToCanvas(ctx, img, width, height) {
            const imgRatio = img.width / img.height;
            const canvasRatio = width / height;

            let drawWidth, drawHeight, drawX, drawY;

            if (imgRatio > canvasRatio) {
                drawHeight = height;
                drawWidth = height * imgRatio;
                drawX = (width - drawWidth) / 2;
                drawY = 0;
            } else {
                drawWidth = width;
                drawHeight = width / imgRatio;
                drawX = 0;
                drawY = (height - drawHeight) / 2;
            }

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
        }
    </script>
</body>
</html>
