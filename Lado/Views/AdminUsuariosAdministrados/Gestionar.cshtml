@model Lado.Models.ApplicationUser
@{
    ViewData["Title"] = $"Gestionar - {Model.UserName}";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var config = ViewBag.Config as Lado.Models.ConfiguracionPublicacionAutomatica;
    var tab = ViewBag.Tab as string ?? "biblioteca";
}

<style>
    .admin-page { padding: 20px; max-width: 1200px; margin: 0 auto; }

    /* Header */
    .page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--line); }
    .btn-back { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 8px; background: var(--surface); border: 1px solid var(--line); color: var(--fg); text-decoration: none; transition: all 0.2s; flex-shrink: 0; }
    .btn-back:hover { background: var(--bg-tertiary); border-color: var(--primary); color: var(--primary); }

    .user-header { display: flex; align-items: center; gap: 14px; flex: 1; }
    .user-avatar { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; background: linear-gradient(135deg, var(--primary), #833ab4); cursor: pointer; position: relative; }
    .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .user-avatar-placeholder { width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #833ab4); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #fff; cursor: pointer; }
    .user-info h1 { font-size: 18px; font-weight: 700; color: var(--fg); margin: 0; }
    .user-info .username { color: var(--muted); font-size: 13px; }

    .header-stats { display: flex; gap: 20px; margin-left: auto; }
    .header-stat { text-align: center; }
    .header-stat-value { font-size: 20px; font-weight: 700; color: var(--fg); }
    .header-stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
    .header-stat.pending .header-stat-value { color: #f57c00; }
    .header-stat.scheduled .header-stat-value { color: #1976d2; }
    .header-stat.published .header-stat-value { color: #388e3c; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; background: var(--surface); padding: 4px; border-radius: 10px; margin-bottom: 24px; border: 1px solid var(--line); overflow-x: auto; }
    .tab { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.2s; white-space: nowrap; border: none; background: transparent; display: flex; align-items: center; gap: 8px; }
    .tab:hover { color: var(--fg); background: var(--bg); }
    .tab.active { background: var(--primary); color: #fff; }
    .tab svg { width: 16px; height: 16px; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Cards - con sombra suave */
    .card { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--fg); display: flex; align-items: center; gap: 8px; }
    .card-title svg { color: var(--primary); width: 18px; height: 18px; }

    /* Formularios - con m√°s contraste */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--fg); margin-bottom: 6px; }
    .form-control { width: 100%; padding: 10px 14px; border: 2px solid #d0d7de; border-radius: 8px; background: #fff; color: var(--fg); font-size: 14px; transition: all 0.2s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    .form-control::placeholder { color: #9ca3af; }
    .form-hint { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .form-check { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .form-check input { width: 18px; height: 18px; accent-color: var(--primary); }
    textarea.form-control { min-height: 80px; resize: vertical; }
    select.form-control { cursor: pointer; }

    /* Botones */
    .btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg); color: var(--fg); border: 1px solid var(--line); }
    .btn-secondary:hover { background: var(--bg-tertiary); }
    .btn-danger { background: #d32f2f; color: #fff; }
    .btn-danger:hover { background: #b71c1c; }
    .btn-success { background: #388e3c; color: #fff; }
    .btn-success:hover { background: #2e7d32; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-outline-danger { background: transparent; color: #d32f2f; border: 2px solid #d32f2f; }
    .btn-outline-danger:hover { background: #d32f2f; color: #fff; }
    .btn-outline-primary { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
    .btn-outline-primary:hover { background: var(--primary); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Upload zone */
    .upload-zone { border: 2px dashed var(--line); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(0,149,246,0.03); }
    .upload-zone-icon { margin-bottom: 12px; color: var(--muted); }
    .upload-zone-text { font-size: 14px; color: var(--muted); }
    .upload-zone-text strong { color: var(--primary); }

    /* Filters & Actions */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; }
    .filters { display: flex; gap: 6px; flex-wrap: wrap; }
    .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid var(--line); background: var(--surface); color: var(--fg); font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { border-color: var(--primary); }
    .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .actions { display: flex; gap: 8px; }

    /* Media Grid - Improved Design */
    .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .media-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        background: var(--bg-tertiary);
        border: 2px solid transparent;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .media-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .media-item.selected { border-color: var(--primary); background: rgba(var(--primary-rgb), 0.1); }
    .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
    .media-item-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 22px;
        height: 22px;
        accent-color: var(--primary);
        cursor: pointer;
        z-index: 3;
        border-radius: 4px;
    }

    /* Video indicator */
    .media-item-video-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 44px;
        height: 44px;
        background: rgba(0,0,0,0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
        pointer-events: none;
        transition: all 0.2s;
    }
    .media-item-video-icon svg { width: 20px; height: 20px; fill: #fff; margin-left: 3px; }
    .media-item:hover .media-item-video-icon { opacity: 0; }

    /* Duration badge for videos */
    .media-item-duration {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        font-family: monospace;
        z-index: 2;
    }

    /* Status badges */
    .media-item-badges { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 4px; z-index: 2; }
    .media-item-status { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; backdrop-filter: blur(4px); }
    .status-pendiente { background: rgba(255,152,0,0.9); color: #fff; }
    .status-programado { background: rgba(33,150,243,0.9); color: #fff; }
    .status-publicado { background: rgba(76,175,80,0.9); color: #fff; }
    .status-error { background: rgba(244,67,54,0.9); color: #fff; }

    /* Type badges */
    .media-item-type { padding: 3px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; }
    .type-story { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); color: #fff; }
    .type-video { background: rgba(156,39,176,0.9); color: #fff; }
    .type-image { background: rgba(0,150,136,0.9); color: #fff; }

    /* Hover overlay with actions */
    .media-item-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0.2) 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .media-item:hover .media-item-overlay { opacity: 1; }
    .media-item-btn {
        background: rgba(255,255,255,0.95);
        color: #333;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .media-item-btn:hover { background: #fff; transform: scale(1.05); }
    .media-item-btn.danger { background: #f44336; color: #fff; }
    .media-item-btn.danger:hover { background: #d32f2f; }

    /* Date/schedule info */
    .media-item-date {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 8px 10px;
        background: linear-gradient(transparent, rgba(0,0,0,0.85));
        font-size: 10px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .media-item-date svg { width: 12px; height: 12px; opacity: 0.8; }

    /* File info */
    .media-item-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 6px 10px;
        background: linear-gradient(transparent, rgba(0,0,0,0.85));
        font-size: 10px;
        color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Selection counter */
    .selection-counter {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--primary);
        color: #fff;
        padding: 12px 20px;
        border-radius: 30px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 100;
        display: none;
        align-items: center;
        gap: 12px;
    }
    .selection-counter.visible { display: flex; }
    .selection-counter button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: #fff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .selection-counter button:hover { background: rgba(255,255,255,0.3); }

    /* Biblioteca footer */
    .biblioteca-footer {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 20px;
        background: var(--bg);
        border-radius: 12px;
        margin-top: 8px;
    }
    .biblioteca-stats {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .stat-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--surface);
        border-radius: 20px;
        font-size: 12px;
        color: var(--fg);
        font-weight: 500;
    }
    .stat-pill.video { background: rgba(156,39,176,0.15); color: #9c27b0; }
    .stat-pill.story { background: rgba(131,58,180,0.15); color: #833ab4; }
    .biblioteca-counter {
        font-size: 13px;
        color: var(--muted);
    }
    .biblioteca-counter strong { color: var(--fg); }
    .btn-load-more {
        display: inline-flex;
        align-items: center;
        padding: 10px 20px;
        font-size: 13px;
    }

    /* Programaci√≥n */
    .config-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .config-card { background: #f8fafc; border-radius: 10px; padding: 16px; border: 1px solid #e2e8f0; }
    .config-card-title { font-size: 13px; font-weight: 600; color: var(--fg); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .config-card-title svg { color: var(--primary); }
    .time-range { display: flex; align-items: center; gap: 8px; }
    .time-range input { width: 100px; }

    .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .toggle-desc { font-size: 11px; color: var(--muted); }
    .toggle-input { width: 44px; height: 24px; background: var(--line); border-radius: 12px; position: relative; cursor: pointer; transition: all 0.2s; appearance: none; }
    .toggle-input:checked { background: var(--primary); }
    .toggle-input::before { content: ''; position: absolute; width: 20px; height: 20px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s; }
    .toggle-input:checked::before { left: 22px; }

    /* Preview calendario */
    /* Calendario de programaci√≥n mejorado */
    .prog-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    .prog-stat { background: #f8fafc; border-radius: 10px; padding: 16px; text-align: center; border: 1px solid #e2e8f0; }
    .prog-stat-value { font-size: 28px; font-weight: 700; color: var(--fg); }
    .prog-stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .prog-stat.pendiente .prog-stat-value { color: #f59e0b; }
    .prog-stat.programado .prog-stat-value { color: var(--primary); }
    .prog-stat.publicado .prog-stat-value { color: #10b981; }
    .prog-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 16px; }
    .prog-calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 11px; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
    .prog-cal-dia { aspect-ratio: 1; min-height: 60px; background: #f8fafc; border-radius: 8px; padding: 6px; display: flex; flex-direction: column; position: relative; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
    .prog-cal-dia:hover { border-color: var(--primary); transform: translateY(-2px); }
    .prog-cal-dia.otro-mes { opacity: 0.3; }
    .prog-cal-dia.hoy { border-color: var(--primary); background: rgba(37, 99, 235, 0.1); }
    .prog-cal-dia .dia-num { font-size: 12px; font-weight: 600; color: var(--fg); }
    .prog-cal-dia .dia-count { position: absolute; bottom: 6px; left: 6px; right: 6px; font-size: 10px; background: var(--primary); color: #fff; border-radius: 4px; padding: 2px 4px; text-align: center; }
    .prog-cal-dia .dia-dots { display: flex; gap: 2px; margin-top: 4px; flex-wrap: wrap; }
    .prog-cal-dia .dia-dot { width: 6px; height: 6px; border-radius: 50%; }
    .prog-cal-dia .dia-dot.video { background: #8b5cf6; }
    .prog-cal-dia .dia-dot.imagen { background: #10b981; }
    .prog-timeline { margin-top: 20px; }
    .prog-timeline-day { margin-bottom: 16px; }
    .prog-timeline-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--line); }
    .prog-timeline-date { font-weight: 600; font-size: 14px; }
    .prog-timeline-count { font-size: 12px; color: var(--muted); }
    .prog-timeline-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    .prog-timeline-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; background: var(--bg); }
    .prog-timeline-item img, .prog-timeline-item video { width: 100%; height: 100%; object-fit: cover; }
    .prog-timeline-item .item-time { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; padding: 4px; text-align: center; }
    .prog-timeline-item .item-type { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(0,0,0,0.6); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .prog-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .prog-nav-title { font-size: 16px; font-weight: 600; }

    /* Contenido */
    .contenido-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .contenido-item { background: #f8fafc; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
    .contenido-item-media { aspect-ratio: 1; background: #e5e7eb; position: relative; }
    .contenido-item-media img, .contenido-item-media video { width: 100%; height: 100%; object-fit: cover; }
    .contenido-item-media .video-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .contenido-item-info { padding: 12px; }
    .contenido-item-stats { display: flex; gap: 12px; font-size: 12px; color: var(--muted); }
    .contenido-item-date { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .contenido-item-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
    .contenido-item:hover .contenido-item-actions { opacity: 1; }
    .contenido-action-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; transition: all 0.2s; text-decoration: none; }
    .contenido-action-btn:hover { background: rgba(0,0,0,0.9); transform: scale(1.1); }
    .contenido-action-btn.danger:hover { background: #d32f2f; }

    /* Mensajes */
    .mensajes-layout { display: grid; grid-template-columns: 280px 1fr; gap: 16px; height: 480px; }
    .conversaciones-list { background: #f8fafc; border-radius: 10px; overflow-y: auto; border: 1px solid #e2e8f0; }
    .conversacion-item { display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; border-bottom: 1px solid #e2e8f0; transition: all 0.2s; }
    .conversacion-item:hover { background: #fff; }
    .conversacion-item.active { background: #fff; border-left: 3px solid var(--primary); }
    .conversacion-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: linear-gradient(135deg, var(--primary), #833ab4); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 14px; }
    .conversacion-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .conversacion-info { flex: 1; min-width: 0; }
    .conversacion-name { font-weight: 500; font-size: 13px; color: var(--fg); }
    .conversacion-preview { font-size: 11px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .conversacion-badge { background: var(--primary); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }

    .chat-container { display: flex; flex-direction: column; background: #f8fafc; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
    .chat-header { padding: 12px 16px; border-bottom: 1px solid var(--line); font-weight: 500; font-size: 14px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
    .chat-message { max-width: 70%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.4; }
    .chat-message.enviado { background: var(--primary); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-message.recibido { background: var(--surface); color: var(--fg); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; }
    .chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--line); }
    .chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--line); border-radius: 20px; background: var(--surface); color: var(--fg); font-size: 13px; }
    .chat-input button { background: var(--primary); color: #fff; border: none; padding: 10px 18px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }

    /* Empty states */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--muted); text-align: center; }
    .empty-state-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--muted); }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .modal-content { background: var(--surface); border-radius: 12px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--line); }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); line-height: 1; }
    .modal-body { padding: 20px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 20px; border-top: 1px solid var(--line); }
    .modal-media-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 16px; background: var(--bg); }

    /* Calendario */
    .btn-cal-nav { background: var(--bg); border: 1px solid var(--line); border-radius: 6px; width: 32px; height: 32px; cursor: pointer; color: var(--fg); font-size: 14px; transition: all 0.2s; }
    .btn-cal-nav:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
    .cal-dia { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 13px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; background: var(--bg); }
    .cal-dia:hover { border-color: var(--primary); }
    .cal-dia.otro-mes { color: var(--muted); opacity: 0.4; }
    .cal-dia.hoy { font-weight: 700; color: var(--primary); }
    .cal-dia.seleccionado { background: var(--primary); color: #fff; font-weight: 600; }
    .cal-dia.pasado { opacity: 0.3; cursor: not-allowed; }
    .cal-dia.pasado:hover { border-color: transparent; }
    .radio-pill { display: inline-flex; align-items: center; cursor: pointer; }
    .radio-pill input { display: none; }
    .radio-pill span { padding: 8px 14px; border-radius: 20px; border: 1px solid var(--line); font-size: 13px; transition: all 0.2s; background: var(--bg); }
    .radio-pill input:checked + span { background: var(--primary); color: #fff; border-color: var(--primary); }
    .radio-pill:hover span { border-color: var(--primary); }

    /* Perfil section */
    .perfil-form { max-width: 800px; }
    .perfil-section { background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .perfil-section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; padding-bottom: 10px; border-bottom: 2px solid rgba(37, 99, 235, 0.2); }
    .perfil-section-title svg { width: 18px; height: 18px; }

    /* Foto portada */
    .portada-preview { width: 100%; height: 120px; border-radius: 8px; background: #e5e7eb; margin-bottom: 12px; position: relative; overflow: hidden; cursor: pointer; border: 2px dashed #d0d7de; }
    .portada-preview img { width: 100%; height: 100%; object-fit: cover; }
    .portada-preview:hover { border-color: var(--primary); }
    .portada-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; color: #fff; font-size: 12px; font-weight: 600; }
    .portada-preview:hover .portada-overlay { opacity: 1; }

    /* Estad√≠sticas */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .stat-card { background: #f8fafc; border-radius: 10px; padding: 16px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-card-value { font-size: 24px; font-weight: 700; color: var(--fg); }
    .stat-card-label { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    .stat-card.primary .stat-card-value { color: var(--primary); }
    .stat-card.success .stat-card-value { color: #388e3c; }
    .stat-card.warning .stat-card-value { color: #f57c00; }

    /* Stories grid */
    .stories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .story-item { position: relative; aspect-ratio: 9/16; border-radius: 10px; overflow: hidden; background: #e5e7eb; cursor: pointer; transition: transform 0.2s, opacity 0.2s; border: 1px solid #d0d7de; }
    .story-item:hover { transform: scale(1.02); }
    .story-item.expirada { opacity: 0.7; }
    .story-item.expirada:hover { opacity: 1; }
    .story-item img, .story-item video { width: 100%; height: 100%; object-fit: cover; }
    .story-item-overlay { position: absolute; inset: 0; background: linear-gradient(transparent 60%, rgba(0,0,0,0.8)); display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; }
    .story-item-stats { display: flex; gap: 8px; font-size: 10px; color: #fff; }
    .story-item-badge { position: absolute; top: 6px; left: 6px; font-size: 8px; padding: 2px 6px; border-radius: 3px; font-weight: 700; }
    .story-item-badge.expired { background: #d32f2f; color: #fff; }
    .story-item-badge.active { background: #10b981; color: #fff; }
    .story-video-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 32px; height: 32px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; }

    /* Importar URL modal */
    .import-url-input { display: flex; gap: 8px; }
    .import-url-input input { flex: 1; }

    /* Errores section */
    .error-list { display: flex; flex-direction: column; gap: 8px; }
    .error-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 8px; border-left: 3px solid #d32f2f; }
    .error-item-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: var(--bg-tertiary); }
    .error-item-info { flex: 1; }
    .error-item-name { font-size: 13px; font-weight: 500; color: var(--fg); }
    .error-item-msg { font-size: 11px; color: #d32f2f; margin-top: 2px; }
    .error-item-actions { display: flex; gap: 6px; }

    /* Admin actions */
    .admin-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--line); }
    .admin-actions .btn { font-size: 12px; }

    /* Badge verificado */
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .badge-verified { background: #2196f3; color: #fff; }
    .badge-creator { background: #9c27b0; color: #fff; }

    /* Upload progress */
    .upload-progress { margin-top: 16px; }
    .progress-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 6px; }
    .progress-item-name { flex: 1; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .progress-bar-wrapper { width: 80px; height: 4px; background: var(--line); border-radius: 2px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--primary); transition: width 0.3s; }
    .progress-status { font-size: 11px; color: var(--muted); width: 50px; text-align: right; }

    @@media (max-width: 768px) {
        .header-stats { display: none; }
        .mensajes-layout { grid-template-columns: 1fr; height: auto; }
        .conversaciones-list { max-height: 200px; }
        .chat-container { min-height: 300px; }
        .config-section { grid-template-columns: 1fr; }
    }
</style>

<div class="admin-page">
    <div class="page-header">
        <a href="/Admin/UsuariosAdministrados" class="btn-back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
        </a>
        <div class="user-header">
            @if (!string.IsNullOrEmpty(Model.FotoPerfil))
            {
                <div class="user-avatar" onclick="document.getElementById('fotoInput').click()" title="Cambiar foto">
                    <img src="@Model.FotoPerfil" alt="@Model.UserName">
                </div>
            }
            else
            {
                <div class="user-avatar-placeholder" onclick="document.getElementById('fotoInput').click()" title="Subir foto">
                    @((Model.NombreCompleto ?? Model.UserName ?? "?")[0].ToString().ToUpper())
                </div>
            }
            <input type="file" id="fotoInput" accept="image/*" style="display:none" onchange="subirFotoPerfil(this)">
            <div class="user-info">
                <h1>@(Model.NombreCompleto ?? Model.UserName)</h1>
                <div class="username">@@@Model.UserName</div>
            </div>
        </div>
        <div class="header-stats">
            <div class="header-stat pending">
                <div class="header-stat-value">@ViewBag.Pendientes</div>
                <div class="header-stat-label">Pendientes</div>
            </div>
            <div class="header-stat scheduled">
                <div class="header-stat-value">@ViewBag.Programados</div>
                <div class="header-stat-label">Programados</div>
            </div>
            <div class="header-stat published">
                <div class="header-stat-value">@ViewBag.ContenidoCount</div>
                <div class="header-stat-label">Publicados</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab @(tab == "biblioteca" ? "active" : "")" onclick="cambiarTab('biblioteca')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            Biblioteca
        </button>
        <button class="tab @(tab == "programacion" ? "active" : "")" onclick="cambiarTab('programacion')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Programaci√≥n
        </button>
        <button class="tab @(tab == "contenido" ? "active" : "")" onclick="cambiarTab('contenido')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Contenido
        </button>
        <button class="tab @(tab == "mensajes" ? "active" : "")" onclick="cambiarTab('mensajes')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Mensajes
        </button>
        <button class="tab @(tab == "perfil" ? "active" : "")" onclick="cambiarTab('perfil')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Perfil
        </button>
        <button class="tab @(tab == "estadisticas" ? "active" : "")" onclick="cambiarTab('estadisticas')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            Estad√≠sticas
        </button>
        <button class="tab @(tab == "errores" ? "active" : "")" onclick="cambiarTab('errores')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            Errores
        </button>
    </div>

    <!-- TAB: BIBLIOTECA -->
    <div id="tab-biblioteca" class="tab-content @(tab == "biblioteca" ? "active" : "")">
        <!-- Selector de tipo de publicaci√≥n al subir -->
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg, #f0f9ff, #f0fdf4);border-radius:10px;border:1px solid #d1fae5">
            <label style="font-size:13px;font-weight:600;color:#374151">Subir como:</label>
            <label class="tipo-subida-option" style="display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s" id="labelTipoPost">
                <input type="radio" name="tipoSubida" value="0" checked id="tipoSubidaPost" onchange="actualizarTipoSubidaUI()">
                <span style="font-size:20px">üì∑</span>
                <div>
                    <div style="font-size:13px;font-weight:600">Post (Feed)</div>
                    <div style="font-size:10px;color:#6b7280">Publicaci√≥n permanente</div>
                </div>
            </label>
            <label class="tipo-subida-option" style="display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s" id="labelTipoStory">
                <input type="radio" name="tipoSubida" value="1" id="tipoSubidaStory" onchange="actualizarTipoSubidaUI()">
                <span style="font-size:20px">‚≠ï</span>
                <div>
                    <div style="font-size:13px;font-weight:600">Story (24h)</div>
                    <div style="font-size:10px;color:#6b7280">Desaparece en 24 horas</div>
                </div>
            </label>
        </div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-zone-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <div class="upload-zone-text">
                <strong>Arrastra archivos aqu√≠</strong> o haz clic para seleccionar<br>
                <small style="color:var(--muted)">Im√°genes y videos (m√°x. 500MB por archivo)</small>
            </div>
        </div>
        <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display:none" onchange="subirArchivos(this.files)">
        <div class="upload-progress" id="uploadProgress"></div>

        <div class="toolbar">
            <div class="filters">
                <button class="filter-btn active" data-estado="" data-tipo="">Todos</button>
                <button class="filter-btn" data-estado="0" data-tipo="">Pendientes</button>
                <button class="filter-btn" data-estado="1" data-tipo="">Programados</button>
                <button class="filter-btn" data-estado="2" data-tipo="">Publicados</button>
                <span style="border-left:1px solid var(--line);margin:0 8px"></span>
                <button class="filter-btn" data-estado="" data-tipo="1">Videos</button>
                <button class="filter-btn" data-estado="" data-tipo="0">Im√°genes</button>
            </div>
            <div class="actions">
                <button class="btn btn-sm btn-secondary" onclick="mostrarModalImportarUrl()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Importar URL
                </button>
                <button class="btn btn-sm btn-secondary" onclick="seleccionarTodos()">Seleccionar todos</button>
                <button class="btn btn-sm btn-secondary" onclick="mostrarModalAccionesLote()" id="btnAccionesLote" disabled>Acciones</button>
                <button class="btn btn-sm btn-danger" onclick="eliminarSeleccionados()" id="btnEliminar" disabled>Eliminar</button>
                <button class="btn btn-sm btn-success" onclick="publicarSeleccionados()" id="btnPublicar" disabled>Publicar</button>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarTodaBiblioteca()" title="Eliminar TODOS los archivos de la biblioteca">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    Vaciar TODO
                </button>
            </div>
        </div>

        <div class="media-grid" id="mediaGrid">
            <div class="loading">Cargando biblioteca...</div>
        </div>
    </div>

    <!-- TAB: PROGRAMACI√ìN -->
    <div id="tab-programacion" class="tab-content @(tab == "programacion" ? "active" : "")">
        <div class="card">
            <div class="toggle-switch">
                <div>
                    <div class="toggle-label">Publicaci√≥n autom√°tica</div>
                    <div class="toggle-desc">El sistema publicar√° contenido autom√°ticamente seg√∫n la configuraci√≥n</div>
                </div>
                <input type="checkbox" class="toggle-input" id="configActivo" @(config?.Activo == true ? "checked" : "")>
            </div>

            <form id="formConfig">
                <div class="config-section">
                    <div class="config-card">
                        <div class="config-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            Posts (Feed) por d√≠a
                        </div>
                        <div class="form-row" style="gap:10px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">M√≠nimo</label>
                                <input type="number" name="publicacionesMinPorDia" class="form-control" value="@(config?.PublicacionesMinPorDia ?? 1)" min="0" max="20">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">M√°ximo</label>
                                <input type="number" name="publicacionesMaxPorDia" class="form-control" value="@(config?.PublicacionesMaxPorDia ?? 3)" min="0" max="20">
                            </div>
                        </div>
                        <div class="form-hint">Publicaciones normales que aparecen en el feed del perfil</div>
                    </div>

                    <div class="config-card">
                        <div class="config-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                            Stories por d√≠a
                        </div>
                        <div class="form-row" style="gap:10px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">M√≠nimo</label>
                                <input type="number" name="storiesMinPorDia" class="form-control" value="@(config?.StoriesMinPorDia ?? 0)" min="0" max="20">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">M√°ximo</label>
                                <input type="number" name="storiesMaxPorDia" class="form-control" value="@(config?.StoriesMaxPorDia ?? 2)" min="0" max="20">
                            </div>
                        </div>
                        <div class="form-hint">Historias temporales (24 horas) - se publican <strong>independiente</strong> de los posts</div>
                    </div>

                    <div class="config-card">
                        <div class="config-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Horario de publicaci√≥n
                        </div>
                        <div class="time-range">
                            <input type="time" name="horaInicio" class="form-control" value="@(config?.HoraInicio.ToString(@"hh\:mm") ?? "09:00")">
                            <span style="color:var(--muted)">a</span>
                            <input type="time" name="horaFin" class="form-control" value="@(config?.HoraFin.ToString(@"hh\:mm") ?? "22:00")">
                        </div>
                        <div class="form-hint" style="margin-top:8px">Las publicaciones se har√°n dentro de este rango horario</div>
                    </div>

                    <div class="config-card">
                        <div class="config-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                            Variaci√≥n aleatoria
                        </div>
                        <div class="form-group" style="margin:0">
                            <input type="number" name="variacionMinutos" class="form-control" value="@(config?.VariacionMinutos ?? 30)" min="0" max="120">
                        </div>
                        <div class="form-hint">¬±X minutos de variaci√≥n para simular comportamiento natural</div>
                    </div>

                    <div class="config-card">
                        <div class="config-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                            Opciones de publicaci√≥n
                        </div>
                        <div style="display:flex;flex-direction:column;gap:14px">
                            <div>
                                <label class="form-check">
                                    <input type="checkbox" name="publicarFinesDeSemana" @(config?.PublicarFinesDeSemana != false ? "checked" : "")>
                                    <span style="font-size:13px;font-weight:500">Publicar fines de semana</span>
                                </label>
                                <div class="form-hint" style="margin-left:28px">Si est√° desactivado, solo se programar√° contenido de lunes a viernes</div>
                            </div>
                            <div>
                                <label class="form-check">
                                    <input type="checkbox" name="soloSuscriptoresDefault" @(config?.SoloSuscriptoresDefault == true ? "checked" : "")>
                                    <span style="font-size:13px;font-weight:500">Solo suscriptores por defecto</span>
                                </label>
                                <div class="form-hint" style="margin-left:28px">El contenido ser√° visible solo para suscriptores de pago (no p√∫blico)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
                    <button type="submit" class="btn btn-primary">Guardar configuraci√≥n</button>
                </div>
            </form>
        </div>

        <!-- Info de c√≥mo funciona -->
        <div class="card" style="background:linear-gradient(135deg, rgba(37,99,235,0.1), rgba(139,92,246,0.1));border:1px solid rgba(37,99,235,0.2)">
            <div style="display:flex;align-items:flex-start;gap:16px">
                <div style="background:var(--primary);color:#fff;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                </div>
                <div style="flex:1">
                    <div style="font-weight:600;margin-bottom:8px">¬øC√≥mo funciona la programaci√≥n?</div>
                    <div style="font-size:13px;color:var(--muted);line-height:1.8">
                        <strong>1.</strong> Sube archivos en <a href="javascript:cambiarTab('biblioteca')" style="color:var(--primary);text-decoration:underline">Biblioteca</a> eligiendo <strong>üì∑ Post</strong> o <strong>‚≠ï Story</strong><br>
                        <strong>2.</strong> Los archivos quedan como <span style="color:#f59e0b;font-weight:600">Pendientes</span> con su tipo asignado<br>
                        <strong>3.</strong> Se publican autom√°ticamente seg√∫n la configuraci√≥n (horario, d√≠as, etc.)<br>
                        <strong>4.</strong> Tambi√©n puedes seleccionar archivos y usar "Programar" para elegir fecha manual
                    </div>
                    <div style="margin-top:12px;padding:10px;background:rgba(245,158,11,0.1);border-radius:6px;font-size:12px">
                        <strong style="color:#f59e0b">üí° Tip:</strong> Cada archivo recuerda si es Post o Story. Puedes cambiar el tipo editando el archivo o usando "Acciones en lote".
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <!-- Acciones r√°pidas -->
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--line)">
                <button type="button" class="btn btn-secondary" onclick="programarContenido()" id="btnProgramarPendientes">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Programar pendientes (<span id="pendientesCount">0</span>)
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="desprogramarTodo()" id="btnDesprogramar">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    Desprogramar todo (<span id="programadosCount">0</span>)
                </button>
                <a href="javascript:cambiarTab('biblioteca')" class="btn btn-outline-primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    Ir a Biblioteca
                </a>
            </div>

            <!-- Estad√≠sticas r√°pidas por tipo -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                <!-- Feed Stats -->
                <div style="background:#f8fafc;border-radius:10px;padding:16px;border:1px solid #e2e8f0">
                    <div style="font-weight:600;font-size:13px;margin-bottom:12px;display:flex;align-items:center;gap:6px">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Feed (Posts)
                    </div>
                    <div style="display:flex;gap:12px;text-align:center">
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:#f59e0b" id="statFeedPendientes">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Pendientes</div>
                        </div>
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:var(--primary)" id="statFeedProgramados">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Programados</div>
                        </div>
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:#10b981" id="statFeedPublicados">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Publicados</div>
                        </div>
                    </div>
                </div>
                <!-- Stories Stats -->
                <div style="background:#f8fafc;border-radius:10px;padding:16px;border:1px solid #e2e8f0">
                    <div style="font-weight:600;font-size:13px;margin-bottom:12px;display:flex;align-items:center;gap:6px">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                        Stories
                    </div>
                    <div style="display:flex;gap:12px;text-align:center">
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:#f59e0b" id="statStoriesPendientes">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Pendientes</div>
                        </div>
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:var(--primary)" id="statStoriesProgramados">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Programados</div>
                        </div>
                        <div style="flex:1;padding:8px;background:#fff;border-radius:6px">
                            <div style="font-size:22px;font-weight:700;color:#10b981" id="statStoriesPublicados">-</div>
                            <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Publicados</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas totales -->
            <div class="prog-stats" id="progStats">
                <div class="prog-stat pendiente">
                    <div class="prog-stat-value" id="statPendientes">-</div>
                    <div class="prog-stat-label">Total Pendientes</div>
                </div>
                <div class="prog-stat programado">
                    <div class="prog-stat-value" id="statProgramados">-</div>
                    <div class="prog-stat-label">Total Programados</div>
                </div>
                <div class="prog-stat publicado">
                    <div class="prog-stat-value" id="statPublicados">-</div>
                    <div class="prog-stat-label">Total Publicados</div>
                </div>
                <div class="prog-stat">
                    <div class="prog-stat-value" id="statProxDias">-</div>
                    <div class="prog-stat-label">Pr√≥x. 7 d√≠as</div>
                </div>
            </div>

            <!-- Navegaci√≥n del calendario -->
            <div class="prog-nav">
                <button type="button" class="btn-cal-nav" onclick="cambiarMesProgCalendario(-1)">&larr;</button>
                <span class="prog-nav-title" id="progCalMesAnio"></span>
                <button type="button" class="btn-cal-nav" onclick="cambiarMesProgCalendario(1)">&rarr;</button>
            </div>

            <!-- D√≠as de la semana -->
            <div class="prog-calendar-header">
                <span>Lun</span><span>Mar</span><span>Mi√©</span><span>Jue</span><span>Vie</span><span>S√°b</span><span>Dom</span>
            </div>

            <!-- Grid del calendario -->
            <div class="prog-calendar" id="progCalendarGrid"></div>

            <!-- Leyenda -->
            <div style="display:flex;gap:16px;margin-top:16px;font-size:11px;color:var(--muted)">
                <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#8b5cf6;margin-right:4px"></span>Video</span>
                <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#10b981;margin-right:4px"></span>Imagen</span>
            </div>
        </div>

        <!-- Timeline de pr√≥ximas publicaciones -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Pr√≥ximas publicaciones
                </div>
            </div>
            <div id="progTimeline" class="prog-timeline">
                <div class="loading">Cargando...</div>
            </div>
        </div>
    </div>

    <!-- TAB: CONTENIDO -->
    <div id="tab-contenido" class="tab-content @(tab == "contenido" ? "active" : "")">
        <!-- Stories publicadas -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                    Stories publicadas
                </div>
                <span id="storiesCount" style="font-size:12px;color:var(--muted)"></span>
            </div>
            <div class="stories-grid" id="storiesGrid">
                <div class="loading">Cargando stories...</div>
            </div>
        </div>

        <!-- Contenido del feed -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Contenido del feed
                </div>
                <span id="contenidoCount" style="font-size:12px;color:var(--muted)"></span>
            </div>
            <div class="contenido-grid" id="contenidoGrid">
                <div class="loading">Cargando contenido...</div>
            </div>
        </div>
    </div>

    <!-- TAB: MENSAJES -->
    <div id="tab-mensajes" class="tab-content @(tab == "mensajes" ? "active" : "")">
        <!-- Plantillas de respuesta r√°pida -->
        <div class="card" style="margin-bottom:16px">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    Respuestas r√°pidas
                </div>
                <button class="btn btn-sm btn-secondary" onclick="agregarPlantillaMensaje()">+ Agregar</button>
            </div>
            <div id="plantillasMensaje" style="display:flex;flex-wrap:wrap;gap:6px"></div>
        </div>

        <div class="mensajes-layout">
            <div class="conversaciones-list" id="conversacionesList">
                <div class="loading">Cargando...</div>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <div>Selecciona una conversaci√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: PERFIL -->
    <div id="tab-perfil" class="tab-content @(tab == "perfil" ? "active" : "")">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Informaci√≥n del perfil
                </div>
                <a href="/@Model.UserName" target="_blank" class="btn btn-sm btn-secondary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    Ver perfil
                </a>
            </div>
            <form id="formPerfil" class="perfil-form">
                <!-- Im√°genes de perfil -->
                <div class="perfil-section">
                    <div class="perfil-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Im√°genes
                    </div>
                    <!-- Foto de portada -->
                    <label class="form-label">Foto de portada</label>
                    <div class="portada-preview" onclick="document.getElementById('portadaInput').click()">
                        @if (!string.IsNullOrEmpty(Model.FotoPortada))
                        {
                            <img src="@Model.FotoPortada" id="portadaImg">
                        }
                        else
                        {
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">Sin portada</div>
                        }
                        <div class="portada-overlay">Cambiar portada</div>
                    </div>
                    <input type="file" id="portadaInput" accept="image/*" style="display:none" onchange="subirFotoPortada(this)">

                    <!-- Foto perfil Lado B -->
                    <div class="form-row" style="margin-top:12px">
                        <div>
                            <label class="form-label">Foto perfil Lado B</label>
                            <div style="display:flex;align-items:center;gap:12px">
                                <div class="user-avatar" onclick="document.getElementById('fotoLadoBInput').click()" style="width:60px;height:60px">
                                    @if (!string.IsNullOrEmpty(Model.FotoPerfilLadoB))
                                    {
                                        <img src="@Model.FotoPerfilLadoB" id="fotoLadoBImg">
                                    }
                                    else
                                    {
                                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff">B</div>
                                    }
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('fotoLadoBInput').click()">Cambiar</button>
                            </div>
                            <input type="file" id="fotoLadoBInput" accept="image/*" style="display:none" onchange="subirFotoPerfilLadoB(this)">
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n b√°sica -->
                <div class="perfil-section">
                    <div class="perfil-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Informaci√≥n b√°sica
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre completo</label>
                            <input type="text" name="nombreCompleto" class="form-control" value="@Model.NombreCompleto">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seud√≥nimo</label>
                            <input type="text" name="seudonimo" class="form-control" value="@Model.Seudonimo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Biograf√≠a (Lado A)</label>
                        <textarea name="biografia" class="form-control" rows="2">@Model.Biografia</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Categor√≠a</label>
                            <select name="categoria" class="form-control" id="selectCategoria">
                                <option value="">Sin categor√≠a</option>
                                <option value="modelo">Modelo</option>
                                <option value="influencer">Influencer</option>
                                <option value="artista">Artista</option>
                                <option value="fitness">Fitness</option>
                                <option value="musico">M√∫sico</option>
                                <option value="cosplayer">Cosplayer</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicaci√≥n</label>
                            <div class="form-row" style="gap:8px">
                                <input type="text" name="pais" class="form-control" placeholder="Pa√≠s" value="@Model.Pais" style="flex:1">
                                <input type="text" name="ciudad" class="form-control" placeholder="Ciudad" value="@Model.Ciudad" style="flex:1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lado B -->
                <div class="perfil-section">
                    <div class="perfil-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        Configuraci√≥n Lado B
                    </div>
                    <div class="form-group">
                        <label class="form-label">Biograf√≠a Lado B</label>
                        <textarea name="biografiaLadoB" class="form-control" rows="2" placeholder="Descripci√≥n para el perfil privado">@Model.BiografiaLadoB</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Precio suscripci√≥n Lado A ($)</label>
                            <input type="number" name="precioSuscripcion" class="form-control" value="@Model.PrecioSuscripcion.ToString(System.Globalization.CultureInfo.InvariantCulture)" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio suscripci√≥n Lado B ($)</label>
                            <input type="number" name="precioSuscripcionLadoB" class="form-control" value="@(Model.PrecioSuscripcionLadoB?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "0")" step="0.01" min="0">
                        </div>
                    </div>
                </div>

                <!-- Estado y verificaci√≥n -->
                <div class="perfil-section">
                    <div class="perfil-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Estado y verificaci√≥n
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:20px">
                        <label class="form-check">
                            <input type="checkbox" name="esCreador" @(Model.EsCreador ? "checked" : "")>
                            <span style="font-size:13px">Es Creador</span>
                        </label>
                        <label class="form-check">
                            <input type="checkbox" name="estaActivo" @(Model.EstaActivo ? "checked" : "")>
                            <span style="font-size:13px">Cuenta Activa</span>
                        </label>
                        <label class="form-check">
                            <input type="checkbox" name="esVerificado" @(Model.EsVerificado ? "checked" : "")>
                            <span style="font-size:13px">Verificado (badge)</span>
                        </label>
                        <label class="form-check">
                            <input type="checkbox" name="creadorVerificado" @(Model.CreadorVerificado ? "checked" : "")>
                            <span style="font-size:13px">Creador Verificado</span>
                        </label>
                    </div>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>

                <!-- Acciones administrativas -->
                <div class="admin-actions">
                    <button type="button" class="btn btn-secondary" onclick="ajustarSeguidores()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Ajustar seguidores
                    </button>
                    <button type="button" class="btn btn-danger" onclick="quitarMarcaAdministrado()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        Quitar marca administrado
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- TAB: ESTAD√çSTICAS -->
    <div id="tab-estadisticas" class="tab-content @(tab == "estadisticas" ? "active" : "")">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Estad√≠sticas del usuario
                </div>
                <button class="btn btn-sm btn-secondary" onclick="cargarEstadisticas()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    Actualizar
                </button>
            </div>
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Cargando estad√≠sticas...</div>
            </div>
        </div>
    </div>

    <!-- TAB: ERRORES -->
    <div id="tab-errores" class="tab-content @(tab == "errores" ? "active" : "")">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Medios con errores de publicaci√≥n
                </div>
            </div>
            <div class="error-list" id="errorList">
                <div class="loading">Cargando...</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal editar media -->
<div id="modalEditarMedia" class="modal-overlay" style="display:none">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Editar medio</div>
            <button class="modal-close" onclick="cerrarModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="modalMediaPreview" class="modal-media-preview" style="display:none">
            <video id="modalVideoPreview" class="modal-media-preview" style="display:none" controls></video>
            <form id="formEditarMedia">
                <input type="hidden" name="id" id="editMediaId">
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="descripcion" id="editDescripcion" class="form-control" rows="2" placeholder="Texto que acompa√±ar√° la publicaci√≥n"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Hashtags</label>
                    <input type="text" name="hashtags" id="editHashtags" class="form-control" placeholder="#lado #contenido">
                    <div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap" id="hashtagTemplates"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Publicar como</label>
                        <select name="tipoPublicacion" id="editTipoPublicacion" class="form-control">
                            <option value="0">Publicaci√≥n (Feed)</option>
                            <option value="1">Story (24h)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de lado</label>
                        <select name="tipoLado" id="editTipoLado" class="form-control">
                            <option value="0">Lado A (p√∫blico)</option>
                            <option value="1">Lado B (privado)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Orden</label>
                        <input type="number" name="orden" id="editOrden" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <label class="form-check" style="margin:0">
                            <input type="checkbox" name="soloSuscriptores" id="editSoloSuscriptores">
                            <span style="font-size:13px">Solo suscriptores</span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="guardarMedia()">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal importar desde URL -->
<div id="modalImportarUrl" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:420px">
        <div class="modal-header">
            <div class="modal-title">Importar desde URL</div>
            <button class="modal-close" onclick="cerrarModalImportarUrl()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">URL de la imagen o video</label>
                <input type="url" id="importUrl" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                <div class="form-hint">Soporta im√°genes y videos directos</div>
            </div>
            <div class="form-group">
                <label class="form-label">Publicar como</label>
                <select id="importTipoPublicacion" class="form-control">
                    <option value="0">Publicaci√≥n (Feed)</option>
                    <option value="1">Story (24h)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModalImportarUrl()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="importarDesdeUrl()">Importar</button>
        </div>
    </div>
</div>

<!-- Modal acciones en lote -->
<div id="modalAccionesLote" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">Acciones en lote</div>
            <button class="modal-close" onclick="cerrarModalAccionesLote()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Seleccionados: <strong id="loteCantidad">0</strong> elementos</p>
            <div class="form-group">
                <label class="form-label">Cambiar tipo de publicaci√≥n</label>
                <select id="loteTipoPublicacion" class="form-control">
                    <option value="0">Publicaci√≥n (Feed)</option>
                    <option value="1">Story (24h)</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="cambiarTipoPublicacionLote()">Aplicar tipo</button>
            <hr style="margin:16px 0;border:0;border-top:1px solid var(--line)">
            <button class="btn btn-secondary" style="width:100%;margin-bottom:8px" onclick="duplicarSeleccionados()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Duplicar seleccionados
            </button>
        </div>
    </div>
</div>

<!-- Modal ajustar seguidores -->
<div id="modalAjustarSeguidores" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:360px">
        <div class="modal-header">
            <div class="modal-title">Ajustar seguidores</div>
            <button class="modal-close" onclick="cerrarModalSeguidores()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Seguidores actuales: <strong id="seguidoresActuales">@Model.NumeroSeguidores</strong></p>
            <div class="form-group">
                <label class="form-label">Nueva cantidad</label>
                <input type="number" id="nuevosSeguidores" class="form-control" value="@Model.NumeroSeguidores" min="0">
            </div>
            <div class="form-hint" style="margin-bottom:16px">Esta acci√≥n modifica el contador de seguidores del usuario</div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModalSeguidores()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="guardarSeguidores()">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal Programar con Calendario -->
<div id="modalProgramar" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:520px">
        <div class="modal-header">
            <div class="modal-title">Programar publicaciones</div>
            <button class="modal-close" onclick="cerrarModalProgramar()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px">
            <div class="programar-info" style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:20px;font-size:13px">
                <span id="programarCantidad">0</span> elementos seleccionados
            </div>

            <!-- Calendario -->
            <div class="calendario-container" style="margin-bottom:20px">
                <div class="calendario-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <button type="button" class="btn-cal-nav" onclick="cambiarMesCalendario(-1)">&larr;</button>
                    <span id="calendarioMesAnio" style="font-weight:600;font-size:14px"></span>
                    <button type="button" class="btn-cal-nav" onclick="cambiarMesCalendario(1)">&rarr;</button>
                </div>
                <div class="calendario-dias-semana" style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:11px;color:var(--muted);margin-bottom:8px">
                    <span>Lun</span><span>Mar</span><span>Mi√©</span><span>Jue</span><span>Vie</span><span>S√°b</span><span>Dom</span>
                </div>
                <div id="calendarioGrid" class="calendario-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px"></div>
            </div>

            <!-- Hora de inicio -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                <div class="form-group" style="margin:0">
                    <label class="form-label">Hora inicio</label>
                    <select id="programarHora" class="form-control">
                        @for(int h = 0; h < 24; h++) {
                            if (h == 9) {
                                <option value="@h" selected>@h.ToString("00"):00</option>
                            } else {
                                <option value="@h">@h.ToString("00"):00</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-group" style="margin:0">
                    <label class="form-label">Hora fin</label>
                    <select id="programarHoraFin" class="form-control">
                        @for(int h = 0; h < 24; h++) {
                            if (h == 22) {
                                <option value="@h" selected>@h.ToString("00"):00</option>
                            } else {
                                <option value="@h">@h.ToString("00"):00</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <!-- Distribuci√≥n -->
            <div class="form-group" style="margin-bottom:20px">
                <label class="form-label">Distribuci√≥n</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <label class="radio-pill">
                        <input type="radio" name="distribucion" value="mismo-dia" checked onchange="actualizarPreviewProgramacion()">
                        <span>Todo el mismo d√≠a</span>
                    </label>
                    <label class="radio-pill">
                        <input type="radio" name="distribucion" value="varios-dias" onchange="actualizarPreviewProgramacion()">
                        <span>Distribuir en d√≠as</span>
                    </label>
                </div>
            </div>

            <!-- Opciones de distribuci√≥n en d√≠as -->
            <div id="opcionesVariosDias" style="display:none;margin-bottom:20px;padding:16px;background:var(--bg);border-radius:8px">
                <div class="form-group" style="margin-bottom:12px">
                    <label class="form-label">Publicaciones por d√≠a</label>
                    <input type="number" id="pubsPorDia" class="form-control" value="3" min="1" max="20" onchange="actualizarPreviewProgramacion()">
                </div>
                <div class="form-group" style="margin:0">
                    <label class="form-label">Intervalo m√≠nimo (minutos)</label>
                    <input type="number" id="intervaloMinutos" class="form-control" value="60" min="15" max="480" step="15" onchange="actualizarPreviewProgramacion()">
                </div>
            </div>

            <!-- Preview -->
            <div class="programar-preview" style="background:var(--bg);border-radius:8px;padding:12px;max-height:150px;overflow-y:auto">
                <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Vista previa:</div>
                <div id="previewProgramacion" style="font-size:13px"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModalProgramar()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="confirmarProgramacion()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Programar
            </button>
        </div>
    </div>
</div>

<!-- Token anti-forgery para JS -->
@Html.AntiForgeryToken()

<script>
const usuarioId = '@Model.Id';
const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
let mediaSeleccionados = new Set();
let mediaData = []; // Cache de datos de biblioteca
let conversacionActual = null;

// ========================================
// TABS
// ========================================
function cambiarTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[onclick="cambiarTab('${tab}')"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');

    if (tab === 'biblioteca') cargarBiblioteca();
    if (tab === 'contenido') { cargarContenido(); cargarStories(); }
    if (tab === 'mensajes') { cargarConversaciones(); renderMensajeTemplates(); }
    if (tab === 'programacion') cargarCalendario();
    if (tab === 'estadisticas') cargarEstadisticas();
    if (tab === 'errores') cargarErrores();

    history.replaceState(null, '', `?tab=${tab}`);
}

// ========================================
// PERFIL
// ========================================
document.getElementById('formPerfil').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('id', usuarioId);
    formData.append('esCreador', this.querySelector('[name="esCreador"]').checked);
    formData.append('estaActivo', this.querySelector('[name="estaActivo"]').checked);
    formData.append('esVerificado', this.querySelector('[name="esVerificado"]').checked);
    formData.append('creadorVerificado', this.querySelector('[name="creadorVerificado"]').checked);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ActualizarPerfil', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.message || (data.success ? 'Guardado correctamente' : 'Error al guardar'));
    } catch (err) {
        alert('Error: ' + err.message);
    }
});

async function subirFotoPerfil(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('foto', input.files[0]);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/SubirFotoPerfil', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) location.reload();
        else alert(data.message || 'Error al subir foto');
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function subirFotoPortada(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('foto', input.files[0]);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/SubirFotoPortada', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            const img = document.getElementById('portadaImg');
            if (img) img.src = data.url;
            else location.reload();
        } else {
            alert(data.message || 'Error al subir portada');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function subirFotoPerfilLadoB(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('foto', input.files[0]);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/SubirFotoPerfilLadoB', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            const img = document.getElementById('fotoLadoBImg');
            if (img) img.src = data.url;
            else location.reload();
        } else {
            alert(data.message || 'Error al subir foto');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function ajustarSeguidores() {
    document.getElementById('modalAjustarSeguidores').style.display = 'flex';
}

function cerrarModalSeguidores() {
    document.getElementById('modalAjustarSeguidores').style.display = 'none';
}

async function guardarSeguidores() {
    const cantidad = parseInt(document.getElementById('nuevosSeguidores').value) || 0;
    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('cantidad', cantidad);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/EstablecerSeguidores', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            document.getElementById('seguidoresActuales').textContent = data.nuevoTotal;
            cerrarModalSeguidores();
            alert('Seguidores actualizados');
        } else {
            alert(data.message || 'Error');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function quitarMarcaAdministrado() {
    if (!confirm('¬øQuitar la marca de usuario administrado? El usuario dejar√° de aparecer en esta lista y no se le podr√° gestionar contenido autom√°ticamente.')) return;

    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/QuitarMarcaAdministrado', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            alert('Usuario ya no es administrado');
            window.location.href = '/Admin/UsuariosAdministrados';
        } else {
            alert(data.message || 'Error');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// BIBLIOTECA
// ========================================
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); subirArchivos(e.dataTransfer.files); });

// UI para selector de tipo de subida
function actualizarTipoSubidaUI() {
    const isPost = document.getElementById('tipoSubidaPost').checked;
    const labelPost = document.getElementById('labelTipoPost');
    const labelStory = document.getElementById('labelTipoStory');

    labelPost.style.background = isPost ? '#dbeafe' : 'transparent';
    labelPost.style.borderColor = isPost ? '#3b82f6' : 'transparent';
    labelStory.style.background = !isPost ? '#fce7f3' : 'transparent';
    labelStory.style.borderColor = !isPost ? '#ec4899' : 'transparent';
}
// Inicializar al cargar
actualizarTipoSubidaUI();

async function subirArchivos(files) {
    if (!files.length) return;
    const progressDiv = document.getElementById('uploadProgress');
    const fileArray = Array.from(files);

    // Obtener tipo de publicaci√≥n seleccionado
    const tipoPublicacion = document.querySelector('input[name="tipoSubida"]:checked')?.value || '0';
    const tipoLabel = tipoPublicacion === '1' ? 'Story' : 'Post';

    // Mostrar lista de archivos pendientes
    progressDiv.innerHTML = `<div style="padding:8px;text-align:center;color:var(--primary);font-size:12px;font-weight:500">Subiendo como ${tipoLabel}</div>` +
        fileArray.map((f, i) => `
        <div class="progress-item" id="progress-${i}">
            <div class="progress-item-name">${f.name}</div>
            <div class="progress-bar-wrapper"><div class="progress-bar" style="width:0%"></div></div>
            <div class="progress-status">Pendiente</div>
        </div>
    `).join('');

    let subidos = 0, errores = 0;

    // Subir archivos UNO POR UNO para evitar 413
    for (let i = 0; i < fileArray.length; i++) {
        const file = fileArray[i];
        const progressItem = document.getElementById(`progress-${i}`);
        const progressBar = progressItem.querySelector('.progress-bar');
        const progressStatus = progressItem.querySelector('.progress-status');

        progressStatus.textContent = 'Subiendo...';
        progressBar.style.width = '50%';

        const formData = new FormData();
        formData.append('id', usuarioId);
        formData.append('archivos', file);
        formData.append('tipoPublicacion', tipoPublicacion);

        try {
            const res = await fetch('/Admin/UsuariosAdministrados/SubirMedia', { method: 'POST', body: formData });

            if (!res.ok) {
                throw new Error(`Error ${res.status}: ${res.statusText}`);
            }

            const data = await res.json();

            if (data.success !== false && (data.subidos > 0 || data.items?.length > 0)) {
                progressBar.style.width = '100%';
                progressBar.style.background = '#388e3c';
                progressStatus.textContent = '‚úì Subido';
                progressStatus.style.color = '#388e3c';
                subidos++;
            } else {
                throw new Error(data.message || 'Error desconocido');
            }
        } catch (err) {
            progressBar.style.width = '100%';
            progressBar.style.background = '#d32f2f';
            progressStatus.textContent = `‚úó ${err.message}`;
            progressStatus.style.color = '#d32f2f';
            errores++;
        }
    }

    // Resumen final
    setTimeout(() => {
        progressDiv.innerHTML = `<div style="padding:12px;color:${errores === 0 ? '#388e3c' : '#f57c00'};text-align:center;font-weight:500">
            ‚úì ${subidos} archivos subidos${errores > 0 ? `, ${errores} con errores` : ''}
        </div>`;
        cargarBiblioteca();
        setTimeout(() => { progressDiv.innerHTML = ''; }, 3000);
    }, 500);
}

let bibliotecaPagina = 1;
let bibliotecaTotal = 0;
let bibliotecaEstadoFiltro = '';
let bibliotecaTipoFiltro = '';
const bibliotecaPageSize = 100;

async function cargarBiblioteca(estado = '', tipo = '', reset = true) {
    const grid = document.getElementById('mediaGrid');

    if (reset) {
        bibliotecaPagina = 1;
        bibliotecaEstadoFiltro = estado;
        bibliotecaTipoFiltro = tipo;
        mediaData = [];
        grid.innerHTML = '<div class="loading">Cargando...</div>';
    }

    try {
        const params = new URLSearchParams();
        if (bibliotecaEstadoFiltro !== '') params.append('estado', bibliotecaEstadoFiltro);
        if (bibliotecaTipoFiltro !== '') params.append('tipoMedia', bibliotecaTipoFiltro);
        params.append('page', bibliotecaPagina);
        params.append('pageSize', bibliotecaPageSize);

        const url = `/Admin/UsuariosAdministrados/Biblioteca/${usuarioId}?${params}`;
        const res = await fetch(url);
        const data = await res.json();

        bibliotecaTotal = data.total || 0;
        const nuevosItems = data.items || [];
        mediaData = reset ? nuevosItems : [...mediaData, ...nuevosItems];

        if (!mediaData.length) {
            grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì∑</div><div>No hay medios en la biblioteca</div><div style="font-size:12px;margin-top:8px">Arrastra archivos o haz clic en la zona de subida</div></div>';
            return;
        }

        const itemsHtml = (reset ? mediaData : nuevosItems).map(m => {
            const estadoClass = m.estado === 0 ? 'pendiente' : m.estado === 1 ? 'programado' : m.estado === 3 ? 'error' : 'publicado';
            const estadoText = m.estado === 0 ? 'Pendiente' : m.estado === 1 ? 'Programado' : m.estado === 3 ? 'Error' : 'Publicado';
            const esVideo = m.tipoMedia === 1;
            const esStory = m.tipoPublicacion === 1;
            const isChecked = mediaSeleccionados.has(m.id);

            // Formato de tama√±o de archivo
            const fileSize = m.tamanoBytes ? formatFileSize(m.tamanoBytes) : '';

            // Icono de video play
            const videoIcon = esVideo ? `
                <div class="media-item-video-icon">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
            ` : '';

            // Badges en esquina superior derecha
            const badges = `
                <div class="media-item-badges">
                    <span class="media-item-status status-${estadoClass}">${estadoText}</span>
                    ${esStory ? '<span class="media-item-type type-story">STORY</span>' : ''}
                    ${esVideo && !esStory ? '<span class="media-item-type type-video">VIDEO</span>' : ''}
                </div>
            `;

            // Info inferior (duracion para videos, tama√±o si disponible)
            let bottomInfo = '';
            if (m.fechaProgramada) {
                bottomInfo = `<div class="media-item-date">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    ${formatDate(m.fechaProgramada)}
                </div>`;
            } else if (esVideo && m.duracionSegundos) {
                bottomInfo = `<span class="media-item-duration">${formatDuration(m.duracionSegundos)}</span>`;
            }

            return `
                <div class="media-item ${isChecked ? 'selected' : ''}" data-id="${m.id}" data-video="${esVideo}">
                    <input type="checkbox" class="media-item-checkbox" ${isChecked ? 'checked' : ''} onchange="toggleSeleccion(${m.id}, this)">
                    ${esVideo ? `<video src="${m.rutaArchivo}" muted preload="metadata"></video>` : `<img src="${m.rutaArchivo}" decoding="async" alt="">`}
                    ${videoIcon}
                    ${badges}
                    ${bottomInfo}
                    <div class="media-item-overlay">
                        <button class="media-item-btn" onclick="editarMedia(${m.id})">
                            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Editar
                        </button>
                        ${m.estado !== 2 ? `<button class="media-item-btn" onclick="publicarAhora(${m.id})">
                            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            ${esStory ? 'Publicar Story' : 'Publicar'}
                        </button>` : ''}
                        <button class="media-item-btn danger" onclick="eliminarMedia(${m.id})">
                            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        // Contador y bot√≥n cargar m√°s + estad√≠sticas
        const hayMas = mediaData.length < bibliotecaTotal;

        // Calcular estad√≠sticas de los items cargados
        const stats = mediaData.reduce((acc, m) => {
            acc.videos += m.tipoMedia === 1 ? 1 : 0;
            acc.imagenes += m.tipoMedia === 0 ? 1 : 0;
            acc.stories += m.tipoPublicacion === 1 ? 1 : 0;
            acc.posts += m.tipoPublicacion === 0 ? 1 : 0;
            acc.pendientes += m.estado === 0 ? 1 : 0;
            acc.programados += m.estado === 1 ? 1 : 0;
            acc.publicados += m.estado === 2 ? 1 : 0;
            return acc;
        }, { videos: 0, imagenes: 0, stories: 0, posts: 0, pendientes: 0, programados: 0, publicados: 0 });

        const footerHtml = `
            <div class="biblioteca-footer">
                <div class="biblioteca-stats">
                    <span class="stat-pill">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        ${stats.imagenes} img
                    </span>
                    <span class="stat-pill video">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
                        ${stats.videos} vid
                    </span>
                    <span class="stat-pill story">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/></svg>
                        ${stats.stories} stories
                    </span>
                </div>
                <div class="biblioteca-counter">
                    Mostrando <strong>${mediaData.length}</strong> de <strong>${bibliotecaTotal}</strong> archivos
                </div>
                ${hayMas ? `
                    <button class="btn btn-primary btn-load-more" onclick="cargarMasBiblioteca()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Cargar m√°s (${bibliotecaTotal - mediaData.length} restantes)
                    </button>
                ` : ''}
            </div>
        `;

        if (reset) {
            grid.innerHTML = itemsHtml + footerHtml;
        } else {
            // Remover footer anterior y agregar nuevos items + footer
            const oldFooter = grid.querySelector('.biblioteca-footer');
            if (oldFooter) oldFooter.remove();
            grid.insertAdjacentHTML('beforeend', itemsHtml + footerHtml);
        }
    } catch (err) {
        grid.innerHTML = `<div class="empty-state"><div>Error: ${err.message}</div></div>`;
    }
}

function cargarMasBiblioteca() {
    bibliotecaPagina++;
    cargarBiblioteca(bibliotecaEstadoFiltro, bibliotecaTipoFiltro, false);
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('es', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatFileSize(bytes) {
    if (!bytes) return '';
    const units = ['B', 'KB', 'MB', 'GB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
    }
    return `${bytes.toFixed(1)} ${units[i]}`;
}

// Filtros
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        mediaSeleccionados.clear();
        actualizarBotones();
        cargarBiblioteca(this.dataset.estado || '', this.dataset.tipo || '');
    });
});

function toggleSeleccion(id, checkbox) {
    const item = checkbox ? checkbox.closest('.media-item') : document.querySelector(`.media-item[data-id="${id}"]`);
    if (mediaSeleccionados.has(id)) {
        mediaSeleccionados.delete(id);
        item?.classList.remove('selected');
    } else {
        mediaSeleccionados.add(id);
        item?.classList.add('selected');
    }
    actualizarBotones();
    actualizarSelectionCounter();
}

function actualizarSelectionCounter() {
    let counter = document.getElementById('selectionCounter');
    if (!counter) {
        counter = document.createElement('div');
        counter.id = 'selectionCounter';
        counter.className = 'selection-counter';
        counter.innerHTML = `
            <span class="selection-count">0 seleccionados</span>
            <button onclick="eliminarSeleccionados()">Eliminar</button>
            <button onclick="programarSeleccionados()">Programar</button>
            <button onclick="limpiarSeleccion()">Cancelar</button>
        `;
        document.body.appendChild(counter);
    }

    const count = mediaSeleccionados.size;
    counter.querySelector('.selection-count').textContent = `${count} seleccionado${count !== 1 ? 's' : ''}`;
    counter.classList.toggle('visible', count > 0);
}

function limpiarSeleccion() {
    mediaSeleccionados.clear();
    document.querySelectorAll('.media-item.selected').forEach(item => item.classList.remove('selected'));
    document.querySelectorAll('.media-item-checkbox:checked').forEach(cb => cb.checked = false);
    actualizarBotones();
    actualizarSelectionCounter();
}

async function eliminarMedia(id) {
    try {
        const res = await fetch('/Admin/UsuariosAdministrados/EliminarMediaMultiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify([id])
        });
        const data = await res.json();
        if (data.success) {
            // Remover elemento del DOM sin recargar toda la p√°gina
            const item = document.querySelector(`.media-item[data-id="${id}"]`);
            if (item) {
                item.style.transition = 'all 0.3s';
                item.style.opacity = '0';
                item.style.transform = 'scale(0.8)';
                setTimeout(() => item.remove(), 300);
            }
            mediaSeleccionados.delete(id);
            actualizarBotones();
        } else {
            showToast(data.message || 'Error al eliminar', 'error');
        }
    } catch (err) {
        console.error('[EliminarMedia] Error:', err);
        showToast('Error: ' + err.message, 'error');
    }
}

function seleccionarTodos() {
    const items = document.querySelectorAll('.media-item');
    const todosSeleccionados = mediaSeleccionados.size === items.length && items.length > 0;

    mediaSeleccionados.clear();
    items.forEach(item => {
        const cb = item.querySelector('.media-item-checkbox');
        const id = parseInt(item.dataset.id);
        if (!todosSeleccionados) {
            mediaSeleccionados.add(id);
            item.classList.add('selected');
            if (cb) cb.checked = true;
        } else {
            item.classList.remove('selected');
            if (cb) cb.checked = false;
        }
    });
    actualizarBotones();
    actualizarSelectionCounter();
}

function actualizarBotones() {
    const haySeleccionados = mediaSeleccionados.size > 0;
    document.getElementById('btnEliminar').disabled = !haySeleccionados;
    document.getElementById('btnPublicar').disabled = !haySeleccionados;
    document.getElementById('btnAccionesLote').disabled = !haySeleccionados;
}

async function eliminarSeleccionados() {
    const cantidad = mediaSeleccionados.size;
    if (cantidad === 0) return;

    // Mostrar progreso
    const btn = document.getElementById('btnEliminar');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Eliminando ${cantidad}...`;

    try {
        // Enviar en lotes de 50 para evitar errores HTTP/2
        const ids = Array.from(mediaSeleccionados);
        let eliminados = 0;

        for (let i = 0; i < ids.length; i += 50) {
            const lote = ids.slice(i, i + 50);
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${eliminados}/${cantidad}`;

            const res = await fetch('/Admin/UsuariosAdministrados/EliminarMediaMultiple', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify(lote)
            });

            if (res.ok) {
                const data = await res.json();
                eliminados += data.eliminados || lote.length;
            }
        }

        limpiarSeleccion();
        cargarBiblioteca(bibliotecaEstadoFiltro, bibliotecaTipoFiltro);
        showToast(`${eliminados} archivos eliminados`, 'success');
    } catch (err) {
        console.error('[Eliminar] Error:', err);
        showToast('Error al eliminar: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function eliminarTodaBiblioteca() {
    // Usar bibliotecaTotal (del servidor) en lugar de mediaData.length (solo los cargados)
    const totalItems = bibliotecaTotal || mediaData.length;
    if (totalItems === 0) {
        showToast('La biblioteca est√° vac√≠a', 'warning');
        return;
    }

    if (!confirm(`¬øELIMINAR TODA LA BIBLIOTECA?\n\nEsto eliminar√° ${totalItems} archivos de forma permanente.\nEsta acci√≥n NO se puede deshacer.`)) {
        return;
    }

    // Doble confirmaci√≥n para acci√≥n destructiva
    const confirmText = prompt(`Escribe "ELIMINAR" para confirmar la eliminaci√≥n de ${totalItems} archivos:`);
    if (confirmText !== 'ELIMINAR') {
        showToast('Operaci√≥n cancelada', 'info');
        return;
    }

    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Eliminando...';

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/EliminarTodaBiblioteca', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${usuarioId}&__RequestVerificationToken=${encodeURIComponent(token)}`
        });

        const data = await res.json();
        if (data.success) {
            showToast(data.message || `${data.eliminados} archivos eliminados`, 'success');
            limpiarSeleccion();
            cargarBiblioteca();
        } else {
            showToast(data.message || 'Error al eliminar', 'error');
        }
    } catch (err) {
        console.error('[EliminarTodo] Error:', err);
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function publicarSeleccionados() {
    if (!confirm(`¬øPublicar ${mediaSeleccionados.size} elementos ahora?`)) return;

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/PublicarMultiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify(Array.from(mediaSeleccionados))
        });
        const data = await res.json();
        alert(`Publicados: ${data.publicados}${data.errores?.length ? `, Errores: ${data.errores.length}` : ''}`);
        limpiarSeleccion();
        cargarBiblioteca(bibliotecaEstadoFiltro, bibliotecaTipoFiltro);
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// CALENDARIO PROGRAMACI√ìN
// ========================================
let calendarioMes = new Date().getMonth();
let calendarioAnio = new Date().getFullYear();
let calendarioFechaSeleccionada = null;

const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

function programarSeleccionados() {
    if (mediaSeleccionados.size === 0) return;

    // Reset calendario a hoy
    const hoy = new Date();
    calendarioMes = hoy.getMonth();
    calendarioAnio = hoy.getFullYear();
    calendarioFechaSeleccionada = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    document.getElementById('programarCantidad').textContent = mediaSeleccionados.size;
    document.getElementById('modalProgramar').style.display = 'flex';
    document.querySelector('input[name="distribucion"][value="mismo-dia"]').checked = true;
    document.getElementById('opcionesVariosDias').style.display = 'none';

    renderizarCalendario();
    actualizarPreviewProgramacion();
}

function cerrarModalProgramar() {
    document.getElementById('modalProgramar').style.display = 'none';
}

function renderizarCalendario() {
    const grid = document.getElementById('calendarioGrid');
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    // Actualizar t√≠tulo
    document.getElementById('calendarioMesAnio').textContent = `${mesesNombres[calendarioMes]} ${calendarioAnio}`;

    // Primer d√≠a del mes
    const primerDia = new Date(calendarioAnio, calendarioMes, 1);
    const ultimoDia = new Date(calendarioAnio, calendarioMes + 1, 0);

    // D√≠a de la semana del primer d√≠a (0=Dom, queremos 0=Lun)
    let diaInicio = primerDia.getDay() - 1;
    if (diaInicio < 0) diaInicio = 6;

    let html = '';

    // D√≠as del mes anterior
    const diasMesAnterior = new Date(calendarioAnio, calendarioMes, 0).getDate();
    for (let i = diaInicio - 1; i >= 0; i--) {
        const dia = diasMesAnterior - i;
        html += `<div class="cal-dia otro-mes">${dia}</div>`;
    }

    // D√≠as del mes actual
    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fecha = new Date(calendarioAnio, calendarioMes, dia);
        const esPasado = fecha < hoy;
        const esHoy = fecha.getTime() === hoy.getTime();
        const esSeleccionado = calendarioFechaSeleccionada && fecha.getTime() === calendarioFechaSeleccionada.getTime();

        let clases = 'cal-dia';
        if (esPasado) clases += ' pasado';
        if (esHoy) clases += ' hoy';
        if (esSeleccionado) clases += ' seleccionado';

        const onclick = esPasado ? '' : `onclick="seleccionarDiaCalendario(${dia})"`;
        html += `<div class="${clases}" ${onclick}>${dia}</div>`;
    }

    // D√≠as del mes siguiente
    const diasRestantes = 42 - (diaInicio + ultimoDia.getDate());
    for (let dia = 1; dia <= diasRestantes && dia <= 14; dia++) {
        html += `<div class="cal-dia otro-mes">${dia}</div>`;
    }

    grid.innerHTML = html;
}

function cambiarMesCalendario(delta) {
    calendarioMes += delta;
    if (calendarioMes > 11) {
        calendarioMes = 0;
        calendarioAnio++;
    } else if (calendarioMes < 0) {
        calendarioMes = 11;
        calendarioAnio--;
    }
    renderizarCalendario();
}

function seleccionarDiaCalendario(dia) {
    calendarioFechaSeleccionada = new Date(calendarioAnio, calendarioMes, dia);
    renderizarCalendario();
    actualizarPreviewProgramacion();
}

function actualizarPreviewProgramacion() {
    const distribucion = document.querySelector('input[name="distribucion"]:checked').value;
    const opcionesDiv = document.getElementById('opcionesVariosDias');
    opcionesDiv.style.display = distribucion === 'varios-dias' ? 'block' : 'none';

    if (!calendarioFechaSeleccionada) {
        document.getElementById('previewProgramacion').innerHTML = '<span style="color:var(--muted)">Selecciona una fecha</span>';
        return;
    }

    const cantidad = mediaSeleccionados.size;
    const horaInicio = parseInt(document.getElementById('programarHora').value);
    const horaFin = parseInt(document.getElementById('programarHoraFin').value);
    const preview = document.getElementById('previewProgramacion');

    if (distribucion === 'mismo-dia') {
        // Calcular intervalo entre publicaciones
        const minutosDisponibles = (horaFin - horaInicio) * 60;
        const intervalo = cantidad > 1 ? Math.floor(minutosDisponibles / (cantidad - 1)) : 0;

        const fechaStr = calendarioFechaSeleccionada.toLocaleDateString('es', { weekday: 'short', day: 'numeric', month: 'short' });
        let html = `<div style="margin-bottom:8px"><strong>${fechaStr}</strong></div>`;

        const maxPreview = Math.min(cantidad, 5);
        for (let i = 0; i < maxPreview; i++) {
            const minutos = i * intervalo;
            const hora = horaInicio + Math.floor(minutos / 60);
            const min = minutos % 60;
            html += `<div style="color:var(--muted);font-size:12px">${hora.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')} - Publicaci√≥n ${i + 1}</div>`;
        }
        if (cantidad > 5) {
            html += `<div style="color:var(--muted);font-size:12px">... y ${cantidad - 5} m√°s</div>`;
        }
        preview.innerHTML = html;
    } else {
        const pubsPorDia = parseInt(document.getElementById('pubsPorDia').value) || 3;
        const intervaloMin = parseInt(document.getElementById('intervaloMinutos').value) || 60;
        const diasNecesarios = Math.ceil(cantidad / pubsPorDia);

        let html = `<div style="margin-bottom:8px"><strong>${diasNecesarios} d√≠as</strong> (${pubsPorDia} pub/d√≠a, cada ${intervaloMin} min)</div>`;

        const maxDiasPreview = Math.min(diasNecesarios, 4);
        let pubIndex = 0;
        for (let d = 0; d < maxDiasPreview; d++) {
            const fecha = new Date(calendarioFechaSeleccionada);
            fecha.setDate(fecha.getDate() + d);
            const fechaStr = fecha.toLocaleDateString('es', { weekday: 'short', day: 'numeric', month: 'short' });
            const pubsEsteDia = Math.min(pubsPorDia, cantidad - pubIndex);
            html += `<div style="font-size:12px"><span style="color:var(--primary)">${fechaStr}</span>: ${pubsEsteDia} publicaciones</div>`;
            pubIndex += pubsEsteDia;
        }
        if (diasNecesarios > 4) {
            html += `<div style="color:var(--muted);font-size:12px">... y ${diasNecesarios - 4} d√≠as m√°s</div>`;
        }
        preview.innerHTML = html;
    }
}

async function confirmarProgramacion() {
    if (!calendarioFechaSeleccionada) {
        showToast('Selecciona una fecha', 'warning');
        return;
    }

    const distribucion = document.querySelector('input[name="distribucion"]:checked').value;
    const horaInicio = parseInt(document.getElementById('programarHora').value);
    const horaFin = parseInt(document.getElementById('programarHoraFin').value);

    // Construir fecha de inicio
    const fechaInicio = new Date(calendarioFechaSeleccionada);
    fechaInicio.setHours(horaInicio, 0, 0, 0);

    const payload = {
        ids: Array.from(mediaSeleccionados),
        fechaInicio: fechaInicio.toISOString(),
        horaInicio: horaInicio,
        horaFin: horaFin,
        distribuirEnDias: distribucion === 'varios-dias',
        publicacionesPorDia: distribucion === 'varios-dias' ? parseInt(document.getElementById('pubsPorDia').value) : mediaSeleccionados.size,
        intervaloMinutos: distribucion === 'varios-dias' ? parseInt(document.getElementById('intervaloMinutos').value) : 0
    };

    const btn = document.querySelector('#modalProgramar .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Programando...';

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ProgramarMultiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            cerrarModalProgramar();
            showToast(`${data.programados} archivos programados`, 'success');
            limpiarSeleccion();
            cargarBiblioteca(bibliotecaEstadoFiltro, bibliotecaTipoFiltro);
        } else {
            showToast(data.message || 'Error al programar', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Programar';
    }
}

// Event listeners para actualizar preview
document.getElementById('programarHora')?.addEventListener('change', actualizarPreviewProgramacion);
document.getElementById('programarHoraFin')?.addEventListener('change', actualizarPreviewProgramacion);

async function publicarAhora(id) {
    if (!confirm('¬øPublicar este contenido ahora?')) return;

    const formData = new FormData();
    formData.append('mediaId', id);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/PublicarAhora', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) cargarBiblioteca();
        else alert(data.message || 'Error al publicar');
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function editarMedia(id) {
    const media = mediaData.find(m => m.id === id);
    if (!media) return;

    document.getElementById('editMediaId').value = id;
    document.getElementById('editDescripcion').value = media.descripcion || '';
    document.getElementById('editHashtags').value = media.hashtags || '';
    document.getElementById('editTipoPublicacion').value = media.tipoPublicacion || 0;
    document.getElementById('editTipoLado').value = media.tipoLado || 0;
    document.getElementById('editOrden').value = media.orden || 0;
    document.getElementById('editSoloSuscriptores').checked = media.soloSuscriptores || false;

    const imgPreview = document.getElementById('modalMediaPreview');
    const videoPreview = document.getElementById('modalVideoPreview');

    if (media.tipoMedia === 1) {
        imgPreview.style.display = 'none';
        videoPreview.style.display = 'block';
        videoPreview.src = media.rutaArchivo;
    } else {
        videoPreview.style.display = 'none';
        imgPreview.style.display = 'block';
        imgPreview.src = media.rutaArchivo;
    }

    document.getElementById('modalEditarMedia').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalEditarMedia').style.display = 'none';
    document.getElementById('modalVideoPreview').pause();
}

async function guardarMedia() {
    const form = document.getElementById('formEditarMedia');
    const formData = new FormData(form);
    formData.append('soloSuscriptores', document.getElementById('editSoloSuscriptores').checked);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ActualizarMedia', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            cerrarModal();
            cargarBiblioteca();
        } else {
            alert(data.message || 'Error al guardar');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// PROGRAMACI√ìN
// ========================================
document.getElementById('formConfig').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('usuarioId', usuarioId);
    formData.append('activo', document.getElementById('configActivo').checked);
    formData.append('publicarFinesDeSemana', this.querySelector('[name="publicarFinesDeSemana"]').checked);
    formData.append('soloSuscriptoresDefault', this.querySelector('[name="soloSuscriptoresDefault"]').checked);
    formData.append('tipoLadoDefault', '0');
    // Stories quota fields
    formData.append('storiesMinPorDia', this.querySelector('[name="storiesMinPorDia"]').value);
    formData.append('storiesMaxPorDia', this.querySelector('[name="storiesMaxPorDia"]').value);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/GuardarConfiguracion', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.success ? 'Configuraci√≥n guardada' : (data.message || 'Error'));
        if (data.success) cargarCalendario();
    } catch (err) {
        alert('Error: ' + err.message);
    }
});

async function programarContenido() {
    const formData = new FormData();
    formData.append('usuarioId', usuarioId);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ProgramarContenido', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.message || (data.success ? `${data.programados} publicaciones programadas` : 'Error'));
        cargarCalendario();
        cargarBiblioteca();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function desprogramarTodo() {
    if (!confirm('¬øDesprogramar todo el contenido? Volver√°n al estado pendiente.')) return;

    const formData = new FormData();
    formData.append('usuarioId', usuarioId);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/DesprogramarTodo', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.success ? `${data.desprogramados} publicaciones desprogramadas` : 'Error');
        cargarCalendario();
        cargarBiblioteca();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// CALENDARIO PROGRAMACI√ìN (Tab)
// ========================================
let progCalMes = new Date().getMonth();
let progCalAnio = new Date().getFullYear();
let progCalData = []; // Datos de medios programados

async function cargarCalendario() {
    try {
        // Cargar estad√≠sticas de todos los estados con m√°s detalle (pageSize=1000 para contar por tipo)
        const [pendientes, programados, publicados] = await Promise.all([
            fetch(`/Admin/UsuariosAdministrados/Biblioteca/${usuarioId}?estado=0&pageSize=2000`).then(r => r.json()),
            fetch(`/Admin/UsuariosAdministrados/Biblioteca/${usuarioId}?estado=1&pageSize=2000`).then(r => r.json()),
            fetch(`/Admin/UsuariosAdministrados/Biblioteca/${usuarioId}?estado=2&pageSize=2000`).then(r => r.json())
        ]);

        // Calcular totales
        const numPendientes = pendientes.total || 0;
        const numProgramados = programados.total || 0;
        const numPublicados = publicados.total || 0;

        // Calcular por tipo (Feed=0, Story=1)
        const feedPendientes = (pendientes.items || []).filter(m => m.tipoPublicacion === 0).length;
        const storiesPendientes = (pendientes.items || []).filter(m => m.tipoPublicacion === 1).length;
        const feedProgramados = (programados.items || []).filter(m => m.tipoPublicacion === 0).length;
        const storiesProgramados = (programados.items || []).filter(m => m.tipoPublicacion === 1).length;
        const feedPublicados = (publicados.items || []).filter(m => m.tipoPublicacion === 0).length;
        const storiesPublicados = (publicados.items || []).filter(m => m.tipoPublicacion === 1).length;

        // Actualizar estad√≠sticas por tipo
        document.getElementById('statFeedPendientes').textContent = feedPendientes;
        document.getElementById('statFeedProgramados').textContent = feedProgramados;
        document.getElementById('statFeedPublicados').textContent = feedPublicados;
        document.getElementById('statStoriesPendientes').textContent = storiesPendientes;
        document.getElementById('statStoriesProgramados').textContent = storiesProgramados;
        document.getElementById('statStoriesPublicados').textContent = storiesPublicados;

        // Actualizar estad√≠sticas totales
        document.getElementById('statPendientes').textContent = numPendientes;
        document.getElementById('statProgramados').textContent = numProgramados;
        document.getElementById('statPublicados').textContent = numPublicados;

        // Actualizar contadores en botones
        document.getElementById('pendientesCount').textContent = numPendientes;
        document.getElementById('programadosCount').textContent = numProgramados;

        // Deshabilitar botones si no hay elementos
        document.getElementById('btnProgramarPendientes').disabled = numPendientes === 0;
        document.getElementById('btnDesprogramar').disabled = numProgramados === 0;

        // Calcular pr√≥ximos 7 d√≠as
        const hoy = new Date();
        const en7dias = new Date(hoy);
        en7dias.setDate(en7dias.getDate() + 7);
        const prox7 = (programados.items || []).filter(m => {
            if (!m.fechaProgramada) return false;
            const fecha = new Date(m.fechaProgramada);
            return fecha >= hoy && fecha <= en7dias;
        }).length;
        document.getElementById('statProxDias').textContent = prox7;

        // Guardar datos para el calendario
        progCalData = programados.items || [];

        // Renderizar calendario
        renderizarProgCalendario();
        renderizarProgTimeline();

    } catch (err) {
        console.error('[CargarCalendario] Error:', err);
    }
}

function renderizarProgCalendario() {
    const grid = document.getElementById('progCalendarGrid');
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    // Actualizar t√≠tulo
    document.getElementById('progCalMesAnio').textContent = `${mesesNombres[progCalMes]} ${progCalAnio}`;

    // Agrupar medios por fecha
    const mediaPorDia = {};
    progCalData.forEach(m => {
        if (m.fechaProgramada) {
            const fecha = new Date(m.fechaProgramada);
            const key = `${fecha.getFullYear()}-${fecha.getMonth()}-${fecha.getDate()}`;
            if (!mediaPorDia[key]) mediaPorDia[key] = [];
            mediaPorDia[key].push(m);
        }
    });

    // Primer d√≠a del mes
    const primerDia = new Date(progCalAnio, progCalMes, 1);
    const ultimoDia = new Date(progCalAnio, progCalMes + 1, 0);

    let diaInicio = primerDia.getDay() - 1;
    if (diaInicio < 0) diaInicio = 6;

    let html = '';

    // D√≠as del mes anterior
    const diasMesAnterior = new Date(progCalAnio, progCalMes, 0).getDate();
    for (let i = diaInicio - 1; i >= 0; i--) {
        const dia = diasMesAnterior - i;
        html += `<div class="prog-cal-dia otro-mes"><span class="dia-num">${dia}</span></div>`;
    }

    // D√≠as del mes actual
    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fecha = new Date(progCalAnio, progCalMes, dia);
        const key = `${progCalAnio}-${progCalMes}-${dia}`;
        const esHoy = fecha.getTime() === hoy.getTime();
        const items = mediaPorDia[key] || [];
        const videos = items.filter(m => m.tipoMedia === 1).length;
        const imagenes = items.filter(m => m.tipoMedia === 0).length;

        let clases = 'prog-cal-dia';
        if (esHoy) clases += ' hoy';

        let dotsHtml = '';
        if (items.length > 0) {
            // Mostrar hasta 6 dots
            const maxDots = Math.min(items.length, 6);
            for (let i = 0; i < maxDots; i++) {
                const tipo = items[i].tipoMedia === 1 ? 'video' : 'imagen';
                dotsHtml += `<span class="dia-dot ${tipo}"></span>`;
            }
        }

        html += `<div class="${clases}" onclick="verDiaProgramado('${key}')">
            <span class="dia-num">${dia}</span>
            ${dotsHtml ? `<div class="dia-dots">${dotsHtml}</div>` : ''}
            ${items.length > 0 ? `<div class="dia-count">${items.length}</div>` : ''}
        </div>`;
    }

    // D√≠as del mes siguiente
    const diasRestantes = 42 - (diaInicio + ultimoDia.getDate());
    for (let dia = 1; dia <= diasRestantes && dia <= 14; dia++) {
        html += `<div class="prog-cal-dia otro-mes"><span class="dia-num">${dia}</span></div>`;
    }

    grid.innerHTML = html;
}

function cambiarMesProgCalendario(delta) {
    progCalMes += delta;
    if (progCalMes > 11) {
        progCalMes = 0;
        progCalAnio++;
    } else if (progCalMes < 0) {
        progCalMes = 11;
        progCalAnio--;
    }
    renderizarProgCalendario();
}

function renderizarProgTimeline() {
    const timeline = document.getElementById('progTimeline');

    if (!progCalData.length) {
        timeline.innerHTML = '<div class="empty-state" style="padding:30px"><div>No hay contenido programado</div><div style="font-size:12px;margin-top:8px;color:var(--muted)">Selecciona contenido en la biblioteca y usa "Programar"</div></div>';
        return;
    }

    // Ordenar por fecha
    const ordenados = [...progCalData].sort((a, b) => new Date(a.fechaProgramada) - new Date(b.fechaProgramada));

    // Agrupar por d√≠a
    const porDia = {};
    ordenados.forEach(m => {
        if (m.fechaProgramada) {
            const fecha = new Date(m.fechaProgramada);
            const key = fecha.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long' });
            if (!porDia[key]) porDia[key] = [];
            porDia[key].push(m);
        }
    });

    // Mostrar solo pr√≥ximos 7 d√≠as
    const dias = Object.entries(porDia).slice(0, 7);

    if (!dias.length) {
        timeline.innerHTML = '<div class="empty-state" style="padding:30px"><div>No hay publicaciones pr√≥ximas</div></div>';
        return;
    }

    let html = '';
    dias.forEach(([fecha, items]) => {
        html += `<div class="prog-timeline-day">
            <div class="prog-timeline-header">
                <span class="prog-timeline-date">${fecha.charAt(0).toUpperCase() + fecha.slice(1)}</span>
                <span class="prog-timeline-count">${items.length} publicaci√≥n${items.length > 1 ? 'es' : ''}</span>
            </div>
            <div class="prog-timeline-items">
                ${items.map(m => {
                    const hora = new Date(m.fechaProgramada).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
                    const esVideo = m.tipoMedia === 1;
                    return `<div class="prog-timeline-item" onclick="editarMedia(${m.id})" title="${m.descripcion || 'Sin descripci√≥n'}">
                        ${esVideo
                            ? `<video src="${m.rutaArchivo}" muted></video>`
                            : `<img src="${m.rutaArchivo}" alt="">`}
                        <div class="item-time">${hora}</div>
                        <div class="item-type">
                            ${esVideo
                                ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
                                : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    });

    timeline.innerHTML = html;
}

function verDiaProgramado(key) {
    // Parsear la key (YYYY-M-D)
    const [anio, mes, dia] = key.split('-').map(Number);
    const fecha = new Date(anio, mes, dia);
    const items = progCalData.filter(m => {
        if (!m.fechaProgramada) return false;
        const f = new Date(m.fechaProgramada);
        return f.getFullYear() === anio && f.getMonth() === mes && f.getDate() === dia;
    });

    if (items.length === 0) {
        showToast(`No hay publicaciones para el ${dia}/${mes + 1}`, 'info');
        return;
    }

    // Mostrar en un toast o scroll a timeline
    const fechaStr = fecha.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long' });
    showToast(`${fechaStr}: ${items.length} publicaci√≥n${items.length > 1 ? 'es' : ''}`, 'info');
}

// ========================================
// CONTENIDO
// ========================================
async function cargarContenido() {
    const grid = document.getElementById('contenidoGrid');
    grid.innerHTML = '<div class="loading">Cargando...</div>';

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/Contenido/${usuarioId}`);
        const data = await res.json();

        document.getElementById('contenidoCount').textContent = `${data.total || 0} publicaciones`;

        if (!data.items || data.items.length === 0) {
            grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div>No hay contenido publicado</div></div>';
            return;
        }

        grid.innerHTML = data.items.map(c => {
            const mediaHtml = c.esVideo
                ? `<video src="${c.rutaMedia || c.thumbnail}" muted playsinline></video>
                   <div class="video-indicator"><svg width="20" height="20" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>`
                : (c.thumbnail || c.rutaMedia)
                    ? `<img src="${c.thumbnail || c.rutaMedia}" decoding="async">`
                    : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">Sin imagen</div>';

            return `<div class="contenido-item" data-id="${c.id}">
                <div class="contenido-item-media">
                    ${mediaHtml}
                    <div class="contenido-item-actions">
                        <a href="/Feed/Detalle/${c.id}" target="_blank" class="contenido-action-btn" title="Ver publicaci√≥n">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </a>
                        <button class="contenido-action-btn danger" onclick="eliminarContenidoPublicado(${c.id})" title="Eliminar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
                <div class="contenido-item-info">
                    <div class="contenido-item-stats">
                        <span>‚ù§Ô∏è ${c.numeroLikes}</span>
                        <span>üí¨ ${c.numeroComentarios}</span>
                    </div>
                    <div class="contenido-item-date">${formatDate(c.fechaPublicacion)}</div>
                </div>
            </div>`;
        }).join('');
    } catch (err) {
        grid.innerHTML = `<div class="empty-state"><div>Error: ${err.message}</div></div>`;
    }
}

async function eliminarContenidoPublicado(id) {
    if (!confirm('¬øEliminar esta publicaci√≥n? Esta acci√≥n no se puede deshacer.')) return;

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/EliminarContenido', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: `id=${id}`
        });

        const data = await res.json();
        if (data.success) {
            showToast('Publicaci√≥n eliminada', 'success');
            // Remover el elemento del DOM
            const item = document.querySelector(`.contenido-item[data-id="${id}"]`);
            if (item) {
                item.style.transition = 'all 0.3s';
                item.style.opacity = '0';
                item.style.transform = 'scale(0.8)';
                setTimeout(() => item.remove(), 300);
            }
            // Actualizar contador
            const countEl = document.getElementById('contenidoCount');
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = `${Math.max(0, currentCount - 1)} publicaciones`;
        } else {
            showToast(data.message || 'Error al eliminar', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// ========================================
// MENSAJES
// ========================================
async function cargarConversaciones() {
    const list = document.getElementById('conversacionesList');
    list.innerHTML = '<div class="loading">Cargando...</div>';

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/Conversaciones/${usuarioId}`);
        const data = await res.json();

        if (!data.conversaciones || data.conversaciones.length === 0) {
            list.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-state-icon">üí¨</div><div>No hay conversaciones</div></div>';
            return;
        }

        list.innerHTML = data.conversaciones.map(c => `
            <div class="conversacion-item" onclick="abrirConversacion('${c.usuarioId}', '${c.usuario?.nombreCompleto || c.usuario?.userName || 'Usuario'}')" data-userid="${c.usuarioId}">
                <div class="conversacion-avatar">
                    ${c.usuario?.fotoPerfil
                        ? `<img src="${c.usuario.fotoPerfil}">`
                        : (c.usuario?.nombreCompleto || c.usuario?.userName || '?')[0].toUpperCase()
                    }
                </div>
                <div class="conversacion-info">
                    <div class="conversacion-name">${c.usuario?.nombreCompleto || c.usuario?.userName || 'Usuario'}</div>
                    <div class="conversacion-preview">${c.ultimoMensaje.esEnviado ? 'T√∫: ' : ''}${c.ultimoMensaje.contenido}</div>
                </div>
                ${c.noLeidos > 0 ? `<span class="conversacion-badge">${c.noLeidos}</span>` : ''}
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = `<div class="empty-state"><div>Error: ${err.message}</div></div>`;
    }
}

async function abrirConversacion(otroUsuarioId, nombre) {
    conversacionActual = otroUsuarioId;

    document.querySelectorAll('.conversacion-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.conversacion-item[data-userid="${otroUsuarioId}"]`)?.classList.add('active');

    const container = document.getElementById('chatContainer');
    container.innerHTML = `
        <div class="chat-header">${nombre}</div>
        <div class="chat-messages" id="chatMessages"><div class="loading">Cargando...</div></div>
        <div class="chat-input">
            <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter')enviarMensaje()">
            <button onclick="enviarMensaje()">Enviar</button>
        </div>
    `;

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/Mensajes/${usuarioId}/${otroUsuarioId}`);
        const data = await res.json();
        const messagesDiv = document.getElementById('chatMessages');

        if (!data.mensajes || data.mensajes.length === 0) {
            messagesDiv.innerHTML = '<div class="empty-state"><div>No hay mensajes</div></div>';
            return;
        }

        messagesDiv.innerHTML = data.mensajes.map(m => `
            <div class="chat-message ${m.esEnviado ? 'enviado' : 'recibido'}">
                ${m.contenido}
                <div class="chat-message-time">${new Date(m.fechaEnvio).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        `).join('');

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (err) {
        document.getElementById('chatMessages').innerHTML = `<div class="empty-state"><div>Error: ${err.message}</div></div>`;
    }
}

async function enviarMensaje() {
    const input = document.getElementById('mensajeInput');
    const contenido = input.value.trim();
    if (!contenido || !conversacionActual) return;

    const formData = new FormData();
    formData.append('remitenteId', usuarioId);
    formData.append('destinatarioId', conversacionActual);
    formData.append('contenido', contenido);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/EnviarMensaje', { method: 'POST', body: formData });
        const data = await res.json();

        if (data.success) {
            input.value = '';
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML += `
                <div class="chat-message enviado">
                    ${contenido}
                    <div class="chat-message-time">${new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    } catch (err) {
        alert('Error al enviar mensaje');
    }
}

// ========================================
// IMPORTAR DESDE URL
// ========================================
function mostrarModalImportarUrl() {
    document.getElementById('importUrl').value = '';
    document.getElementById('importTipoPublicacion').value = '0';
    document.getElementById('modalImportarUrl').style.display = 'flex';
}

function cerrarModalImportarUrl() {
    document.getElementById('modalImportarUrl').style.display = 'none';
}

async function importarDesdeUrl() {
    const url = document.getElementById('importUrl').value.trim();
    if (!url) {
        alert('Ingresa una URL v√°lida');
        return;
    }

    const tipoPublicacion = document.getElementById('importTipoPublicacion').value;
    const formData = new FormData();
    formData.append('id', usuarioId);
    formData.append('url', url);
    formData.append('tipoPublicacion', tipoPublicacion);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ImportarDesdeUrl', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            cerrarModalImportarUrl();
            cargarBiblioteca();
            alert('Medio importado correctamente');
        } else {
            alert(data.message || 'Error al importar');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// ACCIONES EN LOTE
// ========================================
function mostrarModalAccionesLote() {
    document.getElementById('loteCantidad').textContent = mediaSeleccionados.size;
    document.getElementById('modalAccionesLote').style.display = 'flex';
}

function cerrarModalAccionesLote() {
    document.getElementById('modalAccionesLote').style.display = 'none';
}

async function cambiarTipoPublicacionLote() {
    const tipoPublicacion = parseInt(document.getElementById('loteTipoPublicacion').value);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/CambiarTipoPublicacionLote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify({ ids: Array.from(mediaSeleccionados), tipoPublicacion })
        });
        const data = await res.json();
        if (data.success) {
            cerrarModalAccionesLote();
            cargarBiblioteca();
            alert(`${data.actualizados} elementos actualizados`);
        } else {
            alert(data.message || 'Error');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function duplicarSeleccionados() {
    if (!confirm(`¬øDuplicar ${mediaSeleccionados.size} elementos?`)) return;

    let duplicados = 0;
    for (const id of mediaSeleccionados) {
        const formData = new FormData();
        formData.append('mediaId', id);
        formData.append('__RequestVerificationToken', token);

        try {
            const res = await fetch('/Admin/UsuariosAdministrados/DuplicarMedia', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) duplicados++;
        } catch (err) {}
    }

    cerrarModalAccionesLote();
    mediaSeleccionados.clear();
    actualizarBotones();
    cargarBiblioteca();
    alert(`${duplicados} elementos duplicados`);
}

// ========================================
// ESTAD√çSTICAS
// ========================================
async function cargarEstadisticas() {
    const grid = document.getElementById('statsGrid');
    grid.innerHTML = '<div class="loading">Cargando...</div>';

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/Estadisticas/${usuarioId}`);
        const data = await res.json();

        if (!data.success) {
            grid.innerHTML = '<div class="empty-state">Error cargando estad√≠sticas</div>';
            return;
        }

        const s = data.stats;
        grid.innerHTML = `
            <div class="stat-card primary">
                <div class="stat-card-value">${s.seguidores}</div>
                <div class="stat-card-label">Seguidores</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.suscriptores}</div>
                <div class="stat-card-label">Suscriptores</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.contenidos}</div>
                <div class="stat-card-label">Publicaciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.stories}</div>
                <div class="stat-card-label">Stories</div>
            </div>
            <div class="stat-card success">
                <div class="stat-card-value">${s.totalLikes}</div>
                <div class="stat-card-label">Likes</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.totalComentarios}</div>
                <div class="stat-card-label">Comentarios</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.visitasPerfil || 0}</div>
                <div class="stat-card-label">Visitas perfil</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">${s.storiesVistas || 0}</div>
                <div class="stat-card-label">Vistas stories</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-card-value">$${(s.totalGanancias || 0).toFixed(2)}</div>
                <div class="stat-card-label">Ganancias</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value">$${(s.saldo || 0).toFixed(2)}</div>
                <div class="stat-card-label">Saldo</div>
            </div>
        `;
    } catch (err) {
        grid.innerHTML = `<div class="empty-state">Error: ${err.message}</div>`;
    }
}

// ========================================
// STORIES
// ========================================
async function cargarStories() {
    const grid = document.getElementById('storiesGrid');
    grid.innerHTML = '<div class="loading">Cargando...</div>';

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/Stories/${usuarioId}`);
        const data = await res.json();

        document.getElementById('storiesCount').textContent = `${data.total || 0} stories`;

        if (!data.items || data.items.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:20px"><div class="empty-state-icon">üì∑</div><div>No hay stories</div></div>';
            return;
        }

        grid.innerHTML = data.items.map(s => {
            // tipoContenido: 0=Post, 1=Imagen/Foto, 2=Video, 3=Audio
            const esVideo = s.tipoContenido === 2;
            return `<div class="story-item ${s.expirada ? 'expirada' : ''}" data-id="${s.id}">
                ${esVideo
                    ? `<video src="${s.rutaArchivo}" muted playsinline></video>
                       <div class="story-video-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>`
                    : `<img src="${s.rutaArchivo}" decoding="async">`}
                ${s.expirada ? '<span class="story-item-badge expired">EXPIRADA</span>' : '<span class="story-item-badge active">ACTIVA</span>'}
                <div class="story-item-overlay">
                    <div class="story-item-stats">
                        <span>üëÅ ${s.numeroVistas}</span>
                        <span>‚ù§Ô∏è ${s.numeroLikes}</span>
                    </div>
                </div>
            </div>`;
        }).join('');
    } catch (err) {
        grid.innerHTML = `<div class="empty-state">Error: ${err.message}</div>`;
    }
}

// ========================================
// ERRORES
// ========================================
async function cargarErrores() {
    const list = document.getElementById('errorList');
    list.innerHTML = '<div class="loading">Cargando...</div>';

    try {
        const res = await fetch(`/Admin/UsuariosAdministrados/HistorialErrores/${usuarioId}`);
        const data = await res.json();

        if (!data.errores || data.errores.length === 0) {
            list.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-state-icon">‚úì</div><div>No hay errores pendientes</div></div>';
            return;
        }

        list.innerHTML = data.errores.map(e => `
            <div class="error-item">
                <img src="${e.rutaArchivo}" class="error-item-thumb" onerror="this.style.display='none'">
                <div class="error-item-info">
                    <div class="error-item-name">${e.nombreOriginal || 'Sin nombre'}</div>
                    <div class="error-item-msg">${e.mensajeError || 'Error desconocido'} (Intentos: ${e.intentosPublicacion})</div>
                </div>
                <div class="error-item-actions">
                    <button class="btn btn-sm btn-secondary" onclick="reintentarPublicacion(${e.id})">Reintentar</button>
                </div>
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = `<div class="empty-state">Error: ${err.message}</div>`;
    }
}

async function reintentarPublicacion(mediaId) {
    const formData = new FormData();
    formData.append('mediaId', mediaId);
    formData.append('__RequestVerificationToken', token);

    try {
        const res = await fetch('/Admin/UsuariosAdministrados/ReintentarPublicacion', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            cargarErrores();
            alert('El medio se ha marcado para reintentar publicaci√≥n');
        } else {
            alert(data.message || 'Error');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// PLANTILLAS DE HASHTAGS
// ========================================
const storageKeyHashtags = `hashtag_templates_${usuarioId}`;

function getHashtagTemplates() {
    try {
        return JSON.parse(localStorage.getItem(storageKeyHashtags)) || ['#lado #contenido', '#modelo #exclusivo', '#hot #premium'];
    } catch {
        return ['#lado #contenido', '#modelo #exclusivo', '#hot #premium'];
    }
}

function saveHashtagTemplates(templates) {
    localStorage.setItem(storageKeyHashtags, JSON.stringify(templates));
}

function renderHashtagTemplates() {
    const container = document.getElementById('hashtagTemplates');
    if (!container) return;
    const templates = getHashtagTemplates();
    container.innerHTML = templates.map((t, i) => `
        <button type="button" class="btn btn-sm btn-secondary" style="font-size:10px;padding:3px 8px" onclick="usarHashtags('${t.replace(/'/g, "\\'")}')">
            ${t.length > 20 ? t.substring(0, 20) + '...' : t}
        </button>
    `).join('') + `
        <button type="button" class="btn btn-sm btn-secondary" style="font-size:10px;padding:3px 8px" onclick="gestionarHashtagTemplates()">‚öôÔ∏è</button>
    `;
}

function usarHashtags(hashtags) {
    const input = document.getElementById('editHashtags');
    if (input) {
        input.value = input.value ? input.value + ' ' + hashtags : hashtags;
    }
}

function gestionarHashtagTemplates() {
    const templates = getHashtagTemplates();
    const nuevas = prompt('Editar plantillas de hashtags (una por l√≠nea):', templates.join('\n'));
    if (nuevas !== null) {
        const lista = nuevas.split('\n').map(t => t.trim()).filter(t => t);
        saveHashtagTemplates(lista);
        renderHashtagTemplates();
    }
}

// ========================================
// PLANTILLAS DE MENSAJES
// ========================================
const storageKeyMensajes = `mensaje_templates_${usuarioId}`;

function getMensajeTemplates() {
    try {
        return JSON.parse(localStorage.getItem(storageKeyMensajes)) || [
            'Hola! Gracias por tu mensaje üíï',
            'Nuevo contenido disponible, no te lo pierdas! üî•',
            'Gracias por tu apoyo! ‚ù§Ô∏è'
        ];
    } catch {
        return ['Hola! Gracias por tu mensaje üíï'];
    }
}

function saveMensajeTemplates(templates) {
    localStorage.setItem(storageKeyMensajes, JSON.stringify(templates));
}

function renderMensajeTemplates() {
    const container = document.getElementById('plantillasMensaje');
    if (!container) return;
    const templates = getMensajeTemplates();

    if (templates.length === 0) {
        container.innerHTML = '<span style="color:var(--muted);font-size:12px">No hay plantillas. Haz clic en "+ Agregar" para crear una.</span>';
        return;
    }

    container.innerHTML = templates.map((t, i) => `
        <button type="button" class="btn btn-sm btn-secondary" onclick="usarPlantillaMensaje(${i})">
            ${t.length > 25 ? t.substring(0, 25) + '...' : t}
        </button>
    `).join('');
}

function usarPlantillaMensaje(index) {
    const templates = getMensajeTemplates();
    const input = document.getElementById('mensajeInput');
    if (input && templates[index]) {
        input.value = templates[index];
        input.focus();
    }
}

function agregarPlantillaMensaje() {
    const texto = prompt('Escribe el texto de la plantilla de mensaje:');
    if (texto && texto.trim()) {
        const templates = getMensajeTemplates();
        templates.push(texto.trim());
        saveMensajeTemplates(templates);
        renderMensajeTemplates();
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    const tab = '@tab';
    if (tab === 'biblioteca') cargarBiblioteca();
    if (tab === 'contenido') { cargarContenido(); cargarStories(); }
    if (tab === 'mensajes') { cargarConversaciones(); renderMensajeTemplates(); }
    if (tab === 'programacion') cargarCalendario();
    if (tab === 'estadisticas') cargarEstadisticas();
    if (tab === 'errores') cargarErrores();

    // Establecer valor inicial del select de categor√≠a
    const selectCategoria = document.getElementById('selectCategoria');
    if (selectCategoria) {
        selectCategoria.value = '@(Model.Categoria ?? "")';
    }

    // Cargar plantillas de hashtags al abrir modal
    renderHashtagTemplates();
});
</script>
